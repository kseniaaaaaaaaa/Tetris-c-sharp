/*! For license information please see 05cf136b.87547dc3.js.LICENSE.txt */
(self.webpackChunkvkweb=self.webpackChunkvkweb||[]).push([[10618],{900917:(e,t,s)=>{"use strict";s.d(t,{Icon16Ghost:()=>n});var n=(0,s(28178).makeIcon)("Icon16Ghost","ghost_16","0 0 16 16",'<symbol xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16" id="ghost_16"><path fill-rule="evenodd" d="M8 1a6.5 6.5 0 0 0-6.5 6.5v4.881c0 .407.095.809.277 1.172a1.5 1.5 0 0 0 2.11.615l.35-.21a1.41 1.41 0 0 1 1.504.036l.857.571.03.02a2.5 2.5 0 0 0 2.745 0l.03-.02.856-.571a1.41 1.41 0 0 1 1.504-.036l.35.21c.748.449 1.72.166 2.11-.615a2.6 2.6 0 0 0 .277-1.172V7.5A6.5 6.5 0 0 0 8 1m-1.091 9.121a.75.75 0 0 0-.818 1.258c.601.39 1.243.618 1.916.619.675 0 1.315-.225 1.911-.625a.75.75 0 1 0-.836-1.246c-.397.267-.75.371-1.072.37-.325 0-.687-.107-1.101-.376M5.5 8.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2m6-1a1 1 0 1 1-2 0 1 1 0 0 1 2 0" clip-rule="evenodd" /></symbol>',16,16,!1,void 0)},561743:(e,t,s)=>{"use strict";s.d(t,{Icon20GlobeCrossOutline:()=>n});var n=(0,s(28178).makeIcon)("Icon20GlobeCrossOutline","globe_cross_outline_20","0 0 20 20",'<symbol xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20" id="globe_cross_outline_20"><g fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"><path d="M8.219 7.999h4.191a.75.75 0 0 0 .7-1.02 19 19 0 0 0-1.653-3.827 7.01 7.01 0 0 1 5.08 4.339l.01.024a.75.75 0 1 0 1.401-.533l-.01-.03A8.5 8.5 0 1 0 6.973 17.945a.75.75 0 0 0 .533-1.4 7.02 7.02 0 0 1-3.57-3.043H6.86a.75.75 0 1 0 0-1.5H3.29A7 7 0 0 1 3 10c0-.696.101-1.367.29-2.001h3.401a12.5 12.5 0 0 0-.182 1.623l-.003.059a1 1 0 0 0 .002.106.75.75 0 1 0 1.498-.078l.001-.018c.027-.584.101-1.15.212-1.692m.361-4.855a7 7 0 0 0-4.643 3.355h3.116c.39-1.281.942-2.414 1.527-3.355m1.443.528a18 18 0 0 1 1.344 2.827H8.63c.375-1.084.876-2.04 1.393-2.827" /><path d="M14.002 19a5 5 0 1 0 0-10 5 5 0 0 0 0 10m2.524-6.47a.75.75 0 1 0-1.061-1.06l-1.466 1.468-1.469-1.468a.75.75 0 1 0-1.06 1.06L12.938 14l-1.469 1.47a.75.75 0 1 0 1.062 1.06l1.468-1.47 1.47 1.47a.75.75 0 1 0 1.061-1.06l-1.47-1.471z" /></g></symbol>',20,20,!1,void 0)},401194:(e,t,s)=>{"use strict";s.d(t,{Icon20PlaceOutline:()=>n});var n=(0,s(28178).makeIcon)("Icon20PlaceOutline","place_outline_20","0 0 20 20",'<symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" id="place_outline_20"><g fill="none" fill-rule="evenodd"><path d="M0 0h20v20H0z" opacity=".4" /><path fill="currentColor" fill-rule="nonzero" d="M10 1c4.148 0 7.5 3.433 7.5 7.5 0 2.85-1.843 6.172-5.435 10.095a2.8 2.8 0 0 1-4.13 0C4.343 14.672 2.5 11.35 2.5 8.5 2.5 4.433 5.852 1 10 1m0 1.5c-3.382 0-6 2.825-6 6q0 3.574 5.041 9.082a1.3 1.3 0 0 0 1.918 0Q15.999 12.075 16 8.5c0-3.175-2.618-6-6-6M10 5a3.5 3.5 0 1 1-.001 7.001A3.5 3.5 0 0 1 10 5m0 1.5a2 2 0 1 0 .001 4.001A2 2 0 0 0 10 6.5" /></g></symbol>',20,20,!1,void 0)},331870:(e,t,s)=>{"use strict";s.d(t,{Icon20UserAddOutline:()=>n});var n=(0,s(28178).makeIcon)("Icon20UserAddOutline","user_add_outline_20","0 0 20 20",'<symbol xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20" id="user_add_outline_20"><path fill-rule="evenodd" d="M12.5 8.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5M8.5 6a4 4 0 1 1 8 0 4 4 0 0 1-8 0m-4-.25a.75.75 0 1 0-1.5 0v2H1a.75.75 0 0 0 0 1.5h2v2a.75.75 0 0 0 1.5 0v-2h2a.75.75 0 0 0 0-1.5h-2zm4.155 7.227c.865-.458 2.194-.727 3.845-.727 1.65 0 2.98.27 3.845.727.794.42 1.155.959 1.155 1.71a.7.7 0 0 1-.05.288.3.3 0 0 1-.092.12c-.077.063-.26.155-.599.155H8.241c-.34 0-.522-.092-.6-.156a.3.3 0 0 1-.09-.12.7.7 0 0 1-.051-.287c0-.751.36-1.29 1.155-1.71M12.5 10.75c-1.774 0-3.38.283-4.547.902C6.783 12.27 6 13.26 6 14.688c0 .688.268 1.217.687 1.563.408.337.956.499 1.554.499h8.518c.598 0 1.146-.162 1.555-.499.418-.346.686-.875.686-1.564 0-1.426-.783-2.416-1.953-3.035-1.168-.619-2.773-.902-4.547-.902" clip-rule="evenodd" /></symbol>',20,20,!1,void 0)},221545:(e,t,s)=>{"use strict";s.d(t,{Icon20Users3Outline:()=>n});var n=(0,s(28178).makeIcon)("Icon20Users3Outline","users_3_outline_20","0 0 20 20",'<symbol xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20" id="users_3_outline_20"><path fill="currentColor" fill-rule="evenodd" d="M10 7.75a1.25 1.25 0 1 1 0-2.5 1.25 1.25 0 0 1 0 2.5M7.25 6.5a2.75 2.75 0 1 1 5.5 0 2.75 2.75 0 0 1-5.5 0m-.5 7.25c0-.416.231-.828.796-1.172C8.12 12.23 8.975 12 10 12s1.881.23 2.454.578c.565.344.796.756.796 1.172 0 .293-.1.444-.218.54-.142.113-.396.21-.782.21h-4.5c-.386 0-.64-.097-.781-.21-.12-.096-.219-.247-.219-.54M10 10.5c-1.225 0-2.369.27-3.234.797-.872.531-1.516 1.369-1.516 2.453 0 .707.276 1.306.781 1.71.484.387 1.105.54 1.719.54h4.5c.614 0 1.235-.153 1.719-.54.506-.404.781-1.003.781-1.71 0-1.084-.643-1.922-1.516-2.453-.865-.526-2.01-.797-3.234-.797m4.006-5.588a.75.75 0 0 1 .848-.637A2.5 2.5 0 0 1 14.5 9.25a.75.75 0 0 1 0-1.5 1 1 0 0 0 .143-1.99.75.75 0 0 1-.637-.848M15.749 10a.75.75 0 0 0 0 1.5c1.158 0 1.75.673 1.75 1.25a.86.86 0 0 1-.185.547.57.57 0 0 1-.464.203.75.75 0 0 0 0 1.5c1.428 0 2.15-1.21 2.15-2.25 0-1.712-1.607-2.75-3.251-2.75M5 10.75a.75.75 0 0 0-.75-.75C2.606 10 .999 11.038.999 12.75c0 1.04.722 2.25 2.15 2.25a.75.75 0 0 0 0-1.5.57.57 0 0 1-.465-.203.86.86 0 0 1-.185-.547c0-.577.592-1.25 1.751-1.25a.75.75 0 0 0 .75-.75m.142-6.474a.75.75 0 0 1 .214 1.484A1 1 0 0 0 5.5 7.75a.75.75 0 1 1 0 1.5 2.5 2.5 0 0 1-.358-4.975" clip-rule="evenodd" /></symbol>',20,20,!1,void 0)},917303:(e,t,s)=>{"use strict";s.d(t,{Icon24PhoneAddOutline:()=>n});var n=(0,s(28178).makeIcon)("Icon24PhoneAddOutline","phone_add_outline_24","0 0 24 24",'<symbol xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" id="phone_add_outline_24"><g fill="currentColor"><path d="M4.495 4.123c-2.92 3.213-1.36 8.186 2.928 12.494 4.198 4.217 9.394 5.794 12.47 2.932 1.681-1.565 1.433-4.337-.645-6.19-1.88-1.596-4.832-1.872-6.714-.106-.634-.533-1.174-1.163-1.754-1.753 1.626-1.706 1.621-4.676-.055-6.679C8.84 2.57 5.98 2.49 4.495 4.123m4.851 1.852c1.059 1.265 1.2 3.28-.05 4.46-.628.565-1.243.899 1.032 3.213 2.455 2.496 2.76 1.62 3.4.95 1.005-1.008 2.971-1.102 4.323.104 1.496 1.332 1.334 2.864.617 3.531-2.219 2.065-6.468.635-9.97-2.884-3.504-3.52-5.058-7.612-2.873-10.017.508-.558 2.099-1.057 3.521.643M18.5 2a.9.9 0 0 1 .9.9v1.7h1.7a.9.9 0 0 1 0 1.8h-1.7v1.7a.9.9 0 1 1-1.8 0V6.4h-1.7a.9.9 0 0 1 0-1.8h1.7V2.9a.9.9 0 0 1 .9-.9" /></g></symbol>',24,24,!1,void 0)},130845:(e,t,s)=>{"use strict";s.d(t,{default:()=>a});var n=Number.isNaN||function(e){return"number"==typeof e&&e!=e};function r(e,t){if(e.length!==t.length)return!1;for(var s=0;s<e.length;s++)if(r=e[s],a=t[s],!(r===a||n(r)&&n(a)))return!1;var r,a;return!0}const a=function(e,t){var s;void 0===t&&(t=r);var n,a=[],i=!1;return function(){for(var r=[],o=0;o<arguments.length;o++)r[o]=arguments[o];return i&&s===this&&t(r,a)||(n=e.apply(this,r),i=!0,s=this,a=r),n}}},968641:()=>{},81290:()=>{},200930:()=>{},215334:()=>{},928910:()=>{},522283:()=>{},950652:()=>{},705875:()=>{},360862:()=>{},181362:()=>{},994718:()=>{},324402:()=>{},168577:()=>{},980160:()=>{},516073:()=>{},974004:(e,t,s)=>{"use strict";s.d(t,{default:()=>h});var n=s(263366),r=s(487462),a=s(497326),i=s(894578),o=s(667294),c=s(500220),d=s(597803),l=Object.values||function(e){return Object.keys(e).map((function(t){return e[t]}))},u=function(e){function t(t,s){var n,r=(n=e.call(this,t,s)||this).handleExited.bind((0,a.default)(n));return n.state={contextValue:{isMounting:!0},handleExited:r,firstRender:!0},n}(0,i.default)(t,e);var s=t.prototype;return s.componentDidMount=function(){this.mounted=!0,this.setState({contextValue:{isMounting:!1}})},s.componentWillUnmount=function(){this.mounted=!1},t.getDerivedStateFromProps=function(e,t){var s=t.children,n=t.handleExited;return{children:t.firstRender?(0,d.getInitialChildMapping)(e,n):(0,d.getNextChildMapping)(e,s,n),firstRender:!1}},s.handleExited=function(e,t){var s=(0,d.getChildMapping)(this.props.children);e.key in s||(e.props.onExited&&e.props.onExited(t),this.mounted&&this.setState((function(t){var s=(0,r.default)({},t.children);return delete s[e.key],{children:s}})))},s.render=function(){var e=this.props,t=e.component,s=e.childFactory,r=(0,n.default)(e,["component","childFactory"]),a=this.state.contextValue,i=l(this.state.children).map(s);return delete r.appear,delete r.enter,delete r.exit,null===t?o.createElement(c.default.Provider,{value:a},i):o.createElement(c.default.Provider,{value:a},o.createElement(t,r,i))},t}(o.Component);u.propTypes={},u.defaultProps={component:"div",childFactory:function(e){return e}};const h=u},597803:(e,t,s)=>{"use strict";s.d(t,{getChildMapping:()=>r,getInitialChildMapping:()=>i,getNextChildMapping:()=>o});var n=s(667294);function r(e,t){var s=Object.create(null);return e&&n.Children.map(e,(function(e){return e})).forEach((function(e){s[e.key]=function(e){return t&&(0,n.isValidElement)(e)?t(e):e}(e)})),s}function a(e,t,s){return null!=s[t]?s[t]:e.props[t]}function i(e,t){return r(e.children,(function(s){return(0,n.cloneElement)(s,{onExited:t.bind(null,s),in:!0,appear:a(s,"appear",e),enter:a(s,"enter",e),exit:a(s,"exit",e)})}))}function o(e,t,s){var i=r(e.children),o=function(e,t){function s(s){return s in t?t[s]:e[s]}e=e||{},t=t||{};var n,r=Object.create(null),a=[];for(var i in e)i in t?a.length&&(r[i]=a,a=[]):a.push(i);var o={};for(var c in t){if(r[c])for(n=0;n<r[c].length;n++){var d=r[c][n];o[r[c][n]]=s(d)}o[c]=s(c)}for(n=0;n<a.length;n++)o[a[n]]=s(a[n]);return o}(t,i);return Object.keys(o).forEach((function(r){var c=o[r];if((0,n.isValidElement)(c)){var d=r in t,l=r in i,u=t[r],h=(0,n.isValidElement)(u)&&!u.props.in;!l||d&&!h?l||!d||h?l&&d&&(0,n.isValidElement)(u)&&(o[r]=(0,n.cloneElement)(c,{onExited:s.bind(null,c),in:u.props.in,exit:a(c,"exit",e),enter:a(c,"enter",e)})):o[r]=(0,n.cloneElement)(c,{in:!1}):o[r]=(0,n.cloneElement)(c,{onExited:s.bind(null,c),in:!0,exit:a(c,"exit",e),enter:a(c,"enter",e)})}})),o}},339142:(e,t,s)=>{"use strict";s.d(t,{default:()=>h});var n=s(667294);let r;r="undefined"!=typeof window?window:"undefined"!=typeof self?self:s.g;let a=null,i=null;const o=r.clearTimeout,c=r.setTimeout,d=r.cancelAnimationFrame||r.mozCancelAnimationFrame||r.webkitCancelAnimationFrame,l=r.requestAnimationFrame||r.mozRequestAnimationFrame||r.webkitRequestAnimationFrame;function u(e){let t,s,n,o,c,d,l;const u="undefined"!=typeof document&&document.attachEvent;if(!u){d=function(e){const t=e.__resizeTriggers__,s=t.firstElementChild,n=t.lastElementChild,r=s.firstElementChild;n.scrollLeft=n.scrollWidth,n.scrollTop=n.scrollHeight,r.style.width=s.offsetWidth+1+"px",r.style.height=s.offsetHeight+1+"px",s.scrollLeft=s.scrollWidth,s.scrollTop=s.scrollHeight},c=function(e){return e.offsetWidth!==e.__resizeLast__.width||e.offsetHeight!==e.__resizeLast__.height},l=function(e){if(e.target.className&&"function"==typeof e.target.className.indexOf&&e.target.className.indexOf("contract-trigger")<0&&e.target.className.indexOf("expand-trigger")<0)return;const t=this;d(this),this.__resizeRAF__&&a(this.__resizeRAF__),this.__resizeRAF__=i((function(){c(t)&&(t.__resizeLast__.width=t.offsetWidth,t.__resizeLast__.height=t.offsetHeight,t.__resizeListeners__.forEach((function(s){s.call(t,e)})))}))};let e=!1,r="";n="animationstart";const u="Webkit Moz O ms".split(" ");let h="webkitAnimationStart animationstart oAnimationStart MSAnimationStart".split(" "),p="";{const t=document.createElement("fakeelement");if(void 0!==t.style.animationName&&(e=!0),!1===e)for(let s=0;s<u.length;s++)if(void 0!==t.style[u[s]+"AnimationName"]){p=u[s],r="-"+p.toLowerCase()+"-",n=h[s],e=!0;break}}s="resizeanim",t="@"+r+"keyframes "+s+" { from { opacity: 0; } to { opacity: 0; } } ",o=r+"animation: 1ms "+s+"; "}return{addResizeListener:function(a,i){if(u)a.attachEvent("onresize",i);else{if(!a.__resizeTriggers__){const i=a.ownerDocument,c=r.getComputedStyle(a);c&&"static"===c.position&&(a.style.position="relative"),function(s){if(!s.getElementById("detectElementResize")){const n=(t||"")+".resize-triggers { "+(o||"")+'visibility: hidden; opacity: 0; } .resize-triggers, .resize-triggers > div, .contract-trigger:before { content: " "; display: block; position: absolute; top: 0; left: 0; height: 100%; width: 100%; overflow: hidden; z-index: -1; } .resize-triggers > div { background: #eee; overflow: auto; } .contract-trigger:before { width: 200%; height: 200%; }',r=s.head||s.getElementsByTagName("head")[0],a=s.createElement("style");a.id="detectElementResize",a.type="text/css",null!=e&&a.setAttribute("nonce",e),a.styleSheet?a.styleSheet.cssText=n:a.appendChild(s.createTextNode(n)),r.appendChild(a)}}(i),a.__resizeLast__={},a.__resizeListeners__=[],(a.__resizeTriggers__=i.createElement("div")).className="resize-triggers";const u=i.createElement("div");u.className="expand-trigger",u.appendChild(i.createElement("div"));const h=i.createElement("div");h.className="contract-trigger",a.__resizeTriggers__.appendChild(u),a.__resizeTriggers__.appendChild(h),a.appendChild(a.__resizeTriggers__),d(a),a.addEventListener("scroll",l,!0),n&&(a.__resizeTriggers__.__animationListener__=function(e){e.animationName===s&&d(a)},a.__resizeTriggers__.addEventListener(n,a.__resizeTriggers__.__animationListener__))}a.__resizeListeners__.push(i)}},removeResizeListener:function(e,t){if(u)e.detachEvent("onresize",t);else if(e.__resizeListeners__.splice(e.__resizeListeners__.indexOf(t),1),!e.__resizeListeners__.length){e.removeEventListener("scroll",l,!0),e.__resizeTriggers__.__animationListener__&&(e.__resizeTriggers__.removeEventListener(n,e.__resizeTriggers__.__animationListener__),e.__resizeTriggers__.__animationListener__=null);try{e.__resizeTriggers__=!e.removeChild(e.__resizeTriggers__)}catch(e){}}}}}null==d||null==l?(a=o,i=function(e){return c(e,20)}):(a=function([e,t]){d(e),o(t)},i=function(e){const t=l((function(){o(s),e()})),s=c((function(){d(t),e()}),20);return[t,s]});class h extends n.Component{constructor(...e){super(...e),this.state={height:this.props.defaultHeight||0,scaledHeight:this.props.defaultHeight||0,scaledWidth:this.props.defaultWidth||0,width:this.props.defaultWidth||0},this._autoSizer=null,this._detectElementResize=null,this._parentNode=null,this._resizeObserver=null,this._timeoutId=null,this._onResize=()=>{this._timeoutId=null;const{disableHeight:e,disableWidth:t,onResize:s}=this.props;if(this._parentNode){const n=window.getComputedStyle(this._parentNode)||{},r=parseFloat(n.paddingLeft||"0"),a=parseFloat(n.paddingRight||"0"),i=parseFloat(n.paddingTop||"0"),o=parseFloat(n.paddingBottom||"0"),c=this._parentNode.getBoundingClientRect(),d=c.height-i-o,l=c.width-r-a,u=this._parentNode.offsetHeight-i-o,h=this._parentNode.offsetWidth-r-a;(e||this.state.height===u&&this.state.scaledHeight===d)&&(t||this.state.width===h&&this.state.scaledWidth===l)||(this.setState({height:u,width:h,scaledHeight:d,scaledWidth:l}),"function"==typeof s&&s({height:u,scaledHeight:d,scaledWidth:l,width:h}))}},this._setRef=e=>{this._autoSizer=e}}componentDidMount(){const{nonce:e}=this.props;this._autoSizer&&this._autoSizer.parentNode&&this._autoSizer.parentNode.ownerDocument&&this._autoSizer.parentNode.ownerDocument.defaultView&&this._autoSizer.parentNode instanceof this._autoSizer.parentNode.ownerDocument.defaultView.HTMLElement&&(this._parentNode=this._autoSizer.parentNode,null!=this._parentNode&&("undefined"!=typeof ResizeObserver?(this._resizeObserver=new ResizeObserver((()=>{this._timeoutId=setTimeout(this._onResize,0)})),this._resizeObserver.observe(this._parentNode)):(this._detectElementResize=u(e),this._detectElementResize.addResizeListener(this._parentNode,this._onResize)),this._onResize()))}componentWillUnmount(){this._parentNode&&(this._detectElementResize&&this._detectElementResize.removeResizeListener(this._parentNode,this._onResize),null!==this._timeoutId&&clearTimeout(this._timeoutId),this._resizeObserver&&(this._resizeObserver.observe(this._parentNode),this._resizeObserver.disconnect()))}render(){const{children:e,defaultHeight:t,defaultWidth:s,disableHeight:r=!1,disableWidth:a=!1,nonce:i,onResize:o,style:c={},tagName:d="div",...l}=this.props,{height:u,scaledHeight:h,scaledWidth:p,width:m}=this.state,g={overflow:"visible"},f={};let C=!1;return r||(0===u&&(C=!0),g.height=0,f.height=u,f.scaledHeight=h),a||(0===m&&(C=!0),g.width=0,f.width=m,f.scaledWidth=p),(0,n.createElement)(d,{ref:this._setRef,style:{...g,...c},...l},!C&&e(f))}}},274061:(e,t,s)=>{"use strict";s.d(t,{FixedSizeList:()=>w,VariableSizeList:()=>I});var n=s(487462),r=s(497326),a=s(894578),i=s(130845),o=s(667294),c=(s(263366),"object"==typeof performance&&"function"==typeof performance.now?function(){return performance.now()}:function(){return Date.now()});function d(e){cancelAnimationFrame(e.id)}function l(e,t){var s=c();var n={id:requestAnimationFrame((function r(){c()-s>=t?e.call(null):n.id=requestAnimationFrame(r)}))};return n}var u=-1;function h(e){if(void 0===e&&(e=!1),-1===u||e){var t=document.createElement("div"),s=t.style;s.width="50px",s.height="50px",s.overflow="scroll",document.body.appendChild(t),u=t.offsetWidth-t.clientWidth,document.body.removeChild(t)}return u}var p=null;function m(e){if(void 0===e&&(e=!1),null===p||e){var t=document.createElement("div"),s=t.style;s.width="50px",s.height="50px",s.overflow="scroll",s.direction="rtl";var n=document.createElement("div"),r=n.style;return r.width="100px",r.height="100px",t.appendChild(n),document.body.appendChild(t),t.scrollLeft>0?p="positive-descending":(t.scrollLeft=1,p=0===t.scrollLeft?"negative":"positive-ascending"),document.body.removeChild(t),p}return p}var g=function(e,t){return e};function f(e){var t,s=e.getItemOffset,c=e.getEstimatedTotalSize,u=e.getItemSize,p=e.getOffsetForIndexAndAlignment,f=e.getStartIndexForOffset,_=e.getStopIndexForStartIndex,v=e.initInstanceProps,y=e.shouldResetStyleCacheOnItemSizeChange,k=e.validateProps;return t=function(e){function t(t){var n;return(n=e.call(this,t)||this)._instanceProps=v(n.props,(0,r.default)(n)),n._outerRef=void 0,n._resetIsScrollingTimeoutId=null,n.state={instance:(0,r.default)(n),isScrolling:!1,scrollDirection:"forward",scrollOffset:"number"==typeof n.props.initialScrollOffset?n.props.initialScrollOffset:0,scrollUpdateWasRequested:!1},n._callOnItemsRendered=void 0,n._callOnItemsRendered=(0,i.default)((function(e,t,s,r){return n.props.onItemsRendered({overscanStartIndex:e,overscanStopIndex:t,visibleStartIndex:s,visibleStopIndex:r})})),n._callOnScroll=void 0,n._callOnScroll=(0,i.default)((function(e,t,s){return n.props.onScroll({scrollDirection:e,scrollOffset:t,scrollUpdateWasRequested:s})})),n._getItemStyle=void 0,n._getItemStyle=function(e){var t,r=n.props,a=r.direction,i=r.itemSize,o=r.layout,c=n._getItemStyleCache(y&&i,y&&o,y&&a);if(c.hasOwnProperty(e))t=c[e];else{var d=s(n.props,e,n._instanceProps),l=u(n.props,e,n._instanceProps),h="horizontal"===a||"horizontal"===o,p="rtl"===a,m=h?d:0;c[e]=t={position:"absolute",left:p?void 0:m,right:p?m:void 0,top:h?0:d,height:h?"100%":l,width:h?l:"100%"}}return t},n._getItemStyleCache=void 0,n._getItemStyleCache=(0,i.default)((function(e,t,s){return{}})),n._onScrollHorizontal=function(e){var t=e.currentTarget,s=t.clientWidth,r=t.scrollLeft,a=t.scrollWidth;n.setState((function(e){if(e.scrollOffset===r)return null;var t=n.props.direction,i=r;if("rtl"===t)switch(m()){case"negative":i=-r;break;case"positive-descending":i=a-s-r}return i=Math.max(0,Math.min(i,a-s)),{isScrolling:!0,scrollDirection:e.scrollOffset<r?"forward":"backward",scrollOffset:i,scrollUpdateWasRequested:!1}}),n._resetIsScrollingDebounced)},n._onScrollVertical=function(e){var t=e.currentTarget,s=t.clientHeight,r=t.scrollHeight,a=t.scrollTop;n.setState((function(e){if(e.scrollOffset===a)return null;var t=Math.max(0,Math.min(a,r-s));return{isScrolling:!0,scrollDirection:e.scrollOffset<t?"forward":"backward",scrollOffset:t,scrollUpdateWasRequested:!1}}),n._resetIsScrollingDebounced)},n._outerRefSetter=function(e){var t=n.props.outerRef;n._outerRef=e,"function"==typeof t?t(e):null!=t&&"object"==typeof t&&t.hasOwnProperty("current")&&(t.current=e)},n._resetIsScrollingDebounced=function(){null!==n._resetIsScrollingTimeoutId&&d(n._resetIsScrollingTimeoutId),n._resetIsScrollingTimeoutId=l(n._resetIsScrolling,150)},n._resetIsScrolling=function(){n._resetIsScrollingTimeoutId=null,n.setState({isScrolling:!1},(function(){n._getItemStyleCache(-1,null)}))},n}(0,a.default)(t,e),t.getDerivedStateFromProps=function(e,t){return C(e,t),k(e),null};var I=t.prototype;return I.scrollTo=function(e){e=Math.max(0,e),this.setState((function(t){return t.scrollOffset===e?null:{scrollDirection:t.scrollOffset<e?"forward":"backward",scrollOffset:e,scrollUpdateWasRequested:!0}}),this._resetIsScrollingDebounced)},I.scrollToItem=function(e,t){void 0===t&&(t="auto");var s=this.props,n=s.itemCount,r=s.layout,a=this.state.scrollOffset;e=Math.max(0,Math.min(e,n-1));var i=0;if(this._outerRef){var o=this._outerRef;i="vertical"===r?o.scrollWidth>o.clientWidth?h():0:o.scrollHeight>o.clientHeight?h():0}this.scrollTo(p(this.props,e,t,a,this._instanceProps,i))},I.componentDidMount=function(){var e=this.props,t=e.direction,s=e.initialScrollOffset,n=e.layout;if("number"==typeof s&&null!=this._outerRef){var r=this._outerRef;"horizontal"===t||"horizontal"===n?r.scrollLeft=s:r.scrollTop=s}this._callPropsCallbacks()},I.componentDidUpdate=function(){var e=this.props,t=e.direction,s=e.layout,n=this.state,r=n.scrollOffset;if(n.scrollUpdateWasRequested&&null!=this._outerRef){var a=this._outerRef;if("horizontal"===t||"horizontal"===s)if("rtl"===t)switch(m()){case"negative":a.scrollLeft=-r;break;case"positive-ascending":a.scrollLeft=r;break;default:var i=a.clientWidth,o=a.scrollWidth;a.scrollLeft=o-i-r}else a.scrollLeft=r;else a.scrollTop=r}this._callPropsCallbacks()},I.componentWillUnmount=function(){null!==this._resetIsScrollingTimeoutId&&d(this._resetIsScrollingTimeoutId)},I.render=function(){var e=this.props,t=e.children,s=e.className,r=e.direction,a=e.height,i=e.innerRef,d=e.innerElementType,l=e.innerTagName,u=e.itemCount,h=e.itemData,p=e.itemKey,m=void 0===p?g:p,f=e.layout,C=e.outerElementType,_=e.outerTagName,v=e.style,y=e.useIsScrolling,k=e.width,I=this.state.isScrolling,w="horizontal"===r||"horizontal"===f,b=w?this._onScrollHorizontal:this._onScrollVertical,R=this._getRangeToRender(),M=R[0],S=R[1],E=[];if(u>0)for(var A=M;A<=S;A++)E.push((0,o.createElement)(t,{data:h,key:m(A,h),index:A,isScrolling:y?I:void 0,style:this._getItemStyle(A)}));var U=c(this.props,this._instanceProps);return(0,o.createElement)(C||_||"div",{className:s,onScroll:b,ref:this._outerRefSetter,style:(0,n.default)({position:"relative",height:a,width:k,overflow:"auto",WebkitOverflowScrolling:"touch",willChange:"transform",direction:r},v)},(0,o.createElement)(d||l||"div",{children:E,ref:i,style:{height:w?"100%":U,pointerEvents:I?"none":void 0,width:w?U:"100%"}}))},I._callPropsCallbacks=function(){if("function"==typeof this.props.onItemsRendered&&this.props.itemCount>0){var e=this._getRangeToRender(),t=e[0],s=e[1],n=e[2],r=e[3];this._callOnItemsRendered(t,s,n,r)}if("function"==typeof this.props.onScroll){var a=this.state,i=a.scrollDirection,o=a.scrollOffset,c=a.scrollUpdateWasRequested;this._callOnScroll(i,o,c)}},I._getRangeToRender=function(){var e=this.props,t=e.itemCount,s=e.overscanCount,n=this.state,r=n.isScrolling,a=n.scrollDirection,i=n.scrollOffset;if(0===t)return[0,0,0,0];var o=f(this.props,i,this._instanceProps),c=_(this.props,o,i,this._instanceProps),d=r&&"backward"!==a?1:Math.max(1,s),l=r&&"forward"!==a?1:Math.max(1,s);return[Math.max(0,o-d),Math.max(0,Math.min(t-1,c+l)),o,c]},t}(o.PureComponent),t.defaultProps={direction:"ltr",itemData:void 0,layout:"vertical",overscanCount:2,useIsScrolling:!1},t}var C=function(e,t){e.children,e.direction,e.height,e.layout,e.innerTagName,e.outerTagName,e.width,t.instance},_=function(e,t,s){var n=e.itemSize,r=s.itemMetadataMap,a=s.lastMeasuredIndex;if(t>a){var i=0;if(a>=0){var o=r[a];i=o.offset+o.size}for(var c=a+1;c<=t;c++){var d=n(c);r[c]={offset:i,size:d},i+=d}s.lastMeasuredIndex=t}return r[t]},v=function(e,t,s,n,r){for(;n<=s;){var a=n+Math.floor((s-n)/2),i=_(e,a,t).offset;if(i===r)return a;i<r?n=a+1:i>r&&(s=a-1)}return n>0?n-1:0},y=function(e,t,s,n){for(var r=e.itemCount,a=1;s<r&&_(e,s,t).offset<n;)s+=a,a*=2;return v(e,t,Math.min(s,r-1),Math.floor(s/2),n)},k=function(e,t){var s=e.itemCount,n=t.itemMetadataMap,r=t.estimatedItemSize,a=t.lastMeasuredIndex,i=0;if(a>=s&&(a=s-1),a>=0){var o=n[a];i=o.offset+o.size}return i+(s-a-1)*r},I=f({getItemOffset:function(e,t,s){return _(e,t,s).offset},getItemSize:function(e,t,s){return s.itemMetadataMap[t].size},getEstimatedTotalSize:k,getOffsetForIndexAndAlignment:function(e,t,s,n,r,a){var i=e.direction,o=e.height,c=e.layout,d=e.width,l="horizontal"===i||"horizontal"===c?d:o,u=_(e,t,r),h=k(e,r),p=Math.max(0,Math.min(h-l,u.offset)),m=Math.max(0,u.offset-l+u.size+a);switch("smart"===s&&(s=n>=m-l&&n<=p+l?"auto":"center"),s){case"start":return p;case"end":return m;case"center":return Math.round(m+(p-m)/2);default:return n>=m&&n<=p?n:n<m?m:p}},getStartIndexForOffset:function(e,t,s){return function(e,t,s){var n=t.itemMetadataMap,r=t.lastMeasuredIndex;return(r>0?n[r].offset:0)>=s?v(e,t,r,0,s):y(e,t,Math.max(0,r),s)}(e,s,t)},getStopIndexForStartIndex:function(e,t,s,n){for(var r=e.direction,a=e.height,i=e.itemCount,o=e.layout,c=e.width,d="horizontal"===r||"horizontal"===o?c:a,l=_(e,t,n),u=s+d,h=l.offset+l.size,p=t;p<i-1&&h<u;)p++,h+=_(e,p,n).size;return p},initInstanceProps:function(e,t){var s={itemMetadataMap:{},estimatedItemSize:e.estimatedItemSize||50,lastMeasuredIndex:-1};return t.resetAfterIndex=function(e,n){void 0===n&&(n=!0),s.lastMeasuredIndex=Math.min(s.lastMeasuredIndex,e-1),t._getItemStyleCache(-1),n&&t.forceUpdate()},s},shouldResetStyleCacheOnItemSizeChange:!1,validateProps:function(e){e.itemSize}}),w=f({getItemOffset:function(e,t){return t*e.itemSize},getItemSize:function(e,t){return e.itemSize},getEstimatedTotalSize:function(e){var t=e.itemCount;return e.itemSize*t},getOffsetForIndexAndAlignment:function(e,t,s,n,r,a){var i=e.direction,o=e.height,c=e.itemCount,d=e.itemSize,l=e.layout,u=e.width,h="horizontal"===i||"horizontal"===l?u:o,p=Math.max(0,c*d-h),m=Math.min(p,t*d),g=Math.max(0,t*d-h+d+a);switch("smart"===s&&(s=n>=g-h&&n<=m+h?"auto":"center"),s){case"start":return m;case"end":return g;case"center":var f=Math.round(g+(m-g)/2);return f<Math.ceil(h/2)?0:f>p+Math.floor(h/2)?p:f;default:return n>=g&&n<=m?n:n<g?g:m}},getStartIndexForOffset:function(e,t){var s=e.itemCount,n=e.itemSize;return Math.max(0,Math.min(s-1,Math.floor(t/n)))},getStopIndexForStartIndex:function(e,t,s){var n=e.direction,r=e.height,a=e.itemCount,i=e.itemSize,o=e.layout,c=e.width,d=t*i,l="horizontal"===n||"horizontal"===o?c:r,u=Math.ceil((l+s-d)/i);return Math.max(0,Math.min(a-1,t+u-1))},initInstanceProps:function(e){},shouldResetStyleCacheOnItemSizeChange:!0,validateProps:function(e){e.itemSize}})},163293:function(e){e.exports=function(){"use strict";var e=function(){return e=Object.assign||function(e){for(var t,s=1,n=arguments.length;s<n;s++)for(var r in t=arguments[s])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},e.apply(this,arguments)};function t(e,t){var s={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(s[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(s[n[r]]=e[n[r]])}return s}var s=function(){function e(e,t){this.ATT_FACTOR=4,this.GRAPH_X=2,this.AMPLITUDE_FACTOR=.6,this.ctrl=e,this.definition=t}return e.prototype.globalAttFn=function(e){return Math.pow(this.ATT_FACTOR/(this.ATT_FACTOR+Math.pow(e,this.ATT_FACTOR)),this.ATT_FACTOR)},e.prototype.xPos=function(e){return this.ctrl.width*((e+this.GRAPH_X)/(2*this.GRAPH_X))},e.prototype.yPos=function(e){return this.AMPLITUDE_FACTOR*(this.globalAttFn(e)*(this.ctrl.heightMax*this.ctrl.amplitude)*(1/this.definition.attenuation)*Math.sin(this.ctrl.opt.frequency*e-this.ctrl.phase))},e.prototype.draw=function(){var e=this.ctrl.ctx;e.moveTo(0,0),e.beginPath();var t=(this.definition.color||this.ctrl.color).replace(/rgb\(/g,"").replace(/\)/g,"");e.strokeStyle="rgba(".concat(t,",").concat(this.definition.opacity,")"),e.lineWidth=this.definition.lineWidth;for(var s=-this.GRAPH_X;s<=this.GRAPH_X;s+=this.ctrl.opt.pixelDepth)e.lineTo(this.xPos(s),this.ctrl.heightMax+this.yPos(s));e.stroke()},e.getDefinition=function(){return[{attenuation:-2,lineWidth:1,opacity:.1},{attenuation:-6,lineWidth:1,opacity:.2},{attenuation:4,lineWidth:1,opacity:.4},{attenuation:2,lineWidth:1,opacity:.6},{attenuation:1,lineWidth:1.5,opacity:1}]},e}(),n=function(){function e(e,t){this.GRAPH_X=25,this.AMPLITUDE_FACTOR=.8,this.SPEED_FACTOR=1,this.DEAD_PX=2,this.ATT_FACTOR=4,this.DESPAWN_FACTOR=.02,this.NOOFCURVES_RANGES=[2,5],this.AMPLITUDE_RANGES=[.3,1],this.OFFSET_RANGES=[-3,3],this.WIDTH_RANGES=[1,3],this.SPEED_RANGES=[.5,1],this.DESPAWN_TIMEOUT_RANGES=[500,2e3],this.ctrl=e,this.definition=t,this.noOfCurves=0,this.spawnAt=0,this.prevMaxY=0,this.phases=[],this.offsets=[],this.speeds=[],this.finalAmplitudes=[],this.widths=[],this.amplitudes=[],this.despawnTimeouts=[],this.verses=[]}return e.prototype.getRandomRange=function(e){return e[0]+Math.random()*(e[1]-e[0])},e.prototype.spawnSingle=function(e){this.phases[e]=0,this.amplitudes[e]=0,this.despawnTimeouts[e]=this.getRandomRange(this.DESPAWN_TIMEOUT_RANGES),this.offsets[e]=this.getRandomRange(this.OFFSET_RANGES),this.speeds[e]=this.getRandomRange(this.SPEED_RANGES),this.finalAmplitudes[e]=this.getRandomRange(this.AMPLITUDE_RANGES),this.widths[e]=this.getRandomRange(this.WIDTH_RANGES),this.verses[e]=this.getRandomRange([-1,1])},e.prototype.getEmptyArray=function(e){return new Array(e)},e.prototype.spawn=function(){this.spawnAt=Date.now(),this.noOfCurves=Math.floor(this.getRandomRange(this.NOOFCURVES_RANGES)),this.phases=this.getEmptyArray(this.noOfCurves),this.offsets=this.getEmptyArray(this.noOfCurves),this.speeds=this.getEmptyArray(this.noOfCurves),this.finalAmplitudes=this.getEmptyArray(this.noOfCurves),this.widths=this.getEmptyArray(this.noOfCurves),this.amplitudes=this.getEmptyArray(this.noOfCurves),this.despawnTimeouts=this.getEmptyArray(this.noOfCurves),this.verses=this.getEmptyArray(this.noOfCurves);for(var e=0;e<this.noOfCurves;e++)this.spawnSingle(e)},e.prototype.globalAttFn=function(e){return Math.pow(this.ATT_FACTOR/(this.ATT_FACTOR+Math.pow(e,2)),this.ATT_FACTOR)},e.prototype.sin=function(e,t){return Math.sin(e-t)},e.prototype.yRelativePos=function(e){for(var t=0,s=0;s<this.noOfCurves;s++){var n=4*(s/(this.noOfCurves-1)*2-1);n+=this.offsets[s];var r=e*(1/this.widths[s])-n;t+=Math.abs(this.amplitudes[s]*this.sin(this.verses[s]*r,this.phases[s])*this.globalAttFn(r))}return t/this.noOfCurves},e.prototype.yPos=function(e){return this.AMPLITUDE_FACTOR*this.ctrl.heightMax*this.ctrl.amplitude*this.yRelativePos(e)*this.globalAttFn(e/this.GRAPH_X*2)},e.prototype.xPos=function(e){return this.ctrl.width*((e+this.GRAPH_X)/(2*this.GRAPH_X))},e.prototype.drawSupportLine=function(){var e=this.ctrl.ctx,t=[0,this.ctrl.heightMax,this.ctrl.width,1],s=e.createLinearGradient.apply(e,t);s.addColorStop(0,"transparent"),s.addColorStop(.1,"rgba(255,255,255,.5)"),s.addColorStop(.8,"rgba(255,255,255,.5)"),s.addColorStop(1,"transparent"),e.fillStyle=s,e.fillRect.apply(e,t)},e.prototype.draw=function(){var e=this.ctrl.ctx;if(e.globalAlpha=.7,e.globalCompositeOperation="lighter",0===this.spawnAt&&this.spawn(),this.definition.supportLine)return this.drawSupportLine();for(var t=0;t<this.noOfCurves;t++)this.spawnAt+this.despawnTimeouts[t]<=Date.now()?this.amplitudes[t]-=this.DESPAWN_FACTOR:this.amplitudes[t]+=this.DESPAWN_FACTOR,this.amplitudes[t]=Math.min(Math.max(this.amplitudes[t],0),this.finalAmplitudes[t]),this.phases[t]=(this.phases[t]+this.ctrl.speed*this.speeds[t]*this.SPEED_FACTOR)%(2*Math.PI);for(var s=-1/0,n=0,r=[1,-1];n<r.length;n++){var a=r[n];e.beginPath();for(var i=-this.GRAPH_X;i<=this.GRAPH_X;i+=this.ctrl.opt.pixelDepth){var o=this.xPos(i),c=this.yPos(i);e.lineTo(o,this.ctrl.heightMax-a*c),s=Math.max(s,c)}e.closePath(),e.fillStyle="rgba(".concat(this.definition.color,", 1)"),e.strokeStyle="rgba(".concat(this.definition.color,", 1)"),e.fill()}return s<this.DEAD_PX&&this.prevMaxY>s&&(this.spawnAt=0),this.prevMaxY=s,null},e.getDefinition=function(){return[{color:"255,255,255",supportLine:!0},{color:"15, 82, 169"},{color:"173, 57, 76"},{color:"48, 220, 155"}]},e}();return function(){function r(r){var a=this,i=r.container,o=t(r,["container"]);this.phase=0,this.run=!1,this.curves=[];var c=window.getComputedStyle(i);this.opt=e({container:i,style:"ios",ratio:window.devicePixelRatio||1,speed:.2,amplitude:1,frequency:6,color:"#fff",cover:!1,width:parseInt(c.width.replace("px",""),10),height:parseInt(c.height.replace("px",""),10),autostart:!0,pixelDepth:.02,lerpSpeed:.1},o),this.speed=Number(this.opt.speed),this.amplitude=Number(this.opt.amplitude),this.width=Number(this.opt.ratio*this.opt.width),this.height=Number(this.opt.ratio*this.opt.height),this.heightMax=Number(this.height/2)-6,this.color="rgb(".concat(this.hex2rgb(this.opt.color),")"),this.interpolation={speed:this.speed,amplitude:this.amplitude},this.canvas=document.createElement("canvas");var d=this.canvas.getContext("2d");if(null===d)throw new Error("Unable to create 2D Context");this.ctx=d,this.canvas.width=this.width,this.canvas.height=this.height,!0===this.opt.cover?this.canvas.style.width=this.canvas.style.height="100%":(this.canvas.style.width="".concat(this.width/this.opt.ratio,"px"),this.canvas.style.height="".concat(this.height/this.opt.ratio,"px")),"ios9"===this.opt.style?this.curves=(this.opt.curveDefinition||n.getDefinition()).map((function(e){return new n(a,e)})):this.curves=(this.opt.curveDefinition||s.getDefinition()).map((function(e){return new s(a,e)})),this.opt.container.appendChild(this.canvas),this.opt.autostart&&this.start()}return r.prototype.hex2rgb=function(e){var t=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;e=e.replace(t,(function(e,t,s,n){return t+t+s+s+n+n}));var s=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return s?"".concat(parseInt(s[1],16).toString(),",").concat(parseInt(s[2],16).toString(),",").concat(parseInt(s[3],16).toString()):null},r.prototype.intLerp=function(e,t,s){return e*(1-s)+t*s},r.prototype.lerp=function(e){var t=this.interpolation[e];return null!==t&&(this[e]=this.intLerp(this[e],t,this.opt.lerpSpeed),this[e]-t==0&&(this.interpolation[e]=null)),this[e]},r.prototype.clear=function(){this.ctx.globalCompositeOperation="destination-out",this.ctx.fillRect(0,0,this.width,this.height),this.ctx.globalCompositeOperation="source-over"},r.prototype.draw=function(){this.curves.forEach((function(e){return e.draw()}))},r.prototype.startDrawCycle=function(){this.clear(),this.lerp("amplitude"),this.lerp("speed"),this.draw(),this.phase=(this.phase+Math.PI/2*this.speed)%(2*Math.PI),window.requestAnimationFrame?this.animationFrameId=window.requestAnimationFrame(this.startDrawCycle.bind(this)):this.timeoutId=setTimeout(this.startDrawCycle.bind(this),20)},r.prototype.start=function(){if(!this.canvas)throw new Error("This instance of SiriWave has been disposed, please create a new instance");this.phase=0,this.run||(this.run=!0,this.startDrawCycle())},r.prototype.stop=function(){this.phase=0,this.run=!1,this.animationFrameId&&window.cancelAnimationFrame(this.animationFrameId),this.timeoutId&&clearTimeout(this.timeoutId)},r.prototype.dispose=function(){this.stop(),this.canvas&&(this.canvas.remove(),this.canvas=null)},r.prototype.set=function(e,t){this.interpolation[e]=t},r.prototype.setSpeed=function(e){this.set("speed",e)},r.prototype.setAmplitude=function(e){this.set("amplitude",e)},r}()}()},906978:(e,t,s)=>{"use strict";s.d(t,{API_ERROR_ACCESS:()=>d,API_ERROR_AUTH:()=>r,API_ERROR_AUTH_VALIDATION:()=>l,API_ERROR_CAPTCHA:()=>c,API_ERROR_FLOOD:()=>i,API_ERROR_LIMITS:()=>f,API_ERROR_MESSAGES_CHAT_ADD_TEMPORARY_DENIED:()=>A,API_ERROR_MESSAGES_CHAT_CANT_ADD_USER_BY_PRIVACY:()=>E,API_ERROR_MESSAGES_CHAT_DISABLED:()=>w,API_ERROR_MESSAGES_CHAT_MEMBER_NOT_STAFF:()=>M,API_ERROR_MESSAGES_CHAT_NOT_ADMIN:()=>v,API_ERROR_MESSAGES_CHAT_UNSUPPORTED:()=>b,API_ERROR_MESSAGES_CHAT_USER_NO_ACCESS:()=>_,API_ERROR_MESSAGES_CHAT_WAS_DELETED:()=>N,API_ERROR_MESSAGES_CONTACT_NOT_FOUND:()=>k,API_ERROR_MESSAGES_FOLDERS_LIMIT_REACHED:()=>S,API_ERROR_MESSAGES_GROUP_PEER_ACCESS:()=>y,API_ERROR_MESSAGES_MEMBER_ACCESS_TO_GROUP_DENIED:()=>R,API_ERROR_MESSAGES_MESSAGE_REQUEST_ALREADY_SENT:()=>I,API_ERROR_MESSAGES_SHOULD_BE_EDU:()=>P,API_ERROR_MESSAGES_SHOULD_NOT_BE_EDU:()=>F,API_ERROR_MESSAGES_SPAM_RESTRICTION:()=>U,API_ERROR_MESSAGES_TOO_LONG_MESSAGE:()=>C,API_ERROR_MESSAGES_WRITING_DISABLED_FOR_CHAT:()=>T,API_ERROR_METHOD_DISABLED:()=>u,API_ERROR_PARAM:()=>g,API_ERROR_RATE_LIMIT:()=>h,API_ERROR_SECTION_DISABLED:()=>m,API_ERROR_SERVER:()=>o,API_ERROR_TOO_MANY:()=>a,API_ERROR_UNKNOWN:()=>n,API_ERROR_UNKNOWN_USER:()=>p,API_ERROR_USER_DEACTIVATED:()=>x});const n=1,r=5,a=6,i=9,o=10,c=14,d=15,l=17,u=23,h=29,p=39,m=43,g=100,f=103,C=914,_=917,v=925,y=932,k=936,I=939,w=945,b=946,R=947,M=967,S=975,E=981,A=982,U=984,T=1012,P=1015,F=1016,N=1017,x=3610},598311:(e,t,s)=>{"use strict";s.d(t,{Player:()=>i});var n=s(324389),r=s(105465);const a="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=";class i extends n.EventEmitter{play(e,t){this.state.currentTrackEntity?.audioTrack?.url!==e.audioTrack.url?("stopped"!==this.state.status&&this.stopCurrentTrackBeforeStartingNewTrack(),this.startNewTrack(e,t)):"stopped"===this.state.status?this.repeateCurrentTrack(e,t):"paused"===this.state.status?this.resumeTrack(e,t):this.player.currentTime=e.audioTrack.duration*e.audioTrack.progress}playNext(e,t){const{shuffle:s,repeatMode:n}=this.getState(),r=t?.getNext(e,s,n);r&&this.play(r,t)}playPrev(e,t){const{shuffle:s,repeatMode:n}=this.getState(),r=t?.getPrev(e,s,n);r&&this.play(r,t)}pause(){const{currentTrackEntity:e,playlist:t,playedTimeAccumulator:s}=this.state,n=e?.audioTrack;if(n){const{currentTime:a}=this.player,{duration:i}=n,o={...this.state,status:"paused",playlist:t,playedTimeAccumulator:s,currentTrackEntity:{...e,audioTrack:{...n,progress:a/i}}};this.setState(o),this.player.pause();const c={state:o};this.emit(r.PlayerEventTypes.PAUSE_CURRENT_TRACK,c)}}resume(){const{currentTrackEntity:e,playlist:t}=this.state,s=e?.audioTrack;s&&this.resumeTrack(e,t)}resetCurrentTrackState(){const{currentTrackEntity:e,playlist:t,playedTimeAccumulator:s}=this.state,n=e?.audioTrack;if(n){const r={...this.state,status:"stopped",playlist:t,playedTimeAccumulator:s,currentTrackEntity:{...e,audioTrack:{...n,progress:0}}};this.setState(r)}}startNewTrack(e,t){const s={...this.getState(),status:"playing",playlist:t,playedTimeAccumulator:{},currentTrackEntity:e};this.setState(s);const n={state:s};this.emit(r.PlayerEventTypes.START_NEW_TRACK,n);const a=e.audioTrack.url,i=e.audioTrack.duration*e.audioTrack.progress;this.playHTML5Player(a,i)}resumeTrack(e,t){const s=this.getState(),n={...s,status:"playing",playlist:t,playedTimeAccumulator:s.playedTimeAccumulator,currentTrackEntity:e},a=s.currentTrackEntity?.audioTrack?.url;let i;this.player.duration!==1/0&&this.state.currentTrackEntity?.audioTrack?.progress!==e.audioTrack.progress&&(i=e.audioTrack.duration*e.audioTrack.progress),this.setState(n);const o={state:n};this.emit(r.PlayerEventTypes.RESUME_TRACK,o),this.playHTML5Player(a,i)}repeateCurrentTrack(e,t){this.startNewTrack(e,t)}startNextTrackAutomatically(){const e=this.getState(),{playlist:t,currentTrackEntity:s,repeatMode:n,shuffle:a}=e;let i={state:e};if(!t||!s)return void this.emit(r.PlayerEventTypes.PLAYLIST_ENDED,i);const o="one"===n?{...s,audioTrack:{...s.audioTrack,progress:0}}:t.getNext(s,a,n);if(!o)return void this.emit(r.PlayerEventTypes.PLAYLIST_ENDED,i);const c={...e,status:"playing",playlist:t,playedTimeAccumulator:{},currentTrackEntity:o};this.setState(c),i={state:c},this.emit(r.PlayerEventTypes.START_NEXT_TRACK_AUTOMATICALLY,i);const d=o.audioTrack.url,l=o.audioTrack.duration*o.audioTrack.progress;this.playHTML5Player(d,l)}stopCurrentTrackAutomatically(){const{currentTrackEntity:e}=this.state;if(e){const e={state:{...this.state}};this.emit(r.PlayerEventTypes.STOP_CURRENT_TRACK_AUTOMATICALLY,e),this.resetCurrentTrackState(),this.player.duration===1/0&&(this.player.src="")}}stopCurrentTrackBeforeStartingNewTrack(){const{currentTrackEntity:e,status:t}=this.state,s=e?.audioTrack;if(s&&"playing"===t){this.player.pause();const e={state:{...this.state,status:"stopped"}};this.emit(r.PlayerEventTypes.STOP_CURRENT_TRACK_BEFORE_STARTING_NEW_TRACK,e),this.resetCurrentTrackState()}else s&&"paused"===t&&this.resetCurrentTrackState()}stopCurrentTrackByError(){const{currentTrackEntity:e}=this.state,t=e?.audioTrack;if(t){this.resetCurrentTrackState();const e={state:this.state};this.emit(r.PlayerEventTypes.STOP_CURRENT_TRACK_BY_ERROR,e)}}stopPlayer(){this.state.currentTrackEntity?.audioTrack&&(this.pause(),this.resetCurrentTrackState(),this.setState({...this.state,currentTrackEntity:void 0,playlist:void 0}))}seek(e){const t=this.getState(),{currentTrackEntity:s}=t,n=s?.audioTrack;if(!n)return;const r={...t,currentTrackEntity:{...s,audioTrack:{...n,progress:e}}};this.player.currentTime=n.duration*e,this.setState(r)}setState(e){this.state=e,this.player.volume=e.volume/100,this.player.muted=e.mute,this.player.playbackRate=e.playbackRate,this.emit("stateupdated",e)}getState(){return{...this.state}}forceUpdate(e){this.setState(e),this.player.src=e.currentTrackEntity?.audioTrack?.url||a}setVolume(e){const t={...this.getState(),mute:!1,volume:e};this.setState(t)}setMute(e){const t={...this.getState(),mute:e};this.setState(t)}setShuffle(e){const t={...this.getState(),shuffle:e};this.setState(t)}setRepeatMode(e){const t={...this.getState(),repeatMode:e};this.setState(t)}setPlaybackRate(e){const t=this.getState();this.setState({...t,playbackRate:e})}playHTML5Player(e,t){"number"==typeof t&&(this.player.currentTime=t),e&&this.player.src!==e&&(this.player.src=e),this.player.play().then((()=>{"playing"!==this.getState().status&&this.player.pause(),e&&this.player.src!==e&&this.player.pause()})).catch((()=>{this.stopCurrentTrackByError()}))}constructor(e){super(),this.state=e,this.player=document.createElement("audio"),this.player.volume=e.volume/100,this.player.src=a,this.player.playbackRate=e.playbackRate,this.player.addEventListener("ended",(()=>{const{currentTrackEntity:e}=this.state,t=e?.audioTrack;if(t){const e={...this.state,status:"ended"};this.setState(e),this.stopCurrentTrackAutomatically(),this.startNextTrackAutomatically()}})),this.player.addEventListener("error",(()=>{this.stopCurrentTrackByError()})),this.player.addEventListener("timeupdate",(()=>{const e={...this.state};if(e.currentTrackEntity?.audioTrack){const{currentTime:t,duration:s}=this.player,{duration:n,progress:r,id:a}=e.currentTrackEntity.audioTrack,i=t/n;i>0&&(e.playedTimeAccumulator[a]=(e=>{const t=e.played;let s=0;for(let e=0;e<t.length;e++)s+=t.end(e)-t.start(e);return s})(this.player)),this.setState({...e,currentTrackEntity:{...e.currentTrackEntity,audioTrack:{...e.currentTrackEntity.audioTrack,progress:i>1?1:i}}}),s===1/0&&(0===i&&0!==r||i>1)&&this.player.dispatchEvent(new Event("ended"))}}))}}},55532:(e,t,s)=>{"use strict";s.d(t,{PlayerStorage:()=>a,VoicePlayerStorage:()=>i});var n=s(485590),r=s(114626);class a extends n.Storage{getPlaylist(){const e=this.get("reforged_audio_player_playlist");if((0,r.isRestoredConvoAudiosPlaylist)(e))return new r.ConvoAudiosPlaylist(e)}getCurrentTrack(){const e=this.get("reforged_audio_player_track");if((0,r.isConvoAudioTrack)(e))return e}getVolume(){return this.get("reforged_audio_player_volume")}storeVolume(e){this.set("reforged_audio_player_volume",e)}getMute(){return this.get("reforged_audio_player_mute")}storeMute(e){this.set("reforged_audio_player_mute",e)}getShuffle(){return this.get("reforged_audio_player_shuffle")}storeShuffle(e){this.set("reforged_audio_player_shuffle",e)}getRepeatMode(){return this.get("reforged_audio_player_repeat_mode")}storeRepeatMode(e){this.set("reforged_audio_player_repeat_mode",e)}invalidatePlayerStateCache(){const e=this.get("reforged_audio_player_saved")||0;Date.now()-72e5>e&&(this.del("reforged_audio_player_playlist"),this.del("reforged_audio_player_saved"),this.del("reforged_audio_player_track"))}restorePlayerState(){this.invalidatePlayerStateCache();const e=this.getVolume()||100,t=this.getMute()||!1,s=this.getShuffle()||!1,n=this.getRepeatMode()||"none";return{status:"stopped",playedTimeAccumulator:{},currentTrackEntity:this.getCurrentTrack(),playlist:this.getPlaylist(),volume:e,mute:t,shuffle:s,repeatMode:n,playbackRate:1}}storePlayerState(e){const{currentTrackEntity:t,playlist:s,volume:n}=e;this.set("reforged_audio_player_saved",Date.now()),this.set("reforged_audio_player_volume",n),t?this.set("reforged_audio_player_track",t):this.del("reforged_audio_player_track"),s?s instanceof r.ConvoAudiosPlaylist&&this.set("reforged_audio_player_playlist",{meta:s.getPlaylistMeta(),list:s.getConvoAudiosList()}):this.del("reforged_audio_player_playlist")}}class i extends n.Storage{getVolume(){return this.get("reforged_voice_player_volume")}storeVolume(e){this.set("reforged_voice_player_volume",e)}getMute(){return this.get("reforged_voice_player_mute")}storeMute(e){this.set("reforged_voice_player_mute",e)}getPlaybackRate(){return this.get("reforged_voice_player_playback_rate")}storePlaybackRate(e){this.set("reforged_voice_player_playback_rate",e)}restorePlayerState(){return{status:"stopped",playedTimeAccumulator:{},volume:this.getVolume()||100,mute:this.getMute()||!1,shuffle:!1,repeatMode:"none",playbackRate:this.getPlaybackRate()||1}}}},74913:(e,t,s)=>{"use strict";s.d(t,{BroadcastChannel:()=>r});var n=s(324389);class r extends n.EventEmitter{emit(e){const t=this.connectionId,s=JSON.stringify((e=>({__act:e}))(e));window.localStorage.removeItem(t),window.localStorage.setItem(t,s)}emitLocally(e,t){super.emit(e,t)}constructor(){super(),this.connectionId="queue_connection_events_queue78668286",window.addEventListener("storage",(e=>{try{if(e.key===this.connectionId&&e.newValue){const t=JSON.parse(e.newValue),s=t?.__act;s&&super.emit(s)}}catch{}}))}}},869993:(e,t,s)=>{"use strict";s.d(t,{ExternalEvents:()=>n});class n{constructor(){this.listeners=[],this.send=(e,t)=>{for(const s of this.listeners)s(e,t)},this.subscribe=e=>(this.listeners.push(e),()=>{this.listeners=this.listeners.filter((t=>t!==e))})}}},36764:(e,t,s)=>{"use strict";s.d(t,{MEAppMediaMediator:()=>r});var n=s(74913);class r{constructor(){this.broadcastChannel=new n.BroadcastChannel,this.player=null,this.voicePlayer=null,this.videoMessagePlayer=null,this.currentMedia=null,this.prevMedia=null,this.destroy=()=>{this.currentMedia=null,this.prevMedia=null,this.player=null,this.voicePlayer=null,this.videoMessagePlayer=null,this.broadcastChannel.unsubscribe("audio_start",this.pauseCurrentMedia),this.broadcastChannel.unsubscribe("video_message_start",this.pauseCurrentMedia),this.broadcastChannel.unsubscribe("stories_video_start",this.pauseCurrentMedia)},this.pauseCurrentMedia=()=>{this.currentMedia?.isPlaying()&&this.currentMedia.handleMediaMediatorPause()},this.handlePlayerOn=e=>{if(this.broadcastChannel.emit("audio_start"),this.player=e,this.currentMedia){if(this.currentMedia&&this.currentMedia!==this.player){this.currentMedia.isPlaying()?(this.currentMedia.handleMediaMediatorPause(),this.prevMedia=this.currentMedia,this.currentMedia=this.player):(this.prevMedia=null,this.currentMedia=this.player)}}else this.prevMedia=null,this.currentMedia=this.player},this.handleVoicePlayerOn=e=>{if(this.broadcastChannel.emit("audio_start"),this.voicePlayer=e,this.currentMedia){if(this.currentMedia&&this.currentMedia!==this.voicePlayer){this.currentMedia.isPlaying()?(this.currentMedia.handleMediaMediatorPause(),this.prevMedia=this.currentMedia,this.currentMedia=this.voicePlayer):(this.prevMedia=null,this.currentMedia=this.voicePlayer)}}else this.prevMedia=null,this.currentMedia=this.voicePlayer},this.handleVoicePlayerOff=e=>{this.voicePlayer=e,this.currentMedia&&this.currentMedia===this.voicePlayer&&(this.currentMedia=null,this.prevMedia&&(this.prevMedia.handleMediaMediatorResume(),this.currentMedia=this.prevMedia,this.prevMedia=null))},this.handleVideoMessagePlayerOn=e=>{if(this.broadcastChannel.emit("video_message_start"),this.videoMessagePlayer=e,this.currentMedia){if(this.currentMedia&&this.currentMedia!==this.videoMessagePlayer){this.currentMedia.isPlaying()?(this.currentMedia.handleMediaMediatorPause(),this.prevMedia=this.currentMedia,this.currentMedia=this.videoMessagePlayer):(this.prevMedia=null,this.currentMedia=this.videoMessagePlayer)}}else this.prevMedia=null,this.currentMedia=this.videoMessagePlayer},this.handleVideoMessagePlayerOff=e=>{this.videoMessagePlayer=e,this.currentMedia&&this.currentMedia===this.videoMessagePlayer&&(this.currentMedia=null,this.prevMedia&&(this.prevMedia.handleMediaMediatorResume(),this.currentMedia=this.prevMedia,this.prevMedia=null))},this.handleVoiceRecorderOn=()=>{if(this.broadcastChannel.emit("audio_start"),this.currentMedia||this.prevMedia!==this.player)if(this.currentMedia){if(this.currentMedia){this.currentMedia.isPlaying()?(this.currentMedia.handleMediaMediatorPause(),this.prevMedia=this.currentMedia,this.currentMedia=null):(this.prevMedia=null,this.currentMedia=null)}}else this.prevMedia=null,this.currentMedia=null},this.handleVoiceRecorderOff=()=>{this.prevMedia&&this.prevMedia===this.player?(this.prevMedia.handleMediaMediatorResume(),this.currentMedia=this.prevMedia,this.prevMedia=null):(this.currentMedia=null,this.prevMedia=null)},this.broadcastChannel.subscribe("audio_start",this.pauseCurrentMedia),this.broadcastChannel.subscribe("video_message_start",this.pauseCurrentMedia),this.broadcastChannel.subscribe("stories_video_start",this.pauseCurrentMedia)}}},51196:(e,t,s)=>{"use strict";s.d(t,{MEAppPlayer:()=>c,MEAppVideoMessagePlayer:()=>l,MEAppVoicePlayer:()=>d});var n=s(598311),r=s(854492),a=s(55532),i=s(105465),o=s(33200);class c extends n.Player{play(e,t){return this.mediaMediator.handlePlayerOn(this),super.play(e,t)}setVolume(e){super.setVolume(e);const{volume:t,mute:s}=this.getState();this.playerStorage.storeVolume(t),this.playerStorage.storeMute(s)}setMute(e){super.setMute(e);const{volume:t,mute:s}=this.getState();this.playerStorage.storeVolume(t),this.playerStorage.storeMute(s)}setShuffle(e){super.setShuffle(e);const{shuffle:t}=this.getState();this.playerStorage.storeShuffle(t)}setRepeatMode(e){super.setRepeatMode(e);const{repeatMode:t}=this.getState();this.playerStorage.storeRepeatMode(t)}stopPlayer(){super.stopPlayer();const e=this.getState();this.playerStorage.storePlayerState({...e,status:"stopped"})}isPlaying(){const{status:e}=this.getState();return"playing"===e}handleMediaMediatorResume(){super.resume()}handleMediaMediatorPause(){super.pause()}constructor(e,t){super({status:"stopped",playedTimeAccumulator:{},volume:100,mute:!1,shuffle:!1,repeatMode:"none",playbackRate:1}),this.subscribe(i.PlayerEventTypes.START_NEW_TRACK,(e=>{this.playerStorage.storePlayerState({...e.state,status:"stopped"})})),this.subscribe(i.PlayerEventTypes.START_NEXT_TRACK_AUTOMATICALLY,(e=>{this.playerStorage.storePlayerState({...e.state,status:"stopped"})})),this.mediaMediator=e,this.playerStorage=new a.PlayerStorage(o.STORAGE_DB_NAME),this.playerStorage.identify(t);const s=this.playerStorage.restorePlayerState();this.forceUpdate(s)}}class d extends n.Player{setVolume(e){super.setVolume(e);const{volume:t,mute:s}=this.getState();this.playerStorage?.storeVolume(t),this.playerStorage?.storeMute(s)}setMute(e){super.setMute(e);const{volume:t,mute:s}=this.getState();this.playerStorage?.storeVolume(t),this.playerStorage?.storeMute(s)}setPlaybackRate(e){super.setPlaybackRate(e);const{playbackRate:t}=this.getState();this.playerStorage?.storePlaybackRate(t)}play(e,t){return this.mediaMediator.handleVoicePlayerOn(this),super.play(e,t)}isPlaying(){const{status:e}=this.getState();return"playing"===e}handleMediaMediatorResume(){super.resume()}handleMediaMediatorPause(){super.pause()}constructor(e,t){super({status:"stopped",playedTimeAccumulator:{},volume:100,mute:!1,shuffle:!1,repeatMode:"none",playbackRate:1}),this.mediaMediator=e,this.subscribe(i.PlayerEventTypes.PLAYLIST_ENDED,(()=>this.mediaMediator.handleVoicePlayerOff(this))),this.playerStorage=new a.VoicePlayerStorage(o.STORAGE_DB_NAME),this.playerStorage.identify(t);const s=this.playerStorage.restorePlayerState();this.forceUpdate(s)}}class l extends r.VideoMessagePlayer{play(e,t){this.mediaMediator.handleVideoMessagePlayerOn(this),super.play(e,t)}resume(){this.mediaMediator.handleVideoMessagePlayerOn(this),super.resume()}stop(){this.mediaMediator.handleVideoMessagePlayerOff(this),super.stop()}destroy(){this.mediaMediator.destroy()}isPlaying(){const{status:e}=this.getState();return"playing"===e}handleMediaMediatorResume(){super.resume()}handleMediaMediatorPause(){super.pause()}constructor(e){super({status:"stopped",settings:{volume:1,playbackRate:1,muted:!1}}),this.pause=()=>{super.pause(),this.mediaMediator.handleVideoMessagePlayerOff(this)},this.mediaMediator=e}}},161680:(e,t,s)=>{"use strict";s.d(t,{MEAppRecorder:()=>r});var n=s(602163);class r extends n.Recorder{start(){return this.mediaMediator.handleVoiceRecorderOn(),super.start()}pause(){const e=super.pause();return this.mediaMediator.handleVoiceRecorderOff(),e}resume(){return this.mediaMediator.handleVoiceRecorderOn(),super.resume()}stop(){const e=super.stop();return this.mediaMediator.handleVoiceRecorderOff(),e}constructor(e={},t,s){super(e,s),this.mediaMediator=t}}},602163:(e,t,s)=>{"use strict";s.d(t,{Recorder:()=>r});const n={bufferLength:4096,encoderApplication:2049,encoderFrameSize:20,encoderSampleRate:48e3,maxFramesPerPage:40,mediaTrackConstraints:!0,monitorGain:0,numberOfChannels:1,recordingGain:1,resampleQuality:3,streamPages:!0,wavBitDepth:16,encoderPath:new URL(s(923562),s.b).href,reuseWorker:!0};class r{initWorklet(){return this.audioContext.audioWorklet?this.audioContext.audioWorklet.addModule(this.config.encoderPath):Promise.resolve()}initEncoder(){this.audioContext.audioWorklet&&(this.encoderNode=new AudioWorkletNode(this.audioContext,"encoder-worklet",{numberOfOutputs:0}),this.encoder=this.encoderNode.port)}storePage(e){this.recordedPages.push(e),this.totalLength+=e.length}streamPage(e){this.onDataAvailable(e)}clearStream(){this.stream&&this.stream.getTracks&&this.stream.getTracks().forEach((e=>e.stop()))}suspendAudioContext(){if("suspended"!==this.audioContext.state)try{this.audioContext.suspend()}catch{}}finish(){if(!this.config.streamPages){const e=new Uint8Array(this.totalLength);this.recordedPages.reduce(((t,s)=>(e.set(s,t),t+s.length)),0),this.onDataAvailable(e),this.recordedPages=[],this.totalLength=0}this.onStop()}initWorker(){const e=(this.config.streamPages?this.streamPage:this.storePage).bind(this);return this.recordedPages=[],this.totalLength=0,new Promise((t=>{const s=({data:n})=>{switch(n.message){case"ready":t();break;case"page":e(n.page);break;case"done":this.encoder?.removeEventListener("message",s),this.finish()}};this.encoder?.addEventListener("message",s),this.encoder?.start&&this.encoder.start(),this.encoder?.postMessage(Object.assign({command:"init",originalSampleRate:this.audioContext.sampleRate,wavSampleRate:this.audioContext.sampleRate},this.config))}))}initSourceNode(){return window.navigator.mediaDevices.getUserMedia({audio:this.config.mediaTrackConstraints}).then((e=>{this.stream=e,this.sourceNode=this.audioContext.createMediaStreamSource(e)}))}start(){return"inactive"===this.state?(this.state="loading",this.audioContext.resume().then((()=>this.initialize)).then((()=>Promise.all([this.initSourceNode(),this.initWorker()]))).then((()=>{this.sourceNode&&this.encoderNode?(this.state="recording",this.encoder?.postMessage({command:"getHeaderPages"}),this.sourceNode?.connect(this.monitorGainNode),this.sourceNode?.connect(this.recordingGainNode),this.monitorGainNode.connect(this.audioContext.destination),this.recordingGainNode.connect(this.encoderNode),this.onStart()):this.state="inactive"})).catch((e=>{throw this.suspendAudioContext(),this.state="inactive",e}))):Promise.resolve()}pause(){return"recording"===this.state?(this.state="paused",this.recordingGainNode.disconnect(),new Promise((e=>{const t=({data:s})=>{"flushed"===s.message&&(this.encoder?.removeEventListener("message",t),this.onPause(),e())};this.encoder?.addEventListener("message",t),this.encoder?.start(),this.encoder?.postMessage({command:"flush"})}))):(this.onPause(),Promise.resolve())}resume(){"paused"===this.state&&this.encoderNode&&(this.state="recording",this.recordingGainNode.connect(this.encoderNode),this.onResume())}stop(){return this.resume(),"recording"===this.state?(this.state="inactive",this.monitorGainNode.disconnect(),this.clearStream(),this.suspendAudioContext(),new Promise((e=>{const t=({data:s})=>{"done"===s.message&&(this.encoder?.removeEventListener("message",t),e())};this.encoder?.addEventListener("message",t),this.encoder?.start(),this.encoder?.postMessage({command:"done"})}))):(this.onStop(),Promise.resolve())}subscribeToAnalyzer(e){const t=this.sourceNode,s=t.context.createAnalyser();s.fftSize=64,t.connect(s);const n=s.frequencyBinCount,r=new Uint8Array(n);let a=!1;function i(){if(a)return;s.getByteFrequencyData(r);const t=r.reduce(((e,t)=>e+t),0)/n/255;e(t<.1?0:t),requestAnimationFrame(i)}return i(),[()=>{a=!0},()=>{a=!1,i()}]}constructor(e={},t){this.state="inactive",this.config=n,this.recordedPages=[],this.totalLength=0,this.onDataAvailable=function(e){},this.onStart=function(){},this.onPause=function(){},this.onResume=function(){},this.onStop=function(){},this.config={...n,...e};try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.suspendAudioContext.call(this)}catch(e){t.info(`[VoiceRecorder]: new AudioContext ERROR: ${e}`),this.audioContext={createGain(){}}}this.monitorGainNode=this.audioContext.createGain(),this.monitorGainNode&&this.audioContext&&this.monitorGainNode.gain.setTargetAtTime(this.config.monitorGain,this.audioContext.currentTime,.01),this.recordingGainNode=this.audioContext.createGain(),this.recordingGainNode&&this.audioContext&&this.recordingGainNode.gain.setTargetAtTime(this.config.recordingGain,this.audioContext.currentTime,.01),this.initialize=this.initWorklet().then((()=>this.initEncoder()))}}},485590:(e,t,s)=>{"use strict";s.d(t,{Storage:()=>r});var n=s(891047);class r{mapKey(e){if(!this.viewerPeerId)throw new Error("Перед использованием Storage должен быть идентифицирован!");return`${this.dbName}-${this.viewerPeerId}-${e}`}constructor(e,t){this.idbStoreName="storage",this.identify=e=>{this.viewerPeerId=e},this.get=e=>{const t=this.mapKey(e);try{const e=localStorage.getItem(t);if(!e)return;return JSON.parse(e,i)}catch(e){return void this.logger?.info("Не удалось получить значение из Storage",e)}},this.set=(e,t)=>{const s=this.mapKey(e);try{localStorage.setItem(s,JSON.stringify(t,a))}catch(e){this.logger?.info("Не удалось записать значение в Storage",e)}},this.del=e=>{const t=this.mapKey(e);try{localStorage.removeItem(t)}catch(e){this.logger?.info("Не удалось удалить значение из Storage",e)}},this.getIDB=async e=>{try{const t=this.mapKey(e);return await n.get(t,this.idbStorage)}catch(e){return void this.logger?.info("Не удалось получить значение из IndexedDB Storage",e)}},this.setIDB=async(e,t)=>{try{const s=this.mapKey(e);return await n.set(s,t,this.idbStorage)}catch(e){this.logger?.info("Не удалось записать значение в IndexedDB Storage",e)}},this.updateIDB=async(e,t)=>{try{const s=this.mapKey(e);return n.update(s,t,this.idbStorage)}catch(e){this.logger?.info("Не удалось обновить значение в IndexedDB Storage",e)}},this.delIDB=async e=>{try{const t=this.mapKey(e);return await n.del(t,this.idbStorage)}catch(e){this.logger?.info("Не удалось удалить значение из IndexedDB Storage",e)}},this.dbName=e,this.logger=t;try{this.idbStorage=window.indexedDB&&n.createStore(e,this.idbStoreName)}catch(e){t?.info("Не удалось создать Storage",e)}}}function a(e,t){return t instanceof Map?{dataType:"Map",entries:Array.from(t.entries())}:t instanceof Set?{dataType:"Set",values:Array.from(t.values())}:t}function i(e,t){if("object"==typeof t&&null!==t){if("Map"===t.dataType)return new Map(t.entries);if("Set"===t.dataType)return new Set(t.values)}return t}},854492:(e,t,s)=>{"use strict";s.d(t,{VideoMessagePlayer:()=>o});var n=s(324389),r=s(105465),a=s(139331);const i={volume:1,playbackRate:1};class o extends n.EventEmitter{updateProgressState(e){const{currentVideoMessageTrack:t}=this.state;t&&this.setState({...this.state,currentVideoMessageTrack:{...t,progress:e}})}setVolume(e){this.setState({...this.state,settings:{...this.state.settings,muted:!1,volume:e}}),this.player.muted=!1,this.player.volume=e,localStorage.setItem("videomessage_settings",JSON.stringify(this.state.settings))}setMuted(e){const t={...this.state,settings:{...this.state.settings,muted:e}};this.setState(t),this.player.muted=e}setPlaybackRate(e){this.setState({...this.state,settings:{...this.state.settings,playbackRate:e}}),this.player.playbackRate=e,localStorage.setItem("videomessage_settings",JSON.stringify(this.state.settings))}stop(){this.player.pause(),this.player.currentTime=0,this.player.src="",this.setState({...this.state,status:"stopped",playlist:void 0,currentVideoMessageTrack:void 0})}play(e,t){this.playHTML5Player(t,t.progress),this.setState({...this.state,status:"playing",convoPeerId:e,currentVideoMessageTrack:t})}move(e=!1){if(!this.state.currentVideoMessageTrack)return;const{playlist:t}=this.state;if(t){const s=e?t.getPrev(this.state.currentVideoMessageTrack):t.getNext(this.state.currentVideoMessageTrack),{source:n}=t.getPlaylistMeta();if(s&&"message"===n?.kind)return this.play(n.peerId,s),this.scrollToMessage(),s;this.stop()}else this.stop()}pause(){const{currentVideoMessageTrack:e}=this.state;e&&(this.player.pause(),this.setState({...this.state,status:"paused"}))}resume(){const{currentVideoMessageTrack:e}=this.state;e&&(this.playHTML5Player(e),this.setState({...this.state,status:"playing"}))}endTrack(){this.setState({...this.state,status:"ended"});const{playlist:e}=this.state;e?this.move():this.stop()}setProgress(e){const{currentVideoMessageTrack:t}=this.state;t&&(this.player.currentTime=(t.duration??0)*e,this.updateProgressState(e))}scrollToMessage(){this.state.currentVideoMessageTrack&&this.emit(r.VideoMessagePlayerEventTypes.SCROLL_TO_MESSAGE,this.state.currentVideoMessageTrack.id)}stopCurrentTrackByError(e){const{currentVideoMessageTrack:t}=this.state;t?.id===e&&this.setState({...this.state,status:"stopped",currentVideoMessageTrack:{...t,progress:0}})}setState(e){this.state=e,this.emit(r.VideoMessagePlayerEventTypes.STATE_UPDATED,e)}getState(){return this.state}getPlayer(){return this.player}forceUpdate(e){this.setState(e)}setPlaylist(e){this.setState({...this.state,playlist:e})}tick(){const{currentVideoMessageTrack:e}=this.state;if(e){const{currentTime:t,duration:s}=this.player,{duration:n=1,progress:r=0}=e,a=t/n;this.updateProgressState(a>1?1:a),s===1/0&&0===a&&0!==r&&this.player.dispatchEvent(new Event("ended"))}}playHTML5Player(e,t){const s=(0,a.getVideoSource)(e.files);"number"==typeof t&&(this.player.currentTime=t),s&&this.player.src!==s&&(this.player.src=s),this.player.volume=this.state.settings.volume,this.player.playbackRate=this.state.settings.playbackRate,this.player.muted=this.state.settings.muted,this.player.play().then((()=>{const{status:e}=this.state;"playing"!==e&&this.player.pause(),s&&this.player.src!==s&&this.player.pause()})).catch((()=>{this.stopCurrentTrackByError(e.id)}))}constructor(e){super(),this.player=document.createElement("video"),this.player.disablePictureInPicture=!0,this.player.playsInline=!0,this.player.src="",this.state=e;const t=localStorage.getItem("videomessage_settings");this.state.settings=t?JSON.parse(t):i,this.player.addEventListener("ended",(()=>{this.endTrack()})),this.player.addEventListener("timeupdate",(()=>{this.tick()})),this.player.addEventListener("error",(()=>{const{currentVideoMessageTrack:e}=this.state;e&&this.stopCurrentTrackByError(e.id)}))}}},139331:(e,t,s)=>{"use strict";function n(e,t,s,n,r){return{...t,id:`${s}_${t.id}`,rootMessageId:s,progress:e,messageSentAt:n,messageAuthorId:r}}function r(e){return e?.mp4_2160||e?.mp4_1440||e?.mp4_1080||e?.mp4_720||e?.mp4_480||e?.mp4_360||e?.mp4_240||e?.mp4_144||""}s.d(t,{getVideoSource:()=>r,toVideoMessageTrack:()=>n})},921530:(e,t,s)=>{"use strict";s.d(t,{searchChannels:()=>p,searchConversations:()=>d,searchMessages:()=>l,searchPosts:()=>h,searchUsersGlobal:()=>u});var n=s(467635),r=s(207739),a=s(500955),i=s(33200),o=s(885540),c=s(482244);async function d(e,t,s,r){const a=await e("messages.searchConversations",{q:s,count:i.SEARCH_CONVOS_COUNT,extended:1,group_id:r}),{profiles:o,groups:c,items:d,contacts:l}=a;return t({profiles:o,groups:c,conversations:d,contacts:l}),d.reduce(((e,t)=>{const s=(0,n.fromApiConvo)(t);return s&&e.add(s.convo.peerId),e}),new Set)}async function l(e,t,s,n){const r=await e("messages.search",{...n,extended:1,count:i.SEARCH_MESSAGES_COUNT}),{items:o,count:c,conversations:d,contacts:l,profiles:u,groups:h}=r;s({profiles:u,groups:h,conversations:d,contacts:l});return{results:o.reduce(((e,s)=>{const n=(0,a.fromApiMessage)(s).message;return"Normal"===n.kind?e.push(n):t.error(`Сообщение неожиданного типа вернулось из message.search: ${n.kind}`),e}),[]),count:c,apiItemsCount:o.length}}async function u(e,t,s,n=!1){const a=await e(n?"meEducation.usersSearch":"users.search",s),{items:i,count:o}=a;t({profiles:i});return{results:i.map((e=>r.resolveRealId("User",e.id))),count:o}}async function h(e,t,s,n){const r=await e("wall.search",{owners_only:1,query:n.query,offset:n.offset,domain:n.channelId,extended:1,count:i.SEARCH_POSTS_COUNT}),{items:a,count:c,profiles:d,groups:l}=r;s({profiles:d,groups:l});return{results:a.reduce(((e,t)=>{const s=(0,o.fromApiSearchPost)(t);return s?(e.push(s),e):e}),[]),count:c,apiItemsCount:a.length}}async function p(e,{count:t,query:s,offset:n}){const r=await e("channels.search",{extended:1,target:"channels",q:s,count:t,offset:n}),{channels:a,count:i,groups:o}=r;return{items:a.reduce(((e,t)=>{const s=o?.find((e=>-e.id===t.channel.channel_id));if(!s)throw new Error("С бэка не приходит нужная группа для канала");const n=(0,c.fromApiChannel)(t,s);return e.push(n),e}),[]),apiCount:i}}},960361:(e,t,s)=>{"use strict";s.d(t,{useApiFetch:()=>o});var n=s(24513),r=s(667294),a=s(963196),i=s(53416);function o(){const{api:e}=(0,n.useBrowserEnv)(),t=(0,r.useRef)(new Set);return(0,r.useEffect)((()=>()=>{t.current.forEach((s=>{e.dangerouslyAbort(s),t.current.delete(s)}))}),[e]),(0,r.useCallback)(((s,n,r)=>{const o=r?.trackId??a.IApi.resolveTrackId(s,(0,i.nanoid)(5));return t.current.add(o),e.fetch(s,n,{...r,trackId:o})}),[e])}},595773:(e,t,s)=>{"use strict";s.d(t,{useFormatPhoneNumber:()=>a});var n=s(260349),r=s(667294);function a(){const[e,t]=(0,r.useState)(!1),a=(0,r.useRef)(null);(0,r.useEffect)((()=>{s.e(4387).then(s.bind(s,304387)).then((({getAsYouType:e})=>{a.current=e("RU"),t(!0)}))}),[]);return{isReady:e,format:(0,r.useCallback)((e=>{if(!a.current)return e;if(0===e.length)return"";const t=(0,n.preparePhoneNumber)(e);return a.current.reset(t.replace(/[^\d+]/g,"")),a.current.number().trim()}),[])}}},397390:(e,t,s)=>{"use strict";s.d(t,{useTabListNavigation:()=>a});var n=s(667294);const r=0;function a({hasMore:e=!1}){const[t,s]=(0,n.useState)(r),[a,i]=(0,n.useState)(!1),o=(0,n.useRef)(0),c=(0,n.useCallback)((e=>o.current=e),[]),d=(0,n.useRef)(),l=(0,n.useCallback)((e=>d.current=e),[]),u=(0,n.useCallback)(((e=r)=>{i(!1),s(e)}),[]),h=(0,n.useCallback)(((n,r)=>{if(0!==o.current)switch(n){case"Enter":r(),d.current?.(t);break;case"ArrowDown":r(),i(e&&t+1===o.current),s((e=>e+1<o.current?e+1:e));break;case"ArrowUp":r(),s((e=>e>0?e-1:0)),i(!1)}}),[t,e]);return{setTabsCount:c,setSelectHandler:l,indexToSelect:t,onKeyDown:h,resetIndexToSelect:u,forceScrollToLoader:a}}},60262:(e,t,s)=>{"use strict";s.d(t,{usePhoneJoin:()=>l});var n=s(667294),r=s(88074),a=s(207739),i=s(952644),o=s(24513),c=s(667302),d=s(122519);function l({onClose:e,onSuccess:t,onError:s,onMyNumberEntered:l,peerId:u}){const{api:h,lang:p}=(0,o.useBrowserEnv)(),{importContact:m}=(0,c.useImportContact)(),g=(0,o.useInsertIntoCache)(),[f,C]=(0,n.useState)(!1),[_,v]=(0,n.useState)(""),{profileType:y}=(0,o.useViewer)(),k=i.isEdu(y),I=(0,n.useCallback)((()=>{e(),C(!1),v("")}),[e]),w=(0,n.useCallback)((()=>v("")),[]),b=(0,n.useCallback)((async e=>{let n;C(!0);try{const s=await m({phone:e,name:"",withExisting:!0});if(s.hasFailed)return v(s.isMyPhoneNumber?p.use("me_phone_invite_error_already_exists"):p.use(k?"me_phone_invite_error_not_found_edu":"me_phone_invite_error_not_found")),void(s.isMyPhoneNumber&&l&&l());g({contacts:[s.contact],profiles:s.profile?[s.profile]:void 0}),n=(0,d.fromApiContact)(s.contact),u&&a.isChatPeerId(u)&&await h.fetch("messages.addChatUser",{peer_id:n.id,chat_id:a.toRealId(u),source:"phone"}),t(n.id)}catch(e){s?.(e,n)}finally{C(!1)}}),[h,m,g,p,s,t,l,u,k]),R=void 0!==u;return{modal:n.createElement(r.PhoneInviteModal,{onClose:I,onSubmit:b,onErrorReset:w,error:_,isLoading:f,title:p.use(R?"me_phone_invite_title":"me_phone_write_title"),subtitle:p.use(R?"me_phone_invite_subtitle":"me_phone_write_subtitle"),action:p.use(R?"me_phone_invite_action":"me_phone_write_action"),focusOnMount:!0})}}},813005:(e,t,s)=>{"use strict";s.d(t,{useChannelsSearchData:()=>A,useConvoSearch:()=>C,useConvoSearchData:()=>y,useMessagesSearchData:()=>I,usePostsSearchData:()=>w,useSearchHandlers:()=>_,useUsersGlobalSearchData:()=>M});var n=s(667294),r=s(24513),a=s(207739),i=s(503048),o=s(460167),c=s(921530),d=s(397390),l=s(216381),u=s(795947),h=s(960361),p=s(33200),m=s(952644),g=s(963196),f=s(53416);function C({onSelect:e,searchIndex:t,defaultResults:s}){const{setTabsCount:r,setSelectHandler:a,resetIndexToSelect:i,onKeyDown:o,indexToSelect:c,forceScrollToLoader:l}=(0,d.useTabListNavigation)({}),{query:u,setNavigationParams:h,...p}=_();(0,n.useEffect)((()=>{h({resetIndexToSelect:i,onKeyDown:o})}),[h,i,o]);const{results:m,isLoading:g,isDefault:f}=y({searchIndex:t,defaultResults:s,query:u}),C=(0,n.useMemo)((()=>S(m)??[]),[m]),v=(0,n.useCallback)((t=>{const s=C[t];void 0!==s&&e(s)}),[C,e]);return(0,n.useEffect)((()=>{a(v)}),[v,a]),(0,n.useEffect)((()=>{r(C.length)}),[C,r]),{query:u,...p,results:m,isLoading:g,isDefault:f,indexToSelect:c,forceScrollToLoader:l}}function _(e){const t=(0,n.useRef)(null),s=(0,n.useCallback)((e=>t.current=e),[]),[r,a]=(0,n.useState)(""),[i,o]=(0,n.useState)(!1),c=(0,n.useCallback)((e=>{a(e),t.current?.resetIndexToSelect()}),[]),d=(0,n.useCallback)((e=>c(e.target.value)),[c]),u=(0,n.useMemo)((()=>(0,l.onElementKeyDownFactory)(((s,n)=>{if("Escape"===s)n(),c(""),e?.current?.blur();t.current?.onKeyDown(s,n)}))),[c,e]),h=(0,n.useCallback)((()=>{o(!0)}),[]),p=(0,n.useCallback)((()=>{o(!1)}),[]),m=(0,n.useCallback)((()=>{c("")}),[c]),g=(0,n.useRef)(),[f,C]=(0,n.useState)(!1);return(0,n.useLayoutEffect)((()=>{i&&C(!1)}),[i]),(0,n.useLayoutEffect)((()=>{C(!r&&!!g.current),g.current=r}),[r]),{onChange:d,onKeyDown:u,onFocus:h,onBlur:p,reset:m,isFocused:i,becameEmpty:f,setNavigationParams:s,query:r,setQuery:c}}const v=new Set;function y({defaultResults:e=v,searchIndex:t,query:s}){const d=(0,r.useConvos)(),{vkm_delete_chat:l}=(0,r.useFeatureFlags)(),[m,g]=(0,n.useState)({isLoading:!1,results:e}),f=(0,n.useRef)(!0),{debounced:C,debouncedUpdatesCount:_}=(0,r.useDebounced)(s,p.SEARCH_DEBOUNCE_MS),y=(0,h.useApiFetch)(),k=(0,r.useOwner)(),I=(0,r.useInsertIntoCache)(),w=0===s.length,b=(0,r.usePeers)();(0,n.useEffect)((()=>{w&&(f.current=!0,g({isLoading:!1,results:e}))}),[w,e]),(0,n.useEffect)((()=>{if(w)return;f.current=!1;let e=t?o.search(t,s):new Set;l&&(e=new Set([...e].filter((e=>{const t=i.safeGet(d,e);return!i.isDeleted(t)})))),g({isLoading:!0,results:e})}),[s,w]);const R=(0,n.useRef)(s);R.current=s;const M=(0,n.useCallback)((async e=>{if(0!==e.length){g((e=>({...e,loading:!0})));try{const t=await(0,c.searchConversations)(y,I,e,(0,u.getOwnerGroupId)(k.id));if(R.current!==e)return;g((e=>{const s=new Set([...e.results.values()]);return t.forEach((e=>{if(a.isContactPeerId(e)){const t=b.get(e);if("Contact"===t?.kind&&t.userId)return}s.has(e)||s.add(e)})),{isLoading:!1,results:s}}))}catch{g((e=>({...e,loading:!1})))}}}),[y,I,k.id,b]);(0,n.useEffect)((()=>{M(C)}),[_,C]);const{isLoading:S,results:E}=m;let A;return A=s&&S&&0===E.size?"loading":s&&!S&&0===E.size?"empty":E,{results:A,isLoading:S,isDefault:f.current}}const k=[];function I({query:e,date:t,peerId:s}){const a=0===e.length&&!t,{logger:i}=(0,r.useBrowserEnv)(),o=(0,r.useOwner)(),d=(0,r.useInsertIntoCache)(),l=(0,h.useApiFetch)(),[p,m]=(0,n.useState)({isLoading:!1,hasMore:!0,results:k}),g=(0,n.useRef)(0),f=(0,n.useRef)(e);f.current=e;const C=(0,n.useCallback)((async e=>{if(!a){m((e=>({...e,isLoading:!0})));try{const n=await(0,c.searchMessages)(l,i,d,{q:e,peer_id:s,date:t,offset:g.current,group_id:(0,u.getOwnerGroupId)(o.id)});if(f.current!==e)return;const{results:r,count:a,apiItemsCount:h}=n;g.current+=h,m((e=>({isLoading:!1,hasMore:a>g.current&&h>0,results:[...e.results,...r]})))}catch{m((e=>({...e,isLoading:!1,hasMore:!1})))}}}),[a,s,t,l,d,i,o.id]),{isLoading:_,hasMore:v,results:y}=p,I=(0,n.useCallback)((()=>{v&&!_&&C(e)}),[v,_,C,e]);(0,n.useLayoutEffect)((()=>{g.current=0,a?m({isLoading:!1,hasMore:!1,results:k}):(m({isLoading:!0,hasMore:!0,results:[]}),C(e))}),[a,e,s,t]);return{results:0===y.length&&!_&&!v&&!a?"empty":y,isLoading:_,hasMore:v,loadMore:I}}function w({query:e,channelId:t}){const s=0===e.length,{logger:a}=(0,r.useBrowserEnv)(),i=(0,r.useInsertIntoCache)(),o=(0,h.useApiFetch)(),[d,l]=(0,n.useState)({isLoading:!1,hasMore:!0,results:[]}),u=(0,n.useRef)(0),m=(0,n.useRef)(e);m.current=e;const g=(0,n.useCallback)((async e=>{if(!s){l((e=>({...e,isLoading:!0})));try{if(!t)return;const s=await(0,c.searchPosts)(o,a,i,{query:e,channelId:t,offset:u.current});if(m.current!==e)return;const{results:n,apiItemsCount:r}=s;u.current+=r,l((e=>({isLoading:!1,hasMore:p.SEARCH_POSTS_COUNT===r,results:[...e.results,...n]})))}catch{l((e=>({...e,isLoading:!1,hasMore:!1})))}}}),[s,o,i,a,t]),{isLoading:f,hasMore:C,results:_}=d,v=(0,n.useCallback)((()=>{C&&!f&&g(e)}),[C,f,g,e]);(0,n.useLayoutEffect)((()=>{u.current=0,s?l({isLoading:!1,hasMore:!1,results:[]}):(l({isLoading:!0,hasMore:!0,results:[]}),g(e))}),[s,e,t]);return{results:0===_.length&&!f&&!C&&!s?"empty":_,isLoading:f,hasMore:C,loadMore:v}}const b=20,R=[];function M({query:e}){const t=0===e.length,s=(0,h.useApiFetch)(),a=(0,r.useFeatureFlags)(),{profileType:i,viewer:o}=(0,r.useViewer)(),d=a.vkm_add_non_friends&&!m.isEdu(i)||a.vkm_edu_global_users_search&&m.isEdu(i)&&o.isVerified,l=(0,r.useInsertIntoCache)(),[u,p]=(0,n.useState)({isLoading:!1,hasMore:!0,results:R}),g=(0,n.useRef)(0),f=(0,n.useRef)(e);f.current=e;const C=(0,n.useCallback)((async e=>{if(!t){p((e=>({...e,isLoading:!0})));try{const t=await(0,c.searchUsersGlobal)(s,l,{q:e,offset:g.current,count:b},m.isEdu(i));if(f.current!==e)return;const{results:n,count:r}=t;g.current+=b,p((e=>({isLoading:!1,hasMore:r>g.current&&0!==n.length,results:[...e.results,...n]})))}catch{p((e=>({...e,isLoading:!1,hasMore:!1})))}}}),[t,s,l,i]),{isLoading:_,hasMore:v,results:y}=u,k=(0,n.useCallback)((()=>{v&&!_&&d&&C(e)}),[v,_,C,e,d]),I=(0,n.useCallback)((()=>{p((e=>({...e,hasMore:!0,results:R})))}),[]);(0,n.useLayoutEffect)((()=>{g.current=0,!t&&d?(p({isLoading:!0,hasMore:!0,results:R}),C(e)):p({isLoading:!1,hasMore:!1,results:R})}),[t,e,d]);return{results:0===y.length&&!_&&!v&&!t?"empty":y,isLoading:_,hasMore:v,loadMore:k,reset:I}}const S=e=>"empty"===e||"loading"===e?null:Array.from(e.values()),E=({query:e,searchCount:t,defaultResults:s=[],loadResults:a})=>{const{api:i}=(0,r.useBrowserEnv)(),o=(0,h.useApiFetch)(),{debounced:c}=(0,r.useDebounced)(e,p.SEARCH_DEBOUNCE_MS),[d,l]=(0,n.useState)({results:s,hasMore:!0,query:""}),[u,m]=(0,n.useState)(!1),[C,_]=(0,n.useState)(void 0),v=(0,n.useRef)(""),y=(0,n.useRef)(0),k=(0,n.useRef)(void 0),I=(0,n.useCallback)((()=>{l({results:s,hasMore:!0,query:""}),v.current="",y.current=0,k.current=void 0,m(!1),_(void 0)}),[s]),w=(0,n.useCallback)((async(e,s=0)=>a(((e,t,s)=>{k.current&&i.dangerouslyAbort(k.current);const n=g.IApi.resolveTrackId(e,(0,f.nanoid)(5));return k.current=n,o(e,t,{...s,trackId:n})}),{query:e,offset:s,count:t})),[i,o,a,t]),b=(0,n.useCallback)((async(e,s)=>{m(!0),_(void 0);try{const n=await w(e,s);if(e!==v.current)return;l((t=>({results:s?[...t.results,...n.items]:n.items,hasMore:n.apiCount>y.current&&!!n.items.length,query:e}))),y.current=(s??0)+t,m(!1)}catch(t){if(t instanceof g.IApi.AbortError)return;t instanceof g.IApi.RequestError&&e===v.current&&(_(t),m(!1))}}),[w,t]),R=(0,n.useCallback)((()=>{d.hasMore&&!u&&b(v.current,y.current)}),[b,u,d.hasMore]),M=(0,n.useCallback)((()=>{void 0!==C&&b(v.current,y.current)}),[b,C]);return(0,n.useEffect)((()=>{v.current=c,c!==d.query&&b(c)}),[c]),(0,n.useEffect)((()=>{m(e!==d.query),0===e.length&&I()}),[e]),{...d,isLoading:u,error:C,loadMore:R,retry:M}};function A({query:e}){return E({query:e,searchCount:p.SEARCH_CHANNELS_COUNT,loadResults:c.searchChannels})}},539029:(e,t,s)=>{"use strict";s.d(t,{SnackbarProvider:()=>d,useSnackbar:()=>l});var n=s(667294),r=s(583429),a=s(574044),i=s(974004),o=s(429697),c=s(79676);const d=(0,n.memo)((e=>{const[t,s]=(0,n.useState)(c.snackbarStore.getState());return(0,n.useEffect)((()=>{const e=c.snackbarStore.subscribe(s);return()=>{e(),c.snackbarStore.reset()}}),[]),n.createElement(r.SnackbarContainer,{...e},n.createElement(i.default,{component:"ul",className:"SnackbarContainer__list"},t.map((e=>n.createElement(u,{key:e.id,timeout:400,classNames:"SnackbarContainer__item-"},n.createElement(a.Snackbar,{...e}))))))}));function l(){return(0,n.useMemo)((()=>(0,c.createSnackbar)()),[])}const u=({children:e,...t})=>{const s=(0,n.useRef)(null);return n.createElement(o.default,{...t,nodeRef:s},n.createElement("li",{className:"SnackbarContainer__item",ref:s},e))}},806432:(e,t,s)=>{"use strict";s.d(t,{ContactList:()=>S});s(200930);var n=s(667294),r=s(27932),a=s(24513),i=s(331870),o=s(561743),c=s(265394),d=s(207739),l=s(460167),u=s(339142),h=s(274061),p=s(448503),m=s(819258),g=s(765641),f=s(150962),C=s(813005),_=s(864978),v=s(942514),y=s(60262),k=s(842281),I=s(539029),w=s(86894),b=s(216381),R=s(963196),M=s(906978);const S=({items:e,contacts:t,hasMore:s,onSelect:r,goBack:d})=>{const g=(0,a.useDispatch)(),{lang:f}=(0,a.useBrowserEnv)(),{navigate:b}=(0,k.useRouter)(),S=(0,I.useSnackbar)(),A=(0,a.useFeatureFlags)(),{viewer:U}=(0,a.useViewer)(),T=(0,n.useRef)(null),P=(0,n.useRef)(null),[F,N]=(0,n.useState)(!1),[x,O]=(0,n.useState)("loading"),[q,L]=(0,n.useState)([]),D=(0,n.useMemo)((()=>new Map([...t].filter((([,e])=>0===e.userId)))),[t]),{query:B,onChange:H,onKeyDown:G,onFocus:z,onBlur:V,reset:W}=(0,C.useSearchHandlers)(),K=(0,n.useCallback)((()=>N(!0)),[]),j=(0,n.useCallback)((()=>N(!1)),[]),$=(0,n.useCallback)((({index:e,style:t})=>n.createElement("li",{key:e,style:t,className:"ContactList__itemWrapper"},n.createElement("button",{className:"ContactList__importButton",onClick:K},n.createElement("span",{className:"ContactList__importButtonIcon"},n.createElement(i.Icon20UserAddOutline,null)),f.use("me_contacts_import")))),[f,K]),Q=(0,v.useModal)(),J=(0,n.useCallback)((e=>{Q.close(),b({kind:"ConvoRoute",peerId:e,entrypoint:"contacts_list"})}),[b,Q]),X=(0,n.useCallback)((e=>{let t=f.use("me_phone_invite_contacts_unknown_error");e instanceof R.IApi.RequestError&&(e.code===M.API_ERROR_MESSAGES_SPAM_RESTRICTION||e.code===M.API_ERROR_FLOOD)&&(t=f.use("me_phone_invite_contacts_spamblock_or_floodcontrol_error")),S({before:n.createElement(o.Icon20GlobeCrossOutline,{fill:"var(--vkui--color_text_negative)"}),message:t})}),[S,f]),{modal:Y}=(0,y.usePhoneJoin)({onClose:Q.close,onSuccess:J,onError:X,onMyNumberEntered:()=>{d?.(),Q.close(),b({kind:"ConvoRoute",peerId:U.id,entrypoint:"contacts_list"})}}),Z=(0,n.useCallback)((({index:e,style:t})=>n.createElement("li",{key:e,style:t,className:"ContactList__itemWrapper"},n.createElement(_.InviteButton,{onClick:Q.open,className:"ContactList__phoneJoin"},f.use("me_phone_invite_contacts_action")))),[Q.open,f]),ee=(0,n.useMemo)((()=>{const e=[$];return A.vkm_write_non_friends_by_phone&&e.push(Z),e}),[A.vkm_write_non_friends_by_phone,$,Z]),te=(0,n.useMemo)((()=>l.add(l.create(),[...e.values(),...t.values()],(e=>({id:"Contact"===e.kind&&e.userId?e.userId:e.id,strings:l.peerWords(e)})))),[t,e]);(0,n.useEffect)((()=>{if(s)return void g({type:"LoadContactList",offset:0});const t=[...e.keys(),...D.keys()];L(t),O(0===t.length?"empty":"results")}),[s,g,e,D]),(0,n.useEffect)((()=>{P.current?.focus()}),[]),(0,n.useEffect)((()=>{if("loading"===x)return;if(B){const e=[...l.search(te,B).values()];return L(e),void O(e.length?"results":"empty")}const t=[...e.keys(),...D.keys()];L(t),O(0===t.length?"empty":"results")}),[D,B,e,te,x]);const se=(0,n.useCallback)((e=>ee[e.index]?.(e)||null),[ee]);return n.createElement("div",{className:"ContactList"},"loading"!==x&&t.size>0&&n.createElement(w.Search,{placeholder:f.use("me_convo_list_search_placeholder"),getRef:P,value:B,onChange:H,onKeyDown:G,onFocus:z,onBlur:V,onReset:W}),"empty"!==x&&n.createElement("div",{className:"ContactList__contacts"},"loading"===x?n.createElement(c.OptimizedSpinner,{className:"ContactList__loader"}):n.createElement(u.default,null,(e=>n.createElement(m.ScrollbarProvider,{style:e,overflowX:"hidden"},(({scrollableRef:t,contentRef:s})=>n.createElement(h.FixedSizeList,{ref:T,className:"ContactList__virtual",height:e.height||0,width:e.width||0,overscanCount:10,itemCount:ee.length+q.length,itemSize:56,innerElementType:"ul",outerRef:t,innerRef:s,itemData:{onSelect:r,renderActionButton:se,actionButtons:ee,contacts:D,results:q}},E)))))),"empty"===x&&n.createElement("div",{className:"ContactList__contacts"},ee.length>0&&n.createElement("ul",null,ee.map(((e,t)=>se({index:t,style:{},data:{}})))),n.createElement("div",{className:"ContactList__noResults"},f.use(B?"me_search_empty_contacts":"me_contacts_empty"))),F&&n.createElement(p.ImportContactModal,{onClose:j}),Q.isActive&&Y)},E=n.memo((({index:e,style:t,data:{contacts:s,results:r,onSelect:i,actionButtons:o,renderActionButton:c}})=>{const d=(0,a.usePeers)();if(e<o.length)return c({index:e,style:t,data:{}});const l=r[e-o.length];if(!l)return null;const u=d.get(l)||s.get(l);return!u||"User"!==u.kind&&"Contact"!==u.kind?null:n.createElement(A,{style:t,peer:u,onSelect:i})})),A=({style:e,peer:t,onSelect:s})=>{const i=(0,a.useLastSeen)(t.id);return n.createElement("li",{className:"ContactList__itemWrapper",key:t.id,style:e},n.createElement("div",{className:"ContactList__item",onClick:()=>s(t.id),onKeyDown:(0,b.onElementKeyDownFactory)(((e,n)=>{"Enter"===e&&(n(),s(t.id))})),tabIndex:0,role:"tab"},n.createElement("div",{className:"ContactList__avatar"},n.createElement(r.Avatar,{peer:t,size:40,withBirthday:!0})),n.createElement("div",{className:"ContactList__itemContent"},n.createElement("div",{className:"ContactList__name"},d.name(t)),i?n.createElement(g.OnlineStatus,{user:t,className:"ContactList__info"}):t.phone?n.createElement(f.FormattedPhoneNumber,{phone:t.phone,className:"ContactList__info"}):null)))}},455903:(e,t,s)=>{"use strict";s.d(t,{CopyText:()=>r});s(215334);var n=s(667294);const r=({text:e,stopPropagation:t=!0,onCopyDone:s,children:r,ariaLabel:a})=>{const i=(0,n.useRef)(null),o=(0,n.useCallback)((n=>{function r(){if(i.current){const e=document.activeElement;i.current.focus(),i.current.select(),document.execCommand("copy"),e instanceof HTMLElement&&e.focus(),s&&s()}}n.preventDefault(),t&&n.stopPropagation(),navigator.clipboard.writeText?navigator.clipboard.writeText(e).then((()=>{s&&s()})).catch(r):r()}),[s,e,t]);return n.createElement("div",{className:"CopyText",onClick:o,tabIndex:0,role:"button","aria-label":a},n.createElement("input",{tabIndex:-1,"aria-hidden":!0,type:"text",readOnly:!0,value:e||"",ref:i,className:"CopyText__input"}),r)}},150962:(e,t,s)=>{"use strict";s.d(t,{FormattedPhoneNumber:()=>a});var n=s(667294),r=s(260349);const a=({phone:e,className:t})=>{const[s,a]=(0,n.useState)(e);return(0,n.useEffect)((()=>{(0,r.formatPhoneNumber)(e).then((e=>a(e.international))).catch((()=>a(e)))}),[e]),n.createElement("div",{className:t},s??e)}},448503:(e,t,s)=>{"use strict";s.d(t,{ImportContactModal:()=>o});var n=s(667294),r=s(942514),a=s(785233),i=s(316274);s(928910);const o=({onClose:e})=>{const t=(0,r.useModalGroup)(),s=(0,r.useModal)(t.id),o=(0,r.useModal)(t.id),[c,d]=(0,n.useState)(null),[l,u]=(0,n.useState)({name:"",surname:"",phone:""});return(0,n.useLayoutEffect)((()=>(s.open(),()=>{t.closeGroup()})),[]),n.createElement(n.Fragment,null,s.isActive&&n.createElement(a.InputContactModal,{initialData:l,openInviteModal:o.open,onClose:e,setContactPhone:d,onFromChange:u}),o.isActive&&c&&n.createElement(i.InviteContactModal,{contactPhone:c,onClose:e,onBack:o.close}))}},785233:(e,t,s)=>{"use strict";s.d(t,{InputContactModal:()=>f});var n=s(667294),r=s(86894),a=s(294184),i=s.n(a),o=s(345543),c=s(207739),d=s(24513),l=s(842281),u=s(491021),h=s(667302),p=s(382703),m=(s(522283),s(595773));const g=e=>({status:"default",value:e??""}),f=({initialData:e,onFromChange:t,onClose:s,openInviteModal:a,setContactPhone:i})=>{const{lang:u}=(0,d.useBrowserEnv)(),{navigate:f}=(0,l.useRouter)(),{isLoading:_,importContact:v}=(0,h.useImportContact)(),[y,k]=(0,n.useState)(e?(e=>({phone:g(e.phone),name:g(e.name),surname:g(e.surname)}))(e):{phone:g(),name:g(),surname:g()}),I=(0,d.useDispatch)(),w=(0,n.useMemo)((()=>!(y.phone.value&&y.name.value.trim())),[y.name.value,y.phone.value]),{isReady:b,format:R}=(0,m.useFormatPhoneNumber)(),M=(0,n.useCallback)(((e,t)=>{k((s=>{const n={...s};return n[e]=t,n}))}),[]),S=(0,n.useCallback)((async e=>{const t=e.target.name;var s;if(s=t,["phone","name","surname"].some((e=>s===e))&&b)if("phone"===t){const s=R(e.target.value);M(t,{status:"default",value:s})}else M(t,{status:"default",value:e.target.value.trim()})}),[R,b,M]),E=(0,n.useCallback)((async()=>{const e=y.phone.value,t=y.name.value,n=y.surname.value;if(!(0,o.isValidPhoneNumber)(e))return M("phone",{status:"error",value:e});if(0===t.length)return M("name",{status:"error",value:t});const r=await v({phone:e,name:t,surname:n});r.hasFailed?(i(e),a()):(I({type:"ImportContact",profile:r.profile,contact:r.contact}),f({kind:"ConvoRoute",peerId:r.profile?.id?c.resolveRealId("User",r.profile.id):c.resolveRealId("Contact",r.contact.id),entrypoint:"contacts_list"}),s())}),[I,y.name.value,y.phone.value,y.surname.value,v,f,s,a,i,M]),A=_||!b;return(0,n.useEffect)((()=>{const e={name:y.name.value,surname:y.surname.value,phone:y.phone.value};t?.(e)}),[y,t]),n.createElement(p.ModalInterface,{title:u.use("me_contacts_import_modal_title"),closeLabel:u.use("me_close"),onClose:s,buttons:n.createElement(r.Button,{disabled:w,loading:A,mode:"primary",onClick:E},u.use("me_contacts_import_add_button")),contextClass:"MEConfig",withCustomLayout:!0},n.createElement(C,{formItems:y,onFormItemChange:S,onSubmit:E}))},C=({formItems:e,onFormItemChange:t,onSubmit:s})=>{const{mode:a}=(0,u.useLayoutData)(),o="one-column"===a,{lang:c}=(0,d.useBrowserEnv)(),l=(0,n.useRef)(null);return(0,n.useEffect)((()=>{l.current&&l.current.focus()}),[]),n.createElement(r.FormLayout,{className:i()("ImportContactModal",{"ImportContactModal--fullScreen":o}),onSubmit:e=>{e.preventDefault(),s()}},n.createElement(r.FormItem,{top:n.createElement(n.Fragment,null,c.use("me_contacts_import_modal_phone_input")," ",n.createElement("span",{className:"InputContactModal__requiredSymbol"},"*")),status:e.phone.status},n.createElement(r.Input,{getRef:l,type:"tel",maxLength:250,autoComplete:"tel",name:"phone",value:e.phone.value,onChange:t,placeholder:c.use("me_contacts_import_tel_placeholder"),required:!0})),n.createElement(r.FormLayoutGroup,{mode:"horizontal"},n.createElement(r.FormItem,{top:n.createElement(n.Fragment,null,c.use("me_contacts_import_modal_name_input")," ",n.createElement("span",{className:"InputContactModal__requiredSymbol"},"*")),status:e.name.status},n.createElement(r.Input,{maxLength:250,type:"text",name:"name",autoComplete:"given-name",value:e.name.value,onChange:t,required:!0})),n.createElement(r.FormItem,{top:c.use("me_contacts_import_modal_surname_input")},n.createElement(r.Input,{maxLength:250,type:"text",name:"surname",autoComplete:"family-name",value:e.surname.value,onChange:t}))))}},316274:(e,t,s)=>{"use strict";s.d(t,{InviteContactModal:()=>p});var n=s(667294),r=s(86894),a=s(294184),i=s.n(a),o=s(33200),c=s(24513),d=s(491021),l=s(382703),u=s(455903),h=(s(950652),s(131854));const p=({contactPhone:e,onClose:t,onBack:s})=>{const{lang:a}=(0,c.useBrowserEnv)(),{mode:p}=(0,d.useLayoutData)(),[m,g]=(0,n.useState)(!1),f=(0,n.useRef)(null);(0,n.useEffect)((()=>()=>{f.current&&clearTimeout(f.current)}),[]);const C="one-column"===p;return n.createElement(l.ModalInterface,{title:a.use("me_contacts_invite_modal_title"),closeLabel:a.use("me_close"),onClose:t,contextClass:"MEConfig",backLabel:a.use("me_back"),onBack:s,withCustomLayout:!0},n.createElement("div",{className:i()("InviteContactModal",{"InviteContactModal--fullScreen":C})},n.createElement("div",{className:"InviteContactModal__textWrapper"},n.createElement("p",{className:"InviteContactModal__text"},n.createElement(h.FormattedLangKey,{langkey:"me_contacts_invite_modal_user_not_found",values:{phone:n.createElement("span",{className:"InviteContactModal__phone"},e)}})),n.createElement("p",{className:"InviteContactModal__text"},a.use("me_contacts_invite_modal_app_promo"))),n.createElement(r.Input,{className:"InviteContactModal__linkBox",value:o.VKME_APP_INSTALL_LINK,readOnly:!0,autoFocus:!0,type:"text"}),n.createElement("div",{className:"InviteContactModal__linkCopyWrapper"},n.createElement(u.CopyText,{onCopyDone:()=>{g(!0),f.current&&clearTimeout(f.current),f.current=setTimeout((()=>g(!1)),2e3)},text:o.VKME_APP_INSTALL_LINK},n.createElement(r.Button,{mode:"secondary",size:"m"},a.use("me_contacts_invite_modal_link_copy"))),n.createElement("span",{className:i()("InviteContactModal__linkCopyNotice",{"InviteContactModal__linkCopyNotice--blink":m})},a.use("me_contacts_invite_modal_link_copied")))))}},667302:(e,t,s)=>{"use strict";s.d(t,{useImportContact:()=>a});var n=s(24513),r=s(667294);const a=()=>{const{api:e}=(0,n.useBrowserEnv)(),t=(0,n.useDeviceId)(),[s,a]=(0,r.useState)(!1);return{isLoading:s,importContact:(0,r.useCallback)((async({phone:s,name:n,surname:r,withExisting:i})=>{a(!0);const o=r?n+" "+r:n,c=await e.fetch("account.importMessagesContacts",{contacts:JSON.stringify([{phones:[s],name:o}]),with_existing:Boolean(i),extended:1,device_id:t});return 0===c.items.synced.length&&0===c.items.existing.length||!c.contacts?.[0]?{hasFailed:!0,isMyPhoneNumber:c.items.has_my_phone_number}:(a(!1),{items:c.items,profile:c.profiles?.[0],contact:c.contacts[0],hasFailed:!1})}),[e,t])}}},864978:(e,t,s)=>{"use strict";s.d(t,{InviteButton:()=>i});var n=s(667294),r=s(917303),a=s(659397);s(705875);const i=({children:e,className:t,onClick:s,icon:i=n.createElement(r.Icon24PhoneAddOutline,null)})=>n.createElement("button",{className:(0,a.classNames)("InviteButton",t),type:"button",onClick:s},n.createElement("span",{className:"InviteButton__icon","aria-hidden":!0},i),n.createElement("span",{className:"InviteButton__label"},e))},382703:(e,t,s)=>{"use strict";s.d(t,{ModalInterface:()=>l});s(360862);var n=s(667294),r=s(422177),a=s(851644),i=s(855419),o=s(492858),c=s(387337),d=s(804931);const l=({onClose:e,closeLabel:t,onBack:s,backLabel:l,title:u,contextClass:h,panelClass:p,headerClass:m,hasClearBackdrop:g,isHidden:f,portalTarget:C,buttons:_,withCustomLayout:v,children:y,footerHint:k})=>n.createElement(r.ModalView,{onEscape:e,contextClass:h,portalTarget:C,isHidden:f},n.createElement(a.ModalBackdrop,{onClick:e,isClear:g},n.createElement(i.ModalPanel,{className:p},n.createElement(o.ModalHeader,{className:m,closeLabel:t,onClose:e,backLabel:l,onBack:s,title:u}),n.createElement(c.ModalBody,{withCustomLayout:v},y),_&&n.createElement(d.ModalFooter,{buttons:_,hint:k}))))},765641:(e,t,s)=>{"use strict";s.d(t,{OnlineStatus:()=>i});var n=s(667294),r=s(24513),a=s(11316);const i=n.memo((function({className:e,user:t}){const{lang:s}=(0,r.useBrowserEnv)(),i=(0,r.useLastSeen)(t.id),o=(0,a.useNow)(6e5);if("Contact"===t.kind){if(t.lastSeen&&["today","recently"].includes(t.lastSeen)){const r={today:s.use("global_online_was_today",{sex:"male"}),recently:s.use("global_online_was_recently",{sex:"male"})}[t.lastSeen];return n.createElement("span",{className:e,role:"status"},r)}return null}const c=n.createElement("div",{className:e}," ");if(!i)return c;if(i.isOnline)return n.createElement("span",{className:e,role:"status"},s.use("global_online",{sex:t.sex}));if("number"==typeof i.at)return n.createElement("span",{className:e,role:"status"},s.formatDate(i.at,{now:o,variant:"time-ago"}));let d;switch(i.at){case"recently":d="global_online_was_recently";break;case"last_week":d="global_online_was_week";break;case"last_month":d="global_online_this_month";break;case"long_ago":case"not_show":d="global_online_long_ago";break;default:i.at;return c}return n.createElement("span",{role:"status",className:e},s.use(d,{sex:t.sex}))}))},293256:(e,t,s)=>{"use strict";s.d(t,{OptionsListItem:()=>o,OptionsListItemWrapper:()=>d});s(181362);var n=s(667294),r=s(294184),a=s.n(r),i=s(658508);const o=({icon:e,title:t,description:s,aside:r,isPadded:o=!0,isInteractive:c,hasChevron:l,hasIconBackground:u,onClick:h,className:p})=>n.createElement(d,{onClick:h,isInteractive:c,className:p,isPadded:o},n.createElement("div",{className:a()("OptionsListItem__icon",{"OptionsListItem__icon--withBG":u}),"aria-hidden":!0},e),n.createElement("div",{className:"OptionsListItem__main"},n.createElement("div",{className:"OptionsListItem__title"},t),s&&n.createElement("div",{className:"OptionsListItem__description"},s)),l&&n.createElement("div",{className:"OptionsListItem__aside OptionsListItem__aside--chevron"},n.createElement(i.Icon28ChevronRightOutline,null)),r&&n.createElement("div",{className:"OptionsListItem__aside"},r));function c(e){e.preventDefault()}const d=({children:e,className:t,isInteractive:s,isPadded:r=!0,onClick:i})=>{const o=a()("OptionsListItem",t,{"OptionsListItem--interactive":s??i,"OptionsListItem--padded":r});return n.createElement("li",{className:o,onClick:i,tabIndex:i?0:void 0,onMouseDown:i?c:void 0},e)}},59251:(e,t,s)=>{"use strict";s.d(t,{PhoneInvite:()=>o});var n=s(667294),r=s(935562),a=s(86894),i=(s(994718),s(595773));const o=({onSubmit:e,onErrorReset:t,isLoading:s=!1,title:o,subtitle:c,action:d,error:l,focusOnMount:u})=>{const[h,p]=(0,n.useState)(""),{isReady:m,format:g}=(0,i.useFormatPhoneNumber)(),f=(0,n.useRef)(null),C=(0,n.useCallback)((e=>{t?.();const s=g(e.target.value);p(s)}),[g,t]);return(0,n.useEffect)((()=>{u&&f.current&&f.current.focus()}),[]),n.createElement(a.FormLayout,{className:"PhoneInvite",onSubmit:t=>{t.preventDefault(),s||e(h)}},n.createElement(r.Icon56PhoneOutline,{className:"PhoneInvite__icon",color:"var(--vkui--color_icon_accent)"}),n.createElement("h3",{className:"PhoneInvite__title"},o),n.createElement("div",{className:"PhoneInvite__subtitle"},c),n.createElement(a.FormItem,{status:l?"error":"default",bottom:l,className:"PhoneInvite__row"},n.createElement(a.Input,{className:"PhoneInvite__input",type:"tel",name:"phone",autoComplete:"tel",value:h,onChange:C,placeholder:"+7 (000) 000-00-00",getRef:f})),n.createElement("div",{className:"PhoneInvite__action"},n.createElement(a.Button,{type:"submit",size:"l",stretched:!0,mode:"primary",loading:s||!m,disabled:!h},d)))}},88074:(e,t,s)=>{"use strict";s.d(t,{PhoneInviteModal:()=>u});var n=s(667294),r=s(422177),a=s(851644),i=s(855419),o=s(387337),c=s(59251),d=(s(324402),s(24513)),l=s(579431);const u=({onClose:e,...t})=>{const{lang:s}=(0,d.useBrowserEnv)();return n.createElement(r.ModalView,{contextClass:"MEConfig",onEscape:e},n.createElement(a.ModalBackdrop,{onClick:e},n.createElement(i.ModalPanel,{className:"PhoneInviteModal__panel"},n.createElement(o.ModalBody,{withCustomLayout:!0},n.createElement("div",{className:"PhoneInviteModal"},n.createElement("button",{className:"PhoneInviteModal__close",type:"button","aria-label":s.use("me_close"),onClick:e},n.createElement("span",{className:"PhoneInviteModal__closeInner"},n.createElement(l.Icon20Cancel,null))),n.createElement(c.PhoneInvite,{...t}))))))}},574044:(e,t,s)=>{"use strict";s.d(t,{Snackbar:()=>d});s(168577);var n=s(667294),r=s(294184),a=s.n(r),i=s(418592),o=s(86894),c=s(513698);const d=(0,n.memo)((({message:e,layout:t="horizontal",action:s,before:r,after:d,duration:l=4e3,onActionClick:u,onClose:h,mode:p="default",className:m,stopOnHover:g=!0,isManuallyClosable:f=!1,autoClose:C=!0,requestClose:_=!1,onRequestRemove:v})=>{const{isTouchOnly:y}=(0,i.useDeviceData)(),[k,I]=(0,n.useState)(l);(0,n.useEffect)((()=>{I(l)}),[l]);const w=(0,n.useRef)((()=>{}));w.current=()=>{v(),h?.()};(0,n.useEffect)((()=>{if(null==k||!C)return;let e=null;return e=window.setTimeout((()=>{w.current()}),k),()=>{e&&window.clearTimeout(e)}}),[C,k]),(0,n.useEffect)((()=>{_&&w.current()}),[_]);const b=d||!y?"vertical":t;return n.createElement("div",{className:a()("Snackbar",`Snackbar--layout-${b}`,`Snackbar--mode-${p}`,m),onMouseEnter:()=>{g&&I(null)},onMouseLeave:()=>{g&&I(l)}},n.createElement("div",{className:"Snackbar__body"},r&&n.createElement("div",{className:"Snackbar__before"},r),n.createElement("div",{className:"Snackbar__content"},n.createElement(o.Paragraph,{className:"Snackbar__content-text"},e),s&&n.createElement(o.Button,{align:"left",hasHover:!1,mode:"tertiary",appearance:"dark"===p?"overlay":"accent",size:"s",className:"Snackbar__action",onClick:e=>{s&&u?.(e),w.current()}},s)),d&&n.createElement("div",{className:"Snackbar__after"},d)),f&&n.createElement(o.Button,{onClick:w.current,after:n.createElement(c.Icon12Cancel,null),mode:"tertiary",appearance:"dark"===p?"overlay":"neutral",size:"s",className:"Snackbar__close"}))}))},583429:(e,t,s)=>{"use strict";s.d(t,{SnackbarContainer:()=>a});var n=s(667294),r=s(56690);s(980160);const a=({withPortal:e=!0,portalProps:t={portalClassName:"MEConfig SnackbarModal"},children:s})=>n.createElement(i,{withPortal:e,portalProps:t},n.createElement("div",{className:"SnackbarContainer"},s)),i=(0,n.memo)((({withPortal:e,children:t,portalProps:s})=>e?n.createElement(r.Portal,{...s},t):n.createElement(n.Fragment,null,t)))},683851:(e,t,s)=>{"use strict";s.d(t,{Symbols:()=>r});s(516073);var n=s(667294);const r=()=>n.createElement("svg",{className:"Symbols"},n.createElement("defs",null,n.createElement("symbol",{id:"mePhone10"},n.createElement("path",{d:"M6.17 6.8c1.1-1.09 2.32-.5 3.3.33 1.15.97.26 2.7-1.08 2.83-1.82.24-3.72-.63-5.72-2.63-2-2-2.88-3.91-2.63-5.73C.16.27 1.91-.62 2.87.52c.82.98 1.41 2.2.32 3.3-.9.9-.16 1.55.64 2.35s1.45 1.53 2.34.64z"})),n.createElement("symbol",{id:"meExpand"},n.createElement("path",{d:"M15.7688 13.7067L11.906 10L15.7688 6.29326C16.0771 5.99741 16.0771 5.51774 15.7688 5.22189C15.4605 4.92604 14.9606 4.92604 14.6523 5.22189L10.2312 9.46431C9.92292 9.76017 9.92292 10.2398 10.2312 10.5357L14.6523 14.7781C14.9606 15.074 15.4605 15.074 15.7688 14.7781C16.0771 14.4823 16.0771 14.0026 15.7688 13.7067Z"}),n.createElement("path",{d:"M9.76877 13.7067L5.90596 10L9.76877 6.29326C10.0771 5.99741 10.0771 5.51774 9.76877 5.22189C9.46046 4.92604 8.96059 4.92604 8.65228 5.22189L4.23123 9.46431C3.92292 9.76017 3.92292 10.2398 4.23123 10.5357L8.65228 14.7781C8.96059 15.074 9.46046 15.074 9.76877 14.7781C10.0771 14.4823 10.0771 14.0026 9.76877 13.7067Z"})),n.createElement("symbol",{id:"meCake10"},n.createElement("path",{d:"M9.16667 8.07392C8.33947 8.29895 7.41292 8.1867 6.66667 7.73385C5.66596 8.34111 4.33404 8.34111 3.33333 7.73385C2.58708 8.1867 1.66053 8.29895 0.833333 8.07392V9.09126C0.833333 9.59314 1.20643 10 1.66667 10H8.33333C8.79357 10 9.16667 9.59314 9.16667 9.09126V8.07392Z"}),n.createElement("path",{d:"M0 5.00191C0 4.50003 0.373096 4.09317 0.833333 4.09317H9.16667C9.6269 4.09317 10 4.50003 10 5.00191C10 6.36503 9.16667 6.8194 8.33333 6.8194C7.08333 6.8194 6.66667 5.91065 6.66667 5.91065C6.66667 5.91065 6.25 6.8194 5 6.8194C3.75 6.8194 3.33333 5.91065 3.33333 5.91065C3.33333 5.91065 2.91667 6.8194 1.66667 6.8194C0.833333 6.8194 0 6.36503 0 5.00191Z"}),n.createElement("path",{d:"M7.83935 0.0492567C7.87234 -0.0164189 7.96099 -0.0164189 7.99398 0.0492567C8.38334 0.824332 8.75 1.16164 8.75 1.82131C8.75 2.32319 8.3769 2.73005 7.91667 2.73005C7.45643 2.73005 7.08333 2.32319 7.08333 1.82131C7.08333 1.16164 7.44999 0.824332 7.83935 0.0492567Z"}),n.createElement("path",{d:"M2.00602 0.0492567C2.03901 -0.0164189 2.12766 -0.0164189 2.16065 0.0492567C2.55001 0.824332 2.91667 1.16164 2.91667 1.82131C2.91667 2.32319 2.54357 2.73005 2.08333 2.73005C1.6231 2.73005 1.25 2.32319 1.25 1.82131C1.25 1.16164 1.61665 0.824332 2.00602 0.0492567Z"}),n.createElement("path",{d:"M4.92268 0.0492567C4.95568 -0.0164189 5.04432 -0.0164189 5.07732 0.0492567C5.46668 0.824332 5.83333 1.16164 5.83333 1.82131C5.83333 2.32319 5.46024 2.73005 5 2.73005C4.53976 2.73005 4.16667 2.32319 4.16667 1.82131C4.16667 1.16164 4.53332 0.824332 4.92268 0.0492567Z"}))),n.createElement("circle",{id:"mePeerFrameOffline20",cx:"10",cy:"10",r:"10"}),n.createElement("path",{id:"mePeerFrameMe24",d:"M20 10a12 12 0 10-9.9 9.9 7 7 0 019.9-9.9z"}),n.createElement("circle",{id:"mePeerFrameOffline24",cx:"12",cy:"12",r:"12"}),n.createElement("path",{id:"mePeerFrameOnline24",d:"M23.57 15.18A12.02 12.02 0 0012 0a12 12 0 103.18 23.57 6 6 0 018.4-8.4z"}),n.createElement("path",{id:"mePeerFrameMobile24",d:"M14.08 23.82a12 12 0 119.9-12.29 3.98 3.98 0 00-1.98-.53h-4a4 4 0 00-4 4v8c0 .28.03.56.08.82z"}),n.createElement("path",{id:"mePeerFrameMe24",d:"M23.84 13.95a12 12 0 10-9.9 9.9 7 7 0 019.9-9.9z"}),n.createElement("circle",{id:"mePeerFrameOffline32",cx:"16",cy:"16",r:"16"}),n.createElement("path",{id:"mePeerFrameOnline32",d:"M30.72 22.29a16 16 0 10-8.43 8.43 6 6 0 018.43-8.43z"}),n.createElement("path",{id:"mePeerFrameMobile32",d:"M21 31.2a16 16 0 1110.52-11.3A3.98 3.98 0 0029 19h-4a4 4 0 00-4 4v8.2z"}),n.createElement("path",{id:"mePeerFrameMe32",d:"M31.1 21.32a16 16 0 10-9.77 9.77 7 7 0 019.77-9.77z"}),n.createElement("path",{id:"mePeerFrameMe32c",d:"M18.1533 0.143651C17.449 0.0489165 16.7302 0 16 0C7.16344 0 0 7.16344 0 16C0 24.8366 7.16344 32 16 32C17.8656 32 19.6565 31.6807 21.3213 31.0938C20.4899 29.9426 20 28.5285 20 27C20 24.8923 20.9316 23.0021 22.4054 21.7188C17.0253 20.533 13 15.7366 13 10C13 5.91761 15.0386 2.31134 18.1533 0.143651ZM30.2451 20.796C30.5411 20.9512 30.8247 21.1269 31.0938 21.3213C31.2337 20.9244 31.3584 20.5204 31.4672 20.1099C31.0749 20.3614 30.6669 20.5907 30.2451 20.796Z"}),n.createElement("path",{id:"mePeerFrameMobile32c",d:"M18.1533 0.143651C17.449 0.0489165 16.7302 0 16 0C7.16344 0 0 7.16344 0 16C0 24.8366 7.16344 32 16 32C17.748 32 19.4305 31.7197 21.005 31.2016C21.0017 31.1348 21 31.0676 21 31V23C21 22.4411 21.1146 21.9089 21.3217 21.4257C16.4937 19.8727 13 15.3443 13 10C13 5.91761 15.0386 2.31134 18.1533 0.143651Z"}),n.createElement("path",{id:"mePeerFrameOffline32c",d:"M31.47 20.11A12 12 0 0118.16.14a16 16 0 1013.31 19.97z"}),n.createElement("path",{id:"mePeerFrameOnline32c",d:"M18.1533 0.143651C17.449 0.0489165 16.7302 0 16 0C7.16344 0 0 7.16344 0 16C0 24.8366 7.16344 32 16 32C18.2328 32 20.3588 31.5426 22.2893 30.7165C21.4819 29.6945 21 28.4035 21 27C21 24.8726 22.1072 23.0038 23.7767 21.9384C17.7239 21.3256 13 16.2145 13 10C13 5.91761 15.0386 2.31134 18.1533 0.143651ZM28.9655 21.3293C29.6052 21.551 30.1958 21.8779 30.7165 22.2893C31.0169 21.5873 31.2686 20.8594 31.4672 20.1099C30.6899 20.6082 29.8514 21.0192 28.9655 21.3293Z"}),n.createElement("circle",{id:"mePeerFrameOffline36",cx:"18",cy:"18",r:"18"}),n.createElement("circle",{id:"mePeerFrameOffline40",cx:"20",cy:"20",r:"20"}),n.createElement("path",{id:"mePeerFrameOnline40",d:"M29.29 37.72a20 20 0 118.43-8.43 5.99 5.99 0 10-8.43 8.43z"}),n.createElement("path",{id:"mePeerFrameMobile40",d:"M28.2 38.25a20 20 0 1110.78-11.92A3.99 3.99 0 0036 25h-4a4 4 0 00-4 4v8a4 4 0 00.2 1.25z"}),n.createElement("path",{id:"mePeerFrameMe40",d:"M28.31 38.2a20 20 0 119.89-9.89 7 7 0 10-9.89 9.89z"}),n.createElement("path",{id:"mePeerFrameMe40c",d:"M33 22c2.61 0 5.03-.83 7-2.25V20c0 2.97-.65 5.78-1.8 8.31a7 7 0 10-9.89 9.89A20 20 0 1125.38.73 12 12 0 0033 22z"}),n.createElement("path",{id:"mePeerFrameMobile40c",d:"M33 22c2.61 0 5.03-.83 7-2.25V20c0 2.21-.36 4.34-1.02 6.33A3.99 3.99 0 0036 25h-4a4 4 0 00-4 4v8a4 4 0 00.2 1.25A20 20 0 1125.38.73 12 12 0 0033 22z"}),n.createElement("path",{id:"mePeerFrameOffline40c",d:"M40 19.75A12 12 0 0125.38.73 20.02 20.02 0 000 20a20 20 0 1040-.25z"}),n.createElement("path",{id:"mePeerFrameOnline40c",d:"M33 22c2.61 0 5.03-.83 7-2.25V20c0 3.35-.83 6.51-2.28 9.29a5.99 5.99 0 10-8.43 8.43A20 20 0 1125.38.74 12 12 0 0033 22z"}),n.createElement("circle",{id:"mePeerFrameOffline44",cx:"22",cy:"22",r:"22"}),n.createElement("path",{id:"mePeerFrameOnline44",d:"M41.21 32.73a22 22 0 10-8.49 8.49 6 6 0 018.49-8.49z"}),n.createElement("path",{id:"mePeerFrameMobile44",d:"M31.13 42.02a22 22 0 1111.1-11.37A4 4 0 0039 29h-4a4 4 0 00-4 4v8c0 .35.05.7.13 1.02z"}),n.createElement("path",{id:"mePeerFrameMe44",d:"M41.7 31.81a22 22 0 10-9.89 9.89 7 7 0 019.89-9.89z"}),n.createElement("path",{id:"mePeerFrameOffline44c",d:"M43.97 20.77A12 12 0 0129.78 1.41a22 22 0 1014.19 19.36z"}),n.createElement("path",{id:"mePeerFrameOnline44c",d:"M29.78 1.41a22 22 0 102.95 39.8 6 6 0 018.49-8.49 21.9 21.9 0 002.75-11.95A12 12 0 0129.78 1.41z"}),n.createElement("path",{id:"mePeerFrameMobile44c",d:"M43.97 20.77A12 12 0 0129.78 1.41a22 22 0 101.35 40.6 4 4 0 01-.13-1.01v-8a4 4 0 014-4h4a4 4 0 013.24 1.65 21.93 21.93 0 001.73-9.88z"}),n.createElement("path",{id:"mePeerFrameMe44c",d:"M29.78 1.41A22 22 0 1031.8 41.7a7 7 0 019.89-9.89 21.91 21.91 0 002.27-11.03A12 12 0 0129.78 1.41z"}),n.createElement("circle",{id:"mePeerFrameOffline46",cx:"23",cy:"23",r:"23"}),n.createElement("path",{id:"mePeerFrameOnline46",d:"M42.94 34.47a23 23 0 10-8.47 8.47 6 6 0 018.47-8.47z"}),n.createElement("path",{id:"mePeerFrameMobile46",d:"M33.06 43.69A23 23 0 1144 32.37 3.99 3.99 0 0041 31h-4a4 4 0 00-4 4v8c0 .24.02.47.06.69z"}),n.createElement("path",{id:"mePeerFrameMe46",d:"M43.43 33.58a23 23 0 10-9.85 9.85 7 7 0 019.85-9.85z"}),n.createElement("path",{id:"mePeerFrameOffline46c",d:"M45.9 20.82A12 12 0 0131.5 1.62a23 23 0 1014.39 19.2z"}),n.createElement("path",{id:"mePeerFrameOnline46c",d:"M31.5 1.63a23 23 0 102.96 41.31 6 6 0 018.47-8.47 22.9 22.9 0 002.97-13.65A12 12 0 0131.5 1.62z"}),n.createElement("path",{id:"mePeerFrameMobile46c",d:"M45.9 20.82A12 12 0 0131.5 1.62a23 23 0 101.55 42.06A4.03 4.03 0 0133 43v-8a4 4 0 014-4h4c1.2 0 2.28.53 3.01 1.37a22.92 22.92 0 001.89-11.55z"}),n.createElement("path",{id:"mePeerFrameMe46c",d:"M31.5 1.63a23 23 0 102.07 41.8 7 7 0 019.85-9.85 22.9 22.9 0 002.48-12.76A12 12 0 0131.5 1.62z"}),n.createElement("circle",{id:"mePeerFrameOffline48",cx:"24",cy:"24",r:"24"}),n.createElement("path",{id:"mePeerFrameOnline48",d:"M44.65 36.2375C46.7781 32.6543 48 28.4699 48 24 48 10.7452 37.2548 0 24 0S0 10.7452 0 24s10.7452 24 24 24c4.4699 0 8.6543-1.2219 12.2375-3.35C35.4614 43.6388 35 42.3733 35 41c0-3.3137 2.6863-6 6-6 1.3733 0 2.6388.4614 3.65 1.2375Z"}),n.createElement("path",{id:"mePeerFrameMobile48",d:"M35.0134 45.3295C31.7149 47.0361 27.97 48 24 48 10.7452 48 0 37.2548 0 24S10.7452 0 24 0s24 10.7452 24 24c0 3.6139-.7987 7.0412-2.2293 10.115C45.0518 33.4245 44.0755 33 43 33h-4c-2.2091 0-4 1.7909-4 4v8c0 .1109.0045.2208.0134.3295Z"}),n.createElement("path",{id:"mePeerFrameMe48",d:"M45.1466 35.3598C46.967 31.9781 48 28.1097 48 24 48 10.7452 37.2548 0 24 0S0 10.7452 0 24s10.7452 24 24 24c4.1097 0 7.9781-1.033 11.3598-2.8534C34.5051 43.986 34 42.552 34 41c0-3.866 3.134-7 7-7 1.552 0 2.986.5051 4.1466 1.3598Z"}),n.createElement("path",{id:"mePeerFrameOffline48c",d:"M47.7535 20.5474c-1.9142 1.485-4.2861 2.3638-6.8546 2.3638-6.3513 0-11.5-5.3726-11.5-12 0-3.60133 1.5202-6.83209 3.9277-9.03164C30.4593.669186 27.3078 0 24 0 10.7452 0 0 10.7452 0 24s10.7452 24 24 24 24-10.7452 24-24c0-1.1724-.0841-2.3252-.2465-3.4526Z"}),n.createElement("path",{id:"mePeerFrameOnline48c",d:"M33.4417 1.92854C30.5438.687251 27.3522 0 24 0 10.7452 0 0 10.7452 0 24s10.7452 24 24 24c4.4699 0 8.6543-1.2219 12.2375-3.35C35.4614 43.6388 35 42.3733 35 41c0-3.3137 2.6863-6 6-6 1.3733 0 2.6388.4614 3.65 1.2375C46.7781 32.6543 48 28.4699 48 24c0-.9987-.061-1.9832-.1795-2.9499-1.8568 1.1786-4.0595 1.8611-6.4216 1.8611-6.6274 0-12-5.3726-12-12 0-3.57469 1.563-6.78427 4.0428-8.98266Z"}),n.createElement("path",{id:"mePeerFrameMobile48c",d:"M47.8002 20.8886C45.8673 22.2203 43.5247 23 41 23c-6.6274 0-12-5.3726-12-12 0-3.66964 1.6472-6.95456 4.2425-9.15573C30.3978.656185 27.2755 0 24 0 10.7452 0 0 10.7452 0 24s10.7452 24 24 24c3.97 0 7.7149-.9639 11.0134-2.6705C35.0045 45.2208 35 45.1109 35 45v-8c0-2.2091 1.7909-4 4-4h4c1.0755 0 2.0518.4245 2.7707 1.115C47.2013 31.0412 48 27.6139 48 24c0-1.0544-.068-2.0929-.1998-3.1114Z"}),n.createElement("path",{id:"mePeerFrameMe48c",d:"M33.4417 1.92854C30.5438.687251 27.3522 0 24 0 10.7452 0 0 10.7452 0 24s10.7452 24 24 24c4.1097 0 7.9781-1.033 11.3598-2.8534C34.5051 43.986 34 42.552 34 41c0-3.866 3.134-7 7-7 1.552 0 2.986.5051 4.1466 1.3598C46.967 31.9781 48 28.1097 48 24c0-.9987-.061-1.9832-.1795-2.9499-1.8568 1.1786-4.0595 1.8611-6.4216 1.8611-6.6274 0-12-5.3726-12-12 0-3.57469 1.563-6.78427 4.0428-8.98266Z"}),n.createElement("circle",{id:"mePeerFrameOffline72",cx:"37",cy:"37",r:"37"}),n.createElement("circle",{id:"mePeerFrameOffline92",cx:"46",cy:"46",r:"46"}),n.createElement("circle",{id:"mePeerFrameOffline96",cx:"48",cy:"48",r:"48"}),n.createElement("path",{id:"meUsersStack16",d:"M14 2.715A8 8 180 008 0 8 8 180 008 16 8 8 180 0014 13.285 8 8 180 0114 2.715"}),n.createElement("path",{id:"meUsersStack18",d:"M 16 14 A 9 9 90 0 1 9 18 A 9 9 90 0 1 9 0 A 9 9 90 0 1 16 4 A 9 9 90 0 0 16 14"}),n.createElement("path",{id:"meUsersStack24",d:"M22 18.6A12 12 0 0112 24 12 12 0 0112 0 12 12 0 0122 5.4 12 12 0 0022 18.6"}),n.createElement("path",{id:"meUsersStack32",d:"M30 23.8A16 16 0 0116 32 16 16 0 0116 0 16 16 0 0130 8.3 16 16 0 0030 23.8"}),n.createElement("path",{id:"meUsersStack40",d:"M37.5 29.8A20 20 90 0120 40 20 20 90 0120 0 20 20 90 0137.5 10.4 20 20 90 0037.5 29.8"}),n.createElement("path",{id:"meUsersStack44",d:"M41.3 32.7A22 22 90 0122 44 22 22 90 0122 0 22 22 90 0141.3 11.4 22 22 90 0041.3 32.7"}),n.createElement("path",{id:"meUsersStack46",d:"M43.1 34.2A23 23 90 0123 46 23 23 90 0123 0 23 23 90 0143.1 11.9 23 23 90 0043.1 34.2"}),n.createElement("path",{id:"meUsersStack48",d:"M44.9739 35.687c-2.0822 3.7346-5.1243 6.8452-8.8117 9.01C32.4747 46.8618 28.2759 48.0021 24 48c-6.3652 0-12.4697-2.5286-16.97056-7.0294C2.52856 36.4697 0 30.3652 0 24c0-6.3652 2.52856-12.4697 7.02944-16.97056C11.5303 2.52856 17.6348 0 24 0c4.2863.00824717 8.4922 1.16428 12.1806 3.34795 3.6884 2.18368 6.7247 5.31531 8.7933 9.06945-1.9734 3.5603-3.0088 7.5641-3.0088 11.6348 0 4.0706 1.0354 8.0744 3.0088 11.6348Z"}))},216381:(e,t,s)=>{"use strict";s.d(t,{onElementKeyDownFactory:()=>r});var n=s(720186);const r=(e,t=!1)=>s=>{const r=(0,n.getKeyCombo)(s);!t&&(0,n.isGlobalKeyCombo)(r)||(0,n.isModuleKeyCombo)(r)&&(s.stopPropagation(),e(r,s.preventDefault.bind(s)))}},429590:(e,t,s)=>{"use strict";s.d(t,{fromApiComment:()=>l});var n=s(382543),r=s(207739),a=s(377836),i=s(548007),o=s(769126),c=s(243860),d=s(361084);function l(e){const t={cmid:n.resolveCmid(e.id),postCmid:a.resolveCmid(e.post_id||0),channelId:i.resolveId(e.owner_id||0),canEdit:Boolean(e.can_edit),rootCmid:e.parents_stack?.[0]?n.resolveCmid(e.parents_stack[0]):void 0,replies:{count:e?.thread?.count||0,history:(e.thread?.items||[]).map(l),nextFrom:e.thread?.next_from,prevFrom:e.thread&&e.thread.prev_from},sentAt:1e3*e.date};return e.deleted?{kind:"Deleted",...t}:{kind:"Normal",...t,chunks:e.text?c.fromServerText(e.text):[],attaches:(0,d.fromApiWallReplyAttach)(e.attachments||[]),likes:{count:e.likes?.count||0,reactionId:Boolean(e.likes?.user_likes)?o.resolveId(0):void 0,availableReactionIds:[],peerIds:new Set},peerId:r.resolveId(e.from_id)}}},154551:(e,t,s)=>{"use strict";function n(e){return{name:e.name,icon:e.icon,text:e.text,canHide:Boolean(e.can_hide),...e.title&&{title:e.title},...e.icon&&{icon:e.icon},buttons:(e.buttons||[]).map((e=>({layout:e.layout,text:e.text,type:e.type,link:e.link,hideOnAction:Boolean(e.hide_on_action)})))}}s.d(t,{fromApiConversationsBar:()=>n})},736578:(e,t,s)=>{"use strict";s.d(t,{fromApiViewerPushSettings:()=>r});var n=s(952644);function r(e){let t=n.VIEWER_DEFAULT_PUSH_SETTINGS;const s=Array.isArray(e.items)?e.items?.find((e=>"messages"===e.id))?.items:e.items&&[e.items];if(void 0===s)return t;const r=e=>e&&"settings"in e?e.settings.find((e=>e.is_enabled))?.id:void 0,a=(e,t)=>{const n=s.find((e=>e.id===t));n&&"push_value"in n&&(e={...e,isEnabled:"on"===n.push_value});const a={text:!0,no_text:!1},i=r(n);i&&(e={...e,withMessageText:a[i]??e.withMessageText})};a(t.userConvo,"private_messages"),a(t.chatConvo,"group_chats"),a(t.groupConvo,"groups_messages_pushes"),a(t.messageReaction,"group_message_reaction");const i=s.find((e=>"mail"===e.id)),o={all:"every-mention",important:"direct-mention",none:"nothing"},c=r(i);return c&&(t={...t,mention:o[c]??t.mention}),t}},791183:(e,t,s)=>{"use strict";function n(e){return{type:e.type,filter:e.filter,name:e.name,description:e.description,peerIds:new Set}}s.d(t,{fromApiSublist:()=>n})},724738:(e,t,s)=>{"use strict";s.d(t,{fromApiAppearance:()=>i,fromApiBackground:()=>c,fromApiStyle:()=>a});var n=s(883262),r=s(345543);const a=(e,t)=>({id:n.resolveStyleId(e.id),appearanceId:n.resolveAppearanceId(e.appearance_id||e.id),backgroundId:n.resolveBackgroundId(e.background_id||e.id),title:t,sortId:e.sort,updateTime:e.update_time,isHidden:Boolean(e.is_hidden)}),i=e=>({id:n.resolveAppearanceId(e.id),sortId:e.sort,updateTime:e.update_time,light:o(e.light),dark:o(e.dark)}),o=e=>({bubbleGradient:e.bubble_gradient,accentColor:e.accent_color,headerTint:e.header_tint,writeBarTint:e.write_bar_tint,forwardLine:e.forward_line,textPlaceholder:e.text_placeholder,textPrimary:e.text_primary}),c=e=>({id:n.resolveBackgroundId(e.id),sortId:e.sort,updateTime:e.update_time,light:d(e.light),dark:d(e.dark)}),d=e=>{switch(e.type){case"raster":return{kind:"raster",url:e.raster.url,height:e.raster.height,width:e.raster.width};case"vector":return{kind:"vector",blur:e.vector.blur,colorEllipses:e.vector.color_ellipses?.map((e=>({color:l(e.color),radiusX:e.radius_x,radiusY:e.radius_y,x:e.x,y:e.y}))),gradient:e.vector.gradient&&{angle:e.vector.gradient.angle,colors:e.vector.gradient.colors.map(l)},svg:e.vector.svg&&{height:e.vector.svg.height,opacity:e.vector.svg.opacity,url:e.vector.svg.url,width:e.vector.svg.width,isOverlay:e.vector.svg.is_overlay}};default:(0,r.exhaustivenessCheck)(e)}},l=e=>7===e.length?e:`#${e.slice(3)}${e.slice(1,3)}`},994541:(e,t,s)=>{"use strict";s.d(t,{fromApiProfileType:()=>i,fromApiViewerAccount:()=>r,fromApiViewerProfileInfo:()=>a});var n=s(207739);function r(e){return{id:n.resolveRealId("User",e.id),profileType:i(e.profile_type),firstName:e.first_name??"",lastName:e.last_name??"",photo:e.photo_100,isService:e.is_service_account||e.is_service}}function a(e){const{screen_name:t,phone:s,id:r,photo_200:a,first_name:i,last_name:o,nick_name:c,is_service_account:d}=e;return{screenName:t,phoneNumber:s,id:n.resolveRealId("User",r),avatarPhoto:a,firstName:i,lastName:o,nickName:c,isServiceAccount:d}}function i(e){return{0:"normal",2:"edu"}[e??0]??"normal"}},736097:(e,t,s)=>{"use strict";s.d(t,{Engine:()=>a});var n=s(345543),r=s(33200);class a{constructor(e,t){this.isWorking=!1,this.empty=()=>({kind:"Buffer",buffer:[]}),this.queued=this.empty(),this.connect=e=>{if(this.isWorking)return;this.isWorking=!0,this.queued=this.empty();(async()=>{for(;this.isWorking;){if("Buffer"===this.queued.kind){if(this.queued.buffer.reduce(((e,t)=>"Batch"===t.kind?e+t.updates.length:e+1),0)>=100)return this.isWorking=!1,void this.dispatch({kind:"Failure"})}try{const t=`https://${e.server}?version=${this.version}&mode=682`,s=new AbortController,n=setTimeout((()=>s.abort()),3e4),r=await this.request(t,{act:"a_check",key:e.key,ts:e.ts,wait:25},s.signal).finally((()=>clearTimeout(n)));if("failed"in r)throw r;e.ts=r.ts,e.pts=r.pts,this.dispatch({kind:"Batch",...r})}catch(e){this.logger.info("[ENGINE] Error",e),this.isWorking=!1,this.dispatch({kind:"Failure"})}}})().catch((e=>{this.isWorking=!1,this.logger.error("[ENGINE] Drain error",e)})),this.logger.info("[ENGINE] Connected")},this.dispatch=e=>{if("Callback"===this.queued.kind)return this.queued.resolve(e),void(this.queued=this.empty());switch(e.kind){case"Failure":return void this.queued.buffer.push(e);case"Batch":{const t=this.queued.buffer[this.queued.buffer.length-1];return void(t&&"Failure"!==t.kind&&t.pts===e.pts?(t.ts=e.ts,t.pts=e.pts,t.updates.push(...e.updates)):this.queued.buffer.push(e))}default:(0,n.exhaustivenessCheck)(e)}},this.poll=()=>{if("Callback"===this.queued.kind)return this.queued.reject("Engine.poll вызван повторно до обработки первого вызова!"),new Promise(((e,t)=>{this.queued={kind:"Callback",resolve:e,reject:t}}));const e=this.queued.buffer.shift();return e?Promise.resolve(e):this.isWorking?new Promise(((e,t)=>{this.queued={kind:"Callback",resolve:e,reject:t}})):Promise.reject("Engine.connect еще не был вызван!")},this.isConnected=()=>this.isWorking,this.logger=e,this.request=t,this.version=r.ENGINE_VERSION}}},324389:(e,t,s)=>{"use strict";s.d(t,{EventEmitter:()=>n});class n{subscribe(e,t){Array.isArray(this.subscriptions[e])?this.subscriptions[e]?.push(t):this.subscriptions[e]=[t]}unsubscribe(e,t){Array.isArray(this.subscriptions[e])&&(this.subscriptions[e]=this.subscriptions[e]?.filter((e=>e!==t))||[])}emit(e,t){Array.isArray(this.subscriptions[e])&&this.subscriptions[e]?.forEach((e=>e(t)))}constructor(){this.subscriptions={}}}},189179:(e,t,s)=>{"use strict";s.d(t,{DEFAULT_CONVOS_FAILED_MESSAGES_STORE:()=>r,getConvosFailedMessagesFromStorage:()=>i,saveConvosFailedMessagesInStorage:()=>a});const n="convos-failed-messages",r={version:1},a=(e,t)=>{const{pending:s}=e.history,a=s.filter((e=>e.item.hasFailed)).map((e=>e.item));t.updateIDB(n,((t=r)=>(a.length?t[e.peerId]=a:delete t[e.peerId],t))).catch((()=>{}))},i=async e=>{const t=await e.getIDB(n)||r;return 1!==t.version?(e.updateIDB(n,(()=>r)).catch((()=>{})),r):t}},105465:(e,t,s)=>{"use strict";var n,r;s.d(t,{PlayerEventTypes:()=>n,VideoMessagePlayerEventTypes:()=>r}),function(e){e.STATE_UPDATED="stateupdated",e.START_NEW_TRACK="startNewTrack",e.START_NEXT_TRACK="startNextTrack",e.START_PREV_TRACK="startPrevTrack",e.RESUME_TRACK="resumeTrack",e.START_NEXT_TRACK_AUTOMATICALLY="startNextTrackAutomatically",e.STOP_CURRENT_TRACK_AUTOMATICALLY="stopCurrentTrackAutomatically",e.PLAYLIST_ENDED="playlistEnded",e.STOP_CURRENT_TRACK_BEFORE_STARTING_NEW_TRACK="stopCurrentTrackBeforeStartingNewTrack",e.STOP_CURRENT_TRACK_BY_ERROR="stopCurrentTrackByError",e.PAUSE_CURRENT_TRACK="pauseCurrentTrack"}(n||(n={})),function(e){e.SCROLL_TO_MESSAGE="scrollToMessage",e.STATE_UPDATED="stateUpdated"}(r||(r={}))},640341:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(795947),r=s(207739);const a=(e,t,s)=>{const{profiles:a,groups:i,conversations:o,mutualFriends:c,contacts:d}=t;if((0,n.insertConvos)(e,o||[],s),(0,n.insertPeers)(e,{apiUsers:a||[],apiGroups:i||[],apiContacts:d||[]}),c){const t=e.peers.get(r.resolveId(c.peerId));t&&r.updateMutualFriends(t,c.hint.map(r.resolveId),c.count)}return[]}},632933:(e,t,s)=>{"use strict";s.d(t,{handler:()=>h});var n=s(795947),r=s(345543),a=s(250122),i=s(703543),o=s(548007),c=s(377836),d=s(207739),l=s(885540),u=s(33200);const h=(e,t)=>{switch(t.type){case"ChannelEngineBatchReceived":switch(t.variant.kind){case"FromChannelEngine":return function(e,t){const{next:s}=t;if("Failure"===s.kind){e.channelConn.status="resyncing";const{ts:t}=e.channelConn,s=e.channelConn.reconnectAttempts++;return[async function({api:e,channelEngine:n}){if(!n)return{type:"Noop"};const a=Math.min(2**s*500,1e4);let i;await(0,r.sleep)(a);try{i=await e.fetch("channels.getLongPollHistory",{lp_version:n.version,ts:t,limit:1e3,extended:1},{retries:1/0,timeout:u.CHANNELS_GLPH_TIMEOUT})}catch{return{type:"Noop"}}return n.connect({...i.credentials,ts:i.new_ts}),{type:"ChannelEngineBatchReceived",variant:{kind:"FromChannelEngineApiHistory",ts:i.new_ts,history:i.history,posts:i.messages||[]}}}]}const n=function(e,t){const s=new Set,n=new Set,r=new Map;function a(t){switch(t[0]){case 70001:{const[,a,i,,l]=t,u=o.resolveId(a);if(e.channels.has(u)||s.add(u),!l){const e=c.resolveCmid(i),t=r.get(u);t?t.add(e):r.set(u,new Set([e]));break}if(l.attachments?.[0]?.wall.copy_history?.[0]?.from_id){const e=d.resolveId(l.attachments[0].wall.copy_history[0].from_id);if(d.isUserPeerId(e)){n.add(e);break}if(d.isGroupPeerId(e)){s.add(o.resolveId(e));break}}break}case 70002:{const[,s,n,a]=t,i=o.resolveId(s);if(!e.channels.has(i))break;if(!a){const e=c.resolveCmid(n),t=r.get(i);t?t.add(e):r.set(i,new Set([e]));break}break}case 70010:{const[,s,n,,a]=t,i=o.resolveId(s);if(!e.channels.has(i))break;if(!a){const e=c.resolveCmid(n),t=r.get(i);t?t.add(e):r.set(i,new Set([e]));break}break}case 70003:case 70004:case 70006:case 70007:case 70008:break;case 70005:{const[,e,n]=t;if(n){const t=o.resolveId(e);s.add(t)}break}case 70009:{const[,e,n]=t;if(n){const t=o.resolveId(e);s.add(t)}break}case 70011:for(const e of t[1])a(e);break;default:}}for(const e of t.updates)a(e);return{channelIds:s,userIds:n,postCmidsByChannel:r}}(e,s);if(n.channelIds.size>0||n.userIds.size>0||n.postCmidsByChannel.size>0)return[async function({api:e}){try{const t=await e.fetchMany([n.channelIds.size>0&&{method:"channels.getById",params:{channel_ids:Array.from(n.channelIds).join(","),extended:1}},n.userIds.size>0&&{method:"users.get",params:{user_ids:Array.from(n.userIds).map(d.toRealId).join(","),extended:1}},...Array.from(n.postCmidsByChannel).map((([e,t])=>({method:"channels.getMessagesById",params:{channel_id:e,cmids:Array.from(t).join(","),extended:1}})))],{retries:1/0});return{type:"ChannelEngineBatchReceived",variant:{kind:"FromChannelEngineWithMissingData",next:s,response:t}}}catch{return{type:"Noop"}}}];return e.channelConn.reconnectAttempts=0,p(e,s)}(e,t.variant);case"FromChannelEngineWithMissingData":return function(e,t){const{next:s,response:[r,a,...i]}=t;let o=new Map;i&&i.forEach((t=>{(0,n.insertPeers)(e,{apiUsers:t.profiles||[],apiGroups:t.groups||[],apiContacts:[]}),t.items?.length&&(o=function(e){const t=new Map;for(const s of e){let e=t.get(s.channel_id);e||(e=new Map,t.set(s.channel_id,e)),e.set(s.cmid,s)}return t}(t.items))}));r&&(0,n.insertChannels)(e,{apiChannels:r.items||[],apiGroups:r.groups||[],dangerouslyMerge:!0});(a||r)&&(0,n.insertPeers)(e,{apiUsers:[...a||[],...r?.profiles||[]],apiGroups:r?.groups||[],apiContacts:[]});return p(e,s,{channelsMessagesById:o})}(e,t.variant);case"FromChannelEngineApiHistory":return function(e,t){const{ts:s,history:n,posts:r}=t,a=new Map;for(const e of r){let t=a.get(e.channel_id);t||(t=new Map,a.set(e.channel_id,t)),t.set(e.cmid,e)}const i={kind:"Batch",ts:s,updates:n.reduce(((e,t)=>{switch(t[0]){case 70001:case 70002:{const s=a.get(t[1])?.get(t[2]);return s?(e.push([...t,s]),e):e}default:return e.push(t),e}}),[])};return p(e,i)}(e,t.variant);default:return(0,r.exhaustivenessCheck)(t.variant)}case"ComposerDraftsUpdateNeeded":return[];default:return(0,r.exhaustivenessCheck)(t)}};function p(e,t,s){e.channelConn.status="running",e.channelConn.ts=t.ts;const n=t=>{switch(t[0]){case 70001:return function(e,t,s){const[,n,r,i,c]=t,d=o.resolveId(n),u=e.channels.get(d);if(!u)return[];if("ChannelRestricted"===u.kind)return[];o.setSortId(u,{minorSortId:i});const h=s?.channelsMessagesById.get(d)?.get(r)||c;if(!h)return[];const{post:p,reactions:m}=(0,l.fromApiPost)(h);for(const t of m)e.reactionsOld.set(t.id,t);o.appendPost(u,p),a.refreshChannels(e.organisers,u),e.locks.channelsCleanup.has(d)||o.cleanup(u);return[]}(e,t,s);case 70002:return function(e,t,s){const[,n,r,a]=t,i=o.resolveId(n),d=e.channels.get(i);if(!d)return[];if("ChannelRestricted"===d.kind)return[];const u=s?.channelsMessagesById.get(i)?.get(r)||a;if(!u)return[];const{post:h,reactions:p}=(0,l.fromApiPost)(u),m=o.findPostByCmid(d,h.cmid),g=c.merge(h,"Node"===m?.kind?m.item:void 0);for(const t of p)e.reactionsOld.set(t.id,t);return o.replacePost(d,g),[async()=>({type:"ComposerDraftsUpdateNeeded",foreignKind:"post",itemsToReplace:[g]})]}(e,t,s);case 70003:return function(e,t){const[,s,n,r]=t,a=o.resolveId(s),i=c.resolveCmid(n),d=e.channels.get(a);if(!d)return[];if("ChannelRestricted"===d.kind)return[];return o.setSortId(d,{minorSortId:r}),o.deletePost(d,i,{isRestorable:!1}),[async()=>({type:"ComposerDraftsUpdateNeeded",foreignKind:"post",itemsToDelete:[{channelId:a,cmid:i}]})]}(e,t);case 70004:return function(e,t){const[,s,n,r]=t,a=o.resolveId(s),i=c.resolveCmid(n),d=e.channels.get(a);if(!d)return[];if("ChannelRestricted"===d.kind)return[];return o.readUntil(d,i,r),[]}(e,t);case 70005:return function(e,t){const[,s,n,r]=t,c=o.resolveId(s),d=e.channels.get(c);if(!d)return[];if("ChannelRestricted"===d.kind)return[];return o.setArchived(d,!n),i.updateCounters(e.organisers.channelFilters,{archiveTotal:r}),a.refreshChannels(e.organisers,d),[]}(e,t);case 70006:return function(e,t){const[,s,n,r]=t,a=o.resolveId(s),i=e.channels.get(a);if(!i)return[];if("ChannelRestricted"===i.kind)return[];return o.setRights(i,{canPost:!!r}),o.setAdminLevel(i,n),[]}(e,t);case 70007:return function(e,t){const[,s,n]=t,r=o.resolveId(s),a=e.channels.get(r);if(!a)return[];if("ChannelRestricted"===a.kind)return[];return o.setMuted(a,0!==n),[]}(e,t);case 70008:return function(e,t){const[,s,n]=t;return i.updateCounters(e.organisers.channelFilters,{unread:s,unreadUnmuted:n}),[]}(e,t);case 70009:return function(e,t){const[,s,n]=t,r=o.resolveId(s),i=e.channels.get(r);if(!i)return[];if("ChannelRestricted"===i.kind)return[];return o.setMembership(i,Boolean(n)),a.refreshChannels(e.organisers,i),[]}(e,t);case 70010:return function(e,t,s){const[,n,r,,a]=t,i=o.resolveId(n),c=e.channels.get(i);if(!c)return[];if("ChannelRestricted"===c.kind)return[];const d=s?.channelsMessagesById.get(i)?.get(r)||a;if(!d)return[];const{post:u}=(0,l.fromApiPost)(d);"Normal"===u.kind&&o.restorePost(c,u.cmid,u);return[]}(e,t,s);case 70011:return t[1].flatMap(n);default:return[]}};return[...t.updates.flatMap(n),async function({channelEngine:e}){if(!e)return{type:"Noop"};try{return{type:"ChannelEngineBatchReceived",variant:{kind:"FromChannelEngine",next:await e.poll()}}}catch{return{type:"Noop"}}}]}},921148:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(345543),r=s(548007);const a=(e,t)=>{switch(t.type){case"ChannelMediaViewerCacheRemoved":{const s=e.channels.get(t.channel.id);return s&&"ChannelRestricted"!==s.kind?(r.clearMediaViewerCache(s),[]):[]}case"ChannelMediaViewerCacheInserted":{const s=e.channels.get(t.channelId);return s&&"ChannelRestricted"!==s.kind?(s.mediaViewerCache={...s.mediaViewerCache,...t.data},[]):[]}default:return(0,n.exhaustivenessCheck)(t)}}},958576:(e,t,s)=>{"use strict";s.d(t,{handler:()=>i});var n=s(345543),r=s(703543),a=s(795947);const i=(e,t)=>{switch(t.type){case"ChannelsOnboardingDone":return 0===t.pickedChannelsIds.length?(r.push(e.organisers.channelFilters,"all",[],!1),[async function({api:e}){return await e.fetch("account.hideHelpHint",{hint_id:"im:channels_onboarding"},{retries:1/0}),{type:"Noop"}}]):[async function({api:e}){try{return{type:"ChannelsOnboardingDone_RequestSucceeded",responseChannels:await e.fetch("channels.unarchive",{channel_ids:t.pickedChannelsIds.join(",")||"",extended:1})}}catch(e){return{type:"ChannelsOnboardingDone_RequestFailed"}}}];case"ChannelsOnboardingDone_RequestSucceeded":{const s=(0,a.insertChannels)(e,{apiChannels:t.responseChannels.succeeded||[],apiGroups:t.responseChannels.groups||[]});return r.push(e.organisers.channelFilters,"all",s,!1),[async function({api:e}){return await e.fetch("account.hideHelpHint",{hint_id:"im:channels_onboarding"},{retries:1/0}),{type:"Noop"}}]}case"ChannelsOnboardingDone_RequestFailed":return[];default:(0,n.exhaustivenessCheck)(t)}}},538975:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(345543),r=s(503048);const a=(e,t)=>{switch(t.type){case"ConvoMediaViewerCacheRemoved":{const s=e.convos.get(t.convo.peerId);return s?(r.clearMediaViewerCache(s),[]):[]}case"ConvoMediaViewerCacheInserted":{const s=e.convos.get(t.peerId);return s?(s.mediaViewerCache={...s.mediaViewerCache,...t.data},[]):[]}default:return(0,n.exhaustivenessCheck)(t)}}},528698:(e,t,s)=>{"use strict";s.d(t,{handler:()=>r});var n=s(345543);const r=(e,t)=>{const{type:s}=t;switch(s){case"HideEduIntegrationBanner":{const t=Date.now(),s=e.eduIntegrationBanner.hiddenCount+1;return e.eduIntegrationBanner.hiddenAt=t,e.eduIntegrationBanner.hiddenCount=s,[async function({storage:e}){return e.set("edu-integration-banner",{hiddenAt:t,hiddenCount:s}),{type:"Noop"}}]}case"ShowEduIntegrationBanner":{const t=null,s=e.eduIntegrationBanner.hiddenCount;return e.eduIntegrationBanner.hiddenAt=t,e.eduIntegrationBanner.hiddenCount=s,[async function({storage:e}){return e.set("edu-integration-banner",{hiddenAt:t,hiddenCount:s}),{type:"Noop"}}]}default:(0,n.exhaustivenessCheck)(s)}}},757061:(e,t,s)=>{"use strict";s.d(t,{handler:()=>M});var n=s(453934),r=s(795947),a=s(310110),i=s(500955),o=s(250122),c=s(81163),d=s(207739),l=s(503048),u=s(429920),h=s(330310),p=s(803854),m=s(907557),g=s(95233),f=s(886330),C=s(883262),_=s(345543),v=s(33200),y=s(467635),k=s(399137),I=s(791183),w=s(234950),b=s(963196);const R=200,M=(e,t,s)=>{switch(t.type){case"EngineBatchReceived":{const{variant:n}=t;switch(n.kind){case"FromEngine":return function(e,t,s){const{next:n,receivedMessagesStats:o,now:c}=s,h=t.convoConn.pts,p=t.ownerId;if("Failure"===n.kind){t.convoConn.status="resyncing";const s=t.convoConn.reconnectAttempts++;return[async function({api:t,engine:s}){if(!e.vkm_resync_glph_replacement)return{type:"Noop"};let n,{conversationLimit:r}=e.vkm_resync_glph_replacement;r=Math.min(Math.max(Number(r)||200,1),200);try{n=await t.fetch("messages.getDiff",{from_version:h,conversations_limit:r,lp_version:s.version,extended_filters:["credentials","server_version","profiles","contacts","groups","counters","messages","folders","folders_with_peers"].join(","),counter_filters:"all"},{retries:1/0})}catch{return{type:"Noop"}}if(n.invalidate_all)return window.location.reload(),{type:"Noop"};if(!n.credentials||!n.server_version)throw new Error("В ответе getDiff с credentials отсутствуют новые креды или pts!");const a=[{apiConversationsInfo:n.conversations_info,apiUsers:n.profiles,apiGroups:n.groups,apiContacts:n.contacts}];let i=n.conversations_source;for(;i;)try{const e=await t.fetch("messages.getDiff",{from_version:h,to_version:n.server_version,conversations_source:i,conversations_limit:r,extended_filters:["profiles","contacts","groups","messages"].join(",")},{retries:1/0});a.push({apiConversationsInfo:e.conversations_info,apiUsers:e.profiles,apiGroups:e.groups,apiContacts:e.contacts}),i=e.conversations_source}catch{return{type:"Noop"}}return s.connect({ts:n.credentials.ts,server:n.credentials.server_lp,key:n.credentials.key,pts:n.server_version}),{type:"EngineBatchReceived",variant:{kind:"FromApiEngineGetDiff",apiEntities:a,apiCounters:n.counters,apiFolders:n.folders,newPts:n.server_version}}},async function({api:t,engine:n,queue:a}){if(e.vkm_resync_glph_replacement)return{type:"Noop"};const i=Math.min(2**s*500,1e4);let o,d;await(0,_.sleep)(i);try{[o,d]=await t.fetchSeq([{method:"messages.getLongPollHistory",params:{lp_version:n.version,credentials:1,pts:h,msgs_limit:1100,events_limit:1100,last_n:1e3,extended:1,group_id:(0,r.getOwnerGroupId)(p)}},{method:"messages.getCounters",params:{filter:"all"}}],{retries:1/0})}catch{return{type:"Noop"}}if(h<(o.from_pts||0))return a.disconnect(),console.error("Выполняется полный ресинк"),{type:"TemporaryHackForResync"};if(!o.credentials||!o.credentials.pts)throw new Error("В ответе getLongPollHistory отсутствуют новые креды!");return n.connect({...o.credentials,pts:o.credentials.pts}),{type:"EngineBatchReceived",variant:{kind:"FromApiEngineHistory",apiMessages:o.messages?.items||[],apiConvos:o.conversations||[],apiUsers:o.profiles||[],apiGroups:o.groups||[],apiContacts:o.contacts||[],apiCounters:d,next:{kind:"Batch",pts:o.credentials.pts,ts:o.credentials.ts,updates:o.history||[]},now:c}}}]}if(function(e,t){for(const s of t.updates){if(a.IEngine.isIncompleteUpdate(s))return!0;switch(s[0]){case 20:case 21:{const[,t]=s,n=d.resolveId(t);if(!e.convos.has(n))return!0;break}case 52:{const[,t,n,r]=s,i=d.resolveId(n),o=e.convos.get(i);if(!o)break;switch(t){case a.IEngine.ChatUpdateType.FlagsChanged:case a.IEngine.ChatUpdateType.TitleChanged:case a.IEngine.ChatUpdateType.AvatarChanged:case a.IEngine.ChatUpdateType.BannerChanged:case a.IEngine.ChatUpdateType.MessageRequestChanged:case a.IEngine.ChatUpdateType.MessageRequestCanceled:case a.IEngine.ChatUpdateType.MessageRequestAccepted:case a.IEngine.ChatUpdateType.MessageRequestRejected:case a.IEngine.ChatUpdateType.CallInProgressChanged:case a.IEngine.ChatUpdateType.ContactConverted:case a.IEngine.ChatUpdateType.ContactJoined:case a.IEngine.ChatUpdateType.DescriptionChanged:case a.IEngine.ChatUpdateType.IncognitoJoined:case a.IEngine.ChatUpdateType.ConvertIncognito:case a.IEngine.ChatUpdateType.StyleChanged:return!0;case a.IEngine.ChatUpdateType.UserJoined:case a.IEngine.ChatUpdateType.UserLeft:case a.IEngine.ChatUpdateType.UserKicked:{const s=d.resolveId(r);if(!e.peers.has(s))return!0;if(t===a.IEngine.ChatUpdateType.UserJoined&&s===e.ownerId)return!0;break}case a.IEngine.ChatUpdateType.Pinned:{const[,,,e]=s;if(0===e)break;const t=u.resolveCmid(e),{status:n}=l.findHistoryNodeByCmid(o,t);return"NotLoaded"===n}case a.IEngine.ChatUpdateType.CopyFlagChanged:case a.IEngine.ChatUpdateType.AdminGrated:case a.IEngine.ChatUpdateType.AdminKicked:case a.IEngine.ChatUpdateType.KeyboardChanged:case a.IEngine.ChatUpdateType.BusinessNotifyDataChanged:case a.IEngine.ChatUpdateType.DonUnsubscribed:case a.IEngine.ChatUpdateType.DonSubscribed:case a.IEngine.ChatUpdateType.IsNewChange:case a.IEngine.ChatUpdateType.ShortPollReactionsChanged:case a.IEngine.ChatUpdateType.IncognitoLeft:break;default:}break}case 10013:{const[,t]=s,n=d.resolveId(t);return e.convos.has(n)}case 63:case 64:case 65:case 66:case 67:case 68:case 10:case 11:case 12:case 80:case 91:case 114:case 115:case 119:case 602:case 604:case 701:case 10001:case 10002:case 10006:case 10007:case 10501:case 10502:case 10503:case 10504:case 10505:case 10506:case 10507:case 10508:case 10509:break;case 10003:{const[,,t,n]=s;if(a.IEngine.isIncompleteUpdate(s))break;const r=d.resolveId(n),i=e.convos.get(r);if(!i)break;const{isDeleted:o,isSpam:c}=u.convertFlags(t);if((o||c)&&i)return!0;break}case 10004:{const[,,,,t,,,n,r]=s,a=d.resolveId(t),o=e.convos.get(a);if(!o)return!0;const c=F(o);if(N(r,c))return!0;if(n.has_template)return!0;const{message:l}=(0,i.fromEngineMessage)(s,e.ownerId,c);if(!e.peers.has(l.peerId)||!e.peers.has(l.authorId))return!0;if(d.isUserPeerId(l.authorId)&&l.peerId===l.authorId&&!e.lastSeens.has(l.authorId))return!0;break}case 10005:case 10018:{const[,t,n,r,,,,a]=s,i=d.resolveId(r),o=e.convos.get(i);if(!o)break;const c=u.resolveCmid(t);if(!l.findMessageByCmid(o,c))break;if(N(a,F(o)))return!0;if(u.convertFlags(n).hasReactions)return!0;break}case 10019:return!0;case 601:{const[,t,n,r]=s;if(1!==t&&2!==t)break;const a=e.convos.get(d.resolveId(n));if(!a||"NotLoaded"===g.findNodeByCmid(a.history,u.resolveCmid(r)).status)return!0;break}case 603:{const[,e]=s;switch(e){case 0:case 2:break;case 1:return!0;default:(0,_.exhaustivenessCheck)(e)}break}default:}}return!1}(t,n))return[T(h,n,p,c)];return t.convoConn.reconnectAttempts=0,[...E(e,t,n,c),U(o)]}(s,e,n);case"FromEngineWithMissingData":return function(e,t,s){const{apiConvos:n,apiMessages:a,apiUsers:i,apiGroups:o,apiContacts:c,apiIncognitoMembers:d,now:l}=s,u=P(a,n);return(0,r.insertConvos)(t,n.map((e=>({conversation:e,last_message:u.messagesByPeerId.get(e.peer.id)?.get(e.last_conversation_message_id||0)}))),e,{dangerouslyMerge:!0}),(0,r.insertPeers)(t,{apiUsers:i,apiGroups:o,apiContacts:c}),(0,r.insertIncognitoMembers)(t,d),E(e,t,s.skippedBatch,l,u)}(s,e,n);case"FromApiEngineHistory":return function(e,t,s){const{next:n,apiMessages:a,apiConvos:i,apiUsers:o,apiGroups:d,apiContacts:l,apiCounters:u,now:p}=s,m=P(a,i);(0,r.insertConvos)(t,i.map((e=>({conversation:e,last_message:m.messagesByPeerId.get(e.peer.id)?.get(e.last_conversation_message_id||0)}))),e,{dangerouslyMerge:!0}),(0,r.insertPeers)(t,{apiUsers:o,apiGroups:d,apiContacts:l},{dangerouslyOverwrite:!0}),t.activeCallsCount=u.calls||0,c.updateCounters(t.organisers.filters,{unread:u.messages||0,unreadUnmuted:u.messages_unread_unmuted||0,headerNotMutedUnread:0,archive:u.messages_archive_unread||0,archiveMentions:u.messages_archive_mentions_count||0,archiveTotal:u.messages_archive||0,messageRequests:u.message_requests||0,businessNotify:u.business_notify||0,businessNotifyTotal:u.business_notify_all||0}),u.messages_folders?.forEach((e=>{h.setUnreadCounters(t.organisers.folders,h.resolveId(e.folder_id),e.total_count,e.unmuted_count)}));const{unreadUnmutedCount:g,unreadCount:f}=t.organisers.filters.all,C=t.viewer.settings.countOnlyNotMuted;return[...E(e,t,n,p,m),async function({notification:e}){return e.setCounters({unread:f,unreadUnmuted:g,showOnlyNotMuted:C}),e.setIdleCounter(0),{type:"Noop"}}]}(s,e,n);case"FromApiEngineGetDiff":return function(e,t,s){const{apiEntities:n,apiFolders:a,apiCounters:i,newPts:o}=s,p=new Map,m=new Map;for(const{apiConversationsInfo:s=[],apiUsers:a=[],apiGroups:i=[],apiContacts:o=[]}of n)s.forEach((({conversation:s,message:n,invalidate:a,cmids_map:i=[],range_deleted_cmids:o=[],range_updated_cmids:c=[],cmids_updated_reactions:h=[]})=>{if(!s)return;const g=d.resolveId(s.peer.id),f=!t.convos.has(g);(0,r.insertConvos)(t,[{conversation:s,last_message:n?.[0]}],e,{dangerouslyMerge:!0,shouldUpdateSortId:!0,invalidateHistory:a});const C=t.convos.get(g);if(!C)return;if(f||a)return;const _=new Set,v=new Set,y=new Set(h.map(u.resolveCmid));i.forEach((({cmid:e,updated_flags:t})=>{const s=u.resolveCmid(e),{isDeleted:n,isPlayed:r,isEdited:a,wasRestored:i,isExpired:o,isImportant:c,isUnimportant:d}=S(t);if(n&&_.add(s),r||c||d){const e=r?u.MESSAGE_FLAGS.isPlayed:u.MESSAGE_FLAGS.isImportant,t=d?"unset":"set";l.updateMessageFlags(C,s,t,2**e)}(a||o)&&y.add(s),i&&v.add(s)}));const{deletedCmidsInCache:k,updatedCmidsInCache:I}=C.history.confirmed.reduce(((e,t)=>{if("GapNode"===t.kind)return e;const s="DeletedNode"===t.kind?t.restorable:t.item;_.has(s.cmid)&&e.deletedCmidsInCache.add(s.cmid);for(const{min:t,max:n}of o)if(s.cmid>=t&&s.cmid<=n){e.deletedCmidsInCache.add(s.cmid);break}y.has(s.cmid)&&e.updatedCmidsInCache.add(s.cmid);for(const{min:t,max:n}of c)if(s.cmid>=t&&s.cmid<=n){e.updatedCmidsInCache.add(s.cmid);break}return e}),{deletedCmidsInCache:new Set,updatedCmidsInCache:new Set});if(Array.from(v).forEach((e=>{const{status:t}=l.findHistoryNodeByCmid(C,e);"NotLoaded"!==t&&I.add(e)})),k.size>0){const e=Array.from(k);e.forEach((e=>{const t=l.findMessageByCmid(C,e);t&&l.deleteMessage(C,t,{isRestorable:!1})})),m.set(g,e)}I.size>0&&p.set(g,Array.from(I))})),(0,r.insertPeers)(t,{apiUsers:a,apiGroups:i,apiContacts:o},{dangerouslyOverwrite:!0});if(a){(0,r.insertSublists)(t,a.included_lists_info?.map(I.fromApiSublist));const e=a.items.map(w.fromApiFolder);(0,r.insertFolders)(t,e,{dangerouslyOverwrite:!0})}i&&(t.activeCallsCount=i.calls||0,c.updateCounters(t.organisers.filters,{unread:i.messages||0,unreadUnmuted:i.messages_unread_unmuted||0,headerNotMutedUnread:0,archive:i.messages_archive_unread||0,archiveMentions:i.messages_archive_mentions_count||0,archiveTotal:i.messages_archive||0,messageRequests:i.message_requests||0,businessNotify:i.business_notify||0,businessNotifyTotal:i.business_notify_all||0}),i.messages_folders?.forEach((e=>{h.setUnreadCounters(t.organisers.folders,h.resolveId(e.folder_id),e.total_count,e.unmuted_count)})));t.convoConn.status="running",t.convoConn.pts=o;const{unreadUnmutedCount:g,unreadCount:f}=t.organisers.filters.all,C=t.viewer.settings.countOnlyNotMuted;return[A(),async function({notification:e}){return e.setCounters({unread:f,unreadUnmuted:g,showOnlyNotMuted:C}),{type:"Noop"}},async function({api:e}){if(!p.size)return{type:"Noop"};let t;try{t=await e.fetch("messages.getDiffContent",{conversation_messages:JSON.stringify(Array.from(p).map((([e,t])=>({peer_id:e,updated_cmids:t})))),extended:1},{retries:1/0})}catch{return{type:"Noop"}}return{type:"EngineBatchReceived",variant:{kind:"FromApiEngineGetDiffContent",apiMessagesByPeerId:t.items.reduce(((e,{requested_messages:t,peer_id:s})=>{if(!t?.length)return e;const n=d.resolveId(s),r=e.get(n);return r?r.push(...t):e.set(n,t),e}),new Map),apiUsers:t.profiles,apiGroups:t.groups,apiContacts:t.contacts}}},...Array.from(m.entries()).map((([e,t])=>async function(){return{type:"ComposerDraftsUpdateNeeded",peerId:e,foreignKind:"message",itemsToDelete:t.map((t=>({peerId:e,cmid:t})))}}))]}(s,e,n);case"FromApiEngineGetDiffContent":return function(e,t){const{apiMessagesByPeerId:s,apiUsers:n=[],apiGroups:a=[],apiContacts:o=[]}=t;(0,r.insertPeers)(e,{apiUsers:n,apiGroups:a,apiContacts:o});const c=Array.from(s?.entries()||[]).reduce(((t,[s,n])=>{const{itemsToDelete:r,itemsToReplace:a}=n.reduce(((t,n)=>{const{message:r,mentions:a}=(0,i.fromApiMessage)(n),o=e.convos.get(s);if(!o)return t;const{status:c}=l.findHistoryNodeByCmid(o,r.cmid),d="Deleted"===c;return d?l.restoreMessage(o,r,a.hasDirect||a.hasMass):l.replaceMessage(o,r,a.hasDirect||a.hasMass),"Expired"===r.kind&&(l.replaceExpiredReplies(o,r.cmid),t.itemsToDelete=[...t.itemsToDelete,{peerId:s,cmid:r.cmid}]),"Normal"!==r.kind||d||(t.itemsToReplace=[...t.itemsToReplace,r]),t}),{itemsToDelete:[],itemsToReplace:[]});return(r.length>0||a.length>0)&&(t=[...t,{peerId:s,itemsToDelete:r,itemsToReplace:a}]),t}),[]);return[...c.map((({peerId:e,itemsToDelete:t,itemsToReplace:s})=>async function(){return{type:"ComposerDraftsUpdateNeeded",peerId:e,foreignKind:"message",itemsToDelete:t,itemsToReplace:s}}))]}(e,n);default:return(0,_.exhaustivenessCheck)(n)}}case"EngineBatchReceived_TypingsTimedOut":{const{peerId:s,typingType:n,timestamp:r}=t,a=e.typings.get(s);if(!a)return[];const i=a[n];return i?(i.updatedAt<=r&&delete a[n],0===Object.keys(a).length&&e.typings.delete(s),[]):[]}case"UpdateMessageRequestsCounter":return[async function({api:e}){try{const t=b.IApi.resolveTrackId("messages.getCounters","message_requests");e.dangerouslyAbort(t);const{message_requests:s}=await e.fetch("messages.getCounters",{filter:"message_requests"},{trackId:t});return{type:"UpdateMessageRequestsCounter_RequestCompleted",count:s??0}}catch{return{type:"Noop"}}}];case"UpdateMessageRequestsCounter_RequestCompleted":return c.updateCounters(e.organisers.filters,{messageRequests:t.count}),[];case"RefetchFoldersRequest_RequestCompleted":{const{apiFolders:n,folderId:a}=t,i=e.organisers.folders.find((e=>e.id===a));if(!i)return[];const c=n.items.find((e=>e.id===a))?.included_lists||[];h.setSublists(i,c),(0,r.insertSublists)(e,n.included_lists_info?.map(I.fromApiSublist));for(const[,t]of e.convos)o.refresh(e.organisers,t,s);return[]}case"TemporaryHackForResync":case"LoadChatMembers":case"LoadChatInfo":case"ComposerDraftsUpdateNeeded":return[];default:return(0,_.exhaustivenessCheck)(t)}};function S(e){const t={isDeleted:0,isEdited:1,isPlayed:2,isExpired:3,wasRestored:4,isImportant:5,isUnimportant:6};return(0,_.getFlagValueByBitOffset)(e,t)}function E(e,t,s,I,b){t.convoConn.status="running",t.convoConn.pts=s.pts;const M=s.updates.flatMap((s=>{switch(s[0]){case 10:case 11:case 12:return function(e,t,s){const[n,r,a]=t,i=d.resolveId(r),c=e.convos.get(i);if(!c)return[];const u={10:"unset",11:"replace",12:"set"}[n];return l.updateFlags(c,u,a),o.refresh(e.organisers,c,s),[]}(t,s,e);case 20:return function(e,t,s){const[,n,r]=t,a=d.resolveId(n),i=e.convos.get(a);if(!i)return[];return l.updateSortId(i,{majorSortId:r}),o.refresh(e.organisers,i,s),[]}(t,s,e);case 21:return function(e,t,s){const[,n,r]=t,a=d.resolveId(n),i=e.convos.get(a);if(!i)return[];l.updateSortId(i,{minorSortId:r}),o.refresh(e.organisers,i,s);const c=r<=0,u=e.organisers.filters.messageRequest.totalCount>0;if(c&&u)return[async function(){return{type:"UpdateMessageRequestsCounter",peerId:a}}];return[]}(t,s,e);case 52:return function(e,t,s){const[,n,r,i]=t,o=d.resolveId(r),c=e.convos.get(o);if(!c)return[];const h=s?.convos.get(r),p=h&&(0,y.fromApiConvo)(h);switch(n){case a.IEngine.ChatUpdateType.CopyFlagChanged:case a.IEngine.ChatUpdateType.TitleChanged:case a.IEngine.ChatUpdateType.AvatarChanged:case a.IEngine.ChatUpdateType.FlagsChanged:case a.IEngine.ChatUpdateType.BannerChanged:case a.IEngine.ChatUpdateType.DescriptionChanged:return[];case a.IEngine.ChatUpdateType.Pinned:{if("ChatConvo"!==c.kind)return[];const t=i,s=u.resolveCmid(t);if(e.hiddenPinnedMessages.delete(o),p?.convo.kind===c.kind)return p.convo.pinnedMessage&&l.pinMessage(c,p.convo.pinnedMessage),[];if(0===s)l.unpinMessage(c);else{const e=l.findMessageByCmid(c,s);"Normal"===e?.kind&&l.pinMessage(c,u.toPinned(e))}return[]}case a.IEngine.ChatUpdateType.ContactJoined:return[];case a.IEngine.ChatUpdateType.UserJoined:{if("ChatConvo"!==c.kind)return[];const t=d.resolveId(i);if(!d.isUserPeerId(t)&&!d.isGroupPeerId(t))return[];if(0!==c.members.memberIds.size){const s=f.isAdmin(c.members,e.ownerId)&&!f.isAdmin(c.members,t)||c.ownerId===e.ownerId,n=c.members.members.get(t);if(!n)return[d.isChatPeerId(o)&&async function(){return{type:"LoadChatMembers",peerId:o,memberIds:[t]}}];const r={peerId:t,canKick:s,isMessageRequest:!1,isRestrictedToWrite:n.isRestrictedToWrite};f.addMembers(c.members,[r])}return t===e.ownerId?(e.locks.getConversationMembers.add(o),[d.isChatPeerId(o)&&async function(){return{type:"LoadChatMembers",peerId:o}},d.isChatPeerId(o)&&async function(){return{type:"LoadChatInfo",peerId:o}}]):[]}case a.IEngine.ChatUpdateType.UserLeft:{if("ChatConvo"!==c.kind)return[];const t=d.resolveId(i);return d.isUserPeerId(t)||d.isGroupPeerId(t)?(t===e.ownerId&&l.changeUserState(c,"left"),f.isAdmin(c.members,t)&&f.unsetAdmin(c.members,t),f.removeMember(c.members,t),[]):[]}case a.IEngine.ChatUpdateType.UserKicked:{if("ChatConvo"!==c.kind)return[];const t=d.resolveId(i);if(!d.isUserPeerId(t)&&!d.isGroupPeerId(t))break;t===e.ownerId&&(l.changeUserState(c,"kicked"),l.restrictViewerToWrite(c,"kicked")),f.isAdmin(c.members,t)&&f.unsetAdmin(c.members,t),f.removeMember(c.members,t);break}case a.IEngine.ChatUpdateType.KeyboardChanged:return[];case a.IEngine.ChatUpdateType.CallInProgressChanged:{const e=c.inReadBy,t=c.unreadCount;return[async function({calls:s}){return s?.updateConvoCounter(o,e,t),{type:"Noop"}}]}case a.IEngine.ChatUpdateType.IsNewChange:return l.updateIsNew(c,!!i),[];case a.IEngine.ChatUpdateType.AdminGrated:{const t=d.resolveId(i);if("ChatConvo"!==c.kind||!d.isUserPeerId(t)&&!d.isGroupPeerId(t))return[];f.setAdmin(c.members,t);const s=f.getMember(c.members,t);return s&&f.addMembers(c.members,[{...s,canKick:c.ownerId===e.ownerId}]),t===e.ownerId&&l.isForbidedWritingForAll(c)&&l.allowViewerToWrite(c),[]}case a.IEngine.ChatUpdateType.AdminKicked:{const t=d.resolveId(i);if("ChatConvo"!==c.kind||!d.isUserPeerId(t)&&!d.isGroupPeerId(t))return[];f.unsetAdmin(c.members,t);const s=f.getMember(c.members,t);return s&&f.addMembers(c.members,[{...s,canKick:f.isAdmin(c.members,e.ownerId)}]),t===e.ownerId&&l.isForbidedWritingForAll(c)&&l.restrictViewerToWrite(c,"forbid_writing_for_all"),[]}case a.IEngine.ChatUpdateType.ContactConverted:{const t=d.resolveId(i),s=e.convos.get(t),n=e.peers.get(t);return n&&s&&"Contact"===n.kind&&d.isUserPeerId(o)?(d.convertContact(n,o),l.updateSortId(s,{minorSortId:0}),[]):[]}case a.IEngine.ChatUpdateType.ShortPollReactionsChanged:return"ChatConvo"!==c.kind||(c.shouldShortPollReactions=Boolean(i)),[];case a.IEngine.ChatUpdateType.IncognitoJoined:{if("ChatConvo"!==c.kind)return[];const t=f.resolveIncognitoMemberId(i),s=f.getIncognitoMember(c.members,t);if(!s?.memberId)return[];const n=d.resolveId(s.memberId);if(!d.isUserPeerId(n)&&!d.isContactPeerId(n))return[];const r={peerId:n,isRestrictedToWrite:!!c.members.members?.get(n)?.isRestrictedToWrite,canKick:f.isAdmin(c.members,e.viewer.id)||e.viewer.id===s.inviterId,isMessageRequest:!1,joinDate:1e3*s.inviteDate};return f.addMembers(c.members,[r]),[]}case a.IEngine.ChatUpdateType.ConvertIncognito:case a.IEngine.ChatUpdateType.IncognitoLeft:{if("ChatConvo"!==c.kind)return[];const e=f.resolveIncognitoMemberId(i),t=f.getIncognitoMember(c.members,e);return t?.memberId&&f.removeMember(c.members,t.memberId),f.removeIncognitoMember(c.members,e),[]}case a.IEngine.ChatUpdateType.StyleChanged:return p?.convo&&(c.styleId=p.convo.styleId),[];case a.IEngine.ChatUpdateType.BusinessNotifyDataChanged:case a.IEngine.ChatUpdateType.MessageRequestChanged:case a.IEngine.ChatUpdateType.MessageRequestAccepted:case a.IEngine.ChatUpdateType.MessageRequestCanceled:case a.IEngine.ChatUpdateType.MessageRequestRejected:case a.IEngine.ChatUpdateType.DonSubscribed:case a.IEngine.ChatUpdateType.DonUnsubscribed:return[];default:}return[]}(t,s,b);case 63:case 64:case 65:case 66:case 67:case 68:return function(e,t){const[s,n,r,,a]=t,i=new Set(r.map((e=>d.resolveId(e))));if(i.delete(e.viewer.id),!i.size)return[];const o=d.resolveId(n),c=e.convos.get(o);if(!c)return[];const l={63:"text",64:"voice",65:"photo",66:"video",67:"file",68:"videomessage"}[s],u={...e.typings.get(o)||{},[l]:{peerIds:i,updatedAt:a}};return e.typings.set(o,u),[async function(){return await(0,_.sleep)(v.TYPING_EXPIRATION_TIME),{type:"EngineBatchReceived_TypingsTimedOut",peerId:o,typingType:l,timestamp:a}}]}(t,s);case 80:return function(e,t){const[,s,n,r,a,,i,o,,d]=t;return c.updateCounters(e.organisers.filters,{unread:s,headerNotMutedUnread:i,unreadUnmuted:n,archive:o,archiveMentions:d,businessNotify:a}),e.viewer.settings.countOnlyNotMuted=Boolean(r),[async function({notification:e}){return e.setCounters({unread:s,unreadUnmuted:n,showOnlyNotMuted:Boolean(r)}),e.setIdleCounter(i),{type:"Noop"}}]}(t,s);case 91:return function(e,t,s){const[,n,r,a,i]=t,o=e.convos.get(d.resolveId(r));if(!o||"ChatConvo"!==o.kind)return[];const c=d.resolveId(a);switch(n){case 1:case 2:if(c===e.viewer.id){const e=i?s+1e3*i:void 0;l.restrictViewerToWrite(o,"restricted_to_write_in_chat",e)}f.restrictMemberToWrite(o.members,c);break;case 3:c===e.viewer.id&&l.allowViewerToWrite(o),f.allowMemberToWrite(o.members,c);break;default:(0,_.exhaustivenessCheck)(n)}return[]}(t,s,I);case 114:return function(e,t){const[,{peer_id:s}]=t,n=d.resolveId(s),r=e.convos.get(n);if(!r)return[];const a=(0,y.fromLongpollPushSettings)(t);return l.updatePush(r,a),[]}(t,s);case 115:return function(e,t){const[,s]=t,{browserNotifications:n}=e.viewer.settings;return[async function({calls:e,notification:t}){if(!e)return{type:"Noop"};if(e.showIncomingCall(s),!n)return{type:"Noop"};const r=d.resolveId(s.from_id);let a,i="";return s.caller_info&&(i=`${s.caller_info.first_name} ${s.caller_info.last_name}`,a=s.caller_info.photo_400),s.chat_info&&(i=s.chat_info.title,a=s.chat_info.photo_400),t.notify({kind:"call",peerId:r,caller:i,image:a},r),{type:"Noop"}}]}(t,s);case 119:return function(e,t){const[,s]=t,n=d.resolveId(s.peer_id),r=d.resolveId(s.owner_id),a=e.convos.get(n),i=e.peers.get(n),o=e.peers.get(r),c=a&&i&&o?(0,k.fromApiMessageEvent)(i,o,s):void 0;return e.botKeyboardEvent=c,[]}(t,s);case 10501:return function(e,t){return(0,r.insertFolders)(e,[(0,w.fromEngineFolder)(t)]),[]}(t,s);case 10502:return function(e,t,s){const[,n]=t,r=h.resolveId(n);if(h.deleteFolder(e.organisers.folders,r),!s.vkm_new_convo_folder_logic)for(const t of e.convos.values())l.removeFolder(t,r);return[]}(t,s,e);case 10503:return function(e,t){const[,s,n]=t,r=h.resolveId(s),a=e.organisers.folders.find((e=>e.id===r));if(!a)return[];return h.setName(a,n),[]}(t,s);case 10504:return function(e,t,s){const[,n,...a]=t,i=h.resolveId(n),o=(0,r.getConvosByIds)(e,a),c=e.organisers.folders.find((e=>e.id===i));if(!c)return[];return(0,r.addConvosToFolder)(e,i,o,s),[]}(t,s,e);case 10505:return function(e,t,s){const[,n,...a]=t,i=h.resolveId(n),o=(0,r.getConvosByIds)(e,a),c=e.organisers.folders.find((e=>e.id===i));if(!c)return[];return(0,r.removeConvosFromFolder)(e,i,o,s),[]}(t,s,e);case 10506:return function(e,t){const[,...s]=t;return h.reorderFolders(e.organisers.folders,s.map((e=>h.resolveId(e)))),[]}(t,s);case 10507:return function(e,t){const[,...s]=t;for(const t of s){if(t.length<3)continue;const s=h.resolveId(t[0]);h.setUnreadCounters(e.organisers.folders,s,t[1],t[2])}return[]}(t,s);case 10508:return function(e,t){const[,s]=t,n=h.resolveId(s),r=e.organisers.folders.find((e=>e.id===n));if(!r)return[];return h.replaceFolder(e.organisers.folders,(0,w.fromApiFolder)({id:n,name:r.name,type:r.type,flags:h.convertFlags({type:r.type,hasSublist:r.hasSublist})})),[]}(t,s);case 10509:return function(e,t,s){const[,n,r]=t,a=h.resolveId(n),i=e.organisers.folders.find((e=>e.id===a));if(i){if(h.updateFlags(i,r),!s.vkm_channels_folder&&"channels"===i?.type)return h.deleteFolder(e.organisers.folders,i.id),[];if(i.hasSublist&&s.vkm_sublists_in_folder&&s.vkm_new_convo_folder_logic)return[async function({api:e}){try{return{type:"RefetchFoldersRequest_RequestCompleted",apiFolders:await e.fetch("messages.getFolders",{with_peers:1,supported_types:h.getSupportedTypes(s)}),folderId:a}}catch{return{type:"Noop"}}}]}return[]}(t,s,e);case 601:return function(e,t,s){const[,r,a,o]=t,c=d.resolveId(a),h=u.resolveCmid(o);let p,g=0,f=[];switch(r){case 1:{const[,,,,e,s,...n]=t;g=s,f=n,p=m.resolveId(e);break}case 2:case 3:case 4:{const[,,,,e,...s]=t;g=e,f=s;break}default:return[]}const C=[];let _=0;for(let e=0;e<g;e++){const e=f[_];if(!e)return[];const t=f.slice(_+1,_+1+e);_+=1+e;const[s,n,r]=t.slice(0,3);if(void 0===s||void 0===n||void 0===r)return[];const a=t.slice(3,3+r).map(d.resolveId).sort(((e,t)=>e-t));C.push({reactionId:m.resolveId(s),count:n,peerIds:new Set(a)})}const v=e.convos.get(c);if(!v)return[];let y,k,I=0,w=[];if(2===r||4===r){I=f[_]??0;const e=_+1,t=e+Math.min(3,I??0);w=f.slice(e,t).map((e=>d.resolveId(e))),y=f[t]?m.resolveId(f[t]):void 0}k=l.findMessageByCmid(v,h),"Normal"===k?.kind&&(1!==r&&3!==r||u.setCurrentUserReaction(k,p),u.setReactions(k,C));if(k)k=(0,n.isDraft)(k)?(0,n.current)(k):k;else{const e=s?.messagesByPeerId.get(c)?.get(h);if(k=e&&(0,i.fromApiMessage)(e).message,!k)return[]}const b=`${c}-${h}`,M=e.messageReactedPeers.get(b)??new Set;let S=[];switch(r){case 2:S=w.filter((e=>!M.has(e))),e.messageReactedPeers.set(b,new Set([...M,...S]));break;case 4:const t=new Set([...M].filter((e=>!w.includes(e))));if(0===t.size){e.messageReactedPeers.delete(b);break}e.messageReactedPeers.set(b,t)}if(e.messageReactedPeers.size>R){const t=e.messageReactedPeers.keys(),s=e.messageReactedPeers.size-R;for(let n=0;n<s;n++)e.messageReactedPeers.delete(t.next().value)}const E=S.map((t=>{const s=e.peers.get(d.resolveId(t));return((0,n.isDraft)(s)?(0,n.current)(s):s)??null})).filter((e=>null!==e)),A=!l.isMuted(v)&&e.viewer.settings.push.messageReaction.isEnabled,U=C.some((t=>!e.messageReactions.has(t.reactionId)));y&&l.setUnreadReaction(v,h,y);return[async function({notification:e}){if("Normal"!==k?.kind)return{type:"Noop"};const t=k.sentAt<Date.now()-432e5,s=[...k.reactions.values()].reduce(((e,t)=>e+t.count),0);return A&&k.isOut&&2===r&&!t&&s<8&&I>0&&e.notify({kind:"reaction",message:k,reactedPeers:E,reactedCount:I}),{type:"Noop"}},U&&async function(){return{type:"InvalidateMessageReactions",force:!0}}]}(t,s,b);case 602:return function(e,t){const[,s,...n]=t,r=d.resolveId(s),a=e.convos.get(r);if(!a)return[];const i=n[0];if(void 0===i)return[];const o=n.slice(1,i+1).map(u.resolveCmid);return l.replaceUnreadReactions(a,o),[]}(t,s);case 603:return function(e,t,s){if(!s.vkm_edu_precreated_convos)return[];const[,n]=t;switch(n){case 0:{const[,,,...s]=t;s.forEach((t=>{e.precreatedConvos.peerIds.delete(t)}));break}case 1:{const[,,,...s]=t;s.forEach((t=>{e.precreatedConvos.peerIds.add(t)}));break}case 2:e.precreatedConvos={peerIds:new Set,hasMore:!0};break;default:(0,_.exhaustivenessCheck)(n)}return[]}(t,s,e);case 604:return function(e,t,s){const[,n,r]=t;if(!s.vkm_edu_integration_banner)return[];if(r===v.EDU_INTEGRATION_BANNER_ID)e.eduIntegrationBanner.isEnabled=1===n;else(0,_.exhaustivenessCheck)(r);return[]}(t,s,e);case 701:return function(e,t,s){const[,n]=t,r=d.resolveId(n),a=e.convos.get(r);if(!a)return[];if("ChatConvo"!==a.kind)return[];return a.isDeleted=!0,o.refresh(e.organisers,a,s),[]}(t,s,e);case 10001:case 10002:case 10003:return function(e,t,s){const[n,r,a,o]=t,c=u.resolveCmid(r),h=d.resolveId(o),p=e.convos.get(h);if(!p)return[];const m=u.convertFlags(a);if(10003===n){const{isDeleted:e,isSpam:t}=m;if((e||t)&&r){const e=s?.messagesByPeerId.get(o)?.get(r);if(e){const t=(0,i.fromApiMessage)(e);l.restoreMessage(p,t.message,t.mentions.hasDirect||t.mentions.hasMass)}}}const g={10001:"replace",10002:"set",10003:"unset"}[n],{status:f}=l.findHistoryNodeByCmid(p,c);if("NotLoaded"===f)return[];return l.updateMessageFlags(p,c,g,a),[async()=>{if(10002!==n)return{type:"Noop"};const{isDeleted:e,isDeletedForAll:t}=m;return e||t?{type:"ComposerDraftsUpdateNeeded",peerId:h,foreignKind:"message",itemsToDelete:[{peerId:h,cmid:c}]}:{type:"Noop"}}]}(t,s,b);case 10004:case 10005:case 10018:case 10019:return function(e,t,s,n){const[,c]=t;let h;switch(t[0]){case 10004:h=t[4];break;case 10005:case 10018:h=t[3];break;case 10019:h=t[2];break;default:(0,_.exhaustivenessCheck)(t)}const m=d.resolveId(h),g=e.convos.get(m);if(!g)return[];const f=n?.messagesByPeerId.get(h)?.get(c);let v,y,I;if(f){const e=(0,i.fromApiMessage)(f);v=e.message,y=e.mentions;const t=n?.convos.get(m)?.current_keyboard;if(t){const e=(0,k.fromApiKeyboard)(t,m);if("InputKeyboard"===e.kind){JSON.stringify(g.currentKeyboard)!==JSON.stringify(e)&&(I={kind:"InputKeyboardUpsertEvent",keyboard:e})}}else I={kind:"InputKeyboardDeleteEvent"}}else{if(a.IEngine.isIncompleteUpdate(t)||10019===t[0])return[];const s=(0,i.fromEngineMessage)(t,e.ownerId,F(g));v=s.message,y=s.mentions,I=s.keyboardEvent}if(f&&!a.IEngine.isIncompleteUpdate(t)&&10019!==t[0]){y=(0,i.fromEngineMessage)(t,e.ownerId,F(g)).mentions}switch(t[0]){case 10004:{const n=e.typings.get(g.peerId);if(n)for(const t of r.TypingVariants){const s=n[t];s&&s.peerIds.has(v.authorId)&&(s.peerIds.delete(v.authorId),0===s.peerIds.size&&delete n[t],0===Object.keys(n).length&&e.typings.delete(g.peerId))}const a=t[3],i=y.hasDirect||y.hasMass;if(i&&_.isDev){if(g.inReadBy>=v.cmid)throw new Error(`Peer: ${g.peerId} получено сообщение с меншеном со cmid: ${v.cmid} и границей прочитанности: ${g.inReadBy}`);if(v.isOut)throw new Error(`Peer: ${g.peerId} получен меншен в исходящем сообщении`)}"ChatConvo"===g.kind?l.appendMessage(g,v,a,i,I):l.appendMessage(g,v,a,!1,I),o.refresh(e.organisers,g,s),e.locks.convosCleanup.has(g.peerId)||l.cleanup(g),"InputKeyboardUpsertEvent"===I?.kind&&e.hiddenBotKeyboards.delete(g.peerId);const c=u.convertFlags(t[2]),h=l.isMessageUnread(g,v),{browserNotifications:f,soundNotifications:k,push:w}=e.viewer.settings;let b=null;switch(g.kind){case"UserConvo":b=w.userConvo;break;case"ChatConvo":b=w.chatConvo;break;case"GroupConvo":b=w.groupConvo}const R=!v.isOut&&!c.noPush&&h;let M=R&&f&&b?.isEnabled;const S=R&&k&&!v.isSilent&&!l.isMuted(g);M&&(M="nothing"!==g.push.mode&&"nothing"!==w.mention&&("direct-mention"===g.push.mode||"direct-mention"===w.mention?!l.isMuted(g)||y.hasDirect:!l.isMuted(g)||i));const E=d.isMarusia(m)&&"Normal"===v.kind&&{type:"add_message",payload:{randomId:Number(v.randomId),text:u.toRawText(v),isOutbound:v.isOut,local:!1,payload:t[7]?.payload,attachIds:p.ids(v.attaches)}},A=g.unreadCount,U=g.inReadBy;return"Service"!==v.kind||"conversation_style_update"!==v.action.type&&"conversation_style_update_action"!==v.action.type||(g.styleId=C.resolveStyleId(v.action.styleId||"system")),[async function({notification:e}){return M&&e.notify({kind:"message",message:v},m),S&&e.playSound(),{type:"Noop"}},"ChatConvo"===g.kind&&g.activeCall&&async function({calls:e}){return e?.updateConvoCounter(m,U,A),{type:"Noop"}},E&&async function({marusia:e}){return e?.handleAction(E),{type:"Noop"}}]}case 10005:case 10018:case 10019:return l.replaceMessage(g,v,y.hasDirect||y.hasMass),"Expired"===v.kind&&l.replaceExpiredReplies(g,v.cmid),[async()=>({type:"ComposerDraftsUpdateNeeded",peerId:m,foreignKind:"message",itemsToDelete:"Expired"===v.kind?[{peerId:m,cmid:v.cmid}]:void 0,itemsToReplace:"Normal"===v.kind?[v]:void 0})];default:return(0,_.exhaustivenessCheck)(t)}}(t,s,e,b);case 10006:case 10007:return function(e,t,s){const[n,r,a,i]=t,c=d.resolveId(r),h=u.resolveCmid(a),p=e.convos.get(c);if(!p)return[];10006===n?(l.readInUntil(p,h,i),d.isFavorites(p.peerId,e.ownerId)&&l.readOutUntil(p,h)):l.readOutUntil(p,h);return o.refresh(e.organisers,p,s),[10006===n&&"ChatConvo"===p.kind&&p.activeCall&&async function({calls:e}){return e?.updateConvoCounter(c,a,i),{type:"Noop"}},10006===n&&async function({notification:e}){return e.removeNotification(c,h),{type:"Noop"}}]}(t,s,e);case 10013:return function(e,t,s){const[,n,r]=t,a=d.resolveId(n),i=u.resolveCmid(r),o=e.convos.get(a);if(!o)return[];if(g.lastCmid(o.history)!==i)return[];const c=s?.convos.get(n);if(!c||!(0,y.fromApiConvo)(c))return[async function({logger:e}){return e.error("[EngineBatchReceived]",new Error(`В ${t[0]} отсутствует дозагруженная беседа`)),{type:"Noop"}}];return[]}(t,s,b);default:return[]}}));return[A(),...M]}function A(){return async function({engine:e,perfStats:t}){const s=await e.poll(),n=Date.now(),r=function(e,t){if(void 0===t||"Failure"===e.kind||e.updates.length>10)return;const s=e.updates.filter((e=>10004===e[0]));if(0!==s.length)return{time:t.getCurrentTime(),updates:s};return}(s,t);return{type:"EngineBatchReceived",variant:{kind:"FromEngine",next:s,receivedMessagesStats:r,now:n}}}}function U(e){return async function({perfStats:t}){if(void 0===t||void 0===e)return{type:"Noop"};const{time:s,updates:n}=e,r=n.reduce(((e,t)=>(10004===t[0]&&e.push(d.resolveId(t[4])),e)),[]);void 0!==t.getEvent("receive_message")?.data.LP&&t.removeEvent("receive_message");const a=t.getEvent("receive_message"),i={LPMessagesCount:r.length,LP:s};if(void 0===a)return t.addEvent("receive_message",{peerIds:r,data:i}),{type:"Noop"};const o=a.peerIds[0];return o&&r.includes(d.resolveId(o))&&t.addEventData("receive_message",i),{type:"Noop"}}}function T(e,t,s,n){return async function({api:a,engine:i,logger:o,queue:c}){let d;try{d=await a.fetch("messages.getLongPollHistory",{pts:e,lp_version:i.version,msgs_limit:1100,events_limit:1100,last_n:1e3,extended:1,group_id:(0,r.getOwnerGroupId)(s)},{retries:1/0})}catch{return{type:"Noop"}}return e<(d.from_pts||0)?(o.error("[EngineBatchReceived]",new Error("Ошибка дозагрузки кэша")),c.disconnect(),{type:"TemporaryHackForResync"}):{type:"EngineBatchReceived",variant:{kind:"FromEngineWithMissingData",apiConvos:d.conversations||[],apiMessages:d.messages?.items||[],apiUsers:d.profiles||[],apiGroups:d.groups||[],skippedBatch:t,apiContacts:d.contacts||[],apiIncognitoMembers:d.incognito_members||[],now:n}}}}function P(e,t){const s=new Map;for(const t of e){let e=s.get(t.peer_id);e||(e=new Map,s.set(t.peer_id,e)),e.set(t.conversation_message_id,t)}return{messagesByPeerId:s,convos:new Map(t.map((e=>[e.peer.id,e])))}}function F(e){return function(t){const s=l.findMessageByCmid(e,t);return"Normal"===s?.kind?s:void 0}}function N(e,t){if(e.fwd&&!e.reply)return!0;if(e.reply){const s=JSON.parse(e.reply);if(!t(u.resolveCmid(s.conversation_message_id)))return!0}if(e.geo)return!0;if(e.attachments&&e.attach1_type&&!e.attach2_type)try{const t=JSON.parse(e.attachments);if(Array.isArray(t)&&t[0].type===e.attach1_type)return!1}catch{return!0}return!!e.attach1_type}},89586:(e,t,s)=>{"use strict";s.d(t,{handler:()=>r});var n=s(795947);const r=(e,t)=>((0,n.insertPeers)(e,{apiUsers:t.profile?[t.profile]:[],apiContacts:[t.contact],apiGroups:[]},{dangerouslyOverwrite:!0}),(0,n.insertContacts)(e,[t.contact]),[])},336921:(e,t,s)=>{"use strict";s.d(t,{handler:()=>i});var n=s(345543),r=s(907557);const a=864e5,i=(e,t)=>{switch(t.type){case"InvalidateMessageReactions":{const{force:s}=t,{locks:{invalidateMessageReactions:n}}=e;return n?[]:(e.locks.invalidateMessageReactions=!0,[async function({api:e,storage:t}){try{const n=await async function({api:e,storage:t,force:s=!1}){const n=t.get("message-reactions-assets"),r=(new Date).getTime(),i=!n||n.expiresAt<r;let o=null;if(i||s)try{o=await e.fetch("messages.getReactionsAssets",{client_version:n?.response.version??void 0},{retries:3})}catch{o=n?.response||null}else o=n?.response||null;const c=o?{...o,assets:[...n?.response.assets||[],...o.assets],override_assets:o.override_assets||[]}:null;(i||s)&&c&&t.set("message-reactions-assets",{response:c,expiresAt:r+a});return c}({api:e,storage:t,force:Boolean(s)});return{type:"InvalidateMessageReactions_RequestCompleted",hasFailed:null===n,response:n}}catch{return{type:"InvalidateMessageReactions_RequestCompleted",hasFailed:!0,response:null}}}])}case"InvalidateMessageReactions_RequestCompleted":{const{response:s,hasFailed:n}=t;if(n||!s)return[];e.locks.invalidateMessageReactions=!1,e.messageReactions=s.assets.reduce(((e,t)=>{const n=s.override_assets?.find((e=>e.reaction_id===t.reaction_id))??t;return e.set(r.resolveId(n.reaction_id),{id:r.resolveId(n.reaction_id),image:n.links.static,animationSmall:n.links.small_animation,animationBig:n.links.big_animation,name:""}),e}),new Map);const a=new Map([[1,0],[3,1],[15,3],[8,4],[7,5]]);return e.postReactions=s.assets.reduce(((e,t)=>{if(a.has(t.reaction_id)){const n=s.override_assets?.find((e=>e.reaction_id===t.reaction_id))??t;e.set(r.resolveId(a.get(t.reaction_id)),{id:r.resolveId(a.get(t.reaction_id)),image:n.links.static,animationSmall:n.links.small_animation,animationBig:n.links.big_animation,name:""})}return e}),new Map),[]}default:(0,n.exhaustivenessCheck)(t)}}},347751:(e,t,s)=>{"use strict";s.d(t,{handler:()=>c});var n=s(345543),r=s(503048),a=s(886330),i=s(795947),o=s(467635);const c=(e,t)=>{switch(t.type){case"LoadChatInfo":{const{peerId:s}=t,n=(0,i.getOwnerGroupId)(e.ownerId);return e.locks.getConversationInfo.has(s)?[]:(e.locks.getConversationInfo.add(s),[async function({api:e}){try{const t=await e.fetch("messages.getConversationsById",{peer_ids:s.toString(),group_id:n,extended:0});return{type:"LoadChatInfo_RequestComplete",peerId:s,convo:t.items[0],hasFailed:!t.items[0]}}catch{return{type:"LoadChatInfo_RequestComplete",peerId:s,hasFailed:!0}}}])}case"LoadChatInfo_RequestComplete":{const{peerId:s,convo:n,hasFailed:i}=t;e.locks.getConversationInfo.delete(s);const c=e.convos.get(s);if("ChatConvo"!==c?.kind||i||!n)return[];const d=(0,o.fromApiConvo)(n);return"ChatConvo"!==d?.convo.kind||(r.updateAcl(c,{...d.convo.acl}),a.setCount(c.members,d.convo.members.count)),[]}default:(0,n.exhaustivenessCheck)(t)}}},613729:(e,t,s)=>{"use strict";s.d(t,{handler:()=>i});var n=s(345543),r=s(886330),a=s(795947);const i=(e,t)=>{switch(t.type){case"LoadChatMembers":{const{peerId:s,offset:n,memberIds:r}=t,i=(0,a.getOwnerGroupId)(e.ownerId),o=e.convos.get(s),c="ChatConvo"!==o?.kind?void 0:o.members.count,d=!!r?.length;return[async function({api:e}){try{return{type:"LoadChatMembers_RequestComplete",peerId:s,response:await e.fetch("messages.getConversationMembers",{peer_id:s,extended:1,group_id:i,count:1e3,offset:n||c,member_ids:r&&r.join(",")},{retries:1}),partialLoading:d,hasFailed:!1}}catch{return{type:"LoadChatMembers_RequestComplete",peerId:s,partialLoading:d,hasFailed:!0}}}]}case"LoadChatMembers_RequestComplete":{const{peerId:s,response:n,partialLoading:i,hasFailed:o}=t;e.locks.getConversationMembers.delete(s);const c=e.convos.get(s);return"ChatConvo"!==c?.kind||o||!n?[]:((0,a.insertChatMembers)(c.members,n),(0,a.insertPeers)(e,{apiUsers:n.profiles||[],apiGroups:n.groups||[],apiContacts:n.contacts||[]}),i?r.setCount(c.members,c.members.members.size+c.members.incognitoMembers.size):r.setCount(c.members,n.count),(c.members.count||0)<n.count?[async function(){return{type:"LoadChatMembers",peerId:s}}]:[])}default:(0,n.exhaustivenessCheck)(t)}}},490867:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(345543),r=s(795947);const a=(e,t)=>{switch(t.type){case"LoadContactList":return e.locks.contactList?[]:(e.locks.contactList=!0,[async function({api:e}){try{const s=await e.fetch("account.getContactList",{extended:1,offset:t.offset},{retries:1});return{type:"LoadContactList_RequestCompleted",contacts:s.contacts||[],profiles:s.profiles||[],items:s.items||[]}}catch(e){return{type:"LoadContactList_RequestCompleted",contacts:[],profiles:[],items:[]}}}]);case"LoadContactList_RequestCompleted":return e.locks.contactList=!1,(0,r.insertContacts)(e,t.contacts),(0,r.insertContactItems)(e,t.items,t.profiles),e.contacts.hasMore=!1,[];default:(0,n.exhaustivenessCheck)(t)}}},497417:(e,t,s)=>{"use strict";s.d(t,{getImportantMessageKey:()=>o,handler:()=>i});var n=s(345543),r=s(500955),a=s(795947);const i=(e,t,s)=>{switch(t.type){case"LoadImportantMessages":{const t=20*Math.floor(e.importantMessages.messages.size/20),s=e.ownerId;return[async function({api:e}){try{return{type:"LoadImportantMessages_RequestCompleted",hasFailed:!1,response:await e.fetch("messages.getImportantMessages",{count:20,offset:t,extended:1,group_id:(0,a.getOwnerGroupId)(s)})}}catch(e){return{type:"Noop"}}}]}case"LoadImportantMessages_RequestCompleted":{const{response:{messages:n,profiles:i,groups:c,conversations:d}}=t;return(n.items?.length||0)<20&&(e.importantMessages.hasMore=!1),(0,a.insertConvos)(e,d||[],s),(0,a.insertPeers)(e,{apiUsers:i||[],apiGroups:c||[],apiContacts:[]}),n.items?.forEach((t=>{const{message:s}=(0,r.fromApiMessage)(t);"Normal"===s.kind&&e.importantMessages.messages.set(o(s.peerId,s.cmid),s)})),[]}case"UserClosedImportantMessages":return e.importantMessages.messages.clear(),e.importantMessages.hasMore=!0,[];default:return(0,n.exhaustivenessCheck)(t)}},o=(e,t)=>`${e}-${t}`},603698:(e,t,s)=>{"use strict";s.d(t,{handler:()=>i});var n=s(345543),r=s(330310),a=s(795947);const i=(e,t,s)=>{switch(t.type){case"LoadRecommendedFolders":return e.locks.loadRecommendedFolders||e.organisers.recommendedFolders.length?[]:(e.locks.loadRecommendedFolders=!0,[async function({api:e}){try{return{type:"LoadRecommendedFolders_RequestComplete",recommendedFolders:(await e.fetch("messages.getRecommendedFolders",{supported_types:r.getSupportedTypes(s)})).items||[],hasFailed:!1}}catch{return{type:"LoadRecommendedFolders_RequestComplete",recommendedFolders:[],hasFailed:!0}}}]);case"LoadRecommendedFolders_RequestComplete":{const{recommendedFolders:s,hasFailed:n}=t;return e.locks.loadRecommendedFolders=n,(0,a.insertRecommendedFolders)(e,s||[]),[]}default:(0,n.exhaustivenessCheck)(t)}}},248934:(e,t,s)=>{"use strict";s.d(t,{handler:()=>o});var n=s(795947),r=s(33200),a=s(703543),i=s(345543);const o=(e,t)=>{switch(t.type){case"MoreChannelsNeeded":{const{organiser:s}=t,{filter:n}=s,i=a.getLockId(n);if(e.locks.getChannels[i]||!e.organisers.channelFilters[n].hasMore)return[];const{minorSortId:o,channelId:c}=e.organisers.channelFilters[n].boundary;e.locks.getChannels[i]=!0;const d=r.CHANNELS_PER_PAGE+1,l=a.isLoaded(e.organisers.channelFilters[n])?o:void 0;return[async function({api:e}){try{const n=await e.fetch("channels.get",{count:d,offset_minor_sort_id:l,offset_channel_id:c,filter:a.snakeCaseId(s.filter),extended:1},{retries:3});return{...t,type:"MoreChannelsNeeded_RequestCompleted",hasFailed:!1,response:n,hasMore:(n.items?.length||0)>=d}}catch(e){return{...t,type:"MoreChannelsNeeded_RequestCompleted",hasFailed:!0,hasMore:!1}}}]}case"MoreChannelsNeeded_RequestCompleted":{const{hasFailed:s,organiser:r,hasMore:o}=t;let c="";if("channelFilters"===r.kind)c=a.getLockId(r.filter);else(0,i.exhaustivenessCheck)(r.kind);if(e.locks.getChannels[c]=!1,s)return[];const{response:d}=t;if(d){const t=(0,n.insertChannels)(e,{apiChannels:d.items||[],apiGroups:d.groups||[]});if((0,n.insertPeers)(e,{apiUsers:d.profiles||[],apiGroups:d.groups||[],apiContacts:[]}),"channelFilters"===r.kind)a.push(e.organisers.channelFilters,r.filter,t,o);else(0,i.exhaustivenessCheck)(r.kind)}return[]}default:(0,i.exhaustivenessCheck)(t)}}},475393:(e,t,s)=>{"use strict";s.d(t,{handler:()=>c});var n=s(795947),r=s(33200),a=s(81163),i=s(345543),o=s(330310);const c=(e,t,s)=>{switch(t.type){case"MoreConvosNeeded":{const{organiser:s}=t,c=e.ownerId;let d,l="";switch(s.kind){case"filters":{const{filter:t}=s;if(l=a.getLockId(t),e.locks.getConversations[l]||!e.organisers.filters[t].hasMore)return[];d={start_message_id:a.isLoaded(e.organisers.filters[t])?e.organisers.filters[t].boundary.minorSortId:void 0,filter:a.snakeCaseId(t),extended:1,group_id:(0,n.getOwnerGroupId)(c)};break}case"folders":{const{id:t,filter:r}=s;l=o.getLockId(t,r);const a=e.organisers.folders.find((e=>e.id===t));if(!a)throw new Error("Не найдена папка");if(e.locks.getConversations[l]||o.isLoaded(a,r)&&!a[r].hasMore)return[];d={start_message_id:o.isLoaded(a,r)?a[r].boundaryMinorId:void 0,folder_id:a.id,filter:r,extended:1,group_id:(0,n.getOwnerGroupId)(c)};break}default:(0,i.exhaustivenessCheck)(s)}return e.locks.getConversations[l]=!0,[async function({api:e}){try{if(!d)throw new Error("Нет параметров запроса");const s=r.CONVOS_PER_PAGE,n=await e.fetch("messages.getConversations",{...d,count:s},{retries:1/0});return{...t,type:"MoreConvosNeeded_RequestCompleted",hasFailed:!1,requestedCount:s,hasMore:n.items.length>=s,response:n}}catch(e){return{...t,type:"MoreConvosNeeded_RequestCompleted",hasMore:!1,hasFailed:!0}}}]}case"MoreConvosNeeded_RequestCompleted":{const{hasFailed:r,organiser:c,hasMore:d}=t;let l="";switch(c.kind){case"filters":l=a.getLockId(c.filter);break;case"folders":l=o.getLockId(c.id,c.filter);break;default:(0,i.exhaustivenessCheck)(c)}if(e.locks.getConversations[l]=!1,r)return[];const{response:u}=t;if(u){const t=(0,n.insertConvos)(e,u.items,s,{dangerouslyMerge:!0});switch((0,n.insertPeers)(e,{apiUsers:u.profiles||[],apiGroups:u.groups||[],apiContacts:u.contacts||[]}),c.kind){case"filters":a.push(e.organisers.filters,c.filter,t,d);break;case"folders":if(!e.organisers.folders.find((e=>e.id===c.id)))return[];o.push(e.organisers.folders,c.id,c.filter,t,d,s);break;default:(0,i.exhaustivenessCheck)(c)}}return[]}default:(0,i.exhaustivenessCheck)(t)}}},82941:(e,t,s)=>{"use strict";s.d(t,{handler:()=>o});var n=s(795947),r=s(33200),a=s(345543),i=s(503048);const o=(e,t,s)=>{if(!s.vkm_edu_precreated_convos)return[];switch(t.type){case"MorePrecreatedConvosNeeded":{if(e.locks.getPrecreatedConversations)return[];e.locks.getPrecreatedConversations=!0;const s=[...e.precreatedConvos.peerIds],n=s[s.length-1];return[async function({api:e}){try{const s=await e.fetch("messages.getPrecreatedConversations",{start_after:n,count:r.CONVOS_PER_PAGE,extended:1});return{...t,type:"MorePrecreatedConvosNeeded_RequestCompleted",hasFailed:!1,hasMore:!0,response:s}}catch(e){return{...t,type:"MorePrecreatedConvosNeeded_RequestCompleted",hasMore:!1,hasFailed:!0}}}]}case"MorePrecreatedConvosNeeded_RequestCompleted":{const{hasFailed:s}=t;if(e.locks.getPrecreatedConversations=!1,s||!t.response)return[];const{profiles:a,items:o,contacts:c}=t.response;return(0,n.insertPeers)(e,{apiUsers:a??[],apiGroups:[],apiContacts:c??[]}),o.forEach((t=>{const s=i.resolvePrecreatedConvoId(t);e.precreatedConvos.peerIds.add(s)})),e.precreatedConvos.hasMore=o.length>=r.CONVOS_PER_PAGE,[]}default:(0,a.exhaustivenessCheck)(t)}}},421660:(e,t,s)=>{"use strict";s.d(t,{handler:()=>d});var n=s(548007),r=s(377836),a=s(95233),i=s(769126),o=s(907557),c=s(345543);const d=(e,t)=>{switch(t.type){case"PollChannelPosts":{const{channelId:s,fromCmid:n,toCmid:r}=t,i=e.channels.get(s);if(!i||"Channel"!==i.kind)return[];const o=r??a.lastCmid(i.history);if(!o)return[];const c=a.around(i.history,n);if(void 0===c)return[];const d=c.nodes.reduce(((e,t)=>{const s=a.nodeCmid(t);return void 0!==s&&s>=n&&s<=o&&e.push(s),e}),[]).slice(-200);return[async function({api:e}){try{const t=await e.fetch("channels.getChannelMessagesCounters",{channel_id:s,cmids:d.join(",")});return{type:"PollChannelPosts_RequestSucceed",channelId:s,response:t}}catch(e){console.error(e)}return{type:"Noop"}}]}case"PollChannelPosts_RequestSucceed":{const{channelId:s,response:a}=t,i=e.channels.get(s);return i&&"Channel"===i.kind?(a.items?.forEach((e=>{const t=n.findPostByCmid(i,r.resolveCmid(e.message_id));t&&"Node"===t.kind&&l(t.item,e)})),[]):[]}default:(0,c.exhaustivenessCheck)(t)}},l=(e,t)=>{t.comments&&(e.comments={...e.comments,canPost:!!(t.comments.can_post??e.comments.canPost),canView:!!(t.comments.can_view??e.comments.canView),count:t.comments.count??e.comments.count}),t.reactions?(e.likes={...e.likes,count:t.reactions.count,reactionId:void 0!==t.reactions.user_reaction?i.resolveId(t.reactions.user_reaction):void 0},e.reactionId=void 0!==t.reactions.user_reaction?o.resolveId(t.reactions.user_reaction):void 0,e.reactions=t.reactions.items.reduce(((e,t)=>{const s=o.resolveId(t.id);return e.set(s,{reactionId:s,count:t.count}),e}),new Map)):(e.likes.count=0,e.likes.reactionId=void 0,e.reactionId=void 0,e.reactions=new Map),t.reposts&&(e.reposts={count:t.reposts.count,isReposted:!!(t.reposts.user_reposted??e.reposts.isReposted)}),e.views=t.views?.count??e.views}},857758:(e,t,s)=>{"use strict";s.d(t,{handler:()=>d});var n=s(345543),r=s(429920),a=s(503048),i=s(95233),o=s(795947),c=s(668214);const d=(e,t,s)=>{if(!s.vkm_reactions)return[];switch(t.type){case"PollConvoReactions":{const{peerId:s,fromCmid:n,toCmid:r}=t,a=e.convos.get(s);if(!a)return[];const c=i.around(a.history,n);if(void 0===c)return[];const d=c.nodes.reduce(((e,t)=>{const s="Node"===t.kind?t.item.cmid:void 0;return void 0!==s&&s>=n&&s<=r&&e.push(s),e}),[]).slice(-100),l=e.ownerId;return[async function({api:e}){try{const t=await e.fetch("messages.getMessagesReactions",{peer_id:s,cmids:d.join(","),extended:1,group_id:(0,o.getOwnerGroupId)(l)});return{type:"PollConvoReactions_RequestSucceed",peerId:s,cmids:d,apiResponse:t}}catch{}return{type:"Noop"}}]}case"PollConvoReactions_RequestSucceed":{const{peerId:s,apiResponse:n,cmids:i}=t;(0,o.insertPeers)(e,{apiUsers:n.profiles||[],apiGroups:n.groups||[],apiContacts:n.contacts||[]});const d=e.convos.get(s);if(!d)return[];const l=new Set(n.items.map((e=>r.resolveCmid(e.cmid))));let u=!1;i.filter((e=>!l.has(e))).forEach((e=>{const t=a.findMessageByCmid(d,r.resolveCmid(e));"Normal"===t?.kind&&0!==t.reactions.size&&r.setReactions(t,[])}));for(const{cmid:t,counters:s}of n.items){const n=a.findMessageByCmid(d,r.resolveCmid(t));if("Normal"!==n?.kind)continue;const i=(0,c.fromApiMessageReactions)(s);r.setReactions(n,Array.from(i.values())),u||(u=Array.from(i.keys()).some((t=>!e.messageReactions.has(t))))}return u?[async function(){return{type:"InvalidateMessageReactions",force:!0}}]:[]}default:(0,n.exhaustivenessCheck)(t)}}},554482:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(207739),r=s(122519);const a=(e,t)=>{const{next:s}=t;if("Reconnecting"===s.kind)return[async function({queue:e}){try{return{type:"QueueBatchReceived",next:await e.poll()}}catch{return{type:"Noop"}}}];if("Disconnected"===s.kind){if("manual"===s.reason)return[];const t=e.viewer.id;return[async function({queue:e,api:s}){const r=await s.fetch("queue.subscribe",{queue_ids:`onlfriends_${t},accountcounters_${t}`},{retries:1/0});e.connect({user_id:n.toRealId(t),...r});try{return{type:"QueueBatchReceived",next:await e.poll()}}catch{return{type:"Noop"}}}]}for(const t of s.events)switch(t.entity_type){case"online":const s=n.resolveId(t.data.user_id);if(!n.isUserPeerId(s))break;e.lastSeens.set(s,{isOnline:!!t.data.online,at:1e3*t.data.last_seen,platform:(0,r.convertPlatform)(t.data.platform,t.data.app_id)});break;case"accountcounters":if("calls"===t.data.type)e.activeCallsCount=t.data.count;else{t.data.type}break;default:}return[async function({queue:e}){try{return{type:"QueueBatchReceived",next:await e.poll()}}catch{return{type:"Noop"}}}]}},764162:(e,t,s)=>{"use strict";s.d(t,{handler:()=>i});var n=s(345543),r=s(81163),a=s(795947);const i=(e,t)=>{switch(t.type){case"ResetUpdatesCounter":{const t=e.ownerId;return[async function({api:e}){try{return{type:"ResetUpdatesCounter_RequestCompleted",hasFailed:!await e.fetch("messages.resetUpdatesCounter",{group_id:(0,a.getOwnerGroupId)(t)})}}catch(e){return{type:"ResetUpdatesCounter_RequestCompleted",hasFailed:!0}}}]}case"ResetUpdatesCounter_RequestCompleted":{const{hasFailed:s}=t;return s?[]:(r.updateCounters(e.organisers.filters,{headerNotMutedUnread:0}),[async function({notification:e}){return e.setIdleCounter(0),{type:"Noop"}}])}default:(0,n.exhaustivenessCheck)(t)}}},198359:(e,t,s)=>{"use strict";s.d(t,{handler:()=>r});var n=s(345543);const r=(e,t)=>{const{type:s}=t;switch(s){case"SettingExperimentalUpdated":return e.locks.settings.has("messageSelfMentionHighlighting")?[]:(e.locks.settings.add("messageSelfMentionHighlighting"),e.viewer.settings.messageSelfMentionHighlighting=t.messageMentionHighlighting,[async function(e){const{api:s}=e;return s.fetch("messages.setConfig",{config:JSON.stringify({message_self_mention_highlighting:t.messageMentionHighlighting})},{retries:3}).catch((()=>{})).then((()=>({type:"SettingExperimentalUpdated_RequestCompleted"})))}]);case"SettingExperimentalUpdated_RequestCompleted":return e.locks.settings.delete("messageSelfMentionHighlighting"),[];default:(0,n.exhaustivenessCheck)(s)}}},626931:(e,t,s)=>{"use strict";s.d(t,{handler:()=>r});var n=s(345543);const r=(e,t)=>{const{type:s}=t;switch(s){case"SettingThemeUpdated":return e.viewer.settings.theme===t.value||e.locks.settings.has("theme")?[]:(e.locks.settings.add("theme"),e.viewer.settings.theme=t.value,[async function(e){const{api:s}=e;return s.fetch("messages.setConfig",{config:JSON.stringify({theme:t.value})},{retries:3}).catch((()=>{})).then((()=>({type:"SettingThemeUpdated_RequestCompleted"})))}]);case"SettingThemeUpdated_RequestCompleted":return e.locks.settings.delete("theme"),[];default:(0,n.exhaustivenessCheck)(s)}}},192697:(e,t,s)=>{"use strict";s.d(t,{handler:()=>r});var n=s(345543);const r=(e,t)=>{const{type:s}=t;switch(s){case"SettingsFromApiLoaded":return 0===Object.keys(t.value).length?[]:[async function(e){return e.api.fetch("messages.setConfig",{config:JSON.stringify(t.value)}).catch((()=>{})).then((()=>({type:"SettingsFromApiLoaded_RequestCompleted"})))}];case"SettingsFromApiLoaded_RequestCompleted":return[];default:(0,n.exhaustivenessCheck)(s)}}},868733:(e,t,s)=>{"use strict";s.d(t,{handler:()=>r});var n=s(345543);const r=(e,t)=>{switch(t.type){case"SettingsThemeStyleUpdated":{const{themeStyleId:s}=t,n=e.viewer.settings.themeStyleId;return n===s||e.locks.settings.has("themeStyleId")?[]:(e.locks.settings.add("themeStyleId"),e.viewer.settings.themeStyleId=s,[async function({storage:e}){try{return e.set("theme-style-id",s),{type:"SettingsThemeStyleUpdated_RequestCompleted"}}catch(e){return{type:"SettingsThemeStyleUpdated_RequestCompleted",previousThemeStyleId:n}}}])}case"SettingsThemeStyleUpdated_RequestCompleted":{const{prevThemeStyleId:s}=t;return e.locks.settings.delete("themeStyleId"),s&&(e.viewer.settings.themeStyleId=s),[]}default:(0,n.exhaustivenessCheck)(t)}}},300887:(e,t,s)=>{"use strict";s.d(t,{handler:()=>r});var n=s(159300);const r=(e,t)=>(t.stickers.forEach((t=>{const s=(0,n.fromApiSticker)(t);e.stickers.set(s.id,s)})),[])},175049:(e,t,s)=>{"use strict";s.d(t,{handler:()=>r});var n=s(345543);const r=(e,t)=>{const{type:s}=t;switch(s){case"UserChangedBrowserNotifications":return e.locks.settings.add("browserNotifications"),e.viewer.settings.browserNotifications=t.value,[async function(e){return e.storage.set("settings-browser-notifications-on",t.value),{type:"UserChangedBrowserNotifications_RequestCompleted"}}];case"UserChangedBrowserNotifications_RequestCompleted":return e.locks.settings.delete("browserNotifications"),[];default:(0,n.exhaustivenessCheck)(s)}}},851707:(e,t,s)=>{"use strict";s.d(t,{handler:()=>r});var n=s(345543);const r=(e,t)=>{const{type:s}=t;switch(s){case"UserChangedBubblesTheme":return e.locks.settings.has("bubblesTheme")?[]:(e.locks.settings.add("bubblesTheme"),e.viewer.settings.bubblesTheme=t.value,[async function(e){const{api:s}=e;return s.fetch("messages.setConfig",{config:JSON.stringify({bubble_theme:"enabled"===t.value?1:0})},{retries:3}).catch((()=>{})).then((()=>({type:"UserChangedBubblesTheme_RequestCompleted"})))}]);case"UserChangedBubblesTheme_RequestCompleted":return e.locks.settings.delete("bubblesTheme"),[];default:(0,n.exhaustivenessCheck)(s)}}},953542:(e,t,s)=>{"use strict";s.d(t,{handler:()=>d});var n=s(345543),r=s(548007),a=s(250122),i=s(803854);const o={archive:"archive",unarchive:"unarchive",join:"join",leave:"join",mute:"mute",unmute:"unmute",mark_read:"mark_read"},c={archive:"unarchive",unarchive:"archive",join:"leave",leave:"join",mute:"unmute",unmute:"mute"},d=(e,t,s)=>{const{type:o}=t;switch(o){case"UserChangedChannel":{const{channelId:s,userAction:i}=t,o=l(t.userAction,s);if(e.locks.channelActions.has(o))return[];e.locks.channelActions.add(o);const c=e.channels.get(s);if(!c)return[];if("ChannelRestricted"===c.kind)return[];let d;switch(i){case"archive":r.setArchived(c,!0),a.refreshChannels(e.organisers,c),d=e=>e.fetch("channels.archive",{channel_ids:String(s)}).then((e=>Boolean(e)));break;case"unarchive":r.setArchived(c,!1),a.refreshChannels(e.organisers,c),d=e=>e.fetch("channels.unarchive",{channel_ids:String(s),extended:1}).then((e=>Boolean(e)));break;case"join":r.setMembership(c,!0),a.refreshChannels(e.organisers,c),d=e=>e.fetch("channels.join",{channel_id:s,extended:1}).then((e=>Boolean(e)));break;case"leave":r.setMembership(c,!1),a.refreshChannels(e.organisers,c),d=e=>e.fetch("channels.leave",{channel_id:s});break;case"mute":r.setMuted(c,!0),d=e=>e.fetch("channels.setNotificationMode",{channel_id:s,mode:"disabled"}).then((e=>Boolean(e)));break;case"unmute":r.setMuted(c,!1),d=e=>e.fetch("channels.setNotificationMode",{channel_id:s,mode:"enabled"}).then((e=>Boolean(e)));break;case"mark_read":{const e=r.lastPost({channel:c,withPending:!1});if(e){const t=e.cmid;c.inReadCmid=t,d=e=>e.fetch("channels.markAsRead",{last_read_cmid:t,channel_id:s})}break}default:(0,n.exhaustivenessCheck)(i)}return[async function({api:e}){try{let t=!1;return d&&(t=!await d(e)),{type:"UserChangedChannel_RequestCompleted",channelId:s,hasFailed:t,userAction:i}}catch(e){return{type:"UserChangedChannel_RequestCompleted",channelId:s,hasFailed:!0,userAction:i}}}]}case"UserChangedChannel_RequestCompleted":{const{channelId:n,userAction:r,hasFailed:a}=t,i=l(r,n);e.locks.channelActions.delete(i);const o=c[r];return a&&o&&(d(e,{type:"UserChangedChannel",userAction:o,channelId:n},s),e.locks.channelActions.delete(i)),[]}case"UserSetChannelPhoto":{const{channelId:s,photo:n}=t,a=e.channels.get(s);return a&&"Channel"===a.kind?(r.setPhotos(a,{photo50:i.preview(n,50,50,!0)?.url,photo100:i.preview(n,100,100,!0)?.url}),[]):[]}case"UserUpdateChannelInfo":{const{channelId:s,name:n,description:r}=t,a=e.channels.get(s);return a&&"Channel"===a.kind?(n&&(a.name=n),void 0!==r&&(a.description=r),[]):[]}default:(0,n.exhaustivenessCheck)(o)}},l=(e,t)=>`${o[e]}-${t.toString()}`},886210:(e,t,s)=>{"use strict";s.d(t,{handler:()=>c});var n=s(236634),r=s(377836),a=s(345543),i=s(453934),o=s(348330);const c=(e,t)=>{const{channelId:s}=t,c=e.channelComposerDrafts[s]??n.empty();let d=n.empty();switch(t.type){case"UserChangedChannelComposerDraft":switch(t.kind){case"text":{const{text:e,visibility:s,donutDelay:n,topic:r,date:a,sendOptions:i,ads:o}=t;d={...c,text:e??c.text,visibility:s||c.visibility,donutDelay:n||c.donutDelay,topic:r||c.topic,date:a,sendOptions:i||c.sendOptions,ads:o||c.ads};break}case"addAttaches":case"removeAttach":case"removeVoice":case"startUploading":case"removeUploads":case"rearrangeAttaches":const e=(0,o.applyAttachmentActions)(c,t);d={...c,...e};break;case"editing":{const{editing:e}=t,s=[],a=["mute_notifications"];e.comments.canPost&&e.comments.canView||s.push("close_comments"),e.signerId&&s.push("signed"),d={editing:e,text:r.toRawText(e),attaches:e.attaches,uploadsTrackIds:c.uploadsTrackIds,visibility:r.isDonut(e)?"donut":"all",donutDelay:e.donut?.duration||-1,topic:n.getPostThemeKeyFromId(e.topicId),sendOptions:{selected:s,disabled:a},ads:n.empty().ads};break}case"forward":{const{forward:e}=t;d={...e&&c.editing?n.empty():c,forward:e,attaches:{},ads:n.empty().ads,uploadsTrackIds:new Set};break}default:(0,a.exhaustivenessCheck)(t)}break;case"UserClearedChannelComposerDraft":break;default:(0,a.exhaustivenessCheck)(t)}!d.text&&0===Object.keys(d.attaches).length&&0===d.uploadsTrackIds.size&&"all"===d.visibility&&"no_theme"===d.topic&&void 0===d.date&&-1===d.donutDelay&&0===d.sendOptions.selected.length&&0===d.sendOptions.disabled.length&&void 0===d.forward&&""===d.ads.erId&&""===d.ads.predId&&!1===d.ads.isAd?delete e.channelComposerDrafts[s]:e.channelComposerDrafts[s]=d;const l=(0,i.current)(e.channelComposerDrafts);return[async({storage:e})=>(e.set("channels-drafts",l),{type:"Noop"})]}},255618:(e,t,s)=>{"use strict";s.d(t,{handler:()=>c});var n=s(345543),r=s(548007),a=s(377836),i=s(95233);const o={delete:"delete",restore:"restore",report:"report",enable_comments:"enable_comments",disable_comments:"enable_comments"},c=(e,t,s)=>{const{type:o}=t;switch(o){case"UserChangedChannelPost":{const{channelId:s,cmid:o,userAction:c}=t,l=d(t.userAction.kind,s,o);if(e.locks.channelPostActions.has(l))return[];e.locks.channelPostActions.add(l);const u=e.channels.get(s);if(!u)return[];if("ChannelRestricted"===u.kind)return[];const h=i.findNodeByCmid(u.history,o);if("NotLoaded"===h.status)return[];let p;switch(c.kind){case"delete":if("Deleted"===h.status)break;r.deletePost(u,o,{isRestorable:!0,isSpam:!0}),p=e=>e.fetch("wall.delete",{owner_id:s,post_id:o}).then((e=>Boolean(e)));break;case"restore":if("Deleted"!==h.status)break;r.restorePost(u,o),p=e=>e.fetch("wall.restore",{owner_id:s,post_id:o}).then((e=>Boolean(e)));break;case"report":if("Deleted"===h.status)break;r.deletePost(u,o,{isRestorable:!0,isSpam:!0}),p=e=>e.fetch("wall.reportPost",{owner_id:s,post_id:o,reason:c.reason}).then((e=>Boolean(e)));break;case"enable_comments":case"disable_comments":if("Deleted"===h.status)break;a.changeCommentsCanPost(h.node.item,"enable_comments"===c.kind),p=e=>e.fetch("enable_comments"===c.kind?"wall.openComments":"wall.closeComments",{owner_id:s,post_id:o}).then((e=>Boolean(e)));break;default:(0,n.exhaustivenessCheck)(c)}return[async function({api:e}){try{let t=!1;return p&&(t=!await p(e)),{type:"UserChangedChannelPost_RequestCompleted",channelId:s,cmid:o,hasFailed:t,userAction:c}}catch(e){return{type:"UserChangedChannelPost_RequestCompleted",channelId:s,cmid:o,hasFailed:!0,userAction:c}}}]}case"UserChangedChannelPost_RequestCompleted":{const{channelId:r,cmid:a,userAction:i,hasFailed:o}=t,l=d(i.kind,r,a);if(e.locks.channelPostActions.delete(l),o){let t;switch(i.kind){case"delete":case"report":t={kind:"restore"};break;case"restore":t={kind:"delete"};break;case"enable_comments":case"disable_comments":t={kind:"enable_comments"===i.kind?"disable_comments":"enable_comments"};break;default:(0,n.exhaustivenessCheck)(i)}t&&c(e,{type:"UserChangedChannelPost",userAction:t,channelId:r,cmid:a},s),e.locks.channelPostActions.delete(l)}return[]}default:(0,n.exhaustivenessCheck)(o)}},d=(e,t,s)=>`${o[e]}-${t.toString()}-${s}`},417141:(e,t,s)=>{"use strict";s.d(t,{handler:()=>r});var n=s(345543);const r=(e,t)=>{const{type:s}=t;if("UserChangedCollapsedVersion"===s)return e.channelsConfig.recommendations.lastCollapsedVersion=t.version,[async function({api:e}){return await e.fetch("channels.setConfig",{last_collapsed_recommendations_version:t.version}),{type:"Noop"}}];(0,n.exhaustivenessCheck)(s)}},696163:(e,t,s)=>{"use strict";s.d(t,{handler:()=>c});var n=s(345543),r=s(207739),a=s(503048),i=s(803854),o=s(795947);const c=(e,t)=>{const{type:s}=t;switch(s){case"UserChangedChatTitle":{const{peerId:s,title:n}=t,a=r.toRealId(s),i=e.peers.get(s),c=e.ownerId;if(!i||"Chat"!==i.kind)return[];const d=i.title;return r.updateChatInfo(i,{title:n}),[async function({api:e}){try{const t=await e.fetch("messages.editChat",{chat_id:a,title:n,group_id:(0,o.getOwnerGroupId)(c)},{retries:1});return{type:"UserChangedChatTitle_RequestCompleted",hasFailed:1!==t,peerId:s,title:1!==t?d:n}}catch(e){return{type:"UserChangedChatTitle_RequestCompleted",hasFailed:!0,peerId:s,title:d}}}]}case"UserChangedChatTitle_RequestCompleted":{const{peerId:s,title:n,hasFailed:a}=t,i=e.peers.get(s);return i&&"Chat"===i.kind&&a?(r.updateChatInfo(i,{title:n}),[]):[]}case"UserChangedChatDescription":{const{peerId:s,description:n}=t,i=r.toRealId(s),c=e.convos.get(s),d=e.ownerId;if(!c||"ChatConvo"!==c.kind&&"GroupConvo"!==c.kind)return[];const l=c.description;return a.setDescription(c,n),[async function({api:e}){try{const t=await e.fetch("messages.editChat",{chat_id:i,description:n,group_id:(0,o.getOwnerGroupId)(d)},{retries:1});return{type:"UserChangedChatDescription_RequestCompleted",hasFailed:1!==t,peerId:s,description:1!==t?l:n}}catch(e){return{type:"UserChangedChatDescription_RequestCompleted",hasFailed:!0,peerId:s,description:l}}}]}case"UserChangedChatDescription_RequestCompleted":{const{peerId:s,description:n,hasFailed:r}=t,i=e.convos.get(s);return!i||"ChatConvo"!==i.kind&&"GroupConvo"!==i.kind?[]:r?(a.setDescription(i,n),[]):[]}case"UserSetChatPhoto":{const{peerId:s,photo:n}=t,a=e.peers.get(s);return a&&"Chat"===a.kind?(r.updateChatInfo(a,{photo50:i.preview(n,50,50)?.url,photo100:i.preview(n,100,100)?.url,photo200:i.preview(n,200,200)?.url}),[]):[]}case"UserRemovedChatPhoto":{const{peerId:s}=t,n=e.ownerId,a=r.toRealId(s),i=e.peers.get(s);return i&&"Chat"===i.kind?(r.updateChatInfo(i,{photo50:void 0,photo100:void 0,photo200:void 0}),[async function({api:e}){try{return await e.fetch("messages.deleteChatPhoto",{chat_id:a,group_id:(0,o.getOwnerGroupId)(n)},{retries:1}),{type:"UserRemovedChatPhoto_RequestCompleted",hasFailed:!1,peerId:s}}catch(e){return{type:"UserRemovedChatPhoto_RequestCompleted",hasFailed:!0,peerId:s}}}]):[]}case"UserRemovedChatPhoto_RequestCompleted":return[];case"UserChangedChatSettings":{const{peerId:s,isService:n,permissions:a}=t,i=r.toRealId(s),c=e.ownerId;return[async function({api:e}){try{return{type:"UserChangedChatSettings_RequestCompleted",hasFailed:1!==await e.fetch("messages.editChat",{chat_id:i,is_service:n?1:0,permissions:JSON.stringify(a),group_id:(0,o.getOwnerGroupId)(c)},{retries:1}),permissions:a,peerId:s,isService:n}}catch(e){return{type:"UserChangedChatSettings_RequestCompleted",hasFailed:!0,permissions:a,peerId:s,isService:n}}}]}case"UserChangedChatSettings_RequestCompleted":{const{peerId:s,isService:n,permissions:r,hasFailed:i}=t;if(i)return[];const o=e.convos.get(s);return o&&"ChatConvo"===o.kind?(a.setChatPermissions(o,r,n),[]):[]}default:(0,n.exhaustivenessCheck)(s)}}},474642:(e,t,s)=>{"use strict";s.d(t,{handler:()=>o});var n=s(345543),r=s(207739),a=s(886330),i=s(795947);const o=(e,t)=>{switch(t.type){case"UserChangedChatMember":{const{peerId:s,memberId:a,userAction:o}=t;if(!e.convos.get(s))return[];const c=function(e,t){const{userAction:s,peerId:a,memberId:o}=t;switch(s){case"promote":return({api:e})=>e.fetch("messages.setMemberRole",{member_id:o,peer_id:a,role:"admin"});case"demote":return({api:e})=>e.fetch("messages.setMemberRole",{member_id:o,peer_id:a,role:"member"});case"cancel_invitation":case"remove":return({api:t})=>t.fetch("messages.removeChatUser",{chat_id:r.toRealId(a),member_id:o,group_id:(0,i.getOwnerGroupId)(e)});default:return(0,n.exhaustivenessCheck)(s)}}(e.ownerId,t);return[async function(e){try{return{type:"UserChangedChatMember_RequestCompleted",hasFailed:1!==await c(e),peerId:s,memberId:a,userAction:o}}catch(e){return{type:"UserChangedChatMember_RequestCompleted",hasFailed:!0,peerId:s,memberId:a,userAction:o}}}]}case"UserRemoveIncognitoMember":{const{peerId:s,userAction:n,incognitoId:a}=t,o=e.convos.get(s),c=e.ownerId;return o?[async function({api:e}){try{return{type:"UserRemoveIncognitoMember_RequestCompleted",hasFailed:1!==await e.fetch("messages.removeChatUser",{chat_id:r.toRealId(s),incognito_id:a,group_id:(0,i.getOwnerGroupId)(c)}),peerId:s,incognitoId:a,userAction:n}}catch(e){return{type:"UserRemoveIncognitoMember_RequestCompleted",hasFailed:!0,peerId:s,incognitoId:a,userAction:n}}}]:[]}case"UserChangedChatMember_RequestCompleted":{const{memberId:s,peerId:n,userAction:i,hasFailed:o}=t,c=e.convos.get(n);return o||"ChatConvo"!==c?.kind?[]:("cancel_invitation"===i&&a.removeMember(c.members,s),r.isContactPeerId(s)||("promote"===i&&a.setAdmin(c.members,s),"demote"===i&&a.unsetAdmin(c.members,s),"remove"===i&&a.removeMember(c.members,s)),[])}case"UserRemoveIncognitoMember_RequestCompleted":{const{incognitoId:s,peerId:n,hasFailed:i}=t,o=e.convos.get(n);if(i||"ChatConvo"!==o?.kind)return[];const c=a.getIncognitoMember(o.members,s);a.removeIncognitoMember(o.members,s);const d=r.resolveId(c?.memberId);return d&&a.removeMember(o.members,d),[]}default:return(0,n.exhaustivenessCheck)(t)}}},244550:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(345543),r=s(503048);const a=(e,t)=>{switch(t.type){case"UserChangedChatStickersDisplay":{const{peerId:s,showChatStickers:n}=t;if(e.locks.setChatStickersDisplay.has(s))return[];e.locks.setChatStickersDisplay.add(s);const a=e.convos.get(s);return a&&"ChatConvo"===a.kind&&a.stickersParams&&r.setStickersParams(a,{...a.stickersParams,isKeyboardHidden:!n}),[async function({api:e}){try{if(1!==await e.fetch(n?"stickers.showUGCKeyboard":"stickers.hideUGCKeyboard",{owner_id:s}))throw Error("Запрос выполнен с ошибкой");return{type:"UserChangedChatStickersDisplay_RequestCompleted",peerId:s,hasFailed:!1,showChatStickers:n}}catch(e){return{type:"UserChangedChatStickersDisplay_RequestCompleted",peerId:s,hasFailed:!0,showChatStickers:!1}}}]}case"UserChangedChatStickersDisplay_RequestCompleted":if(e.locks.setChatStickersDisplay.delete(t.peerId),t.hasFailed){const s=e.convos.get(t.peerId);s&&"ChatConvo"===s.kind&&s.stickersParams&&r.setStickersParams(s,{...s.stickersParams,isKeyboardHidden:t.showChatStickers})}return[];default:(0,n.exhaustivenessCheck)(t)}}},406450:(e,t,s)=>{"use strict";s.d(t,{handler:()=>c});var n=s(345543),r=s(377836),a=s(382543),i=s(95233);const o={delete:"delete",restore:"restore",report:"report"},c=(e,t,s)=>{const{type:o,channelId:l,postCmid:u,commentCmid:h,userAction:p}=t,m=d(p.kind,l,u,h),g=e.channels.get(l);if("ChannelRestricted"===g?.kind)return[];const f=g&&i.findNodeByCmid(g.history,u).node,C="Node"===f?.kind&&f.item,_=C&&r.findCommentByCmid(C,h);if(!_)return[];switch(o){case"UserChangedComment":{if(e.locks.commentActions.has(m))return[];let t;switch(e.locks.commentActions.add(m),p.kind){case"delete":{if("Normal"!==_.kind)break;const e=a.markDeleted(_);r.replaceComment(C,e),t=t=>t.fetch("wall.deleteComment",{owner_id:l,comment_id:e.cmid}).then((e=>Boolean(e)));break}case"restore":{if("MarkedDeleted"!==_.kind)break;const e=a.restoreDeleted(_);r.replaceComment(C,e),t=t=>t.fetch("wall.restoreComment",{owner_id:l,comment_id:e.cmid}).then((e=>Boolean(e)));break}case"report":{if("Normal"!==_.kind)break;r.deleteComment(C,_.cmid);const e=_.cmid;t=t=>t.fetch("wall.reportComment",{owner_id:l,comment_id:e,reason:p.reason}).then((e=>Boolean(e)));break}default:(0,n.exhaustivenessCheck)(p)}return[async function({api:e}){try{let s=!1;if(t){s=!await t(e)}return{type:"UserChangedComment_RequestCompleted",channelId:l,postCmid:u,commentCmid:h,hasFailed:s,userAction:p}}catch(e){return{type:"UserChangedComment_RequestCompleted",channelId:l,postCmid:u,commentCmid:h,hasFailed:!0,userAction:p}}}]}case"UserChangedComment_RequestCompleted":{const{hasFailed:r}=t;if(e.locks.commentActions.delete(m),r){let t;switch(p.kind){case"delete":case"report":t={kind:"restore"};break;case"restore":t={kind:"delete"};break;default:(0,n.exhaustivenessCheck)(p)}t&&c(e,{type:"UserChangedComment",userAction:t,channelId:l,postCmid:u,commentCmid:h},s),e.locks.commentActions.delete(m)}return[]}default:(0,n.exhaustivenessCheck)(t)}},d=(e,t,s,n)=>`${o[e]}-${t}-${s}-${n}`},144539:(e,t,s)=>{"use strict";s.d(t,{handler:()=>c});var n=s(300749),r=s(382543),a=s(345543),i=s(453934),o=s(348330);const c=(e,t)=>{const{channelId:s,postCmid:c}=t,d=`${s}-${c}`,l=e.commentsComposerDrafts[d]??n.empty();let u=n.empty();switch(t.type){case"UserChangedCommentsComposerDraft":switch(t.kind){case"text":{const{text:e}=t;u={...l,text:e??l.text};break}case"editing":{const{editing:e}=t;u={editing:e,text:r.toRawText(e),attaches:e.attaches,uploadsTrackIds:l.uploadsTrackIds,reply:void 0};break}case"reply":{const{reply:e}=t;u={...e&&l.editing?n.empty():l,reply:e};break}case"addAttaches":case"removeAttach":case"removeVoice":case"startUploading":case"removeUploads":case"rearrangeAttaches":const e=(0,o.applyAttachmentActions)(l,t);u={...l,...e};break;default:(0,a.exhaustivenessCheck)(t)}break;case"UserClearedCommentsComposerDraft":break;default:(0,a.exhaustivenessCheck)(t)}!u.text&&!u.reply&&!u.editing&&0===u.uploadsTrackIds.size&&0===Object.keys(u.attaches).length?delete e.commentsComposerDrafts[d]:e.commentsComposerDrafts[d]=u;const h=(0,i.current)(e.commentsComposerDrafts);return[async({storage:e})=>(e.set("comments-drafts",h),{type:"Noop"})]}},348330:(e,t,s)=>{"use strict";s.d(t,{applyAttachmentActions:()=>p,handler:()=>h});var n=s(841),r=s(429920),a=s(803854),i=s(345543),o=s(453934),c=s(795947),d=s(500955),l=s(885540),u=s(429590);const h=(e,t)=>{const{peerId:s}=t,a=void 0!==s?e.composerDrafts[s]??[]:[],h=a[a.length-1]??(0,o.castDraft)(n.empty());let C=(0,o.castDraft)(a.slice(0,-1));switch(t.type){case"UserChangedComposerDraft":switch(t.kind){case"text":{const{text:e}=t;C.push({...h,text:e??h.text});break}case"addAttaches":case"removeAttach":case"removeVoice":case"startUploading":case"removeUploads":case"rearrangeAttaches":const e=p(h,t);C.push({...h,...e});break;case"editing":{const{editing:e}=t;C.push(h,{editing:e,text:r.toRawText(e),attaches:e.attaches,uploadsTrackIds:h.uploadsTrackIds,forward:e.forwardedMessages&&{kind:"message",items:e.forwardedMessages},reply:e.replyMessage});break}case"forward":{const{forward:e,isForwardAuthorHidden:s}=t;C.push({...e&&h.editing?n.empty():h,reply:void 0,forward:e,isForwardAuthorHidden:s??n.DEFAULT_FORWARD_AUTHOR_HIDDEN});break}case"reply":{const{reply:e}=t;C.push({...e&&h.editing?n.empty():h,forward:void 0,reply:e});break}default:(0,i.exhaustivenessCheck)(t)}break;case"UserClearedComposerDraft":break;case"ComposerDraftsUpdateNeeded":{const{itemsToDelete:s,itemsToReplace:n,foreignKind:r}=t;C.push(h),C=C.reduce(((e,t)=>{const{editing:a,reply:i}=t;if("message"===r){if(void 0!==a&&m(s,a))return e;if(void 0===a&&void 0!==i)if(m(s,i))t.reply=void 0;else{const e=m(n,i);void 0!==e&&(t.reply=e)}}return e.push(t),e}),[]);const a=Object.values(e.composerDrafts).reduce(((e,t)=>(t.forEach((t=>e.push(t))),e)),[h]);a.forEach((e=>{const{forward:t,editing:a}=e;if(void 0===a&&void 0!==t){if("message"===r&&"message"===t.kind){const r=(0,i.toNonEmpty)([...t.items].reduce(((e,t)=>{const r=m(n,t);return void 0!==r?(e.push(r),e):(m(s,t)||e.push(t),e)}),[]));e.forward=null!==r?{kind:"message",items:r}:void 0}if("post"===r&&"post"===t.kind){const r=(0,i.toNonEmpty)([...t.items].reduce(((e,t)=>{const r=g(n,t);return void 0!==r?(e.push(r),e):(g(s,t)||e.push(t),e)}),[]));e.forward=null!==r?{kind:"post",items:r}:void 0}if("comment"===t.kind&&"comment"===r){const r=(0,i.toNonEmpty)([...t.items].reduce(((e,t)=>{const r=f(n,t);return void 0!==r?(e.push(r),e):(f(s,t)||e.push(t),e)}),[]));e.forward=null!==r?{kind:"comment",items:r}:void 0}}}));break}case"ActualizeComposerDraft":{const t=e.ownerId;return C.push(h),C.map((e=>{const n=(0,o.isDraft)(e)?(0,o.current)(e):e;return async({api:e})=>{const{reply:r,forward:a,editing:o}=n,d=[...o?[o]:[],...r?[r]:[],..."message"===a?.kind?a.items:[]].reduce(((e,t)=>("Foreign"!==t.kind&&"ForeignExpired"!==t.kind&&e.push(t),e)),[]);if(d.length>0&&d[0]){const s=d[0].peerId,n=d.reduce(((e,t)=>{if(t.peerId!==s){if(i.isDev)throw new Error("Перессылаемые сообщения не из одного чата");return e}return e.push(t.cmid),e}),[]);try{const r=await e.fetch("messages.getByConversationMessageId",{peer_id:s,conversation_message_ids:n.join(","),extended:1,group_id:(0,c.getOwnerGroupId)(t)});return{type:"ActualizeComposerDraft_RequestCompleted",peerId:s,foreignKind:"message",foreignItems:d,response:r}}catch{}}if("post"===a?.kind){const{channelId:t}=a.items[0],n=a.items.reduce(((e,s)=>{if(s.channelId!==t){if(i.isDev)throw new Error("Перессылаемые посты не из одного канала");return e}return e.push(s.cmid),e}),[]);try{const r=await e.fetch("channels.getMessagesById",{channel_id:t,cmids:n.join(","),extended:1});return{type:"ActualizeComposerDraft_RequestCompleted",peerId:s,foreignKind:"post",foreignItems:a.items,response:r}}catch{}}return{type:"Noop"}}}))}case"ActualizeComposerDraft_RequestCompleted":{const{response:n,foreignKind:r,foreignItems:a}=t;switch(r){case"message":{const{profiles:t,groups:r,contacts:i,items:o}=n;(0,c.insertPeers)(e,{apiUsers:t||[],apiGroups:r||[],apiContacts:i||[]});const l=o.reduce(((e,t)=>{if(t.deleted)return e;const s=(0,d.fromApiMessage)(t).message;return"Normal"===s.kind&&e.push(s),e}),[]),u=a.filter((e=>!m(l,e)));return u.length>0||l.length>0?[async()=>({type:"ComposerDraftsUpdateNeeded",foreignKind:"message",itemsToDelete:u,itemsToReplace:l,peerId:s})]:[]}case"post":{const{profiles:t,groups:r,items:i}=n;(0,c.insertPeers)(e,{apiUsers:t||[],apiGroups:r||[],apiContacts:[]});const o=i?.map((e=>(0,l.fromApiPost)(e).post))??[],d=a.filter((e=>!g(o,e)));return d.length>0||o.length>0?[async()=>({type:"ComposerDraftsUpdateNeeded",foreignKind:"post",itemsToDelete:d,itemsToReplace:o,peerId:s})]:[]}case"comment":{const t=n.reduce(((t,s)=>{const{profiles:n,groups:r,items:a}=s;return(0,c.insertPeers)(e,{apiUsers:n||[],apiGroups:r||[],apiContacts:[]}),a.forEach((e=>{const s=(0,u.fromApiComment)(e);"Normal"===s.kind&&t.push(s)})),t}),[]),r=a.filter((e=>!f(t,e)));return r.length>0||t.length>0?[async()=>({type:"ComposerDraftsUpdateNeeded",foreignKind:"comment",itemsToDelete:r,itemsToReplace:t,peerId:s})]:[]}default:return(0,i.exhaustivenessCheck)(r)}}default:(0,i.exhaustivenessCheck)(t)}void 0!==s&&(C=C.filter((e=>!(e=>!(e.text||e.forward||e.reply||e.editing||0!==Object.keys(e.attaches).length||0!==e.uploadsTrackIds.size))(e))),0===C.length?delete e.composerDrafts[s]:e.composerDrafts[s]=C);const _=(0,o.current)(e.composerDrafts);return[async({storage:e})=>(e.set("drafts",_),{type:"Noop"})]};function p(e,t){switch(t.kind){case"addAttaches":{const{attaches:s,trackIds:n}=t;let r=e.attaches;s&&(r=(0,o.produce)(r,(e=>{a.addAttach(e,s)})));let i=e.uploadsTrackIds;return n?.length&&(i=(0,o.produce)(i,(e=>{n.forEach((t=>{e.delete(t)}))}))),{attaches:r,uploadsTrackIds:i}}case"removeAttach":{const{attach:s,index:n}=t;let r=e.attaches;return s&&(r=(0,o.produce)(r,(e=>{a.removeAttach(e,s,n)}))),{attaches:r}}case"removeVoice":return{attaches:(0,o.produce)(e.attaches,(e=>{e.voice&&delete e.voice}))};case"startUploading":{const{trackIds:s}=t;return{uploadsTrackIds:new Set([...e.uploadsTrackIds,...s])}}case"removeUploads":{const{trackIds:s}=t;return{uploadsTrackIds:(0,o.produce)(e.uploadsTrackIds,(e=>{s.forEach((t=>{e.delete(t)}))}))}}case"rearrangeAttaches":{const{key:s,currentPosition:n,newPosition:r}=t;let i=e.attaches;return-1!==r&&r!==n&&(i=(0,o.produce)(i,(e=>{a.rearrangeAttaches(e,{currentPosition:n,newPosition:r},s)}))),{attaches:i}}default:(0,i.exhaustivenessCheck)(t)}}function m(e=[],t){return e.find((e=>t.peerId===e.peerId&&t.cmid===e.cmid))}function g(e=[],t){return e.find((e=>t.channelId===e.channelId&&t.cmid===e.cmid))}function f(e=[],t){return e.find((e=>t.channelId===e.channelId&&t.postCmid===e.postCmid&&t.cmid===e.cmid))}},230527:(e,t,s)=>{"use strict";s.d(t,{handler:()=>p});var n=s(503048),r=s(207739),a=s(250122),i=s(886330),o=s(429920),c=s(345543),d=s(453934),l=s(795947);const u={mute:"mute",unmute:"mute",mute_until:"mute_until",pin:"pin",unpin:"pin",mark_read:"mark_read",mark_unread:"mark_read",archive:"archive",unarchive:"archive",clear:"clear",leave:"leave",leave_and_clear:"leave_and_clear",show_pinned_message:"show_pinned_message",hide_pinned_message:"show_pinned_message",show_bot_keyboard:"show_bot_keyboard",hide_bot_keyboard:"hide_bot_keyboard",pin_message_for_all:"pin_message_for_all",unpin_message_for_all:"pin_message_for_all",ban:"ban",unban:"unban",return_to_chat:"return_to_chat",business_notify_enable:"business_notify_enable",business_notify_disable:"business_notify_enable",forbid_writing_all:"forbid_writing_all",allow_writing_all:"allow_writing_all",forbid_writing_all_until:"forbid_writing_all_until",finish_call:"finish_call",restrict_to_write:"restrict_to_write",allow_to_write:"allow_to_write"},h={pin:"unpin",unpin:"pin",mark_read:"mark_unread",mark_unread:"mark_read",archive:"unarchive",unarchive:"archive",show_pinned_message:"hide_pinned_message",hide_pinned_message:"show_pinned_message",show_bot_keyboard:"hide_bot_keyboard",hide_bot_keyboard:"show_bot_keyboard"},p=(e,t,s)=>{const{type:u}=t;switch(u){case"UserChangedConvo":{const{peerId:i,userAction:o}=t,{organisers:d}=e,u=e.viewer.id,h=m(t.userAction,i);if(e.locks.convoActions.has(h))return[];e.locks.convoActions.add(h);const p=e.convos.get(i),g=e.peers.get(i),f=e.ownerId;if(!p||!g)return[];let C;switch(o){case"pin":C=e=>e.fetch("messages.pinConversation",{peer_id:i});break;case"unpin":C=e=>e.fetch("messages.unpinConversation",{peer_id:i});break;case"mark_read":n.setPeerFlag(p,n.PEER_FLAGS.isMarkedUnread,!1),C=e=>e.fetch("messages.markAsRead",{peer_id:i,mark_conversation_as_read:1,group_id:(0,l.getOwnerGroupId)(f)});break;case"mark_unread":n.setPeerFlag(p,n.PEER_FLAGS.isMarkedUnread,!0),C=e=>e.fetch("messages.markAsUnreadConversation",{peer_id:i,group_id:0});break;case"archive":case"unarchive":{const t="archive"===o;n.setPeerFlag(p,n.PEER_FLAGS.isArchived,t),a.refresh(d,p,s),t&&(e.onboardingTriggers.userArchivedChat=!0),C=e=>e.fetch(t?"messages.archiveConversation":"messages.unarchiveConversation",{peer_id:i});break}case"hide_pinned_message":"ChatConvo"===p.kind&&p.pinnedMessage&&e.hiddenPinnedMessages.set(t.peerId,p.pinnedMessage.cmid);break;case"show_pinned_message":e.hiddenPinnedMessages.delete(t.peerId);break;case"hide_bot_keyboard":e.hiddenBotKeyboards.add(t.peerId);break;case"show_bot_keyboard":e.hiddenBotKeyboards.delete(t.peerId);break;case"clear":C=e=>e.fetch("messages.deleteConversation",{peer_id:i,group_id:(0,l.getOwnerGroupId)(f)}).then((({last_deleted_id:e})=>Boolean(e)));break;case"leave":case"leave_and_clear":{if("ChatConvo"!==p.kind)break;C=e=>e.fetch("messages.removeChatUser",{chat_id:r.toRealId(i),user_id:r.toRealId(u),group_id:(0,l.getOwnerGroupId)(f)});const t=e.peers.get(i);if(!t||"Chat"!==t.kind)break;n.clearChatDataOnLeave(p),r.clearChatDataOnLeave(t);break}case"ban":if(!("User"===g.kind&&"UserConvo"===p.kind||"Group"===g.kind&&"GroupConvo"===p.kind))break;r.updateIsPeerBlacklistedByMe(g,!0),"UserConvo"===p.kind&&n.restrictViewerToWrite(p,"peer_blacklisted_by_me"),C=r.isGroupPeerId(f)?e=>e.fetch("groups.ban",{owner_id:i,group_id:(0,l.getOwnerGroupId)(f)}):r.isGroupPeerId(i)?e=>e.fetch("messages.denyMessagesFromGroup",{group_id:r.toRealId(i)}):e=>e.fetch("account.ban",{owner_id:i});break;case"unban":if(!("User"===g.kind&&"UserConvo"===p.kind||"Group"===g.kind&&"GroupConvo"===p.kind))break;r.updateIsPeerBlacklistedByMe(g,!1),"UserConvo"===p.kind&&n.allowViewerToWrite(p),C=r.isGroupPeerId(f)?e=>e.fetch("groups.unban",{owner_id:i,group_id:(0,l.getOwnerGroupId)(f)}):r.isGroupPeerId(i)?e=>e.fetch("messages.allowMessagesFromGroup",{group_id:r.toRealId(i)}):e=>e.fetch("account.unban",{owner_id:i});break;case"return_to_chat":C=e=>e.fetch("messages.addChatUser",{chat_id:r.toRealId(i),user_id:r.toRealId(u)}).then((({result:e})=>Boolean(e)));break;case"finish_call":if(n.canFinishCall(p)){const e=p.activeCall.id;C=t=>t.fetch("messages.forceCallFinish",{call_id:e})}break;default:(0,c.exhaustivenessCheck)(o)}return[async function({api:e}){try{let t=!1;return C&&(t=!await C(e)),{type:"UserChangedConvo_RequestCompleted",hasFailed:t,userAction:o,peerId:i}}catch(e){return{type:"UserChangedConvo_RequestCompleted",hasFailed:!0,userAction:o,peerId:i}}}]}case"UserChangedConvo_RequestCompleted":{const{peerId:r,userAction:a,hasFailed:i}=t,d=m(a,r);e.locks.convoActions.delete(d);const l=h[a];if(i&&l)return p(e,{type:"UserChangedConvo",userAction:l,peerId:r},s),[];if(i)return[];switch(a){case"clear":case"pin":case"unpin":case"mark_read":case"mark_unread":case"unarchive":case"show_pinned_message":case"hide_pinned_message":case"show_bot_keyboard":case"hide_bot_keyboard":case"ban":case"unban":case"finish_call":return[];case"archive":{const t=e.convos.get(r);if(!t||"ChatConvo"!==t.kind||!t.unreadMentions.size)return[];const s=o.resolveCmid(Math.max(...t.unreadMentions));return[async function({storage:e}){const t=e.get("archive-mentions-map");return t&&s?(t[r]=s,e.set("archive-mentions-map",t),{type:"Noop"}):{type:"Noop"}}]}case"leave":{const t=e.convos.get(r);return"ChatConvo"===t?.kind&&n.setConvoState(t,"left"),[]}case"leave_and_clear":{const t=e.convos.get(r);return"ChatConvo"!==t?.kind?[]:(n.setConvoState(t,"left"),p(e,{type:"UserChangedConvo",userAction:"clear",peerId:r},s))}case"return_to_chat":{const t=e.convos.get(r);return"ChatConvo"===t?.kind&&n.setConvoState(t,"in"),[]}default:return(0,c.exhaustivenessCheck)(t)}}case"UserChangedMute":{const{peerId:s,timer:n,userAction:r}=t,a=m(t.userAction,s);if(e.locks.convoActions.has(a))return[];const i=e.convos.get(s);if(!i)return[];let o;switch(r){case"mute":i.push={mode:"every-mention",disabledUntil:1/0},o=-1;break;case"unmute":i.push={mode:"everything",disabledUntil:0},o=0;break;case"mute_until":i.push={mode:"every-mention",disabledUntil:Date.now()+1e3*n},o=n;break;default:(0,c.exhaustivenessCheck)(r)}return[async function({api:e}){try{return{type:"UserChangedMute_RequestCompleted",hasFailed:1!==await e.fetch("account.setSilenceMode",{time:o,peer_id:s,sound:"unmute"===r?1:0}),userAction:r,peerId:s}}catch(e){return{type:"UserChangedMute_RequestCompleted",hasFailed:!0,userAction:r,peerId:s}}}]}case"UserChangedMute_RequestCompleted":{const{peerId:n,userAction:r,hasFailed:a}=t,i=m(r,n);e.locks.convoActions.delete(i);const o={mute:"unmute",unmute:"mute",mute_until:"unmute"}[r];return a&&o?(p(e,{type:"UserChangedMute",userAction:o,peerId:n,timer:0},s),[]):[]}case"UserPinMessage":{const{peerId:s,cmid:r,userAction:a}=t,i=m(t.userAction,s);if(e.locks.convoActions.has(i))return[];e.locks.convoActions.add(i);const c=e.convos.get(s),u=e.ownerId;if(!c||"ChatConvo"!==c.kind)return[];const h=c.pinnedMessage&&(0,d.current)(c.pinnedMessage),p=n.findMessageByCmid(c,r);return"Normal"===p?.kind&&n.pinMessage(c,o.toPinned(p)),[async function({api:e}){try{return await e.fetch("messages.pin",{peer_id:s,cmid:r,group_id:(0,l.getOwnerGroupId)(u)}),{type:"UserPinMessage_RequestCompleted",hasFailed:!1,userAction:a,peerId:s,cmid:r}}catch(e){return{type:"UserPinMessage_RequestCompleted",hasFailed:!0,userAction:a,pinnedMessage:h,peerId:s,cmid:r}}}]}case"UserPinMessage_RequestCompleted":{const{peerId:s,hasFailed:r,pinnedMessage:a,userAction:i}=t,o=m(i,s);e.locks.convoActions.delete(o);const c=e.convos.get(s);return c&&"ChatConvo"===c.kind?(r&&(n.unpinMessage(c),a&&n.pinMessage(c,a)),[]):[]}case"UserUnpinMessage":{const{peerId:s,userAction:r}=t,a=m(t.userAction,s);if(e.locks.convoActions.has(a))return[];const i=e.convos.get(s),o=e.ownerId;if(!i||"ChatConvo"!==i.kind)return[];const c=(0,d.current)(n.unpinMessage(i));return[async function({api:e}){try{return await e.fetch("messages.unpin",{peer_id:s,group_id:(0,l.getOwnerGroupId)(o)}),{type:"UserUnpinMessage_RequestCompleted",hasFailed:!1,userAction:r,peerId:s}}catch(e){return{type:"UserUnpinMessage_RequestCompleted",hasFailed:!0,userAction:r,prevPinnedMessage:c,peerId:s}}}]}case"UserUnpinMessage_RequestCompleted":{const{peerId:s,hasFailed:r,prevPinnedMessage:a,userAction:i}=t,o=m(i,s);e.locks.convoActions.delete(o);const c=e.convos.get(s);return c&&"ChatConvo"===c.kind?(r&&a&&n.pinMessage(c,a),[]):[]}case"UserChangedBusinessNotify":{const{userAction:s,peerId:n}=t,a=m(t.userAction,n);if(e.locks.convoActions.has(a))return[];const i=e.peers.get(n);return"Group"!==i?.kind||i.isBlacklistedByMe&&"business_notify_disable"===s||!i.isBlacklistedByMe&&"business_notify_enable"===s?[]:(r.updateIsPeerBlacklistedByMe(i,"business_notify_disable"===s),[async function({api:e}){try{return{type:"UserChangedBusinessNotify_RequestCompleted",hasFailed:1!==await e.fetch("business_notify_disable"===s?"messages.denyMessagesFromGroup":"messages.allowMessagesFromGroup",{group_id:r.toRealId(n)}),userAction:s,peerId:n}}catch(e){return{type:"UserChangedBusinessNotify_RequestCompleted",hasFailed:!0,userAction:s,peerId:n}}}])}case"UserChangedBusinessNotify_RequestCompleted":{const{userAction:s,peerId:n,hasFailed:a}=t,i=m(s,n);e.locks.convoActions.delete(i);const o=e.peers.get(n);return"Group"!==o?.kind||a&&r.updateIsPeerBlacklistedByMe(o,!o.isBlacklistedByMe),[]}case"UserRestrictChatMemberToWrite":{const{userAction:s,chatId:n,memberId:r,duration:a}=t,o=e.convos.get(n);if(!o||"ChatConvo"!==o.kind)return[];const d=m(t.userAction,n);if(e.locks.convoActions.has(d))return[];switch(e.locks.convoActions.add(d),s){case"restrict_to_write":i.restrictMemberToWrite(o.members,r);break;case"allow_to_write":i.allowMemberToWrite(o.members,r);break;default:(0,c.exhaustivenessCheck)(s)}const l=o.peerId;return[async({api:e})=>{try{const t=await e.fetch("messages.changeConversationMemberRestrictions",{peer_id:l,member_ids:r.toString(),..."restrict_to_write"===s?{for:a,action:"ro"}:{action:"rw"}});return{type:"UserRestrictChatMemberToWrite_RequestCompleted",hasFailed:0!==t.failed_member_ids?.length,chatId:n,failedIds:t.failed_member_ids,userAction:s}}catch{return{type:"UserRestrictChatMemberToWrite_RequestCompleted",chatId:n,hasFailed:!0,failedIds:[],userAction:s}}}]}case"UserRestrictChatMemberToWrite_RequestCompleted":{const{hasFailed:s,userAction:n,failedIds:a,chatId:o}=t,d=m(n,o);e.locks.convoActions.delete(d);const l=e.convos.get(o);if(!l||"ChatConvo"!==l.kind)return[];if(s&&a.length)switch(n){case"restrict_to_write":a.forEach((e=>{i.allowMemberToWrite(l.members,r.resolveId(e))}));break;case"allow_to_write":a.forEach((e=>{i.restrictMemberToWrite(l.members,r.resolveId(e))}));break;default:(0,c.exhaustivenessCheck)(n)}return[]}case"UserChangeForbidWritingAll":{const{peerId:s,duration:a,userAction:i}=t,o=m(t.userAction,s);if(e.locks.convoActions.has(o))return[];const d=e.convos.get(s);if(!d||"ChatConvo"!==d.kind)return[];switch(i){case"forbid_writing_all":n.forbidWritingForAll(d,!0);break;case"allow_writing_all":d.forbidedWritingForAll=void 0;break;case"forbid_writing_all_until":n.forbidWritingForAll(d,!0,Date.now()+1e3*a);break;default:(0,c.exhaustivenessCheck)(i)}const u=r.toRealId(s),h=e.ownerId;return[async function({api:e}){try{return{type:"UserChangeForbidWritingAll_RequestCompleted",hasFailed:1!==await("allow_writing_all"===i?e.fetch("messages.enableChatWriting",{chat_id:u,group_id:(0,l.getOwnerGroupId)(h)}):e.fetch("messages.disableChatWriting",{chat_id:u,group_id:(0,l.getOwnerGroupId)(h),duration_sec:a===1/0?0:Math.round(a/1e3)})),userAction:i,peerId:s}}catch(e){return{type:"UserChangeForbidWritingAll_RequestCompleted",hasFailed:!0,userAction:i,peerId:s}}}]}case"UserChangeForbidWritingAll_RequestCompleted":{const{peerId:n,userAction:r,hasFailed:a}=t,i=m(r,n);e.locks.convoActions.delete(i);const o={forbid_writing_all:"allow_writing_all",allow_writing_all:"forbid_writing_all",forbid_writing_all_until:"allow_writing_all"}[r];return a&&o?(p(e,{type:"UserChangeForbidWritingAll",userAction:o,peerId:n,duration:1/0},s),[]):[]}default:(0,c.exhaustivenessCheck)(t)}},m=(e,t)=>`${u[e]}-${t.toString()}`},268734:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(207739),r=s(345543);const a=(e,t)=>{switch(t.type){case"UserChangedFriendship":{const s=e.peers.get(t.userId);if("User"!==s?.kind||e.locks.updateFriendshipOrMembership.has(s.id))return[];const r=s.friendship;return n.updateFriendship(s,t.change),r===s.friendship?[]:(e.locks.updateFriendshipOrMembership.add(s.id),[async function({api:e}){let s=!1;try{await e.fetch(`friends.${t.change}`,{user_id:n.toRealId(t.userId)})}catch(e){s=!0}return{type:"UserChangedFriendship_RequestCompleted",userId:t.userId,change:t.change,hasFailed:s}}])}case"UserChangedFriendship_RequestCompleted":{e.locks.updateFriendshipOrMembership.delete(t.userId);const s=e.peers.get(t.userId);return"User"!==s?.kind||t.hasFailed&&n.updateFriendship(s,{add:"delete",delete:"add"}[t.change]),[]}default:return(0,r.exhaustivenessCheck)(t)}}},642667:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(207739),r=s(345543);const a=(e,t)=>{switch(t.type){case"UserChangedGroupMembership":{const s=e.peers.get(t.groupId);if("Group"!==s?.kind||e.locks.updateFriendshipOrMembership.has(s.id))return[];const r=s.membership;return n.updateMembership(s,t.change),r===s.membership?[]:(e.locks.updateFriendshipOrMembership.add(s.id),[async function({api:e}){const s=`groups.${t.change}`;let n=!1;try{await e.fetch(s,{group_id:-t.groupId})}catch(e){n=!0}return{type:"UserChangedGroupMembership_RequestCompleted",groupId:t.groupId,change:t.change,hasFailed:n}}])}case"UserChangedGroupMembership_RequestCompleted":{e.locks.updateFriendshipOrMembership.delete(t.groupId);const s=e.peers.get(t.groupId);return"Group"!==s?.kind||t.hasFailed&&n.updateMembership(s,{join:"leave",leave:"join"}[t.change]),[]}default:return(0,r.exhaustivenessCheck)(t)}}},779471:(e,t,s)=>{"use strict";s.d(t,{handler:()=>m});var n=s(453934),r=s(429920),a=s(503048),i=s(95233),o=s(345543),c=s(497417),d=s(795947),l=s(189179),u=s(250122);const h={mark_important:"unmark_important",unmark_important:"mark_important"},p={delete:"delete",restore:"restore",mark_important:"mark_important",unmark_important:"mark_important"},m=(e,t,s)=>{const{type:p}=t;switch(p){case"UserChangedMessage":{const{peerId:s,userAction:r,cmids:i}=t;for(let t=0;t<i.length;t+=1){const n=i[t];if(!n)return[];const a=g(r,s,n);if(e.locks.messageActions.has(a))return[];e.locks.messageActions.add(a)}const d=e.convos.get(s);let l;switch(r){case"mark_important":case"unmark_important":i.forEach((t=>{if(d){const e=(0,n.castDraft)(a.findMessageByCmid(d,t));"Normal"===e?.kind&&(e.isImportant="mark_important"===r)}const i=e.importantMessages.messages.get((0,c.getImportantMessageKey)(s,t));i&&(i.isImportant="mark_important"===r)})),l=e=>e.fetch("messages.markAsImportant",{peer_id:s,cmids:i.join(","),important:"mark_important"===r?1:0}).then((e=>Boolean(e.marked.length)));break;default:(0,o.exhaustivenessCheck)(r)}return[async function({api:e}){try{let t=!1;return l&&(t=!await l(e)),{type:"UserChangedMessage_RequestCompleted",hasFailed:t,userAction:r,cmids:i,peerId:s}}catch(e){return{type:"UserChangedMessage_RequestCompleted",hasFailed:!0,userAction:r,cmids:i,peerId:s}}}]}case"UserChangedMessage_RequestCompleted":{const{peerId:n,userAction:r,hasFailed:a,cmids:i}=t;i.forEach((t=>{const s=g(r,n,t);e.locks.messageActions.delete(s)}));const o=h[r];return a&&o&&m(e,{type:"UserChangedMessage",userAction:o,peerId:n,cmids:i},s),[]}case"UserDeleteMessage":{const{deleteType:s,peerId:n,userAction:i,messages:c}=t,l=e.ownerId,u=e.convos.get(n);if(!u)return[];const h=new Map,p="spam"===s?t.reason:void 0,m=c.length>5;for(let t=0;t<c.length;t+=1){const d=c[t];if(!d||"Normal"!==d.kind)return[];const l=g(i,n,d.cmid);if(e.locks.messageActions.has(l))return[];e.locks.messageActions.add(l),h.set(d.cmid,d);const p=a.isCasper(u)||r.isCall(d)||m;switch(s){case"local":case"spam":if(p){a.deleteMessage(u,d,{isRestorable:!1});break}a.deleteMessage(u,d,{isRestorable:!0,isSpam:"spam"===s});break;case"for_all":a.deleteMessage(u,d,{isRestorable:!1});break;default:(0,o.exhaustivenessCheck)(s)}}return[async function({api:e}){try{const t=100,a=c.reduce(((e,s,n)=>{const r=Math.floor(n/t);return e[r]||(e[r]=[]),e[r]?.push(s.cmid),e}),new Array),o=await e.fetchMany(a.map((e=>({method:"messages.delete",params:{peer_id:n,cmids:e.join(","),delete_for_all:"for_all"===s?1:0,spam:"spam"===s?1:0,group_id:(0,d.getOwnerGroupId)(l),reason:p}})))),u=[];return o.forEach(((e,t)=>{if(!1===e){const e=a[t];e&&u.push(...e)}else e.forEach((e=>{if(1!==e.response){const t=r.resolveCmid(e.conversation_message_id);0!==t&&u.push(t)}}))})),{type:"UserDeleteMessage_RequestCompleted",hasFailed:!1,failedCmids:u,userAction:i,deleteType:s,peerId:n,messages:c,deletedMessages:h}}catch(e){return{type:"UserDeleteMessage_RequestCompleted",hasFailed:!0,failedCmids:[],userAction:i,deleteType:s,peerId:n,messages:c,deletedMessages:h}}}]}case"UserDeleteFailedMessage":{const{peerId:r,randomId:i}=t,o=e.convos.get(r);if(!o)return[];a.removePending(o,i),u.refresh(e.organisers,o,s);const c=(0,n.current)(o);return[async({storage:e})=>((0,l.saveConvosFailedMessagesInStorage)(c,e),{type:"Noop"})]}case"UserDeleteAllFailedMessage":{const{peerId:s}=t,r=e.convos.get(s);if(!r)return[];a.allQueuedMessages(r).filter((e=>e.hasFailed)).forEach((e=>{a.removePending(r,e.randomId)}));const i=(0,n.current)(r);return[async({storage:e})=>((0,l.saveConvosFailedMessagesInStorage)(i,e),{type:"Noop"})]}case"UserDeleteMessage_RequestCompleted":{const{peerId:s,userAction:n,messages:r,failedCmids:i,hasFailed:o,deletedMessages:c}=t,d=e.convos.get(s);return d&&(o?c.forEach((e=>{a.restoreMessage(d,e,!1)})):i.forEach((e=>{const t=c.get(e);t&&a.restoreMessage(d,t,!1)}))),r.forEach((({cmid:t})=>{const r=g(n,s,t);e.locks.messageActions.delete(r)})),[async()=>({type:"Noop"})]}case"UserRestoreMessage":{const{peerId:s,userAction:n,cmid:r}=t,o=g(n,s,r);if(e.locks.messageActions.has(o))return[];e.locks.messageActions.add(o);const c=e.convos.get(s);if(!c)return[];const l=e.ownerId,u=i.findNodeByCmid(c.history,r).node;return"DeletedNode"===u?.kind&&a.restoreMessage(c,u.restorable,!1),[async function({api:e}){try{const t=await e.fetch("messages.restore",{peer_id:s,cmid:r,group_id:(0,d.getOwnerGroupId)(l)});return{type:"UserRestoreMessage_RequestCompleted",hasFailed:!Boolean(t),userAction:n,peerId:s,cmid:r}}catch(e){return{type:"UserRestoreMessage_RequestCompleted",hasFailed:!0,userAction:n,peerId:s,cmid:r}}}]}case"UserRestoreMessage_RequestCompleted":{const{peerId:n,userAction:r,cmid:i,hasFailed:o}=t,c=g(r,n,i);e.locks.messageActions.delete(c);const d=e.convos.get(n);if(void 0===d)return[];const l=a.findMessageByCmid(d,i);return o&&"Normal"===l?.kind&&m(e,{type:"UserDeleteMessage",messages:[l],deleteType:"local",peerId:n,userAction:"delete"},s),[]}default:(0,o.exhaustivenessCheck)(t)}},g=(e,t,s)=>`${p[e]}-${t.toString()}-${s.toString()}`},327950:(e,t,s)=>{"use strict";s.d(t,{handler:()=>i});var n=s(500955),r=s(345543),a=s(503048);const i=(e,t)=>{switch(t.type){case"UserChangedMessageAttachment":return[async function({api:e}){try{const s=(await e.fetch("messages.getByConversationMessageId",{peer_id:t.peerId,conversation_message_ids:t.cmid.toString(),extended:1,group_id:t.groupId||0},{retries:3})).items[0];return s?{type:"UserChangedMessageAttachment_RequestCompleted",hasFailed:!1,peerId:t.peerId,apiMessage:s}:{type:"UserChangedMessageAttachment_RequestCompleted",hasFailed:!0}}catch(e){return{type:"UserChangedMessageAttachment_RequestCompleted",hasFailed:!0}}}];case"UserChangedMessageAttachment_RequestCompleted":{if(t.hasFailed)return[];const{message:s,mentions:r}=(0,n.fromApiMessage)(t.apiMessage),i=e.convos.get(t.peerId);return i?(a.replaceMessage(i,s,r.hasDirect||r.hasMass),[]):[]}default:(0,r.exhaustivenessCheck)(t)}}},387410:(e,t,s)=>{"use strict";s.d(t,{handler:()=>c});var n=s(345543),r=s(207739),a=s(503048),i=s(250122),o=s(453934);const c=(e,t,s)=>{const{type:c}=t,{viewer:d}=e,l=d.id;switch(c){case"UserAcceptedChatMessageRequest":{const{peerId:s}=t;return e.locks.changeMessageRequest.has(s)?[]:(e.locks.changeMessageRequest.add(s),[async function({api:e}){try{return await e.fetch("messages.acceptMessageRequest",{peer_id:s,user_id:r.toRealId(l)}),{type:"UserAcceptedChatMessageRequest_RequestCompleted",peerId:s}}catch(e){return{type:"UserAcceptedChatMessageRequest_RequestCompleted",peerId:s}}}])}case"UserRejectedMessageRequest":{const{peerId:n,isSpam:c}=t,d=e.convos.get(n),u=(0,o.current)(d);if("MessageRequestChatConvo"!==d?.kind&&"MessageRequestUserConvo"!==d?.kind&&"UserConvo"!==d?.kind)return[];if(e.locks.changeMessageRequest.has(n))return[];e.locks.changeMessageRequest.add(n);const h=a.rejectMR(d);return e.convos.set(n,h),i.refresh(e.organisers,h,s),[async function({api:e}){try{return{type:"UserRejectedChatMessageRequest_RequestCompleted",hasFailed:1!==await e.fetch("messages.rejectMessageRequest",{peer_id:n,user_id:r.toRealId(l),spam:c?1:0}),peerId:n,prevConvo:u}}catch(e){return{type:"UserRejectedChatMessageRequest_RequestCompleted",hasFailed:!0,peerId:n,prevConvo:u}}}]}case"UserAcceptedChatMessageRequest_RequestCompleted":{const{peerId:s}=t;return e.locks.changeMessageRequest.delete(s),[]}case"UserRejectedChatMessageRequest_RequestCompleted":{const{prevConvo:n,hasFailed:r,peerId:a}=t;return e.locks.changeMessageRequest.delete(a),r&&void 0!==n&&(e.convos.set(a,n),i.refresh(e.organisers,n,s)),[]}default:(0,n.exhaustivenessCheck)(c)}}},59444:(e,t,s)=>{"use strict";s.d(t,{handler:()=>o});var n=s(345543),r=s(548007),a=s(377836),i=s(885540);const o=(e,t)=>{switch(t.type){case"UserChangedPostAttachment":{const{channelId:e,cmid:s}=t;return[async function({api:t}){try{const n=await t.fetch("channels.getMessagesById",{channel_id:e,cmids:s.toString(),extended:1},{retries:3}),r=n.items?.[0];return r?{type:"UserChangedPostAttachment_RequestCompleted",hasFailed:!1,channelId:e,apiPost:r}:{type:"UserChangedPostAttachment_RequestCompleted",hasFailed:!0}}catch(e){return{type:"UserChangedPostAttachment_RequestCompleted",hasFailed:!0}}}]}case"UserChangedPostAttachment_RequestCompleted":{if(t.hasFailed)return[];const{apiPost:s,channelId:n}=t,o=e.channels.get(n);if(!o)return[];if("ChannelRestricted"===o.kind)return[];const{post:c,reactions:d}=(0,i.fromApiPost)(s),l=r.findPostByCmid(o,c.cmid),u=a.merge(c,"Node"===l?.kind?l.item:void 0);for(const t of d)e.reactionsOld.set(t.id,t);return r.replacePost(o,u),[]}default:(0,n.exhaustivenessCheck)(t)}}},530330:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(345543),r=s(453934);const a=(e,t)=>{switch(t.type){case"UserChangedPushSetting":{const{setting:s,value:n}=t;e.viewer.settings.push[s]=n;const a=(0,r.current)(e.viewer.settings.push);return[async function({storage:e}){return e.set("settings-push",a),{type:"UserChangedPushSetting_RequestCompleted",hasFailed:!1,setting:s,value:n}}]}case"UserChangedPushSetting_RequestCompleted":return t.hasFailed,[];default:(0,n.exhaustivenessCheck)(t)}}},896567:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(345543),r=s(952644);const a=(e,t)=>{const{type:s}=t;switch(s){case"UserChangedSetting":{const s=t.setting;if(e.locks.settings.has(s))return[];e.locks.settings.add(s);const r=e.viewer.settings[t.setting];return e.viewer.settings[t.setting]=t.value,[async function(e){try{const s=await function({env:e,setting:t,value:s}){const{api:r,storage:a}=e;switch(t){case"ctrSubmit":return r.fetch("account.setInfo",{name:"messages_multiline_input",value:String(Number(s))},{retries:3});case"soundNotifications":return"boolean"==typeof s&&a.set("settings-sound-notifications-on",s),Promise.resolve(1);case"eduAccountSwitchBanner":return r.fetch("messages.setConfig",{config:JSON.stringify({edu_account_switch_banner:Number(s)})},{retries:3});case"showRecommendations":return r.fetch("account.setInfo",{name:"messages_recommendation_list_hidden",value:String(Number(!s))},{retries:3});case"countOnlyNotMuted":return r.fetch("account.setInfo",{name:"show_only_not_muted_messages",value:String(Number(s))},{retries:3});case"autoUnarchive":return r.fetch("account.setInfo",{name:"messages_auto_unarchive",value:String(Number(s))},{retries:3});case"transcriptAutoShow":return r.fetch("account.setInfo",{name:"messages_transcript_auto_show",value:String(Number(s))},{retries:3});case"verticalFoldersView":return r.fetch("messages.setConfig",{config:JSON.stringify({vertical_folders_view:Number(s)})},{retries:3});case"messageReactionAnimation":return r.fetch("messages.setConfig",{config:JSON.stringify({message_reactions_animation:Number(s)})},{retries:3});case"fastActionsTrigger":{let e="hover_and_right_button_click";switch(s){case"hover":case!1:e="hover";break;case"rightClick":case!0:e="right_button_click";break;default:e="hover_and_right_button_click"}return r.fetch("messages.setConfig",{config:JSON.stringify({fast_action_type:e})},{retries:3})}case"autoPlayMedia":return"boolean"==typeof s&&a.set("settings-auto-play-media-enabled",s),Promise.resolve(1);case"autoExtendReactionPicker":return r.fetch("messages.setConfig",{config:JSON.stringify({auto_extend_reactions_picker:Number(s)})},{retries:3});default:(0,n.exhaustivenessCheck)(t)}}({env:e,setting:t.setting,value:t.value}),a=1===s||void 0!==s.version;return"transcriptAutoShow"===t.setting&&a&&e.stats.logEvent({type:"type_action",type_action:{type:"type_settings_changes_item",type_settings_changes_item:{type:"general",name:"voice_transcription_autoshow",value_old:String(Number(r)),value_new:String(Number(t.value)),screen:"im_web_settings"}}}),{type:"UserChangedSetting_RequestCompleted",hasFailed:!a,setting:t.setting,value:t.value}}catch(e){return{type:"UserChangedSetting_RequestCompleted",hasFailed:!0,setting:t.setting,value:t.value}}}]}case"UserChangedSetting_RequestCompleted":{const s=t.setting;if(e.locks.settings.delete(s),!t.hasFailed&&"eduAccountSwitchBanner"===t.setting){const s=e.viewer,n=r.isEdu(s.profileType);return[async function(e){return e.stats.logEvent({type:"general",name:n?"go_to_messenger_banner":"go_to_sferum_banner",value_new:t.value?"enable":"disable",value_old:t.value?"disable":"enable"}),{type:"Noop"}}]}return[]}default:(0,n.exhaustivenessCheck)(s)}}},40946:(e,t,s)=>{"use strict";s.d(t,{handler:()=>o});var n=s(330310),r=s(345543),a=s(795947),i=s(234950);const o=(e,t,s)=>{if("UserCreatedFolder"===t.type){const r=(0,a.insertFolders)(e,[(0,i.fromApiFolder)({id:t.folderId,name:t.name,type:t.folderType,flags:0})]),o=(0,a.getConvosByIds)(e,t.peerIds);return(0,a.addConvosToFolder)(e,t.folderId,o,s),s.vkm_new_convo_folder_logic||r[0]&&"default"===t.folderType&&n.setHasMore(r[0],"all",!1),[]}(0,r.exhaustivenessCheck)(t.type)}},576035:(e,t,s)=>{"use strict";s.d(t,{handler:()=>i});var n=s(330310),r=s(503048),a=s(345543);const i=(e,t,s)=>{switch(t.type){case"UserDeletedFolder":{const{folderId:a}=t;if(e.locks.deleteFolder.has(a))return[];if(e.locks.deleteFolder.add(a),n.deleteFolder(e.organisers.folders,a),!s.vkm_new_convo_folder_logic)for(const t of e.convos.values())r.removeFolder(t,a);return[async function({api:e}){try{return{type:"UserDeletedFolder_DeleteRequestCompleted",hasFailed:1!==await e.fetch("messages.deleteFolder",{folder_id:a}),folderId:a}}catch(e){return{type:"UserDeletedFolder_DeleteRequestCompleted",hasFailed:!0,folderId:a}}}]}case"UserDeletedFolder_DeleteRequestCompleted":{const{hasFailed:s,folderId:n}=t;if(e.locks.deleteFolder.delete(n),s&&a.isDev)throw new Error("Не удалось удалить папку");return[]}default:(0,a.exhaustivenessCheck)(t)}}},869237:(e,t,s)=>{"use strict";s.d(t,{handler:()=>r});var n=s(345543);const r=(e,t)=>{if("UserHideConversationsBar"===t.type){if(!e.conversationsBar)return[];const{name:s}=t;return e.conversationsBar.name!==s?[]:(delete e.conversationsBar,[async function({api:e}){try{await e.fetch("messages.conversationBarHide",{name:s})}catch{}return{type:"Noop"}}])}(0,n.exhaustivenessCheck)(t.type)}},919421:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(345543),r=s(503048);const a=(e,t)=>{switch(t.type){case"UserHideConvoBanner":{const{peerId:s,name:n}=t,a=r.safeGet(e.convos,s);return r.hideBanner(a),[async function({api:e}){try{await e.fetch("messages.conversationBarHide",{name:n,peer_id:s})}catch{}return{type:"Noop"}}]}case"UserHideConvoBannerTemporarily":{const{peerId:s,undo:n}=t,a=r.safeGet(e.convos,s);return n?r.undoTemporaryBannerHiding(a):r.hideBannerTemporarily(a),[]}default:(0,n.exhaustivenessCheck)(t)}}},422510:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(81163),r=s(345543);const a=(e,t)=>{switch(t.type){case"UserHideFilter":return"businessNotify"===t.kind?e.organisers.filters.businessNotify.unreadCount>0?[]:[async function({storage:e}){return e.set("business-notify-manually-hidden",!0),{type:"UserHideFilter_Completed",kind:"businessNotify"}}]:"all"===t.kind||"unread"===t.kind||"chats"===t.kind||"messageRequest"===t.kind||"archive"===t.kind?[]:(0,r.exhaustivenessCheck)(t.kind);case"UserHideFilter_Completed":return"businessNotify"===t.kind?(n.toggleBusinessNotifyVisibility(e.organisers.filters,!1),[]):"all"===t.kind||"unread"===t.kind||"chats"===t.kind||"messageRequest"===t.kind||"archive"===t.kind?[]:(0,r.exhaustivenessCheck)(t.kind);case"UserUndoHideFilter":return"businessNotify"===t.kind?(n.toggleBusinessNotifyVisibility(e.organisers.filters,!0),[async function({storage:e}){return e.set("business-notify-manually-hidden",!1),{type:"Noop"}}]):"all"===t.kind||"unread"===t.kind||"chats"===t.kind||"messageRequest"===t.kind||"archive"===t.kind?[]:(0,r.exhaustivenessCheck)(t.kind);case"UserActualizeHideFilter":if("businessNotify"===t.kind){const t=e.organisers.filters.businessNotify.unreadCount,{isHidden:s}=e.organisers.filters.businessNotify;return[async function({storage:e}){const n=e.get("business-notify-manually-hidden");return n&&!s?{type:"UserHideFilter",kind:"businessNotify"}:!n&&s?{type:"UserUndoHideFilter",kind:"businessNotify"}:0===t?{type:"Noop"}:{type:"UserUndoHideFilter",kind:"businessNotify"}}]}return"all"===t.kind||"unread"===t.kind||"chats"===t.kind||"messageRequest"===t.kind||"archive"===t.kind?[]:(0,r.exhaustivenessCheck)(t.kind);default:(0,r.exhaustivenessCheck)(t)}}},185866:(e,t,s)=>{"use strict";s.d(t,{handler:()=>h});var n=s(95233),r=s(377836),a=s(382543),i=s(803854),o=s(345543),c=s(33200),d=s(457911),l=s(429590),u=s(795947);const h=(e,t)=>{const{channelId:s,postCmid:h,replyCmid:m}=t,g=p(s,h),f=e.channels.get(s);if(!f||"ChannelRestricted"===f.kind)return[];const C=n.findNodeByCmid(f.history,h).node,_="Node"===C?.kind&&C.item;if(!_)return[];const v=m&&(r.findCommentByCmid(_,m)?.rootCmid||m),y=(0,d.getCommentsHistoryLockKey)(s,h,_.comments.order,v);switch(t.type){case"UserHitCommentSend":{const{text:n,attaches:r,extra:a,onComplete:o,onFail:c}=t,d=i.ids(r).join(",");return n||d||a?.sticker?e.locks.sendComment.has(g)?[]:(e.locks.sendComment.add(g),[async function({api:e}){try{o?.();return{type:"UserHitCommentSend_RequestCompleted",hasFailed:!1,response:await e.fetch("wall.createComment",{owner_id:s,post_id:h,message:n,attachments:d,reply_to_comment:m,sticker_id:a?.sticker?.id,sticker_referrer:a?.sticker?.referrer}),channelId:s,postCmid:h,replyCmid:m,text:n,attaches:r}}catch(e){return c?.(e),{type:"UserHitCommentSend_RequestCompleted",hasFailed:!0,channelId:s,postCmid:h,replyCmid:m,text:n,attaches:r}}}]):[]}case"UserHitCommentSend_RequestCompleted":{const{text:n,attaches:i,hasFailed:o,response:l}=t;if(o)return e.locks.sendComment.delete(g),[];const u=v?r.findCommentByCmid(_,v)?.replies:_.comments;if(!u)return[];const p=a.resolveCmid(l.comment_id);if(u.nextFrom){e.locks.getPostCommentsHistory.add(y);const t=(0,d.mapOrderToSort)(_.comments.order);return[async function({api:e}){try{return{type:"UserHitCommentSend_HistoryRequestCompleted",hasFailed:!1,response:await e.fetch("wall.getComments",{owner_id:s,post_id:h,count:c.COMMENTS_PER_PAGE,thread_items_count:c.THREAD_COMMENTS_COUNT,need_likes:1,extended:1,sort:t,start_comment_id:p,comment_id:v,offset:1-c.COMMENTS_PER_PAGE}),channelId:s,postCmid:h,rootCommentCmid:v,newCommentCmid:p,replyCmid:m}}catch(e){return{type:"UserHitCommentSend_HistoryRequestCompleted",hasFailed:!0,channelId:s,postCmid:h,rootCommentCmid:v,newCommentCmid:p,replyCmid:m}}}]}e.locks.sendComment.delete(g);const f=!!i.sticker||!!i.ugcSticker,C=a.newNormal({canEdit:!f,channelId:s,postCmid:h,sentAt:Date.now(),rootCmid:v,cmid:p,peerId:e.ownerId,attaches:i},n);if(v){const e=r.findCommentByCmid(_,v);if(!e)return[];e.replies.history=[...e.replies.history,C],e.replies.count+=1}else _.comments.history=[..._.comments.history,C],_.comments.count+=1,_.comments.oneLevelCount+=1;return _.comments.lastSendCmid=p,[]}case"UserHitCommentSend_HistoryRequestCompleted":{const{hasFailed:s,response:n,newCommentCmid:a}=t;if(e.locks.sendComment.delete(g),e.locks.getPostCommentsHistory.delete(y),s)return[];const i=n.items.map((e=>(0,l.fromApiComment)(e)));if(v){const e=r.findCommentByCmid(_,v);if(!e)return[];e.replies={...e.replies,count:n.current_level_count||0,history:i,nextFrom:n.next_from,prevFrom:n.prev_from}}else _.comments={..._.comments,history:i,count:n.count,oneLevelCount:n.current_level_count||0,nextFrom:n.next_from,prevFrom:n.prev_from};return _.comments.lastSendCmid=a,(0,u.insertPeers)(e,{apiUsers:n.profiles||[],apiGroups:n.groups||[],apiContacts:[]}),[]}default:(0,o.exhaustivenessCheck)(t)}},p=(e,t)=>`${e}-${t}`},584352:(e,t,s)=>{"use strict";s.d(t,{handler:()=>d});var n=s(345543),r=s(453934),a=s(429920),i=s(503048),o=s(803854),c=s(795947);const d=(e,t)=>{switch(t.type){case"UserHitEdit":{const{cmid:s,text:n,attaches:r,peerId:d,keepForwarded:l,skipCheckChanges:u}=t,h=e.convos.get(d),p=e.ownerId;if(!h)return[];const m=i.findMessageByCmid(h,s);if(!u&&"Normal"===m?.kind&&!a.checkMessageHasChanged({draft:{text:n,attaches:r,keepForwarded:l},message:m}))return[];"Normal"===m?.kind&&a.edit(m,{text:n,attaches:r,keepForwarded:l}),e.locks.edit.add(d);const g=o.ids(r).join(",");return[async function({api:e}){let t=!1;try{await e.fetch("messages.edit",{cmid:s,peer_id:d,message:n,attachment:0===g.length?void 0:g,group_id:(0,c.getOwnerGroupId)(p),keep_forward_messages:l?1:0,keep_snippets:r.link||r.inviteLink||r.donutLink||r.stickerPack||r.miniApps?1:0,lat:r.geo?.coordinates.latitude,long:r.geo?.coordinates.longitude})}catch(e){t=!0}return{type:"UserHitEdit_RequestCompleted",peerId:d,cmid:s,hasFailed:t}}]}case"UserHitEdit_Resend":{const{cmid:s,peerId:n}=t,o=e.convos.get(n);if(!o)return[];const c=i.findMessageByCmid(o,s);if("Normal"===c?.kind&&"failed"===c.editing?.status){const e=(0,r.current)(c),{cmid:t,peerId:s,attaches:n,replyMessage:i,forwardedMessages:o}=e,d=Boolean(i||o?.length),l=a.toRawText(c);return[async function(){return{type:"UserHitEdit",cmid:t,text:l,attaches:n,peerId:s,keepForwarded:d,skipCheckChanges:!0}}]}return[]}case"UserHitEdit_RequestCompleted":{const{peerId:s,hasFailed:n,cmid:r}=t;e.locks.edit.delete(s);const o=e.convos.get(s);if(!o)return[];if(n){const e=i.findMessageByCmid(o,r);"Normal"===e?.kind&&a.editFailed(e)}return[]}case"UserHitEdit_CancelFailedEditing":{const{peerId:s,cmid:n}=t,r=e.convos.get(s);if(!r)return[];const a=i.findMessageByCmid(r,n);return a&&"Normal"===a.kind&&a.editing?.status&&a.editing?.originalEditedMessage&&i.replaceMessage(r,a.editing.originalEditedMessage,!1),[]}default:return(0,n.exhaustivenessCheck)(t)}}},6246:(e,t,s)=>{"use strict";s.d(t,{handler:()=>c});var n=s(345543),r=s(803854),a=s(377836),i=s(95233),o=s(243860);const c=(e,t)=>{const{channelId:s,postCmid:c,commentCmid:l}=t,u=d(s,c);switch(t.type){case"UserHitEditComment":{const{text:n,attaches:a,onComplete:i,onFail:o}=t;if(e.locks.sendComment.has(u))return[];e.locks.sendComment.add(u);const d=r.ids(a).join(",");return n||d?[async function({api:e}){let t=!1;try{t=!Boolean(await e.fetch("wall.editComment",{attachments:d,owner_id:s,message:n,comment_id:l})),i?.()}catch(e){o?.(e),t=!0}return{type:"UserHitEditComment_RequestCompleted",hasFailed:t,text:n,attaches:a,channelId:s,postCmid:c,commentCmid:l}}]:[]}case"UserHitEditComment_RequestCompleted":{e.locks.sendComment.delete(u);const{hasFailed:n,text:r,attaches:d}=t;if(n)return[];const h=e.channels.get(s);if("ChannelRestricted"===h?.kind)return[];const p=h&&i.findNodeByCmid(h.history,c).node,m="Node"===p?.kind&&p.item,g=m&&a.findCommentByCmid(m,l);return g&&"Normal"===g.kind?(a.replaceComment(m,{...g,chunks:o.fromServerText(r),attaches:d}),[]):[]}default:return(0,n.exhaustivenessCheck)(t)}},d=(e,t)=>`${e}-${t}`},646987:(e,t,s)=>{"use strict";s.d(t,{handler:()=>l});var n=s(548007),r=s(803854),a=s(377836),i=s(236634),o=s(348330),c=s(345543),d=s(885540);const l=(e,t,s)=>{switch(t.type){case"UserHitPostEdit":{const{cmid:s,text:a,attaches:o,channelId:c,topic:d,options:l,visibility:h,donutDelay:p,onComplete:m,onFail:g}=t,f=e.channels.get(c);if(!f||"ChannelRestricted"===f.kind)return[];const C=r.ids(o).join(",");if(!a&&!C)return[];const _=n.findPostByCmid(f,s);return _&&"DeletedNode"!==_.kind?(e.locks.editPost.add(c),[async function({api:e}){try{m();const t=await e.fetch("channels.editMessage",{channel_id:c,cmid:s,message:a,attachments:C,topic_id:i.getPostThemeIdFromKey(d),close_comments:u(l.has("close_comments")),signed:u(l.has("signed")),donut_paid_duration:"all"===h?void 0:-1===p?p:86400*p});return{type:"UserHitPostEdit_RequestCompleted",hasFailed:!1,channelId:c,response:t}}catch(e){return g(e),{type:"UserHitPostEdit_RequestCompleted",hasFailed:!0,channelId:c}}}]):[]}case"UserHitPostEdit_RequestCompleted":{const{hasFailed:r,channelId:i}=t;e.locks.editPost.delete(i);const c=e.channels.get(i);if(!c||"ChannelRestricted"===c.kind||r)return[];const{post:l,reactions:u}=(0,d.fromApiPost)(t.response),h=n.findPostByCmid(c,l.cmid),p=a.merge(l,"Node"===h?.kind?h.item:void 0);for(const t of u)e.reactionsOld.set(t.id,t);return n.replacePost(c,p),o.handler(e,{type:"ComposerDraftsUpdateNeeded",foreignKind:"post",itemsToReplace:[p]},s),[]}default:(0,c.exhaustivenessCheck)(t)}},u=e=>void 0!==e?Number(e)&&1:e},631728:(e,t,s)=>{"use strict";s.d(t,{handler:()=>p});var n=s(548007),r=s(803854),a=s(95233),i=s(377836),o=s(207739),c=s(236634),d=s(250122),l=s(348330),u=s(345543),h=s(885540);const p=(e,t,s)=>{switch(t.type){case"UserHitPostSend":{const{text:s,attaches:n,channelId:d,publishAt:l,topic:u,options:h,visibility:p,donutDelay:g,onComplete:f,onFail:C,forwardingPost:_,ads:v}=t,y=e.channels.get(d);if(!y||"ChannelRestricted"===y.kind)return[];const k=r.ids(n).join(",");if(!s&&!k&&!_)return[];let I;if(void 0===l){const e=_?{...n,wall:{kind:"Wall",id:_.cmid,date:Date.now(),authorId:o.resolveRealId("Group",-_.channelId),attaches:_.attaches,isDeleted:!1,isVisibleFor:"all",isAds:!!_.ads.markedAsAds,chunks:_.chunks}}:n;I=i.newPending({channelId:d,attaches:e,sentAt:+new Date},s),a.appendPending(y.history,I)}return[async function({api:e}){try{f();const t={channel_id:d,message:s,attachments:k,publish_date:l&&Math.floor(l.getTime()/1e3),topic_id:c.getPostThemeIdFromKey(u),close_comments:m(h.has("close_comments")),mark_as_ads:m(v.isAd),ord_erid:v.erId,mute_notifications:m(h.has("mute_notifications")),signed:m(h.has("signed")),donut_paid_duration:"all"===p?void 0:-1===g?g:86400*g};let n,r;if(_){r=(await e.fetch("wall.repost",{object:`wall${_.channelId}_${_.cmid}`,message:t.message,group_id:Math.abs(d),close_comments:t.close_comments,publish_date:t.publish_date,mark_as_ads:t.mark_as_ads,mute_notifications:t.mute_notifications})).post_id}else n=await e.fetch("channels.sendMessage",{...t,from_group:1}),r=n.cmid;return{type:"UserHitPostSend_RequestCompleted",hasFailed:!1,randomId:I?.randomId,channelId:d,cmid:i.resolveCmid(r),response:n}}catch(e){return C(e),{type:"UserHitPostSend_RequestCompleted",hasFailed:!0,randomId:I?.randomId,channelId:d}}}]}case"UserHitPostSend_RequestCompleted":{const{hasFailed:r,randomId:i,channelId:o}=t,c=e.channels.get(o);if(!c||"ChannelRestricted"===c.kind)return[];if(r)return i&&a.removePending(c.history,i),[];const u=i&&a.findPendingNode(c.history,i);if(!u)return[];if(u.item.cmid=t.cmid,!t.response)return[];const{post:p,reactions:m}=(0,h.fromApiPost)(t.response);for(const t of m)e.reactionsOld.set(t.id,t);return n.appendPost(c,p),d.refreshChannels(e.organisers,c),l.handler(e,{type:"ComposerDraftsUpdateNeeded",foreignKind:"post",itemsToReplace:[p]},s),[]}default:(0,u.exhaustivenessCheck)(t)}},m=e=>void 0!==e?Number(e)&&1:e},717479:(e,t,s)=>{"use strict";s.d(t,{handler:()=>f});var n=s(453934),r=s(906978),a=s(345543),i=s(429920),o=s(207739),c=s(503048),d=s(95233),l=s(250122),u=s(803854),h=s(795947),p=s(33200),m=s(963196),g=s(189179);const f=(e,t,s)=>{switch(t.type){case"UserHitSend":{const{peerId:n,analyticsAppName:r}=t,a=e.convos.get(n);return a?function(e,t){const{text:s,attaches:n,peerId:r,timestamp:a,expireTTL:o,deleteTTL:c,entrypoint:d,extra:l,reply:u,forwarded:h}=e,m=function(e){const t=e.length;if(t<p.MAX_MESSAGE_SIZE)return[e];const s=[];let n=0;for(let r=0;r<Math.ceil(t/p.MAX_MESSAGE_SIZE);r++){const r=e.substring(n,n+p.MAX_MESSAGE_SIZE).lastIndexOf(" "),a=-1===r?p.MAX_MESSAGE_SIZE:r,i=t-n<=p.MAX_MESSAGE_SIZE?e.substring(n):e.substring(n,n+a);n+=i.length,s.push(i)}return s.map((e=>e.trim()))}(s),g=function(e){const t=Object.values(e).flat(),s=Object.fromEntries(Object.entries(e).map((([e,t])=>Array.isArray(t)?[t[0].kind,{key:e,isArray:!0}]:[t.kind,{key:e,isArray:!1}])));if(t.length<=p.MAX_MESSAGE_ATTACHES)return[e];return t.reduce(((e,t,n)=>{const r=Math.floor(n/p.MAX_MESSAGE_ATTACHES),a=s[t.kind];return a?(e[r][a.key]=a.isArray?e[r][a.key]?.concat(t)||[t]:t,e):e}),Array.from({length:Math.ceil(t.length/p.MAX_MESSAGE_ATTACHES)},(()=>Object())))}(n),f=m.length+g.length-1,C=[];for(let e=0;e<f;e++){const s=m[e]||"",n=g[e-m.length+1]||{},p=i.newQueued({peerId:r,text:s,isOut:!0,sentAt:a+e,authorId:t,attaches:n,expireTTL:o,deleteTTL:c,extra:l,entrypoint:d},0===e?u:void 0,e===f-1?h:void 0);C.push(p)}return C}(t,e.ownerId).flatMap((t=>{c.appendQueuedMessage(a,s.vkm_new_remove_empty_forwards?i.removeEmptyForwardsFromQueued(t):t);const n=e.locks.sendQueue.get(a.peerId);return n?(n.add(t.randomId),[]):(e.locks.sendQueue.set(a.peerId,new Set([t.randomId])),[C(t.peerId,t.randomId,t.text,u.ids(t.attaches),t.extra,t.entrypoint,t.attaches.geo,(0,h.getOwnerGroupId)(e.ownerId),_(t),r),o.isMarusia(t.peerId)&&async function({marusia:e}){return e?.handleAction({type:"add_message",payload:{randomId:Number(t.randomId),text:i.toRawText(t),isOutbound:t.isOut,local:!0,payload:t.extra.botPayload,attachIds:u.ids(t.attaches)}}),{type:"Noop"}}])})):[]}case"UserHitSend_RequestCompleted":{const{peerId:a,randomId:o,response:p,error:f,analyticsAppName:v}=t,y=e.convos.get(a),k=e.ownerId;if(!y)return e.locks.sendQueue.delete(a),[];const I=d.findPendingNode(y.history,o);I&&(p?p.cmid&&i.updateCmid(I.item,i.resolveCmid(p.cmid)):(f&&f instanceof m.IApi.RequestError?(i.updateFailedStatus(I.item,!0,f.code),f.code===r.API_ERROR_MESSAGES_WRITING_DISABLED_FOR_CHAT&&(c.forbidWritingForAll(y,!0),c.restrictViewerToWrite(y,"forbid_writing_for_all"))):i.updateFailedStatus(I.item,!0),l.refresh(e.organisers,y,s)));const w=(0,n.current)(y),b=async({storage:e})=>((0,g.saveConvosFailedMessagesInStorage)(w,e),{type:"Noop"}),R=e.locks.sendQueue.get(y.peerId);if(!R)return[b];R.delete(o);const M=[...R][0];if(!M)return e.locks.sendQueue.delete(a),[b];const S=d.findPendingNode(y.history,M)?.item;if(!S)return[b];const E=(0,n.current)(S);return[C(a,E.randomId,E.text,u.ids(E.attaches),E.extra,E.entrypoint,E.attaches.geo,(0,h.getOwnerGroupId)(k),_(E),v),b]}case"ResendFailedMessage":case"UserHitResendFailedMessage":{const{randomId:s,peerId:r,entrypoint:a}=t;let i;"UserHitResendFailedMessage"===t.type&&(i=t.analyticsAppName);const o=e.convos.get(r),l=e.ownerId;if(!o)return[];const p=d.findPendingNode(o.history,s)?.item;if(!p)return[];c.updateSendingFail(o,s,!1),c.changeQueuedMessageEntrypoint(o,s,a);const m=e.locks.sendQueue.get(o.peerId);if(m)return m.add(p.randomId),[];e.locks.sendQueue.set(o.peerId,new Set([p.randomId]));const g=(0,n.current)(p);return[C(r,g.randomId,g.text,u.ids(g.attaches),g.extra,a,g.attaches.geo,(0,h.getOwnerGroupId)(l),_(g),i)]}case"ResendAllConvoFailedMessages":case"UserHitResendAllConvoFailedMessages":{const{peerId:n,entrypoint:r}=t;let a;"UserHitResendAllConvoFailedMessages"===t.type&&(a=t.analyticsAppName);const i=e.convos.get(n);if(!i)return[];return c.allQueuedMessages(i).filter((e=>e.hasFailed)).flatMap((t=>f(e,{type:"UserHitResendFailedMessage",peerId:n,randomId:t.randomId,entrypoint:r||t.entrypoint,analyticsAppName:a},s)))}case"ResendAllFailedMessages":return Array.from(e.convos.values()).flatMap((t=>f(e,{type:"ResendAllConvoFailedMessages",peerId:t.peerId},s)));case"UserHitSendWidget":{const{peerId:n,text:r,timestamp:a,entrypoint:o,extra:c,analyticsAppName:d}=t;if(e.convos.get(n))return f(e,{type:"UserHitSend",attaches:{},extra:c,entrypoint:o,text:r,peerId:n,timestamp:a,analyticsAppName:d},s);const l=i.newQueued({peerId:n,text:r,isOut:!0,sentAt:a,authorId:e.ownerId,attaches:{},extra:c,entrypoint:o});return[C(l.peerId,l.randomId,l.text,u.ids(l.attaches),l.extra,l.entrypoint,l.attaches.geo,(0,h.getOwnerGroupId)(e.ownerId),null,d)]}case"UserHitSend_ErrorSnackbarShown":{const{peerId:s,randomId:r}=t,a=e.convos.get(s);if(!a)return[];const o=c.allQueuedMessages(a).find((e=>e.randomId===r));if(!o)return[];i.updateFailedStatus(o,!0,void 0);const d=(0,n.current)(a);return[async({storage:e})=>((0,g.saveConvosFailedMessagesInStorage)(d,e),{type:"Noop"})]}default:return(0,a.exhaustivenessCheck)(t)}};function C(e,t,s,n,r,a,i,o,c,d){return async function({api:l,perfStats:u,stats:h}){const p={};r.sticker&&(p.sticker_id=r.sticker.id,p.sticker_referrer=r.sticker.referrer),r.botPayload&&(p.payload=r.botPayload),r.silent&&(p.silent=1),r.expiresIn&&(p.expire_ttl=r.expiresIn),r.ref&&(p.ref=r.ref),r.refSource&&(p.ref_source=r.refSource),i&&(p.lat=i.coordinates.latitude,p.long=i.coordinates.longitude);try{u?.addEventData("receive_message",{sendStart:u.getCurrentTime()});const r=await l.fetch("messages.send",{...p,peer_id:e,random_id:t,message:s,forward:c?JSON.stringify(c):void 0,attachment:0===n.length?void 0:n.join(","),entrypoint:a,group_id:o,from:d});return u?.addEventData("receive_message",{sendEnd:u.getCurrentTime()}),h.trackExternalEvent({type:"message_sent"}),{type:"UserHitSend_RequestCompleted",peerId:e,randomId:t,response:r,analyticsAppName:d}}catch(s){return{type:"UserHitSend_RequestCompleted",peerId:e,randomId:t,analyticsAppName:d,error:s instanceof Error?s:void 0}}}}function _(e){let t=null;return e.replyMessage&&(t={peer_id:e.replyMessage.peerId,conversation_message_ids:[e.replyMessage.cmid],is_reply:!0}),e.forwardedMessages&&(t={peer_id:e.forwardedMessages[0].peerId,conversation_message_ids:e.forwardedMessages.map((e=>e.cmid))}),t}},169664:(e,t,s)=>{"use strict";s.d(t,{handler:()=>l});var n=s(345543),r=s(377836),a=s(207739),i=s(95233),o=s(33200),c=s(795947);const d={UserChangedLike:"UserChangedLike",UserChangedLike_RequestCompleted:"UserChangedLike",UserLoadedLikes:"UserLoadedLikes",UserLoadedLikes_RequestCompleted:"UserLoadedLikes"},l=(e,t,s)=>{let h,p,m;switch(t.kind){case"comment":{const{channelId:s,postCmid:n,commentCmid:a}=t,o=e.channels.get(s);if("ChannelRestricted"===o?.kind)break;const c=o&&i.findNodeByCmid(o.history,n).node,d="Node"===c?.kind&&r.findCommentByCmid(c.item,a);if(!d||"Normal"!==d.kind)break;h=d.channelId,m=d,p=d.cmid;break}case"post":{const{channelId:s,postCmid:n}=t,r=e.channels.get(s);if("ChannelRestricted"===r?.kind)break;const a=r&&i.findNodeByCmid(r.history,n).node,o="Node"===a?.kind&&a.item;if(!o)break;h=o.channelId,p=o.cmid,m=o;break}default:(0,n.exhaustivenessCheck)(t)}if(!m||!h||!p)return[];const g=u(d[t.type],t.kind,h,p);switch(t.type){case"UserLoadedLikes":{if(e.locks.likeActions.has(g))return[];let s;switch(e.locks.likeActions.add(g),t.kind){case"comment":case"post":s=m.likes.peerIds.size;break;default:(0,n.exhaustivenessCheck)(t)}const r=0===m.likes.peerIds.size?o.LIKE_PEERS_FIRST_LOAD:o.LIKE_PEERS_PER_PAGE;return[async function({api:e}){try{const n=await e.fetch("likes.getList",{type:t.kind,owner_id:h,item_id:p,extended:1,skip_own:1,count:r,offset:s});return{...t,type:"UserLoadedLikes_RequestCompleted",response:n,hasFailed:!1}}catch(e){return{...t,type:"UserLoadedLikes_RequestCompleted",hasFailed:!0}}}]}case"UserLoadedLikes_RequestCompleted":{const{hasFailed:s,response:r}=t;if(e.locks.likeActions.delete(g),s||!r)return[];const i=r.items.filter((e=>"profile"===e.type)),o=r.items.filter((e=>"group"===e.type)),d=[...i.map((e=>a.resolveRealId("User",e.id))),...o.map((e=>a.resolveRealId("Group",e.id)))];switch((0,c.insertPeers)(e,{apiUsers:i,apiGroups:o,apiContacts:[]}),t.kind){case"comment":case"post":d.forEach((e=>m?.likes.peerIds.add(e)));break;default:(0,n.exhaustivenessCheck)(t)}return[]}case"UserChangedLike":{const{reactionId:s}=t,n=m.likes.reactionId;if(n===s)return[];const r=void 0!==n;return e.locks.likeActions.has(g)?[]:(e.locks.likeActions.add(g),void 0===s?m.likes.count-=1:r||(m.likes.count+=1),m.likes.reactionId=s,[async function({api:e}){try{const n=await e.fetch(r&&void 0===s?"likes.delete":"likes.add",{type:t.kind,owner_id:h,item_id:p||0,reaction_id:s});return{...t,type:"UserChangedLike_RequestCompleted",response:n,hasFailed:!1}}catch(e){return{...t,type:"UserChangedLike_RequestCompleted",hasFailed:!0,prevReactionId:n}}}])}case"UserChangedLike_RequestCompleted":{const{hasFailed:n,response:r,prevReactionId:a}=t;return e.locks.likeActions.delete(g),n||!r?(l(e,{...t,type:"UserChangedLike",reactionId:a},s),e.locks.likeActions.delete(g),[]):(m.likes.count=r.likes,[])}default:(0,n.exhaustivenessCheck)(t)}},u=(e,t,s,n)=>`${e}-${t}-${s}-${n}`},457911:(e,t,s)=>{"use strict";s.d(t,{getCommentsHistoryLockKey:()=>l,handler:()=>d,mapOrderToSort:()=>u});var n=s(345543),r=s(377836),a=s(95233),i=s(795947),o=s(33200),c=s(429590);const d=(e,t)=>{switch(t.type){case"UserLoadedCommentsHistory":{const{channelId:s,postCmid:n,direction:i,order:c,rootCommentCmid:d}=t,h=l(s,n,c,d);if(e.locks.getPostCommentsHistory.has(h))return[];e.locks.getPostCommentsHistory.add(h);const p=e.channels.get(s);if(!p||"ChannelRestricted"===p.kind)return[];const m=a.findNodeByCmid(p.history,n).node,g="Node"===m?.kind&&m.item;if(!g)return[];c!==g.comments.order&&r.changeCommentsOrder(g,c);let f,C,_=u(c);if(d){const e=r.findCommentByCmid(g,d);if(!e)return[];_="asc",f=e.replies.nextFrom,C=e.replies.prevFrom}else f=g.comments.nextFrom,C=g.comments.prevFrom;return[async function({api:e}){try{const r=await e.fetch("wall.getComments",{owner_id:s,post_id:n,count:o.COMMENTS_PER_PAGE,thread_items_count:o.THREAD_COMMENTS_COUNT,need_likes:1,extended:1,sort:_,comment_id:d,next_from:"forward"===i?f:void 0,prev_from:"backward"===i?C:void 0});return{...t,type:"UserLoadedCommentsHistory_RequestSucceed",response:r}}catch(e){return{type:"UserLoadedCommentsHistory_RequestFailed",channelId:s,postCmid:n,order:c,direction:i,hasFailed:!0}}}]}case"UserLoadedCommentsHistory_RequestSucceed":{const{response:s,channelId:o,postCmid:d,direction:u,order:h,rootCommentCmid:p}=t;e.locks.getPostCommentsHistory.delete(l(o,d,h,p));const m=e.channels.get(o);if(!m||"ChannelRestricted"===m.kind)return[];const g=a.findNodeByCmid(m.history,d).node,f="Node"===g?.kind&&g.item;if(!f||f.comments.order!==h)return[];const C=s.items.map((e=>(0,c.fromApiComment)(e))),_=(e,t)=>{switch(u){case"forward":return{...e,history:[...e.history,...t],nextFrom:s.next_from};case"backward":return{...e,history:[...t,...e.history],prevFrom:s.prev_from};default:(0,n.exhaustivenessCheck)(u)}};if(p){const e=r.findCommentByCmid(f,p);if(!e)return[];e.replies=_(e.replies,C),e.replies.count=s.current_level_count||e.replies.count}else f.comments=_(f.comments,C),f.comments.count=s.count,f.comments.oneLevelCount=s.current_level_count||f.comments.oneLevelCount;return(0,i.insertPeers)(e,{apiUsers:s.profiles||[],apiGroups:s.groups||[],apiContacts:[]}),[]}case"UserLoadedCommentsHistory_RequestFailed":{const{channelId:s,postCmid:n,order:r,rootCommentCmid:a}=t;return e.locks.getPostCommentsHistory.delete(l(s,n,r,a)),[]}default:return(0,n.exhaustivenessCheck)(t)}},l=(e,t,s,n)=>`${e}-${t}-${s}-${n||""}`,u=e=>{switch(e){case"interesting":return;case"new":return"desc";case"old":return"asc";default:(0,n.exhaustivenessCheck)(e)}}},623127:(e,t,s)=>{"use strict";s.d(t,{handler:()=>o});var n=s(345543),r=s(361084),a=s(795947),i=s(803854);const o=(e,t,s)=>{switch(t.type){case"UserLoadedUrlSnippets":{const{urls:s}=t;if(s.forEach((t=>!e.urlSnippetsCache.has(t)&&e.urlSnippetsQueue.add(t))),0===e.urlSnippetsQueue.size)return[];if(e.locks.urlSnippets.load||e.locks.urlSnippets.throttle)return[];const r=Array.from(e.urlSnippetsQueue);return e.urlSnippetsQueue=new Set,e.locks.urlSnippets={load:!0,throttle:!0},[async function({api:e}){try{const t=await e.fetch("wall.parseAttachedLink",{links:JSON.stringify(r),extended:1});return{type:"UserLoadedUrlSnippets_RequestCompleted",urls:r,res:t}}catch(e){return{type:"UserLoadedUrlSnippets_RequestCompleted",urls:r}}},async function(){return await(0,n.sleep)(300),{type:"UserLoadedUrlSnippets_ThrottleTimedOut"}}]}case"UserLoadedUrlSnippets_ThrottleTimedOut":return e.locks.urlSnippets.throttle=!1,e.locks.urlSnippets.load?[]:o(e,{type:"UserLoadedUrlSnippets",urls:[]},s);case"UserLoadedUrlSnippets_RequestCompleted":{const{res:n,urls:c}=t;if(e.locks.urlSnippets.load=!1,n){const{data:t,groups:s,profiles:o}=n;t.forEach(((t,s)=>{const n=(0,r.fromApiWallReplyAttach)([t]),a=Object.values(n).map((e=>Array.isArray(e)?e[0]:e))[0],o=c[s];a&&o&&i.isAddableAttach(a)&&(e.urlSnippetsCache.set(o,a),e.urlSnippetsCache.size>=60&&(e.urlSnippetsCache=new Map(Array.from(e.urlSnippetsCache).slice(-30))))})),(0,a.insertPeers)(e,{apiUsers:o||[],apiGroups:s||[],apiContacts:[]})}return e.locks.urlSnippets.throttle?[]:o(e,{type:"UserLoadedUrlSnippets",urls:[]},s)}default:(0,n.exhaustivenessCheck)(t)}}},822333:(e,t,s)=>{"use strict";s.d(t,{handler:()=>d});var n=s(906978),r=s(548007),a=s(250122),i=s(345543),o=s(963196),c=s(795947);const d=(e,t)=>{switch(t.type){case"UserOpenedChannel":{const{channelId:s}=t,n=e.locks.channelsCleanup.get(s)||0;e.locks.channelsCleanup.set(s,n+1);return e.channels.get(s)?[]:[async function({api:e}){try{const t=await e.fetch("channels.getById",{channel_ids:s.toString(),extended:1},{retries:2});return{type:"UserOpenedChannel_ChannelRequestCompleted",channelId:s,response:t,hasFailed:!1}}catch(e){return{type:"UserOpenedChannel_ChannelRequestCompleted",channelId:s,hasFailed:!0,errCode:e instanceof o.IApi.RequestError?e.code:void 0}}}]}case"UserOpenedChannel_ChannelRequestCompleted":{const{hasFailed:s,channelId:r,response:o,errCode:d}=t;if(s&&(d===n.API_ERROR_MESSAGES_SHOULD_BE_EDU||d===n.API_ERROR_MESSAGES_SHOULD_NOT_BE_EDU))return e.channels.set(r,{id:r,kind:"ChannelRestricted",needSwitchAccount:!0}),[];if(s&&d===n.API_ERROR_ACCESS)return e.channels.set(r,{id:r,kind:"ChannelRestricted"}),[];if(!o)return[];(0,c.insertChannels)(e,{apiChannels:o.items||[],apiGroups:o.groups||[]});const l=e.channels.get(r);if(!l){if(i.isDev)throw new Error("Диалог не был найден");return[]}return"ChannelRestricted"===l.kind||l.isMember&&a.refreshChannels(e.organisers,l),[]}case"UserClosedChannel":{const{channelId:s}=t,n=e.locks.channelsCleanup.get(s);if(n&&n>1)return e.locks.channelsCleanup.set(s,n-1),[];e.locks.channelsCleanup.delete(s);const a=e.channels.get(s);return a?("ChannelRestricted"===a.kind||r.cleanup(a),[]):[]}default:return(0,i.exhaustivenessCheck)(t)}}},255242:(e,t,s)=>{"use strict";s.d(t,{handler:()=>d});var n=s(795947),r=s(207739),a=s(503048),i=s(250122),o=s(345543),c=s(159300);const d=(e,t,s)=>{switch(t.type){case"LoadChatMembers":case"ActualizeComposerDraft":return[];case"UserOpenedConvo":{e.convoLoadingFailed=void 0;const{peerId:r}=t,a=e.convos.get(r),i=e.locks.convosCleanup.get(r)||0;e.locks.convosCleanup.set(r,i+1);const o=(0,n.getOwnerGroupId)(e.ownerId);return a?d(e,{type:"UserOpenedConvo_ConvoRequestCompleted",peerId:r,hasFailed:!1},s):[async function({api:e,perfStats:t}){try{t?.addEventData("open_chat",{loadConvoStart:t.getCurrentTime()});const s=await e.fetch("messages.getConversationsById",{peer_ids:r.toString(),group_id:o,extended:1},{retries:3});return t?.addEventData("open_chat",{loadConvoEnd:t.getCurrentTime()}),{type:"UserOpenedConvo_ConvoRequestCompleted",peerId:r,hasFailed:!1,profiles:s.profiles,groups:s.groups,conversations:s.items,contacts:s.contacts}}catch(e){return{type:"UserOpenedConvo_ConvoRequestCompleted",peerId:r,hasFailed:!0}}}]}case"UserOpenedConvo_ConvoRequestCompleted":{const{peerId:c,conversations:d,profiles:l,groups:u,contacts:h,hasFailed:p}=t;if(p){if(o.isDev)throw new Error("Не удалось загрузить диалог");return e.convoLoadingFailed=c,[]}(0,n.insertConvos)(e,d||[],s),(0,n.insertPeers)(e,{apiUsers:l||[],apiGroups:u||[],apiContacts:h||[]});const m=e.convos.get(c);if(!m){if(o.isDev)throw new Error("Диалог не был найден");return[]}const g=a.hasPeerFlag(m,a.PEER_FLAGS.isMarkedUnread)&&0===m.unreadCount;g&&a.markRead(m),i.refresh(e.organisers,m,s);const f="ChatConvo"===m.kind&&0===m.members.memberIds.size&&a.canReadMembers(m)&&!e.locks.getConversationMembers.has(c);f&&e.locks.getConversationMembers.add(c);const C=(0,n.getOwnerGroupId)(e.ownerId),_=0===e.stickersKeywords.size;return[f&&r.isChatPeerId(c)&&async function(){return{type:"LoadChatMembers",peerId:c}},async function({api:e,storage:t}){try{const n=await async function({api:e,storage:t,shouldReturnStickersKeywordsIfNotExpired:s}){const n=t.get("stickers-keywords-meta"),r=Math.round((new Date).getTime()/1e3),a=86400;if(n&&n.expiresAt>r&&!n.incomplete){if(!s)return;const e=await t.getIDB("stickers-keywords");return e?.dictionary}const i=[];let o,c=0,d=!1;for(;;)try{const{dictionary:t,chunks_hash:s,chunks_count:n}=await e.fetch("store.getStickersKeywords",{need_stickers:0,all_products:0,chunk:c,chunks_hash:o},{retries:2});if(i.push(...t),o=s,c++,!n||n===c)break}catch{d=!0;break}try{await t.setIDB("stickers-keywords",{dictionary:i}),t.set("stickers-keywords-meta",{expiresAt:r+a,incomplete:d})}catch{}return i}({api:e,storage:t,featureFlags:s,shouldReturnStickersKeywordsIfNotExpired:_});return{type:"UserOpenedConvo_StickersKeywordsRequestCompleted",response:n}}catch{return{type:"UserOpenedConvo_StickersKeywordsRequestCompleted"}}},g&&async function({api:e}){try{await e.fetch("messages.markAsRead",{peer_id:c,mark_conversation_as_read:0,group_id:C})}catch{}return{type:"Noop"}},async function(){return{type:"ActualizeComposerDraft",peerId:c}}]}case"UserClosedConvo":{const s=e.locks.convosCleanup.get(t.peerId);if(s&&s>1)return e.locks.convosCleanup.set(t.peerId,s-1),[];e.locks.convosCleanup.delete(t.peerId);const n=e.convos.get(t.peerId);return n?(a.cleanup(n),[]):[]}case"UserOpenedConvo_StickersKeywordsRequestCompleted":{const{response:s}=t;return s&&(e.stickersKeywords=(0,c.fromApiStickersKeywords)(s)),[]}default:return(0,o.exhaustivenessCheck)(t)}}},467959:(e,t,s)=>{"use strict";s.d(t,{handler:()=>c});var n=s(207739),r=s(345543),a=s(795947),i=s(503048),o=s(246919);const c=(e,t,s)=>{switch(t.type){case"LoadChatMembers":return[];case"UserOpenedConvoProfile":{const{peerId:n,isLinkWithHistory:r}=t,i=e.convos.get(n),o=e.ownerId;return i?c(e,{type:"UserOpenedConvoProfile_ConvoRequestCompleted",peerId:n,hasFailed:!1,isLinkWithHistory:r},s):[async function({api:e}){try{let t;return i||(t=await e.fetch("messages.getConversationsById",{peer_ids:n.toString(),extended:1,group_id:(0,a.getOwnerGroupId)(o)},{retries:3})),{type:"UserOpenedConvoProfile_ConvoRequestCompleted",peerId:n,hasFailed:!1,convoResponse:t,isLinkWithHistory:r}}catch(e){return{type:"UserOpenedConvoProfile_ConvoRequestCompleted",peerId:n,hasFailed:!0,isLinkWithHistory:r}}}]}case"UserOpenedConvoProfile_ConvoRequestCompleted":{const{peerId:c,convoResponse:d,hasFailed:l,isLinkWithHistory:u}=t,h=e.ownerId;if(l){if(r.isDev)throw new Error("Не удалось загрузить диалог");return[async function(){return{type:"Noop"}}]}d&&((0,a.insertConvos)(e,d.items||[],s),(0,a.insertPeers)(e,{apiUsers:d.profiles||[],apiGroups:d.groups||[],apiContacts:d.contacts||[]}));const p=e.convos.get(c);if(!p){if(r.isDev)throw new Error("Диалог не был найден");return[]}const m="ChatConvo"===p.kind&&0===p.members.memberIds.size&&i.canReadMembers(p)&&!e.locks.getConversationMembers.has(c);m&&e.locks.getConversationMembers.add(c);const g="ChatConvo"===p.kind&&p.acl.canSeeInviteLink,f=n.isChatPeerId(c);return m&&e.locks.setChatStickersDisplay.add(c),[m&&n.isChatPeerId(c)&&async function(){return{type:"LoadChatMembers",peerId:c}},g&&n.isChatPeerId(c)&&async function({api:e}){try{return{type:"UserOpenedConvoProfile_InviteLinksCompleted",peerId:c,isLinkWithHistory:u,response:await e.fetch("messages.getInviteLink",{peer_id:c,visible_messages_count:u?o.VISIBLE_MESSAGES_COUNT:0,reset:0,group_id:(0,a.getOwnerGroupId)(h)},{retries:1})}}catch{}return{type:"Noop"}},f&&async function({api:e}){try{return{type:"UserOpenedConvoProfile_UGCPackListsCompleted",peerId:c,response:await e.fetch("stickers.getUGCPackLists",{owner_ids:c.toString()},{retries:1})}}catch{}return{type:"Noop"}}]}case"UserOpenedConvoProfile_InviteLinksCompleted":{const{peerId:s,response:{link:n},isLinkWithHistory:r}=t,a=e.convos.get(s);return a&&"ChatConvo"===a.kind&&n?(i.replaceInviteLinks(a,{...a.inviteLinks,...r?{withHistory:n}:{noHistory:n}}),[]):[]}case"UserOpenedConvoProfile_UGCPackListsCompleted":{const{peerId:s,response:{lists:n}}=t,r=e.convos.get(s);if(!r||"ChatConvo"!==r.kind||!n[0])return[];const{can_hide_keyboard:a,can_edit:o,is_keyboard_hidden:c,items:d}=n[0];return i.setStickersParams(r,{canEdit:o??!1,canHideKeyboard:a,isKeyboardHidden:c,hasStickers:0!==d.length}),e.locks.setChatStickersDisplay.delete(s),[]}default:(0,r.exhaustivenessCheck)(t)}}},25124:(e,t,s)=>{"use strict";s.d(t,{handler:()=>c});var n=s(503048),r=s(429920),a=s(345543),i=s(795947),o=s(453934);const c=(e,t)=>{switch(t.type){case"UserPlayedMessage":{const{cmid:s,peerId:a}=t,o=e.convos.get(a),c=o&&n.findMessageByCmid(o,s),d=e.ownerId;return"Normal"===c?.kind&&r.canChangeMessagePlayedStatus(c)?[async function({api:e}){try{return{type:"UserPlayedMessage_RequestCompleted",hasFailed:1!==await e.fetch("messages.markAsPlayed",{peer_id:a,cmid:s,group_id:(0,i.getOwnerGroupId)(d)},{retries:1}),cmid:s,peerId:a}}catch{return{type:"UserPlayedMessage_RequestCompleted",hasFailed:!0,cmid:s,peerId:a}}}]:[]}case"UserPlayedMessage_RequestCompleted":if(!t.hasFailed){const{cmid:s,peerId:a}=t,i=e.convos.get(a),c=i&&(0,o.castDraft)(n.findMessageByCmid(i,s));if("Normal"!==c?.kind||!r.canChangeMessagePlayedStatus(c))return[];c.isPlayed=!0}return[];default:(0,a.exhaustivenessCheck)(t)}}},846102:(e,t,s)=>{"use strict";s.d(t,{handler:()=>r});var n=s(345543);const r=(e,t)=>{if("UserProfileInfo_Update"===t.type){const{user:s,profileInfo:n}=t;return n&&(e.viewer.profileInfo=n),s&&e.peers.set(s.id,s),[]}(0,n.exhaustivenessCheck)(t.type)}},406300:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(345543),r=s(795947);const a=(e,t)=>{switch(t.type){case"UserReadAllReactions":{const{peerId:s}=t;if(e.locks.readAllReactions.has(s))return[];e.locks.readAllReactions.add(s);const n=(0,r.getOwnerGroupId)(e.ownerId),a=e.convos.get(s);let i=new Map;return a&&(i=new Map(a.unreadReactions.entries()),a.unreadReactions.clear()),[async function({api:e}){try{const t=await e.fetch("messages.markReactionsAsRead",{peer_id:s,cmids:Array.from(i.keys()).join(","),group_id:n});return{type:"UserReadAllReactions_RequestCompleted",peerId:s,hasFailed:1!==t,unreadReactions:i}}catch{return{type:"UserReadAllReactions_RequestCompleted",peerId:s,hasFailed:!0,unreadReactions:i}}}]}case"UserReadAllReactions_RequestCompleted":{const{hasFailed:s,peerId:n,unreadReactions:r}=t;if(e.locks.readAllReactions.delete(n),!s)return[];const a=e.convos.get(n);return a&&(a.unreadReactions=new Map([...r,...a.unreadReactions])),[]}default:return(0,n.exhaustivenessCheck)(t)}}},183173:(e,t,s)=>{"use strict";s.d(t,{handler:()=>i});var n=s(345543),r=s(250122),a=s(548007);const i=(e,t)=>{switch(t.type){case"UserReadPost":{const{cmid:s,channelId:n}=t,i=e.channels.get(n);if(!i)return[];if("ChannelRestricted"===i.kind)return[];if(s<=i.inReadCmid)return[];a.readUntil(i,s),r.refreshChannels(e.organisers,i);const c=e.channelReadQueues.has(n);return e.channelReadQueues.set(n,i.inReadCmid),c?[]:[o(n)]}case"UserReadPost_ThrottleTimedOut":{const{channelId:s}=t,n=e.channelReadQueues.get(s);return n?[async function({api:e}){try{await e.fetch("channels.markAsRead",{channel_id:s,last_read_cmid:n})}catch(e){}return{type:"UserReadPost_RequestCompleted",channelId:s,readUntilCmid:n}}]:[]}case"UserReadPost_RequestCompleted":{const{channelId:s,readUntilCmid:n}=t,r=e.channelReadQueues.get(s);return r?n>=r?(e.channelReadQueues.delete(s),[]):[o(s)]:[]}default:return(0,n.exhaustivenessCheck)(t)}};function o(e){return async function(){return await(0,n.sleep)(300),{type:"UserReadPost_ThrottleTimedOut",channelId:e}}}},911149:(e,t,s)=>{"use strict";s.d(t,{handler:()=>i});var n=s(330310),r=s(345543),a=s(963196);const i=(e,t)=>{switch(t.type){case"UserReorderedFolders":{const{order:s}=t;return e.locks.reorderFolders?[]:(e.locks.reorderFolders=!0,n.reorderFolders(e.organisers.folders,s),[async function({api:e}){try{return{type:"UserReorderedFolders_ReorderRequestCompleted",hasFailed:1!==await e.fetch("messages.reorderFolders",{folder_ids:s.join(",")}),order:s}}catch(e){let t;return e instanceof a.IApi.RequestError&&(t=e.code),{type:"UserReorderedFolders_ReorderRequestCompleted",hasFailed:!0,error:t,order:s}}}])}case"UserReorderedFolders_ReorderRequestCompleted":{const{hasFailed:s}=t;if(e.locks.reorderFolders=!1,s){if(t.error);else if(r.isDev)throw new Error("Не удалось изменить порядок папок");return[]}return[]}default:(0,r.exhaustivenessCheck)(t)}}},313262:(e,t,s)=>{"use strict";s.d(t,{handler:()=>r});var n=s(345543);const r=(e,t)=>{if("UserReportAttach"===t.type){const{attach:e,reason:s}=t;let r;switch(e.kind){case"Photo":r=t=>t.fetch("photos.report",{reason:s,owner_id:e.ownerId,photo_id:e.id});break;case"Video":r=t=>t.fetch("video.report",{reason:s,owner_id:e.ownerId,video_id:e.id});break;default:(0,n.exhaustivenessCheck)(e)}return[async function({api:e}){try{r&&await r(e)}catch{}return{type:"Noop"}}]}(0,n.exhaustivenessCheck)(t.type)}},246919:(e,t,s)=>{"use strict";s.d(t,{VISIBLE_MESSAGES_COUNT:()=>i,handler:()=>o});var n=s(345543),r=s(503048),a=s(795947);const i=250,o=(e,t)=>{switch(t.type){case"UserRequestChatInvitationLink":{const{peerId:s,isLinkWithHistory:n}=t,r=e.ownerId;return[async function({api:e}){try{const t=await e.fetch("messages.getInviteLink",{peer_id:s,reset:0,visible_messages_count:n?i:0,group_id:(0,a.getOwnerGroupId)(r)},{retries:1});return{type:"UserRequestChatInvitationLink_RequestCompleted",hasFailed:!t.link,link:t.link,isLinkWithHistory:n,peerId:s}}catch(e){return{type:"UserRequestChatInvitationLink_RequestCompleted",hasFailed:!0,isLinkWithHistory:n,peerId:s}}}]}case"UserRequestChatInvitationLink_RequestCompleted":{const{peerId:s,link:n,isLinkWithHistory:a,hasFailed:i}=t,o=e.convos.get(s);return!i&&o&&"ChatConvo"===o.kind&&n?(r.replaceInviteLinks(o,{...o.inviteLinks,...a?{withHistory:n}:{noHistory:n}}),[]):[]}case"UserResetChatInvitationLink":{const{peerId:s}=t,n=e.ownerId;return[async function({api:e}){try{const t=await e.fetch("messages.getInviteLink",{peer_id:s,reset:1,visible_messages_count:i,group_id:(0,a.getOwnerGroupId)(n)},{retries:1}),r=await e.fetch("messages.getInviteLink",{peer_id:s,reset:0,visible_messages_count:0,group_id:(0,a.getOwnerGroupId)(n)},{retries:1});return{type:"UserResetChatInvitationLink_RequestCompleted",hasFailed:!t.link||!r.link,links:{withHistory:t.link,noHistory:r.link},peerId:s}}catch(e){return{type:"UserResetChatInvitationLink_RequestCompleted",hasFailed:!0,peerId:s,links:{}}}}]}case"UserResetChatInvitationLink_RequestCompleted":{const{peerId:s,links:n,hasFailed:a}=t,i=e.convos.get(s);return a||"ChatConvo"!==i?.kind?[]:n.noHistory&&n.withHistory?(r.replaceInviteLinks(i,n),[]):[]}default:return(0,n.exhaustivenessCheck)(t)}}},854854:(e,t,s)=>{"use strict";s.d(t,{handler:()=>l});var n=s(345543),r=s(33200),a=s(548007),i=s(377836),o=s(95233),c=s(885540),d=s(795947);const l=(e,t)=>{switch(t.type){case"UserScrolledChannelHistory":{const{channelId:s,direction:a,startCmid:i,possibleSkipped:o}=t,c=e.channels.get(s);if(!c)return[];if("ChannelRestricted"===c.kind)return[];if(e.locks.getChannelHistory.has(u(s,i)))return[];e.locks.getChannelHistory.add(u(s,i));let d,l=Math.min(r.POSTS_PER_PAGE,o||r.POSTS_PER_PAGE)+2;switch(a){case"backward":d=-1;break;case"forward":d=1-l;break;case"around":l=r.POSTS_PER_PAGE,d=-Math.floor(.8*l),c.inReadCmid===i&&(d=Math.max(-c.unreadCount,d));break;default:(0,n.exhaustivenessCheck)(a)}return[async function({api:e}){try{const t=await e.fetch("channels.getHistory",{channel_id:s,start_cmid:Math.max(i,1),count:l,offset:d,extended:1},{retries:5});let r,o;switch(a){case"backward":r=l===t.items.length,o=!0;break;case"around":{const e=t.items.filter((({cmid:e})=>e<=i)).length;r=e===l+d;const s=t.items.length-e;o=s===-d;break}case"forward":r=!0,o=l===t.items.length;break;default:(0,n.exhaustivenessCheck)(a)}return{type:"UserScrolledChannelHistory_RequestSucceed",channelId:s,startCmid:i,response:t,hasMoreBackward:r,hasMoreForward:o}}catch(e){return{type:"UserScrolledChannelHistory_RequestFailed",channelId:s,startCmid:i}}}]}case"UserScrolledChannelHistory_RequestSucceed":{const{channelId:s,startCmid:n,response:r,hasMoreBackward:l,hasMoreForward:h}=t;e.locks.getChannelHistory.delete(u(s,n));const p=e.channels.get(s);if(!p)return[];if("ChannelRestricted"===p.kind)return[];const m=[];return r.items.reverse().forEach(((t,s,n)=>{const{post:r,reactions:d}=(0,c.fromApiPost)(t),u=a.findPostByCmid(p,r.cmid),g=i.merge(r,"Node"===u?.kind?u.item:void 0);d.forEach((t=>{e.reactionsOld.set(t.id,t)})),0===s&&g.cmid>1&&l&&m.push({kind:"GapNode",fromCmid:i.resolveCmid(1),toCmid:i.resolveCmid(g.cmid-1)}),m.push({kind:"Node",item:g});const f=o.lastCmid(p.history);s===n.length-1&&void 0!==f&&h&&g.cmid<f&&m.push({kind:"GapNode",fromCmid:i.resolveCmid(g.cmid+1),toCmid:i.resolveCmid(f)})})),a.insertPosts(p,m),(0,d.insertPeers)(e,{apiUsers:r.profiles||[],apiGroups:r.groups||[],apiContacts:[]}),[]}case"UserScrolledChannelHistory_RequestFailed":{const{channelId:s,startCmid:n}=t;return e.locks.getChannelHistory.delete(u(s,n)),[]}default:return(0,n.exhaustivenessCheck)(t)}};function u(e,t){return`${e}-${t}`}},247463:(e,t,s)=>{"use strict";s.d(t,{handler:()=>l});var n=s(345543),r=s(503048),a=s(95233),i=s(429920),o=s(33200),c=s(795947),d=s(500955);const l=(e,t,s)=>{switch(t.type){case"UserScrolledConvoHistory":{const{peerId:s,direction:r,startCmid:a,possibleSkipped:d}=t,l=e.ownerId,h=e.convos.get(s);if(!h)return[];const p=u(s,a);if(e.locks.getHistory.has(p))return[];e.locks.getHistory.add(p);let m,g=Math.min(o.MESSAGES_PER_PAGE,d||o.MESSAGES_PER_PAGE)+2;switch(r){case"backward":m=-1;break;case"forward":m=1-g;break;case"around":g=o.MESSAGES_PER_PAGE,m=-Math.floor(.8*g),h.inReadBy===a&&(m=Math.max(-h.unreadCount,m));break;default:(0,n.exhaustivenessCheck)(r)}return[async function({api:e,perfStats:t}){try{t?.addEventData("open_chat",{loadHistoryStart:t.getCurrentTime()});const o=await e.fetch("messages.getHistory",{peer_id:s,start_cmid:a,count:g,offset:m,extended:1,group_id:(0,c.getOwnerGroupId)(l),fwd_extended:1},{retries:5});let d,u;switch(t?.addEventData("open_chat",{loadHistoryEnd:t.getCurrentTime()}),r){case"backward":d=g===o.items.length,u=!0;break;case"around":{const e=o.items.filter((({conversation_message_id:e})=>i.resolveCmid(e)<=a)).length;d=e===g+m;const t=o.items.length-e;u=t===-m;break}case"forward":d=!0,u=g===o.items.length;break;default:(0,n.exhaustivenessCheck)(r)}return{type:"UserScrolledConvoHistory_RequestSucceed",response:o,peerId:s,startCmid:a,hasMoreBackward:d,hasMoreForward:u}}catch(e){return{type:"UserScrolledConvoHistory_RequestFailed",peerId:s,startCmid:a}}}]}case"UserScrolledConvoHistory_RequestSucceed":{const{peerId:s,startCmid:n,response:a,hasMoreBackward:i,hasMoreForward:o}=t;e.locks.getHistory.delete(u(s,n));const l=e.convos.get(s);if(!l)return[];const h=a.items.map((e=>(0,d.fromApiMessage)(e).message));return r.insertMessages(l,h,{backward:i,forward:o}),(0,c.insertPeers)(e,{apiUsers:a.profiles||[],apiGroups:a.groups||[],apiContacts:[]}),[]}case"UserScrolledConvoHistory_RequestFailed":{const{peerId:s,startCmid:n}=t;return e.locks.getHistory.delete(u(s,n)),[]}case"MessagesHistoryWarmUp":{if(!s.vkm_history_warm_up)return[];const{convos:n,now:r}=t,{limit:c,offsetMultiplier:d,maxUnreadInclude:l,timeDiffInclude:h}=s.vkm_history_warm_up,p=Number(c)||o.MESSAGES_PER_PAGE,m=Number(d)||.8,g=Number(l)||void 0,f=Number(h)||6048e5;let C=n.filter((({history:e})=>{const t=a.lastNode({history:e,withFailed:!1,withDeleted:!1,withPending:!1});return!!t&&r-t.item.sentAt<=f}));g&&(C=C.filter((({unreadCount:e})=>e<=g)));const _=C.reduce(((t,s)=>{const{peerId:n,inReadBy:r,history:o}=s,c=r===a.lastCmid(o),d=c?i.resolveCmid(r-1):r,l=u(n,d);if(e.locks.getHistory.has(l))return t;e.locks.getHistory.add(u(n,d));const h=c?-1:-Math.floor(p*m);return[...t,{peerId:n,offset:h,startCmid:d,convo:s}]}),[]);return[async function({api:e}){let t;try{t=await e.fetch("messages.getDiffContent",{conversation_messages:JSON.stringify(_.map((({peerId:e,offset:t,startCmid:s})=>({peer_id:e,cmid_mark:s,offset:t,limit:p})))),extended:1})}catch{return{type:"MessagesHistoryWarmUp_RequestFailed",failedItems:_}}const s=t.items.reduce(((e,{messages:t},s)=>{const n=_[s];if(!n||!t)return e;const{convo:r,startCmid:a,offset:o}=n,c=t.filter((({conversation_message_id:e})=>i.resolveCmid(e)<=a)).length,d=c===p+o,l=t.length-c===-o;return[...e,{peerId:r.peerId,apiMessages:t,hasMoreBackward:d,hasMoreForward:l}]}),[]);return{type:"MessagesHistoryWarmUp_RequestSucceed",requestedItems:_,historyItems:s,apiUsers:t.profiles??[],apiGroups:t.groups??[],apiContacts:t.contacts??[]}}]}case"MessagesHistoryWarmUp_RequestSucceed":{const{requestedItems:s,historyItems:n,apiUsers:a,apiGroups:i,apiContacts:o}=t;for(const{peerId:t,startCmid:n}of s)e.locks.getHistory.delete(u(t,n));for(const{peerId:t,apiMessages:s,hasMoreBackward:a,hasMoreForward:i}of n){const n=e.convos.get(t);if(!n)continue;const o=s.map((e=>(0,d.fromApiMessage)(e).message));r.insertMessages(n,o,{backward:a,forward:i})}return(0,c.insertPeers)(e,{apiUsers:a,apiGroups:i,apiContacts:o}),[]}case"MessagesHistoryWarmUp_RequestFailed":{const{failedItems:s}=t;for(const{peerId:t,startCmid:n}of s)e.locks.getHistory.delete(u(t,n));return[]}default:(0,n.exhaustivenessCheck)(t)}};function u(e,t){return`${e}-${t}`}},807745:(e,t,s)=>{"use strict";s.d(t,{handler:()=>r});var n=s(345543);const r=(e,t)=>{switch(t.type){case"UserSeenHelpHint":return e.helpHints.delete(t.hintId)?[async function({api:e}){try{return{type:"UserSeenHelpHint_RequestCompleted",hasFailed:1!==await e.fetch("account.hideHelpHint",{hint_id:t.hintId},{retries:1})}}catch{return{type:"UserSeenHelpHint_RequestCompleted",hasFailed:!0}}}]:[];case"UserSeenHelpHint_RequestCompleted":return[];default:(0,n.exhaustivenessCheck)(t)}}},108704:(e,t,s)=>{"use strict";s.d(t,{handler:()=>c});var n=s(345543),r=s(503048),a=s(250122),i=s(95233),o=s(795947);const c=(e,t,s)=>{switch(t.type){case"UserSeenMessages":{const{fromCmid:n,toCmid:o,peerId:c}=t,l=e.convos.get(c);if(!l)return[];const u=i.around(l.history,n);if(void 0===u)return[];const h=u.nodes.reduce(((e,t)=>{const s="Node"===t.kind?t.item:void 0;return void 0!==s&&s.cmid>e&&s.cmid<=o&&!s.isOut&&(e=s.cmid),e}),n),p=l.inReadBy;r.readInUntil(l,h);const m=[...l.unreadReactions.keys()].filter((e=>e>=n&&e<=o));if(l.inReadBy===p&&0===m.length)return[];m.forEach((e=>r.readReactions(l,e))),a.refresh(e.organisers,l,s);const g=e.readQueues.get(c);return g?(g.inReadBy=l.inReadBy,m.forEach((e=>g.reactions.add(e))),[]):(e.readQueues.set(c,{inReadBy:l.inReadBy,reactions:new Set(m)}),[d(c,p)])}case"UserSeenMessages_ThrottleTimedOut":{const{peerId:n,prevInReadBy:r}=t;if(!e.convos.get(n))return e.readQueues.delete(n),[];const a=e.readQueues.get(n);if(!a)return[];const i=[];for(const e of a.reactions)if(i.push(e),a.reactions.delete(e),100===i.length)break;const d=a.inReadBy,l=e.ownerId,u=r<d,h=!1!==s.vkm_reactions&&i.length>0;return u||h?[async function({api:e}){try{await e.fetchMany([u&&{method:"messages.markAsRead",params:{peer_id:n,up_to_cmid:d,mark_conversation_as_read:0,group_id:(0,o.getOwnerGroupId)(l)}},h&&{method:"messages.markReactionsAsRead",params:{peer_id:n,cmids:i.join(","),group_id:(0,o.getOwnerGroupId)(l)}}])}catch(e){}return{type:"UserSeenMessages_RequestCompleted",peerId:n,readUntilCmid:d}}]:c(e,{type:"UserSeenMessages_RequestCompleted",peerId:n,readUntilCmid:d},s)}case"UserSeenMessages_RequestCompleted":{const{peerId:s,readUntilCmid:n}=t;if(!e.convos.get(s))return[];const r=e.readQueues.get(s);return r?r.inReadBy<=n&&0===r.reactions.size?(e.readQueues.delete(s),[]):[d(s,n)]:[]}default:return(0,n.exhaustivenessCheck)(t)}};function d(e,t){return async function(){return await(0,n.sleep)(500),{type:"UserSeenMessages_ThrottleTimedOut",prevInReadBy:t,peerId:e}}}},139750:(e,t,s)=>{"use strict";s.d(t,{handler:()=>i});var n=s(345543),r=s(377836),a=s(548007);const i=(e,t)=>{switch(t.type){case"UserSeenPost":{const{items:s,channelId:n}=t,i=e.channels.get(n);if(!i||"ChannelRestricted"===i.kind)return[];const c=0===e.seenPostsStatsQueues.size&&!e.locks.seenPostsStatsSend,d=(t,s)=>{e.seenPosts.has(t)||e.seenPosts.set(t,new Set);const n=e.seenPosts.get(t);n&&!n.has(s.cmid)&&(n.add(s.cmid),e.seenPostsStatsQueues.has(t)||e.seenPostsStatsQueues.set(t,[]),e.seenPostsStatsQueues.get(t)?.push(s),n.size>=60&&e.seenPosts.set(t,new Set(Array.from(n).slice(-30))))};return s.forEach((e=>{if(d(n,{cmid:e.post.cmid,time:e.time}),e.post.attaches.wall&&a.isChannelId(e.post.attaches.wall.authorId)){const t=a.resolveId(e.post.attaches.wall.authorId),s=r.resolveCmid(e.post.attaches.wall.id);d(t,{cmid:s,time:e.time})}})),[c&&0!==e.seenPostsStatsQueues.size&&o()]}case"UserSeenPost_ThrottleTimedOut":{e.locks.seenPostsStatsSend=!0;const t=[];return e.seenPostsStatsQueues.forEach(((e,s)=>{t.push(...e.map((e=>({ref:"im_channels",post_id:`${s}_${e.cmid}`,times:JSON.stringify([e.time])}))))})),e.seenPostsStatsQueues=new Map,[async function({api:e}){try{await e.fetch("stats.trackEvents",{events:JSON.stringify([{e:"view_post_time",views:t}])})}catch(e){}return{type:"UserSeenPost_RequestCompleted"}}]}case"UserSeenPost_RequestCompleted":return 0===e.seenPostsStatsQueues.size?(e.locks.seenPostsStatsSend=!1,[]):[o()];default:return(0,n.exhaustivenessCheck)(t)}};function o(){return async function(){return await(0,n.sleep)(5e3),{type:"UserSeenPost_ThrottleTimedOut"}}}},4472:(e,t,s)=>{"use strict";s.d(t,{handler:()=>i});var n=s(345543),r=s(548007),a=s(963196);const i=(e,t)=>{switch(t.type){case"UserSetChannelReaction":{const{channelId:s,cmid:n,reactionId:i}=t,c=e.channels.get(s);if(!c||"ChannelRestricted"===c.kind)return[];const d=r.findPostByCmid(c,n);if(!d||"Node"!==d.kind)return[];const l=d.item.reactionId,u=c.id,h=d.item.cmid;return o(d.item,i),[async function({api:e}){try{return await e.fetch("likes.add",{type:"post",owner_id:u,item_id:h,reaction_id:i}),{type:"UserSetChannelReaction_RequestCompleted",hasFailed:!1,cmid:n,channelId:s,reactionId:i,prevReactionId:l}}catch(e){let t;return e instanceof a.IApi.RequestError&&(t=e.code),{type:"UserSetChannelReaction_RequestCompleted",hasFailed:!0,cmid:n,error:t,channelId:s,reactionId:i,prevReactionId:l}}}]}case"UserSetChannelReaction_RequestCompleted":{const{hasFailed:s,channelId:n,cmid:a,prevReactionId:i}=t;if(!s)return[];const c=e.channels.get(n);if(!c||"ChannelRestricted"===c.kind)return[];const d=r.findPostByCmid(c,a);return d&&"Node"===d.kind?(o(d.item,i),[]):[]}case"UserUnsetChannelReaction":{const{channelId:s,cmid:n}=t,a=e.channels.get(s);if(!a||"ChannelRestricted"===a.kind)return[];const i=r.findPostByCmid(a,n);if(!i||"Node"!==i.kind||void 0===i.item.reactionId)return[];const c=i.item.reactionId,d=a.id,l=i.item.cmid;return o(i.item,void 0),[async function({api:e}){try{return await e.fetch("likes.delete",{type:"post",owner_id:d,item_id:l}),{type:"UserUnsetChannelReaction_RequestCompleted",hasFailed:!1,cmid:n,channelId:s,reactionId:c}}catch{return{type:"UserUnsetChannelReaction_RequestCompleted",hasFailed:!0,cmid:n,channelId:s,reactionId:c}}}]}case"UserUnsetChannelReaction_RequestCompleted":{const{hasFailed:s,channelId:n,cmid:a,reactionId:i}=t;if(!s)return[];const c=e.channels.get(n);if(!c||"ChannelRestricted"===c.kind)return[];const d=r.findPostByCmid(c,a);return d&&"Node"===d.kind?(o(d.item,i),[]):[]}default:(0,n.exhaustivenessCheck)(t)}};function o(e,t){const s=e.reactionId;if(e.reactionId=t,void 0!==s){const t=e.reactions.get(s);if(!t&&n.isDev)throw new Error("Реакция не найдена в списке реакций сообщения");t&&(t.count<=1?e.reactions.delete(s):t.count-=1)}if(void 0!==t){const s=e.reactions.get(t);s?s.count+=1:e.reactions.set(t,{reactionId:t,count:1})}}},956386:(e,t,s)=>{"use strict";s.d(t,{handler:()=>o});var n=s(345543),r=s(503048),a=s(795947),i=s(963196);const o=(e,t)=>{switch(t.type){case"UserSetMessageReaction":{const{peerId:s,cmid:n,reactionId:o,analyticsAppName:d,onFail:l}=t,u=e.convos.get(s);if(!u)return[];const h=r.findMessageByCmid(u,n);if(!h||"Normal"!==h.kind)return[];const p=h.reactionId,m=e.ownerId;return c(h,o,e.ownerId),[async function({api:e}){try{return{type:"UserSetMessageReaction_RequestCompleted",hasFailed:1!==await e.fetch("messages.sendReaction",{cmid:n,peer_id:s,reaction_id:o,group_id:(0,a.getOwnerGroupId)(m),from:d}),cmid:n,peerId:s,reactionId:o,prevReactionId:p,onFail:l}}catch(e){let t;return e instanceof i.IApi.RequestError&&(t=e.code),{type:"UserSetMessageReaction_RequestCompleted",hasFailed:!0,cmid:n,error:t,peerId:s,reactionId:o,prevReactionId:p,onFail:l}}}]}case"UserSetMessageReaction_RequestCompleted":{const{hasFailed:s,peerId:n,cmid:a,prevReactionId:i,onFail:o}=t;if(!s)return[];1011===t.error&&o();const d=e.convos.get(n);if(!d)return[];const l=r.findMessageByCmid(d,a);return l&&"Normal"===l.kind?(c(l,i,e.ownerId),[]):[]}case"UserUnsetMessageReaction":{const{peerId:s,cmid:n}=t,i=e.convos.get(s);if(!i)return[];const o=r.findMessageByCmid(i,n);if(!o||"Normal"!==o.kind||!o.reactionId)return[];const d=o.reactionId,l=e.ownerId;return c(o,void 0,e.ownerId),[async function({api:e}){try{return{type:"UserUnsetMessageReaction_RequestCompleted",hasFailed:1!==await e.fetch("messages.deleteReaction",{cmid:n,peer_id:s,group_id:(0,a.getOwnerGroupId)(l)}),cmid:n,peerId:s,reactionId:d}}catch{return{type:"UserUnsetMessageReaction_RequestCompleted",hasFailed:!0,cmid:n,peerId:s,reactionId:d}}}]}case"UserUnsetMessageReaction_RequestCompleted":{const{hasFailed:s,peerId:n,cmid:a,reactionId:i}=t;if(!s)return[];const o=e.convos.get(n);if(!o)return[];const d=r.findMessageByCmid(o,a);return d&&"Normal"===d.kind?(c(d,i,e.ownerId),[]):[]}default:(0,n.exhaustivenessCheck)(t)}};function c(e,t,s){const r=e.reactionId;if(e.reactionId=t,r){const t=e.reactions.get(r);if(!t&&n.isDev)throw new Error("Реакция не найдена в списке реакций сообщения");t&&(t.count<=1?e.reactions.delete(r):(t.count-=1,t.peerIds.delete(s)))}if(t){const n=e.reactions.get(t);n?(n.count+=1,n.peerIds=new Set([s,...n.peerIds].sort(((e,t)=>e-t)))):e.reactions.set(t,{reactionId:t,count:1,peerIds:new Set([s])})}}},421427:(e,t,s)=>{"use strict";s.d(t,{handler:()=>i});var n=s(330310),r=s(345543),a=s(795947);const i=(e,t,s)=>{switch(t.type){case"UserUpdatedFolder":{const{folderId:r,name:i,addPeerIds:c,removePeerIds:d}=t;if(e.locks.updateFolder.has(r))return[];if(function(e,t){if(new Set([...e].filter((e=>t.has(e)))).size)return!0;return!1}(c,d))throw new Error("Peer id не может одновременно находиться в списке на добавление и на удаление");e.locks.updateFolder.add(r);const l=e.organisers.folders.find((e=>e.id===r));if(!l)return[];const u=(0,a.getConvosByIds)(e,Array.from(d)),h=(0,a.getConvosByIds)(e,Array.from(c));return i&&n.setName(l,i),(0,a.removeConvosFromFolder)(e,l.id,u,s),(0,a.addConvosToFolder)(e,l.id,h,s),[o(r,i,c,d)]}case"UserUpdatedFolder_UpdateRequestCompleted":{const{hasFailed:s,folderId:n}=t;if(e.locks.updateFolder.delete(n),s&&r.isDev)throw new Error("Не удалось изменить папку");return[]}default:(0,r.exhaustivenessCheck)(t)}};function o(e,t,s,n){return async function({api:r}){let a=!1;const i={folder_id:e};t&&(i.name=t),s.size&&(i.add_included_peer_ids=[...s].join(",")),n.size&&(i.remove_included_peer_ids=[...n].join(","));try{a=1!==await r.fetch("messages.updateFolder",i)}catch(e){a=!0}return{type:"UserUpdatedFolder_UpdateRequestCompleted",hasFailed:a,folderId:e,addPeerIds:s,removePeerIds:n,name:t}}}},712789:(e,t,s)=>{"use strict";s.d(t,{handler:()=>r});var n=s(345543);const r=(e,t)=>{switch(t.type){case"VideoMessageShapesGetById":{const{shapeId:s}=t;return e.locks.getVideoMessageShapesById.has(s)||e.videoMessageShapes?.has(s)?[]:(e.locks.getVideoMessageShapesById.add(s),[async function({api:e,storage:t}){const n=t.get("videomessage-shapes");n&&(n.expiresAt=0);try{const t=await e.fetch("messages.getVideoMessageShapesByIds",{ids:s.toString()});return{type:"VideoMessageShapesGetById__RequestCompleted",shapeId:s,response:t,hasFailed:!Boolean(t)}}catch{return{type:"VideoMessageShapesGetById__RequestCompleted",shapeId:s,response:null,hasFailed:!0}}}])}case"VideoMessageShapesGetById__RequestCompleted":{const{response:s,shapeId:n}=t;if(e.locks.getVideoMessageShapesById.delete(n),!s)return[];const r=s.shapes.reduce(((e,t)=>(e.set(t.id,t.raw_path),e)),new Map);return e.videoMessageShapes=new Map([...e.videoMessageShapes??[],...r]),[]}default:return(0,n.exhaustivenessCheck)(t)}}},567359:(e,t,s)=>{"use strict";s.d(t,{createStore:()=>i});var n=s(395948),r=s(345543),a=s(80975);function i(e,t,s=a.initial,i,c,d,l){let u=!1;const h=r.isDev&&(0,n.devTools)();let p=[],[m,g]=s(t,i,c,d,l);h&&h.init(m);const f=s=>{if(!u)throw new Error("Стор еще не был активирован. Нужно вызвать store.start().");const[n,r]=(0,a.reducer)(m,s,t);h&&h.send(s,n);const i=m!==n;if(m=n,o(f,r,e,s.type),i)for(const e of p)e(n)};return{start:()=>{u||(u=!0,o(f,g,e,"Init"))},dispatch:f,subscribe:e=>(p.push(e),()=>{p=p.filter((t=>t!==e))}),featureFlags:t,getState:()=>m}}function o(e,t,s,n){0!==t.length&&setTimeout((()=>{for(const r of t)"function"==typeof r&&r(s).then(e).catch((e=>{s.logger.error(`[${n}] Необработанная ошибка редьюсера`,e)}))}))}},395948:(e,t,s)=>{"use strict";function n(){return"undefined"!=typeof window&&"__REDUX_DEVTOOLS_EXTENSION__"in window?window.__REDUX_DEVTOOLS_EXTENSION__.connect({serialize:{options:{map:!0,set:!0}}}):null}s.d(t,{devTools:()=>n})},80975:(e,t,s)=>{"use strict";s.d(t,{IMPORTANT_USERS_COUNT:()=>lt,initial:()=>it,reducer:()=>ot});var n=s(453934),r=s(474582),a=s(795947),i=s(345543),o=s(250122),c=s(81163),d=s(330310),l=s(703543),u=s(503048),h=s(207739),p=s(429920),m=s(841),g=s(236634),f=s(548007),C=s(377836),_=s(460167),v=s(952644),y=s(243860),k=s(883262),I=s(122519),w=s(33200),b=s(994541),R=s(736578),M=s(717479),S=s(584352),E=s(108704),A=s(255242),U=s(757061),T=s(632933),P=s(896567),F=s(626931),N=s(198359),x=s(268734),O=s(642667),q=s(475393),L=s(248934),D=s(82941),B=s(640341),H=s(554482),G=s(25124),z=s(807745),V=s(230527),W=s(779471),K=s(490867),j=s(387410),$=s(422510),Q=s(696163),J=s(467959),X=s(244550),Y=s(497417),Z=s(40946),ee=s(421427),te=s(576035),se=s(911149),ne=s(854854),re=s(822333),ae=s(417141),ie=s(474642),oe=s(246919),ce=s(613729),de=s(347751),le=s(953542),ue=s(255618),he=s(139750),pe=s(183173),me=s(846102),ge=s(457911),fe=s(958576),Ce=s(348330),_e=s(764162),ve=s(327950),ye=s(169664),ke=s(406450),Ie=s(175049),we=s(712789),be=s(59444),Re=s(300887),Me=s(956386),Se=s(4472),Ee=s(857758),Ae=s(886210),Ue=s(631728),Te=s(89586),Pe=s(336921),Fe=s(530330),Ne=s(528698),xe=s(247463),Oe=s(406300),qe=s(467635),Le=s(421660),De=s(851707),Be=s(603698),He=s(234950),Ge=s(791183),ze=s(189179),Ve=s(185866),We=s(144539),Ke=s(6246),je=s(869237),$e=s(919421),Qe=s(154551),Je=s(538975),Xe=s(921148),Ye=s(646987),Ze=s(192697),et=s(623127),tt=s(724738),st=s(868733),nt=s(53416),rt=s(313262);const at={ctrSubmit:!1,soundNotifications:!0,browserNotifications:!1,showRecommendations:!0,countOnlyNotMuted:!1,autoUnarchive:!0,transcriptAutoShow:!0,theme:"system",themeStyleId:k.SYSTEM_STYLE_ID,verticalFoldersView:!1,messageReactionAnimation:!0,businessNotify:!1,push:v.VIEWER_DEFAULT_PUSH_SETTINGS,teacherVerification:!1,fastActionsTrigger:"hoverAndRightClick",messageSelfMentionHighlighting:"none",eduAccountSwitchBanner:!0,autoExtendReactionPicker:!1,bubblesTheme:"default",autoPlayMedia:!0},it=(e,t,s,n,r)=>{const a=h.resolveId(t),i=s?h.resolveId(s):void 0;if(!h.isUserPeerId(a))throw Error("Viewer может быть только пользователем");if(void 0!==i&&!h.isUserPeerId(i)&&!h.isGroupPeerId(i))throw Error("Owner может быть только пользователем или группой");const c=(0,b.fromApiProfileType)(n),d={convoConn:{status:"loading",pts:0,reconnectAttempts:0},channelConn:{status:"running",ts:0,reconnectAttempts:0},viewer:{id:a,profileType:c,settings:at,profileInfo:{id:a},accounts:[]},ownerId:h.resolveId(),organisers:o.empty(),channels:new Map([[f.resolveId(0),{kind:"Channel",id:f.resolveId(0),name:"",description:[],activity:"",adminLevel:0,isVerified:!1,photos:{},inReadCmid:C.resolveCmid(0),unreadCount:0,isArchived:!1,isRepostsDisabled:!1,isMuted:!1,isClosed:!1,notificationsDisabledUntil:0,majorSortId:0,minorSortId:0,membersCount:0,isMember:!1,canMessage:!1,rights:{canPost:!1,canSendDonut:!1},pending:{},locks:{loading:!1,cleanUp:0},history:{confirmed:[],pending:[]},actionButton:{isEnabled:!1},mediaViewerCache:{items:[],hasPrev:!0,hasNext:!0}}]]),channelsRecommendationsIds:[],precreatedConvos:{peerIds:new Set,hasMore:!0},convos:new Map([[h.resolveId(),{kind:"UserConvo",peerId:h.resolveId(),unreadCount:0,majorSortId:0,minorSortId:0,inReadBy:p.resolveCmid(0),outReadBy:p.resolveCmid(0),isNew:!1,folderIds:new Set,peerFlags:0,canWrite:{allowed:!1,reason:"unknown"},push:{mode:"everything",disabledUntil:0},unreadExpireables:new Set,unreadReactions:new Map,entrypoint:null,history:{confirmed:[],pending:[]},mediaViewerCache:{items:[],hasPrev:!0,hasNext:!0},styleId:k.SYSTEM_STYLE_ID}]]),composerDrafts:{},channelComposerDrafts:{},commentsComposerDrafts:{},readQueues:new Map,seenPosts:new Map,seenPostsStatsQueues:new Map,channelReadQueues:new Map,peers:new Map([[h.resolveId(),{kind:"User",id:h.resolveId(),firstName:"...",firstNameGen:"...",firstNameAcc:"...",lastName:"...",lastNameGen:"...",lastNameAcc:"...",sex:"unknown",isVerified:!1,canCall:!0,followersCount:0,canChangeFriendship:!1,canMessage:!1,friendship:"unfamiliar",isBlacklisted:!1,isBlacklistedByMe:!1,isProfileClosed:!1,isDeactivated:!1,canInviteToChats:!1}]]),lastSeens:new Map,typings:new Map,convosSearchIndex:_.create(),locks:{getConversations:{all:!1,unread:!1,archive:!1,messageRequest:!1},getChannels:{all:!1,unread:!1},hideFilter:{all:!1,unread:!1,chats:!1,archive:!1,messageRequest:!1,businessNotify:!1},getHistory:new Set,getConversationRestrictedMembers:new Set,getConversationMembers:new Set,getConversationInfo:new Set,getPrecreatedConversations:!1,sendQueue:new Map,edit:new Set,convosCleanup:new Map,channelsCleanup:new Map,updateFriendshipOrMembership:new Set,convoActions:new Set,setChatStickersDisplay:new Set,messageActions:new Set,channelActions:new Set,channelPostActions:new Set,settings:new Set,contactList:!1,deleteFolder:new Set,updateFolder:new Set,reorderFolders:!1,getChannelHistory:new Set,changeMessageRequest:new Set,getPostCommentsHistory:new Set,likeActions:new Set,commentActions:new Set,getVideoMessageShapesById:new Set,loadStickers:new Set,seenPostsStatsSend:!1,invalidateMessageReactions:!1,loadStickersKeywords:!1,loadStickerPacks:!1,loadRecommendedFolders:!1,readAllReactions:new Set,sendComment:new Set,editPost:new Set,urlSnippets:{load:!1,throttle:!1}},hiddenPinnedMessages:new Map,helpHints:new Set,stickers:new Map,stickersKeywords:new Map,contacts:{items:new Map,contacts:new Map,hasMore:!0},importantMessages:{messages:new Map,hasMore:!0},hiddenBotKeyboards:new Set,reactionsOld:new Map,messageReactions:new Map,postReactions:new Map,importantUsers:null,channelsConfig:{recommendations:{lastCollapsedVersion:0,version:1}},videoMessageShapes:null,activeCallsCount:0,messageReactedPeers:new Map,convosFailedMessages:ze.DEFAULT_CONVOS_FAILED_MESSAGES_STORE,themeStyles:new Map,themeAppearances:new Map,themeBackgrounds:new Map,urlSnippetsCache:new Map,urlSnippetsQueue:new Set,onboardingTriggers:{userArchivedChat:!1},deviceId:"",eduIntegrationBanner:{isEnabled:!1,hiddenAt:null,hiddenCount:0}};if(0===a)return[d,[]];const l=void 0!==r&&r.viewer?.id===a&&r.viewer?.profileType===c&&(void 0===i||r.ownerId===i);return[l?{...d,...r}:d,[async function({storage:e,stats:t}){return e.identify(a),t.init(),{type:"Noop"}},()=>Promise.resolve({type:"InitialData",ownerId:i,withCache:l}),async({api:e,storage:t})=>{const s=await async function({api:e,storage:t}){const s=t.get("videomessage-shapes"),n=Math.round((new Date).getTime()/1e3),r=86400,a=s&&s.expiresAt>n;let i=null;if(a)i=s.response;else try{i=await e.fetch("messages.getVideoMessageShapes",{client_version:s?.response.version??0},{retries:3})}catch{}const o=i?{...i,shapes:[...s?.response.shapes||[],...i.shapes]}:null;!a&&o&&t.set("videomessage-shapes",{response:o,expiresAt:n+r});return o}({api:e,storage:t});return{type:"LoadVideoMessageShapes_RequestCompleted",videoMessageShapes:s}},async()=>e.vkm_reactions?{type:"InvalidateMessageReactions"}:{type:"Noop"}]]};function ot(e,t,s){if("TemporaryHackForResync"===t.type){const[t,n]=it(s,e.viewer.id,e.ownerId,"edu"===e.viewer.profileType?2:0);return t.organisers.filters.unread.headerNotMutedUnread=e.organisers.filters.unread.headerNotMutedUnread,[t,n]}const r=(0,n.createDraft)(e);let a;switch(t.type){case"Noop":a=[];break;case"InitialData":case"InitialData_RequestCompleted":case"InitialDataWithCached_RequestCompleted":case"InitialData_ChannelsReadyForUse":case"InitialData_ManagedGroupsFetched":case"InitialData_ThemeStylesLoaded":case"QueueConfigAndUsersFromSearch_RequestCompleted":a=ct(r,t,s);break;case"LoadVideoMessageShapes_RequestCompleted":a=dt(r,t,s);break;case"EngineBatchReceived":case"EngineBatchReceived_TypingsTimedOut":case"UpdateMessageRequestsCounter":case"UpdateMessageRequestsCounter_RequestCompleted":case"RefetchFoldersRequest_RequestCompleted":a=U.handler(r,t,s);break;case"ChannelEngineBatchReceived":a=T.handler(r,t,s);break;case"QueueBatchReceived":a=H.handler(r,t,s);break;case"MoreConvosNeeded":case"MoreConvosNeeded_RequestCompleted":a=q.handler(r,t,s);break;case"MorePrecreatedConvosNeeded":case"MorePrecreatedConvosNeeded_RequestCompleted":a=D.handler(r,t,s);break;case"MoreChannelsNeeded":case"MoreChannelsNeeded_RequestCompleted":a=L.handler(r,t,s);break;case"CacheUpdateReceived":a=B.handler(r,t,s);break;case"UserSeenMessages":case"UserSeenMessages_ThrottleTimedOut":case"UserSeenMessages_RequestCompleted":a=E.handler(r,t,s);break;case"UserHitSend":case"UserHitSend_RequestCompleted":case"ResendAllConvoFailedMessages":case"ResendFailedMessage":case"UserHitResendAllConvoFailedMessages":case"ResendAllFailedMessages":case"UserHitResendFailedMessage":case"UserHitSendWidget":case"UserHitSend_ErrorSnackbarShown":a=M.handler(r,t,s);break;case"UserHitEdit":case"UserHitEdit_Resend":case"UserHitEdit_CancelFailedEditing":case"UserHitEdit_RequestCompleted":a=S.handler(r,t,s);break;case"UserOpenedConvo":case"UserClosedConvo":case"UserOpenedConvo_ConvoRequestCompleted":case"UserOpenedConvo_StickersKeywordsRequestCompleted":a=A.handler(r,t,s);break;case"StickersCacheReceived":a=Re.handler(r,t,s);break;case"UserChangedFriendship":case"UserChangedFriendship_RequestCompleted":a=x.handler(r,t,s);break;case"UserChangedGroupMembership":case"UserChangedGroupMembership_RequestCompleted":a=O.handler(r,t,s);break;case"UserChangedSetting":case"UserChangedSetting_RequestCompleted":a=P.handler(r,t,s);break;case"SettingThemeUpdated":case"SettingThemeUpdated_RequestCompleted":a=F.handler(r,t,s);break;case"SettingExperimentalUpdated":case"SettingExperimentalUpdated_RequestCompleted":a=N.handler(r,t,s);break;case"UserChangedBubblesTheme":case"UserChangedBubblesTheme_RequestCompleted":a=De.handler(r,t,s);break;case"UserPlayedMessage":case"UserPlayedMessage_RequestCompleted":a=G.handler(r,t,s);break;case"UserSeenHelpHint":case"UserSeenHelpHint_RequestCompleted":a=z.handler(r,t,s);break;case"UserChangedConvo":case"UserChangedConvo_RequestCompleted":case"UserPinMessage":case"UserPinMessage_RequestCompleted":case"UserUnpinMessage":case"UserUnpinMessage_RequestCompleted":case"UserChangedMute":case"UserChangedMute_RequestCompleted":case"UserChangedBusinessNotify":case"UserChangedBusinessNotify_RequestCompleted":case"UserChangeForbidWritingAll":case"UserChangeForbidWritingAll_RequestCompleted":case"UserRestrictChatMemberToWrite":case"UserRestrictChatMemberToWrite_RequestCompleted":a=V.handler(r,t,s);break;case"UserChangedMessage":case"UserChangedMessage_RequestCompleted":case"UserDeleteMessage":case"UserDeleteMessage_RequestCompleted":case"UserDeleteFailedMessage":case"UserDeleteAllFailedMessage":case"UserRestoreMessage":case"UserRestoreMessage_RequestCompleted":a=W.handler(r,t,s);break;case"UserChangedCollapsedVersion":a=ae.handler(r,t,s);break;case"LoadContactList":case"LoadContactList_RequestCompleted":a=K.handler(r,t,s);break;case"UserHideFilter":case"UserHideFilter_Completed":case"UserUndoHideFilter":case"UserActualizeHideFilter":a=$.handler(r,t,s);break;case"UserAcceptedChatMessageRequest":case"UserRejectedMessageRequest":case"UserAcceptedChatMessageRequest_RequestCompleted":case"UserRejectedChatMessageRequest_RequestCompleted":a=j.handler(r,t,s);break;case"UserChangedChatTitle":case"UserChangedChatDescription":case"UserChangedChatTitle_RequestCompleted":case"UserChangedChatDescription_RequestCompleted":case"UserRemovedChatPhoto":case"UserSetChatPhoto":case"UserRemovedChatPhoto_RequestCompleted":case"UserChangedChatSettings":case"UserChangedChatSettings_RequestCompleted":a=Q.handler(r,t,s);break;case"UserOpenedConvoProfile":case"UserOpenedConvoProfile_ConvoRequestCompleted":case"UserOpenedConvoProfile_InviteLinksCompleted":case"UserOpenedConvoProfile_UGCPackListsCompleted":a=J.handler(r,t,s);break;case"UserChangedChatStickersDisplay":case"UserChangedChatStickersDisplay_RequestCompleted":a=X.handler(r,t,s);break;case"LoadImportantMessages":case"LoadImportantMessages_RequestCompleted":case"UserClosedImportantMessages":a=Y.handler(r,t,s);break;case"UserCreatedFolder":a=Z.handler(r,t,s);break;case"UserUpdatedFolder":case"UserUpdatedFolder_UpdateRequestCompleted":a=ee.handler(r,t,s);break;case"UserDeletedFolder":case"UserDeletedFolder_DeleteRequestCompleted":a=te.handler(r,t,s);break;case"UserReorderedFolders":case"UserReorderedFolders_ReorderRequestCompleted":a=se.handler(r,t,s);break;case"UserScrolledChannelHistory":case"UserScrolledChannelHistory_RequestSucceed":case"UserScrolledChannelHistory_RequestFailed":a=ne.handler(r,t,s);break;case"UserOpenedChannel":case"UserClosedChannel":case"UserOpenedChannel_ChannelRequestCompleted":a=re.handler(r,t,s);break;case"UserChangedChatMember":case"UserChangedChatMember_RequestCompleted":case"UserRemoveIncognitoMember":case"UserRemoveIncognitoMember_RequestCompleted":a=ie.handler(r,t,s);break;case"UserRequestChatInvitationLink":case"UserRequestChatInvitationLink_RequestCompleted":case"UserResetChatInvitationLink":case"UserResetChatInvitationLink_RequestCompleted":a=oe.handler(r,t,s);break;case"LoadChatMembers":case"LoadChatMembers_RequestComplete":a=ce.handler(r,t,s);break;case"LoadChatInfo":case"LoadChatInfo_RequestComplete":a=de.handler(r,t,s);break;case"UserChangedChannel":case"UserChangedChannel_RequestCompleted":case"UserSetChannelPhoto":case"UserUpdateChannelInfo":a=le.handler(r,t,s);break;case"UserChangedChannelPost":case"UserChangedChannelPost_RequestCompleted":a=ue.handler(r,t,s);break;case"UserSeenPost":case"UserSeenPost_ThrottleTimedOut":case"UserSeenPost_RequestCompleted":a=he.handler(r,t,s);break;case"UserReadPost":case"UserReadPost_ThrottleTimedOut":case"UserReadPost_RequestCompleted":a=pe.handler(r,t,s);break;case"UserLoadedCommentsHistory":case"UserLoadedCommentsHistory_RequestSucceed":case"UserLoadedCommentsHistory_RequestFailed":a=ge.handler(r,t,s);break;case"ChannelsOnboardingDone":case"ChannelsOnboardingDone_RequestSucceeded":case"ChannelsOnboardingDone_RequestFailed":a=fe.handler(r,t,s);break;case"UserChangedComposerDraft":case"UserClearedComposerDraft":case"ComposerDraftsUpdateNeeded":case"ActualizeComposerDraft":case"ActualizeComposerDraft_RequestCompleted":a=Ce.handler(r,t,s);break;case"ResetUpdatesCounter":case"ResetUpdatesCounter_RequestCompleted":a=_e.handler(r,t,s);break;case"UserProfileInfo_Update":a=me.handler(r,t,s);break;case"UserChangedMessageAttachment":case"UserChangedMessageAttachment_RequestCompleted":a=ve.handler(r,t,s);break;case"UserChangedComment":case"UserChangedComment_RequestCompleted":a=ke.handler(r,t,s);break;case"UserLoadedLikes":case"UserLoadedLikes_RequestCompleted":case"UserChangedLike":case"UserChangedLike_RequestCompleted":a=ye.handler(r,t,s);break;case"UserChangedBrowserNotifications":case"UserChangedBrowserNotifications_RequestCompleted":a=Ie.handler(r,t,s);break;case"UserSetMessageReaction":case"UserSetMessageReaction_RequestCompleted":case"UserUnsetMessageReaction":case"UserUnsetMessageReaction_RequestCompleted":a=Me.handler(r,t,s);break;case"ImportContact":a=Te.handler(r,t,s);break;case"VideoMessageShapesGetById":case"VideoMessageShapesGetById__RequestCompleted":a=we.handler(r,t,s);break;case"UserChangedPostAttachment":case"UserChangedPostAttachment_RequestCompleted":a=be.handler(r,t,s);break;case"PollConvoReactions":case"PollConvoReactions_RequestSucceed":a=Ee.handler(r,t,s);break;case"UserChangedChannelComposerDraft":case"UserClearedChannelComposerDraft":a=Ae.handler(r,t,s);break;case"UserHitPostSend":case"UserHitPostSend_RequestCompleted":a=Ue.handler(r,t,s);break;case"InvalidateMessageReactions":case"InvalidateMessageReactions_RequestCompleted":a=Pe.handler(r,t,s);break;case"UserChangedPushSetting":case"UserChangedPushSetting_RequestCompleted":a=Fe.handler(r,t,s);break;case"UserScrolledConvoHistory":case"UserScrolledConvoHistory_RequestSucceed":case"UserScrolledConvoHistory_RequestFailed":case"MessagesHistoryWarmUp":case"MessagesHistoryWarmUp_RequestSucceed":case"MessagesHistoryWarmUp_RequestFailed":a=xe.handler(r,t,s);break;case"UserReadAllReactions":case"UserReadAllReactions_RequestCompleted":a=Oe.handler(r,t,s);break;case"PollChannelPosts":case"PollChannelPosts_RequestSucceed":a=Le.handler(r,t,s);break;case"LoadRecommendedFolders":case"LoadRecommendedFolders_RequestComplete":a=Be.handler(r,t,s);break;case"UserHitCommentSend":case"UserHitCommentSend_RequestCompleted":case"UserHitCommentSend_HistoryRequestCompleted":a=Ve.handler(r,t,s);break;case"UserChangedCommentsComposerDraft":case"UserClearedCommentsComposerDraft":a=We.handler(r,t,s);break;case"UserHitEditComment":case"UserHitEditComment_RequestCompleted":a=Ke.handler(r,t,s);break;case"UserSetChannelReaction":case"UserSetChannelReaction_RequestCompleted":case"UserUnsetChannelReaction":case"UserUnsetChannelReaction_RequestCompleted":a=Se.handler(r,t,s);break;case"UserHideConversationsBar":a=je.handler(r,t,s);break;case"UserHideConvoBanner":case"UserHideConvoBannerTemporarily":a=$e.handler(r,t,s);break;case"UserHitPostEdit":case"UserHitPostEdit_RequestCompleted":a=Ye.handler(r,t,s);break;case"ConvoMediaViewerCacheRemoved":case"ConvoMediaViewerCacheInserted":a=Je.handler(r,t,s);break;case"ChannelMediaViewerCacheRemoved":case"ChannelMediaViewerCacheInserted":a=Xe.handler(r,t,s);break;case"SettingsFromApiLoaded":case"SettingsFromApiLoaded_RequestCompleted":a=Ze.handler(r,t,s);break;case"SettingsThemeStyleUpdated":case"SettingsThemeStyleUpdated_RequestCompleted":a=st.handler(r,t,s);break;case"UserLoadedUrlSnippets":case"UserLoadedUrlSnippets_RequestCompleted":case"UserLoadedUrlSnippets_ThrottleTimedOut":a=et.handler(r,t,s);break;case"HideEduIntegrationBanner":case"ShowEduIntegrationBanner":a=Ne.handler(r,t,s);break;case"UserReportAttach":a=rt.handler(r,t,s);break;default:(0,i.exhaustivenessCheck)(t)}r.convos.set(h.resolveId(),u.safeGet(e.convos,h.resolveId())),r.peers.set(h.resolveId(),h.safeGet(e.peers,h.resolveId())),r.channels.set(f.resolveId(0),f.safeGet(e.channels,f.resolveId(0)));const o=(0,n.finishDraft)(r);if(e.hiddenPinnedMessages!==o.hiddenPinnedMessages&&a.push((async function({storage:e}){return e.set("hidden-pinned-messages",Array.from(o.hiddenPinnedMessages.entries()).reduce(((e,[t,s])=>(e[t]=s,e)),{})),{type:"Noop"}})),e.hiddenBotKeyboards!==o.hiddenBotKeyboards&&a.push((async function({storage:e}){return e.set("hidden-bot-keyboards",o.hiddenBotKeyboards),{type:"Noop"}})),o.organisers.filters.businessNotify.isHidden&&"Noop"!==t.type&&"UserUndoHideFilter"!==t.type&&"visible"===document.visibilityState){const e=o.organisers.filters.businessNotify.unreadCount;a.push((async function(){return 0===e?{type:"Noop"}:{type:"UserUndoHideFilter",kind:"businessNotify"}}))}return[o,a]}const ct=(e,t,s)=>{switch(t.type){case"InitialData":{const{ownerId:n,withCache:o}=t,c=n?(0,a.getOwnerGroupId)(n):0,l=e.viewer.id,u=async({engine:e,api:t,storage:n,perfStats:a})=>{const u=await(0,ze.getConvosFailedMessagesFromStorage)(n);if(s.vkm_new_chunk_parser){y.dontUse__enableNewParser__hack();let e=!1,t=500;for(;!e;)try{await(0,r.default)(),e=!0}catch{await(0,i.sleep)(t),t=Math.min(2*t,2e3)}}if(o){const[e,s,n,r]=await t.fetchMany([{method:"account.getInfo",params:{fields:w.API_GET_INFO_FIELDS.join(",")}},{method:"account.getMulti",params:{fields:w.API_GET_MULTI_FIELDS.join(",")}},{method:"account.getProfileInfo",params:{}},{method:"notifications.getSettings",params:{}}],{retries:2,timeout:2e4});return{type:"InitialDataWithCached_RequestCompleted",responseMultiAccount:s,responseProfileInfo:n,serverUserSettings:{ctrSubmit:Boolean(e.messages_multiline_input),showRecommendations:!Boolean(e.messages_recommendation_list_hidden),countOnlyNotMuted:Boolean(e.show_only_not_muted_messages),autoUnarchive:Boolean(e.messages_auto_unarchive),transcriptAutoShow:Boolean(e.messages_transcript_auto_show),businessNotify:Boolean(e.business_notify_enabled),push:(0,R.fromApiViewerPushSettings)(r),teacherVerification:Boolean("1"===e.settings?.find((e=>"messages_show_banner_teacher_verification"===e.name))?.value)}}}const h=await t.fetch("messages.getLongPollServer",{need_pts:1,lp_version:e.version,group_id:c},{retries:1/0,usePrefetch:!0});if(!h.pts)throw new Error("Отсутствует pts");e.connect({...h,pts:h.pts});const[p,f,C,_,v,I,b,M,S,E,A,U]=await t.fetchMany([{method:"messages.getConversations",params:{count:w.CONVOS_PER_PAGE,group_id:c,extended:1}},{method:"messages.getConversationsById",params:{peer_ids:l.toString(),group_id:c,extended:1}},{method:"messages.getFolders",params:{with_peers:1,supported_types:d.getSupportedTypes(s)}},{method:"users.get",params:{}},0!==c&&{method:"groups.getById",params:{group_ids:String(c)}},{method:"messages.getCounters",params:{filter:"all"}},{method:"account.getInfo",params:{fields:w.API_GET_INFO_FIELDS.join(",")}},{method:"account.getHelpHints",params:{hints:w.API_GET_HELP_HINTS.join(",")}},{method:"account.getMulti",params:{fields:w.API_GET_MULTI_FIELDS.join(",")}},{method:"messages.getConfig",params:{}},{method:"account.getProfileInfo",params:{}},{method:"notifications.getSettings",params:{}}],{retries:1/0,timeout:2e4,usePrefetch:!0});a?.addEventData("start",{loadDataEnd:a.getCurrentTime()});const T=v?.groups?.[0],P=_[0];if(!P)throw new Error("Не удалось получить текущего пользователя");const[F,N]=ht(n,E.config),x=window.localStorage.getItem(w.STORAGE_DEVICE_ID_KEY)||(0,nt.nanoid)();window.localStorage.setItem(w.STORAGE_DEVICE_ID_KEY,x);const O=n.get("edu-integration-banner");return{type:"InitialData_RequestCompleted",responseViewer:P,responseMultiAccount:S,responseGroup:T,responseConvos:p,responseProfileInfo:A,responseViewerConvo:f,responseMessagesConfig:E,hasMoreConvos:p.items.length>=w.CONVOS_PER_PAGE,folders:C,activeCallsCount:I.calls||0,unreadCount:{messages:I.messages||0,messagesUnmuted:I.messages_unread_unmuted||0,archive:I.messages_archive_unread||0,archiveMentions:I.messages_archive_mentions_count||0,archiveTotal:I.messages_archive||0,messageRequest:I.message_requests||0,businessNotify:I.business_notify||0,businessNotifyTotal:I.business_notify_all||0,channelsTotal:I.channels?.total_count||0,channelsUnmuted:I.channels?.unmuted_count||0,folders:I.messages_folders||[]},convoLp:{pts:h.pts},hiddenPinnedMessages:n.get("hidden-pinned-messages"),hiddenBotKeyboards:n.get("hidden-bot-keyboards"),composerDrafts:m.validateRequiredFields(n.get("drafts")||{}),channelComposerDrafts:g.validateRequiredFields(n.get("channels-drafts")||{}),commentsComposerDrafts:n.get("comments-drafts")||{},businessNotifyManuallyHidden:!!n.get("business-notify-manually-hidden"),userSettings:{ctrSubmit:Boolean(b.messages_multiline_input),soundNotifications:n.get("settings-sound-notifications-on")??!0,browserNotifications:Boolean(n.get("settings-browser-notifications-on"))??!1,showRecommendations:!Boolean(b.messages_recommendation_list_hidden),countOnlyNotMuted:Boolean(b.show_only_not_muted_messages),autoUnarchive:Boolean(b.messages_auto_unarchive),transcriptAutoShow:Boolean(b.messages_transcript_auto_show),businessNotify:Boolean(b.business_notify_enabled),push:n.get("settings-push")??(0,R.fromApiViewerPushSettings)(U),teacherVerification:Boolean("1"===b.settings?.find((e=>"messages_show_banner_teacher_verification"===e.name))?.value),eduAccountSwitchBanner:F.eduAccountSwitchBanner,verticalFoldersView:F.verticalFoldersView,messageReactionAnimation:F.messageReactionAnimation,autoExtendReactionPicker:F.autoExtendReactionPicker,fastActionsTrigger:F.fastActionsTrigger,autoPlayMedia:F.autoPlayMedia,theme:F.theme,themeStyleId:s.vkm_theme_styles_settings&&n.get("theme-style-id")||k.SYSTEM_STYLE_ID,bubblesTheme:F.bubblesTheme,messageSelfMentionHighlighting:F.messageSelfMentionHighlighting},settingsWrittenToApi:N,helpHints:M.items.reduce(((e,t)=>(e.add(t.id),e)),new Set),conversationsBar:b.conversations_bar,convosFailedMessages:u,themeAppearances:n.get("theme-appearances")||new Map,themeBackgrounds:n.get("theme-backgrounds")||new Map,themeStyles:n.get("theme-styles")?.items||new Map,deviceId:x,eduIntegrationBanner:{isEnabled:!!s.vkm_edu_integration_banner&&!!E.config.messages_featureblocks_enabled?.enabled_items?.includes(w.EDU_INTEGRATION_BANNER_ID),hiddenAt:O?.hiddenAt??null,hiddenCount:O?.hiddenCount??0}}};return o?[async function(){return{type:"EngineBatchReceived",variant:{kind:"FromEngine",next:{kind:"Failure"},now:Date.now()}}},u]:[u]}case"InitialDataWithCached_RequestCompleted":e.viewer.profileInfo=(0,b.fromApiViewerProfileInfo)(t.responseProfileInfo),e.viewer.accounts=t.responseMultiAccount.items.map(b.fromApiViewerAccount),e.viewer.settings={...e.viewer.settings,...t.serverUserSettings};return[ut(e.viewer.id,e.ownerId,!0,s),async function({channelEngine:e}){return e&&s.me_channels?{type:"ChannelEngineBatchReceived",variant:{kind:"FromChannelEngine",next:{kind:"Failure"}}}:{type:"Noop"}}];case"InitialData_RequestCompleted":{e.eduIntegrationBanner=t.eduIntegrationBanner,e.convosFailedMessages=t.convosFailedMessages,e.convoConn={status:"running",pts:t.convoLp.pts,reconnectAttempts:0},e.deviceId=t.deviceId,e.activeCallsCount=t.activeCallsCount,e.hiddenPinnedMessages=new Map(Object.entries(t.hiddenPinnedMessages||{}).map((([e,t])=>[h.resolveId(parseInt(e)),p.resolveCmid(t)]))),e.hiddenBotKeyboards=t.hiddenBotKeyboards||new Set,e.composerDrafts=t.composerDrafts,e.channelComposerDrafts=t.channelComposerDrafts,e.commentsComposerDrafts=t.commentsComposerDrafts,s.vkm_sublists_in_folder&&(0,a.insertSublists)(e,t.folders.included_lists_info?.map(Ge.fromApiSublist));const n=(0,a.insertConvos)(e,t.responseConvos.items,s);(0,a.insertConvos)(e,t.responseViewerConvo.items,s),e.organisers.filters.businessNotify.isHidden=!!t.businessNotifyManuallyHidden,c.push(e.organisers.filters,"all",n,t.hasMoreConvos),0===t.unreadCount.archiveTotal&&c.push(e.organisers.filters,"archive",[],!1),0===t.unreadCount.messageRequest&&c.push(e.organisers.filters,"messageRequest",[],!1),c.updateCounters(e.organisers.filters,{unread:t.unreadCount.messages,unreadUnmuted:t.unreadCount.messagesUnmuted,archive:t.unreadCount.archive,archiveMentions:t.unreadCount.archiveMentions,archiveTotal:t.unreadCount.archiveTotal,messageRequests:t.unreadCount.messageRequest,businessNotify:t.unreadCount.businessNotify,businessNotifyTotal:t.unreadCount.businessNotifyTotal}),(0,a.insertFolders)(e,t.folders.items.map(He.fromApiFolder)),t.unreadCount.folders?.forEach((t=>{d.setUnreadCounters(e.organisers.folders,d.resolveId(t.folder_id),t.total_count,t.unmuted_count)})),l.updateCounters(e.organisers.channelFilters,{unread:t.unreadCount.channelsTotal,unreadUnmuted:t.unreadCount.channelsUnmuted,archiveTotal:0}),(0,a.insertPeers)(e,{apiUsers:[...t.responseConvos.profiles||[]],apiGroups:[...t.responseConvos.groups||[]],apiContacts:[...t.responseConvos.contacts||[]]}),e.viewer.profileInfo=(0,b.fromApiViewerProfileInfo)(t.responseProfileInfo),t.conversationsBar&&(e.conversationsBar=(0,Qe.fromApiConversationsBar)(t.conversationsBar));const{user:r}=(0,I.fromApiUser)(t.responseViewer);e.peers.set(r.id,r),e.viewer.id=r.id,e.viewer.accounts=t.responseMultiAccount.items.map(b.fromApiViewerAccount);const i=t.responseGroup?(0,I.fromApiGroup)(t.responseGroup):void 0;i&&e.peers.set(i.id,i);const o=i?i.id:r.id;return e.ownerId=o,e.viewer.settings=t.userSettings,e.helpHints=t.helpHints,e.themeStyles=t.themeStyles,e.themeAppearances=t.themeAppearances,e.themeBackgrounds=t.themeBackgrounds,[async function({engine:e}){return{type:"EngineBatchReceived",variant:{kind:"FromEngine",next:await e.poll(),now:Date.now()}}},ut(r.id,o,!1,s),async function({api:e}){try{return{type:"InitialData_ManagedGroupsFetched",groups:(await e.fetch("groups.get",{user_id:h.toRealId(r.id),filter:"editor",offset:0,count:1e3,extended:1},{retries:2})).items||[]}}catch{return{type:"Noop"}}},async function({api:e,channelEngine:t,storage:n}){if(!t||!s.me_channels)return{type:"Noop"};try{const s=async()=>{const t=n.get("channels-recomendations");if(!(!t||t.expiresAt<Date.now()))return{recommendedChannelIds:t.response,recommendationsVersion:t.version||1};const s=await e.fetch("channels.getRecommendations",{extended:0}),r=(s.items||[]).map((e=>f.resolveId(e.channel_id)));return n.set("channels-recomendations",{expiresAt:Date.now()+864e5,response:r,version:s.recommendations_version||1}),{recommendedChannelIds:r,recommendationsVersion:s.recommendations_version||1}},{recommendedChannelIds:r,recommendationsVersion:a}=await s(),i=n.get("selected-channels-from-search")||[],o=[...r,...i],c=await e.fetch("channels.getLongPollServer",{}),[d,l,u]=await e.fetchMany([{method:"channels.get",params:{count:w.CHANNELS_PER_PAGE,extended:1}},0!==o.length&&{method:"channels.getById",params:{channel_ids:o.map((e=>e.toString())).join(","),extended:1}},{method:"channels.getConfig",params:{}}],{retries:1/0});return t.connect(c),{type:"InitialData_ChannelsReadyForUse",channelLpTS:c.ts,channelsGetResponse:d,additionalChannelsResponse:l||void 0,recommendedChannelIds:r,channelsConfig:{recommendations:{lastCollapsedVersion:u.last_collapsed_recommendations_version||0,version:a}}}}catch{return{type:"Noop"}}},async function(){return{type:"SettingThemeUpdated",value:t.userSettings.theme}},async function(){return{type:"SettingsFromApiLoaded",value:t.settingsWrittenToApi}},s.vkm_theme_styles_settings&&ft(o),...s.vkm_history_warm_up?xe.handler(e,{type:"MessagesHistoryWarmUp",convos:n,now:Date.now()},s):[]]}case"QueueConfigAndUsersFromSearch_RequestCompleted":{const{queueConfig:n,importantUsers:r,selectedFromSearchConvos:i}=t;(0,a.insertConvos)(e,[...r.items,...i?.items??[]],s),(0,a.insertPeers)(e,{apiUsers:[...r.profiles??[],...i?.profiles??[]],apiGroups:[...r.groups??[],...i?.groups??[]],apiContacts:[...r.contacts??[],...i?.contacts??[]]});const o=r.items.reduce(((e,t)=>{const s=(0,qe.fromApiConvo)(t);return s&&e.add(s.convo.peerId),e}),new Set);e.importantUsers=o;const c=e.viewer.id;return[async function({queue:e}){return e.connect({user_id:h.toRealId(c),...n}),{type:"QueueBatchReceived",next:await e.poll()}}]}case"InitialData_ManagedGroupsFetched":return(0,a.insertPeers)(e,{apiGroups:t.groups,apiUsers:[],apiContacts:[]}),[];case"InitialData_ChannelsReadyForUse":{const{channelLpTS:s,channelsConfig:n,channelsGetResponse:r,recommendedChannelIds:i,additionalChannelsResponse:o}=t;if(e.channelConn.status="running",e.channelConn.ts=s,e.channelsConfig.recommendations=n.recommendations,o){const t=(0,a.insertChannels)(e,{apiChannels:o.items||[],apiGroups:o.groups||[]});i.forEach((s=>{-1!==t.findIndex((e=>e.id===s))&&e.channelsRecommendationsIds.push(s)}))}const c=(0,a.insertChannels)(e,{apiChannels:r.items||[],apiGroups:r.groups||[]}),d=(r.items?.length||0)>=w.CHANNELS_PER_PAGE;return l.push(e.organisers.channelFilters,"all",c,d),(0,a.insertPeers)(e,{apiUsers:[...r.profiles||[],...o?.profiles||[]],apiGroups:[...r.groups||[],...o?.groups||[]],apiContacts:[]}),[async function({channelEngine:e}){return e?{type:"ChannelEngineBatchReceived",variant:{kind:"FromChannelEngine",next:await e.poll()}}:{type:"Noop"}}]}case"InitialData_ThemeStylesLoaded":{const{themeStyles:s,themeAppearances:n,themeBackgrounds:r}=t;return e.themeStyles=s,e.themeAppearances=n,e.themeBackgrounds=r,[]}default:return[]}},dt=(e,t)=>"LoadVideoMessageShapes_RequestCompleted"===t.type?(e.videoMessageShapes=t.videoMessageShapes?.shapes.reduce(((e,{id:t,raw_path:s})=>(e.set(t,s),e)),new Map)??new Map,[]):[];const lt=10;function ut(e,t,s,n){const r=(0,a.getOwnerGroupId)(t);return async({api:t,storage:a,logger:i})=>{const o=a.get("selected-convos-from-search"),[c,d,l]=await t.fetchMany([{method:"queue.subscribe",params:{queue_ids:`onlfriends_${e},accountcounters_${e}`}},{method:"messages.searchConversations",params:{q:" ",count:lt,extended:1,group_id:r}},!s&&!!o?.length&&{method:"messages.getConversationsById",params:{peer_ids:o.join(","),extended:1,group_id:r}}],{retries:1/0}).catch((e=>{throw"messages.getConversationsById"===e.apiError?.method&&100===e.code&&i.error(`Какая-то ошибка с пустым peer_ids в messages.getConversationsById. Значение сохранённых бесед selectedFromSearchConvosId: ${o}, typeof selectedFromSearchConvosId: ${typeof o}, stringyfied selectedFromSearchConvosId: ${JSON.stringify(o)}`,e),e}));return{type:"QueueConfigAndUsersFromSearch_RequestCompleted",queueConfig:c,importantUsers:d,selectedFromSearchConvos:l,featureFlags:n}}}const ht=(e,t)=>{const s=e.get("settings-bubbles-theme"),n=e.get("settings-right-click-actions-enabled"),r=e.get("settings-auto-play-media-enabled"),a=e.get("folders-view-vertical"),i=e.get("message-reactions-animation"),o=e.get("settings-edu-account-switch-banner-on"),c=e.get("settings-auto-extend-reaction-picker"),d=e.get("settings-message-self-mention-highlighting"),l=e.get("theme"),u={bubblesTheme:gt(t.bubble_theme??s),fastActionsTrigger:Ct(t.fast_action_type??n),autoPlayMedia:r??at.autoPlayMedia,verticalFoldersView:t.vertical_folders_view??a??at.verticalFoldersView,messageReactionAnimation:t.message_reactions_animation??i??at.messageReactionAnimation,eduAccountSwitchBanner:t.edu_account_switch_banner??o??at.eduAccountSwitchBanner,autoExtendReactionPicker:t.auto_extend_reactions_picker??c??at.autoExtendReactionPicker,messageSelfMentionHighlighting:pt(t.message_self_mention_highlighting??d),theme:mt(t.theme??l)},h={};return void 0===t.bubble_theme&&void 0!==s&&(h.bubble_theme="enabled"===s),void 0===t.vertical_folders_view&&void 0!==a&&(h.vertical_folders_view=a),void 0===t.message_reactions_animation&&void 0!==i&&(h.message_reactions_animation=i),void 0===t.edu_account_switch_banner&&void 0!==o&&(h.edu_account_switch_banner=o),void 0===t.auto_extend_reactions_picker&&void 0!==c&&(h.auto_extend_reactions_picker=c),void 0===t.message_self_mention_highlighting&&void 0!==d&&(h.message_self_mention_highlighting=d),void 0===t.theme&&void 0!==l&&(h.theme=l),[u,h]},pt=e=>{switch(e){case"primary":case"secondary":return e;default:return at.messageSelfMentionHighlighting}},mt=e=>{switch(e){case"light":case"dark":case"system":return e;default:return at.theme}},gt=e=>{switch(e){case"enabled":case!0:return"enabled";case"disabled":case!1:return"disabled";case"default":return"default";default:return at.bubblesTheme}};function ft(e,t="ru"){const s=(0,a.getOwnerGroupId)(e);return async({api:e,storage:n})=>{const r=n.get("theme-styles"),a=n.get("theme-appearances")||new Map,i=n.get("theme-backgrounds")||new Map,[o,c,d,l]=await e.fetchMany([{method:"messages.enumerateAppearances",params:{group_id:s}},{method:"messages.enumerateBackgrounds",params:{group_id:s}},{method:"messages.getConversationStyles",params:{show_hidden:1}},{method:"messages.getConversationStylesLang",params:{lang:t,version_hash:r?.langVersionHash}}],{retries:1/0}),u=o.appearances.reduce(((e,t)=>{const s=k.resolveAppearanceId(t.id),n=a.get(s);return(!n||n.updateTime<t.update_time)&&e.push(s),e}),[]),h=c.backgrounds.reduce(((e,t)=>{const s=k.resolveBackgroundId(t.id),n=i.get(s);return(!n||n.updateTime<t.update_time)&&e.push(s),e}),[]);if(0!==u.length||0!==h.length){const[t,s]=await e.fetchMany([0!==u.length&&{method:"messages.getAppearances",params:{appearance_ids:u.map((e=>e.toString())).join(",")}},0!==h.length&&{method:"messages.getBackgrounds",params:{background_ids:h.map((e=>e.toString())).join(",")}}],{retries:1/0});t?.appearances.forEach((e=>{const t=(0,tt.fromApiAppearance)(e);a.set(t.id,t)})),s?.backgrounds.forEach((e=>{const t=(0,tt.fromApiBackground)(e);i.set(t.id,t)})),n.set("theme-appearances",a),n.set("theme-backgrounds",i)}const p=l.not_changed&&l.lang===r?.lang,m=l.styles.reduce(((e,t)=>(e.set(t.id,t.value),e)),new Map),g=d.items.reduce(((e,t)=>{const s=p?r?.items.get(k.resolveStyleId(t.id))?.title:m.get(t.id);if(!s)return e;const n=(0,tt.fromApiStyle)(t,s);return e.set(n.id,n),e}),new Map);return n.set("theme-styles",{items:g,langVersionHash:l.version_hash,lang:"ru"}),{type:"InitialData_ThemeStylesLoaded",themeStyles:g,themeAppearances:a,themeBackgrounds:i}}}const Ct=e=>{switch(e){case"hover":case!1:return"hover";case"rightClick":case"right_button_click":case!0:return"rightClick";case"hoverAndRightClick":case"hover_and_right_button_click":return"hoverAndRightClick";default:return at.fastActionsTrigger}}},815907:(e,t,s)=>{"use strict";s.d(t,{initConfig:()=>r});var n=s(453934);function r(){(0,n.enableMapSet)()}},661020:(e,t,s)=>{"use strict";s.d(t,{MediaScopeStats:()=>a});const n=(0,s(977053).partConfigEnabled)("messenger_mediascope_stats_collect"),r={vk:{open:"23112",close:"25112",active:"24112"},vkme:{open:"23122",close:"25122",active:"24122"},mvk:{open:"23112",close:"25112",active:"24112"}};const a=new class{constructor(){this.sendRequest=e=>{const t=r[this.platform][e];t&&("hidden"===document.visibilityState&&void 0!==navigator.sendBeacon?navigator.sendBeacon(`https://${t}.ms.vk.com`):fetch(`https://${t}.ms.vk.com`,{method:"HEAD",mode:"no-cors"}).catch((()=>{})))},this.stopStatsCollecting=()=>{clearInterval(this.timerId),this.sendRequest("close")},this.startStatsCollecting=()=>{this.sendRequest("open"),this.timerId=setInterval((()=>{this.sendRequest("active")}),1e4)},this.handleVisibilityChange=()=>{"hidden"===document.visibilityState?this.stopStatsCollecting():this.startStatsCollecting()},this.start=e=>{n&&(this.platform=e,this.startStatsCollecting(),document.addEventListener("visibilitychange",this.handleVisibilityChange))},this.stop=()=>{this.platform&&(this.stopStatsCollecting(),document.removeEventListener("visibilitychange",this.handleVisibilityChange))}}}},66502:(e,t,s)=>{"use strict";s.d(t,{screenWakeLocker:()=>n});const n=new class{_onVisibilityChange(){this.wakeLockSentinel&&"visible"===document.visibilityState&&this.lock().then((()=>{})).catch(console.error)}requestWakeLock(){return navigator.wakeLock?this.wakeLockSentinel?Promise.resolve():navigator.wakeLock.request("screen").then((e=>{this.wakeLockSentinel=e})):Promise.reject()}isLocked(){return!!this.wakeLockSentinel&&!this.wakeLockSentinel.released}lock(){return this.requestWakeLock().then((()=>{this.wakeLockSentinel&&document.addEventListener("visibilitychange",this.onVisibilityChange)})).catch((()=>{}))}unlock(){return this.wakeLockSentinel?(document.removeEventListener("visibilitychange",this.onVisibilityChange),this.wakeLockSentinel.release().finally((()=>{this.wakeLockSentinel=null}))):Promise.resolve()}constructor(){this.onVisibilityChange=this._onVisibilityChange.bind(this)}}},608798:(e,t,s)=>{"use strict";s.d(t,{IdleManager:()=>c});var n=s(195763),r=s(15042),a=s(433830),i=s(66502);const o=r.browser.iphone||r.browser.ipad||r.browser.ipod;class c extends n.default{stop(){this.started=!1,l(this.opts.element,this.opts.triggerEvents,this.cbActive),(0,a.isMvk)()&&this._isTopLevel()&&h()&&l(document,h(),this.onVisiblityChange),(0,a.isMvk)()&&o||(l(this.opts.focusElement,"focus",this.cbActive),l(this.opts.focusElement,"blur",this.cbInactive)),clearTimeout(this.setIdleTo),clearTimeout(this.checkIdleCbTo),clearTimeout(this.sendCbTO),this.is_idle=!0,this.opts.parentManager&&this.opts.parentManager.off("idle",this.cbInactive)}idle(e){this.is_idle=!0,e||this.opts.onIdleCb(),this.emit("idle")}unidle(e){this.is_idle=!1,e||this.opts.onUnIdleCb(),this.emit("unidle")}start(){this.started=!0,!(0,a.isMvk)()&&r.browser.mobile||(this.is_idle=!this._isFocused(),this.opts.parentManager&&this.opts.parentManager.on("idle",this.cbInactive),(0,a.isMvk)()&&this._isTopLevel()&&h()&&d(document,h(),this.onVisiblityChange),(0,a.isMvk)()&&o||(d(this.opts.focusElement,"focus",this.cbActive),d(this.opts.focusElement,"blur",this.cbInactive)),clearTimeout(this.checkIdleCbTo),this.checkIdleCb(),this.checkIdleCbTo=setTimeout(this.checkIdleCb,this.opts.idleTimeout))}constructor(e){super(),this.started=!1,this.is_idle=!0,this.activeTimeStart=null,this.checkIdleCb=()=>{this.started&&(d(this.opts.element,this.opts.triggerEvents,this.cbActive),clearTimeout(this.setIdleTo),this.setIdleTo=setTimeout(this.cbInactive,this.opts.idleTimeout))},this.cbActive=()=>{this.started&&(this.activeTimeStart=(new Date).getTime(),clearTimeout(this.setIdleTo),this.is_idle&&(this.is_idle=!1,clearTimeout(this.sendCbTO),this.sendCbTO=setTimeout((()=>{this.emit("unidle"),this.opts.onUnIdleCb&&this.opts.onUnIdleCb()}),100)),l(this.opts.element,this.opts.triggerEvents,this.cbActive),clearTimeout(this.checkIdleCbTo),this.checkIdleCbTo=setTimeout(this.checkIdleCb,this.opts.idleTimeout))},this.cbInactive=()=>{this.started&&(i.screenWakeLocker.isLocked()||(this.activeTimeStart=null,this.is_idle||(this.is_idle=!0,clearTimeout(this.sendCbTO),this.sendCbTO=setTimeout((()=>{this.emit("idle"),this.opts.onIdleCb&&this.opts.onIdleCb()}),100)),clearTimeout(this.checkIdleCbTo),l(this.opts.element,this.opts.triggerEvents,this.cbActive),d(this.opts.element,this.opts.triggerEvents,this.cbActive),this.checkIdleCbTo=setTimeout(this.checkIdleCb,this.opts.idleTimeout)))},this.getActiveTime=()=>!this.is_idle&&this.activeTimeStart?(new Date).getTime()-this.activeTimeStart:0,this.onVisiblityChange=()=>{"visible"===u()?this.cbActive():this.cbInactive()},this._isTopLevel=()=>{const{focusElement:e}=this.opts;return e===window||e===document},this._isFocused=()=>{const{focusElement:e}=this.opts;if(this._isTopLevel()){const e=u();return"string"==typeof e&&"visible"===e}return document.activeElement===e},this.opts={triggerEvents:"mousemove keydown",onIdleCb:()=>{},onUnIdleCb:()=>{},focusElement:e.element,idleTimeout:3e4,...e}}}function d(e,t,s){(0,a.isMvk)()?window.addEvent(e,t,s,{passive:!0}):window.addEvent(e,t,s)}function l(e,t,s){(0,a.isMvk)()?window.removeEvent(e,t,s,{passive:!0}):window.removeEvent(e,t,s)}function u(){return document.visibilityState||document.webkitVisibilityState}function h(){let e="visibilitychange";return document.visibilityState||(document.webkitVisibilityState?e+="webkit":e=""),e}},923562:(e,t,s)=>{"use strict";e.exports=s.p+"27cd5b4a8c2a8a0e12d1.js"},497326:(e,t,s)=>{"use strict";function n(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}s.d(t,{default:()=>n})}}]);try{stManager.done("dist/web/chunks/05cf136b.87547dc3.js")}catch(e){}