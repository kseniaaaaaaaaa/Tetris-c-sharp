"use strict";(self.webpackChunkvkweb=self.webpackChunkvkweb||[]).push([[46140],{419249:(e,t,i)=>{i.d(t,{ChromecastState:()=>u,HttpConnectionType:()=>c,Observable:()=>s.Observable,PlaybackState:()=>r,Player:()=>$i,Subscription:()=>s.Subscription,Surface:()=>l,VERSION:()=>a,VideoFormat:()=>o,VideoQuality:()=>s.VideoQuality});var s=i(877741);const a="2.0.100";var r,n,o,h,u,c,d,l;(n=r||(r={})).STOPPED="stopped",n.READY="ready",n.PLAYING="playing",n.PAUSED="paused",function(e){e.MPEG="MPEG",e.DASH="DASH_SEP",e.DASH_SEP="DASH_SEP",e.DASH_SEP_VK="DASH_SEP",e.DASH_WEBM="DASH_WEBM",e.DASH_WEBM_AV1="DASH_WEBM_AV1",e.DASH_WEBM_VK="DASH_WEBM",e.DASH_ONDEMAND="DASH_ONDEMAND",e.DASH_ONDEMAND_VK="DASH_ONDEMAND",e.DASH_LIVE="DASH_LIVE",e.DASH_LIVE_CMAF="DASH_LIVE_CMAF",e.DASH_LIVE_WEBM="DASH_LIVE_WEBM",e.HLS="HLS",e.HLS_ONDEMAND="HLS_ONDEMAND",e.HLS_JS="HLS",e.HLS_LIVE="HLS_LIVE",e.HLS_LIVE_CMAF="HLS_LIVE_CMAF",e.WEB_RTC_LIVE="WEB_RTC_LIVE"}(o||(o={})),function(e){e.SCREEN="SCREEN",e.CHROMECAST="CHROMECAST"}(h||(h={})),function(e){e.NOT_AVAILABLE="NOT_AVAILABLE",e.AVAILABLE="AVAILABLE",e.CONNECTING="CONNECTING",e.CONNECTED="CONNECTED"}(u||(u={})),function(e){e.HTTP1="http1",e.HTTP2="http2",e.QUIC="quic"}(c||(c={})),function(e){e.None="none",e.Requested="requested",e.Applying="applying"}(d||(d={})),function(e){e.NONE="none",e.INLINE="inline",e.FULLSCREEN="fullscreen",e.SECOND_SCREEN="second_screen",e.PIP="pip"}(l||(l={}));class p{connect(){cast.framework.CastContext.getInstance()?.requestSession()}disconnect(){cast.framework.CastContext.getInstance()?.getCurrentSession()?.endSession(!0)}stopMedia(){return new Promise(((e,t)=>{cast.framework.CastContext.getInstance()?.getCurrentSession()?.getMediaSession()?.stop(new chrome.cast.media.StopRequest,e,t)}))}toggleConnection(){(0,s.isNonNullable)(this.connection$.getValue())?this.disconnect():this.connect()}setVolume(e){const t=this.connection$.getValue();(0,s.isNullable)(t)||(t.remotePlayer.volumeLevel=e,t.remotePlayerController.setVolumeLevel())}setMuted(e){const t=this.connection$.getValue();(0,s.isNullable)(t)||e!==t.remotePlayer.isMuted&&t.remotePlayerController.muteOrUnmute()}destroy(){this.subscription.unsubscribe()}initListeners(){const e=new cast.framework.RemotePlayer,t=new cast.framework.RemotePlayerController(e),i=cast.framework.CastContext.getInstance();this.subscription.add((0,s.fromEvent)(i,cast.framework.CastContextEventType.SESSION_STATE_CHANGED).subscribe((e=>{switch(e.sessionState){case cast.framework.SessionState.SESSION_STARTED:case cast.framework.SessionState.SESSION_STARTING:case cast.framework.SessionState.SESSION_RESUMED:this.contentId=i.getCurrentSession()?.getMediaSession()?.media.contentId;break;case cast.framework.SessionState.NO_SESSION:case cast.framework.SessionState.SESSION_ENDING:case cast.framework.SessionState.SESSION_ENDED:case cast.framework.SessionState.SESSION_START_FAILED:this.contentId=void 0;break;default:return(0,s.assertNever)(e.sessionState)}}))).add((0,s.merge)((0,s.fromEvent)(i,cast.framework.CastContextEventType.CAST_STATE_CHANGED).pipe((0,s.tap)((e=>{this.log({message:`[cast.framework.RemotePlayerEventType.CAST_STATE_CHANGED]: ${JSON.stringify(e)}`})})),(0,s.map)((e=>e.castState))),(0,s.observableFrom)([i.getCastState()])).pipe((0,s.filterChanged)(),(0,s.map)(m),(0,s.tap)((e=>{this.log({message:`realCastState$: ${e}`})}))).subscribe(this.realCastState$)).add(this.realCastState$.subscribe((a=>{const r=a===u.CONNECTED,n=(0,s.isNonNullable)(this.connection$.getValue());if(r&&!n){const a=i.getCurrentSession();(0,s.assertNonNullable)(a);const r=a.getCastDevice(),n=a.getMediaSession()?.media.contentId;((0,s.isNullable)(n)||n===this.contentId)&&(this.log({message:"connection created"}),this.connection$.next({remotePlayer:e,remotePlayerController:t,session:a,castDevice:r}))}else!r&&n&&(this.log({message:"connection destroyed"}),this.connection$.next(void 0));this.castState$.next(a===u.CONNECTED?(0,s.isNonNullable)(this.connection$.getValue())?u.CONNECTED:u.AVAILABLE:a)})))}initializeCastApi(){let e,t,i;try{e=cast.framework.CastContext.getInstance(),t=chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,i=chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED}catch{return}try{e.setOptions({receiverApplicationId:this.params.receiverApplicationId??t,autoJoinPolicy:i}),this.initListeners()}catch(e){this.errorEvent$.next({id:"ChromecastInitializer",category:s.ErrorCategory.EXTERNAL_API,message:"[initializeCastApi] failed",thrown:e})}}constructor(e){this.connection$=new s.ValueSubject(void 0),this.castState$=new s.ValueSubject(u.NOT_AVAILABLE),this.errorEvent$=new s.Subject,this.realCastState$=new s.ValueSubject(u.NOT_AVAILABLE),this.subscription=new s.Subscription,this.params=e,this.log=this.params.dependencies.logger.createComponentLog("ChromecastInitializer");const t="chrome"in window;if(this.log({message:`[constructor] receiverApplicationId: ${this.params.receiverApplicationId}, isDisabled: ${this.params.isDisabled}, isSupported: ${t}`}),e.isDisabled||!t)return;const i=(0,s.isNonNullable)(window.chrome?.cast),a=!!window.__onGCastApiAvailable;i?this.initializeCastApi():(window.__onGCastApiAvailable=e=>{delete window.__onGCastApiAvailable,e&&this.initializeCastApi()},a||(e=>new Promise(((t,i)=>{const s=document.createElement("script");s.setAttribute("src",e),s.onload=()=>t,s.onerror=()=>i,document.body.appendChild(s)})))("https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1").catch((()=>this.errorEvent$.next({id:"ChromecastLoading",category:s.ErrorCategory.NETWORK,message:"Script loading failed!"}))))}}const m=e=>{switch(e){case cast.framework.CastState.NO_DEVICES_AVAILABLE:return u.NOT_AVAILABLE;case cast.framework.CastState.NOT_CONNECTED:return u.AVAILABLE;case cast.framework.CastState.CONNECTING:return u.CONNECTING;case cast.framework.CastState.CONNECTED:return u.CONNECTED;default:return(0,s.assertNever)(e)}};var f;!function(e){e[e.OFFSET_P=0]="OFFSET_P",e[e.PLAYBACK_SHIFT=1]="PLAYBACK_SHIFT",e[e.DASH_CMAF_OFFSET_P=2]="DASH_CMAF_OFFSET_P"}(f||(f={}));var g=(e,t=0,i=f.OFFSET_P)=>{switch(i){case f.OFFSET_P:return e.replace("_offset_p",0===t?"":"_"+t.toFixed(0));case f.PLAYBACK_SHIFT:{if(0===t)return e;const i=new URL(e);return i.searchParams.append("playback_shift",t.toFixed(0)),i.toString()}case f.DASH_CMAF_OFFSET_P:{const i=new URL(e);return i.searchParams.get("offset_p")||0!==t?(i.searchParams.set("offset_p",t.toFixed(0)),i.toString()):e}default:(0,s.assertNever)(i)}return e};const b=(e,t)=>{switch(t){case f.OFFSET_P:return NaN;case f.PLAYBACK_SHIFT:{const t=new URL(e);return Number(t.searchParams.get("playback_shift"))}case f.DASH_CMAF_OFFSET_P:{const t=new URL(e);return Number(t.searchParams.get("offset_p")??0)}default:(0,s.assertNever)(t)}};var S=(e,t,i=!1)=>{const s=e.getTransition();(i||!s||s.to===t)&&e.setState(t)};class v{setState(e){const t=this.transition,i=this.state;this.transition=void 0,this.prevState=i,this.state=e,t?t.to===e?this.transitionEnded$.next(t):this.forceChanged$.next({from:t.from,to:e,canceledTransition:t}):this.forceChanged$.next({from:i,to:e,canceledTransition:t})}startTransitionTo(e){const t=this.transition,i=this.state;i===e||(0,s.isNonNullable)(t)&&t.to===e||(this.prevState=i,this.state=e,t?(this.transition={from:t.from,to:e,canceledTransition:t},this.transitionUpdated$.next(this.transition)):(this.transition={from:i,to:e},this.transitionStarted$.next(this.transition)))}getTransition(){return this.transition}getState(){return this.state}getPrevState(){return this.prevState}constructor(e){this.transitionStarted$=new s.Subject,this.transitionEnded$=new s.Subject,this.transitionUpdated$=new s.Subject,this.forceChanged$=new s.Subject,this.stateChangeStarted$=(0,s.merge)(this.transitionStarted$,this.transitionUpdated$),this.stateChangeEnded$=(0,s.merge)(this.transitionEnded$,this.forceChanged$),this.state=e,this.prevState=void 0}}var y;!function(e){e.STOPPED="stopped",e.READY="ready",e.PLAYING="playing",e.PAUSED="paused"}(y||(y={}));class T{destroy(){this.log({message:"[destroy]"}),this.subscription.unsubscribe()}subscribe(){this.subscription.add(this.loadMediaTimeoutSubscription);const e=new s.Subscription;this.subscription.add(e),this.subscription.add((0,s.merge)(this.videoState.stateChangeStarted$.pipe((0,s.map)((e=>`stateChangeStarted$ ${JSON.stringify(e)}`))),this.videoState.stateChangeEnded$.pipe((0,s.map)((e=>`stateChangeEnded$ ${JSON.stringify(e)}`)))).subscribe((e=>this.log({message:`[videoState] ${e}`}))));const t=(e,t)=>this.subscription.add(e.subscribe(t));if(this.params.output.isLive$.getValue())this.params.output.position$.next(0),this.params.output.duration$.next(0);else{const t=new s.Subject;e.add(t.pipe((0,s.debounce)(500)).subscribe((()=>{this.params.output.seekedEvent$.next()})));let i=NaN;e.add((0,s.fromEvent)(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.CURRENT_TIME_CHANGED).subscribe((e=>{this.logRemoteEvent(e);const s=e.value;this.params.output.position$.next(s),(this.params.desiredState.seekState.getState().state===d.Applying||Math.abs(s-i)>5)&&t.next(s),i=s}))),e.add((0,s.fromEvent)(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.DURATION_CHANGED).subscribe((e=>{this.logRemoteEvent(e),this.params.output.duration$.next(e.value)})))}t((0,s.fromEvent)(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.IS_MEDIA_LOADED_CHANGED),(t=>{this.logRemoteEvent(t),t.value?this.handleRemoteReady():(this.handleRemoteStop(),e.unsubscribe())})),t((0,s.fromEvent)(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.IS_PAUSED_CHANGED),(e=>{this.logRemoteEvent(e),e.value?this.handleRemotePause():this.handleRemotePlay()})),t((0,s.fromEvent)(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.PLAYER_STATE_CHANGED),(e=>{this.logRemoteEvent(e);const{remotePlayer:t}=this.params.connection,i=e.value,a=this.params.output.isBuffering$.getValue(),n=i===chrome.cast.media.PlayerState.BUFFERING;switch(a!==n&&this.params.output.isBuffering$.next(n),i){case chrome.cast.media.PlayerState.IDLE:!this.params.output.isLive$.getValue()&&t.duration-t.currentTime<5&&this.params.output.endedEvent$.next(),this.handleRemoteStop(),S(this.params.desiredState.playbackState,r.STOPPED);break;case chrome.cast.media.PlayerState.PAUSED:this.handleRemotePause();break;case chrome.cast.media.PlayerState.PLAYING:this.handleRemotePlay();break;case chrome.cast.media.PlayerState.BUFFERING:break;default:(0,s.assertNever)(i)}})),t((0,s.fromEvent)(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.VOLUME_LEVEL_CHANGED),(e=>{this.logRemoteEvent(e),this.handleRemoteVolumeChange({volume:e.value})})),t((0,s.fromEvent)(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.IS_MUTED_CHANGED),(e=>{this.logRemoteEvent(e),this.handleRemoteVolumeChange({muted:e.value})}));t((0,s.merge)(this.params.desiredState.playbackState.stateChangeStarted$,this.params.desiredState.seekState.stateChangeEnded$,this.videoState.stateChangeEnded$,(0,s.observableFrom)(["init"])).pipe((0,s.debounce)(0)),this.syncPlayback)}restoreSession(e){this.log({message:"restoreSession"});const{remotePlayer:t}=this.params.connection;if(e.playerState!==chrome.cast.media.PlayerState.IDLE){t.isPaused?(this.videoState.setState(y.PAUSED),S(this.params.desiredState.playbackState,r.PAUSED)):(this.videoState.setState(y.PLAYING),S(this.params.desiredState.playbackState,r.PLAYING));const e=this.params.output.isLive$.getValue();this.params.output.duration$.next(e?0:t.duration),this.params.output.position$.next(e?0:t.currentTime),this.params.desiredState.seekState.setState({state:d.None})}}prepare(){const e=this.params.format;this.log({message:`[prepare] format: ${e}`});const t=this.createMediaInfo(e),i=this.createLoadRequest(t);this.loadMedia(i)}handleRemotePause(){const e=this.videoState.getState();(this.videoState.getTransition()?.to===y.PAUSED||e===y.PLAYING)&&(this.videoState.setState(y.PAUSED),S(this.params.desiredState.playbackState,r.PAUSED))}handleRemotePlay(){const e=this.videoState.getState();(this.videoState.getTransition()?.to===y.PLAYING||e===y.PAUSED)&&(this.videoState.setState(y.PLAYING),S(this.params.desiredState.playbackState,r.PLAYING))}handleRemoteReady(){this.videoState.getTransition()?.to===y.READY&&this.videoState.setState(y.READY),this.params.desiredState.playbackState.getTransition()?.to===r.READY&&S(this.params.desiredState.playbackState,r.READY)}handleRemoteStop(){this.videoState.getState()!==y.STOPPED&&this.videoState.setState(y.STOPPED)}handleRemoteVolumeChange(e){const t=this.params.output.volume$.getValue(),i={volume:e.volume??t.volume,muted:e.muted??t.muted};(i.volume!==t.volume||i.muted!=i.muted)&&this.params.output.volume$.next(i)}seek(e){this.params.output.willSeekEvent$.next();const{remotePlayer:t,remotePlayerController:i}=this.params.connection;t.currentTime=e,i.seek()}stop(){const{remotePlayerController:e}=this.params.connection;e.stop()}createMediaInfo(e){const t=this.params.source;let i,a,r;switch(e){case o.MPEG:{const n=t[e];(0,s.assertNonNullable)(n);const o=(0,s.getHighestQuality)(Object.keys(n));(0,s.assertNonNullable)(o);const h=n[o];(0,s.assertNonNullable)(h),i=h,a="video/mp4",r=chrome.cast.media.StreamType.BUFFERED;break}case o.HLS:case o.HLS_ONDEMAND:{const n=t[e];(0,s.assertNonNullable)(n),i=n.url,a="application/x-mpegurl",r=chrome.cast.media.StreamType.BUFFERED;break}case o.DASH_SEP:case o.DASH_ONDEMAND:case o.DASH_WEBM:case o.DASH_WEBM_AV1:{const n=t[e];(0,s.assertNonNullable)(n),i=n.url,a="application/dash+xml",r=chrome.cast.media.StreamType.BUFFERED;break}case o.DASH_LIVE_CMAF:{const n=t[e];(0,s.assertNonNullable)(n),i=n.url,a="application/dash+xml",r=chrome.cast.media.StreamType.LIVE;break}case o.HLS_LIVE:case o.HLS_LIVE_CMAF:{const n=t[e];(0,s.assertNonNullable)(n),i=g(n.url),a="application/x-mpegurl",r=chrome.cast.media.StreamType.LIVE;break}case o.DASH_LIVE:case o.WEB_RTC_LIVE:{const e="Unsupported format for Chromecast",t=new Error(e);throw this.params.output.error$.next({id:"ChromecastProvider.createMediaInfo()",category:s.ErrorCategory.VIDEO_PIPELINE,message:e,thrown:t}),t}case o.DASH_LIVE_WEBM:throw new Error("DASH_LIVE_WEBM is no longer supported");default:return(0,s.assertNever)(e)}const n=new chrome.cast.media.MediaInfo(this.params.meta.videoId??i,a);n.contentUrl=i,n.streamType=r,n.metadata=new chrome.cast.media.GenericMediaMetadata;const{title:h,subtitle:u}=this.params.meta;return(0,s.isNonNullable)(h)&&(n.metadata.title=h),(0,s.isNonNullable)(u)&&(n.metadata.subtitle=u),n}createLoadRequest(e){const t=new chrome.cast.media.LoadRequest(e);t.autoplay=!1;const i=this.params.desiredState.seekState.getState();return i.state===d.Applying||i.state===d.Requested?t.currentTime=this.params.output.isLive$.getValue()?0:i.position/1e3:t.currentTime=0,t}loadMedia(e){const t=this.params.connection.session.loadMedia(e),i=new Promise(((e,t)=>{this.loadMediaTimeoutSubscription.add((0,s.timeout)(7e3).subscribe((()=>t("timeout(7000)"))))}));Promise.race([t,i]).then((()=>{this.log({message:`[loadMedia] completed, format: ${this.params.format}`}),this.params.desiredState.seekState.getState().state===d.Applying&&this.params.output.seekedEvent$.next(),this.handleRemoteReady()}),(e=>{const t=`[prepare] loadMedia failed, format: ${this.params.format}, reason: ${e}`;this.log({message:t}),this.params.output.error$.next({id:"ChromecastProvider.loadMedia",category:s.ErrorCategory.VIDEO_PIPELINE,message:t,thrown:e})})).finally((()=>{this.loadMediaTimeoutSubscription.unsubscribe()}))}logRemoteEvent(e){this.log({message:`[remoteEvent] ${JSON.stringify(e)}`})}constructor(e){this.subscription=new s.Subscription,this.loadMediaTimeoutSubscription=new s.Subscription,this.videoState=new v(y.STOPPED),this.syncPlayback=()=>{const e=this.videoState.getState(),t=this.videoState.getTransition(),i=this.params.desiredState.playbackState.getState(),a=this.params.desiredState.playbackState.getTransition(),n=this.params.desiredState.seekState.getState();if(this.log({message:`[syncPlayback] videoState: ${e}; videoTransition: ${JSON.stringify(t)}; desiredPlaybackState: ${i}; desiredPlaybackStateTransition: ${this.params.desiredState.playbackState.getTransition()}; seekState: ${JSON.stringify(n)};`}),i!==r.STOPPED){if(!t){if(a?.to!==r.PAUSED&&n.state===d.Requested&&e!==y.STOPPED)return void this.seek(n.position/1e3);switch(i){case r.READY:switch(e){case y.PLAYING:case y.PAUSED:case y.READY:break;case y.STOPPED:this.videoState.startTransitionTo(y.READY),this.prepare();break;default:(0,s.assertNever)(e)}break;case r.PLAYING:switch(e){case y.PLAYING:break;case y.PAUSED:case y.READY:this.videoState.startTransitionTo(y.PLAYING),this.params.connection.remotePlayerController.playOrPause();break;case y.STOPPED:this.videoState.startTransitionTo(y.READY),this.prepare();break;default:(0,s.assertNever)(e)}break;case r.PAUSED:switch(e){case y.PLAYING:this.videoState.startTransitionTo(y.PAUSED),this.params.connection.remotePlayerController.playOrPause();break;case y.PAUSED:break;case y.READY:this.videoState.startTransitionTo(y.PAUSED),this.videoState.setState(y.PAUSED);break;case y.STOPPED:this.videoState.startTransitionTo(y.READY),this.prepare();break;default:(0,s.assertNever)(e)}break;default:(0,s.assertNever)(i)}}}else e!==y.STOPPED&&(this.videoState.startTransitionTo(y.STOPPED),this.stop())},this.params=e,this.log=this.params.dependencies.logger.createComponentLog("ChromecastProvider"),this.log({message:`constructor, format: ${e.format}`}),this.params.output.isLive$.next((e=>{switch(e){case o.MPEG:case o.DASH_SEP:case o.DASH_ONDEMAND:case o.DASH_WEBM:case o.DASH_WEBM_AV1:case o.HLS:case o.HLS_ONDEMAND:return!1;case o.DASH_LIVE:case o.DASH_LIVE_CMAF:case o.HLS_LIVE:case o.HLS_LIVE_CMAF:case o.DASH_LIVE_WEBM:case o.WEB_RTC_LIVE:return!0;default:return(0,s.assertNever)(e)}})(e.format)),this.params.output.isAudioAvailable$.next(!0),this.handleRemoteVolumeChange({volume:this.params.connection.remotePlayer.volumeLevel,muted:this.params.connection.remotePlayer.isMuted});const t=this.params.connection.session.getMediaSession();t&&this.restoreSession(t),this.subscribe()}}const E=e=>{e.removeAttribute("src"),e.load()};const w=window.WeakMap?new WeakMap:new class{get(e){return e.hasAttribute(this.attribute)}set(e,t){e.toggleAttribute(this.attribute,t)}delete(e){e.removeAttribute(this.attribute)}constructor(){this.attribute="data-pool-reused"}},A=e=>{let t=e.querySelector("video");const i=!!t;return t?E(t):(t=document.createElement("video"),e.appendChild(t)),w.set(t,i),t.setAttribute("crossorigin","anonymous"),t.setAttribute("playsinline","playsinline"),t.controls=!1,t.setAttribute("poster","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII="),t},$=e=>{const t=w.get(e);w.delete(e),t?E(e):(e=>{try{e.pause(),e.playbackRate=0,E(e),e.remove()}catch(e){console.error(e)}})(e)},k=(e,t,i,{equal:a=((e,t)=>e===t),changed$:r,onError:n}={})=>{const o=e.getState(),h=t(),u=(0,s.isNullable)(r),c=new s.Subscription;return r&&c.add(r.subscribe((t=>{const i=e.getState();a(t,i)&&e.setState(t)}),n)),a(h,o)||(i(o),u&&e.setState(o)),c.add(e.stateChangeStarted$.subscribe((t=>{i(t.to),u&&e.setState(t.to)}),n)),c},P=(e,t,i)=>k(t,(()=>e.loop),(t=>{(0,s.isNonNullable)(t)&&(e.loop=t)}),{onError:i}),C=(e,t,i,a)=>k(t,(()=>({muted:e.muted,volume:e.volume})),(t=>{(0,s.isNonNullable)(t)&&(e.muted=t.muted,e.volume=t.volume)}),{equal:(e,t)=>e===t||e?.muted===t?.muted&&e?.volume===t?.volume,changed$:i,onError:a}),L=(e,t,i,a)=>k(t,(()=>e.playbackRate),(t=>{(0,s.isNonNullable)(t)&&(e.playbackRate=t)}),{changed$:i,onError:a}),D=(e,t)=>{if(e.id===t)return!0;const[i,s,a]=t.split("|");return e.language===s&&e.label===a};class R{connect(e,t,i){this.video=e,this.cueSettings=t.textTrackCuesSettings,this.subscribe();const a=e=>{this.error$.next({id:"TextTracksManager",category:s.ErrorCategory.WTF,message:"Generic HtmlVideoTextTrackManager error",thrown:e})};this.subscription.add(this.available$.subscribe(i.availableTextTracks$)),this.subscription.add(this.current$.subscribe(i.currentTextTrack$)),this.subscription.add(this.error$.subscribe(i.error$)),this.subscription.add(k(t.internalTextTracks,(()=>Object.values(this.internalTracks)),(e=>{(0,s.isNonNullable)(e)&&this.setInternal(e)}),{equal:(e,t)=>(0,s.isNonNullable)(e)&&(0,s.isNonNullable)(t)&&e.length===t.length&&e.every((({id:e},i)=>e===t[i].id)),changed$:this.available$.pipe((0,s.map)((e=>e.filter((({type:e})=>"internal"===e))))),onError:a})),this.subscription.add(k(t.externalTextTracks,(()=>Object.values(this.externalTracks)),(e=>{(0,s.isNonNullable)(e)&&this.setExternal(e)}),{equal:(e,t)=>(0,s.isNonNullable)(e)&&(0,s.isNonNullable)(t)&&e.length===t.length&&e.every((({id:e},i)=>e===t[i].id)),changed$:this.available$.pipe((0,s.map)((e=>e.filter((({type:e})=>"external"===e))))),onError:a})),this.subscription.add(k(t.currentTextTrack,(()=>{if(this.video)return;const e=this.htmlTextTracksAsArray().find((({mode:e})=>"showing"===e));return e&&this.htmlTextTrackToITextTrack(e).id}),(e=>this.select(e)),{changed$:this.current$,onError:a})),this.subscription.add(k(t.textTrackCuesSettings,(()=>({})),(()=>{if(this.video)for(const e of this.htmlTextTracksAsArray())this.applyCueSettings(e.cues),this.applyCueSettings(e.activeCues)})))}subscribe(){(0,s.assertNonNullable)(this.video);const{textTracks:e}=this.video;this.subscription.add((0,s.fromEvent)(e,"addtrack").subscribe((()=>{const e=this.current$.getValue();e&&this.select(e)}))),this.subscription.add((0,s.merge)((0,s.fromEvent)(e,"addtrack"),(0,s.fromEvent)(e,"removetrack"),(0,s.observableFrom)(["init"])).pipe((0,s.map)((()=>this.htmlTextTracksAsArray().map((e=>this.htmlTextTrackToITextTrack(e))))),(0,s.filterChanged)(((e,t)=>e.length===t.length&&e.every((({id:e},i)=>e===t[i].id))))).subscribe(this.available$)),this.subscription.add((0,s.merge)((0,s.fromEvent)(e,"change"),(0,s.observableFrom)(["init"])).pipe((0,s.map)((()=>this.htmlTextTracksAsArray().find((({mode:e})=>"showing"===e)))),(0,s.map)((e=>e&&this.htmlTextTrackToITextTrack(e).id)),(0,s.filterChanged)()).subscribe(this.current$));const t=e=>this.applyCueSettings(e.target?.activeCues??null);this.subscription.add((0,s.fromEvent)(e,"addtrack").subscribe((e=>{e.track?.addEventListener("cuechange",t);const i=e=>{const t=e.target?.cues??null;t&&t.length&&(this.applyCueSettings(e.target?.cues??null),e.target?.removeEventListener("cuechange",i))};e.track?.addEventListener("cuechange",i)}))),this.subscription.add((0,s.fromEvent)(e,"removetrack").subscribe((e=>{e.track?.removeEventListener("cuechange",t)})))}applyCueSettings(e){if(!e||!e.length)return;const t=this.cueSettings.getState();for(const i of Array.from(e)){const e=i;(0,s.isNonNullable)(t.align)&&(e.align=t.align),(0,s.isNonNullable)(t.position)&&(e.position=t.position),(0,s.isNonNullable)(t.size)&&(e.size=t.size),(0,s.isNonNullable)(t.line)&&(e.line=t.line)}}htmlTextTracksAsArray(e=!1){(0,s.assertNonNullable)(this.video);const t=[...this.video.textTracks];return e?t:t.filter(R.isHealthyTrack)}htmlTextTrackToITextTrack(e){const{language:t,label:i}=e,s=e.id?e.id:(e=>["__",e.language,e.label].join("|"))(e),a=this.externalTracks.has(s),r=s.includes("auto");return a?{id:s,type:"external",isAuto:r,language:t,label:i,url:this.externalTracks.get(s)?.url}:{id:s,type:"internal",isAuto:r,language:t,label:i,url:this.internalTracks.get(s)?.url}}static isHealthyTrack(e){return!("metadata"===e.kind||e.groupId||""===e.id&&""===e.label&&""===e.language)}setExternal(e){this.internalTracks.size>0&&Array.from(this.internalTracks).forEach((([,e])=>this.detach(e))),e.filter((({id:e})=>!this.externalTracks.has(e))).forEach((e=>this.attach(e))),Array.from(this.externalTracks).filter((([t])=>!e.find((e=>e.id===t)))).forEach((([,e])=>this.detach(e)))}setInternal(e){const t=[...this.externalTracks];e.filter((({id:e,language:i,isAuto:s})=>!this.internalTracks.has(e)&&!t.some((([,e])=>e.language===i&&e.isAuto===s)))).forEach((e=>this.attach(e))),Array.from(this.internalTracks).filter((([t])=>!e.find((e=>e.id===t)))).forEach((([,e])=>this.detach(e)))}select(e){(0,s.assertNonNullable)(this.video);for(const e of this.htmlTextTracksAsArray(!0))e.mode="showing";for(const t of this.htmlTextTracksAsArray(!0))((0,s.isNullable)(e)||!D(t,e))&&(t.mode="disabled")}destroy(){if(this.subscription.unsubscribe(),this.video)for(const e of Array.from(this.video.getElementsByTagName("track"))){const t=e.getAttribute("id");t&&this.externalTracks.has(t)&&this.video.removeChild(e)}this.externalTracks.clear()}attach(e){(0,s.assertNonNullable)(this.video);const t=document.createElement("track");t.setAttribute("src",e.url),t.setAttribute("id",e.id),e.label&&t.setAttribute("label",e.label),e.language&&t.setAttribute("srclang",e.language),"external"===e.type?this.externalTracks.set(e.id,e):"internal"===e.type&&this.internalTracks.set(e.id,e),this.video.appendChild(t)}detach(e){(0,s.assertNonNullable)(this.video);const t=Array.prototype.find.call(this.video.getElementsByTagName("track"),(t=>t.getAttribute("id")===e.id));t&&this.video.removeChild(t),"external"===e.type?this.externalTracks.delete(e.id):"internal"===e.type&&this.internalTracks.delete(e.id)}constructor(){this.available$=new s.Subject,this.current$=new s.ValueSubject(void 0),this.error$=new s.Subject,this.subscription=new s.Subscription,this.externalTracks=new Map,this.internalTracks=new Map}}class N{getTotalPausedTime(){return this.pausedTime+this.getCurrentPausedTime()}getCurrentPausedTime(){return this.pauseTimestamp>0?Date.now()-this.pauseTimestamp:0}getStreamOffset(){return this.streamOffset}getTotalOffset(){return this.getTotalPausedTime()+this.streamOffset}pause(){0===this.pauseTimestamp&&(this.pauseTimestamp=Date.now())}resume(){this.pauseTimestamp>0&&(this.pausedTime+=this.getCurrentPausedTime(),this.pauseTimestamp=0)}resetTo(e,t=!1){this.streamOffset=e,this.pauseTimestamp=0,this.pausedTime=0,t&&this.pause()}constructor(){this.pausedTime=0,this.streamOffset=0,this.pauseTimestamp=0}}const x=e=>{let t=e;for(;!(t instanceof Document||t instanceof ShadowRoot||null===t);)t=t?.parentNode;return t??void 0},I=e=>{const t=x(e);return!(!t||!t.fullscreenElement||t.fullscreenElement!==e)};const M=e=>{const t=t=>(0,s.fromEvent)(e,t).pipe((0,s.mapTo)(void 0)),i=(0,s.merge)(...["waiting","pause","canplay","play","canplaythrough","playing","seeking","seeked","ended"].map((t=>(0,s.fromEvent)(e,t)))).pipe((0,s.map)((t=>"ended"===t.type?e.readyState<2:e.readyState<3)),(0,s.filterChanged)()),a=(0,s.merge)((0,s.fromEvent)(e,"progress"),(0,s.fromEvent)(e,"timeupdate")).pipe((0,s.map)((()=>((e,t,i=3)=>{let s=0,a=0;for(let r=0;r<e.length;r++){const n=e.start(r),o=e.end(r);if(n<=t&&t<=o){if(s=n,a=o,!i)return{from:s,to:a};for(let t=r-1;t>=0;t--)e.end(t)+i>=s&&(s=e.start(t));for(let t=r+1;t<e.length;t++)e.start(t)-i<=a&&(a=e.end(t))}}return{from:s,to:a}})(e.buffered,e.currentTime)))),r=(0,s.getCurrentBrowser)().browser===s.CurrentClientBrowser.Safari?(0,s.combine)({play:t("play").pipe((0,s.once)()),playing:t("playing")}).pipe((0,s.mapTo)(void 0)):t("playing"),n=(0,s.fromEvent)(e,"volumechange").pipe((0,s.map)((()=>({muted:e.muted,volume:e.volume})))),o=(0,s.fromEvent)(e,"ratechange").pipe((0,s.map)((()=>e.playbackRate))),h=(0,s.fromEvent)(e,"error").pipe((0,s.filter)((()=>!(!e.error&&!e.played.length))),(0,s.map)((()=>{const t=e.error;return{id:t?`MediaError#${t.code}`:"HtmlVideoError",category:s.ErrorCategory.VIDEO_PIPELINE,message:t?t.message:"Error event from HTML video element",thrown:e.error??void 0}}))),u=(0,s.fromEvent)(e,"timeupdate").pipe((0,s.map)((()=>e.currentTime))),c=new s.Subject;let d;u.subscribe((t=>{e.loop&&(0,s.isNonNullable)(d)&&(0,s.isNonNullable)(t)&&d>=e.duration-.3&&t<=.3&&c.next(d),d=t}));const l=(0,s.fromEvent)(e,"enterpictureinpicture"),p=(0,s.fromEvent)(e,"leavepictureinpicture"),m=new s.ValueSubject((e=>{const t=x(e);return!(!t||!t.pictureInPictureElement||t.pictureInPictureElement!==e)})(e));l.subscribe((()=>m.next(!0))),p.subscribe((()=>m.next(!1)));const f=new s.ValueSubject(I(e));return(0,s.fromEvent)(e,"fullscreenchange").pipe((0,s.map)((()=>I(e)))).subscribe(f),{playing$:r,pause$:t("pause").pipe((0,s.filter)((()=>!e.error))),canplay$:t("canplay"),ended$:t("ended"),looped$:c,error$:h,seeked$:t("seeked"),seeking$:t("seeking"),progress$:t("progress"),loadStart$:t("loadstart"),loadedMetadata$:t("loadedmetadata"),loadedData$:t("loadeddata"),timeUpdate$:u,durationChange$:(0,s.fromEvent)(e,"durationchange").pipe((0,s.map)((()=>e.duration))),isBuffering$:i,currentBuffer$:a,volumeState$:n,playbackRateState$:o,inPiP$:m,inFullscreen$:f}};var O=e=>{switch(e){case"mobile":return s.VideoQuality.Q_144P;case"lowest":return s.VideoQuality.Q_240P;case"low":return s.VideoQuality.Q_360P;case"sd":case"medium":return s.VideoQuality.Q_480P;case"hd":case"high":return s.VideoQuality.Q_720P;case"fullhd":case"full":return s.VideoQuality.Q_1080P;case"quadhd":case"quad":return s.VideoQuality.Q_1440P;case"ultrahd":case"ultra":return s.VideoQuality.Q_2160P}};let _=!1,V={};const B=e=>{e(V)},F=(e,t)=>{_&&(V.meta=V.meta??{},V.meta[e]=t)};class U{next(e){if(!_)return;V.series=V.series??{};const t=V.series[this.name]??[];t.push([Date.now(),e]),V.series[this.name]=t}constructor(e){this.name=e}}var H;!function(e){e.FitsContainer="FitsContainer",e.FitsThroughput="FitsThroughput",e.Buffer="Buffer",e.DroppedFramesLimit="DroppedFramesLimit",e.FitsQualityLimits="FitsQualityLimits"}(H||(H={}));const j=new U("best_bitrate");class q{recordSelection(e){this.history[e.id]=(0,s.now)()}recordSwitch(e){this.last=e}clear(){this.last=void 0,this.history={}}constructor(){this.history={}}}const Y=(e,{container:t,throughput:i,tuning:a,limits:r,reserve:n=0,forwardBufferHealth:o,playbackRate:h,current:u,history:c,droppedVideoMaxQualityLimit:d,abrLogger:l})=>{(0,s.assertNotEmptyArray)(e,'Assertion "ABR Tracks is empty array" failed');const p=a.usePixelRatio?window.devicePixelRatio??1:1,m=a.limitByContainer&&t&&t.width>0&&t.height>0&&{width:t.width*p*a.containerSizeFactor,height:t.height*p*a.containerSizeFactor},f=m&&(0,s.videoSizeToQuality)(m),g=a.considerPlaybackRate&&(0,s.isNonNullable)(h)?h:1,b=e.filter((e=>!(0,s.isInvariantQuality)(e.quality))).sort(((e,t)=>(0,s.isHigher)(e.quality,t.quality)?-1:1)),S=b.at(-1)?.quality,v=b.at(0)?.quality,y=(0,s.isNullable)(r)||(0,s.isNonNullable)(r.min)&&(0,s.isNonNullable)(r.max)&&(0,s.isLower)(r.max,r.min)||(0,s.isNonNullable)(r.min)&&v&&(0,s.isHigher)(r.min,v)||(0,s.isNonNullable)(r.max)&&S&&(0,s.isLower)(r.max,S),T=g*((e,t,i)=>(t-i)*Math.pow(2,-10*e)+i)(o??.5,a.bitrateFactorAtEmptyBuffer,a.bitrateFactorAtFullBuffer),E={},w=b.filter((e=>!f||(0,s.isLower)(e.quality,f)?!((0,s.isNonNullable)(i)&&isFinite(i)&&(0,s.isNonNullable)(e.bitrate))||i-n>=e.bitrate*T?a.lazyQualitySwitch&&(0,s.isNonNullable)(a.minBufferToSwitchUp)&&u&&!(0,s.isInvariantQuality)(u.quality)&&(o??0)<a.minBufferToSwitchUp&&(0,s.isHigher)(e.quality,u.quality)?(E[e.quality]=H.Buffer,!1):d&&(0,s.isHigherOrEqual)(e.quality,d)?(E[e.quality]=H.DroppedFramesLimit,!1):!!(y||((0,s.isNullable)(r.max)||(0,s.isLowerOrEqual)(e.quality,r.max))&&((0,s.isNullable)(r.min)||(0,s.isHigherOrEqual)(e.quality,r.min)))||(E[e.quality]=H.FitsQualityLimits,!1):(E[e.quality]=H.FitsThroughput,!1):(E[e.quality]=H.FitsContainer,!1)))[0];w&&w.bitrate&&j.next(w.bitrate);const A=w??b[Math.ceil((b.length-1)/2)]??e[0];A.quality!==c?.last?.quality&&l({message:`\n    [available tracks]\n\t${e.map((e=>`{ id: ${e.id}, quality: ${e.quality}, bitrate: ${e.bitrate} }`)).join("\n\t")}\n\n    [tuning]\n\t${Object.entries(a??{}).map((([e,t])=>`${e}: ${t}`)).join("\n\t")}\n\n    [limit params]\n    containerQualityLimit: ${f},\n    throughput: ${i},\n    reserve: ${n},\n    playbackRate: ${h},\n    playbackRateFactor: ${g},\n    forwardBufferHealth: ${o},\n    bitrateFactor: ${T},\n    minBufferToSwitchUp: ${a.minBufferToSwitchUp},\n    droppedVideoMaxQualityLimit: ${d},\n    limitsAreInvalid: ${y},\n    maxQualityLimit: ${r?.max},\n    minQualityLimit: ${r?.min},\n\n    [limited tracks]\n    ${Object.entries(E).map((([e,t])=>`${e}: ${t}`)).join("\n\t")||"All tracks are available"}\n\n    [best track] ${w?.quality}\n    [selected track] ${A?.quality}\n    `});const $=A&&c&&c.history[A.id]&&(0,s.now)()-c.history[A.id]<=a.trackCooldown&&(!c.last||A.id!==c.last.id);if(A?.id&&c&&!$&&c.recordSelection(A),$&&c?.last){const e=c.last;return c?.recordSwitch(e),l({message:`\n    [last selected] ${e?.quality}\n    `}),e}return c?.recordSwitch(A),A};var G=e=>new URL(e).hostname;const Q=e=>{if(e instanceof DOMException&&["Failed to load because no supported source was found.","The element has no supported sources."].includes(e.message))throw e;return!(e instanceof DOMException&&(20===e.code||"AbortError"===e.name))};var z=async e=>{const t=e.muted;try{await e.play()}catch(i){if(!Q(i))return!1;if(t)return console.warn(i),!1;e.muted=!0;try{await e.play()}catch(t){return Q(t)&&(e.muted=!1,console.warn(t)),!1}}return!0};function W(){return(0,s.now)()}function J(e){return W()-e}function X(e){const t=e.split("/"),i=t.slice(0,t.length-1).join("/"),s=/^([a-z]+:)?\/\//i;return{resolve:(e,t,a=!1)=>{(e=>s.test(e))(e)||(e.startsWith("/")||(e="/"+e),e=i+e);let r=e.indexOf("?")>-1?"&":"?";return a&&(e+=r+"lowLat=1",r="&"),t&&(e+=r+"_rnd="+Math.floor(999999999*Math.random())),e}}}function K(e,t,i,a){const r=window.XMLHttpRequest;let n,o,h,u,c,d=!1,l=0,p=!1,m="arraybuffer",f=7e3,g=2e3,b=()=>{if(d)return;(0,s.assertNonNullable)(u);const e=J(u);let t;if(e<g)return t=g-e,void setTimeout(b,t);g*=2,g>f&&(g=f),o&&o.abort(),o=new r,v()};const S=()=>{if(!d){if(--l>=0)return b(),void(a&&a());d=!0,c&&c(),i&&i()}},v=()=>{u=W(),o=new r,o.open("get",e);let i,a=0,l=0;const f=()=>((0,s.assertNonNullable)(u),Math.max(u,Math.max(i||0,l||0)));if(n&&o.addEventListener("progress",(e=>{const t=W();n.updateChunk&&e.loaded>a&&(n.updateChunk(f(),e.loaded-a),a=e.loaded,i=t)})),h&&(o.timeout=h,o.addEventListener("timeout",(()=>S()))),o.addEventListener("load",(()=>{if(d)return;(0,s.assertNonNullable)(o);const e=o.status;if(e>=200&&e<300){if(o.response.byteLength&&n){const e=o.response.byteLength-a;e&&n.updateChunk&&n.updateChunk(f(),e)}"json"!==o.responseType||Object.values(o.response).length?(c&&c(),t(o.response)):S()}else S()})),o.addEventListener("error",(()=>{S()})),p){const e=()=>{(0,s.assertNonNullable)(o),o.readyState===XMLHttpRequest.HEADERS_RECEIVED&&(l=W(),o.removeEventListener("readystatechange",e))};o.addEventListener("readystatechange",e)}return o.responseType=m,o.send(),y},y={withBitrateReporting:e=>(n=e,y),withParallel:e=>(p=e,y),withJSONResponse:()=>(m="json",y),withRetryCount:e=>(l=e,y),withRetryInterval:(e,t)=>((0,s.isNonNullable)(e)&&(g=e),(0,s.isNonNullable)(t)&&(f=t),y),withTimeout:e=>(h=e,y),withFinally:e=>(c=e,y),send:v,abort:()=>{o&&(o.abort(),o=void 0),d=!0,c&&c()}};return y}let Z=class{_updateRate(e){let t=.2;this.currentRate&&(e<.1*this.currentRate?t=.8:e<.5*this.currentRate?t=.5:e<.7*this.currentRate&&(t=.3)),e=Math.max(1,Math.min(e,104857600)),this.currentRate=this.currentRate?this.currentRate*(1-t)+e*t:e}_createInterval(e,t,i){return{start:e,end:t,bytes:i}}_doMergeIntervals(e,t){e.start=Math.min(t.start,e.start),e.end=Math.max(t.end,e.end),e.bytes+=t.bytes}_mergeIntervals(e,t){return e.start<=t.end&&t.start<=e.end&&(this._doMergeIntervals(e,t),!0)}_flushIntervals(){if(!this.intervals.length)return!1;const e=this.intervals[0].start,t=this.intervals[this.intervals.length-1].end-500;if(t-e>2e3){let i=0,s=0;for(;this.intervals.length>0;){const e=this.intervals[0];if(e.end<=t)i+=e.end-e.start,s+=e.bytes,this.intervals.splice(0,1);else{if(e.start>=t)break;{const a=t-e.start,r=e.end-e.start;i+=a;const n=e.bytes*a/r;s+=n,e.start=t,e.bytes-=n}}}if(s>0&&i>0){const a=8*s/(i/1e3);return this._updateRate(a),this.logger(`rate updated, new=${Math.round(a/1024)}K; average=${Math.round(this.currentRate/1024)}K bytes/ms=${Math.round(s)}/${Math.round(i)} interval=${Math.round(t-e)}`),!0}}return!1}_joinIntervals(){let e;do{e=!1;for(let t=0;t<this.intervals.length-1;++t)this._mergeIntervals(this.intervals[t],this.intervals[t+1])&&(this.intervals.splice(t+1,1),e=!0)}while(e)}addInterval(e,t,i){return this.intervals.push(this._createInterval(e,t,i)),this._joinIntervals(),this.intervals.length>100&&(this.logger(`too many intervals (${this.intervals.length}); will merge`,{type:"warn"}),this._doMergeIntervals(this.intervals[1],this.intervals[0]),this.intervals.splice(0,1)),this._flushIntervals()}getBitRate(){return this.currentRate}constructor(e){this.intervals=[],this.currentRate=0,this.logger=e}};class ee{limitCompleteCount(){let e;for(;(e=Object.keys(this.completeRequests)).length>this._getParallelRequestCount()+2;){const t=e[Math.floor(Math.random()*e.length)];this.logger(`Dropping completed request for url ${t}`,{type:"warn"}),delete this.completeRequests[t]}}_sendRequest(e,t){const i=W(),s=i=>{delete this.activeRequests[t],this.limitCompleteCount(),this.completeRequests[t]=e,this._sendPending(),e._error=1,e._errorMsg=i,e._errorCB?e._errorCB(i):(this.limitCompleteCount(),this.completeRequests[t]=e)};e._request=K(t,(s=>{e._complete=1,e._responseData=s,e._downloadTime=W()-i,delete this.activeRequests[t],this._sendPending(),e._cb?e._cb(s,e._downloadTime):(this.limitCompleteCount(),this.completeRequests[t]=e)}),(()=>s("error")),(()=>{e._retry=1,e._retryCB&&e._retryCB()})),e._request.withRetryCount(this.RETRY_COUNT).withTimeout(this.TIMEOUT).withBitrateReporting(this.BITRATE_ESTIMATOR).withParallel(this._getParallelRequestCount()>1).withFinally((()=>{e._finallyCB&&e._finallyCB()})),this.activeRequests[t]=e,e._request.send(),this.lastPrefetchStart=W()}_getParallelRequestCount(){return Math.min(this.MAX_PARALLEL_REQUESTS,this.averageSegmentDuration<3e3?3:2)}_getPrefetchDelay(){return Math.max(100,Math.min(5e3,this.averageSegmentDuration/3))}_canSendPending(){const e=this._getParallelRequestCount(),t=W();if(Object.keys(this.activeRequests).length>=e)return!1;const i=this._getPrefetchDelay()-(t-this.lastPrefetchStart);return this.throttleTimeout&&clearTimeout(this.throttleTimeout),!(i>0)||(this.throttleTimeout=window.setTimeout((()=>this._sendPending()),i),!1)}_sendPending(){for(;this._canSendPending();){const e=this.pendingQueue.pop();if(!e)return;this.activeRequests[e]||this.completeRequests[e]||(this.logger(`Submitting pending request url=${e}`),this._sendRequest({},e))}}_removeFromActive(e){delete this.completeRequests[e],delete this.activeRequests[e]}abortAll(){Object.values(this.activeRequests).forEach((e=>{e&&e._request&&e._request.abort()})),this.activeRequests={},this.pendingQueue=[],this.completeRequests={}}requestData(e,t,i,s){const a={};return a.send=()=>{const r=this.activeRequests[e]||this.completeRequests[e];if(r)r._cb=t,r._errorCB=i,r._retryCB=s,r._finallyCB=a._finallyCB,r._error||r._complete?(this._removeFromActive(e),setTimeout((()=>{r._complete?(this.logger(`Requested url already prefetched, url=${e}`),t(r._responseData,r._downloadTime)):(this.logger(`Requested url already prefetched with error, url=${e}`),i(r._errorMsg)),a._finallyCB&&a._finallyCB()}),0)):this.logger(`Attached to active request, url=${e}`);else{const t=this.pendingQueue.indexOf(e);-1!==t&&this.pendingQueue.splice(t,1),this.logger(`Request not prefetched, starting new request, url=${e}${-1===t?"":"; removed pending"}`),this._sendRequest(a,e)}},a._cb=t,a._errorCB=i,a._retryCB=s,a.abort=function(){a.request&&a.request.abort()},a.withFinally=e=>(a._finallyCB=e,a),a}prefetch(e){this.activeRequests[e]||this.completeRequests[e]?this.logger(`Request already active for url=${e}`):(this.logger(`Added to pending queue; url=${e}`),this.pendingQueue.unshift(e),this._sendPending())}optimizeForSegDuration(e){this.averageSegmentDuration=e}constructor(e,t,i,s,a){this.pendingQueue=[],this.activeRequests={},this.completeRequests={},this.averageSegmentDuration=2e3,this.lastPrefetchStart=0,this.throttleTimeout=null,this.RETRY_COUNT=e,this.TIMEOUT=t,this.BITRATE_ESTIMATOR=i,this.MAX_PARALLEL_REQUESTS=s,this.logger=a}}const te=1e4;class ie{attachSource(e){this.manifestUrl=e,this.urlResolver=X(e),this.bitrateSwitcher=this._initBitrateSwitcher(),this._initManifest()}setAutoQualityEnabled(e){this.autoQuality=e}setMaxAutoQuality(e){this.maxAutoQuality=e}switchByName(e){let t;for(let i=0;i<this.manifest.length;++i)if(t=this.manifest[i],t.name===e)return void this._switchToQuality(t)}catchUp(){this.rep&&this.rep.stop(),this.currentManifestEntry&&(this.paused=!1,this._initPlayerWith(this.currentManifestEntry),this._notifyBuffering(!0))}stop(){this.params.videoElement.pause(),this.rep&&(this.rep.stop(),this.rep=null)}pause(){this.paused=!0,this.params.videoElement.pause(),this.videoPlayStarted=!1,this._notifyBuffering(!1)}play(e){this.paused=!1;const t=this.lowLatency&&this._getBufferSizeSec()>this.sourceJitter+5;this.rep&&!t?(this.bufferStates=[],this.videoPlayStarted=!1,this.shouldPlay()?this._playVideoElement(e):this._notifyBuffering(!0)):this.catchUp()}startPlay(e,t){this.autoQuality=t,this._initPlayerWith(e)}destroy(){this.destroyed=!0,this.rep&&(this.rep.stop(),this.rep=null),this.manifestRequest&&this.manifestRequest.abort(),this.manifestRefetchTimer&&(clearTimeout(this.manifestRefetchTimer),this.manifestRefetchTimer=void 0)}reinit(e){this.manifestUrl=e,this.urlResolver=X(e),this.catchUp()}_handleNetworkError(){this.params.logger("Fatal network error"),this.params.playerCallback({name:"error",type:"network"})}_retryCallback(){this.params.playerCallback({name:"retry"})}_getBufferSizeSec(){const e=this.params.videoElement;let t=0;const i=e.buffered.length;return 0!==i&&(t=e.buffered.end(i-1)-Math.max(e.currentTime,e.buffered.start(0))),t}_notifyBuffering(e){this.destroyed||(this.params.logger(`buffering: ${e}`),this.params.playerCallback({name:"buffering",isBuffering:e}),this.buffering=e)}_initVideo(){const{videoElement:e,logger:t}=this.params;e.addEventListener("error",(()=>{e.error&&!this.destroyed&&(t(`Video element error: ${e.error?.code}`),this.params.playerCallback({name:"error",type:"media"}))})),e.addEventListener("timeupdate",(()=>{const e=this._getBufferSizeSec();!this.paused&&e<.3?this.buffering||(this.buffering=!0,window.setTimeout((()=>{!this.paused&&this.buffering&&this._notifyBuffering(!0)}),1e3*(e+.1))):this.buffering&&this.videoPlayStarted&&this._notifyBuffering(!1)})),e.addEventListener("playing",(()=>{t("playing")})),e.addEventListener("stalled",(()=>this._fixupStall())),e.addEventListener("waiting",(()=>this._fixupStall()))}_fixupStall(){const{logger:e,videoElement:t}=this.params,i=t.buffered.length;let s;0!==i&&(s=t.buffered.start(i-1),t.currentTime<s&&(e("Fixup stall"),t.currentTime=s))}_selectQuality(e){const{videoElement:t}=this.params;let i,s,a;const r=t&&1.62*(window.devicePixelRatio||1)*t.offsetHeight||520;for(let t=0;t<this.manifest.length;++t)a=this.manifest[t],!(this.maxAutoQuality&&a.video.height>this.maxAutoQuality)&&(a.bitrate<e&&r>Math.min(a.video.height,a.video.width)?(!s||a.bitrate>s.bitrate)&&(s=a):(!i||i.bitrate>a.bitrate)&&(i=a));return s||i}shouldPlay(){if(this.paused)return!1;const e=this._getBufferSizeSec()-Math.max(1,this.sourceJitter);return e>3||(0,s.isNonNullable)(this.downloadRate)&&(this.downloadRate>1.5&&e>2||this.downloadRate>2&&e>1)}_setVideoSrc(e,t){const{logger:i,videoElement:s,playerCallback:a}=this.params;this.mediaSource=new window.MediaSource,i("setting video src"),s.src=URL.createObjectURL(this.mediaSource),this.mediaSource.addEventListener("sourceopen",(()=>{this.mediaSource&&(this.sourceBuffer=this.mediaSource.addSourceBuffer(e.codecs),this.bufferStates=[],t())})),this.videoPlayStarted=!1,s.addEventListener("canplay",(()=>{this.shouldPlay()&&(this.videoPlayStarted=!0,this._playVideoElement())}));const r=()=>{!function(e,t,i){const s=(...a)=>{i.apply(null,a),e.removeEventListener(t,s)};e.addEventListener(t,s)}(s,"progress",(()=>{s.buffered.length?(s.currentTime=s.buffered.start(0),a({name:"playing"})):r()}))};r()}_initPlayerWith(e){this.bitrate=0,this.rep=0,this.sourceBuffer=0,this.bufferStates=[],this.filesFetcher&&this.filesFetcher.abortAll(),this.filesFetcher=new ee(3,te,this.bitrateSwitcher,this.params.config.maxParallelRequests,this.params.logger),this._setVideoSrc(e,(()=>this._switchToQuality(e)))}_representation(e){const{logger:t,videoElement:i,playerCallback:a}=this.params;let r=!1,n=null,o=null,h=null,u=null,c=!1;const d=()=>{const e=r&&(!c||c===this.rep);return e||t("Not running!"),e},l=(e,t,i)=>{h&&h.abort(),h=K(this.urlResolver.resolve(e,!1),t,i,(()=>this._retryCallback())).withTimeout(te).withBitrateReporting(this.bitrateSwitcher).withRetryCount(3).withFinally((()=>{h=null})).send()},p=(e,t,i)=>{(0,s.assertNonNullable)(this.filesFetcher),o?.abort(),o=this.filesFetcher.requestData(this.urlResolver.resolve(e,!1),t,i,(()=>this._retryCallback())).withFinally((()=>{o=null})).send()},m=e=>{const s=i.playbackRate;i.playbackRate!==e&&(t(`Playback rate switch: ${s}=>${e}`),i.playbackRate=e)},f=e=>{this.lowLatency=e,t(`lowLatency changed to ${e}`),g()},g=()=>{if(this.lowLatency||this.params.config.isLiveCatchUpMode){let e=this._getBufferSizeSec();if(this.bufferStates.length<5)return void m(1);const i=W()-1e4;let s=0;for(let t=0;t<this.bufferStates.length;t++){const a=this.bufferStates[t];e=Math.min(e,a.buf),a.ts<i&&s++}this.bufferStates.splice(0,s),t(`update playback rate;  minBuffer=${e} drop=${s} jitter=${this.sourceJitter}`);let a=e-1;this.sourceJitter>=0?a-=this.sourceJitter/2:this.sourceJitter-=1,m(a>3?1.15:a>1?1.1:a>.3?1.05:1)}else m(1)},b=e=>{let i;const r=()=>i&&i.start?i.start.length:0,n=e=>i.start[e]/1e3,o=e=>i.dur[e]/1e3,h=e=>i.fragIndex+e,c=(e,t)=>({chunkIdx:h(e),startTS:n(e),dur:o(e),discontinuity:t}),l=()=>{let e=0;if(i&&i.dur){let t=this.lowLatency?this.params.config.lowLatencyMinBuffer:this.params.config.minBuffer,s=this.lowLatency?this.params.config.lowLatencyMinBufferSegments:this.params.config.minBufferSegments,a=t;this.sourceJitter>1&&(a+=this.sourceJitter-1);let r=i.dur.length-1;for(;r>=0&&(a-=i.dur[r],!(a<=0));--r);e=Math.min(r,i.dur.length-1-s),e=Math.max(e,0)}return c(e,!0)},p=(e,t,i)=>{u&&u.abort(),u=K(this.urlResolver.resolve(e,!0,this.lowLatency),t,i,(()=>this._retryCallback())).withTimeout(te).withRetryCount(3).withFinally((()=>{u=null})).withJSONResponse().send()};return{seek:(t,o)=>{p(e,(e=>{if(!d())return;i=e;const h=!!i.lowLatency;h!==this.lowLatency&&f(h);let u=0;for(let e=0;e<i.dur.length;++e)u+=i.dur[e];u>0&&((0,s.assertNonNullable)(this.filesFetcher),this.filesFetcher.optimizeForSegDuration(u/i.dur.length)),a({name:"index",zeroTime:i.zeroTime,shiftDuration:i.shiftDuration}),this.sourceJitter=i.hasOwnProperty("jitter")?Math.min(10,Math.max(.01,i.jitter/1e3)):1,t((e=>{const t=r();if(!(t<=0)){if((0,s.isNonNullable)(e))for(let i=0;i<t;i++)if(n(i)>e)return c(i);return l()}})(o))}),(()=>this._handleNetworkError()))},nextChunk:e=>{const s=r(),a=e?e.chunkIdx+1:0,n=a-i.fragIndex;if(!(s<=0)){if(!e||n<0||n-s>10)return t(`Resync: offset=${n} bChunks=${s} chunk=`+JSON.stringify(e)),l();if(!(n>=s))return c(a-i.fragIndex,!1)}}}},S=()=>{r=!1,o&&o.abort(),h&&h.abort(),u&&u.abort(),(0,s.assertNonNullable)(this.filesFetcher),this.filesFetcher.abortAll()};return c={start:t=>{const{videoElement:i,logger:a}=this.params;let o,h,c,m,f,v,y,T=b(e.jidxUrl),E=0;const w=()=>{f&&(clearTimeout(f),f=void 0);const e=Math.max(500,1e3*(this._getBufferSizeSec()-this.sourceJitter-5)),t=E+e,i=W(),s=Math.min(1e4,t-i);E=i;const a=()=>{u||d()&&T.seek((()=>{d()&&(E=W(),A(),w())}))};s>0?f=window.setTimeout((()=>{this.paused?w():a()}),s):a()},A=()=>{let t;for(;t=T.nextChunk(m);)m=t,L(t);const i=T.nextChunk(c);if(i){if(c&&i.discontinuity)return a("Detected discontinuity; restarting playback"),void(this.paused?w():(S(),this._initPlayerWith(e)));C(i)}else w()},$=(e,t)=>{if(!d()||!this.sourceBuffer)return;let s,r,n;const o=i=>{window.setTimeout((()=>{d()&&$(e,t)}),i)};if(this.sourceBuffer.updating)a("Source buffer is updating; delaying appendBuffer"),o(100);else{const h=W(),u=i.currentTime;!this.paused&&i.buffered.length>1&&v===u&&h-y>500&&(a("Stall suspected; trying to fix"),this._fixupStall()),v!==u&&(v=u,y=h);const c=this._getBufferSizeSec();if(c>30)a(`Buffered ${c} seconds; delaying appendBuffer`),o(2e3);else try{this.sourceBuffer.appendBuffer(e),this.videoPlayStarted?(this.bufferStates.push({ts:h,buf:c}),g(),this.bufferStates.length>200&&this.bufferStates.shift()):this.shouldPlay()&&(this.videoPlayStarted=!0,this._playVideoElement()),t&&t()}catch(e){if("QuotaExceededError"!==e.name)throw e;a("QuotaExceededError; delaying appendBuffer"),n=this.sourceBuffer.buffered.length,0!==n&&(s=this.sourceBuffer.buffered.start(0),r=u,r-s>4&&this.sourceBuffer.remove(s,r-3)),o(1e3)}}},k=()=>{h&&o&&(a([`Appending chunk, sz=${h.byteLength}:`,JSON.stringify(c)]),$(h,(function(){h=null,A()})))},P=t=>e.fragUrlTemplate.replace("%%id%%",t.chunkIdx),C=e=>{d()&&p(P(e),((t,i)=>{if(d()){if(i/=1e3,h=t,c=e,n=e.startTS,i){const t=Math.min(10,e.dur/i);this.downloadRate=this.downloadRate?.7*this.downloadRate+.3*t:t}k()}}),(()=>this._handleNetworkError()))},L=e=>{d()&&((0,s.assertNonNullable)(this.filesFetcher),this.filesFetcher.prefetch(this.urlResolver.resolve(P(e),!1)))},D=t=>{d()&&(e.cachedHeader=t,$(t,(()=>{o=!0,k()})))};r=!0,T.seek((e=>{if(d()){if(E=W(),!e)return void w();m=e,!(0,s.isNullable)(t)||e.startTS>t?C(e):(c=e,A())}}),t),e.cachedHeader?D(e.cachedHeader):l(e.headerUrl,D,(()=>this._handleNetworkError()))},stop:S,getTimestampSec:()=>n},c}_switchToQuality(e){const{logger:t,playerCallback:i}=this.params;let a;e.bitrate!==this.bitrate&&(this.rep&&(a=this.rep.getTimestampSec(),(0,s.isNonNullable)(a)&&(a+=.1),this.rep.stop()),this.currentManifestEntry=e,this.rep=this._representation(e),t(`switch to quality: codecs=${e.codecs}; headerUrl=${e.headerUrl}; bitrate=${e.bitrate}`),this.bitrate=e.bitrate,(0,s.assertNonNullable)(this.bitrateSwitcher),this.bitrateSwitcher.notifySwitch(this.bitrate),this.rep.start(a),i({name:"qualitySwitch",quality:e}))}_qualityAvailable(e){return(0,s.isNonNullable)(this.manifest.find((t=>t.name===e)))}_initBitrateSwitcher(){const{logger:e,playerCallback:t}=this.params,i=t=>{if(!this.autoQuality)return;let i,s,a;this.currentManifestEntry&&this._qualityAvailable(this.currentManifestEntry.name)&&t<this.bitrate&&(s=this._getBufferSizeSec(),a=t/this.bitrate,s>10&&a>.8||s>15&&a>.5||s>20&&a>.3)?e(`Not switching: buffer=${Math.floor(s)}; bitrate=${this.bitrate}; newRate=${Math.floor(t)}`):(i=this._selectQuality(t),i?this._switchToQuality(i):e(`Could not find quality by bitrate ${t}`))},s=(()=>({updateChunk:(e,i)=>{const s=W();if(this.chunkRateEstimator.addInterval(e,s,i)){const a=this.chunkRateEstimator.getBitRate();return t({name:"bandwidth",size:i,duration:s-e,speed:a}),!0}},get:()=>{const e=this.chunkRateEstimator.getBitRate();return e?.85*e:0}}))();let a,r=-1/0,n=!0;const o=()=>{let e=s.get();if(e&&a&&this.autoQuality){if(n&&e>a&&J(r)<3e4)return;i(e)}n=this.autoQuality};return{updateChunk:(e,t)=>{const i=s.updateChunk(e,t);return i&&o(),i},notifySwitch:e=>{const t=W();e<a&&(r=t),a=e}}}_fetchManifest(e,t,i){this.manifestRequest=K(this.urlResolver.resolve(e,!0),t,i,(()=>this._retryCallback())).withJSONResponse().withTimeout(te).withRetryCount(this.params.config.manifestRetryMaxCount).withRetryInterval(this.params.config.manifestRetryInterval,this.params.config.manifestRetryMaxInterval).send().withFinally((()=>{this.manifestRequest=void 0}))}_playVideoElement(e){const{videoElement:t}=this.params;z(t).then((t=>{t||e?.()}))}_handleManifestUpdate(e){const{logger:t,playerCallback:i,videoElement:s}=this.params;this.manifest=(e=>{const t=[];return e?.length?(e.forEach(((e,i)=>{e.video&&s.canPlayType(e.codecs).replace(/no/,"")&&window.MediaSource.isTypeSupported(e.codecs)&&(e.index=i,t.push(e))})),t.sort((function(e,t){return e.video&&t.video?t.video.height-e.video.height:t.bitrate-e.bitrate})),t):(i({name:"error",type:"empty_manifest"}),[])})(e),t(`Valid manifest entries: ${this.manifest.length}/${e.length}`),i({name:"manifest",manifest:this.manifest})}_refetchManifest(e){this.destroyed||(this.manifestRefetchTimer&&clearTimeout(this.manifestRefetchTimer),this.manifestRefetchTimer=window.setTimeout((()=>{this._fetchManifest(e,(t=>{this.destroyed||(this._handleManifestUpdate(t),this._refetchManifest(e))}),(()=>this._refetchManifest(e)))}),6e4))}_initManifest(){this._fetchManifest(this.manifestUrl,(e=>{this.destroyed||(this._handleManifestUpdate(e),this._refetchManifest(this.manifestUrl))}),(()=>this._handleNetworkError()))}constructor(e){this.paused=!1,this.autoQuality=!0,this.maxAutoQuality=void 0,this.buffering=!0,this.destroyed=!1,this.videoPlayStarted=!1,this.lowLatency=!1,this.bitrate=0,this.manifest=[],this.sourceBuffer=0,this.bufferStates=[],this.sourceJitter=-1,this.params=e,this.chunkRateEstimator=new Z(this.params.logger),this._initVideo()}}class se{connect(e){this.log=e.logger.createComponentLog("DroppedFramesManager"),this.video=e.video,this.isAuto=e.isAuto,this.droppedFramesChecker=e.droppedFramesChecker,this.subscription.add(e.playing$.subscribe((()=>this.playing=!0))),this.subscription.add(e.pause$.subscribe((()=>this.playing=!1))),this.subscription.add(e.tracks$.subscribe((e=>this.tracks=e))),this.isEnabled&&this.subscribe()}destroy(){this.currentTimer&&window.clearTimeout(this.currentTimer),this.subscription.unsubscribe()}get droppedVideoMaxQualityLimit(){return this.maxQualityLimit}subscribe(){this.subscription.add((0,s.fromEvent)(this.video,"resize").subscribe(this.handleChangeVideoQuality));const e=(0,s.interval)(this.droppedFramesChecker.checkTime).pipe((0,s.filter)((()=>this.playing)),(0,s.filter)((()=>{const e=!!this.isForceCheckCounter;return e&&(this.isForceCheckCounter-=1),!e}))),t=this.forceChecker$.pipe((0,s.debounce)(this.droppedFramesChecker.checkTime)),i=(0,s.merge)(e,t);this.subscription.add(i.subscribe(this.checkDroppedFrames))}onChangeQuality(e){this.currentQuality=e;const{totalVideoFrames:t,droppedVideoFrames:i}=this.video.getVideoPlaybackQuality();this.savePrevFrameCounts(t,i),this.isForceCheckCounter=this.droppedFramesChecker.tickCountAfterQualityChange,this.forceChecker$.next()}onDroopedVideoFramesLimitTrigger(){this.isAuto.getState()&&(this.log({message:`[onDroopedVideoFramesLimit]. maxQualityLimit: ${this.maxQualityLimit}`}),this.onDroopedVideoFramesLimit$.next())}getMaxQualityLimit(e){const t=Object.entries(this.limitCounts).filter((([,e])=>e>=this.droppedFramesChecker.countLimit)).sort((([e],[t])=>(0,s.isLower)(e,t)?-1:1))?.[0]?.[0];return e??t}get isEnabled(){return this.droppedFramesChecker.enabled&&this.isDroppedFramesCheckerSupport}get isDroppedFramesCheckerSupport(){return!!this.video&&"function"==typeof this.video.getVideoPlaybackQuality}savePrevFrameCounts(e,t){this.prevTotalVideoFrames=e,this.prevDroppedVideoFrames=t}constructor(){this.onDroopedVideoFramesLimit$=new s.Subject,this.subscription=new s.Subscription,this.playing=!1,this.tracks=[],this.forceChecker$=new s.Subject,this.isForceCheckCounter=0,this.prevTotalVideoFrames=0,this.prevDroppedVideoFrames=0,this.limitCounts={},this.handleChangeVideoQuality=()=>{const e=this.tracks.find((({size:e})=>e?.height===this.video.videoHeight&&e?.width===this.video.videoWidth));e&&!(0,s.isInvariantQuality)(e.quality)&&this.onChangeQuality(e.quality)},this.checkDroppedFrames=()=>{const{totalVideoFrames:e,droppedVideoFrames:t}=this.video.getVideoPlaybackQuality(),i=e-this.prevTotalVideoFrames,a=1-(i-(t-this.prevDroppedVideoFrames))/i;!isNaN(a)&&a>0&&this.log({message:`[dropped]. current dropped percent: ${a}, limit: ${this.droppedFramesChecker.percentLimit}`}),!isNaN(a)&&a>=this.droppedFramesChecker.percentLimit&&(0,s.isHigher)(this.currentQuality,this.droppedFramesChecker.minQualityBanLimit)&&(this.limitCounts[this.currentQuality]=(this.limitCounts[this.currentQuality]??0)+1,this.maxQualityLimit=this.getMaxQualityLimit(this.currentQuality),this.currentTimer&&window.clearTimeout(this.currentTimer),this.currentTimer=window.setTimeout((()=>this.maxQualityLimit=this.getMaxQualityLimit()),this.droppedFramesChecker.qualityUpWaitingTime),this.onDroopedVideoFramesLimitTrigger()),this.savePrevFrameCounts(e,t)}}}var ae;!function(e){e.STOPPED="stopped",e.MANIFEST_READY="manifest_ready",e.READY="ready",e.PLAYING="playing",e.PAUSED="paused"}(ae||(ae={}));const re=[ae.PAUSED,ae.PLAYING,ae.READY],ne=[ae.PAUSED,ae.PLAYING,ae.READY];class oe{destroy(){this.subscription.unsubscribe(),this.textTracksManager.destroy(),this.droppedFramesManager.destroy(),this.dash.destroy(),this.params.output.element$.next(void 0),$(this.video)}createLiveDashPlayer(){const e=new ie({videoElement:this.video,config:{maxParallelRequests:this.params.config.maxParallelRequests,minBuffer:this.params.tuning.live.minBuffer,minBufferSegments:this.params.tuning.live.minBufferSegments,lowLatencyMinBuffer:this.params.tuning.live.lowLatencyMinBuffer,lowLatencyMinBufferSegments:this.params.tuning.live.lowLatencyMinBufferSegments,isLiveCatchUpMode:this.params.tuning.live.isLiveCatchUpMode,manifestRetryInterval:this.params.tuning.manifestRetryInterval,manifestRetryMaxInterval:this.params.tuning.manifestRetryMaxInterval,manifestRetryMaxCount:this.params.tuning.manifestRetryMaxCount},playerCallback:this._dashCb,logger:e=>{this.params.dependencies.logger.log({message:String(e),component:"LiveDashPlayer"})}});return e.pause(),e}prepare(){const e=this.representations$.getValue(),t=this.params.desiredState.videoTrack.getTransition()?.to??this.params.desiredState.videoTrack.getState(),i=this.params.desiredState.autoVideoTrackSwitching.getTransition()?.to??this.params.desiredState.autoVideoTrackSwitching.getState(),a=!i&&(0,s.isNonNullable)(t)?t:Y(e.map((({track:e})=>e)),{container:{width:this.video.offsetWidth,height:this.video.offsetHeight},throughput:this.params.dependencies.throughputEstimator.throughput$.getValue(),tuning:this.params.tuning.autoTrackSelection,limits:this.params.desiredState.autoVideoTrackLimits.getState(),droppedVideoMaxQualityLimit:this.droppedFramesManager.droppedVideoMaxQualityLimit,abrLogger:this.params.dependencies.abrLogger}),r=a?.id,n=this.params.desiredState.videoTrack.getTransition(),o=this.params.desiredState.videoTrack.getState()?.id,h=this.params.desiredState.autoVideoTrackSwitching.getTransition();if(a&&(n||r!==o)&&this.setVideoTrack(a),h&&this.setAutoQuality(i),n||h||r!==o){const t=e.find((({track:e})=>e.id===r))?.representation;(0,s.assertNonNullable)(t,"Representations missing"),this.dash.startPlay(t,i)}}setVideoTrack(e){const t=this.representations$.getValue().find((({track:t})=>t.id===e.id))?.representation;(0,s.assertNonNullable)(t,`No such representation ${e.id}`),this.dash.switchByName(t.name),this.params.desiredState.videoTrack.setState(e)}setAutoQuality(e){this.dash.setAutoQualityEnabled(e),this.params.desiredState.autoVideoTrackSwitching.setState(e)}seek(e){this.log({message:`[seek] position: ${e}`}),this.params.output.willSeekEvent$.next();const t=this.params.desiredState.playbackState.getState(),i=this.videoState.getState(),s=t===r.PAUSED&&i===ae.PAUSED,a=-e,n=a<=this.maxSeekBackTime$.getValue()?a:0;this.params.output.position$.next(e/1e3),this.dash.reinit(g(this.params.source.url,n)),s&&this.dash.pause(),this.liveOffset.resetTo(n,s)}constructor(e){this.subscription=new s.Subscription,this.videoState=new v(ae.STOPPED),this.representations$=new s.ValueSubject([]),this.textTracksManager=new R,this.droppedFramesManager=new se,this.maxSeekBackTime$=new s.ValueSubject(1/0),this.zeroTime$=new s.ValueSubject(void 0),this.liveOffset=new N,this._dashCb=e=>{switch(e.name){case"buffering":{const t=e.isBuffering;this.params.output.isBuffering$.next(t);break}case"error":this.params.output.error$.next({id:`DashLiveProviderInternal:${e.type}`,category:s.ErrorCategory.WTF,message:"LiveDashPlayer reported error"});break;case"manifest":{const t=e.manifest,i=[];for(const e of t){const t=e.name??e.index.toString(10),a=O(e.name)??(0,s.videoSizeToQuality)(e.video),r=e.bitrate/1e3,n={...e.video};if(!a)continue;const o={id:t,quality:a,bitrate:r,size:n};i.push({track:o,representation:e})}this.representations$.next(i),this.params.output.availableVideoTracks$.next(i.map((({track:e})=>e))),this.videoState.getTransition()?.to===ae.MANIFEST_READY&&this.videoState.setState(ae.MANIFEST_READY);break}case"qualitySwitch":{const t=e.quality,i=this.representations$.getValue().find((({representation:e})=>e===t))?.track;this.params.output.hostname$.next(new URL(t.headerUrl,this.params.source.url).hostname),(0,s.isNonNullable)(i)&&this.params.output.currentVideoTrack$.next(i);break}case"bandwidth":{const{size:t,duration:i}=e;this.params.dependencies.throughputEstimator.addRawSpeed(t,i);break}case"index":this.maxSeekBackTime$.next(e.shiftDuration||0),this.zeroTime$.next(e.zeroTime)}},this.syncPlayback=()=>{const e=this.videoState.getState(),t=this.videoState.getTransition(),i=this.params.desiredState.playbackState.getState(),a=this.params.desiredState.playbackState.getTransition(),n=this.params.desiredState.seekState.getState();if(this.log({message:`[syncPlayback] videoState: ${e}; videoTransition: ${JSON.stringify(t)}; desiredPlaybackState: ${i}; seekState: ${JSON.stringify(n)};`}),i===r.STOPPED)return void(e!==ae.STOPPED&&(this.videoState.startTransitionTo(ae.STOPPED),this.dash.destroy(),this.video.removeAttribute("src"),this.video.load(),this.videoState.setState(ae.STOPPED)));if(t)return;const o=this.params.desiredState.videoTrack.getTransition(),h=this.params.desiredState.autoVideoTrackSwitching.getTransition();if(ne.includes(e)&&(o||h))this.prepare();else if(a?.to!==r.PAUSED&&n.state===d.Requested&&re.includes(e))this.seek(n.position-this.liveOffset.getTotalPausedTime());else switch(e){case ae.STOPPED:return this.videoState.startTransitionTo(ae.MANIFEST_READY),void this.dash.attachSource(g(this.params.source.url));case ae.MANIFEST_READY:this.videoState.startTransitionTo(ae.READY),this.prepare();break;case ae.READY:if(i===r.PAUSED)this.videoState.setState(ae.PAUSED);else if(i===r.PLAYING){this.videoState.startTransitionTo(ae.PLAYING);const e=a?.from;e&&e===r.READY&&this.dash.catchUp(),this.dash.play((()=>{this.liveOffset.pause(),this.videoState.setState(ae.PAUSED)}))}return;case ae.PLAYING:return void(i===r.PAUSED&&(this.videoState.startTransitionTo(ae.PAUSED),this.liveOffset.pause(),this.dash.pause()));case ae.PAUSED:if(i===r.PLAYING)if(this.videoState.startTransitionTo(ae.PLAYING),this.liveOffset.getTotalPausedTime()<this.params.config.maxPausedTime&&this.liveOffset.getTotalOffset()<this.maxSeekBackTime$.getValue())this.liveOffset.resume(),this.dash.play((()=>{this.liveOffset.pause(),this.videoState.setState(ae.PAUSED)})),this.params.output.position$.next(-this.liveOffset.getTotalOffset()/1e3);else{let e=this.liveOffset.getTotalOffset();e>=this.maxSeekBackTime$.getValue()&&(e=0,this.liveOffset.resetTo(e)),this.liveOffset.resume(),this.params.output.position$.next(-e/1e3),this.dash.reinit(g(this.params.source.url,e))}return;default:return(0,s.assertNever)(e)}},this.params=e,this.log=this.params.dependencies.logger.createComponentLog("DashLiveProvider");const t=t=>{e.output.error$.next({id:"DashLiveProvider",category:s.ErrorCategory.WTF,message:"DashLiveProvider internal logic error",thrown:t})};(0,s.merge)(this.videoState.stateChangeStarted$.pipe((0,s.map)((e=>({transition:e,type:"start"})))),this.videoState.stateChangeEnded$.pipe((0,s.map)((e=>({transition:e,type:"end"}))))).subscribe((({transition:e,type:t})=>{this.log({message:`[videoState change] ${t}: ${JSON.stringify(e)}`})})),this.video=A(e.container),this.params.output.element$.next(this.video),this.dash=this.createLiveDashPlayer(),this.params.output.duration$.next(1/0),this.params.output.position$.next(0),this.params.output.isLive$.next(!0),this.params.output.canChangePlaybackSpeed$.next(!1),this.params.output.hostname$.next(G(this.params.source.url)),this.params.output.autoVideoTrackLimitingAvailable$.next(!0),this.params.output.availableVideoTracks$.next([]),this.params.output.availableAudioTracks$.next([]),this.params.output.isAudioAvailable$.next(!0),this.textTracksManager.connect(this.video,this.params.desiredState,this.params.output);const i=M(this.video);this.droppedFramesManager.connect({logger:this.params.dependencies.logger,video:this.video,droppedFramesChecker:this.params.tuning.droppedFramesChecker,isAuto:this.params.desiredState.autoVideoTrackSwitching,playing$:i.playing$,pause$:i.pause$,tracks$:this.representations$.pipe((0,s.map)((e=>e.map((({track:e})=>e)))))}),this.subscription.add(i.canplay$.subscribe((()=>{this.videoState.getTransition()?.to===ae.READY&&this.videoState.setState(ae.READY)}),t)).add(i.pause$.subscribe((()=>{this.videoState.setState(ae.PAUSED)}),t)).add(i.playing$.subscribe((()=>{this.params.desiredState.seekState.getState().state===d.Applying&&this.params.output.seekedEvent$.next(),this.videoState.setState(ae.PLAYING)}),t)).add(i.error$.subscribe(this.params.output.error$)).add(this.maxSeekBackTime$.pipe((0,s.filterChanged)(),(0,s.map)((e=>-e/1e3))).subscribe(this.params.output.duration$)).add((0,s.combine)({zeroTime:this.zeroTime$.pipe((0,s.filter)(s.isNonNullable)),position:i.timeUpdate$}).subscribe((({zeroTime:e,position:t})=>this.params.output.liveTime$.next(e+1e3*t)),t)).add(P(this.video,this.params.desiredState.isLooped,t)).add(C(this.video,this.params.desiredState.volume,i.volumeState$,t)).add(i.volumeState$.subscribe(this.params.output.volume$,t)).add(L(this.video,this.params.desiredState.playbackRate,i.playbackRateState$,t)).add(i.loadStart$.subscribe(this.params.output.firstBytesEvent$)).add(i.playing$.subscribe(this.params.output.firstFrameEvent$)).add(i.canplay$.subscribe(this.params.output.canplay$)).add(i.inPiP$.subscribe(this.params.output.inPiP$)).add(i.inFullscreen$.subscribe(this.params.output.inFullscreen$)).add(this.params.desiredState.autoVideoTrackLimits.stateChangeStarted$.subscribe((({to:{max:e}})=>{const t=e&&(0,s.videoQualityToHeight)(e);this.dash.setMaxAutoQuality(t),this.params.output.autoVideoTrackLimits$.next({max:e})}))).add(this.videoState.stateChangeEnded$.subscribe((e=>{switch(e.to){case ae.STOPPED:this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.desiredState.playbackState.setState(r.STOPPED);break;case ae.MANIFEST_READY:case ae.READY:this.params.desiredState.playbackState.getTransition()?.to===r.READY&&this.params.desiredState.playbackState.setState(r.READY);break;case ae.PAUSED:this.params.desiredState.playbackState.setState(r.PAUSED);break;case ae.PLAYING:this.params.desiredState.playbackState.setState(r.PLAYING);break;default:return(0,s.assertNever)(e.to)}}),t)).add((0,s.merge)(e.desiredState.playbackState.stateChangeStarted$,e.desiredState.seekState.stateChangeEnded$,e.desiredState.videoTrack.stateChangeStarted$,e.desiredState.autoVideoTrackSwitching.stateChangeStarted$,this.videoState.stateChangeEnded$,this.droppedFramesManager.onDroopedVideoFramesLimit$,(0,s.observableFrom)(["init"])).pipe((0,s.debounce)(0)).subscribe(this.syncPlayback,t))}}var he,ue,ce,de,le,pe,me,fe;!function(e){e.VIDEO="video",e.AUDIO="audio",e.TEXT="text"}(he||(he={})),function(e){e[e.ActiveLowLatency=0]="ActiveLowLatency",e[e.LiveWithTargetOffset=1]="LiveWithTargetOffset",e[e.LiveForwardBuffering=2]="LiveForwardBuffering",e[e.None=3]="None"}(ue||(ue={})),function(e){e.WEBM_AS_IN_SPEC="urn:mpeg:dash:profile:webm-on-demand:2012",e.WEBM_AS_IN_FFMPEG="urn:webm:dash:profile:webm-on-demand:2012"}(ce||(ce={})),function(e){e.BYTE_RANGE="byteRange",e.TEMPLATE="template"}(de||(de={})),function(e){e.NONE="none",e.DOWNLOADING="downloading",e.DOWNLOADED="downloaded",e.PARTIALLY_FED="partially_fed",e.PARTIALLY_EJECTED="partially_ejected",e.FED="fed"}(le||(le={})),function(e){e.MP4="mp4",e.WEBM="webm"}(pe||(pe={})),function(e){e[e.RECTANGULAR=0]="RECTANGULAR",e[e.EQUIRECTANGULAR=1]="EQUIRECTANGULAR",e[e.CUBEMAP=2]="CUBEMAP",e[e.MESH=3]="MESH"}(me||(me={})),function(e){e.STOPPED="stopped",e.READY="ready",e.PLAYING="playing",e.PAUSED="paused"}(fe||(fe={}));var ge=(e,t)=>{let i=0;for(let s=0;s<e.length;s++){const a=1e3*e.start(s),r=1e3*e.end(s);a<=t&&t<=r&&(i=r)}return Math.max(i-t,0)};class be{addEventListener(e,t,i){e in this.listeners||(this.listeners[e]=[]),this.listeners[e].push({callback:t,options:i})}removeEventListener(e,t){if(!(e in this.listeners))return;const i=this.listeners[e];for(let e=0,s=i.length;e<s;e++)if(i[e].callback===t)return void i.splice(e,1)}dispatchEvent(e){if(!(e.type in this.listeners))return;const t=this.listeners[e.type].slice();for(let i=0,s=t.length;i<s;i++){const s=t[i];try{s.callback.call(this,e)}catch(e){Promise.resolve().then((()=>{throw e}))}s.options&&s.options.once&&this.removeEventListener(e.type,s.callback)}return!e.defaultPrevented}constructor(){Object.defineProperty(this,"listeners",{value:{},writable:!0,configurable:!0})}}class Se extends be{toString(){return"[object AbortSignal]"}dispatchEvent(e){"abort"===e.type&&(this.aborted=!0,"function"==typeof this.onabort&&this.onabort.call(this,e)),super.dispatchEvent(e)}constructor(){super(),this.listeners||be.call(this),Object.defineProperty(this,"aborted",{value:!1,writable:!0,configurable:!0}),Object.defineProperty(this,"onabort",{value:null,writable:!0,configurable:!0}),Object.defineProperty(this,"reason",{value:void 0,writable:!0,configurable:!0})}}let ve=class{abort(e){let t;try{t=new Event("abort")}catch{typeof document<"u"?document.createEvent?(t=document.createEvent("Event"),t.initEvent("abort",!1,!1)):(t=document.createEventObject(),t.type="abort"):t={type:"abort",bubbles:!1,cancelable:!1}}let i=e;if(void 0===i)if(typeof document>"u")i=new Error("This operation was aborted"),i.name="AbortError";else try{i=new DOMException("signal is aborted without reason")}catch{i=new Error("This operation was aborted"),i.name="AbortError"}this.signal.reason=i,this.signal.dispatchEvent(t)}toString(){return"[object AbortController]"}constructor(){Object.defineProperty(this,"signal",{value:new Se,writable:!0,configurable:!0})}};function ye(e){return e.__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL?(console.log("__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL=true is set, will force install polyfill"),!0):"function"==typeof e.Request&&!e.Request.prototype.hasOwnProperty("signal")||!e.AbortController}typeof Symbol<"u"&&Symbol.toStringTag&&(ve.prototype[Symbol.toStringTag]="AbortController",Se.prototype[Symbol.toStringTag]="AbortSignal");const Te=ye({fetch:window.fetch,Request:window.Request,AbortController:window.AbortController}),Ee=Te?function(e){"function"==typeof e&&(e={fetch:e});const{fetch:t,Request:i=t.Request,AbortController:s,__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL:a=!1}=e;if(!ye({fetch:t,Request:i,AbortController:s,__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL:a}))return{fetch:t,Request:r};let r=i;(r&&!r.prototype.hasOwnProperty("signal")||a)&&(r=function(e,t){let s;t&&t.signal&&(s=t.signal,delete t.signal);const a=new i(e,t);return s&&Object.defineProperty(a,"signal",{writable:!1,enumerable:!1,configurable:!0,value:s}),a},r.prototype=i.prototype);const n=t;return{fetch:(e,t)=>{const i=r&&r.prototype.isPrototypeOf(e)?e.signal:t?t.signal:void 0;if(i){let s;try{s=new DOMException("Aborted","AbortError")}catch{s=new Error("Aborted"),s.name="AbortError"}if(i.aborted)return Promise.reject(s);const a=new Promise(((e,t)=>{i.addEventListener("abort",(()=>t(s)),{once:!0})}));return t&&t.signal&&delete t.signal,Promise.race([a,n(e,t)])}return n(e,t)},Request:r}}({fetch:window.fetch,Request:window.Request,AbortController:window.AbortController}):void 0,we=Te?Ee.fetch:window.fetch;Te?Ee.Request:window.Request;const Ae=Te?ve:window.AbortController;var $e=(e,t)=>{for(let i=0;i<e.length;i++)if(1e3*e.start(i)<=t&&1e3*e.end(i)>t)return!0;return!1};const ke="function"!=typeof window.requestIdleCallback||"function"!=typeof window.cancelIdleCallback?(e,t={})=>{const i=t.timeout||1,s=performance.now();return window.setTimeout((()=>{e({get didTimeout(){return!t.timeout&&performance.now()-s-1>i},timeRemaining:()=>Math.max(0,performance.now()-s+1)})}),1)}:window.requestIdleCallback;let Pe=!1;try{Pe=(0,s.getCurrentBrowser)().browser===s.CurrentClientBrowser.Safari&&parseInt(navigator.userAgent.match(/Version\/(\d+)/)?.[1]??"",10)<=16}catch(n){console.error(n)}class Ce{async append(e,t){return(!t||!t.aborted)&&new Promise((i=>{const s={operation:"append",data:e,signal:t,callback:i};this.queue.push(s),this.pull()}))}async remove(e,t,i){return(!i||!i.aborted)&&new Promise((s=>{const a={operation:"remove",from:e,to:t,signal:i,callback:s};this.queue.unshift(a),this.pull()}))}async abort(e){return new Promise((t=>{let i;i=Pe&&e?{operation:"safariAbort",init:e,callback:t}:{operation:"abort",callback:t};for(const{callback:e}of this.queue)e(!1);i&&(this.queue=[i]),this.pull()}))}destroy(){this.destroyed=!0,this.buffer.removeEventListener("updateend",this.completeTask),this.queue=[],this.currentTask=null;try{this.buffer.abort()}catch(e){if(!(e instanceof DOMException&&"InvalidStateError"===e.name))throw e}}pull(){if(this.buffer.updating||this.currentTask||this.destroyed)return;const e=this.queue.shift();if(!e)return;if(e.signal?.aborted)return e.callback(!1),void this.pull();this.currentTask=e;const{operation:t}=this.currentTask;try{this.execute(this.currentTask)}catch(e){e instanceof DOMException&&"QuotaExceededError"===e.name&&"append"===t?this.bufferFull$.next(this.currentTask.data.byteLength):e instanceof DOMException&&"InvalidStateError"===e.name||this.error$.next({id:`BufferTaskQueue:${t}`,category:s.ErrorCategory.VIDEO_PIPELINE,message:"Buffer operation failed",thrown:e}),this.currentTask.callback(!1),this.currentTask=null}this.currentTask&&"abort"===this.currentTask.operation&&this.completeTask()}execute(e){const{operation:t}=e;switch(t){case"append":this.buffer.appendBuffer(e.data);break;case"remove":this.buffer.remove(e.from/1e3,e.to/1e3);break;case"abort":this.buffer.abort();break;case"safariAbort":this.buffer.abort(),this.buffer.appendBuffer(e.init);break;default:(0,s.assertNever)(t)}}constructor(e){this.bufferFull$=new s.Subject,this.error$=new s.Subject,this.queue=[],this.currentTask=null,this.destroyed=!1,this.completeTask=()=>{try{if(this.currentTask){const e=this.currentTask.signal?.aborted;this.currentTask.callback(!e),this.currentTask=null}this.queue.length&&this.pull()}catch(e){this.error$.next({id:"BufferTaskQueueUnknown",category:s.ErrorCategory.VIDEO_PIPELINE,message:"Buffer appending or removal failed",thrown:e})}},this.buffer=e,this.buffer.addEventListener("updateend",this.completeTask)}}var Le,De=e=>{let t=0;for(let i=0;i<e.length;i++)t+=e.end(i)-e.start(i);return 1e3*t};class Re{get id(){return this.type}get size(){return this.size32}parseChildrenBoxes(){return[]}readString(e,t="ascii"){const i=new TextDecoder(t).decode(new DataView(this.source.buffer,this.source.byteOffset+this.cursor,e));return this.cursor+=e,i}readUint8(){const e=this.source.getUint8(this.cursor);return this.cursor+=1,e}readUint16(){const e=this.source.getUint16(this.cursor);return this.cursor+=2,e}readUint32(){const e=this.source.getUint32(this.cursor);return this.cursor+=4,e}readUint64(){const e=this.source.getBigInt64(this.cursor);return this.cursor+=8,e}constructor(e){this.cursor=0,this.source=e,this.children=[];const t=this.readUint32();this.size32=t<=e.buffer.byteLength?t:NaN,this.type=this.readString(4),this.size64=0,this.usertype=0,this.content=new DataView(e.buffer,e.byteOffset+this.cursor,this.size32?this.size32-8:void 0),this.children=this.parseChildrenBoxes()}}class Ne extends Re{}class xe extends Re{constructor(e){super(e);const t=this.readUint32();this.version=t>>>24,this.flags=16777215&t}}!function(e){e[e.MONOSCOPIC=0]="MONOSCOPIC",e[e.TOP_BOTTOM=1]="TOP_BOTTOM",e[e.LEFT_RIGHT=2]="LEFT_RIGHT",e[e.STEREO_CUSTOM=3]="STEREO_CUSTOM",e[e.RIGHT_LEFT=4]="RIGHT_LEFT"}(Le||(Le={}));const Ie={ftyp:class extends Re{constructor(e){super(e),this.compatibleBrands=[],this.majorBrand=this.readString(4),this.minorVersion=this.readUint32();let t=this.size-this.cursor;for(;t;){const e=this.readString(4);this.compatibleBrands.push(e),t-=4}}},moov:class extends Re{parseChildrenBoxes(){return Ve(this.content)}},moof:class extends Re{parseChildrenBoxes(){return Ve(this.content)}},mdat:class extends Re{constructor(e){super(e),this.data=this.content}},sidx:class extends xe{get earliestPresentationTime(){return this.earliestPresentationTime32}get firstOffset(){return this.firstOffset32}constructor(e){super(e),this.segments=[],this.referenceId=this.readUint32(),this.timescale=this.readUint32(),this.earliestPresentationTime32=this.readUint32(),this.firstOffset32=this.readUint32(),this.earliestPresentationTime64=0,this.firstOffset64=0,this.referenceCount=65535&this.readUint32();for(let e=0;e<this.referenceCount;e++){let e=this.readUint32();const t=e>>>31,i=e<<1>>>1,s=this.readUint32();e=this.readUint32();const a=e>>>28,r=e<<3>>>3;this.segments.push({referenceType:t,referencedSize:i,subsegmentDuration:s,SAPType:a,SAPDeltaTime:r})}}},trak:class extends Re{parseChildrenBoxes(){return Ve(this.content)}},mdia:class extends Re{parseChildrenBoxes(){return Ve(this.content)}},mfhd:class extends xe{constructor(e){super(e),this.sequenceNumber=this.readUint32()}},tkhd:class extends xe{constructor(e){super(e),this.creationTime=this.readUint32(),this.modificationTime=this.readUint32(),this.trackId=this.readUint32(),this.cursor+=4,this.duration=this.readUint32(),this.cursor+=8,this.layer=this.readUint16(),this.alternateGroup=this.readUint16(),this.cursor+=2,this.cursor+=2,this.matrix=[[this.readUint32(),this.readUint32(),this.readUint32()],[this.readUint32(),this.readUint32(),this.readUint32()],[this.readUint32(),this.readUint32(),this.readUint32()]],this.width=this.readUint32(),this.height=this.readUint32()}},traf:class extends Re{parseChildrenBoxes(){return Ve(this.content)}},tfhd:class extends xe{constructor(e){super(e),this.trackId=this.readUint32(),1&this.flags&&(this.baseDataOffset=this.readUint64()),2&this.flags&&(this.sampleDescriptionIndex=this.readUint32()),8&this.flags&&(this.defaultSampleDuration=this.readUint32()),16&this.flags&&(this.defaultSampleSize=this.readUint32()),32&this.flags&&(this.defaultSampleFlags=this.readUint32())}},tfdt:class extends xe{get baseMediaDecodeTime(){return 1===this.version?this.baseMediaDecodeTime64:this.baseMediaDecodeTime32}constructor(e){super(e),this.baseMediaDecodeTime32=0,this.baseMediaDecodeTime64=BigInt(0),1===this.version?this.baseMediaDecodeTime64=this.readUint64():this.baseMediaDecodeTime32=this.readUint32()}},trun:class extends xe{constructor(e){super(e),this.sampleDuration=[],this.sampleSize=[],this.sampleFlags=[],this.sampleCompositionTimeOffset=[],this.optionalFields=0,this.sampleCount=this.readUint32(),1&this.flags&&(this.dataOffset=this.readUint32()),4&this.flags&&(this.firstSampleFlags=this.readUint32());for(let e=0;e<this.sampleCount;e++)256&this.flags&&this.sampleDuration.push(this.readUint32()),512&this.flags&&this.sampleSize.push(this.readUint32()),1024&this.flags&&this.sampleFlags.push(this.readUint32()),2048&this.flags&&this.sampleCompositionTimeOffset.push(this.readUint32())}},minf:class extends Re{parseChildrenBoxes(){return Ve(this.content)}},sv3d:class extends Re{parseChildrenBoxes(){return Ve(this.content)}},st3d:class extends xe{constructor(e){switch(super(e),this.readUint8()){case 0:this.stereoMode=Le.MONOSCOPIC;break;case 1:this.stereoMode=Le.TOP_BOTTOM;break;case 2:this.stereoMode=Le.LEFT_RIGHT;break;case 3:this.stereoMode=Le.STEREO_CUSTOM;break;case 4:this.stereoMode=Le.RIGHT_LEFT}this.cursor+=1}},prhd:class extends xe{constructor(e){super(e),this.poseYawDegrees=this.readUint32(),this.posePitchDegrees=this.readUint32(),this.poseRollDegrees=this.readUint32()}},proj:class extends Re{parseChildrenBoxes(){return Ve(this.content)}},equi:class extends xe{constructor(e){super(e),this.projectionBoundsTop=this.readUint32(),this.projectionBoundsBottom=this.readUint32(),this.projectionBoundsLeft=this.readUint32(),this.projectionBoundsRight=this.readUint32()}},unknown:Ne};const Me=new class{createBox(e,t){const i=Ie[e];return i?new i(t):new Ne(t)}createFromView(e){const t=new TextDecoder("ascii").decode(new DataView(e.buffer,e.byteOffset+4,4));return Me.createBox(t,new DataView(e.buffer,e.byteOffset))}};function Oe(e,t){const i=new Uint8Array(e.buffer),s=t.split("").map((e=>e.charCodeAt(0)));let a=e.byteOffset,r=[];for(;a<i.byteLength;){if(i[a]===s[r.length]?r.push(i[a]):r.length&&(r=[],a--),4===r.length){return a-7+new DataView(e.buffer,a-7,4).getUint32(0)>e.buffer.byteLength?null:Me.createBox(t,new DataView(e.buffer,a-7))}a++}return null}function _e(e,t){const i=[];let s=e.byteOffset;for(;s<e.buffer.byteLength;){const a=Oe(new DataView(e.buffer,s,e.buffer.byteLength-s),t);if(!a)break;i.push(a),s=a.source.byteOffset+a.size}return i}function Ve(e){const t=[];let i=0;for(;i<e.byteLength;){const s=Me.createFromView(new DataView(e.buffer,e.byteOffset+i));if(t.push(s),!s.size)break;i+=s.size}return t}const Be=new TextDecoder("ascii"),Fe={validateData:e=>"ftyp"===Be.decode(new DataView(e.buffer,e.byteOffset+4,4)),parseInit:e=>{const t={is3dVideo:!1,stereoMode:0,projectionType:me.EQUIRECTANGULAR,projectionData:{pose:{yaw:0,pitch:0,roll:0},bounds:{top:0,bottom:0,left:0,right:0}}};if(Oe(e,"sv3d")){t.is3dVideo=!0;const i=Oe(e,"st3d");i&&(t.stereoMode=i.stereoMode);const s=Oe(e,"prhd");s&&(t.projectionData.pose.yaw=s.poseYawDegrees,t.projectionData.pose.pitch=s.posePitchDegrees,t.projectionData.pose.roll=s.poseRollDegrees);const a=Oe(e,"equi");a&&(t.projectionData.bounds.top=a.projectionBoundsTop,t.projectionData.bounds.right=a.projectionBoundsRight,t.projectionData.bounds.bottom=a.projectionBoundsBottom,t.projectionData.bounds.left=a.projectionBoundsLeft)}return t},getIndexRange:()=>{},parseSegments:e=>{const t=Me.createFromView(e);let i=t.earliestPresentationTime/t.timescale*1e3,s=e.byteOffset+e.byteLength+t.firstOffset;return t.segments.map((e=>{if(0!==e.referenceType)throw new Error("Unsupported multilevel sidx");const a=e.subsegmentDuration/t.timescale*1e3,r={status:le.NONE,time:{from:i,to:i+a},byte:{from:s,to:s+e.referencedSize-1}};return i+=a,s+=e.referencedSize,r}))},parseFeedableSegmentChunk:e=>{const t=_e(e,"mdat"),i=_e(e,"moof");if(!t.length||!i.length)return null;const s=i[0],a=t[t.length-1],r=s.source.byteOffset,n=a.source.byteOffset-s.source.byteOffset+a.size;return new DataView(e.buffer,r,n)},getSegmentEndTime:(e,t)=>{const i=_e(e,"traf"),s=i[i.length-1].children.find((e=>"tfhd"===e.type)),a=i[i.length-1].children.find((e=>"tfdt"===e.type)),r=i[i.length-1].children.find((e=>"trun"===e.type));let n=0;return n=r.sampleDuration.length?r.sampleDuration.reduce(((e,t)=>e+t),0):s.defaultSampleDuration*r.sampleCount,(Number(a.baseMediaDecodeTime)+n)/t*1e3}};var Ue,He;!function(e){e[e.EBML=440786851]="EBML",e[e.EBMLVersion=17030]="EBMLVersion",e[e.EBMLReadVersion=17143]="EBMLReadVersion",e[e.EBMLMaxIDLength=17138]="EBMLMaxIDLength",e[e.EBMLMaxSizeLength=17139]="EBMLMaxSizeLength",e[e.DocType=17026]="DocType",e[e.DocTypeVersion=17031]="DocTypeVersion",e[e.DocTypeReadVersion=17029]="DocTypeReadVersion",e[e.Void=236]="Void",e[e.Segment=408125543]="Segment",e[e.SeekHead=290298740]="SeekHead",e[e.Seek=19899]="Seek",e[e.SeekID=21419]="SeekID",e[e.SeekPosition=21420]="SeekPosition",e[e.Info=357149030]="Info",e[e.TimestampScale=2807729]="TimestampScale",e[e.Duration=17545]="Duration",e[e.Tracks=374648427]="Tracks",e[e.TrackEntry=174]="TrackEntry",e[e.Video=224]="Video",e[e.Projection=30320]="Projection",e[e.ProjectionType=30321]="ProjectionType",e[e.ProjectionPrivate=30322]="ProjectionPrivate",e[e.Chapters=272869232]="Chapters",e[e.Cluster=524531317]="Cluster",e[e.Timestamp=231]="Timestamp",e[e.SilentTracks=22612]="SilentTracks",e[e.SilentTrackNumber=22743]="SilentTrackNumber",e[e.Position=167]="Position",e[e.PrevSize=171]="PrevSize",e[e.SimpleBlock=163]="SimpleBlock",e[e.BlockGroup=160]="BlockGroup",e[e.EncryptedBlock=175]="EncryptedBlock",e[e.Attachments=423732329]="Attachments",e[e.Tags=307544935]="Tags",e[e.Cues=475249515]="Cues",e[e.CuePoint=187]="CuePoint",e[e.CueTime=179]="CueTime",e[e.CueTrackPositions=183]="CueTrackPositions",e[e.CueTrack=247]="CueTrack",e[e.CueClusterPosition=241]="CueClusterPosition",e[e.CueRelativePosition=240]="CueRelativePosition",e[e.CueDuration=178]="CueDuration",e[e.CueBlockNumber=21368]="CueBlockNumber",e[e.CueCodecState=234]="CueCodecState",e[e.CueReference=219]="CueReference",e[e.CueRefTime=150]="CueRefTime"}(Ue||(Ue={})),function(e){e.SignedInteger="int",e.UnsignedInteger="uint",e.Float="float",e.String="string",e.UTF8="utf8",e.Date="date",e.Master="master",e.Binary="binary"}(He||(He={}));const je={[Ue.EBML]:{type:He.Master},[Ue.EBMLVersion]:{type:He.UnsignedInteger},[Ue.EBMLReadVersion]:{type:He.UnsignedInteger},[Ue.EBMLMaxIDLength]:{type:He.UnsignedInteger},[Ue.EBMLMaxSizeLength]:{type:He.UnsignedInteger},[Ue.DocType]:{type:He.String},[Ue.DocTypeVersion]:{type:He.UnsignedInteger},[Ue.DocTypeReadVersion]:{type:He.UnsignedInteger},[Ue.Void]:{type:He.Binary},[Ue.Segment]:{type:He.Master},[Ue.SeekHead]:{type:He.Master},[Ue.Seek]:{type:He.Master},[Ue.SeekID]:{type:He.Binary},[Ue.SeekPosition]:{type:He.UnsignedInteger},[Ue.Info]:{type:He.Master},[Ue.TimestampScale]:{type:He.UnsignedInteger},[Ue.Duration]:{type:He.Float},[Ue.Tracks]:{type:He.Master},[Ue.TrackEntry]:{type:He.Master},[Ue.Video]:{type:He.Master},[Ue.Projection]:{type:He.Master},[Ue.ProjectionType]:{type:He.UnsignedInteger},[Ue.ProjectionPrivate]:{type:He.Master},[Ue.Chapters]:{type:He.Master},[Ue.Cluster]:{type:He.Master},[Ue.Timestamp]:{type:He.UnsignedInteger},[Ue.SilentTracks]:{type:He.Master},[Ue.SilentTrackNumber]:{type:He.UnsignedInteger},[Ue.Position]:{type:He.UnsignedInteger},[Ue.PrevSize]:{type:He.UnsignedInteger},[Ue.SimpleBlock]:{type:He.Binary},[Ue.BlockGroup]:{type:He.Master},[Ue.EncryptedBlock]:{type:He.Binary},[Ue.Attachments]:{type:He.Master},[Ue.Tags]:{type:He.Master},[Ue.Cues]:{type:He.Master},[Ue.CuePoint]:{type:He.Master},[Ue.CueTime]:{type:He.UnsignedInteger},[Ue.CueTrackPositions]:{type:He.Master},[Ue.CueTrack]:{type:He.UnsignedInteger},[Ue.CueClusterPosition]:{type:He.UnsignedInteger},[Ue.CueRelativePosition]:{type:He.UnsignedInteger},[Ue.CueDuration]:{type:He.UnsignedInteger},[Ue.CueBlockNumber]:{type:He.UnsignedInteger},[Ue.CueCodecState]:{type:He.UnsignedInteger},[Ue.CueReference]:{type:He.Master},[Ue.CueRefTime]:{type:He.UnsignedInteger}},qe=e=>{const t=e.getUint8(0);let i=0;128&t?i=1:64&t?i=2:32&t?i=3:16&t&&(i=4);const s=Ye(e,i),a=s in je,r=a?je[s].type:He.Binary,n=e.getUint8(i);let o=0;128&n?o=1:64&n?o=2:32&n?o=3:16&n?o=4:8&n?o=5:4&n?o=6:2&n?o=7:1&n&&(o=8);const h=new DataView(e.buffer,e.byteOffset+i+1,o-1),u=(n&255>>o)*2**(8*(o-1))+Ye(h),c=i+o;let d;return d=c+u>e.byteLength?new DataView(e.buffer,e.byteOffset+c):new DataView(e.buffer,e.byteOffset+c,u),{tag:a?s:"0x"+s.toString(16).toUpperCase(),type:r,tagHeaderSize:c,tagSize:c+u,value:d,valueSize:u}},Ye=(e,t=e.byteLength)=>{switch(t){case 1:return e.getUint8(0);case 2:return e.getUint16(0);case 3:return 65536*e.getUint8(0)+e.getUint16(1);case 4:return e.getUint32(0);case 5:return e.getUint8(0)*2**32+e.getUint32(1);case 6:return e.getUint16(0)*2**32+e.getUint32(2);case 7:{const t=281474976710656*e.getUint8(0)+4294967296*e.getUint16(1)+e.getUint32(3);if(Number.isSafeInteger(t))return t}case 8:throw new ReferenceError("Int64 is not supported")}return 0},Ge=(e,t)=>{switch(t){case He.SignedInteger:return e.getInt8(0);case He.UnsignedInteger:return Ye(e);case He.Float:return 4===e.byteLength?e.getFloat32(0):e.getFloat64(0);case He.String:return new TextDecoder("ascii").decode(e);case He.UTF8:return new TextDecoder("utf-8").decode(e);case He.Date:return new Date(Date.UTC(2001,0)+e.getInt8(0)).getTime();case He.Master:case He.Binary:return e;default:(0,s.assertNever)(t)}},Qe=(e,t)=>{let i=0;for(;i<e.byteLength;){const s=new DataView(e.buffer,e.byteOffset+i),a=qe(s);if(!t(a))return;a.type===He.Master&&Qe(a.value,t),i=a.value.byteOffset-e.byteOffset+a.valueSize}},ze=[Ue.Info,Ue.SeekHead,Ue.Tracks,Ue.TrackEntry,Ue.Video,Ue.Projection,Ue.ProjectionType,Ue.ProjectionPrivate,Ue.Chapters,Ue.Cluster,Ue.Cues,Ue.Attachments,Ue.Tags],We=[Ue.Timestamp,Ue.SilentTracks,Ue.SilentTrackNumber,Ue.Position,Ue.PrevSize,Ue.SimpleBlock,Ue.BlockGroup,Ue.EncryptedBlock],Je={validateData:e=>{if(e.getUint32(0)!==Ue.EBML)return!1;let t,i,s;const a=qe(e);return Qe(a.value,(({tag:e,type:a,value:r})=>(e===Ue.EBMLReadVersion?t=Ge(r,a):e===Ue.DocType?i=Ge(r,a):e===Ue.DocTypeReadVersion&&(s=Ge(r,a)),!0))),(void 0===t||t<=1)&&void 0!==i&&"webm"===i&&(void 0===s||s<=2)},parseInit:e=>{let t,i,a,r,n,o,h=!1,u=!1,c=!1,d=!1;return Qe(e,(({tag:e,type:s,value:l,valueSize:p})=>{if(e===Ue.SeekID){const e=Ge(l,s);o=Ye(e)}else e!==Ue.SeekPosition&&(o=void 0);return e===Ue.Segment?(t=l.byteOffset,i=l.byteOffset+p):e===Ue.Info?h=!0:e===Ue.SeekHead?u=!0:e===Ue.TimestampScale?a=Ge(l,s):e===Ue.Duration?r=Ge(l,s):e===Ue.SeekPosition&&o===Ue.Cues?n=Ge(l,s):e===Ue.Tracks?Qe(l,(({tag:e,type:t,value:i})=>e!==Ue.ProjectionType||(d=1===Ge(i,t),!1))):h&&u&&ze.includes(e)&&(c=!0),!c})),(0,s.assertNonNullable)(t,"Failed to parse webm Segment start"),(0,s.assertNonNullable)(i,"Failed to parse webm Segment end"),(0,s.assertNonNullable)(r,"Failed to parse webm Segment duration"),a=a??1e6,{segmentStart:Math.round(t/1e9*a*1e3),segmentEnd:Math.round(i/1e9*a*1e3),timeScale:a,segmentDuration:Math.round(r/1e9*a*1e3),cuesSeekPosition:n,is3dVideo:d,stereoMode:0,projectionType:me.EQUIRECTANGULAR,projectionData:{pose:{yaw:0,pitch:0,roll:0},bounds:{top:0,bottom:0,left:0,right:0}}}},getIndexRange:e=>{if((0,s.isNullable)(e.cuesSeekPosition))return;const t=e.segmentStart+e.cuesSeekPosition;return{from:t,to:t+1048576}},parseSegments:(e,t)=>{let i=!1,a=!1;const r=e=>(0,s.isNonNullable)(e.time)&&(0,s.isNonNullable)(e.position),n=[];let o;return Qe(e,(({tag:e,type:t,value:s})=>{switch(e){case Ue.Cues:i=!0;break;case Ue.CuePoint:o&&r(o)&&n.push(o),o={};break;case Ue.CueTime:o&&(o.time=Ge(s,t));break;case Ue.CueTrackPositions:break;case Ue.CueClusterPosition:o&&(o.position=Ge(s,t));break;default:i&&ze.includes(e)&&(a=!0)}return!(i&&a)})),o&&r(o)&&n.push(o),n.map(((e,i)=>{const{time:s,position:a}=e,r=n[i+1];return{status:le.NONE,time:{from:s,to:r?r.time:t.segmentDuration},byte:{from:t.segmentStart+a,to:r?t.segmentStart+r.position-1:t.segmentEnd-1}}}))},parseFeedableSegmentChunk:e=>{let t=0,i=!1;try{Qe(e,(s=>s.tag===Ue.Cluster?s.tagSize<=e.byteLength?(t=s.tagSize,!1):(t+=s.tagHeaderSize,!0):!!We.includes(s.tag)&&(t+s.tagSize<=e.byteLength&&(t+=s.tagSize,i||(i=[Ue.SimpleBlock,Ue.BlockGroup,Ue.EncryptedBlock].includes(s.tag))),!0)))}catch{}return t>0&&t<=e.byteLength&&i?new DataView(e.buffer,e.byteOffset,t):null}},Xe=e=>{if(e.includes("/")){const t=e.split("/");return parseInt(t[0])/parseInt(t[1])}return parseFloat(e)},Ke=e=>{if(!e.startsWith("P"))return;const t=(e,t)=>{const i=e?parseFloat(e.replace(",",".")):NaN;return(isNaN(i)?0:i)*t},i=/^(-|\+)?P(?:([-+]?[0-9,.]*)Y)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)W)?(?:([-+]?[0-9,.]*)D)?(?:T(?:([-+]?[0-9,.]*)H)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)S)?)?$/.exec(e),s="-"===i?.[1]?-1:1;return 24*t(i?.[5],s)*60*60*1e3+60*t(i?.[6],s)*60*1e3+60*t(i?.[7],s)*1e3+1e3*t(i?.[8],s)},Ze=(e,t)=>{let i=e;i=i.replaceAll("$$","$");const a={RepresentationID:t.representationId,Number:t.segmentNumber,Bandwidth:t.bandwidth,Time:t.segmentTime};for(const[e,t]of Object.entries(a)){const a=new RegExp(`\\$${e}(?:%0(\\d+)d)?\\$`,"g");i=i.replaceAll(a,((e,i)=>(0,s.isNullable)(t)?e:(0,s.isNullable)(i)?t:t.padStart(parseInt(i,10),"0")))}return i},et=({id:e,width:t,height:i,bitrate:a,fps:r,quality:n})=>{const o=(n?O(n):void 0)??(0,s.videoSizeToQuality)({width:t,height:i});return o&&{id:e,quality:o,bitrate:a,size:{width:t,height:i},fps:r}},tt=({id:e,bitrate:t})=>({id:e,bitrate:t}),it=(e,t,i)=>{const s=t.indexOf(i);return e.at(Math.round(e.length*s/t.length))??e.at(-1)},st=({id:e,lang:t,url:i,isAuto:s})=>({id:e,url:i,isAuto:s,type:"internal",language:t}),at=e=>"url"in e,rt=e=>e.type===de.TEMPLATE,nt=e=>e instanceof DOMException&&("AbortError"===e.name||20===e.code);class ot{abort(){for(const e of this.activeSegments)this.abortSegment(e.segment);this.activeSegments.clear(),this.downloadAbortController.abort(),this.downloadAbortController=new Ae,this.abortBuffer()}maintain(e=this.getCurrentPosition()){if((0,s.isNullable)(e)||(0,s.isNullable)(this.downloadingRepresentationId)||(0,s.isNullable)(this.playingRepresentationId)||(0,s.isNullable)(this.sourceBuffer)||this.isSeekingLive)return;const t=this.representations.get(this.downloadingRepresentationId),i=this.segments.get(this.downloadingRepresentationId);if((0,s.assertNonNullable)(t,`No such representation ${this.downloadingRepresentationId}`),!i)return;const a=i.find((t=>e>=t.time.from&&e<t.time.to));let r=e;if(this.playingRepresentationId!==this.downloadingRepresentationId){const t=ge(this.sourceBuffer.buffered,e),i=a?a.time.to+100:-1/0;a&&a.time.to-e<this.tuning.dash.maxSegmentDurationLeftToSelectNextSegment&&t>=a.time.to-e+100&&(r=i)}if(isFinite(this.bufferLimit)&&De(this.sourceBuffer.buffered)>=this.bufferLimit){const t=ge(this.sourceBuffer.buffered,e),i=Math.min(this.forwardBufferTarget,this.bufferLimit)*this.tuning.dash.minSafeBufferThreshold;return void this.pruneBuffer(e,1/0,t<i)}let n=[];if(!this.activeSegments.size&&(n=this.selectForwardBufferSegments(i,t.segmentReference.type,r),n.length)){let e="auto";if(this.tuning.dash.useFetchPriorityHints&&a)if(n.includes(a))e="high";else{const t=n.at(0);t&&t.time.from-a.time.to>=this.forwardBufferTarget/2&&(e="low")}this.loadSegments(n,t,e)}(!this.preloadOnly&&!this.allInitsLoaded&&a&&a.status===le.FED&&!n.length&&ge(this.sourceBuffer.buffered,e)>3e3||this.isActiveLowLatency())&&this.loadNextInit();const o=i.at(-1);o&&o.status===le.FED&&(this.fullyBuffered$.next(!0),this.isLive||this.onLastSegment$.next(a===o))}searchGaps(e,t){this.gaps=[];let i=0;const a=this.isLive?this.liveInitialAdditionalOffset:0;for(const s of e)Math.trunc(s.time.from-i)>0&&this.gaps.push({representation:t.id,from:i,to:s.time.from+a}),i=s.time.to;(0,s.isNonNullable)(t.duration)&&t.duration-i>0&&this.gaps.push({representation:t.id,from:i,to:t.duration})}getActualLiveStartingSegments(e){const t=e.segments,i=this.isActiveLowLatency()?this.tuning.dashCmafLive.lowLatency.maxTargetOffset:this.tuning.dashCmafLive.maxActiveLiveOffset,s=[];let a=0,r=t.length-1;do{s.unshift(t[r]),a+=t[r].time.to-t[r].time.from,r--}while(a<i&&r>=0);return this.liveInitialAdditionalOffset=a-i,this.isActiveLowLatency()?[s[0]]:s}getLiveSegmentsToLoadState(e){const t=e?.representations[this.kind].find((e=>e.id===this.downloadingRepresentationId));if(!t)return;const i=this.segments.get(t.id);return i?.length?{from:i[0].time.from,to:i[i.length-1].time.to}:void 0}updateLive(e){for(const t of e?.representations[this.kind].values()??[]){if(!t||!rt(t.segmentReference))return;const e=t.segmentReference.segments.map((e=>({...e,status:le.NONE,size:void 0}))),i=this.segments.get(t.id)??[],s=i.at(-1)?.time.to??0,a=e?.findIndex((e=>Math.floor(s)>=Math.floor(e.time.from)&&Math.floor(s)<=Math.floor(e.time.to)));if(-1===a){this.liveUpdateSegmentIndex=0;const e=this.getActualLiveStartingSegments(t.segmentReference);this.segments.set(t.id,e)}else{const s=e.slice(a+1);this.segments.set(t.id,[...i,...s])}}}updateLowLatencyLive(e){if(this.isActiveLowLatency())for(const t of this.representations.values()){const i=t.segmentReference;if(!rt(i))return;const s=Math.round(e.segment.time.to*i.timescale/1e3).toString(10),a=Ze(i.segmentTemplateUrl,{segmentTime:s}),r=this.segments.get(t.id)??[],n=r.find((t=>Math.floor(t.time.from)===Math.floor(e.segment.time.from)));n&&(n.time.to=e.segment.time.to),r.find((t=>Math.floor(t.time.from)===Math.floor(e.segment.time.to)))||r.push({status:le.NONE,time:{from:e.segment.time.to,to:1/0},url:a})}}findSegmentStartTime(e){const t=this.switchingToRepresentationId??this.downloadingRepresentationId??this.playingRepresentationId;if(!t)return;const i=this.segments.get(t);return i?i.find((t=>t.time.from<=e&&t.time.to>=e))?.time.from??void 0:void 0}setTarget(e){this.forwardBufferTarget=e}setPreloadOnly(e){this.preloadOnly=e}destroy(){if(this.initData.clear(),this.segments.clear(),this.parsedInitData.clear(),this.representations.clear(),this.sourceBufferTaskQueue?.destroy(),this.gapDetectionIdleCallback&&window.cancelIdleCallback&&window.cancelIdleCallback(this.gapDetectionIdleCallback),this.initLoadIdleCallback&&window.cancelIdleCallback&&window.cancelIdleCallback(this.initLoadIdleCallback),this.subscription.unsubscribe(),this.sourceBuffer){"open"===this.mediaSource.readyState&&this.abortBuffer();try{this.mediaSource.removeSourceBuffer(this.sourceBuffer)}catch(e){if(!(e instanceof DOMException&&"NotFoundError"===e.name))throw e}}this.sourceBuffer=null,this.downloadAbortController.abort(),this.destroyAbortController.abort()}selectForwardBufferSegments(e,t,i){return this.isLive?this.selectForwardBufferSegmentsLive(e,i):this.selectForwardBufferSegmentsRecord(e,t,i)}selectForwardBufferSegmentsLive(e,t){const i=e.findIndex((e=>t>=e.time.from&&t<e.time.to));return this.playingRepresentationId!==this.downloadingRepresentationId&&(this.liveUpdateSegmentIndex=i),this.liveUpdateSegmentIndex<e.length?e.slice(this.liveUpdateSegmentIndex++):[]}selectForwardBufferSegmentsRecord(e,t,i){const s=e.findIndex((({status:e,time:{from:t,to:s}},a)=>{const r=t>i||t<=i&&s>=i||0===a&&0===i,n=Math.min(this.forwardBufferTarget,this.bufferLimit),o=this.preloadOnly&&t<=i+n||s<=i+n;return(e===le.NONE||e===le.PARTIALLY_EJECTED&&r&&o&&this.sourceBuffer&&!$e(this.sourceBuffer.buffered,i))&&r&&o}));if(-1===s)return[];if(t!==de.BYTE_RANGE)return e.slice(s,s+1);const a=e;let r=0,n=0;const o=[],h=this.preloadOnly?0:this.tuning.dash.segmentRequestSize,u=this.preloadOnly?this.forwardBufferTarget:0;for(let e=s;e<a.length&&(r<=h||n<=u);e++){const t=a[e];if(r+=t.byte.to+1-t.byte.from,n+=t.time.to+1-t.time.from,t.status!==le.NONE&&t.status!==le.PARTIALLY_EJECTED)break;o.push(t)}return o}async loadSegments(e,t,i="auto"){t.segmentReference.type===de.TEMPLATE?await this.loadTemplateSegment(e[0],t,i):await this.loadByteRangeSegments(e,t,i)}async loadTemplateSegment(e,t,i="auto"){e.status=le.DOWNLOADING;const a={segment:e,loadedBytes:0,feedingBytes:0,fedBytes:0,representationId:t.id};this.activeSegments.add(a);const{range:r,url:n,signal:o,onProgress:h,onProgressTasks:u}=this.prepareTemplateFetchSegmentParams(e,t);this.failedDownloads&&o&&(await(0,s.abortable)(o,async function*(){const e=(0,s.getExponentialDelay)(this.failedDownloads,this.tuning.downloadBackoff);yield new Promise((t=>setTimeout(t,e)))}.bind(this))(),o.aborted&&this.abortActiveSegments([e]));try{const e=await this.fetcher.fetch(n,{range:r,signal:o,onProgress:h,priority:i,isLowLatency:this.isActiveLowLatency()});if(!e)return;const s=new DataView(e);if(this.isActiveLowLatency()){const e=t.segmentReference.timescale;a.segment.time.to=this.containerParser.getSegmentEndTime(s,e)}h&&a.feedingBytes&&u?await Promise.all(u):await this.sourceBufferTaskQueue.append(s,o),a.segment.status=le.DOWNLOADED,this.onSegmentFullyAppended(a,t.id),this.failedDownloads=0}catch(t){if(!nt(t))return;this.abortActiveSegments([e]),this.onSegmentDownloadError(t)}}async loadByteRangeSegments(e,t,i="auto"){if(!e.length)return;for(const i of e)i.status=le.DOWNLOADING,this.activeSegments.add({segment:i,loadedBytes:0,feedingBytes:0,fedBytes:0,representationId:t.id});const{range:a,url:r,signal:n,onProgress:o}=this.prepareByteRangeFetchSegmentParams(e,t);this.failedDownloads&&n&&(await(0,s.abortable)(n,async function*(){const e=(0,s.getExponentialDelay)(this.failedDownloads,this.tuning.downloadBackoff);yield new Promise((t=>setTimeout(t,e)))}.bind(this))(),n.aborted&&this.abortActiveSegments(e));try{await this.fetcher.fetch(r,{range:a,onProgress:o,signal:n,priority:i}),this.failedDownloads=0}catch(t){if(!nt(t))return;this.abortActiveSegments(e),this.onSegmentDownloadError(t)}}prepareByteRangeFetchSegmentParams(e,t){if(rt(t.segmentReference))throw new Error("Representation is not byte range type");const i=t.segmentReference.url,a={from:e.at(0).byte.from,to:e.at(-1).byte.to},{signal:r}=this.downloadAbortController,n=()=>{this.abort()};return{url:i,range:a,signal:r,onProgress:(e,i)=>{if(!r.aborted)try{this.onSomeByteRangesDataLoaded({dataView:e,loaded:i,signal:r,onSegmentAppendFailed:n,globalFrom:a?a.from:0,representationId:t.id})}catch(e){this.error$.next({id:"SegmentFeeding",category:s.ErrorCategory.VIDEO_PIPELINE,message:"Error when feeding segments",thrown:e})}}}}prepareTemplateFetchSegmentParams(e,t){if(!rt(t.segmentReference))throw new Error("Representation is not template type");const i=new URL(e.url,t.segmentReference.baseUrl);this.isActiveLowLatency()&&i.searchParams.set("low-latency","yes");const a=i.toString(),{signal:r}=this.downloadAbortController,n=()=>{this.abort()},o=[],h=this.isActiveLowLatency()||this.tuning.dash.enableSubSegmentBufferFeeding&&this.liveUpdateSegmentIndex<3?(e,i)=>{if(!r.aborted)try{const s=this.onSomeTemplateDataLoaded({dataView:e,loaded:i,signal:r,onSegmentAppendFailed:n,representationId:t.id});o.push(s)}catch(e){this.error$.next({id:"SegmentFeeding",category:s.ErrorCategory.VIDEO_PIPELINE,message:"Error when feeding segments",thrown:e})}}:void 0;return{url:a,signal:r,onProgress:h,onProgressTasks:o}}abortActiveSegments(e){for(const t of this.activeSegments)e.includes(t.segment)&&this.abortSegment(t.segment)}onSegmentDownloadError(e){let t=!1;const i=this.getCurrentPosition();this.sourceBuffer&&(0,s.isNonNullable)(i)&&(t=ge(this.sourceBuffer?.buffered,i)>=this.tuning.downloadBackoff.bufferThreshold),this.failedDownloads++,t||this.error$.next({id:"SegmentDownload",category:s.ErrorCategory.NETWORK,message:"Error when fetching segments",thrown:e})}async onSomeTemplateDataLoaded({dataView:e,representationId:t,loaded:i,onSegmentAppendFailed:s,signal:a}){if(this.activeSegments.size&&this.representations.get(t))for(const r of this.activeSegments){const{segment:n}=r;if(r.representationId===t){if(a.aborted){s();continue}if(r.loadedBytes=i,r.loadedBytes>r.feedingBytes){const t=new DataView(e.buffer,e.byteOffset+r.feedingBytes,r.loadedBytes-r.feedingBytes),i=this.containerParser.parseFeedableSegmentChunk(t);i?.byteLength&&(n.status=le.PARTIALLY_FED,r.feedingBytes+=i.byteLength,await this.sourceBufferTaskQueue.append(i),r.fedBytes+=i.byteLength)}}}}onSomeByteRangesDataLoaded({dataView:e,representationId:t,globalFrom:i,loaded:s,signal:a,onSegmentAppendFailed:r}){if(!this.activeSegments.size)return;const n=this.representations.get(t);if(!n)return;const o=n.segmentReference.type,h=e.byteLength;for(const n of this.activeSegments){const{segment:u}=n,c=o===de.BYTE_RANGE,d=c?u.byte.to-u.byte.from+1:h;if(n.representationId!==t||c&&!(u.byte.from>=i&&u.byte.to<i+e.byteLength))continue;if(a.aborted){r();continue}const l=c?u.byte.from-i:0,p=l<s,m=(c?u.byte.to-i:e.byteLength)<=s;if(u.status===le.DOWNLOADING&&p&&m){u.status=le.DOWNLOADED;const i=new DataView(e.buffer,e.byteOffset+l,d);this.sourceBufferTaskQueue.append(i,a).then((e=>e&&!a.aborted?this.onSegmentFullyAppended(n,t):r()))}else if(this.tuning.dash.enableSubSegmentBufferFeeding&&p&&(n.loadedBytes=Math.min(d,s-l),n.loadedBytes>n.feedingBytes)){const i=new DataView(e.buffer,e.byteOffset+l+n.feedingBytes,n.loadedBytes-n.feedingBytes),s=n.loadedBytes===d?i:this.containerParser.parseFeedableSegmentChunk(i);s?.byteLength&&(u.status=le.PARTIALLY_FED,n.feedingBytes+=s.byteLength,this.sourceBufferTaskQueue.append(s,a).then((e=>{if(a.aborted)r();else if(e)n.fedBytes+=s.byteLength,n.fedBytes===d&&this.onSegmentFullyAppended(n,t);else{if(n.feedingBytes<d)return;r()}})))}}}onSegmentFullyAppended(e,t){this.playingRepresentationId=t,this.playingRepresentation$.next(this.playingRepresentationId),this.playingRepresentationInit$.next(this.parsedInitData.get(this.playingRepresentationId)),e.segment.status=le.FED,at(e.segment)&&(e.segment.size=e.fedBytes);for(const i of this.representations.values())if(i.id!==t)for(const t of this.segments.get(i.id)??[])t.status===le.FED&&t.time.from===e.segment.time.from&&t.time.to===e.segment.time.to&&(t.status=le.NONE);this.isActiveLowLatency()&&this.updateLowLatencyLive(e),this.activeSegments.delete(e),this.detectGapsWhenIdle(t,[e.segment])}abortSegment(e){this.tuning.useDashAbortPartiallyFedSegment&&e.status===le.PARTIALLY_FED||e.status===le.PARTIALLY_EJECTED?(this.sourceBufferTaskQueue.remove(e.time.from,e.time.to).then((()=>e.status=le.NONE)),e.status=le.PARTIALLY_EJECTED):e.status=le.NONE;for(const t of this.activeSegments.values())if(t.segment===e){this.activeSegments.delete(t);break}}loadNextInit(){if(this.allInitsLoaded||this.initLoadIdleCallback)return;let e=null,t=!1;for(const[i,s]of this.initData.entries()){t||(t=s instanceof Promise),null===s&&(e=i)}if(!e)return void(this.allInitsLoaded=!0);if(t)return;const i=this.representations.get(e);i&&(this.initLoadIdleCallback=ke((()=>this.loadInit(i,"low",!1).finally((()=>this.initLoadIdleCallback=null)))))}async loadInit(e,t="auto",i=!1){const a=this.tuning.dash.useFetchPriorityHints?t:"auto",r=(!i&&this.failedDownloads>0?(0,s.abortable)(this.destroyAbortController.signal,async function*(){const e=(0,s.getExponentialDelay)(this.failedDownloads,this.tuning.downloadBackoff);yield new Promise((t=>setTimeout(t,e)))}.bind(this))():Promise.resolve()).then((()=>this.fetcher.fetchRepresentation(e.segmentReference,this.containerParser,a))).then((async t=>{if(!t)return;const{init:i,dataView:s,segments:a}=t,r=s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength);this.initData.set(e.id,r);let n=a;this.isLive&&rt(e.segmentReference)&&(n=this.getActualLiveStartingSegments(e.segmentReference)),(!this.isLive||!this.segments.has(e.id))&&this.segments.set(e.id,n),i&&this.parsedInitData.set(e.id,i)})).then((()=>this.failedDownloads=0),(t=>{this.initData.set(e.id,null),i&&this.error$.next({id:"LoadInits",category:s.ErrorCategory.WTF,message:"loadInit threw",thrown:t})}));return this.initData.set(e.id,r),r}async pruneBuffer(e,t,i=!1){if(!this.sourceBuffer||!this.playingRepresentationId||(0,s.isNullable)(e)||this.sourceBuffer.updating)return!1;let a=0,r=1/0,n=-1/0,o=!1;const h=e=>{r=Math.min(r,e.time.from),n=Math.max(n,e.time.to);const t=at(e)?e.size??0:e.byte.to-e.byte.from;a+=t};for(const i of this.segments.values())for(const s of i){if(s.time.to>=e-this.tuning.dash.bufferPruningSafeZone||a>=t)break;s.status===le.FED&&h(s)}if(o=isFinite(r)&&isFinite(n),!o){a=0,r=1/0,n=-1/0;for(const i of this.segments.values())for(const s of i){if(s.time.from<e+Math.min(this.forwardBufferTarget,this.bufferLimit)||a>t)break;s.status===le.FED&&h(s)}}if(o=isFinite(r)&&isFinite(n),!o)for(let e=0;e<this.sourceBuffer.buffered.length;e++){const t=1e3*this.sourceBuffer.buffered.start(e),i=1e3*this.sourceBuffer.buffered.end(e);for(const e of this.segments.values())for(const s of e)if(s.status===le.NONE&&Math.round(s.time.from)<=Math.round(t)&&Math.round(s.time.to)>=Math.round(i)){r=t,n=i;break}}if(o=isFinite(r)&&isFinite(n),!o&&i){a=0,r=1/0,n=-1/0;const t=Math.min(this.forwardBufferTarget,this.bufferLimit)*this.tuning.dash.minSafeBufferThreshold;for(const i of this.segments.values())for(const s of i)s.time.from>e+t&&s.status===le.FED&&h(s)}return o=isFinite(r)&&isFinite(n),!!o&&this.sourceBufferTaskQueue.remove(r,n)}abortBuffer(){if(!this.sourceBuffer||"open"!==this.mediaSource.readyState)return;const e=this.playingRepresentationId&&this.initData.get(this.playingRepresentationId),t=e instanceof ArrayBuffer?e:void 0;this.sourceBufferTaskQueue.abort(t)}getDebugBufferState(){if(this.sourceBuffer&&this.sourceBuffer.buffered.length)return{from:this.sourceBuffer.buffered.start(0),to:this.sourceBuffer.buffered.end(this.sourceBuffer.buffered.length-1)}}detectGaps(e,t){if(this.sourceBuffer)for(const i of t){let t={representation:e,from:i.time.from,to:i.time.to};for(let e=0;e<this.sourceBuffer.buffered.length;e++){const s=1e3*this.sourceBuffer.buffered.start(e),a=1e3*this.sourceBuffer.buffered.end(e);if(!(a<=i.time.from||s>=i.time.to)){if(s<=i.time.from&&a>=i.time.to){t=void 0;break}a>i.time.from&&a<i.time.to&&(t.from=a),s<i.time.to&&s>i.time.from&&(t.to=s)}}t&&t.to-t.from>1&&!this.gaps.some((e=>t&&e.from===t.from&&e.to===t.to))&&this.gaps.push(t)}}detectGapsWhenIdle(e,t){this.gapDetectionIdleCallback||(this.gapDetectionIdleCallback=ke((()=>{try{this.detectGaps(e,t)}catch(e){this.error$.next({id:"GapDetection",category:s.ErrorCategory.WTF,message:"detectGaps threw",thrown:e})}finally{this.gapDetectionIdleCallback=null}})))}checkEjectedSegments(){if((0,s.isNullable)(this.sourceBuffer)||(0,s.isNullable)(this.playingRepresentationId))return;const e=[];for(let t=0;t<this.sourceBuffer.buffered.length;t++){const i=Math.round(1e3*this.sourceBuffer.buffered.start(t)),s=Math.round(1e3*this.sourceBuffer.buffered.end(t));e.push({from:i,to:s})}for(const t of this.segments.values())for(const i of t){const{status:t}=i;if(t!==le.FED&&t!==le.PARTIALLY_EJECTED)continue;const s=Math.floor(i.time.from),a=Math.ceil(i.time.to),r=e.some((e=>e.from-1<=s&&e.to+1>=a)),n=e.filter((e=>s>=e.from-1&&s<=e.to+1||a>=e.from-1&&a<=e.to+1));r||(1===n.length?i.status=le.PARTIALLY_EJECTED:i.status=le.NONE)}}constructor(e,t,i,a,{fetcher:r,tuning:n,getCurrentPosition:o,isActiveLowLatency:h,compatibilityMode:u=!1,manifest:c}){switch(this.onLastSegment$=new s.ValueSubject(!1),this.fullyBuffered$=new s.ValueSubject(!1),this.playingRepresentation$=new s.ValueSubject(void 0),this.playingRepresentationInit$=new s.ValueSubject(void 0),this.error$=new s.Subject,this.gaps=[],this.subscription=new s.Subscription,this.allInitsLoaded=!1,this.activeSegments=new Set,this.downloadAbortController=new Ae,this.destroyAbortController=new Ae,this.bufferLimit=1/0,this.failedDownloads=0,this.isLive=!1,this.liveUpdateSegmentIndex=0,this.liveInitialAdditionalOffset=0,this.isSeekingLive=!1,this.index=0,this.startWith=(0,s.abortable)(this.destroyAbortController.signal,async function*(e){const t=this.representations.get(e);(0,s.assertNonNullable)(t,`Cannot find representation ${e}`),this.playingRepresentationId=e,this.downloadingRepresentationId=e,this.sourceBuffer=this.mediaSource.addSourceBuffer(`${t.mime}; codecs="${t.codecs}"`),this.sourceBufferTaskQueue=new Ce(this.sourceBuffer),this.subscription.add((0,s.fromEvent)(this.sourceBuffer,"updateend").subscribe((()=>{this.checkEjectedSegments(),this.maintain()}),(e=>this.error$.next({id:"SegmentEjection",category:s.ErrorCategory.WTF,message:"Error when trying to clear segments ejected by browser",thrown:e})))),this.subscription.add((0,s.fromEvent)(this.sourceBuffer,"error").subscribe((()=>this.error$.next({id:"SourceBuffer",category:s.ErrorCategory.VIDEO_PIPELINE,message:"SourceBuffer Error event fired"})))),this.subscription.add(this.sourceBufferTaskQueue.bufferFull$.subscribe((e=>{if(!this.sourceBuffer)return;const t=Math.min(this.bufferLimit,.8*De(this.sourceBuffer.buffered));this.bufferLimit=t,this.pruneBuffer(this.getCurrentPosition(),e)}))),this.subscription.add(this.sourceBufferTaskQueue.error$.subscribe((e=>this.error$.next(e)))),yield this.loadInit(t,"high",!0);const i=this.initData.get(t.id),a=this.segments.get(t.id),r=this.parsedInitData.get(t.id);(0,s.assertNonNullable)(i,"No init buffer for starting representation"),(0,s.assertNonNullable)(a,"No segments for starting representation"),i instanceof ArrayBuffer&&(this.searchGaps(a,t),yield this.sourceBufferTaskQueue.append(i,this.destroyAbortController.signal),this.playingRepresentation$.next(this.playingRepresentationId),this.playingRepresentationInit$.next(r))}.bind(this)),this.switchTo=(0,s.abortable)(this.destroyAbortController.signal,async function*(e){if(e===this.downloadingRepresentationId||e===this.switchingToRepresentationId)return;this.switchingToRepresentationId=e;const t=this.representations.get(e);(0,s.assertNonNullable)(t,`No such representation ${e}`);let i=this.segments.get(e),a=this.initData.get(e);if((0,s.isNullable)(a)||(0,s.isNullable)(i)?yield this.loadInit(t,"high",!1):a instanceof Promise&&(yield a),i=this.segments.get(e),(0,s.assertNonNullable)(i,"No segments for starting representation"),a=this.initData.get(e),!(a&&a instanceof ArrayBuffer&&this.sourceBuffer))return;this.switchingToRepresentationId=void 0,this.downloadingRepresentationId=e,this.abort(),yield this.sourceBufferTaskQueue.append(a,this.downloadAbortController.signal);const r=this.getCurrentPosition();(0,s.isNonNullable)(r)&&(this.isLive||(i.forEach((e=>e.status=le.NONE)),this.pruneBuffer(r,1/0,!0)),this.maintain(r))}.bind(this)),this.seekLive=(0,s.abortable)(this.destroyAbortController.signal,async function*(e){if(this.isSeekingLive=!0,!this.downloadingRepresentationId||!e)return;for(const t of this.representations.keys()){const i=e.find((e=>e.id===t));i&&this.representations.set(t,i);const s=this.representations.get(t);if(!s||!rt(s.segmentReference))return;const a=this.getActualLiveStartingSegments(s.segmentReference);this.segments.set(s.id,a)}const t=this.switchingToRepresentationId??this.downloadingRepresentationId,i=this.representations.get(t);(0,s.assertNonNullable)(i);const a=this.segments.get(t);(0,s.assertNonNullable)(a,"No segments for starting representation");const r=this.initData.get(t);if((0,s.assertNonNullable)(r,"No init buffer for starting representation"),!(r instanceof ArrayBuffer))return;const n=this.getDebugBufferState();this.liveUpdateSegmentIndex=0,this.abort(),n&&(yield this.sourceBufferTaskQueue.remove(1e3*n.from,1e3*n.to,this.destroyAbortController.signal)),this.searchGaps(a,i),yield this.sourceBufferTaskQueue.append(r,this.destroyAbortController.signal),this.isSeekingLive=!1}.bind(this)),this.fetcher=r,this.tuning=n,this.compatibilityMode=u,this.forwardBufferTarget=n.dash.forwardBufferTargetAuto,this.getCurrentPosition=o,this.isActiveLowLatency=h,this.isLive=!!c?.dynamic,this.container=i,i){case pe.MP4:this.containerParser=Fe;break;case pe.WEBM:this.containerParser=Je;break;default:(0,s.assertNever)(i)}this.initData=new Map(a.map((e=>[e.id,null]))),this.segments=new Map,this.parsedInitData=new Map,this.representations=new Map(a.map((e=>[e.id,e]))),this.kind=e,this.mediaSource=t,this.sourceBuffer=null}}var ht,ut=e=>{const t=new URL(e);return t.searchParams.set("quic","1"),t.toString()};!function(e){e[e.HEADER=0]="HEADER",e[e.PARAM=1]="PARAM"}(ht||(ht={}));class ct{onHeadersReceived(e){const{type:t,reused:i}=(e=>{const t=e.get("X-Delivery-Type"),i=e.get("X-Reused");return{type:null===t?c.HTTP1:t??void 0,reused:null===i?void 0:{1:!0,0:!1}[i]??void 0}})(e);this.lastConnectionType$.next(t),this.lastConnectionReused$.next(i)}async fetchRepresentation(e,t,i="auto"){const{type:a}=e;switch(a){case de.BYTE_RANGE:return await this.fetchByteRangeRepresentation(e,t,i)??null;case de.TEMPLATE:return await this.fetchTemplateRepresentation(e,i)??null;default:(0,s.assertNever)(a)}}destroy(){this.abortAllController.abort(),this.subscription.unsubscribe()}constructor({throughputEstimator:e,requestQuic:t,compatibilityMode:i=!1}){this.lastConnectionType$=new s.ValueSubject(void 0),this.lastConnectionReused$=new s.ValueSubject(void 0),this.lastRequestFirstBytes$=new s.ValueSubject(void 0),this.abortAllController=new Ae,this.subscription=new s.Subscription,this.fetchManifest=(0,s.abortable)(this.abortAllController.signal,async function*(e){let t=e;this.requestQuic&&(t=ut(t));const i=yield we(t,{signal:this.abortAllController.signal}).catch(dt);return i?(this.onHeadersReceived(i.headers),i.text()):null}.bind(this)),this.fetch=(0,s.abortable)(this.abortAllController.signal,async function*(e,{rangeMethod:t=(this.compatibilityMode?ht.HEADER:ht.PARAM),range:i,onProgress:a,priority:r="auto",signal:n,measureThroughput:o=!0,isLowLatency:h=!1}={}){let u=e;const c=new Headers;if(i)switch(t){case ht.HEADER:c.append("Range",`bytes=${i.from}-${i.to}`);break;case ht.PARAM:{const e=new URL(u,location.href);e.searchParams.append("bytes",`${i.from}-${i.to}`),u=e.toString();break}default:(0,s.assertNever)(t)}this.requestQuic&&(u=ut(u));let d,l=this.abortAllController.signal;if(n){const e=new Ae;if(d=(0,s.merge)((0,s.fromEvent)(this.abortAllController.signal,"abort"),(0,s.fromEvent)(n,"abort")).subscribe((()=>{try{e.abort()}catch(e){dt(e)}})),this.abortAllController.signal.aborted||n.aborted)try{e.abort()}catch(e){dt(e)}l=e.signal}const p=(0,s.now)(),m=yield we(u,{priority:r,headers:c,signal:l}).catch(dt),f=(0,s.now)();if(!m)return d?.unsubscribe(),null;if(this.throughputEstimator?.addRawRtt(f-p),!m.ok||!m.body)return d?.unsubscribe(),Promise.reject(new Error(`Fetch error ${m.status}: ${m.statusText}`));if(this.onHeadersReceived(m.headers),!a&&!o)return d?.unsubscribe(),m.arrayBuffer();const[g,b]=m.body.tee(),S=g.getReader();o&&this.throughputEstimator?.trackStream(b,h);let v=0,y=new Uint8Array(0),T=!1;const E=e=>{d?.unsubscribe(),T=!0,dt(e)},w=(0,s.abortable)(l,async function*({done:e,value:t}){if(0===v&&this.lastRequestFirstBytes$.next((0,s.now)()-p),l.aborted)d?.unsubscribe();else if(!e&&t){const e=new Uint8Array(y.length+t.length);e.set(y),e.set(t,y.length),y=e,v+=t.byteLength,a?.(new DataView(y.buffer),v),yield S?.read().then(w,E)}}.bind(this));return yield S?.read().then(w,E),d?.unsubscribe(),T?null:y.buffer}.bind(this)),this.fetchByteRangeRepresentation=(0,s.abortable)(this.abortAllController.signal,async function*(e,t,i){if(e.type!==de.BYTE_RANGE)return null;const{from:s,to:a}=e.initRange;let r,n,o=s,h=a,u=!1;e.indexRange&&(r=e.indexRange.from,n=e.indexRange.to,u=a+1===r,u&&(o=Math.min(r,s),h=Math.max(n,a))),o=Math.min(o,0);const c=yield this.fetch(e.url,{range:{from:o,to:h},priority:i,measureThroughput:!1});if(!c)return null;const d=new DataView(c,s-o,a-o+1);if(!t.validateData(d))throw new Error("Invalid media file");const l=t.parseInit(d),p=e.indexRange??t.getIndexRange(l);if(!p)throw new ReferenceError("No way to load representation index");let m;if(u)m=new DataView(c,p.from-o,p.to-p.from+1);else{const t=yield this.fetch(e.url,{range:p,priority:i,measureThroughput:!1});if(!t)return null;m=new DataView(t)}const f=t.parseSegments(m,l,p);return{init:l,dataView:new DataView(c),segments:f}}.bind(this)),this.fetchTemplateRepresentation=(0,s.abortable)(this.abortAllController.signal,async function*(e,t){if(e.type!==de.TEMPLATE)return null;const i=new URL(e.initUrl,e.baseUrl).toString(),s=yield this.fetch(i,{priority:t,measureThroughput:!1});return s?{init:null,segments:e.segments.map((e=>({...e,status:le.NONE,size:void 0}))),dataView:new DataView(s)}:null}.bind(this)),this.throughputEstimator=e,this.requestQuic=t,this.compatibilityMode=i}}const dt=e=>{if(!nt(e))throw e},lt=1e3,pt=(e,t,i)=>i*t+(1-i)*e,mt=(e,t)=>e.reduce(((e,t)=>e+t),0)/t;class ft{next(e){let t=0,i=0;for(let e=0;e<this.pastMeasures.length;e++)void 0!==this.pastMeasures[e]&&(t+=(this.pastMeasures[e]-this.smoothed)**2,i++);this.takenMeasures=i,t/=i;const a=Math.sqrt(t),r=this.smoothed+this.params.deviationFactor*a,n=this.smoothed-this.params.deviationFactor*a;this.pastMeasures[this.measuresCursor]=e,this.measuresCursor=(this.measuresCursor+1)%this.pastMeasures.length,this.rawSeries$.next(e),this.updateSmoothedValue(e),this.smoothed$.next(this.smoothed),this.smoothedSeries$.next(this.smoothed),!(this.smoothed>r||this.smoothed<n)&&((0,s.isNullable)(this.prevReported)||Math.abs(this.smoothed-this.prevReported)/this.prevReported>=this.params.changeThreshold)&&(this.prevReported=this.smoothed,this.debounced$.next(this.smoothed),this.reportedSeries$.next(this.smoothed))}constructor(e){this.prevReported=void 0,this.pastMeasures=[],this.takenMeasures=0,this.measuresCursor=0,this.params=e,this.pastMeasures=Array(e.deviationDepth),this.smoothed=this.prevReported=e.initial,this.smoothed$=new s.ValueSubject(e.initial),this.debounced$=new s.ValueSubject(e.initial);const t=e.label??"value"+Math.random().toString(16).substring(2,6);this.rawSeries$=new U(`raw_${t}`),this.smoothedSeries$=new U(`smoothed_${t}`),this.reportedSeries$=new U(`reported_${t}`),this.rawSeries$.next(e.initial),this.smoothedSeries$.next(e.initial),this.reportedSeries$.next(e.initial)}}class gt extends ft{updateSmoothedValue(e){this.slow=pt(this.slow,e,this.params.emaAlphaSlow),this.fast=pt(this.fast,e,this.params.emaAlphaFast);const t=this.params.fastDirection>0?Math.max:Math.min;this.smoothed=t(this.slow,this.fast)}constructor(e){super(e),this.slow=this.fast=e.initial}}class bt extends ft{updateSmoothedValue(e){const t=mt(this.pastMeasures,this.takenMeasures);this.emaSmoothed=pt(this.emaSmoothed,e,this.params.emaAlpha);const i=((e,t,i,s)=>{let a=0,r=i;const n=mt(e,t),o=t<s?t:s;for(let t=0;t<o;t++)e[r]>n?a++:a--,r=(e.length+r-1)%e.length;return Math.abs(a)===o})(this.pastMeasures,this.takenMeasures,this.measuresCursor-1,this.params.basisTrendChangeCount);this.smoothed=i?this.emaSmoothed:t}constructor(e){super(e),this.emaSmoothed=e.initial}}class St extends ft{next(e){this.currentTopExtremumValue<=e?(this.currentTopExtremumValue=e,this.furtherValues=[]):this.furtherValues.length===this.extremumInterval?(super.next(this.currentTopExtremumValue),this.currentTopExtremumValue=e,this.furtherValues=[]):this.furtherValues.push(e)}updateSmoothedValue(e){this.smoothed=this.smoothed?pt(this.smoothed,e,this.params.emaAlpha):e}constructor(e){super(e),this.furtherValues=[],this.currentTopExtremumValue=0,this.extremumInterval=e.extremumInterval}}class vt{static getSmoothedValue(e,t,i){return"TwoEma"===i.type?new gt({initial:e,emaAlphaSlow:i.emaAlphaSlow,emaAlphaFast:i.emaAlphaFast,changeThreshold:i.changeThreshold,fastDirection:t,deviationDepth:i.deviationDepth,deviationFactor:i.deviationFactor,label:"throughput"}):new bt({initial:e,emaAlpha:i.emaAlpha,basisTrendChangeCount:i.basisTrendChangeCount,changeThreshold:i.changeThreshold,deviationDepth:i.deviationDepth,deviationFactor:i.deviationFactor,label:"throughput"})}static getLiveEstimatedDelaySmoothedValue(e,t){return new St({initial:e,label:"liveEdgeDelay",...t})}}const yt=()=>window.ManagedMediaSource||window.MediaSource,Tt=()=>!(!window.ManagedMediaSource||!window.ManagedSourceBuffer?.prototype?.appendBuffer),Et=["timeupdate","progress","play","seeked","stalled","waiting"];var wt;!function(e){e.NONE="none",e.MANIFEST_READY="manifest_ready",e.REPRESENTATIOS_READY="representations_ready",e.RUNNING="running"}(wt||(wt={}));let At=class{async seekLive(e){(0,s.assertNonNullable)(this.element);const t=this.normolizeLiveOffset(e);this.isActiveLowLatency=this.tuning.dashCmafLive.lowLatency.isActive&&0===t,this.liveLastSeekOffset=t,this.isJumpGapAfterSeekLive=!0,this.manifestUrlString=g(this.manifestUrlString,t,f.DASH_CMAF_OFFSET_P),this.manifest=await this.updateManifest(),this.manifest&&(await(this.videoBufferManager?.seekLive(this.manifest?.representations.video)),await(this.audioBufferManager?.seekLive(this.manifest?.representations.audio)))}initBuffer(){(0,s.assertNonNullable)(this.element),this.state$.setState(wt.RUNNING),this.subscription.add((0,s.merge)(...Et.map((e=>(0,s.fromEvent)(this.element,e))),(0,s.fromEvent)(window,"online")).subscribe((()=>this.tick()),(e=>{this.error$.next({id:"DashVKPlayer",category:s.ErrorCategory.WTF,message:"Internal logic error",thrown:e})}))),this.subscription.add((0,s.fromEvent)(this.element,"progress").subscribe((()=>{this.element&&2===this.element.readyState&&!this.element.seeking&&(this.element.currentTime=this.element.currentTime)}))),this.subscription.add((0,s.fromEvent)(this.element,"waiting").subscribe((()=>{this.element&&2===this.element.readyState&&!this.element.seeking&&$e(this.element.buffered,1e3*this.element.currentTime)&&(this.element.currentTime=this.element.currentTime),this.waitingEventInterval&&window.clearInterval(this.waitingEventInterval),this.waitingEventInterval=window.setInterval(this.waitingEventCallback.bind(this),this.tuning.dashMaxWaitingDuration)}))),this.tick()}async switchRepresentation(e,t){return{[he.VIDEO]:this.videoBufferManager,[he.AUDIO]:this.audioBufferManager,[he.TEXT]:null}[e]?.switchTo(t)}seek(e,t){let i;(0,s.assertNonNullable)(this.element),(0,s.assertNonNullable)(this.videoBufferManager),i=t||1e3*this.element.duration<=this.tuning.dashSeekInSegmentDurationThreshold||Math.abs(1e3*this.element.currentTime-e)<=this.tuning.dashSeekInSegmentAlwaysSeekDelta?e:Math.max(this.videoBufferManager.findSegmentStartTime(e)??e,this.audioBufferManager?.findSegmentStartTime(e)??e),$e(this.element.buffered,i)||(this.videoBufferManager.abort(),this.audioBufferManager?.abort()),this.videoBufferManager.maintain(i),this.audioBufferManager?.maintain(i),this.element.currentTime=i/1e3}stop(){this.element?.querySelectorAll("source").forEach((e=>e.remove())),this.element=null,this.source=null,this.manifest=null,this.currentVideoRepresentation$.next(void 0),this.videoBufferManager?.destroy(),this.videoBufferManager=null,this.audioBufferManager?.destroy(),this.audioBufferManager=null,this.bufferManagers=[],this.state$.setState(wt.NONE)}setBufferTarget(e){for(const t of this.bufferManagers)t.setTarget(e)}getRepresentations(){return this.manifest?.representations}setPreloadOnly(e){for(const t of this.bufferManagers)t.setPreloadOnly(e)}destroy(){this.subscription.unsubscribe(),this.representationSubscription.unsubscribe(),this.destroyController.abort(),this.fetcher.destroy(),window.clearInterval(this.waitingEventInterval),this.stop(),"open"===this.source?.readyState&&Array.from(this.source.sourceBuffers).every((e=>!e.updating))&&this.source.endOfStream(),this.source=null}async waitingEventCallback(){try{if(!this.element)return;this.isLive$.getValue()?await this.seekLive(this.liveLastSeekOffset):this.seek(1e3*this.element.currentTime,!0)}catch(e){this.error$.next({id:"WaitingEventCallback",category:s.ErrorCategory.WTF,message:"Error in seeking in waiting event callback",thrown:e})}}normolizeLiveOffset(e){return 1e3*Math.trunc(e/1e3)}async updateLive(){this.isUpdatingLive=!0,this.manifest=await this.updateManifest(),this.manifest&&this.bufferManagers?.forEach((e=>e.updateLive(this.manifest))),this.isUpdatingLive=!1}jumpGap(){if(!this.element||!this.videoBufferManager)return;const e=this.videoBufferManager.getDebugBufferState();if(!e)return;this.isJumpGapAfterSeekLive&&!this.isActiveLowLatency&&this.element.currentTime>e.to&&(this.isJumpGapAfterSeekLive=!1,this.element.currentTime=0);const t=1e3*this.element.currentTime,i=[];for(const e of this.bufferManagers)for(const s of e.gaps)e.playingRepresentation$.getValue()===s.representation&&s.from<=t&&s.to>t&&(1e3*this.element.duration-s.to<this.tuning.endGapTolerance?i.push(1/0):i.push(s.to));if(i.length){const e=Math.max(...i);e===1/0?(this.forceEnded$.next(),this.gapWatchdogSubscription.unsubscribe(),this.gapWatchdogStarted=!1):Math.trunc(1e3*this.element.currentTime)!==Math.trunc(e)&&(this.element.currentTime=e/1e3)}}constructor(e){this.element=null,this.manifestUrlString="",this.source=null,this.manifest=null,this.subscription=new s.Subscription,this.representationSubscription=new s.Subscription,this.state$=new v(wt.NONE),this.currentVideoRepresentation$=new s.ValueSubject(void 0),this.currentVideoRepresentationInit$=new s.ValueSubject(void 0),this.error$=new s.Subject,this.lastConnectionType$=new s.ValueSubject(void 0),this.lastConnectionReused$=new s.ValueSubject(void 0),this.lastRequestFirstBytes$=new s.ValueSubject(void 0),this.isLive$=new s.ValueSubject(!1),this.liveDuration$=new s.ValueSubject(0),this.liveAvailabilityStartTime$=new s.ValueSubject(void 0),this.bufferLength$=new s.ValueSubject(0),this.liveLoadBufferLength$=new s.ValueSubject(0),this.livePositionFromPlayer$=new s.ValueSubject(0),this.isActiveLowLatency=!1,this.isUpdatingLive=!1,this.isJumpGapAfterSeekLive=!1,this.liveLastSeekOffset=0,this.forceEnded$=new s.Subject,this.gapWatchdogStarted=!1,this.destroyController=new Ae,this.initManifest=(0,s.abortable)(this.destroyController.signal,async function*(e,t,i){this.element=e,this.manifestUrlString=g(t,i,f.DASH_CMAF_OFFSET_P),this.state$.startTransitionTo(wt.MANIFEST_READY),this.manifest=yield this.updateManifest(),this.manifest?.representations.video.length?this.state$.setState(wt.MANIFEST_READY):this.error$.next({id:"NoRepresentations",category:s.ErrorCategory.PARSER,message:"No playable video representations"})}.bind(this)),this.updateManifest=(0,s.abortable)(this.destroyController.signal,async function*(){const e=yield this.fetcher.fetchManifest(this.manifestUrlString).catch((e=>{!this.manifest&&!this.bufferLength$.getValue()&&this.error$.next({id:"LoadManifest",category:s.ErrorCategory.NETWORK,message:"Failed to load manifest",thrown:e})}));if(!e)return null;let t;try{t=((e,t)=>{const i={video:[],audio:[],text:[]},a=(new DOMParser).parseFromString(e,"application/xml").children[0],r=a.getElementsByTagName("Period")[0],n=a.querySelector("BaseURL")?.textContent?.trim()??"",o=r.children,h="dynamic"===a.getAttribute("type"),u=a.getAttribute("availabilityStartTime"),c=u?new Date(u).getTime():void 0;let d;const l=a.getAttribute("mediaPresentationDuration"),p=r.getAttribute("duration"),m=a.getElementsByTagName("vk:Attrs")[0]?.getElementsByTagName("vk:XPlaybackDuration")[0].textContent;if(l)d=Ke(l);else if(p){const e=Ke(p);(0,s.isNonNullable)(e)&&(d=e)}else m&&(d=parseInt(m,10));let f=0;const g=a.getAttribute("profiles")?.split(",")??[],b=g.includes(ce.WEBM_AS_IN_FFMPEG)||g.includes(ce.WEBM_AS_IN_SPEC)?pe.WEBM:pe.MP4;for(const e of o){const a=e.getAttribute("mimeType"),r=e.getAttribute("codecs"),o=e.getAttribute("contentType")??a?.split("/")[0],h=e.getAttribute("profiles")?.split(",")??[],u=e.querySelectorAll("Representation"),c=e.querySelector("SegmentTemplate");if(o!==he.TEXT)for(const l of u){const u=l.getAttribute("mimeType")??a,p=l.getAttribute("codecs")??r??"",m=l.getAttribute("contentType")??u?.split("/")[0]??o,b=e.getAttribute("profiles")?.split(",")??[],S=parseInt(l.getAttribute("width")??"",10),v=parseInt(l.getAttribute("height")??"",10),y=parseInt(l.getAttribute("bandwidth")??"",10)/1e3,T=l.getAttribute("frameRate")??"",E=l.getAttribute("quality")??void 0,w=T?Xe(T):void 0,A=`${l.getAttribute("id")??(f++).toString(10)}@${"video"===m?`${v}p`:"audio"===m?`${y}Kbps`:p}`,$=l.querySelector("BaseURL")?.textContent?.trim()??"",k=new URL($||n,t).toString(),P=[...g,...h,...b];let C;const L=l.querySelector("SegmentBase"),D=l.querySelector("SegmentTemplate")??c;if(L){const e=l.querySelector("SegmentBase Initialization")?.getAttribute("range")??"",[t,i]=e.split("-").map((e=>parseInt(e,10))),s={from:t,to:i},a=l.querySelector("SegmentBase")?.getAttribute("indexRange"),[r,n]=a?a.split("-").map((e=>parseInt(e,10))):[],o=a?{from:r,to:n}:void 0;C={type:de.BYTE_RANGE,url:k,initRange:s,indexRange:o}}else{if(!D)throw new ReferenceError("Unknown MPD segment referencing type");{const e={representationId:l.getAttribute("id")??void 0,bandwidth:l.getAttribute("bandwidth")??void 0},t=parseInt(D.getAttribute("timescale")??"",10),i=D.getAttribute("initialization")??"",a=D.getAttribute("media"),r=parseInt(D.getAttribute("startNumber")??"",10)??1,n=Ze(i,e);if(!a)throw new ReferenceError("No media attribute in SegmentTemplate");const o=D.querySelectorAll("SegmentTimeline S")??[],h=[];let u=0,c="",p=0;if(o.length){let i=r,s=0;for(const r of o){const n=parseInt(r.getAttribute("d")??"",10),o=parseInt(r.getAttribute("r")??"",10)||0,c=parseInt(r.getAttribute("t")??"",10);s=Number.isFinite(c)?c:s;const d=n/t*1e3,l=s/t*1e3;for(let t=0;t<o+1;t++){const r=Ze(a,{...e,segmentNumber:i.toString(10),segmentTime:(s+t*n).toString(10)}),o=(l??0)+t*d,u=o+d;i++,h.push({time:{from:o,to:u},url:r})}s+=(o+1)*n,u+=(o+1)*d}p=s/t*1e3,c=Ze(a,{...e,segmentNumber:i.toString(10),segmentTime:s.toString(10)})}else if((0,s.isNonNullable)(d)){const i=parseInt(D.getAttribute("duration")??"",10)/t*1e3,s=Math.ceil(d/i);let r=0;for(let t=1;t<s;t++){const s=Ze(a,{...e,segmentNumber:t.toString(10),segmentTime:r.toString(10)});h.push({time:{from:r,to:r+i},url:s}),r+=i}p=r,c=Ze(a,{...e,segmentNumber:s.toString(10),segmentTime:r.toString(10)})}const m={time:{from:p,to:1/0},url:c};C={type:de.TEMPLATE,baseUrl:k,segmentTemplateUrl:a,initUrl:n,totalSegmentsDurationMs:u,segments:h,nextSegmentBeyondManifest:m,timescale:t}}}if(!m||!u)continue;const R={video:he.VIDEO,audio:he.AUDIO,text:he.TEXT}[m];R&&i[R].push({id:A,kind:R,segmentReference:C,profiles:P,duration:d,bitrate:y,mime:u,codecs:p,width:S,height:v,fps:w,quality:E})}else for(const s of u){const a=s.getAttribute("id")||"",r=e.getAttribute("lang"),o=s.querySelector("BaseURL")?.textContent?.trim()??"",h=new URL(o||n,t).toString(),u=a.includes("_auto");i[he.TEXT].push({id:a,lang:r,isAuto:u,kind:he.TEXT,url:h})}}return{dynamic:h,liveAvailabilityStartTime:c,duration:d,container:b,representations:i}})(e??"",this.manifestUrlString)}catch(e){this.error$.next({id:"ManifestParsing",category:s.ErrorCategory.PARSER,message:"Failed to parse MPD manifest",thrown:e})}if(!t)return null;const i=({kind:e,mime:t,codecs:i})=>!!(this.element?.canPlayType?.(t)&&yt()?.isTypeSupported?.(`${t}; codecs="${i}"`)||e===he.TEXT);return t.dynamic&&this.isLive$.getValue()!==t.dynamic&&(this.isLive$.next(t.dynamic),this.liveDuration$.getValue()!==t.duration&&this.liveDuration$.next(-1*(t.duration??0)/1e3),this.liveAvailabilityStartTime$.getValue()!==t.liveAvailabilityStartTime&&this.liveAvailabilityStartTime$.next(t.liveAvailabilityStartTime)),{...t,representations:Object.fromEntries(Object.entries(t.representations).map((([e,t])=>[e,t.filter(i)])))}}.bind(this)),this.initRepresentations=(0,s.abortable)(this.destroyController.signal,async function*(e,t,i){(0,s.assertNonNullable)(this.manifest),(0,s.assertNonNullable)(this.element),this.representationSubscription.unsubscribe(),this.state$.startTransitionTo(wt.REPRESENTATIOS_READY);const a=e=>{this.representationSubscription.add((0,s.fromEvent)(e,"error").pipe((0,s.filter)((e=>!!this.element?.played.length))).subscribe((e=>{this.error$.next({id:"VideoSource",category:s.ErrorCategory.VIDEO_PIPELINE,message:"Unexpected video source error",thrown:e})})))};this.source=this.tuning.useManagedMediaSource&&window.ManagedMediaSource?new ManagedMediaSource:new MediaSource;const r=document.createElement("source");if(a(r),r.src=URL.createObjectURL(this.source),this.element.appendChild(r),this.tuning.useManagedMediaSource&&Tt())if(i){const e=document.createElement("source");a(e),e.type="application/x-mpegurl",e.src=i.url,this.element.appendChild(e)}else this.element.disableRemotePlayback=!0;this.isActiveLowLatency=this.isLive$.getValue()&&this.tuning.dashCmafLive.lowLatency.isActive;const n={fetcher:this.fetcher,tuning:this.tuning,getCurrentPosition:()=>this.element?1e3*this.element.currentTime:void 0,isActiveLowLatency:()=>this.isActiveLowLatency,manifest:this.manifest};if(this.videoBufferManager=new ot(he.VIDEO,this.source,this.manifest.container,this.manifest.representations.video,n),this.bufferManagers=[this.videoBufferManager],(0,s.isNonNullable)(t)&&(this.audioBufferManager=new ot(he.AUDIO,this.source,this.manifest.container,this.manifest.representations.audio,n),this.bufferManagers.push(this.audioBufferManager)),this.representationSubscription.add(this.fetcher.lastConnectionType$.subscribe(this.lastConnectionType$)),this.representationSubscription.add(this.fetcher.lastConnectionReused$.subscribe(this.lastConnectionReused$)),this.representationSubscription.add(this.fetcher.lastRequestFirstBytes$.subscribe(this.lastRequestFirstBytes$)),this.representationSubscription.add((0,s.interval)(lt).subscribe((e=>{if(this.element?.paused){const e=b(this.manifestUrlString,f.DASH_CMAF_OFFSET_P);this.manifestUrlString=g(this.manifestUrlString,e+lt,f.DASH_CMAF_OFFSET_P)}}))),this.representationSubscription.add((0,s.merge)(...Et.map((e=>(0,s.fromEvent)(this.element,e)))).pipe((0,s.map)((e=>this.element?ge(this.element.buffered,1e3*this.element.currentTime):0)),(0,s.filterChanged)(),(0,s.filter)((e=>!!e)),(0,s.tap)((e=>{this.waitingEventInterval&&(window.clearInterval(this.waitingEventInterval),this.waitingEventInterval=void 0)}))).subscribe(this.bufferLength$)),this.isLive$.getValue()){this.representationSubscription.add(this.bufferLength$.pipe((0,s.filter)((e=>this.isActiveLowLatency&&!!e))).subscribe((e=>this.liveEstimatedDelay.next(e)))),this.representationSubscription.add(this.liveEstimatedDelay.smoothed$.subscribe((e=>{if(!this.isActiveLowLatency)return;const t=this.tuning.dashCmafLive.lowLatency.maxTargetOffset,i=this.tuning.dashCmafLive.lowLatency.maxTargetOffsetDeviation,s=this.tuning.dashCmafLive.lowLatency.playbackCatchupSpeedup,a=e-t;let r=1+Math.sign(a)*s;Math.abs(a)<i?r=1:Math.abs(a)>2*i&&(r=1+Math.sign(a)*s*2),((e,t)=>{e&&e.playbackRate!==t&&(e.playbackRate=t)})(this.element,r)}))),this.representationSubscription.add(this.bufferLength$.subscribe((e=>{let t=0;if(e){const e=1e3*(this.element?.currentTime??0);t=Math.min(...this.bufferManagers.map((e=>e.getLiveSegmentsToLoadState(this.manifest)?.to??0)))-e}t&&this.liveLoadBufferLength$.getValue()!==t&&this.liveLoadBufferLength$.next(t)})));let e=0;this.representationSubscription.add((0,s.combine)({liveLoadBufferLength:this.liveLoadBufferLength$,bufferLength:this.bufferLength$}).subscribe((async({liveLoadBufferLength:t,bufferLength:i})=>{if((0,s.assertNonNullable)(this.element),this.isUpdatingLive)return;const a=this.element.playbackRate,r=b(this.manifestUrlString,f.DASH_CMAF_OFFSET_P),n=1e3*Math.abs(this.livePositionFromPlayer$.getValue()),o=Math.min(n,this.tuning.dashCmafLive.normalizedTargetMinBufferSize*a),h=this.tuning.dashCmafLive.normalizedActualBufferOffset*a,u=this.tuning.dashCmafLive.normalizedLiveMinBufferSize*a,c=this.isActiveLowLatency?i:t;let d=ue.None;if(this.isActiveLowLatency?d=ue.ActiveLowLatency:c<o+u&&c>=o?d=ue.LiveWithTargetOffset:0!==r&&c<o&&(d=ue.LiveForwardBuffering),isFinite(t)&&(e=t>e?t:e),d===ue.LiveForwardBuffering||d===ue.LiveWithTargetOffset){const i=e-(o+h),s=this.normolizeLiveOffset(Math.trunc(r+i/a)),n=Math.abs(s-r);let u;u=!t||n<=this.tuning.dashCmafLive.offsetCalculationError?r:s>0&&n>this.tuning.dashCmafLive.offsetCalculationError?s:0,this.manifestUrlString=g(this.manifestUrlString,u,f.DASH_CMAF_OFFSET_P)}d!==ue.None&&d!==ue.ActiveLowLatency&&(e=0,this.updateLive())})))}const o=(0,s.merge)(...this.bufferManagers.map((e=>e.fullyBuffered$))).pipe((0,s.map)((()=>this.bufferManagers.every((e=>e.fullyBuffered$.getValue()))))),h=(0,s.merge)(...this.bufferManagers.map((e=>e.onLastSegment$))).pipe((0,s.map)((()=>this.bufferManagers.some((e=>e.onLastSegment$.getValue())))));this.representationSubscription.add((0,s.merge)(this.forceEnded$,(0,s.combine)({allBuffersFull:o,someBufferEnded:h}).pipe((0,s.filter)((({allBuffersFull:e,someBufferEnded:t})=>e&&t)))).subscribe((()=>{if(this.source&&"open"===this.source.readyState&&Array.from(this.source.sourceBuffers).every((e=>!e.updating)))try{this.source?.endOfStream()}catch(e){this.error$.next({id:"EndOfStream",category:s.ErrorCategory.VIDEO_PIPELINE,message:"Failed to end MediaSource stream",thrown:e})}}))),this.representationSubscription.add((0,s.merge)(...this.bufferManagers.map((e=>e.error$))).subscribe(this.error$)),this.representationSubscription.add(this.videoBufferManager.playingRepresentation$.subscribe(this.currentVideoRepresentation$)),this.subscription.add(this.videoBufferManager.playingRepresentationInit$.subscribe(this.currentVideoRepresentationInit$)),"open"!==this.source.readyState&&(yield new Promise((e=>this.source?.addEventListener("sourceopen",e))));const u=this.manifest.duration??0,c=(e,t)=>Math.max(e,t.duration??0),d=this.manifest.representations.audio.reduce(c,u),l=this.manifest.representations.video.reduce(c,u);(d||l)&&(this.source.duration=Math.max(d,l)/1e3),this.audioBufferManager&&(0,s.isNonNullable)(t)?yield Promise.all([this.videoBufferManager.startWith(e),this.audioBufferManager.startWith(t)]):yield this.videoBufferManager.startWith(e),this.state$.setState(wt.REPRESENTATIOS_READY)}.bind(this)),this.tick=()=>{if(!this.element||!this.videoBufferManager)return;const e=1e3*this.element.currentTime;this.videoBufferManager.maintain(e),this.audioBufferManager?.maintain(e),(this.videoBufferManager.gaps.length||this.audioBufferManager?.gaps.length)&&!this.gapWatchdogStarted&&(this.gapWatchdogStarted=!0,this.gapWatchdogSubscription=(0,s.interval)(this.tuning.gapWatchdogInterval).subscribe((()=>this.jumpGap()),(e=>{this.error$.next({id:"GapWatchdog",category:s.ErrorCategory.WTF,message:"Error handling gaps",thrown:e})})),this.subscription.add(this.gapWatchdogSubscription))},this.throughputEstimator=e.throughputEstimator,this.tuning=e.tuning,this.fetcher=new ct({throughputEstimator:this.throughputEstimator,requestQuic:this.tuning.requestQuick,compatibilityMode:e.compatibilityMode}),this.liveEstimatedDelay=vt.getLiveEstimatedDelaySmoothedValue(0,{...e.tuning.dashCmafLive.lowLatency.delayEstimator})}};class $t{constructor(e,t){this.fov=e,this.orientation=t}}class kt{turnCamera(e=0,t=0,i=0){this.pointCameraTo(this.camera.orientation.x+e,this.camera.orientation.y+t,this.camera.orientation.z+i)}pointCameraTo(e=0,t=0,i=0){t=this.limitCameraRotationY(t);const s=e-this.camera.orientation.x,a=t-this.camera.orientation.y,r=i-this.camera.orientation.z;this.camera.orientation.x=e,this.camera.orientation.y=t,this.camera.orientation.z=i,this.lastCameraTurn={x:s,y:a,z:r},this.lastCameraTurnTS=Date.now()}setRotationSpeed(e,t,i){this.rotationSpeed.x=e??this.rotationSpeed.x,this.rotationSpeed.y=t??this.rotationSpeed.y,this.rotationSpeed.z=i??this.rotationSpeed.z}startRotation(){this.rotating=!0}stopRotation(e=!1){e?(this.setRotationSpeed(0,0,0),this.fadeStartSpeed=null):this.startFading(this.rotationSpeed.x,this.rotationSpeed.y,this.rotationSpeed.z),this.rotating=!1}onCameraRelease(){if(this.lastCameraTurn&&this.lastCameraTurnTS){const e=Date.now()-this.lastCameraTurnTS;if(e<this.options.speedFadeThreshold){const t=(1-e/this.options.speedFadeThreshold)*this.options.rotationSpeedCorrection;this.startFading(this.lastCameraTurn.x*t,this.lastCameraTurn.y*t,this.lastCameraTurn.z*t)}}}startFading(e,t,i){this.setRotationSpeed(e,t,i),this.fadeStartSpeed={...this.rotationSpeed},this.fading=!0}stopFading(){this.fadeStartSpeed=null,this.fading=!0,this.fadeTime=0}limitCameraRotationY(e){return Math.max(-this.options.maxYawAngle,Math.min(e,this.options.maxYawAngle))}tick(e){if(!this.lastTickTS)return this.lastTickTS=e,void(this.lastCameraTurnTS=Date.now());const t=e-this.lastTickTS,i=t/1e3;if(this.rotating)this.turnCamera(this.rotationSpeed.x*this.options.rotationSpeedCorrection*i,this.rotationSpeed.y*this.options.rotationSpeedCorrection*i,this.rotationSpeed.z*this.options.rotationSpeedCorrection*i);else if(this.fading&&this.fadeStartSpeed){const e=-this.fadeCorrection*(this.fadeTime/1e3)**2+1;this.setRotationSpeed(this.fadeStartSpeed.x*e,this.fadeStartSpeed.y*e,this.fadeStartSpeed.z*e),e>0?this.turnCamera(this.rotationSpeed.x*this.options.rotationSpeedCorrection*i,this.rotationSpeed.y*this.options.rotationSpeedCorrection*i,this.rotationSpeed.z*this.options.rotationSpeedCorrection*i):(this.stopRotation(!0),this.stopFading()),this.fadeTime=Math.min(this.fadeTime+t,this.options.speedFadeTime)}this.lastTickTS=e}constructor(e,t){this.rotating=!1,this.fading=!1,this.lastTickTS=0,this.lastCameraTurnTS=0,this.fadeStartSpeed=null,this.fadeTime=0,this.camera=e,this.options=t,this.rotationSpeed={x:0,y:0,z:0},this.fadeCorrection=1/(this.options.speedFadeTime/1e3)**2}}class Pt{play(){this.active||(this.videoInitialized?this.doPlay():this.sourceVideoElement.readyState>=2?(this.videoInitialized=!0,this.doPlay()):this.sourceVideoElement.addEventListener("loadeddata",this.videoElementDataLoadedFn))}stop(){this.active=!1}startCameraManualRotation(e,t){this.cameraRotationManager.setRotationSpeed(e*this.params.rotationSpeed,t*this.params.rotationSpeed,0),this.cameraRotationManager.startRotation()}stopCameraManualRotation(e=!1){this.cameraRotationManager.stopRotation(e)}turnCamera(e,t){this.cameraRotationManager.turnCamera(e,t)}pointCameraTo(e,t){this.cameraRotationManager.pointCameraTo(e,t)}pixelToDegree(e){return{x:this.params.degreeToPixelCorrection*this.params.fov.x*-e.x/this.viewportWidth,y:this.params.degreeToPixelCorrection*this.params.fov.y*e.y/this.viewportHeight}}getCameraRotation(){return this.camera.orientation}holdCamera(){this.cameraRotationManager.stopRotation(!0)}releaseCamera(){this.cameraRotationManager.onCameraRelease()}destroy(){this.sourceVideoElement.removeEventListener("loadeddata",this.videoElementDataLoadedFn),this.stop(),this.canvas.remove()}setViewportSize(e,t){this.viewportWidth=e,this.viewportHeight=t,this.canvas.width=this.viewportWidth,this.canvas.height=this.viewportHeight,this.gl.viewport(0,0,this.canvas.width,this.canvas.height)}onDataLoadedHandler(){this.videoInitialized=!0,this.doPlay()}doPlay(){this.updateFrameSize(),this.vertexBuffer=this.createVertexBuffer(),this.active=!0,this.sourceVideoElement.removeEventListener("loadeddata",this.videoElementDataLoadedFn),requestAnimationFrame(this.renderFn)}render(e){this.cameraRotationManager.tick(e),this.updateTexture(),this.updateTextureMappingBuffer();const t=this.gl.getAttribLocation(this.program,"a_vertex"),i=this.gl.getAttribLocation(this.program,"a_texel"),s=this.gl.getUniformLocation(this.program,"u_texture"),a=this.gl.getUniformLocation(this.program,"u_focus");this.gl.enableVertexAttribArray(t),this.gl.enableVertexAttribArray(i),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer),this.gl.vertexAttribPointer(t,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureMappingBuffer),this.gl.vertexAttribPointer(i,2,this.gl.FLOAT,!1,0,0),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.videoTexture),this.gl.uniform1i(s,0),this.gl.uniform2f(a,-this.camera.orientation.x,-this.camera.orientation.y),this.gl.drawArrays(this.gl.TRIANGLE_FAN,0,4),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null),this.gl.disableVertexAttribArray(t),this.gl.disableVertexAttribArray(i),this.active&&requestAnimationFrame(this.renderFn)}createShader(e,t){const i=this.gl.createShader(t);if(!i)throw this.destroy(),new Error(`Could not create shader (${t})`);if(this.gl.shaderSource(i,e),this.gl.compileShader(i),!this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS))throw this.destroy(),new Error("An error occurred while compiling the shader: "+this.gl.getShaderInfoLog(i));return i}createProgram(){const e=this.gl.createProgram();if(!e)throw this.destroy(),new Error("Could not create shader program");const t=this.createShader("#define GLSLIFY 1\nattribute vec2 a_vertex;attribute vec2 a_texel;varying vec2 v_texel;void main(void){gl_Position=vec4(a_vertex,0.0,1.0);v_texel=a_texel;}",this.gl.VERTEX_SHADER),i=this.createShader("#ifdef GL_ES\nprecision highp float;precision highp int;\n#else\nprecision highp float;\n#define GLSLIFY 1\n#endif\n#define PI 3.14159265358979323846264\nvarying vec2 v_texel;uniform sampler2D u_texture;uniform vec2 u_focus;void main(void){float lambda0=u_focus.x/360.0;float phi0=u_focus.y/180.0;float lambda=PI*2.0*(v_texel.x-0.5-lambda0);float phi=PI*(v_texel.y-0.5-phi0);float p=sqrt(lambda*lambda+phi*phi);float c=atan(p);float cos_c=cos(c);float sin_c=sin(c);float x=lambda0+atan(lambda*sin_c,p*cos(phi0)*cos_c-phi*sin(phi0)*sin_c);float y=asin(cos_c*sin(phi0)+(phi*sin_c*cos(phi0))/p);vec2 tc=vec2(mod(x/(PI*2.0)-0.5,1.0),mod(y/PI-0.5,1.0));gl_FragColor=texture2D(u_texture,tc);}",this.gl.FRAGMENT_SHADER);if(this.gl.attachShader(e,t),this.gl.attachShader(e,i),this.gl.linkProgram(e),!this.gl.getProgramParameter(e,this.gl.LINK_STATUS))throw this.destroy(),new Error("Could not link shader program.");return e}createTexture(){const e=this.gl.createTexture();if(!e)throw this.destroy(),new Error("Could not create texture");return this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.bindTexture(this.gl.TEXTURE_2D,null),e}updateTexture(){this.gl.bindTexture(this.gl.TEXTURE_2D,this.videoTexture),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!0),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.sourceVideoElement),this.gl.bindTexture(this.gl.TEXTURE_2D,null)}createVertexBuffer(){const e=this.gl.createBuffer();if(!e)throw this.destroy(),new Error("Could not create vertex buffer");let t=1,i=1;const s=this.frameHeight/(this.frameWidth/this.viewportWidth);return s>this.viewportHeight?t=this.viewportHeight/s:i=s/this.viewportHeight,this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([-t,-i,t,-i,t,i,-t,i]),this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null),e}createTextureMappingBuffer(){const e=this.gl.createBuffer();if(!e)throw this.destroy(),new Error("Could not create texture mapping buffer");return e}calculateTexturePosition(){const e=.5-this.camera.orientation.x/360,t=.5-this.camera.orientation.y/180,i=this.camera.fov.x/360/2,s=this.camera.fov.y/180/2;return[e-i,t-s,e+i,t-s,e+i,t+s,e-i,t+s]}updateTextureMappingBuffer(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureMappingBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([...this.calculateTexturePosition()]),this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)}updateFrameSize(){this.frameWidth=this.sourceVideoElement.videoWidth,this.frameHeight=this.sourceVideoElement.videoHeight}createCanvas(){const e=document.createElement("canvas");return e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.width="100%",e.style.height="100%",e}constructor(e,t,i){this.videoInitialized=!1,this.active=!1,this.container=e,this.sourceVideoElement=t,this.params=i,this.canvas=this.createCanvas();const s=this.canvas.getContext("webgl");if(!s)throw new Error("Could not initialize WebGL context");this.gl=s,this.container.appendChild(this.canvas),this.camera=new $t(this.params.fov,this.params.orientation),this.cameraRotationManager=new kt(this.camera,{rotationSpeed:this.params.rotationSpeed,maxYawAngle:this.params.maxYawAngle,rotationSpeedCorrection:this.params.rotationSpeedCorrection,degreeToPixelCorrection:this.params.degreeToPixelCorrection,speedFadeTime:this.params.speedFadeTime,speedFadeThreshold:this.params.speedFadeThreshold}),this.updateFrameSize(),this.vertexBuffer=this.createVertexBuffer(),this.textureMappingBuffer=this.createTextureMappingBuffer(),this.updateTextureMappingBuffer(),this.program=this.createProgram(),this.videoTexture=this.createTexture(),this.gl.useProgram(this.program),this.videoElementDataLoadedFn=this.onDataLoadedHandler.bind(this),this.renderFn=this.render.bind(this)}}class Ct{getProviderSubscriptionInfo(){const{output:e,desiredState:t}=this.params,i=M(this.video),a=this.constructor.name,r=t=>{e.error$.next({id:a,category:s.ErrorCategory.WTF,message:`${a} internal logic error`,thrown:t})};return{output:e,desiredState:t,observableVideo:i,genericErrorListener:r,connect:(e,t)=>this.subscription.add(e.subscribe(t,r))}}subscribe(){const{output:e,desiredState:t,observableVideo:i,genericErrorListener:a,connect:n}=this.getProviderSubscriptionInfo();this.droppedFramesManager.connect({logger:this.params.dependencies.logger,video:this.video,droppedFramesChecker:this.params.tuning.droppedFramesChecker,isAuto:this.params.desiredState.autoVideoTrackSwitching,playing$:i.playing$,pause$:i.pause$,tracks$:this.videoTracks$.pipe((0,s.map)((e=>e.map((({track:e})=>e)))))}),n(i.ended$,e.endedEvent$),n(i.looped$,e.loopedEvent$),n(i.error$,e.error$),n(i.isBuffering$,e.isBuffering$),n(i.currentBuffer$,e.currentBuffer$),n(i.playing$,e.firstFrameEvent$),n(i.canplay$,e.canplay$),n(i.inPiP$,e.inPiP$),n(i.inFullscreen$,e.inFullscreen$),n(this.player.error$,e.error$),n(this.player.lastConnectionType$,e.httpConnectionType$),n(this.player.lastConnectionReused$,e.httpConnectionReused$),n(this.player.isLive$,e.isLive$),n(this.player.lastRequestFirstBytes$.pipe((0,s.filter)(s.isNonNullable),(0,s.once)()),e.firstBytesEvent$),this.subscription.add(i.seeked$.subscribe(e.seekedEvent$,a)),this.subscription.add(P(this.video,t.isLooped,a)),this.subscription.add(C(this.video,t.volume,i.volumeState$,a)),this.subscription.add(i.volumeState$.subscribe(this.params.output.volume$,a)),this.subscription.add(L(this.video,t.playbackRate,i.playbackRateState$,a)),n(((e,t=300)=>new s.Observable((i=>{const{width:a,height:r}=e.getBoundingClientRect();if(i.next({width:a,height:r}),!window.ResizeObserver)return;const n=new ResizeObserver((0,s.debounceFn)((e=>{const t=e[0];if(!t)return;let a,r;t.contentBoxSize&&t.contentBoxSize[0]?(r=t.contentBoxSize[0].blockSize,a=t.contentBoxSize[0].inlineSize):t.contentRect&&(a=t.contentRect.width,r=t.contentRect.height),(0,s.isNonNullable)(a)&&(0,s.isNonNullable)(r)&&i.next({width:a,height:r})}),t));return n.observe(e),()=>n.disconnect()})))(this.video),this.elementSize$),n(((e,t)=>new s.Observable((i=>{if(!window.IntersectionObserver)return;const a=()=>!!window.documentPictureInPicture?.window||!!document.pictureInPictureElement,r=new IntersectionObserver(((e,t)=>{e.forEach((e=>i.next(e.isIntersecting||a())))}),{root:null,...t});r.observe(e);const n=(0,s.fromEvent)(document,"visibilitychange").pipe((0,s.map)((e=>!document.hidden||a()))).subscribe((e=>i.next(e)));return()=>{r.unobserve(e),n.unsubscribe}})))(this.video,{threshold:this.params.tuning.autoTrackSelection.activeVideoAreaThreshold}),this.elementVisible$),this.subscription.add(i.playing$.subscribe((()=>{this.videoState.setState(fe.PLAYING),S(t.playbackState,r.PLAYING),this.scene3D&&this.scene3D.play()}),a)).add(i.pause$.subscribe((()=>{this.videoState.setState(fe.PAUSED),S(t.playbackState,r.PAUSED)}),a)).add(i.canplay$.subscribe((()=>{this.videoState.getState()===fe.PLAYING&&this.playIfAllowed()}),a)),this.subscription.add(this.player.state$.stateChangeEnded$.subscribe((({to:e})=>{if(e===wt.MANIFEST_READY){const e=[];this.audioTracks=[],this.textTracks=[];const t=this.player.getRepresentations();(0,s.assertNonNullable)(t,"Manifest not loaded or empty");const i=Array.from(t.audio).sort(((e,t)=>t.bitrate-e.bitrate)),a=Array.from(t.video).sort(((e,t)=>t.bitrate-e.bitrate)),r=Array.from(t.text);if(!this.params.tuning.isAudioDisabled)for(const e of i){const t=tt(e);t&&this.audioTracks.push({track:t,representation:e})}for(const t of a){const s=et(t);if(s){e.push({track:s,representation:t});const r=!this.params.tuning.isAudioDisabled&&it(i,a,t);r&&this.audioRepresentations.set(t.id,r)}}this.videoTracks$.next(e);for(const e of r){const t=st(e);t&&this.textTracks.push({track:t,representation:e})}this.params.output.availableVideoTracks$.next(e.map((({track:e})=>e))),this.params.output.availableAudioTracks$.next(this.audioTracks.map((({track:e})=>e))),this.params.output.isAudioAvailable$.next(!!this.audioTracks.length),this.textTracks.length>0&&this.params.desiredState.internalTextTracks.startTransitionTo(this.textTracks.map((({track:e})=>e)));const n=this.selectVideoRepresentation();(0,s.assertNonNullable)(n),this.player.initRepresentations(n.id,this.audioRepresentations.get(n.id)?.id,this.params.sourceHls)}else e===wt.REPRESENTATIOS_READY&&(this.videoState.setState(fe.READY),this.player.initBuffer())}),a));const o=t=>e.error$.next({id:"RepresentationSwitch",category:s.ErrorCategory.WTF,message:"Switching representations threw",thrown:t});this.subscription.add((0,s.merge)(this.player.state$.stateChangeEnded$,t.videoTrack.stateChangeStarted$,t.autoVideoTrackSwitching.transitionStarted$,this.params.dependencies.throughputEstimator.rttAdjustedThroughput$,t.autoVideoTrackLimits.stateChangeStarted$,this.elementSize$,this.elementVisible$,this.droppedFramesManager.onDroopedVideoFramesLimit$,(0,s.fromEvent)(this.video,"progress")).subscribe((()=>{const e=this.player.state$.getState(),i=this.player.state$.getTransition();if(e!==wt.RUNNING||i||!this.videoTracks$.getValue().length)return;t.autoVideoTrackSwitching.getTransition()&&t.autoVideoTrackSwitching.setState(t.autoVideoTrackSwitching.getState());const a=this.selectVideoRepresentation(),r=this.params.desiredState.autoVideoTrackLimits.getTransition();r&&this.params.output.autoVideoTrackLimits$.next(r.to);const n=this.params.desiredState.autoVideoTrackSwitching.getState(),h=this.params.tuning.autoTrackSelection.backgroundVideoQualityLimit;if(a){let e=a.id;!this.elementVisible$.getValue()&&n&&(e=this.videoTracks$.getValue().map((e=>e.representation)).sort(((e,t)=>t.bitrate-e.bitrate)).filter((e=>{const t=(0,s.videoSizeToQuality)(e),i=(0,s.videoSizeToQuality)(a);if(t&&i)return(0,s.isLowerOrEqual)(t,i)&&(0,s.isLowerOrEqual)(t,h)})).map((e=>e.id))[0]),this.player.switchRepresentation(he.VIDEO,e).catch(o);const t=this.audioRepresentations.get(a.id);t&&this.player.switchRepresentation(he.AUDIO,t.id).catch(o)}}),a)),this.subscription.add(t.cameraOrientation.stateChangeEnded$.subscribe((({to:e})=>{this.scene3D&&e&&this.scene3D.pointCameraTo(e.x,e.y)}))),this.subscription.add(this.elementSize$.subscribe((e=>{this.scene3D&&e&&this.scene3D.setViewportSize(e.width,e.height)}))),this.subscription.add(this.player.currentVideoRepresentation$.pipe((0,s.filterChanged)(),(0,s.map)((e=>e&&this.videoTracks$.getValue().find((({representation:{id:t}})=>t===e))?.track))).subscribe(e.currentVideoTrack$,a)),this.subscription.add(this.player.currentVideoRepresentationInit$.subscribe((t=>{if(t?.is3dVideo&&this.params.tuning.spherical?.enabled)try{this.init3DScene(t),e.is3DVideo$.next(!0)}catch(t){e.warning$.next({id:"DashProvider",message:`DashProvider could not initialize 3D-scene: ${t}`})}else this.destroy3DScene(),this.params.tuning.spherical?.enabled&&e.is3DVideo$.next(!1)}),a)),this.textTracksManager.connect(this.video,t,e);const h=t.playbackState.stateChangeStarted$.pipe((0,s.map)((({to:e})=>e===r.READY)),(0,s.filterChanged)());this.subscription.add((0,s.merge)(h,t.autoVideoTrackSwitching.stateChangeStarted$,this.player.state$.stateChangeEnded$).subscribe((()=>{const e=t.autoVideoTrackSwitching.getState(),i=t.playbackState.getState()===r.READY?this.params.tuning.dash.forwardBufferTargetPreload:e?this.params.tuning.dash.forwardBufferTargetAuto:this.params.tuning.dash.forwardBufferTargetManual;this.player.setBufferTarget(i)}))),this.subscription.add((0,s.merge)(h,this.player.state$.stateChangeEnded$).subscribe((()=>this.player.setPreloadOnly(t.playbackState.getState()===r.READY))));const u=(0,s.merge)(t.playbackState.stateChangeStarted$,t.videoTrack.stateChangeStarted$,t.seekState.stateChangeEnded$,this.videoState.stateChangeEnded$,(0,s.observableFrom)(["init"])).pipe((0,s.debounce)(0));this.subscription.add(u.subscribe(this.syncPlayback,a))}selectVideoRepresentation(){const e=this.params.desiredState.autoVideoTrackSwitching.getState(),t=this.params.desiredState.videoTrack.getState()?.id,i=this.videoTracks$.getValue().find((({track:{id:e}})=>e===t))?.track,s=this.params.output.currentVideoTrack$.getValue(),a=ge(this.video.buffered,1e3*this.video.currentTime),r=e?this.params.tuning.dash.forwardBufferTargetAuto:this.params.tuning.dash.forwardBufferTargetManual,n=Math.min(a/Math.min(r,(1e3*this.video.duration||1/0)-1e3*this.video.currentTime),1),o=Math.max(i&&!e?this.audioRepresentations.get(i.id)?.bitrate??0:0,s?this.audioRepresentations.get(s.id)?.bitrate??0:0),h=Y(this.videoTracks$.getValue().map((({track:e})=>e)),{container:this.elementSize$.getValue(),throughput:this.params.dependencies.throughputEstimator.rttAdjustedThroughput$.getValue(),tuning:this.params.tuning.autoTrackSelection,limits:this.params.desiredState.autoVideoTrackLimits.getState(),reserve:o,forwardBufferHealth:n,current:s,history:this.videoTrackSwitchHistory,playbackRate:this.video.playbackRate,droppedVideoMaxQualityLimit:this.droppedFramesManager.droppedVideoMaxQualityLimit,abrLogger:this.params.dependencies.abrLogger}),u=e?h??i:i??h;return u&&this.videoTracks$.getValue().find((({track:e})=>e===u))?.representation}prepare(e=0){this.player.initManifest(this.video,this.params.source.url,e)}playIfAllowed(){z(this.video).then((e=>{e||(this.liveOffset?.pause(),this.videoState.setState(fe.PAUSED),S(this.params.desiredState.playbackState,r.PAUSED,!0))}),(e=>this.params.output.error$.next({id:"ForcePlay",message:"play() failed even with workarounds",category:s.ErrorCategory.DOM,thrown:e})))}destroy(){this.subscription.unsubscribe(),this.droppedFramesManager.destroy(),this.destroy3DScene(),this.textTracksManager.destroy(),this.player.destroy(),this.params.output.element$.next(void 0),$(this.video)}constructor(e){this.subscription=new s.Subscription,this.videoState=new v(fe.STOPPED),this.elementSize$=new s.ValueSubject(void 0),this.elementVisible$=new s.ValueSubject(!0),this.textTracksManager=new R,this.droppedFramesManager=new se,this.videoTracks$=new s.ValueSubject([]),this.audioTracks=[],this.audioRepresentations=new Map,this.videoTrackSwitchHistory=new q,this.textTracks=[],this.syncPlayback=()=>{const e=this.videoState.getState(),t=this.params.desiredState.playbackState.getState(),i=this.params.desiredState.playbackState.getTransition(),a=this.params.desiredState.seekState.getState();if(!this.videoState.getTransition()){if(a.state===d.Requested&&i?.to!==r.PAUSED&&e!==fe.STOPPED&&t!==r.STOPPED){const e=this.liveOffset?.getTotalPausedTime()??0;this.seek(a.position-e,a.forcePrecise)}if(t===r.STOPPED)return void(e!==fe.STOPPED&&(this.videoState.startTransitionTo(fe.STOPPED),this.player.stop(),this.video.removeAttribute("src"),this.video.load(),this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.videoState.setState(fe.STOPPED),S(this.params.desiredState.playbackState,r.STOPPED,!0)));switch(e){case fe.STOPPED:return this.videoState.startTransitionTo(fe.READY),void this.prepare();case fe.READY:return void(t===r.PAUSED?(this.videoState.setState(fe.PAUSED),S(this.params.desiredState.playbackState,r.PAUSED)):t===r.PLAYING?(this.videoState.startTransitionTo(fe.PLAYING),this.playIfAllowed()):i?.to===r.READY&&S(this.params.desiredState.playbackState,r.READY));case fe.PLAYING:return void(t===r.PAUSED?(this.videoState.startTransitionTo(fe.PAUSED),this.liveOffset?.pause(),this.video.pause()):i?.to===r.PLAYING&&S(this.params.desiredState.playbackState,r.PLAYING));case fe.PAUSED:return void(t===r.PLAYING?(this.videoState.startTransitionTo(fe.PLAYING),this.liveOffset?this.liveOffset.getTotalOffset()/1e3<Math.abs(this.params.output.duration$.getValue())?(this.liveOffset.resume(),this.playIfAllowed(),this.params.output.position$.next(-this.liveOffset.getTotalOffset()/1e3)):this.seek(0,!1):this.playIfAllowed()):i?.to===r.PAUSED&&S(this.params.desiredState.playbackState,r.PAUSED));default:return(0,s.assertNever)(e)}}},this.init3DScene=e=>{if(this.scene3D)return;this.scene3D=new Pt(this.params.container,this.video,{fov:this.params.tuning.spherical.fov,orientation:this.params.tuning.spherical.orientation||{x:e.projectionData?.pose.yaw||0,y:e.projectionData?.pose.pitch||0,z:e.projectionData?.pose.roll||0},rotationSpeed:this.params.tuning.spherical.rotationSpeed,maxYawAngle:this.params.tuning.spherical.maxYawAngle,rotationSpeedCorrection:this.params.tuning.spherical.rotationSpeedCorrection,degreeToPixelCorrection:this.params.tuning.spherical.degreeToPixelCorrection,speedFadeTime:this.params.tuning.spherical.speedFadeTime,speedFadeThreshold:this.params.tuning.spherical.speedFadeThreshold});const t=this.elementSize$.getValue();t&&this.scene3D.setViewportSize(t.width,t.height)},this.destroy3DScene=()=>{this.scene3D&&(this.scene3D.destroy(),this.scene3D=void 0)},this.params=e,this.video=A(e.container),this.params.output.element$.next(this.video),this.params.output.availableVideoTracks$.next([]),this.params.output.availableAudioTracks$.next([]),this.params.output.isAudioAvailable$.next(!0),this.params.output.hostname$.next(G(this.params.source.url)),this.params.output.isLive$.next(!1),this.params.output.autoVideoTrackLimitingAvailable$.next(!0),this.player=new At({throughputEstimator:this.params.dependencies.throughputEstimator,tuning:this.params.tuning,compatibilityMode:this.params.source.compatibilityMode}),this.subscribe()}}class Lt extends Ct{subscribe(){super.subscribe();const{output:e,observableVideo:t,connect:i}=this.getProviderSubscriptionInfo();i(t.timeUpdate$,e.position$),i(t.durationChange$,e.duration$)}seek(e,t){this.params.output.willSeekEvent$.next(),this.player.seek(e,t)}}class Dt extends Ct{subscribe(){super.subscribe();const{output:e,observableVideo:t,connect:i}=this.getProviderSubscriptionInfo();this.params.output.position$.next(0),i(t.timeUpdate$,e.liveBufferTime$),i(this.player.liveDuration$,e.duration$),this.subscription.add(this.params.output.position$.subscribe(this.player.livePositionFromPlayer$)).add((0,s.combine)({interval:(0,s.interval)(lt),playbackRate:t.playbackRateState$}).subscribe((({playbackRate:t})=>{if(this.videoState.getState()===fe.PLAYING&&!this.player.isActiveLowLatency){const i=e.position$.getValue()+(t-1);e.position$.next(i),this.liveOffset?.resetTo(1e3*-i)}}))).add((0,s.combine)({liveBufferTime:e.liveBufferTime$,liveAvailabilityStartTime:this.player.liveAvailabilityStartTime$}).pipe((0,s.map)((({liveBufferTime:e,liveAvailabilityStartTime:t})=>e&&t?e+t:void 0))).subscribe(e.liveTime$))}seek(e){this.params.output.willSeekEvent$.next();const t=this.params.desiredState.playbackState.getState(),i=this.videoState.getState(),s=t===r.PAUSED&&i===fe.PAUSED,a=-e,n=Math.trunc(a/1e3<=Math.abs(this.params.output.duration$.getValue())?a:0);this.player.seekLive(n).then((()=>{this.params.output.position$.next(e/1e3),this.liveOffset?.resetTo(n,s)}))}constructor(e){super(e),this.liveOffset=new N}}const Rt={};var Nt;!function(e){e.INITIALIZING="initializing",e.STOPPED="stopped",e.READY="ready",e.PLAYING="playing",e.PAUSED="paused"}(Nt||(Nt={}));const xt=(e,t)=>new s.Observable((i=>{const s=(e,t)=>i.next(t);return e.on(t,s),()=>e.off(t,s)}));class It{destroy(){this.subscription.unsubscribe(),this.trackLevels.clear(),this.textTracksManager.destroy(),this.hls?.detachMedia(),this.hls?.destroy(),this.params.output.element$.next(void 0),$(this.video)}loadHlsJs(){let e=!1;const t=t=>{e||this.params.output.error$.next({id:"timeout"===t?"HlsJsTimeout":"HlsJsLoadError",category:s.ErrorCategory.NETWORK,message:"Failed to load Hls.js",thrown:t}),e=!0},a=window.setTimeout((()=>t("timeout")),this.params.tuning.dynamicImportTimeout);i.e(24817).then(i.bind(i,293041)).then((t=>{e||(Rt.Hls=t.default,Rt.Events=t.default.Events,this.init())}),t).finally((()=>{window.clearTimeout(a),e=!0}))}init(){(0,s.assertNonNullable)(Rt.Hls,"hls.js not loaded"),this.hls=new Rt.Hls({fragLoadingMaxRetry:5,levelLoadingMaxRetry:2,manifestLoadingMaxRetry:2,fragLoadingMaxRetryTimeout:16e3,manifestLoadingMaxRetryTimeout:2e3,levelLoadingMaxRetryTimeout:2e3}),this.subscribe(),this.videoState.setState(Nt.STOPPED)}subscribe(){(0,s.assertNonNullable)(Rt.Events,"hls.js not loaded");const{desiredState:e,output:t}=this.params,i=e=>{t.error$.next({id:"HlsJsProvider",category:s.ErrorCategory.WTF,message:"HlsJsProvider internal logic error",thrown:e})},a=M(this.video),n=(e,t)=>this.subscription.add(e.subscribe(t,i));n(a.timeUpdate$,t.position$),n(a.durationChange$,t.duration$),n(a.ended$,t.endedEvent$),n(a.looped$,t.loopedEvent$),n(a.error$,t.error$),n(a.isBuffering$,t.isBuffering$),n(a.currentBuffer$,t.currentBuffer$),n(a.loadStart$,t.firstBytesEvent$),n(a.playing$,t.firstFrameEvent$),n(a.canplay$,t.canplay$),n(a.seeked$,t.seekedEvent$),n(a.inPiP$,t.inPiP$),n(a.inFullscreen$,t.inFullscreen$),this.subscription.add(P(this.video,e.isLooped,i)),this.subscription.add(C(this.video,e.volume,a.volumeState$,i)),this.subscription.add(a.volumeState$.subscribe(this.params.output.volume$)),this.subscription.add(L(this.video,e.playbackRate,a.playbackRateState$,i)),this.subscription.add(xt(this.hls,Rt.Events.ERROR).subscribe((e=>{e.fatal&&t.error$.next({id:["HlsJsFatal",e.type,e.details].join("_"),category:s.ErrorCategory.WTF,message:`HlsJs fatal ${e.type} ${e.details}, ${e.err?.message} ${e.reason}`,thrown:e.error})}))),this.subscription.add(a.playing$.subscribe((()=>{this.videoState.setState(Nt.PLAYING),S(e.playbackState,r.PLAYING)}),i)).add(a.pause$.subscribe((()=>{this.videoState.setState(Nt.PAUSED),S(e.playbackState,r.PAUSED)}),i)).add(a.canplay$.subscribe((()=>{this.videoState.getTransition()?.to===Nt.READY&&this.videoState.setState(Nt.READY),this.videoState.getState()===Nt.PLAYING&&this.playIfAllowed()}),i)),n(xt(this.hls,Rt.Events.MANIFEST_PARSED).pipe((0,s.map)((({levels:e})=>e.reduce(((e,t)=>{const i=t.name||t.height.toString(10),{width:a,height:r}=t,n=O(t.attrs.QUALITY??"")??(0,s.videoSizeToQuality)({width:a,height:r});if(!n)return e;const o=t.attrs["FRAME-RATE"]?parseFloat(t.attrs["FRAME-RATE"]):void 0,h={id:i.toString(),quality:n,bitrate:t.bitrate/1e3,size:{width:a,height:r},fps:o};return this.trackLevels.set(i,{track:h,level:t}),e.push(h),e}),[])))),t.availableVideoTracks$),n(xt(this.hls,Rt.Events.MANIFEST_PARSED),(t=>{if(t.subtitleTracks.length>0){const i=[];for(const e of t.subtitleTracks){const t=e.name,s=e.attrs.URI||"",a=e.lang,r="internal";i.push({id:t,url:s,language:a,type:r})}e.internalTextTracks.startTransitionTo(i)}})),n(xt(this.hls,Rt.Events.LEVEL_LOADING).pipe((0,s.map)((({url:e})=>G(e)))),t.hostname$),this.subscription.add(k(e.autoVideoTrackSwitching,(()=>this.hls.autoLevelEnabled),(e=>{this.hls.nextLevel=e?-1:this.hls.currentLevel,this.hls.loadLevel=e?-1:this.hls.loadLevel}),{onError:i}));const o=e=>Array.from(this.trackLevels.values()).find((({level:t})=>t===e))?.track,h=xt(this.hls,Rt.Events.LEVEL_SWITCHED).pipe((0,s.map)((({level:e})=>o(this.hls.levels[e]))));h.pipe((0,s.filter)(s.isNonNullable)).subscribe(t.currentVideoTrack$,i),this.subscription.add(k(e.videoTrack,(()=>o(this.hls.levels[this.hls.currentLevel])),(e=>{if((0,s.isNullable)(e))return;const t=this.trackLevels.get(e.id)?.level;if(!t)return;const i=this.hls.levels.indexOf(t),a=this.hls.currentLevel,r=this.hls.levels[a];!r||t.bitrate>r.bitrate?this.hls.nextLevel=i:(this.hls.loadLevel=i,this.hls.loadLevel=i)}),{changed$:h,onError:i})),n(a.progress$,(()=>{this.params.dependencies.throughputEstimator.addRawThroughput(this.hls.bandwidthEstimate/1e3)})),this.textTracksManager.connect(this.video,e,t);const u=(0,s.merge)(e.playbackState.stateChangeStarted$,e.videoTrack.stateChangeStarted$,e.seekState.stateChangeEnded$,this.videoState.stateChangeEnded$,(0,s.observableFrom)(["init"])).pipe((0,s.debounce)(0));this.subscription.add(u.subscribe(this.syncPlayback,i))}prepare(){this.videoState.startTransitionTo(Nt.READY),this.hls.attachMedia(this.video),this.hls.loadSource(this.params.source.url)}async playIfAllowed(){this.videoState.startTransitionTo(Nt.PLAYING),await z(this.video).catch((e=>this.params.output.error$.next({id:"ForcePlay",message:"play() failed even with workarounds",category:s.ErrorCategory.DOM,thrown:e})))||(this.videoState.setState(Nt.PAUSED),S(this.params.desiredState.playbackState,r.PAUSED,!0))}pause(){this.videoState.startTransitionTo(Nt.PAUSED),this.video.pause()}seek(e){this.params.output.willSeekEvent$.next(),this.video.currentTime=e/1e3}stop(){this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.hls.stopLoad(),this.hls.detachMedia(),this.video.removeAttribute("src"),this.video.load(),this.videoState.setState(Nt.STOPPED),S(this.params.desiredState.playbackState,r.STOPPED,!0)}constructor(e){this.subscription=new s.Subscription,this.videoState=new v(Nt.INITIALIZING),this.textTracksManager=new R,this.trackLevels=new Map,this.syncPlayback=()=>{const e=this.videoState.getState(),t=this.params.desiredState.playbackState.getState(),i=this.params.desiredState.playbackState.getTransition(),a=this.params.desiredState.seekState.getState();if(e!==Nt.INITIALIZING)switch(i?.to!==r.PAUSED&&a.state===d.Requested&&this.seek(a.position),t){case r.STOPPED:switch(e){case Nt.STOPPED:break;case Nt.READY:case Nt.PLAYING:case Nt.PAUSED:this.stop();break;default:(0,s.assertNever)(e)}break;case r.READY:switch(e){case Nt.STOPPED:this.prepare();break;case Nt.READY:case Nt.PLAYING:case Nt.PAUSED:break;default:(0,s.assertNever)(e)}break;case r.PLAYING:switch(e){case Nt.PLAYING:break;case Nt.STOPPED:this.prepare();break;case Nt.READY:case Nt.PAUSED:this.playIfAllowed();break;default:(0,s.assertNever)(e)}break;case r.PAUSED:switch(e){case Nt.PAUSED:break;case Nt.STOPPED:this.prepare();break;case Nt.READY:this.videoState.setState(Nt.PAUSED),S(this.params.desiredState.playbackState,r.PAUSED);break;case Nt.PLAYING:this.pause();break;default:(0,s.assertNever)(e)}break;default:(0,s.assertNever)(t)}},this.video=A(e.container),this.params=e,this.params.output.element$.next(this.video),this.params.output.isLive$.next(!1),this.params.output.availableVideoTracks$.next([]),this.params.output.availableAudioTracks$.next([]),this.params.output.isAudioAvailable$.next(!0),this.params.output.hostname$.next(G(this.params.source.url)),this.loadHlsJs()}}const Mt="X-Playback-Duration";var Ot=async e=>{const t=await we(e),i=await t.text(),s=/#EXT-X-VK-PLAYBACK-DURATION:(\d+)/m.exec(i)?.[1];return s?parseInt(s,10):t.headers.has(Mt)?parseInt(t.headers.get(Mt),10):void 0};const _t=e=>{let t=null;if(e.QUALITY&&(t=O(e.QUALITY)),!t&&e.RESOLUTION){const[i,a]=e.RESOLUTION.split("x").map((e=>parseInt(e,10)));t=(0,s.videoSizeToQuality)({width:i,height:a})}return t??null};let Vt=0;const Bt=async(e,t=e,i)=>{const a=await(await we(e)).text();Vt+=1;try{const{qualityManifests:e,textTracks:i}=((e,t)=>{const i=e.split("\n"),s=[],a=[];for(let e=0;e<i.length;e++){const r=i[e],n=r.match(/^#EXT-X-STREAM-INF:(.+)/),o=r.match(/^#EXT-X-MEDIA:TYPE=SUBTITLES,(.+)/);if(n||o){if(n){const a=Object.fromEntries(n[1].split(",").map((e=>e.split("=")))),r=a.QUALITY??`stream-${a.BANDWIDTH}`,o=_t(a);let h;a.BANDWIDTH&&(h=parseInt(a.BANDWIDTH,10)/1e3||void 0),!h&&a["AVERAGE-BANDWIDTH"]&&(h=parseInt(a["AVERAGE-BANDWIDTH"],10)/1e3||void 0);const u=a["FRAME-RATE"]?parseFloat(a["FRAME-RATE"]):void 0;let c;if(a.RESOLUTION){const[e,t]=a.RESOLUTION.split("x").map((e=>parseInt(e,10)));e&&t&&(c={width:e,height:t})}const d=new URL(i[++e],t).toString();o&&s.push({id:r,quality:o,url:d,bandwidth:h,size:c,fps:u})}if(o){const e=Object.fromEntries(o[1].split(",").map((e=>e.split("="))).map((([e,t])=>[e,t.replace(/^"|"$/g,"")]))),t=e.URI?.replace(/playlist$/,"subtitles.vtt"),i=e.LANGUAGE,s=e.NAME;t&&i&&a.push({type:"internal",id:i,label:s,language:i,url:t,isAuto:!1})}}}if(!s.length)throw new Error("Empty manifest");return{qualityManifests:s,textTracks:a}})(a,t);return{qualityManifests:e,textTracks:i}}catch{if(Vt<=i.manifestRetryMaxCount)return await(e=>new Promise((t=>{setTimeout((()=>{t()}),e)})))((0,s.getExponentialDelay)(Vt-1,{start:i.manifestRetryInterval,max:i.manifestRetryMaxInterval})),Bt(e,t,i)}return{qualityManifests:[],textTracks:[]}};var Ft,Ut,Ht;!function(e){e.STOPPED="stopped",e.READY="ready",e.PLAYING="playing",e.CHANGING_MANIFEST="changing_manifest",e.PAUSED="paused"}(Ft||(Ft={}));class jt{selectManifest(){const{autoVideoTrackSwitching:e,videoTrack:t}=this.params.desiredState,i=e.getState(),s=t.getTransition(),a=s?.to?.id??t.getState()?.id??"master",r=this.manifests$.getValue();if(!r.length)return;const n=i?"master":a;return i&&!s&&t.startTransitionTo(this.masterManifest),r.find((e=>e.id===n))}subscribe(){const{output:e,desiredState:t}=this.params,i=t=>{e.error$.next({id:"HlsLiveProvider",category:s.ErrorCategory.WTF,message:"HlsLiveProvider internal logic error",thrown:t})},a=M(this.video),n=(e,t)=>this.subscription.add(e.subscribe(t,i));n(a.ended$,e.endedEvent$),n(a.error$,e.error$),n(a.isBuffering$,e.isBuffering$),n(a.currentBuffer$,e.currentBuffer$),n(a.loadedMetadata$,e.firstBytesEvent$),n(a.playing$,e.firstFrameEvent$),n(a.canplay$,e.canplay$),n(a.inPiP$,e.inPiP$),n(a.inFullscreen$,e.inFullscreen$),this.subscription.add(t.isLooped.stateChangeStarted$.subscribe((()=>t.isLooped.setState(!1)),i)),this.subscription.add(C(this.video,t.volume,a.volumeState$,i)),this.subscription.add(a.volumeState$.subscribe(this.params.output.volume$,i)),this.subscription.add(L(this.video,t.playbackRate,a.playbackRateState$,i)),this.textTracksManager.connect(this.video,t,e),this.subscription.add(a.playing$.subscribe((()=>{this.videoState.setState(Ft.PLAYING),S(t.playbackState,r.PLAYING)}),i)).add(a.pause$.subscribe((()=>{this.videoState.setState(Ft.PAUSED),S(t.playbackState,r.PAUSED)}),i)).add(a.canplay$.subscribe((()=>{this.videoState.getTransition()?.to===Ft.READY&&this.videoState.setState(Ft.READY),this.videoState.getState()===Ft.PLAYING&&this.playIfAllowed()}),i)),this.subscription.add(this.maxSeekBackTime$.pipe((0,s.filterChanged)(),(0,s.map)((e=>-e/1e3))).subscribe(this.params.output.duration$,i)),this.subscription.add(a.loadedMetadata$.subscribe((()=>{const e=this.params.desiredState.seekState.getState(),t=this.videoState.getTransition(),i=this.params.desiredState.videoTrack.getTransition(),a=this.params.desiredState.autoVideoTrackSwitching.getTransition();if(i&&(0,s.isNonNullable)(i.to)){const e=i.to.id;this.params.desiredState.videoTrack.setState(i.to);const t=this.manifests$.getValue().find((t=>t.id===e));t&&(this.params.output.currentVideoTrack$.next(t),this.params.output.hostname$.next(G(t.url)))}a&&this.params.desiredState.autoVideoTrackSwitching.setState(a.to),t&&t.from===Ft.CHANGING_MANIFEST&&this.videoState.setState(t.to),e&&e.state===d.Requested&&this.seek(e.position)}),i)),this.subscription.add(a.loadedData$.subscribe((()=>{const e=this.video?.getStartDate?.()?.getTime();this.manifestStartTime$.next(e||void 0)}),i)),this.subscription.add((0,s.combine)({startTime:this.manifestStartTime$.pipe((0,s.filter)(s.isNonNullable)),currentTime:a.timeUpdate$}).subscribe((({startTime:e,currentTime:t})=>this.params.output.liveTime$.next(e+1e3*t)),i)),this.subscription.add(this.manifests$.pipe((0,s.map)((e=>e.map((({id:e,quality:t,size:i,bandwidth:s,fps:a})=>({id:e,quality:t,size:i,fps:a,bitrate:s})))))).subscribe(this.params.output.availableVideoTracks$,i));const o=(0,s.merge)(t.playbackState.stateChangeStarted$,t.seekState.stateChangeEnded$,t.videoTrack.stateChangeStarted$,t.autoVideoTrackSwitching.stateChangeStarted$,t.autoVideoTrackLimits.stateChangeStarted$,this.videoState.stateChangeEnded$,this.manifests$,(0,s.observableFrom)(["init"])).pipe((0,s.debounce)(0));this.subscription.add(o.subscribe(this.syncPlayback,i))}destroy(){this.subscription.unsubscribe(),this.textTracksManager.destroy(),this.params.output.element$.next(void 0),$(this.video)}prepare(){const e=this.selectManifest();if((0,s.isNullable)(e))return;const t=this.params.desiredState.autoVideoTrackLimits.getTransition(),i=this.params.desiredState.autoVideoTrackLimits.getState(),a=new URL(e.url);if((t||i)&&e.id===this.masterManifest.id){const{max:e,min:s}=t?.to??i??{};for(const[t,i]of[[e,"mq"],[s,"lq"]]){const e=String(parseFloat(t||""));i&&t&&a.searchParams.set(i,e)}}const r=this.params.format===o.HLS_LIVE_CMAF?f.DASH_CMAF_OFFSET_P:f.OFFSET_P,n=g(a.toString(),this.liveOffset.getTotalOffset(),r);this.video.setAttribute("src",n),this.video.load(),Ot(n).then((e=>{if((0,s.isNullable)(e)){const e=this.params.source.maxSeekBackTime??this.maxSeekBackTime$.getValue();if((0,s.isNullable)(e)||!isFinite(e))try{we(n).then((e=>e.text())).then((e=>{const t=/#EXT-X-STREAM-INF[^\n]+\n(.+)/m.exec(e)?.[1];if(t){const e=new URL(t,n).toString();Ot(e).then((e=>{(0,s.isNullable)(e)||this.maxSeekBackTime$.next(e)}))}}))}catch{}}else this.maxSeekBackTime$.next(e)}))}playIfAllowed(){z(this.video).then((e=>{e||(this.videoState.setState(Ft.PAUSED),this.liveOffset.pause(),S(this.params.desiredState.playbackState,r.PAUSED,!0))}),(e=>this.params.output.error$.next({id:"ForcePlay",message:"play() failed even with workarounds",category:s.ErrorCategory.DOM,thrown:e})))}seek(e){this.params.output.willSeekEvent$.next();const t=-e,i=t<this.maxSeekBackTime$.getValue()?t:0;this.liveOffset.resetTo(i),this.params.output.position$.next(-i/1e3),this.params.output.seekedEvent$.next()}constructor(e){this.subscription=new s.Subscription,this.videoState=new v(Ft.STOPPED),this.textTracksManager=new R,this.manifests$=new s.ValueSubject([]),this.liveOffset=new N,this.manifestStartTime$=new s.ValueSubject(void 0),this.syncPlayback=()=>{if(!this.manifests$.getValue().length)return;const e=this.videoState.getState(),t=this.params.desiredState.playbackState.getState(),i=this.params.desiredState.playbackState.getTransition(),a=this.params.desiredState.videoTrack.getTransition(),n=this.params.desiredState.autoVideoTrackSwitching.getTransition(),o=this.params.desiredState.autoVideoTrackLimits.getTransition();if(t===r.STOPPED)return void(e!==Ft.STOPPED&&(this.videoState.startTransitionTo(Ft.STOPPED),this.video.removeAttribute("src"),this.video.load(),this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.videoState.setState(Ft.STOPPED),S(this.params.desiredState.playbackState,r.STOPPED,!0)));if(this.videoState.getTransition())return;const h=this.params.desiredState.seekState.getState();if(e===Ft.STOPPED)return this.videoState.startTransitionTo(Ft.READY),void this.prepare();if(a||n||o){const e=this.videoState.getState();return this.videoState.setState(Ft.CHANGING_MANIFEST),this.videoState.startTransitionTo(e),this.prepare(),o&&this.params.output.autoVideoTrackLimits$.next(o.to),void(h.state===d.None&&this.params.desiredState.seekState.setState({state:d.Requested,position:-this.liveOffset.getTotalOffset(),forcePrecise:!0}))}if(i?.to!==r.PAUSED&&h.state===d.Requested)return this.videoState.startTransitionTo(Ft.READY),this.seek(h.position-this.liveOffset.getTotalPausedTime()),void this.prepare();switch(e){case Ft.READY:return void(t===r.READY?S(this.params.desiredState.playbackState,r.READY):t===r.PAUSED?(this.videoState.setState(Ft.PAUSED),this.liveOffset.pause(),S(this.params.desiredState.playbackState,r.PAUSED)):t===r.PLAYING&&(this.videoState.startTransitionTo(Ft.PLAYING),this.playIfAllowed()));case Ft.PLAYING:return void(t===r.PAUSED?(this.videoState.startTransitionTo(Ft.PAUSED),this.liveOffset.pause(),this.video.pause()):i?.to===r.PLAYING&&S(this.params.desiredState.playbackState,r.PLAYING));case Ft.PAUSED:if(t===r.PLAYING)if(this.videoState.startTransitionTo(Ft.PLAYING),this.liveOffset.getTotalPausedTime()<this.params.config.maxPausedTime&&this.liveOffset.getTotalOffset()<this.maxSeekBackTime$.getValue())this.liveOffset.resume(),this.playIfAllowed(),this.params.output.position$.next(-this.liveOffset.getTotalOffset()/1e3);else{let e=this.liveOffset.getTotalOffset();e>=this.maxSeekBackTime$.getValue()&&(e=0,this.liveOffset.resetTo(e)),this.liveOffset.resume(),this.params.output.position$.next(-e/1e3),this.prepare()}else i?.to===r.PAUSED&&(S(this.params.desiredState.playbackState,r.PAUSED),this.liveOffset.pause());return;case Ft.CHANGING_MANIFEST:break;default:return(0,s.assertNever)(e)}},this.params=e,this.video=A(e.container),this.params.output.element$.next(this.video),this.masterManifest={id:"master",quality:s.VideoQuality.INVARIANT,url:this.params.source.url},Bt(g(this.params.source.url),this.params.source.url,{manifestRetryInterval:this.params.tuning.manifestRetryInterval,manifestRetryMaxInterval:this.params.tuning.manifestRetryMaxInterval,manifestRetryMaxCount:this.params.tuning.manifestRetryMaxCount}).then((({qualityManifests:e})=>{0===e.length&&this.params.output.error$.next({id:"HlsLiveProviderInternal:empty_manifest",category:s.ErrorCategory.WTF,message:"HlsLiveProvider: there are no qualities in manifest"}),this.manifests$.next([this.masterManifest,...e])}),(e=>this.params.output.error$.next({id:"ExtractHlsQualities",category:s.ErrorCategory.NETWORK,message:"Error fetching manifest and extracting qualities",thrown:e}))),this.params.output.isLive$.next(!0),this.params.output.canChangePlaybackSpeed$.next(!1),this.params.output.availableVideoTracks$.next([]),this.params.output.availableAudioTracks$.next([]),this.params.output.isAudioAvailable$.next(!0),this.params.output.hostname$.next(G(this.params.source.url)),this.maxSeekBackTime$=new s.ValueSubject(e.source.maxSeekBackTime??1/0),this.subscribe()}}!function(e){e.STOPPED="stopped",e.READY="ready",e.PLAYING="playing",e.CHANGING_MANIFEST="changing_manifest",e.PAUSED="paused"}(Ut||(Ut={}));class qt{selectManifest(){const{autoVideoTrackSwitching:e,videoTrack:t}=this.params.desiredState,i=e.getState(),s=t.getTransition(),a=s?.to?.id??t.getState()?.id??"master",r=this.manifests$.getValue();if(!r.length)return;const n=i?"master":a;return i&&!s&&t.startTransitionTo(this.masterManifest),r.find((e=>e.id===n))}subscribe(){const{output:e,desiredState:t}=this.params,i=t=>{e.error$.next({id:"HlsProvider",category:s.ErrorCategory.WTF,message:"HlsProvider internal logic error",thrown:t})},a=M(this.video),n=(e,t)=>this.subscription.add(e.subscribe(t));if(n(a.timeUpdate$,e.position$),n(a.durationChange$,e.duration$),n(a.ended$,e.endedEvent$),n(a.looped$,e.loopedEvent$),n(a.error$,e.error$),n(a.isBuffering$,e.isBuffering$),n(a.currentBuffer$,e.currentBuffer$),n(a.loadedMetadata$,e.firstBytesEvent$),n(a.playing$,e.firstFrameEvent$),n(a.canplay$,e.canplay$),n(a.seeked$,e.seekedEvent$),n(a.inPiP$,e.inPiP$),n(a.inFullscreen$,e.inFullscreen$),this.subscription.add(P(this.video,t.isLooped,i)),this.subscription.add(C(this.video,t.volume,a.volumeState$,i)),this.subscription.add(a.volumeState$.subscribe(this.params.output.volume$,i)),this.subscription.add(L(this.video,t.playbackRate,a.playbackRateState$,i)),this.textTracksManager.connect(this.video,t,e),this.subscription.add(a.playing$.subscribe((()=>{this.videoState.setState(Ut.PLAYING),S(t.playbackState,r.PLAYING)}),i)).add(a.pause$.subscribe((()=>{this.videoState.setState(Ut.PAUSED),S(t.playbackState,r.PAUSED)}),i)).add(a.canplay$.subscribe((()=>{this.videoState.getTransition()?.to===Ut.READY&&this.videoState.setState(Ut.READY),this.videoState.getState()===Ut.PLAYING&&this.playIfAllowed()}),i).add(a.loadedMetadata$.subscribe((()=>{const e=this.params.desiredState.seekState.getState(),t=this.videoState.getTransition(),i=this.params.desiredState.videoTrack.getTransition(),a=this.params.desiredState.autoVideoTrackSwitching.getTransition();if(i&&(0,s.isNonNullable)(i.to)){const e=i.to.id;this.params.desiredState.videoTrack.setState(i.to);const t=this.manifests$.getValue().find((t=>t.id===e));if(t){this.params.output.currentVideoTrack$.next(t),this.params.output.hostname$.next(G(t.url));const e=this.params.desiredState.playbackRate.getState(),i=this.params.output.element$.getValue()?.playbackRate;if(e!==i){const t=this.params.output.element$.getValue();t&&(this.params.desiredState.playbackRate.setState(e),t.playbackRate=e)}}}a&&this.params.desiredState.autoVideoTrackSwitching.setState(a.to),t&&t.from===Ut.CHANGING_MANIFEST&&this.videoState.setState(t.to),e.state===d.Requested&&this.seek(e.position)}),i))),this.subscription.add(this.manifests$.pipe((0,s.map)((e=>e.map((({id:e,quality:t,size:i,bandwidth:s,fps:a})=>({id:e,quality:t,size:i,fps:a,bitrate:s})))))).subscribe(this.params.output.availableVideoTracks$,i)),!(0,s.isIOS)()||!this.params.tuning.useNativeHLSTextTracks){const{textTracks:e}=this.video;this.subscription.add((0,s.merge)((0,s.fromEvent)(e,"addtrack"),(0,s.fromEvent)(e,"removetrack"),(0,s.fromEvent)(e,"change"),(0,s.observableFrom)(["init"])).subscribe((()=>{for(let t=0;t<e.length;t++)e[t].mode="hidden"}),i))}const o=(0,s.merge)(t.playbackState.stateChangeStarted$,t.seekState.stateChangeEnded$,t.videoTrack.stateChangeStarted$,t.autoVideoTrackSwitching.stateChangeStarted$,t.autoVideoTrackLimits.stateChangeStarted$,this.videoState.stateChangeEnded$,this.manifests$,(0,s.observableFrom)(["init"])).pipe((0,s.debounce)(0));this.subscription.add(o.subscribe(this.syncPlayback,i))}destroy(){this.subscription.unsubscribe(),this.textTracksManager.destroy(),this.params.output.element$.next(void 0),$(this.video)}prepare(){const e=this.selectManifest();if((0,s.isNullable)(e))return;const t=this.params.desiredState.autoVideoTrackLimits.getTransition(),i=this.params.desiredState.autoVideoTrackLimits.getState(),a=new URL(e.url);if((t||i)&&e.id===this.masterManifest.id){const{max:e,min:s}=t?.to??i??{};for(const[t,i]of[[e,"mq"],[s,"lq"]]){const e=String(parseFloat(t||""));i&&t&&a.searchParams.set(i,e)}}this.video.setAttribute("src",a.toString()),this.video.load()}playIfAllowed(){z(this.video).then((e=>{e||(this.videoState.setState(Ut.PAUSED),S(this.params.desiredState.playbackState,r.PAUSED,!0))}),(e=>this.params.output.error$.next({id:"ForcePlay",message:"play() failed even with workarounds",category:s.ErrorCategory.DOM,thrown:e})))}seek(e){this.params.output.willSeekEvent$.next(),this.video.currentTime=e/1e3}constructor(e){this.subscription=new s.Subscription,this.videoState=new v(Ut.STOPPED),this.textTracksManager=new R,this.manifests$=new s.ValueSubject([]),this.syncPlayback=()=>{if(!this.manifests$.getValue().length)return;const e=this.videoState.getState(),t=this.params.desiredState.playbackState.getState(),i=this.params.desiredState.playbackState.getTransition(),a=this.params.desiredState.videoTrack.getTransition(),n=this.params.desiredState.autoVideoTrackSwitching.getTransition(),o=this.params.desiredState.autoVideoTrackLimits.getTransition();if(t===r.STOPPED)return void(e!==Ut.STOPPED&&(this.videoState.startTransitionTo(Ut.STOPPED),this.video.removeAttribute("src"),this.video.load(),this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.videoState.setState(Ut.STOPPED),S(this.params.desiredState.playbackState,r.STOPPED,!0)));if(this.videoState.getTransition())return;const h=this.params.desiredState.seekState.getState();if(e===Ut.STOPPED)return this.videoState.startTransitionTo(Ut.READY),void this.prepare();if(a||n||o){const e=this.videoState.getState();this.videoState.setState(Ut.CHANGING_MANIFEST),this.videoState.startTransitionTo(e);const{currentTime:t}=this.video;return this.prepare(),o&&this.params.output.autoVideoTrackLimits$.next(o.to),void(h.state===d.None&&this.params.desiredState.seekState.setState({state:d.Requested,position:1e3*t,forcePrecise:!0}))}switch(i?.to!==r.PAUSED&&h.state===d.Requested&&this.seek(h.position),e){case Ut.READY:return void(t===r.READY?S(this.params.desiredState.playbackState,r.READY):t===r.PAUSED?(this.videoState.setState(Ut.PAUSED),S(this.params.desiredState.playbackState,r.PAUSED)):t===r.PLAYING&&(this.videoState.startTransitionTo(Ut.PLAYING),this.playIfAllowed()));case Ut.PLAYING:return void(t===r.PAUSED?(this.videoState.startTransitionTo(Ut.PAUSED),this.video.pause()):i?.to===r.PLAYING&&S(this.params.desiredState.playbackState,r.PLAYING));case Ut.PAUSED:return void(t===r.PLAYING?(this.videoState.startTransitionTo(Ut.PLAYING),this.playIfAllowed()):i?.to===r.PAUSED&&S(this.params.desiredState.playbackState,r.PAUSED));case Ut.CHANGING_MANIFEST:break;default:return(0,s.assertNever)(e)}},this.params=e,this.video=A(e.container),this.params.output.element$.next(this.video),this.masterManifest={id:"master",quality:s.VideoQuality.INVARIANT,url:this.params.source.url},this.params.output.isLive$.next(!1),this.params.output.availableVideoTracks$.next([]),this.params.output.availableAudioTracks$.next([]),this.params.output.isAudioAvailable$.next(!0),this.params.output.hostname$.next(G(this.params.source.url)),this.params.output.autoVideoTrackLimitingAvailable$.next(!0),Bt(g(this.params.source.url),this.params.source.url,{manifestRetryInterval:this.params.tuning.manifestRetryInterval,manifestRetryMaxInterval:this.params.tuning.manifestRetryMaxInterval,manifestRetryMaxCount:this.params.tuning.manifestRetryMaxCount}).then((({qualityManifests:e,textTracks:t})=>{this.manifests$.next([this.masterManifest,...e]),this.params.tuning.useNativeHLSTextTracks||this.params.desiredState.internalTextTracks.startTransitionTo(t)}),(e=>this.params.output.error$.next({id:"ExtractHlsQualities",category:s.ErrorCategory.NETWORK,message:"Error fetching manifest and extracting qualities",thrown:e}))),this.subscribe()}}!function(e){e.STOPPED="stopped",e.READY="ready",e.PLAYING="playing",e.PAUSED="paused"}(Ht||(Ht={}));class Yt{subscribe(){const{output:e,desiredState:t}=this.params,i=t=>{e.error$.next({id:"MpegProvider",category:s.ErrorCategory.WTF,message:"MpegProvider internal logic error",thrown:t})},a=M(this.video),n=(e,t)=>this.subscription.add(e.subscribe(t,i));n(a.timeUpdate$,e.position$),n(a.durationChange$,e.duration$),n(a.ended$,e.endedEvent$),n(a.looped$,e.loopedEvent$),n(a.error$,e.error$),n(a.isBuffering$,e.isBuffering$),n(a.currentBuffer$,e.currentBuffer$),n(a.loadedMetadata$,e.firstBytesEvent$),n(a.playing$,e.firstFrameEvent$),n(a.canplay$,e.canplay$),n(a.seeked$,e.seekedEvent$),n(a.inPiP$,e.inPiP$),n(a.inFullscreen$,e.inFullscreen$),this.subscription.add(P(this.video,t.isLooped,i)),this.subscription.add(C(this.video,t.volume,a.volumeState$,i)),this.subscription.add(a.volumeState$.subscribe(this.params.output.volume$,i)),this.subscription.add(L(this.video,t.playbackRate,a.playbackRateState$,i)),this.subscription.add(a.playing$.subscribe((()=>{this.videoState.setState(Ht.PLAYING),S(t.playbackState,r.PLAYING)}),i)).add(a.pause$.subscribe((()=>{this.videoState.setState(Ht.PAUSED),S(t.playbackState,r.PAUSED)}),i)).add(a.canplay$.subscribe((()=>{this.videoState.getTransition()?.to===Ht.READY&&this.videoState.setState(Ht.READY);const e=this.params.desiredState.videoTrack.getTransition();if(e&&(0,s.isNonNullable)(e.to)){this.params.desiredState.videoTrack.setState(e.to),this.params.output.currentVideoTrack$.next(this.trackUrls[e.to.id].track);const t=this.params.desiredState.playbackRate.getState(),i=this.params.output.element$.getValue()?.playbackRate;if(t!==i){const e=this.params.output.element$.getValue();e&&(this.params.desiredState.playbackRate.setState(t),e.playbackRate=t)}}this.videoState.getState()===Ht.PLAYING&&this.playIfAllowed()}),i)),this.textTracksManager.connect(this.video,t,e);const o=(0,s.merge)(t.playbackState.stateChangeStarted$,t.videoTrack.stateChangeStarted$,t.seekState.stateChangeEnded$,t.autoVideoTrackLimits.stateChangeStarted$,this.videoState.stateChangeEnded$,(0,s.observableFrom)(["init"])).pipe((0,s.debounce)(0));this.subscription.add(o.subscribe(this.syncPlayback,i))}destroy(){this.subscription.unsubscribe(),this.textTracksManager.destroy(),this.trackUrls={},this.params.output.element$.next(void 0),$(this.video)}prepare(){const e=this.params.desiredState.videoTrack.getState()?.id;(0,s.assertNonNullable)(e,"MpegProvider: track is not selected");let{url:t}=this.trackUrls[e];(0,s.assertNonNullable)(t,`MpegProvider: No url for ${e}`),this.params.tuning.requestQuick&&(t=ut(t)),this.video.setAttribute("src",t),this.video.load(),this.params.output.hostname$.next(G(t))}playIfAllowed(){z(this.video).then((e=>{e||(this.videoState.setState(Ht.PAUSED),S(this.params.desiredState.playbackState,r.PAUSED,!0))}),(e=>this.params.output.error$.next({id:"ForcePlay",message:"play() failed even with workarounds",category:s.ErrorCategory.DOM,thrown:e})))}seek(e){this.params.output.willSeekEvent$.next(),this.video.currentTime=e/1e3}handleQualityLimitTransition(e){let t,i=e;if(e&&this.params.output.currentVideoTrack$.getValue()?.quality!==e){const a=Object.values(this.trackUrls).find((t=>!(0,s.isInvariantQuality)(t.track.quality)&&(0,s.isLowerOrEqual)(t.track.quality,e)))?.track,r=this.params.desiredState.videoTrack.getState()?.id,n=this.trackUrls[r??"0"]?.track;if(a&&n&&(0,s.isHigherOrEqual)(n.quality,a.quality)&&(t=a),!t){const i=Object.values(this.trackUrls).filter((t=>!(0,s.isInvariantQuality)(t.track.quality)&&(0,s.isHigher)(t.track.quality,e))),a=i.length;a&&(t=i[a-1].track)}t&&(i=t.quality)}else if(!e){const e=Object.values(this.trackUrls).map((e=>e.track));t=Y(e,{container:{width:this.video.offsetWidth,height:this.video.offsetHeight},throughput:this.params.dependencies.throughputEstimator.throughput$.getValue(),tuning:this.params.tuning.autoTrackSelection,forwardBufferHealth:0,abrLogger:this.params.dependencies.abrLogger})}t&&(this.params.output.currentVideoTrack$.next(t),this.params.desiredState.videoTrack.startTransitionTo(t)),this.params.output.autoVideoTrackLimits$.next({max:i})}constructor(e){this.subscription=new s.Subscription,this.videoState=new v(Ht.STOPPED),this.trackUrls={},this.textTracksManager=new R,this.syncPlayback=()=>{const e=this.videoState.getState(),t=this.params.desiredState.playbackState.getState(),i=this.params.desiredState.playbackState.getTransition();if(t===r.STOPPED)return void(e!==Ht.STOPPED&&(this.videoState.startTransitionTo(Ht.STOPPED),this.video.removeAttribute("src"),this.video.load(),this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.videoState.setState(Ht.STOPPED),S(this.params.desiredState.playbackState,r.STOPPED,!0)));if(this.videoState.getTransition())return;const a=this.params.desiredState.autoVideoTrackLimits.getTransition(),n=this.params.desiredState.videoTrack.getTransition(),o=this.params.desiredState.seekState.getState();if(!a||e===Ht.READY||n){if(e===Ht.STOPPED)return this.videoState.startTransitionTo(Ht.READY),void this.prepare();if(n){const{currentTime:e}=this.video;return this.prepare(),o.state===d.None&&this.params.desiredState.seekState.setState({state:d.Requested,position:1e3*e,forcePrecise:!0}),void(n.to&&this.params.desiredState.autoVideoTrackLimits.getState()?.max!==this.trackUrls[n.to.id]?.track?.quality&&this.params.output.autoVideoTrackLimits$.next({max:void 0}))}switch(i?.to!==r.PAUSED&&o.state===d.Requested&&this.seek(o.position),e){case Ht.READY:return void(t===r.READY?S(this.params.desiredState.playbackState,r.READY):t===r.PAUSED?(this.videoState.setState(Ht.PAUSED),S(this.params.desiredState.playbackState,r.PAUSED)):t===r.PLAYING&&(this.videoState.startTransitionTo(Ht.PLAYING),this.playIfAllowed()));case Ht.PLAYING:return void(t===r.PAUSED?(this.videoState.startTransitionTo(Ht.PAUSED),this.video.pause()):i?.to===r.PLAYING&&S(this.params.desiredState.playbackState,r.PLAYING));case Ht.PAUSED:return void(t===r.PLAYING?(this.videoState.startTransitionTo(Ht.PLAYING),this.playIfAllowed()):i?.to===r.PAUSED&&S(this.params.desiredState.playbackState,r.PAUSED));default:return(0,s.assertNever)(e)}}else this.handleQualityLimitTransition(a.to.max)},this.params=e,this.video=A(e.container),this.params.output.element$.next(this.video),Object.entries(this.params.source).reverse().forEach((([e,t],i)=>{const s=i.toString(10);this.trackUrls[s]={track:{quality:e,id:s},url:t}})),this.params.output.isLive$.next(!1),this.params.output.availableVideoTracks$.next(Object.values(this.trackUrls).map((({track:e})=>e))),this.params.output.availableAudioTracks$.next([]),this.params.output.isAudioAvailable$.next(!0),this.params.desiredState.autoVideoTrackSwitching.setState(!1),this.params.output.autoVideoTrackLimitingAvailable$.next(!0),this.subscribe()}}const Gt=["stun:videostun.mycdn.me:80"],Qt=()=>null;class zt{onStart(e){try{this.externalStartCallback=e}catch(e){this.handleSystemError(e)}}onStop(e){try{this.externalStopCallback=e}catch(e){this.handleSystemError(e)}}onError(e){try{this.externalErrorCallback=e}catch(e){this.handleSystemError(e)}}connect(){this.connectWS()}disconnect(){try{this.externalStopCallback(),this.closeConnections()}catch(e){this.handleSystemError(e)}}connectWS(){this.ws||(this.ws=new WebSocket(this.serverUrl),this.ws.onopen=this.onSocketOpen.bind(this),this.ws.onmessage=this.onSocketMessage.bind(this),this.ws.onclose=this.onSocketClose.bind(this),this.ws.onerror=this.onSocketError.bind(this))}onSocketOpen(){this.handleLogin()}onSocketClose(e){try{if(!this.ws)return;this.ws=null,e.code>1e3?(this.retryCount++,this.retryCount>this.options.maxRetryNumber?this.handleNetworkError():this.scheduleRetry()):this.externalStopCallback()}catch(e){this.handleRTCError(e)}}onSocketError(e){try{this.externalErrorCallback(new Error(e.toString()))}catch(e){this.handleRTCError(e)}}onSocketMessage(e){try{const t=this.parseMessage(e.data);switch(t.type){case"JOIN":case"CALL_JOIN":this.handleJoinMessage(t);break;case"UPDATE":this.handleUpdateMessage(t);break;case"STATUS":this.handleStatusMessage(t)}}catch(e){this.handleRTCError(e)}}handleJoinMessage(e){switch(e.inviteType){case"ANSWER":this.handleAnswer(e.sdp);break;case"CANDIDATE":this.handleCandidate(e.candidate)}}handleStatusMessage(e){if("UNPUBLISHED"===e.status)this.handleUnpublished()}async handleUpdateMessage(e){try{const t=await this.createOffer();this.peerConnection&&await this.peerConnection.setLocalDescription(t),this.handleAnswer(e.sdp)}catch(e){this.handleRTCError(e)}}async handleLogin(){try{const e={iceServers:[{urls:Gt}]};this.peerConnection=new RTCPeerConnection(e),this.peerConnection.ontrack=this.onPeerConnectionStream.bind(this),this.peerConnection.onicecandidate=this.onPeerConnectionIceCandidate.bind(this),this.peerConnection.oniceconnectionstatechange=this.onPeerConnectionIceConnectionStateChange.bind(this);const t=await this.createOffer();await this.peerConnection.setLocalDescription(t),this.send({type:this.signalingType,inviteType:"OFFER",streamKey:this.streamKey,sdp:t.sdp,callSupport:!1})}catch(e){this.handleRTCError(e)}}async handleAnswer(e){try{this.peerConnection&&await this.peerConnection.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:e}))}catch(e){this.handleRTCError(e)}}async handleCandidate(e){if(e)try{this.peerConnection&&await this.peerConnection.addIceCandidate(e)}catch(e){this.handleRTCError(e)}}handleUnpublished(){try{this.closeConnections(),this.externalStopCallback()}catch(e){this.handleRTCError(e)}}handleSystemError(e){this.options.errorChanel&&this.options.errorChanel.next({id:"webrtc-provider-error",category:s.ErrorCategory.WTF,message:e.message})}async onPeerConnectionStream(e){const t=e.streams[0];this.stream&&this.stream.id===t.id||(this.stream=t,this.externalStartCallback(this.stream))}onPeerConnectionIceCandidate(e){e.candidate&&this.send({type:this.signalingType,inviteType:"CANDIDATE",candidate:e.candidate})}onPeerConnectionIceConnectionStateChange(){if(this.peerConnection){const e=this.peerConnection.iceConnectionState;["failed","closed"].indexOf(e)>-1&&(this.retryCount++,this.retryCount>this.options.maxRetryNumber?this.handleNetworkError():(this.closeConnections(),this.scheduleRetry()))}}async createOffer(){if(!this.peerConnection)throw new Error("Can not create offer - no peer connection instance ");const e=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0,voiceActivityDetection:!1}),t=e.sdp||"";if(!/^a=rtpmap:\d+ H264\/\d+$/m.test(t))throw new Error("No h264 codec support error");return e}handleRTCError(e){try{this.externalErrorCallback(e||new Error("RTC connection error"))}catch(e){this.handleSystemError(e)}}handleNetworkError(){try{this.externalErrorCallback(new Error("Network error"))}catch(e){this.handleSystemError(e)}}send(e){this.ws&&this.ws.send(JSON.stringify(e))}parseMessage(e){try{return JSON.parse(e)}catch{throw new Error("Can not parse socket message")}}closeConnections(){const e=this.ws;e&&(this.ws=null,e.close(1e3)),this.removePeerConnection()}removePeerConnection(){let e=this.peerConnection;e&&(this.peerConnection=null,e.close(),e.ontrack=null,e.onicecandidate=null,e.oniceconnectionstatechange=null,e=null)}scheduleRetry(){this.retryTimeout=setTimeout(this.connectWS.bind(this),1e3)}normalizeOptions(e={}){const t={stunServerList:Gt,maxRetryNumber:3,errorChanel:null};return e.stunServerList&&(t.stunServerList=e.stunServerList),e.maxRetryNumber&&e.maxRetryNumber>0&&(t.maxRetryNumber=e.maxRetryNumber),t}constructor(e,t){this.ws=null,this.peerConnection=null,this.serverUrl="",this.streamKey="",this.stream=null,this.signalingType="JOIN",this.retryCount=0,this.externalStartCallback=Qt,this.externalStopCallback=Qt,this.externalErrorCallback=Qt,this.options=this.normalizeOptions(t);const i=e.split("/");this.serverUrl=i.slice(0,i.length-1).join("/"),this.streamKey=i[i.length-1]}}var Wt;!function(e){e.STOPPED="stopped",e.READY="ready",e.PLAYING="playing",e.PAUSED="paused"}(Wt||(Wt={}));class Jt{destroy(){this.subscription.unsubscribe(),this.liveStreamClient.disconnect(),this.params.output.element$.next(void 0),$(this.video)}subscribe(){const{output:e,desiredState:t}=this.params,i=t=>{e.error$.next({id:"WebRTCLiveProvider",category:s.ErrorCategory.WTF,message:"WebRTCLiveProvider internal logic error",thrown:t})};(0,s.merge)(this.videoState.stateChangeStarted$.pipe((0,s.map)((e=>({transition:e,type:"start"})))),this.videoState.stateChangeEnded$.pipe((0,s.map)((e=>({transition:e,type:"end"}))))).subscribe((({transition:e,type:t})=>{this.log({message:`[videoState change] ${t}: ${JSON.stringify(e)}`})}));const a=M(this.video),n=(e,t)=>this.subscription.add(e.subscribe(t,i));n(a.timeUpdate$,e.liveTime$),n(a.ended$,e.endedEvent$),n(a.looped$,e.loopedEvent$),n(a.error$,e.error$),n(a.isBuffering$,e.isBuffering$),n(a.currentBuffer$,e.currentBuffer$),this.subscription.add(a.durationChange$.subscribe((t=>{e.duration$.next(t===1/0?0:t)}))).add(a.canplay$.subscribe((()=>{this.videoState.getTransition()?.to===Wt.READY&&this.videoState.setState(Wt.READY)}),i)).add(a.pause$.subscribe((()=>{this.videoState.setState(Wt.PAUSED)}),i)).add(a.playing$.subscribe((()=>{this.videoState.setState(Wt.PLAYING)}),i)).add(a.error$.subscribe(e.error$)).add(this.maxSeekBackTime$.subscribe(this.params.output.duration$)).add(C(this.video,t.volume,a.volumeState$,i)).add(a.volumeState$.subscribe(e.volume$,i)).add(this.videoState.stateChangeEnded$.subscribe((i=>{switch(i.to){case Wt.STOPPED:e.position$.next(0),e.duration$.next(0),t.playbackState.setState(r.STOPPED);break;case Wt.READY:break;case Wt.PAUSED:t.playbackState.setState(r.PAUSED);break;case Wt.PLAYING:t.playbackState.setState(r.PLAYING);break;default:return(0,s.assertNever)(i.to)}}),i)).add((0,s.merge)(t.playbackState.stateChangeStarted$,this.videoState.stateChangeEnded$,(0,s.observableFrom)(["init"])).pipe((0,s.debounce)(0)).subscribe(this.syncPlayback.bind(this),i)),this.subscription.add(t.isLooped.stateChangeStarted$.subscribe((()=>t.isLooped.setState(!1)),i)),this.subscription.add(t.autoVideoTrackSwitching.stateChangeStarted$.subscribe((()=>t.autoVideoTrackSwitching.setState(!1)),i))}onLiveStreamStart(e){this.params.output.element$.next(this.video),this.params.output.duration$.next(0),this.params.output.position$.next(0),this.params.output.isLive$.next(!0),this.params.output.canChangePlaybackSpeed$.next(!1),this.params.output.hostname$.next(G(this.params.source.url)),this.params.output.autoVideoTrackLimitingAvailable$.next(!1),this.params.output.availableVideoTracks$.next([]),this.params.output.availableAudioTracks$.next([]),this.params.output.isAudioAvailable$.next(!0),this.params.output.currentVideoTrack$.next({id:"webrtc",quality:s.VideoQuality.INVARIANT}),this.video.srcObject=e,S(this.params.desiredState.playbackState,r.PLAYING)}onLiveStreamStop(){this.videoState.startTransitionTo(Wt.STOPPED),this.syncPlayback(),this.params.output.position$.next(0),this.params.output.duration$.next(0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.params.output.endedEvent$.next()}onLiveStreamError(e){this.onLiveStreamStop(),this.params.output.error$.next({id:"WebRTC stream runtime error",category:s.ErrorCategory.EXTERNAL_API,message:e.message,thrown:e})}playIfAllowed(){z(this.video).then((e=>{e||(this.videoState.setState(Wt.PAUSED),S(this.params.desiredState.playbackState,r.PAUSED,!0))}),(e=>this.params.output.error$.next({id:"ForcePlay",message:"play() failed even with workarounds",category:s.ErrorCategory.DOM,thrown:e})))}prepare(){this.liveStreamClient.connect()}constructor(e){this.videoState=new v(Wt.STOPPED),this.maxSeekBackTime$=new s.ValueSubject(0),this.syncPlayback=()=>{const e=this.videoState.getState(),t=this.params.desiredState.playbackState.getState(),i=this.params.desiredState.playbackState.getTransition();if(t===r.STOPPED)return void(e!==Wt.STOPPED&&(this.videoState.startTransitionTo(Wt.STOPPED),this.video.pause(),this.video.srcObject=null,this.params.output.position$.next(0),this.params.output.duration$.next(0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.videoState.setState(Wt.STOPPED),S(this.params.desiredState.playbackState,r.STOPPED,!0)));if(this.videoState.getTransition())return;const a=this.params.desiredState.videoTrack.getTransition();if(e===Wt.STOPPED)return this.videoState.startTransitionTo(Wt.READY),void this.prepare();if(a)this.prepare();else switch(e){case Wt.READY:return void(t===r.PAUSED?(this.videoState.setState(Wt.PAUSED),S(this.params.desiredState.playbackState,r.PAUSED)):t===r.PLAYING&&(this.videoState.startTransitionTo(Wt.PLAYING),this.playIfAllowed()));case Wt.PLAYING:return void(t===r.PAUSED?(this.videoState.startTransitionTo(Wt.PAUSED),this.video.pause()):i?.to===r.PLAYING&&S(this.params.desiredState.playbackState,r.PLAYING));case Wt.PAUSED:return void(t===r.PLAYING?(this.videoState.startTransitionTo(Wt.PLAYING),this.playIfAllowed()):i?.to===r.PAUSED&&S(this.params.desiredState.playbackState,r.PAUSED));default:return(0,s.assertNever)(e)}},this.subscription=new s.Subscription,this.params=e,this.log=this.params.dependencies.logger.createComponentLog("WebRTCLiveProvider"),this.video=A(e.container),this.liveStreamClient=new zt(this.params.source.url,{maxRetryNumber:this.params.tuning.webrtc.connectionRetryMaxNumber,errorChanel:this.params.output.error$}),this.liveStreamClient.onStart(this.onLiveStreamStart.bind(this)),this.liveStreamClient.onStop(this.onLiveStreamStop.bind(this)),this.liveStreamClient.onError(this.onLiveStreamError.bind(this)),this.subscribe()}}class Xt{next(){this.current=this.iterator.next()}getValue(){if(this.current.done)throw new Error("Iterable is completed");return this.current.value}isCompleted(){return!!this.current.done}constructor(e){this.iterator=e[Symbol.iterator](),this.next()}}const Kt=(0,s.getCurrentBrowser)().device===s.CurrentClientDevice.Android,Zt=document.createElement("video"),ei='video/webm; codecs="vp09.00.10.08"',ti='video/webm; codecs="av01.0.00M.08"',ii={mms:Tt(),mse:!!(window.MediaSource&&window.MediaStreamTrack&&window.SourceBuffer?.prototype?.appendBuffer),hls:!(!Zt.canPlayType?.("application/x-mpegurl")&&!Zt.canPlayType?.("vnd.apple.mpegURL")),webrtc:!!window.RTCPeerConnection,ws:!!window.WebSocket},si={mp4:!!Zt.canPlayType?.("video/mp4"),webm:!!Zt.canPlayType?.("video/webm"),cmaf:!0},ai={h264:!!yt()?.isTypeSupported?.('video/mp4; codecs="avc1.42000a,mp4a.40.2"'),h265:!!yt()?.isTypeSupported?.('video/mp4; codecs="hev1.1.6.L93.B0"'),vp9:!!yt()?.isTypeSupported?.(ei),av1:!!yt()?.isTypeSupported?.(ti),aac:!!yt()?.isTypeSupported?.('audio/mp4; codecs="mp4a.40.2"'),opus:!!yt()?.isTypeSupported?.('audio/webm; codecs="opus"')},ri=(ai.h264||ai.h265)&&ai.aac;var ni,oi;let hi;!function(e){e.VP9="vp9",e.AV1="av1",e.NONE="none",e.SMOOTH="smooth",e.POWER_EFFICIENT="power_efficient"}(ni||(ni={})),function(e){e.DASH="dash",e.HLS="hls",e.MPEG="mpeg"}(oi||(oi={}));try{(async()=>{if(!window.navigator.mediaCapabilities)return;const e={type:"media-source",video:{contentType:"video/webm",width:1280,height:720,bitrate:1e6,framerate:30}},[t,i]=await Promise.all([window.navigator.mediaCapabilities.decodingInfo({...e,video:{...e.video,contentType:ti}}),window.navigator.mediaCapabilities.decodingInfo({...e,video:{...e.video,contentType:ei}})]);hi={[o.DASH_WEBM_AV1]:t,[o.DASH_WEBM]:i}})()}catch(n){console.error(n)}const ui=ii.hls&&si.mp4,ci=e=>{const t=o.DASH_WEBM,i=o.DASH_WEBM_AV1;switch(e){case ni.VP9:return[t,i];case ni.AV1:return[i,t];case ni.NONE:return[];case ni.SMOOTH:return hi?hi[i].smooth?[i,t]:hi[t].smooth?[t,i]:[i,t]:[t,i];case ni.POWER_EFFICIENT:return hi?hi[i].powerEfficient?[i,t]:hi[t].powerEfficient?[t,i]:[i,t]:[t,i];default:(0,s.assertNever)(e)}return[t,i]},di=({webmCodec:e,androidPreferredFormat:t})=>{if(Kt)switch(t){case oi.MPEG:return[o.MPEG,...ci(e),o.DASH_SEP,o.DASH_ONDEMAND,o.HLS,o.HLS_ONDEMAND];case oi.HLS:return[o.HLS,o.HLS_ONDEMAND,...ci(e),o.DASH_SEP,o.DASH_ONDEMAND,o.MPEG];case oi.DASH:return[...ci(e),o.DASH_SEP,o.DASH_ONDEMAND,o.HLS,o.HLS_ONDEMAND,o.MPEG]}return[...ci(e),o.DASH_SEP,o.DASH_ONDEMAND,o.HLS,o.HLS_ONDEMAND,o.MPEG]},li=({androidPreferredFormat:e,preferCMAF:t,preferWebRTC:i})=>{const s=t?[o.DASH_LIVE_CMAF,o.DASH_LIVE]:[o.DASH_LIVE,o.DASH_LIVE_CMAF],a=t?[o.HLS_LIVE_CMAF,o.HLS_LIVE]:[o.HLS_LIVE,o.HLS_LIVE_CMAF],r=[...s,...a],n=[...a,...s];let h;if(Kt)switch(e){case oi.DASH:h=r;break;case oi.HLS:case oi.MPEG:h=n}else h=ui?n:r;return i?[o.WEB_RTC_LIVE,...h]:[...h,o.WEB_RTC_LIVE]},pi=e=>e?[o.HLS_LIVE,o.HLS_LIVE_CMAF,o.DASH_LIVE_CMAF]:[o.DASH_WEBM,o.DASH_WEBM_AV1,o.DASH_SEP,o.DASH_ONDEMAND,o.HLS,o.HLS_ONDEMAND,o.MPEG];const mi={chunkDuration:5e3,maxParallelRequests:5};class fi{init(){this.subscription.add(this.initProviderErrorHandling()),this.subscription.add(this.params.dependencies.chromecastInitializer.connection$.subscribe((()=>{this.reinitProvider()})))}destroy(){this.destroyProvider(),this.current$.next({type:void 0}),this.subscription.unsubscribe()}initProvider(){const e=this.chooseDestination(),t=this.chooseFormat(e);if((0,s.isNullable)(t))return void this.handleNoFormatsError(e);let i;try{i=this.createProvider(e,t)}catch(e){this.providerError$.next({id:"ProviderNotConstructed",category:s.ErrorCategory.WTF,message:"Failed to create provider",thrown:e})}i?this.current$.next({type:t,provider:i,destination:e}):this.current$.next({type:void 0})}reinitProvider(){this.destroyProvider(),this.initProvider()}switchToNextProvider(e){this.destroyProvider(),this.failoverIndex=void 0,this.skipFormat(e),this.initProvider()}destroyProvider(){const e=this.current$.getValue().provider;if(!e)return;this.log({message:"destroyProvider"});const t=1e3*this.providerOutput.position$.getValue(),i=this.params.desiredState.seekState.getState(),s=i.state!==d.None;if(this.params.desiredState.seekState.setState({state:d.Requested,position:s?i.position:t,forcePrecise:!!s&&i.forcePrecise}),e.scene3D){const t=e.scene3D.getCameraRotation();this.params.desiredState.cameraOrientation.setState({x:t.x,y:t.y})}e.destroy();const a=this.providerOutput.isBuffering$;a.getValue()||a.next(!0)}createProvider(e,t){switch(this.log({message:`createProvider: ${e}:${t}`}),e){case h.SCREEN:return this.createScreenProvider(t);case h.CHROMECAST:return this.createChromecastProvider(t);default:return(0,s.assertNever)(e)}}createScreenProvider(e){const{sources:t,container:i,desiredState:a}=this.params,r=this.providerOutput,n={container:i,source:null,desiredState:a,output:r,dependencies:this.params.dependencies,tuning:this.params.tuning};switch(e){case o.DASH_SEP:case o.DASH_WEBM:case o.DASH_WEBM_AV1:case o.DASH_ONDEMAND:{const i=this.applyFailoverHost(t[e]),a=this.applyFailoverHost(t[o.HLS_ONDEMAND]||t[o.HLS]);return(0,s.assertNonNullable)(i),new Lt({...n,source:i,sourceHls:a})}case o.DASH_LIVE_CMAF:{const i=this.applyFailoverHost(t[e]);return(0,s.assertNonNullable)(i),new Dt({...n,source:i})}case o.HLS:case o.HLS_ONDEMAND:{const i=this.applyFailoverHost(t[e]);return(0,s.assertNonNullable)(i),ui||!this.params.tuning.useHlsJs?new qt({...n,source:i}):new It({...n,source:i})}case o.HLS_LIVE:case o.HLS_LIVE_CMAF:{const i=this.applyFailoverHost(t[e]);return(0,s.assertNonNullable)(i),new jt({...n,source:i,config:{maxPausedTime:this.params.tuning.live.maxPausedTime},format:e})}case o.MPEG:{const i=this.applyFailoverHost(t[e]);return(0,s.assertNonNullable)(i),new Yt({...n,source:i})}case o.DASH_LIVE:{const i=this.applyFailoverHost(t[e]);return(0,s.assertNonNullable)(i),new oe({...n,source:i,config:{...mi,maxPausedTime:this.params.tuning.live.maxPausedTime}})}case o.WEB_RTC_LIVE:{const n=this.applyFailoverHost(t[e]);return(0,s.assertNonNullable)(n),new Jt({container:i,source:n,desiredState:a,output:r,dependencies:this.params.dependencies,tuning:this.params.tuning})}case o.DASH_LIVE_WEBM:throw new Error("DASH_LIVE_WEBM is no longer supported");default:return(0,s.assertNever)(e)}}createChromecastProvider(e){const{sources:t,container:i,desiredState:a,meta:r}=this.params,n=this.providerOutput,o=this.params.dependencies.chromecastInitializer.connection$.getValue();return(0,s.assertNonNullable)(o),new T({connection:o,meta:r,container:i,source:t,format:e,desiredState:a,output:n,dependencies:this.params.dependencies,tuning:this.params.tuning})}chooseDestination(){return this.params.dependencies.chromecastInitializer.connection$.getValue()?h.CHROMECAST:h.SCREEN}chooseFormat(e){switch(e){case h.SCREEN:return this.screenFormatsIterator.isCompleted()?void 0:this.screenFormatsIterator.getValue();case h.CHROMECAST:return this.chromecastFormatsIterator.isCompleted()?void 0:this.chromecastFormatsIterator.getValue();default:return(0,s.assertNever)(e)}}skipFormat(e){switch(e){case h.SCREEN:return this.screenFormatsIterator.next();case h.CHROMECAST:return this.chromecastFormatsIterator.next();default:return(0,s.assertNever)(e)}}handleNoFormatsError(e){switch(e){case h.SCREEN:return this.noAvailableProvidersError$.next(this.params.tuning.forceFormat),void this.current$.next({type:void 0});case h.CHROMECAST:return void this.params.dependencies.chromecastInitializer.disconnect();default:return(0,s.assertNever)(e)}}applyFailoverHost(e){if(void 0===this.failoverIndex)return e;const t=this.params.failoverHosts[this.failoverIndex];if(!t)return e;const i=e=>{const i=new URL(e);return i.host=t,i.toString()};if(void 0===e)return e;if("type"in e){if("raw"===e.type)return e;if("url"===e.type)return{...e,url:i(e.url)}}return Object.fromEntries(Object.entries(e).map((([e,t])=>[e,i(t)])))}initProviderErrorHandling(){const e=new s.Subscription;let t=!1,i=0;return e.add((0,s.merge)(this.providerOutput.error$,(e=>new s.Observable((t=>{const i=new s.Subscription,a=e.desiredPlaybackState$.stateChangeStarted$.pipe((0,s.map)((({from:e,to:t})=>`${e}-${t}`))),r=e.desiredPlaybackState$.stateChangeEnded$,n=e.providerChanged$.pipe((0,s.map)((({type:e})=>void 0!==e))),o=new s.Subject;let h=0,u="unknown";return i.add(a.subscribe((t=>{h&&window.clearTimeout(h),u=t,h=window.setTimeout((()=>o.next(t)),e.maxTransitionInterval)}))),i.add(r.subscribe((()=>{window.clearTimeout(h),u="unknown",h=0}))),i.add(n.subscribe((t=>{h&&(window.clearTimeout(h),h=0,t&&(h=window.setTimeout((()=>o.next(u)),e.maxTransitionInterval)))}))),i.add(o.subscribe(t)),()=>{window.clearTimeout(h),i.unsubscribe()}})))({desiredPlaybackState$:this.params.desiredState.playbackState,maxTransitionInterval:this.params.tuning.maxPlaybackTransitionInterval,position$:this.providerOutput.position$,providerChanged$:this.current$}).pipe((0,s.map)((e=>({id:`ProviderHangup:${e}`,category:s.ErrorCategory.WTF,message:`A ${e} transition failed to complete within reasonable time`}))))).subscribe(this.providerError$)),e.add(this.current$.subscribe((()=>{t=!1;const i=this.params.desiredState.playbackState.transitionEnded$.pipe((0,s.filter)((({to:e})=>e===r.PLAYING)),(0,s.once)()).subscribe((()=>t=!0));e.add(i)}))),e.add(this.providerError$.subscribe((e=>{const a=this.current$.getValue().destination;if(a===h.CHROMECAST)this.destroyProvider(),this.params.dependencies.chromecastInitializer.stopMedia().then((()=>this.switchToNextProvider(h.SCREEN)),(()=>this.params.dependencies.chromecastInitializer.disconnect()));else{const r=e.category===s.ErrorCategory.NETWORK,n=this.params.failoverHosts.length>0&&(void 0===this.failoverIndex||this.failoverIndex<this.params.failoverHosts.length-1),o=i<this.params.tuning.providerErrorLimit;n&&(r&&t||!o)?(this.failoverIndex=void 0===this.failoverIndex?0:this.failoverIndex+1,this.reinitProvider()):o?(i++,this.reinitProvider()):this.switchToNextProvider(a??h.SCREEN)}}))),e}constructor(e){this.current$=new s.ValueSubject({type:void 0}),this.providerError$=new s.Subject,this.noAvailableProvidersError$=new s.Subject,this.providerOutput={position$:new s.ValueSubject(0),duration$:new s.ValueSubject(1/0),volume$:new s.ValueSubject({muted:!1,volume:1}),currentVideoTrack$:new s.ValueSubject(void 0),availableVideoTracks$:new s.ValueSubject([]),availableAudioTracks$:new s.ValueSubject([]),isAudioAvailable$:new s.ValueSubject(!0),autoVideoTrackLimitingAvailable$:new s.ValueSubject(!1),autoVideoTrackLimits$:new s.ValueSubject(void 0),currentBuffer$:new s.ValueSubject(void 0),isBuffering$:new s.ValueSubject(!0),error$:new s.Subject,warning$:new s.Subject,willSeekEvent$:new s.Subject,seekedEvent$:new s.Subject,loopedEvent$:new s.Subject,endedEvent$:new s.Subject,firstBytesEvent$:new s.Subject,firstFrameEvent$:new s.Subject,canplay$:new s.Subject,isLive$:new s.ValueSubject(void 0),isLowLatency$:new s.ValueSubject(!1),canChangePlaybackSpeed$:new s.ValueSubject(!0),liveTime$:new s.ValueSubject(void 0),liveBufferTime$:new s.ValueSubject(void 0),availableTextTracks$:new s.ValueSubject([]),currentTextTrack$:new s.ValueSubject(void 0),hostname$:new s.ValueSubject(void 0),httpConnectionType$:new s.ValueSubject(void 0),httpConnectionReused$:new s.ValueSubject(void 0),inPiP$:new s.ValueSubject(!1),inFullscreen$:new s.ValueSubject(!1),element$:new s.ValueSubject(void 0),availableSources$:new s.ValueSubject(void 0),is3DVideo$:new s.ValueSubject(!1)},this.subscription=new s.Subscription,this.params=e,this.log=this.params.dependencies.logger.createComponentLog("ProviderContainer");const t=((e,t=!1,i=!1)=>{const a=ii.mse||ii.mms&&i;return e.filter((e=>{switch(e){case o.DASH_SEP:return a&&si.mp4&&ri;case o.DASH_WEBM:return a&&si.webm&&ai.vp9&&ai.opus;case o.DASH_WEBM_AV1:return a&&si.webm&&ai.av1&&ai.opus;case o.DASH_LIVE:return ii.mse&&si.mp4&&ri;case o.DASH_LIVE_CMAF:return a&&si.mp4&&ri&&si.cmaf;case o.DASH_ONDEMAND:return a&&si.mp4&&ri;case o.HLS:case o.HLS_ONDEMAND:return ui||t&&ii.mse&&si.mp4&&ri;case o.HLS_LIVE:case o.HLS_LIVE_CMAF:return ui;case o.MPEG:return si.mp4;case o.DASH_LIVE_WEBM:return!1;case o.WEB_RTC_LIVE:return ii.webrtc&&ii.ws&&ai.h264&&(si.mp4||si.webm);default:return(0,s.assertNever)(e)}}))})([...li(this.params.tuning),...di(this.params.tuning)],this.params.tuning.useHlsJs,this.params.tuning.useManagedMediaSource).filter((t=>(0,s.isNonNullable)(e.sources[t]))),{forceFormat:i,formatsToAvoid:a}=this.params.tuning;let r=[];r=i?[i]:a.length?[...t.filter((e=>!a.includes(e))),...t.filter((e=>a.includes(e)))]:t,this.log({message:`Selected formats: ${r.join(" > ")}`}),this.screenFormatsIterator=new Xt(r);const n=[...pi(!0),...pi(!1)];this.chromecastFormatsIterator=new Xt(n.filter((t=>(0,s.isNonNullable)(e.sources[t])))),this.providerOutput.availableSources$.next(e.sources)}}const gi="one_video_throughput",bi="one_video_rtt",Si=window.navigator.connection,vi=()=>{const e=Si?.downlink;if((0,s.isNonNullable)(e)&&10!==e)return 1e3*e},yi=()=>{const e=Si?.rtt;if((0,s.isNonNullable)(e)&&3e3!==e)return e},Ti=(e,t,i)=>{const s=8*i;return s/(s/e+t)};class Ei{destroy(){this.concurrentDownloads.clear(),this.subscription.unsubscribe()}trackXHR(e){let t=0,i=(0,s.now)();const a=new s.Subscription;switch(this.subscription.add(a),this.concurrentDownloads.add(e),e.readyState){case 4:break;case 3:case 2:a.add((0,s.fromEvent)(e,"progress").pipe((0,s.once)()).subscribe((e=>{t=e.loaded,i=(0,s.now)()})));break;case 1:case 0:a.add((0,s.fromEvent)(e,"loadstart").subscribe((()=>{t=0,i=(0,s.now)()})))}a.add((0,s.fromEvent)(e,"loadend").subscribe((r=>{if(200===e.status){const e=r.loaded,a=(0,s.now)(),n=e-t,o=a-i;this.addRawSpeed(n,o,1)}this.concurrentDownloads.delete(e),a.unsubscribe()})))}trackStream(e,t=!1){const i=e.getReader();if(!i)return void e.cancel("Could not get reader");let a=0,r=(0,s.now)(),n=0,o=(0,s.now)();const h=t=>{this.concurrentDownloads.delete(e),i.releaseLock(),e.cancel(`Throughput Estimator error: ${t}`).catch((()=>{}))},u=async({done:c,value:d})=>{if(c)!t&&this.addRawSpeed(a,(0,s.now)()-r,1),this.concurrentDownloads.delete(e);else if(d){if(t){if((0,s.now)()-o<this.tuningConfig.lowLatency.continuesByteSequenceInterval)n+=d.byteLength;else{const e=o-r;e&&this.addRawSpeed(n,e,1,t),n=d.byteLength,r=(0,s.now)()}o=(0,s.now)()}else a+=d.byteLength,n+=d.byteLength,n>=this.tuningConfig.streamMinSampleSize&&(0,s.now)()-o>=this.tuningConfig.streamMinSampleTime&&(this.addRawSpeed(n,(0,s.now)()-o,this.concurrentDownloads.size),n=0,o=(0,s.now)());await(i?.read().then(u,h))}};this.concurrentDownloads.add(e),i?.read().then(u,h)}addRawSpeed(e,t,i=1,s=!1){if(Ei.sanityCheck(e,t,s)){const s=8*e/t;this.throughput.next(s*i)}}addRawThroughput(e){this.throughput.next(e)}addRawRtt(e){this.rtt.next(e)}static sanityCheck(e,t,i=!1){const s=8*e/t;return!(!s||!isFinite(s)||s>1e6||s<30||i&&e<1e4||!i&&e<10240||!i&&t<=20)}static load(e){const t=s.safeStorage.get(e);if((0,s.isNonNullable)(t))return parseInt(t,10)??void 0}constructor(e){this.subscription=new s.Subscription,this.concurrentDownloads=new Set,this.tuningConfig=e;const t=Ei.load(gi)||(e.useBrowserEstimation?vi():void 0)||5e3,i=Ei.load(bi)??(e.useBrowserEstimation?yi():void 0)??0;if(this.throughput$=new s.ValueSubject(t),this.rtt$=new s.ValueSubject(i),this.rttAdjustedThroughput$=new s.ValueSubject(Ti(t,i,e.rttPenaltyRequestSize)),this.throughput=vt.getSmoothedValue(t,-1,e),this.rtt=vt.getSmoothedValue(i,1,e),e.useBrowserEstimation){const e=()=>{const e=vi();e&&this.throughput.next(e);const t=yi();(0,s.isNonNullable)(t)&&this.rtt.next(t)};Si&&"onchange"in Si&&this.subscription.add((0,s.fromEvent)(Si,"change").subscribe(e)),e()}this.subscription.add(this.throughput.smoothed$.subscribe((e=>{s.safeStorage.set(gi,e.toFixed(0))}))),this.subscription.add(this.rtt.smoothed$.subscribe((e=>{s.safeStorage.set(bi,e.toFixed(0))}))),this.subscription.add(this.throughput.debounced$.subscribe(this.throughput$)),this.subscription.add(this.rtt.debounced$.subscribe(this.rtt$)),this.subscription.add((0,s.combine)({throughput:this.throughput.smoothed$,rtt:this.rtt.smoothed$}).pipe((0,s.map)((({throughput:t,rtt:i})=>Ti(t,i,e.rttPenaltyRequestSize))),(0,s.filter)((t=>{const i=this.rttAdjustedThroughput$.getValue()||0;return Math.abs(t-i)/i>=e.changeThreshold}))).subscribe(this.rttAdjustedThroughput$))}}const wi={configName:["core"],throughputEstimator:{type:"EmaAndMa",emaAlphaSlow:.2,emaAlphaFast:.7,emaAlpha:.45,basisTrendChangeCount:10,changeThreshold:.05,useBrowserEstimation:!0,rttPenaltyRequestSize:1048576,streamMinSampleSize:10240,streamMinSampleTime:300,deviationDepth:20,deviationFactor:.5,lowLatency:{continuesByteSequenceInterval:10}},autoTrackSelection:{bitrateFactorAtEmptyBuffer:1.8,bitrateFactorAtFullBuffer:1.2,usePixelRatio:!0,limitByContainer:!0,containerSizeFactor:2,lazyQualitySwitch:!0,minBufferToSwitchUp:.4,considerPlaybackRate:!1,trackCooldown:3e3,backgroundVideoQualityLimit:s.VideoQuality.Q_4320P,activeVideoAreaThreshold:.1},droppedFramesChecker:{enabled:!1,percentLimit:.1,checkTime:1e3,countLimit:3,tickCountAfterQualityChange:5,qualityUpWaitingTime:5e3,minQualityBanLimit:s.VideoQuality.Q_480P},dash:{forwardBufferTarget:6e4,forwardBufferTargetAuto:6e4,forwardBufferTargetManual:3e5,forwardBufferTargetPreload:5e3,maxSegmentDurationLeftToSelectNextSegment:3e3,minSafeBufferThreshold:.5,bufferPruningSafeZone:1e3,segmentRequestSize:1048576,representationSwitchForwardBufferGap:3e3,enableSubSegmentBufferFeeding:!0,segmentTimelineTolerance:100,useFetchPriorityHints:!0},dashCmafLive:{maxActiveLiveOffset:1e4,normalizedTargetMinBufferSize:6e4,normalizedLiveMinBufferSize:5e3,normalizedActualBufferOffset:1e4,offsetCalculationError:3e3,lowLatency:{maxTargetOffset:3e3,maxTargetOffsetDeviation:500,playbackCatchupSpeedup:.05,isActive:!1,delayEstimator:{emaAlpha:.45,changeThreshold:.05,deviationDepth:20,deviationFactor:.5,extremumInterval:5}}},live:{minBuffer:3e3,minBufferSegments:3,lowLatencyMinBuffer:1e3,lowLatencyMinBufferSegments:1,isLiveCatchUpMode:!1,lowLatencyActiveLiveDelay:3e3,activeLiveDelay:5e3,maxPausedTime:5e3},downloadBackoff:{bufferThreshold:100,start:100,factor:2,max:3e3,random:.1},enableWakeLock:!0,enableTelemetryAtStart:!1,forceFormat:void 0,formatsToAvoid:[],disableChromecast:!1,chromecastReceiverId:void 0,useWebmBigRequest:!1,webmCodec:ni.VP9,androidPreferredFormat:oi.MPEG,preferCMAF:!1,preferWebRTC:!1,bigRequestMinInitSize:51200,bigRequestMinDataSize:1048576,stripRangeHeader:!0,flushShortLoopedBuffers:!0,insufficientBufferRuleMargin:1e4,dashSeekInSegmentDurationThreshold:18e4,dashSeekInSegmentAlwaysSeekDelta:1e4,dashMaxWaitingDuration:5e3,endGapTolerance:300,stallIgnoreThreshold:33,gapWatchdogInterval:50,requestQuick:!1,useHlsJs:!0,useDashAbortPartiallyFedSegment:!1,useNativeHLSTextTracks:!1,useManagedMediaSource:!1,isAudioDisabled:!1,autoplayOnlyInActiveTab:!0,dynamicImportTimeout:5e3,maxPlaybackTransitionInterval:2e4,providerErrorLimit:3,manifestRetryInterval:300,manifestRetryMaxInterval:1e4,manifestRetryMaxCount:10,webrtc:{connectionRetryMaxNumber:3},spherical:{enabled:!1,fov:{x:135,y:76},rotationSpeed:45,maxYawAngle:175,rotationSpeedCorrection:10,degreeToPixelCorrection:5,speedFadeTime:2e3,speedFadeThreshold:50}};var Ai=({seekState:e,position$:t})=>(0,s.merge)(e.stateChangeEnded$.pipe((0,s.map)((({to:e})=>e.state===d.None?void 0:(e.position??NaN)/1e3)),(0,s.filter)(s.isNonNullable)),t.pipe((0,s.filter)((()=>e.getState().state===d.None))));class $i{initVideo(e){return this.config=e,this.domContainer=(e=>{const t="string"==typeof e.container?document.getElementById(e.container):e.container;return(0,s.assertNonNullable)(t,`Wrong container or containerId {${e.container}}`),t})(e),this.chromecastInitializer.contentId=e.meta?.videoId,this.providerContainer=new fi({sources:e.sources,meta:e.meta??{},failoverHosts:e.failoverHosts??[],container:this.domContainer,desiredState:this.desiredState,dependencies:{throughputEstimator:this.throughputEstimator,chromecastInitializer:this.chromecastInitializer,logger:this.logger,abrLogger:this.abrLogger},tuning:this.tuning}),this.initProviderContainerSubscription(this.providerContainer),this.initStartingVideoTrack(this.providerContainer),this.providerContainer.init(),this.setMuted(this.tuning.isAudioDisabled),this.initDebugTelemetry(),this.initWakeLock(),this}destroy(){this.events.willDestruct$.next(),this.stop(),this.providerContainer?.destroy(),this.throughputEstimator.destroy(),this.chromecastInitializer.destroy(),this.subscription.unsubscribe()}prepare(){const e=this.desiredState.playbackState;return e.getState()===r.STOPPED&&e.startTransitionTo(r.READY),this}play(){const e=()=>{const e=this.desiredState.playbackState;e.getState()!==r.PLAYING&&e.startTransitionTo(r.PLAYING)};return document.hidden&&this.tuning.autoplayOnlyInActiveTab?(0,s.fromEvent)(document,"visibilitychange").pipe((0,s.once)()).subscribe(e):e(),this}pause(){const e=this.desiredState.playbackState;return e.getState()!==r.PAUSED&&e.startTransitionTo(r.PAUSED),this}stop(){const e=this.desiredState.playbackState;return e.getState()!==r.STOPPED&&e.startTransitionTo(r.STOPPED),this}seekTime(e,t=!0){const i=this.info.duration$.getValue(),s=this.info.isLive$.getValue();return e>=i&&!s&&(e=i-.1),this.events.willSeek$.next({from:this.getExactTime(),to:e}),this.desiredState.seekState.setState({state:d.Requested,position:1e3*e,forcePrecise:t}),this}seekPercent(e){const t=this.info.duration$.getValue();return isFinite(t)&&this.seekTime(Math.abs(t)*e,!1),this}setVolume(e){const t=this.tuning.isAudioDisabled||this.desiredState.volume.getState().muted;return this.chromecastInitializer.castState$.getValue()===u.CONNECTED?this.chromecastInitializer.setVolume(e):this.desiredState.volume.startTransitionTo({volume:e,muted:t}),this}setMuted(e){const t=this.tuning.isAudioDisabled||e;return this.chromecastInitializer.castState$.getValue()===u.CONNECTED?this.chromecastInitializer.setMuted(t):this.desiredState.volume.startTransitionTo({volume:this.desiredState.volume.getState().volume,muted:t}),this}setQuality(e){(0,s.assertNonNullable)(this.providerContainer);const t=this.providerContainer.providerOutput.availableVideoTracks$.getValue();return void 0===this.desiredState.videoTrack.getState()&&void 0===this.desiredState.videoTrack.getPrevState()&&0===t.length?this.providerContainer.providerOutput.availableVideoTracks$.pipe((0,s.filter)((e=>e.length>0)),(0,s.once)()).subscribe((t=>{this.setVideoTrackIdByQuality(t,e)})):t.length>0&&this.setVideoTrackIdByQuality(t,e),this}setAutoQuality(e){return this.desiredState.autoVideoTrackSwitching.startTransitionTo(e),this}setAutoQualityLimits(e){return this.desiredState.autoVideoTrackLimits.startTransitionTo(e),this}setPlaybackRate(e){(0,s.assertNonNullable)(this.providerContainer);const t=this.providerContainer?.providerOutput.element$.getValue();return t&&(this.desiredState.playbackRate.setState(e),t.playbackRate=e),this}setExternalTextTracks(e){return this.desiredState.externalTextTracks.startTransitionTo(e.map((e=>({type:"external",...e})))),this}selectTextTrack(e){return((e,t,i,a)=>{void 0!==e&&void 0===t.getState()&&void 0===t.getPrevState()&&0===i?.getValue().length?i.pipe((0,s.filter)((e=>e.length>0)),(0,s.once)()).subscribe((i=>{i.find(a)&&t.startTransitionTo(e)})):(void 0===e||i?.getValue().find(a))&&t.startTransitionTo(e)})(e,this.desiredState.currentTextTrack,this.providerContainer?.providerOutput.availableTextTracks$,(t=>t.id===e)),this}setTextTrackCueSettings(e){return this.desiredState.textTrackCuesSettings.startTransitionTo(e),this}setLooped(e){return this.desiredState.isLooped.startTransitionTo(e),this}toggleChromecast(){this.chromecastInitializer.toggleConnection()}startCameraManualRotation(e,t){const i=this.getScene3D();return i&&i.startCameraManualRotation(e,t),this}stopCameraManualRotation(e=!1){const t=this.getScene3D();return t&&t.stopCameraManualRotation(e),this}moveCameraFocusPX(e,t){const i=this.getScene3D();if(i){const s=i.getCameraRotation(),a=i.pixelToDegree({x:e,y:t});this.desiredState.cameraOrientation.setState({x:s.x+a.x,y:s.y+a.y})}return this}holdCamera(){const e=this.getScene3D();return e&&e.holdCamera(),this}releaseCamera(){const e=this.getScene3D();return e&&e.releaseCamera(),this}getExactTime(){if(!this.providerContainer)return 0;const e=this.providerContainer.providerOutput.element$.getValue();if((0,s.isNullable)(e))return this.info.position$.getValue();const t=this.desiredState.seekState.getState(),i=t.state===d.None?void 0:t.position;return(0,s.isNonNullable)(i)?i/1e3:e.currentTime}getAllLogs(){return this.logger.getAllLogs()}getScene3D(){const e=this.providerContainer?.current$.getValue();if(e?.provider?.scene3D)return e.provider.scene3D}setIntrinsicVideoSize(...e){const t={width:e.reduce(((e,{width:t})=>e||t||0),0),height:e.reduce(((e,{height:t})=>e||t||0),0)};t.width&&t.height&&this.info.intrinsicVideoSize$.next({width:t.width,height:t.height})}initDesiredStateSubscriptions(){this.subscription.add((0,s.merge)(this.desiredState.playbackState.stateChangeStarted$,this.desiredState.playbackState.forceChanged$).pipe((0,s.map)((e=>e.to))).subscribe(this.info.playbackState$)).add(this.desiredState.isLooped.stateChangeEnded$.pipe((0,s.map)((e=>e.to))).subscribe(this.info.isLooped$)).add(this.desiredState.playbackRate.stateChangeEnded$.pipe((0,s.map)((e=>e.to))).subscribe(this.info.currentPlaybackRate$)).add(this.desiredState.autoVideoTrackSwitching.stateChangeEnded$.pipe((0,s.map)((e=>e.to))).subscribe(this.info.isAutoQualityEnabled$)).add(this.desiredState.autoVideoTrackLimits.stateChangeEnded$.pipe((0,s.map)((e=>e.to))).subscribe(this.info.autoQualityLimits$)),this.subscription.add(this.desiredState.playbackState.stateChangeStarted$.pipe((0,s.filter)((({from:e})=>e===r.STOPPED)),(0,s.once)()).subscribe((()=>{this.initedAt=(0,s.now)(),this.events.inited$.next()}))).add(this.desiredState.playbackState.stateChangeEnded$.subscribe((e=>{switch(e.to){case r.READY:this.events.ready$.next();break;case r.PLAYING:this.isPlaybackStarted||this.events.started$.next(),this.isPlaybackStarted=!0,this.events.playing$.next();break;case r.PAUSED:this.events.paused$.next();break;case r.STOPPED:this.events.stopped$.next()}}))).add(this.desiredState.playbackState.stateChangeStarted$.subscribe((e=>{switch(e.to){case r.PAUSED:this.events.willPause$.next();break;case r.PLAYING:this.isPlaybackStarted?this.events.willResume$.next():this.events.willStart$.next();break;case r.STOPPED:this.events.willStop$.next()}})))}initProviderContainerSubscription(e){this.subscription.add(e.providerOutput.willSeekEvent$.subscribe((()=>{const e=this.desiredState.seekState.getState();e.state===d.Requested?this.desiredState.seekState.setState({...e,state:d.Applying}):this.events.managedError$.next({id:`WillSeekIn${e.state}`,category:s.ErrorCategory.WTF,message:"Received unexpeceted willSeek$"})}))).add(e.providerOutput.seekedEvent$.subscribe((()=>{this.desiredState.seekState.getState().state===d.Applying&&(this.desiredState.seekState.setState({state:d.None}),this.events.seeked$.next())}))).add(e.current$.pipe((0,s.map)((e=>e.type))).subscribe(this.info.currentFormat$)).add(e.current$.pipe((0,s.map)((e=>e.destination)),(0,s.filterChanged)()).subscribe((()=>{this.isPlaybackStarted=!1}))).add(e.providerOutput.availableVideoTracks$.pipe((0,s.map)((e=>e.map((({quality:e})=>e)).sort(((e,t)=>(0,s.isInvariantQuality)(e)?1:(0,s.isInvariantQuality)(t)?-1:(0,s.isHigher)(t,e)?1:-1))))).subscribe(this.info.availableQualities$)).add(e.providerOutput.availableVideoTracks$.subscribe((e=>{const t={};for(const i of e)i.fps&&(t[i.quality]=i.fps);this.info.availableQualitiesFps$.next(t)}))).add(e.providerOutput.availableAudioTracks$.subscribe(this.info.availableAudioTracks$)).add(e.providerOutput.isAudioAvailable$.subscribe(this.info.isAudioAvailable$)).add(e.providerOutput.currentVideoTrack$.subscribe((e=>{this.info.currentQuality$.next(e?.quality),this.info.videoBitrate$.next(e?.bitrate)}))).add(e.providerOutput.hostname$.pipe((0,s.filterChanged)()).subscribe(this.info.hostname$)).add(e.providerOutput.httpConnectionType$.pipe((0,s.filterChanged)()).subscribe(this.info.httpConnectionType$)).add(e.providerOutput.httpConnectionReused$.pipe((0,s.filterChanged)()).subscribe(this.info.httpConnectionReused$)).add(e.providerOutput.currentTextTrack$.subscribe(this.info.currentTextTrack$)).add(e.providerOutput.availableTextTracks$.subscribe(this.info.availableTextTracks$)).add(e.providerOutput.autoVideoTrackLimitingAvailable$.subscribe(this.info.autoQualityLimitingAvailable$)).add(e.providerOutput.autoVideoTrackLimits$.subscribe((e=>{this.desiredState.autoVideoTrackLimits.setState(e??{})}))).add(e.providerOutput.currentBuffer$.pipe((0,s.map)((e=>e?{start:e.from,end:e.to}:{start:0,end:0}))).subscribe(this.info.currentBuffer$)).add(e.providerOutput.duration$.subscribe(this.info.duration$)).add(e.providerOutput.isBuffering$.subscribe(this.info.isBuffering$)).add(e.providerOutput.isLive$.subscribe(this.info.isLive$)).add(e.providerOutput.canChangePlaybackSpeed$.subscribe(this.info.canChangePlaybackSpeed$)).add(e.providerOutput.liveTime$.subscribe(this.info.liveTime$)).add(e.providerOutput.liveBufferTime$.subscribe(this.info.liveBufferTime$)).add((0,s.combine)({isLive:e.providerOutput.isLive$,isLowLatency:e.providerOutput.isLowLatency$,position:Ai({seekState:this.desiredState.seekState,position$:e.providerOutput.position$})}).pipe((0,s.map)((({isLive:e,position:t,isLowLatency:i})=>{const s=i?this.tuning.live.lowLatencyActiveLiveDelay:this.tuning.live.activeLiveDelay;return e&&Math.abs(t)<s/1e3})),(0,s.filterChanged)(),(0,s.tap)((e=>e&&this.setPlaybackRate(1)))).subscribe(this.info.atLiveEdge$)).add((0,s.combine)({isLive:e.providerOutput.isLive$,position:e.providerOutput.position$,duration:e.providerOutput.duration$}).pipe((0,s.map)((({isLive:e,position:t,duration:i})=>e&&1e3*(Math.abs(i)-Math.abs(t))<this.tuning.live.activeLiveDelay)),(0,s.filterChanged)(),(0,s.tap)((e=>e&&this.setPlaybackRate(1)))).subscribe(this.info.atLiveDurationEdge$)).add(e.providerOutput.volume$.pipe((0,s.map)((e=>e.muted)),(0,s.filterChanged)()).subscribe(this.info.muted$)).add(e.providerOutput.volume$.pipe((0,s.map)((e=>e.volume)),(0,s.filterChanged)()).subscribe(this.info.volume$)).add(Ai({seekState:this.desiredState.seekState,position$:e.providerOutput.position$}).subscribe(this.info.position$)).add((0,s.merge)(e.providerOutput.endedEvent$.pipe((0,s.mapTo)(!0)),e.providerOutput.seekedEvent$.pipe((0,s.mapTo)(!1))).pipe((0,s.filterChanged)()).subscribe(this.info.isEnded$)).add(e.providerOutput.endedEvent$.subscribe(this.events.ended$)).add(e.providerOutput.loopedEvent$.subscribe(this.events.looped$)).add(e.providerError$.subscribe(this.events.managedError$)).add(e.noAvailableProvidersError$.pipe((0,s.map)((e=>({id:e?`No${e}`:"NoProviders",category:s.ErrorCategory.VIDEO_PIPELINE,message:e?`${e} was forced but failed or not available`:"No suitable providers or all providers failed"})))).subscribe(this.events.fatalError$)).add(e.providerOutput.element$.subscribe(this.experimental.element$)).add(e.providerOutput.firstBytesEvent$.pipe((0,s.once)(),(0,s.map)((e=>e??(0,s.now)()-this.initedAt))).subscribe(this.events.firstBytes$)).add(e.providerOutput.firstFrameEvent$.pipe((0,s.once)(),(0,s.map)((()=>(0,s.now)()-this.initedAt))).subscribe(this.events.firstFrame$)).add(e.providerOutput.canplay$.pipe((0,s.once)(),(0,s.map)((()=>(0,s.now)()-this.initedAt))).subscribe(this.events.canplay$)).add(this.throughputEstimator.throughput$.subscribe(this.info.throughputEstimation$)).add(this.throughputEstimator.rtt$.subscribe(this.info.rttEstimation$)).add(e.providerOutput.availableSources$.subscribe(this.info.availableSources$));const t=new s.ValueSubject(!1);this.subscription.add(e.providerOutput.seekedEvent$.subscribe((()=>t.next(!1)))).add(e.providerOutput.willSeekEvent$.subscribe((()=>t.next(!0))));const i=new s.ValueSubject(!0);this.subscription.add(e.current$.subscribe((()=>i.next(!0)))).add(this.desiredState.playbackState.stateChangeEnded$.pipe((0,s.filter)((({to:e})=>e===r.PLAYING)),(0,s.once)()).subscribe((()=>i.next(!1))));let a=0;const n=(0,s.merge)(e.providerOutput.isBuffering$,t,i).pipe((0,s.map)((()=>{const s=e.providerOutput.isBuffering$.getValue(),a=t.getValue()||i.getValue();return s&&!a})),(0,s.filterChanged)());this.subscription.add(n.subscribe((e=>{e?a=window.setTimeout((()=>this.info.isStalled$.next(!0)),this.tuning.stallIgnoreThreshold):(window.clearTimeout(a),this.info.isStalled$.next(!1))}))),this.subscription.add((0,s.merge)(e.providerOutput.canplay$,e.providerOutput.firstFrameEvent$,e.providerOutput.firstBytesEvent$).subscribe((()=>{const t=e.providerOutput.element$.getValue();this.setIntrinsicVideoSize({width:t?.videoWidth,height:t?.videoHeight})}))).add(e.providerOutput.currentVideoTrack$.subscribe((t=>{const i=e.providerOutput.element$.getValue();this.setIntrinsicVideoSize({width:t?.size?.width,height:t?.size?.height},{width:i?.videoWidth,height:i?.videoHeight})}))).add(e.providerOutput.is3DVideo$.subscribe(this.info.is3DVideo$)),this.subscription.add((0,s.merge)(e.providerOutput.inPiP$,e.providerOutput.inFullscreen$,e.providerOutput.element$,this.chromecastInitializer.castState$).subscribe((()=>{const t=e.providerOutput.inPiP$.getValue(),i=e.providerOutput.inFullscreen$.getValue(),s=e.providerOutput.element$.getValue();let a;a=this.chromecastInitializer.castState$.getValue()===u.CONNECTED?l.SECOND_SCREEN:s?t?l.PIP:i?l.FULLSCREEN:l.INLINE:l.NONE,this.info.surface$.getValue()!==a&&this.info.surface$.next(a)})))}initChromecastSubscription(){this.subscription.add(this.chromecastInitializer.castState$.subscribe(this.info.chromecastState$)),this.subscription.add(this.chromecastInitializer.connection$.pipe((0,s.map)((e=>e?.castDevice.friendlyName))).subscribe(this.info.chromecastDeviceName$)),this.subscription.add(this.chromecastInitializer.errorEvent$.subscribe(this.events.managedError$))}initStartingVideoTrack(e){const t=new s.Subscription;this.subscription.add(t),this.subscription.add(e.current$.pipe((0,s.filterChanged)(((e,t)=>e.provider===t.provider))).subscribe((()=>{t.unsubscribe(),t.add(e.providerOutput.availableVideoTracks$.pipe((0,s.filter)((e=>e.length>0)),(0,s.once)()).subscribe((e=>{this.setStartingVideoTrack(e)})))})))}setStartingVideoTrack(e){let t;const i=this.desiredState.videoTrack.getState()?.quality;i&&(t=e.find((({quality:e})=>e===i)),t||this.setAutoQuality(!0)),t||(t=Y(e,{container:this.domContainer.getBoundingClientRect(),throughput:this.throughputEstimator.throughput$.getValue(),tuning:this.tuning.autoTrackSelection,limits:this.desiredState.autoVideoTrackLimits.getState(),playbackRate:this.info.currentPlaybackRate$.getValue(),forwardBufferHealth:0,abrLogger:this.abrLogger})),this.desiredState.videoTrack.startTransitionTo(t),this.info.currentQuality$.next(t.quality),this.info.videoBitrate$.next(t.bitrate)}initLogs(){this.subscription.add((0,s.merge)(this.desiredState.videoTrack.stateChangeStarted$.pipe((0,s.map)((e=>({transition:e,entity:"quality",type:"start"})))),this.desiredState.videoTrack.stateChangeEnded$.pipe((0,s.map)((e=>({transition:e,entity:"quality",type:"end"})))),this.desiredState.autoVideoTrackSwitching.stateChangeStarted$.pipe((0,s.map)((e=>({transition:e,entity:"autoQualityEnabled",type:"start"})))),this.desiredState.autoVideoTrackSwitching.stateChangeEnded$.pipe((0,s.map)((e=>({transition:e,entity:"autoQualityEnabled",type:"end"})))),this.desiredState.seekState.stateChangeStarted$.pipe((0,s.map)((e=>({transition:e,entity:"seekState",type:"start"})))),this.desiredState.seekState.stateChangeEnded$.pipe((0,s.map)((e=>({transition:e,entity:"seekState",type:"end"})))),this.desiredState.playbackState.stateChangeStarted$.pipe((0,s.map)((e=>({transition:e,entity:"playbackState",type:"start"})))),this.desiredState.playbackState.stateChangeEnded$.pipe((0,s.map)((e=>({transition:e,entity:"playbackState",type:"end"}))))).pipe((0,s.map)((e=>({component:"desiredState",message:`[${e.entity} change] ${e.type}: ${JSON.stringify(e.transition)}`})))).subscribe(this.logger.log)),this.subscription.add(this.logger.log$.subscribe(this.events.log$))}initDebugTelemetry(){const e=this.providerContainer?.providerOutput;(0,s.assertNonNullable)(this.providerContainer),(0,s.assertNonNullable)(e),V={},this.experimental.enableDebugTelemetry$.next(this.tuning.enableTelemetryAtStart),[this.experimental.enableDebugTelemetry$.subscribe((e=>(e=>{_=e})(e))),this.providerContainer.current$.subscribe((({type:e})=>F("provider",e))),e.duration$.subscribe((e=>F("duration",e))),e.availableVideoTracks$.pipe((0,s.filter)((e=>!!e.length)),(0,s.once)()).subscribe((e=>F("tracks",e))),this.events.fatalError$.subscribe(new U("fatalError")),this.events.managedError$.subscribe(new U("managedError")),e.position$.subscribe(new U("position")),e.currentVideoTrack$.pipe((0,s.map)((e=>e?.quality))).subscribe(new U("quality")),this.info.currentBuffer$.subscribe(new U("buffer")),e.isBuffering$.subscribe(new U("isBuffering"))].forEach((e=>this.subscription.add(e))),F("codecs",Object.keys(ai).filter((e=>ai[e])))}initWakeLock(){if(!window.navigator.wakeLock||!this.tuning.enableWakeLock)return;let e;const t=()=>{e?.release(),e=void 0},i=async()=>{t(),e=await window.navigator.wakeLock.request("screen").catch((e=>{e instanceof DOMException&&"NotAllowedError"===e.name||this.events.managedError$.next({id:"WakeLock",category:s.ErrorCategory.DOM,message:String(e)})}))};this.subscription.add((0,s.merge)((0,s.fromEvent)(document,"visibilitychange"),(0,s.fromEvent)(document,"fullscreenchange"),this.desiredState.playbackState.stateChangeEnded$).subscribe((()=>{const s="visible"===document.visibilityState,a=this.desiredState.playbackState.getState()===r.PLAYING;s&&a?!!e&&!e?.released||i():t()}))).add(this.events.willDestruct$.subscribe(t))}setVideoTrackIdByQuality(e,t){const i=e.find((e=>e.quality===t));i?this.desiredState.videoTrack.startTransitionTo(i):this.setAutoQuality(!0)}constructor(e={configName:[]}){if(this.subscription=new s.Subscription,this.logger=new s.Logger,this.abrLogger=this.logger.createComponentLog("ABR"),this.isPlaybackStarted=!1,this.desiredState={playbackState:new v(r.STOPPED),seekState:new v({state:d.None}),volume:new v({volume:1,muted:!1}),videoTrack:new v(void 0),autoVideoTrackSwitching:new v(!0),autoVideoTrackLimits:new v({}),isLooped:new v(!1),playbackRate:new v(1),externalTextTracks:new v([]),internalTextTracks:new v([]),currentTextTrack:new v(void 0),textTrackCuesSettings:new v({}),cameraOrientation:new v({x:0,y:0})},this.info={playbackState$:new s.ValueSubject(r.STOPPED),position$:new s.ValueSubject(0),duration$:new s.ValueSubject(1/0),muted$:new s.ValueSubject(!1),volume$:new s.ValueSubject(1),availableQualities$:new s.ValueSubject([]),availableQualitiesFps$:new s.ValueSubject({}),availableAudioTracks$:new s.ValueSubject([]),isAudioAvailable$:new s.ValueSubject(!0),currentQuality$:new s.ValueSubject(void 0),isAutoQualityEnabled$:new s.ValueSubject(!0),autoQualityLimitingAvailable$:new s.ValueSubject(!1),autoQualityLimits$:new s.ValueSubject({}),currentPlaybackRate$:new s.ValueSubject(1),currentBuffer$:new s.ValueSubject({start:0,end:0}),isBuffering$:new s.ValueSubject(!0),isStalled$:new s.ValueSubject(!1),isEnded$:new s.ValueSubject(!1),isLooped$:new s.ValueSubject(!1),isLive$:new s.ValueSubject(void 0),canChangePlaybackSpeed$:new s.ValueSubject(void 0),atLiveEdge$:new s.ValueSubject(void 0),atLiveDurationEdge$:new s.ValueSubject(void 0),liveTime$:new s.ValueSubject(void 0),liveBufferTime$:new s.ValueSubject(void 0),currentFormat$:new s.ValueSubject(void 0),availableTextTracks$:new s.ValueSubject([]),currentTextTrack$:new s.ValueSubject(void 0),throughputEstimation$:new s.ValueSubject(void 0),rttEstimation$:new s.ValueSubject(void 0),videoBitrate$:new s.ValueSubject(void 0),hostname$:new s.ValueSubject(void 0),httpConnectionType$:new s.ValueSubject(void 0),httpConnectionReused$:new s.ValueSubject(void 0),surface$:new s.ValueSubject(l.NONE),chromecastState$:new s.ValueSubject(u.NOT_AVAILABLE),chromecastDeviceName$:new s.ValueSubject(void 0),intrinsicVideoSize$:new s.ValueSubject(void 0),availableSources$:new s.ValueSubject(void 0),is3DVideo$:new s.ValueSubject(!1)},this.events={inited$:new s.Subject,ready$:new s.Subject,started$:new s.Subject,playing$:new s.Subject,paused$:new s.Subject,stopped$:new s.Subject,willStart$:new s.Subject,willResume$:new s.Subject,willPause$:new s.Subject,willStop$:new s.Subject,willDestruct$:new s.Subject,watchCoverageRecord$:new s.Subject,watchCoverageLive$:new s.Subject,managedError$:new s.Subject,fatalError$:new s.Subject,ended$:new s.Subject,looped$:new s.Subject,seeked$:new s.Subject,willSeek$:new s.Subject,firstBytes$:new s.Subject,firstFrame$:new s.Subject,canplay$:new s.Subject,log$:new s.Subject},this.experimental={element$:new s.ValueSubject(void 0),tuningConfigName$:new s.ValueSubject([]),enableDebugTelemetry$:new s.ValueSubject(!1),dumpTelemetry:B},this.initLogs(),this.tuning=(e=>({...(0,s.fillWithDefault)(e,wi),configName:[...e.configName??[],...wi.configName]}))(e),this.experimental.tuningConfigName$.next(this.tuning.configName),this.chromecastInitializer=new p({receiverApplicationId:e.chromecastReceiverId,isDisabled:e.disableChromecast,dependencies:{logger:this.logger}}),this.throughputEstimator=new Ei(this.tuning.throughputEstimator),this.initChromecastSubscription(),this.initDesiredStateSubscriptions(),Proxy&&Reflect)return new Proxy(this,{get:(e,t,i)=>{const a=Reflect.get(e,t,i);return"function"!=typeof a?a:(...i)=>{try{return a.apply(e,i)}catch(e){const a=i.map((e=>JSON.stringify(e,((e,t)=>{const i=typeof t;return["number","string","boolean"].includes(i)?t:null===t?null:`<${i}>`})))),r=`Player.${String(t)}`,n=`Exception calling ${r} (${a.join(", ")})`;throw this.events.fatalError$.next({id:r,category:s.ErrorCategory.WTF,message:n,thrown:e}),e}}}})}}},877741:(e,t,i)=>{i.d(t,{CurrentClientBrowser:()=>S,CurrentClientDevice:()=>y,ErrorCategory:()=>ge,InterfaceLanguage:()=>Pe,Logger:()=>c,Observable:()=>h,Subject:()=>u,Subscription:()=>a,VERSION:()=>s,ValueSubject:()=>W,VideoQuality:()=>I,abortable:()=>b,addScript:()=>f,assertNever:()=>r,assertNonNullable:()=>d,assertNotEmptyArray:()=>m,checkNever:()=>n,cloneDeepWith:()=>z,combine:()=>J,debounce:()=>se,debounceFn:()=>Q,detectEmbed:()=>x,fillWithDefault:()=>Y,filter:()=>re,filterChanged:()=>oe,fromEvent:()=>te,getCurrentBrowser:()=>T,getExponentialDelay:()=>k,getHighestQuality:()=>F,getIOSVersion:()=>w,interval:()=>Z,isHigher:()=>O,isHigherOrEqual:()=>_,isIOS:()=>E,isInvariantQuality:()=>q,isLower:()=>V,isLowerOrEqual:()=>B,isMacLike:()=>A,isMobile:()=>$,isNonNullable:()=>l,isNullable:()=>p,loadVKLangPack:()=>Ae,map:()=>ce,mapTo:()=>le,merge:()=>X,noop:()=>o,now:()=>g,observableFrom:()=>ee,once:()=>pe,safeStorage:()=>N,tap:()=>me,timeCodeToString:()=>G,timeout:()=>K,videoQualityToHeight:()=>j,videoSizeToQuality:()=>H});const s="1.0.33";class a{unsubscribe(){const e=this.subscriptions;this.subscriptions=[],e.forEach((e=>"function"==typeof e?e():e.unsubscribe()))}add(e){return this.subscriptions.push(e),this}constructor(){this.subscriptions=[]}}const r=e=>{throw new Error(`${e} is value of unexpected type`)},n=e=>{},o=()=>{};class h{subscribe(e,t){let i;i=t?"function"==typeof t?{next:t,error:o}:{next:e=>t.next(e),error:e=>t.error?.(e)}:{next:o,error:o};const s="function"==typeof e?{next:t=>{try{e(t)}catch(e){i.next(e)}},error:e=>i.next(e)}:{next:t=>e.next(t),error:t=>e.error?e.error(t):i.next(t)};let n;try{n=this._subscribe(s)}catch(e){s.error?.(e)}return(new a).add((()=>{switch(s.next=o,s.error=o,typeof n){case"function":return void n();case"object":return void n.unsubscribe();case"undefined":return;default:return r(n)}}))}pipe(...e){return e.reduce(((e,t)=>t(e)),this)}_subscribe(e){}constructor(e){e&&(this._subscribe=e)}}class u extends h{next(e){this.subscribers.forEach((t=>t.next(e)))}error(e){this.subscribers.forEach((t=>t.error?.(e)))}_subscribe(e){const t=this.keyCounter++;return this.subscribers.set(t,e),(new a).add((()=>this.subscribers.delete(t)))}constructor(){super(),this.keyCounter=0,this.subscribers=new Map}}class c{createCustomLog(e){return(...t)=>{let i;try{i=e(...t)}catch{i={message:"error in `createCustomLog`",component:"Logger"}}this.log(i)}}createComponentLog(e){return this.createCustomLog((t=>({component:e,...t})))}constructor(){this.log$=new u,this.logs=[],this.log=e=>{const t={...e,timestamp:Date.now()};this.logs.push(t),this.log$.next(t)},this.getAllLogs=()=>this.logs}}function d(e,t='Assertion "value is not nullable" failed'){if(null==e)throw new Error(t)}function l(e){return typeof e<"u"&&null!==e}function p(e){return null==e}function m(e,t){if(!e?.length)throw new Error(t)}const f=(e,t,i)=>new Promise(((s,a)=>{t.addEventListener("abort",(()=>{o(),u.remove()}));const r=()=>{o(),a()},n=()=>{o(),s()},o=()=>{h&&clearTimeout(h),u.removeEventListener("load",n),u.removeEventListener("error",r)};let h;i&&(h=window.setTimeout(r,i));const u=document.createElement("script");u.addEventListener("load",n),u.addEventListener("error",r),u.src=e,document.head.appendChild(u)})),g="function"==typeof window.performance?.now?()=>window.performance.now():()=>Date.now(),b=(e,t)=>async(...i)=>{const s=t(...i);let a,r=e.aborted;for(;!r&&!e.aborted;)try{const e=await s.next(a);r=e.done??!1,a=e.value}catch(e){await s.throw(e)}return a};var S,v,y;(v=S||(S={})).Unknown="Unknown",v.Yandex="Yandex",v.Chrome="Chrome",v.Chromium="Chromium",v.Firefox="Firefox",v.Safari="Safari",v.Opera="Opera",v.Edge="Edge",v.Rest="Rest",function(e){e.Unknown="Unknown",e.Android="Android",e.iPhone="iPhone",e.iPad="iPad",e.iPod="iPod",e.RestMobile="RestMobile",e.Mac="Mac",e.Desktop="Desktop"}(y||(y={}));const T=()=>{const{userAgent:e}=window.navigator,t=/yabrowser/i.test(e)?S.Yandex:void 0,i=/chrome|crios/i.test(e)?S.Chrome:void 0,s=/chromium/i.test(e)?S.Chromium:void 0,a=/firefox|fxios/i.test(e)?S.Firefox:void 0,r=/webkit|safari|khtml/i.test(e)?S.Safari:void 0,n=/opr\//i.test(e)?S.Opera:void 0,o=/edg/i.test(e)?S.Edge:void 0,h=/android/i.test(e)?y.Android:void 0,u=/iphone/i.test(e)?y.iPhone:void 0,c=/ipad/i.test(e)?y.iPad:void 0,d=/ipod/i.test(e)?y.iPod:void 0,l=/mac/i.test(e)?y.Mac:void 0,p=/webOS|BlackBerry|IEMobile|Opera Mini/i.test(e)?y.RestMobile:void 0;return{browser:t||a||n||o||i||s||r||S.Rest,device:h||u||c||d||p||l||y.Desktop}},E=(e=!1)=>{const t=[y.iPhone,y.iPad,y.iPod].includes(T().device);if(!e)return t;const{userAgent:i,maxTouchPoints:s}=window.navigator;return!!(t||/macintosh/i.test(i)&&s>0)},w=()=>{const{userAgent:e}=window.navigator,t=e.match(/Version\/(\d+(\.\d+)?)/i);if(!t)return null;const i=t[1],s=parseFloat(i);return isNaN(s)?null:s},A=()=>[y.Mac,y.iPhone,y.iPad,y.iPod].includes(T().device),$=()=>/Mobile|mini|Fennec|Android|iP(ad|od|hone)/.test(navigator.appVersion??navigator.userAgent)||navigator?.userAgentData?.mobile,k=(e,{start:t=0,factor:i=2,max:s=1/0,min:a=t,random:r=0}={})=>{let n=t;return n*=i**e,n*=Math.random()*r*2-r+1,n=Math.round(n),n=Math.min(n,s),n=Math.max(n,a),n};var P;let C,L;!function(e){e[e.LOCAL_STORAGE=0]="LOCAL_STORAGE",e[e.SESSION_STORAGE=1]="SESSION_STORAGE",e[e.RUNTIME=2]="RUNTIME"}(P||(P={}));const D=`vk-videoplayer-dummy-key-${Math.random()}`,R=()=>{if(void 0!==L)return L;try{localStorage.setItem(D,"test"),localStorage.removeItem(D),L=P.LOCAL_STORAGE}catch(e){if(!(e instanceof DOMException||e instanceof TypeError))throw e;try{sessionStorage.getItem(D),L=P.SESSION_STORAGE}catch(e){if(!(e instanceof DOMException||e instanceof TypeError))throw e;L=P.RUNTIME}}return L===P.RUNTIME&&(C=new Map),L};var N=Object.freeze({__proto__:null,clear:()=>{const e=R();switch(e){case P.LOCAL_STORAGE:return localStorage.clear();case P.SESSION_STORAGE:return sessionStorage.clear();case P.RUNTIME:return C?.clear();default:r(e)}},get:e=>{const t=R();switch(t){case P.LOCAL_STORAGE:return localStorage.getItem(e)??void 0;case P.SESSION_STORAGE:return sessionStorage.getItem(e)??void 0;case P.RUNTIME:return C?.get(e);default:r(t)}},has:e=>{const t=R();switch(t){case P.LOCAL_STORAGE:return e in localStorage;case P.SESSION_STORAGE:return e in sessionStorage;case P.RUNTIME:return C?.has(e)??!1;default:return r(t),!1}},isPersistent:()=>R()===P.LOCAL_STORAGE,remove:e=>{const t=R();switch(t){case P.LOCAL_STORAGE:return localStorage.removeItem(e);case P.SESSION_STORAGE:return sessionStorage.removeItem(e);case P.RUNTIME:return void C?.delete(e);default:r(t)}},set:(e,t)=>{const i=R();switch(i){case P.LOCAL_STORAGE:try{localStorage.setItem(e,t)}catch(e){if(!(e instanceof DOMException))throw e;console.error(e)}break;case P.SESSION_STORAGE:try{sessionStorage.setItem(e,t)}catch(e){if(!(e instanceof DOMException))throw e;console.error(e)}break;case P.RUNTIME:return void C?.set(e,t);default:r(i)}}});const x=()=>{let e,t;try{e=window.self!==window.top}catch(t){t instanceof DOMException&&"SecurityError"===t.name?e=!0:(e=!1,console.error(t))}try{window.location.ancestorOrigins&&(t=window.location.ancestorOrigins[window.location.ancestorOrigins.length-1])}catch(e){console.error(e)}try{!t&&document.referrer&&(t=document.referrer)}catch(e){console.error(e)}return{isEmbed:e,host:t?new URL(t).hostname:void 0}};var I;!function(e){e.INVARIANT="Invariant quality",e.Q_144P="144p",e.Q_240P="240p",e.Q_360P="360p",e.Q_480P="480p",e.Q_720P="720p",e.Q_1080P="1080p",e.Q_1440P="1440p",e.Q_2160P="2160p",e.Q_4320P="4320p"}(I||(I={}));const M={[I.Q_144P]:{width:256,height:144},[I.Q_240P]:{width:428,height:240},[I.Q_360P]:{width:640,height:360},[I.Q_480P]:{width:856,height:480},[I.Q_720P]:{width:1280,height:720},[I.Q_1080P]:{width:1920,height:1080},[I.Q_1440P]:{width:2560,height:1440},[I.Q_2160P]:{width:3840,height:2160},[I.Q_4320P]:{width:7680,height:4320}},O=(e,t)=>M[e].height>M[t].height,_=(e,t)=>M[e].height>=M[t].height,V=(e,t)=>M[e].height<M[t].height,B=(e,t)=>M[e].height<=M[t].height,F=e=>e.sort(((e,t)=>e===t?0:e===I.INVARIANT?1:t===I.INVARIANT?-1:V(e,t)?1:-1))[0],U=Object.keys(M).sort(((e,t)=>V(e,t)?-1:1)),H=({width:e,height:t})=>{const i=Math.min(e,t),s=Math.max(e,t);return U.find((e=>{const t=M[e];return t.width>=s&&t.height>=i}))},j=e=>M[e].height,q=e=>e===I.INVARIANT;const Y=(e,t)=>{const i={};for(const s of Object.keys(t)){const a=t[s],r=e[s];Array.isArray(a)&&Array.isArray(r)?i[s]=r:i[s]="object"==typeof a&&"object"==typeof r?Y(r,a):s in e?r:a}return i},G=e=>{let t="";return e>=3600&&(t+=Math.floor(e/3600)+"h",e%=3600),e>=60&&(t+=Math.floor(e/60)+"m",e%=60),e>0&&(t+=Math.floor(e)+"s"),t};function Q(e,t=0,i){let s,a,r,n,o,h,u=0,c=!1,d=!1,l=!0;const p=!t&&0!==t&&"function"==typeof window.requestAnimationFrame;function m(t){const i=s,r=a;return s=a=void 0,u=t,n=e.apply(r,i),n}function f(e,t){return p?(o&&window.cancelAnimationFrame(o),window.requestAnimationFrame(e)):setTimeout(e,t)}function g(e){const i=e-h;return void 0===h||i>=t||i<0||d&&e-u>=r}function b(){const e=Date.now();if(g(e))return S(e);o=f(b,function(e){const i=e-u,s=t-(e-h);return d?Math.min(s,r-i):s}(e))}function S(e){return o=void 0,l&&s?m(e):(s=a=void 0,n)}function v(...e){const i=Date.now(),r=g(i);if(s=e,a=this,h=i,r){if(void 0===o)return function(e){return u=e,o=f(b,t),c?m(e):n}(h);if(d)return o=f(b,t),m(h)}return void 0===o&&(o=f(b,t)),n}return i&&(c=!!i.leading,d="maxWait"in i,r=i?.maxWait?Math.max(+i?.maxWait||0,t):r,l="trailing"in i?!!i.trailing:l),v.cancel=function(){var e;void 0!==o&&(e=o,p?window.cancelAnimationFrame(e):clearTimeout(e)),u=0,s=h=a=o=void 0},v.flush=function(){return void 0===o?n:S(Date.now())},v.pending=function(){return void 0!==o},v}const z=(e,t)=>{if(null===e||"object"!=typeof e)return e;const i=Array.isArray(e)?[]:{};for(const s in e){if("function"==typeof t){const a=t(e[s],s,e,i);if(void 0!==a){i[s]=a;continue}}"object"==typeof e[s]?i[s]=z(e[s],t):i[s]=e[s]}return i};class W extends u{next(e){super.next(this.value=e)}error(e){super.error(this.value=e)}getValue(){return this.value}_subscribe(e){const t=super._subscribe(e);return e.next(this.value),t}constructor(e){super(),this.value=e}}function J(e){return new h((t=>{const i={};let s=Object.keys(e).length;return Object.entries(e).reduce(((e,[a,r])=>e.add(r.subscribe((e=>a=>{e in i||s--,i[e]=a,0===s&&t.next(i)})(a)))),new a)}))}function X(...e){return new h((t=>e.reduce(((e,i)=>e.add(i.subscribe(t))),new a)))}var K=e=>new h((t=>{const i=window.setTimeout((()=>{try{t.next()}catch(e){if(!t.error)throw e;t.error(e)}}),e);return()=>window.clearTimeout(i)})),Z=e=>new h((t=>{const i=window.setInterval((()=>t.next()),e);return()=>window.clearInterval(i)})),ee=e=>new h((t=>{e.forEach((e=>t.next(e)))})),te=(e,t)=>new h((i=>{const s=e=>i.next(e);return e.addEventListener(t,s),()=>e.removeEventListener(t,s)}));const ie={leading:!1,trailing:!0};function se(e,t=ie){return i=>new h((s=>i.subscribe(new ae(s,e,t))))}class ae{next(e){this.lastValue=e,l(this.timeout)?window.clearTimeout(this.timeout):this.config.leading&&this.destination.next(e),this.timeout=window.setTimeout((()=>{if(this.config.trailing)try{this.destination.next(this.lastValue)}catch(e){if(!this.destination.error)throw e;this.destination.error(e)}this.timeout=void 0}),this.time)}error(e){this.destination.error?.(e)}constructor(e,t,i){this.destination=e,this.time=t,this.config=i}}function re(e){return t=>new h((i=>t.subscribe(new ne(i,e))))}class ne{next(e){let t;try{t=this.predicate(e)}catch(e){throw this.error(e),e}t&&this.destination.next(e)}error(e){this.destination.error?.(e)}constructor(e,t){this.destination=e,this.predicate=t}}function oe(e=((e,t)=>e===t)){return t=>new h((i=>t.subscribe(new ue(i,e))))}const he={};class ue{next(e){let t;try{t=this.lastValue===he||!this.predicate(this.lastValue,e),this.lastValue=e}catch(e){throw this.error(e),e}t&&this.destination.next(e)}error(e){this.destination.error?.(e)}constructor(e,t){this.lastValue=he,this.destination=e,this.predicate=t}}function ce(e){return t=>new h((i=>t.subscribe(new de(i,e))))}let de=class{next(e){let t;try{t=this.mapper(e)}catch(e){throw this.error(e),e}this.destination.next(t)}error(e){this.destination.error?.(e)}constructor(e,t){this.destination=e,this.mapper=t}};function le(e){return ce((()=>e))}function pe(){return e=>new h((t=>{let i=!1,s=!1;const a=e.subscribe((e=>{i||(i=!0,t.next(e)),s&&a.unsubscribe()}),(e=>{i=!0,t.error?.(e),s&&a.unsubscribe()}));return s=!0,i&&a.unsubscribe(),a}))}function me(e){return t=>new h((i=>t.subscribe(new fe(i,e))))}class fe{next(e){try{this.effect(e)}catch(e){throw this.error(e),e}this.destination.next(e)}error(e){this.destination.error?.(e)}constructor(e,t){this.destination=e,this.effect=t}}var ge;!function(e){e.NETWORK="network",e.VIDEO_PIPELINE="video_pipeline",e.EXTERNAL_API="external_api",e.PARSER="parser",e.DOM="dom",e.WTF="wtf"}(ge||(ge={}));class be{addEventListener(e,t,i){e in this.listeners||(this.listeners[e]=[]),this.listeners[e].push({callback:t,options:i})}removeEventListener(e,t){if(!(e in this.listeners))return;const i=this.listeners[e];for(let e=0,s=i.length;e<s;e++)if(i[e].callback===t)return void i.splice(e,1)}dispatchEvent(e){if(!(e.type in this.listeners))return;const t=this.listeners[e.type].slice();for(let i=0,s=t.length;i<s;i++){const s=t[i];try{s.callback.call(this,e)}catch(e){Promise.resolve().then((()=>{throw e}))}s.options&&s.options.once&&this.removeEventListener(e.type,s.callback)}return!e.defaultPrevented}constructor(){Object.defineProperty(this,"listeners",{value:{},writable:!0,configurable:!0})}}class Se extends be{toString(){return"[object AbortSignal]"}dispatchEvent(e){"abort"===e.type&&(this.aborted=!0,"function"==typeof this.onabort&&this.onabort.call(this,e)),super.dispatchEvent(e)}constructor(){super(),this.listeners||be.call(this),Object.defineProperty(this,"aborted",{value:!1,writable:!0,configurable:!0}),Object.defineProperty(this,"onabort",{value:null,writable:!0,configurable:!0}),Object.defineProperty(this,"reason",{value:void 0,writable:!0,configurable:!0})}}function ve(e){return e.__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL?(console.log("__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL=true is set, will force install polyfill"),!0):"function"==typeof e.Request&&!e.Request.prototype.hasOwnProperty("signal")||!e.AbortController}typeof Symbol<"u"&&Symbol.toStringTag&&(class{abort(e){let t;try{t=new Event("abort")}catch{typeof document<"u"?document.createEvent?(t=document.createEvent("Event"),t.initEvent("abort",!1,!1)):(t=document.createEventObject(),t.type="abort"):t={type:"abort",bubbles:!1,cancelable:!1}}let i=e;if(void 0===i)if(typeof document>"u")i=new Error("This operation was aborted"),i.name="AbortError";else try{i=new DOMException("signal is aborted without reason")}catch{i=new Error("This operation was aborted"),i.name="AbortError"}this.signal.reason=i,this.signal.dispatchEvent(t)}toString(){return"[object AbortController]"}constructor(){Object.defineProperty(this,"signal",{value:new Se,writable:!0,configurable:!0})}}.prototype[Symbol.toStringTag]="AbortController",Se.prototype[Symbol.toStringTag]="AbortSignal");const ye=ve({fetch:window.fetch,Request:window.Request,AbortController:window.AbortController}),Te=ye?function(e){"function"==typeof e&&(e={fetch:e});const{fetch:t,Request:i=t.Request,AbortController:s,__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL:a=!1}=e;if(!ve({fetch:t,Request:i,AbortController:s,__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL:a}))return{fetch:t,Request:r};let r=i;(r&&!r.prototype.hasOwnProperty("signal")||a)&&(r=function(e,t){let s;t&&t.signal&&(s=t.signal,delete t.signal);const a=new i(e,t);return s&&Object.defineProperty(a,"signal",{writable:!1,enumerable:!1,configurable:!0,value:s}),a},r.prototype=i.prototype);const n=t;return{fetch:(e,t)=>{const i=r&&r.prototype.isPrototypeOf(e)?e.signal:t?t.signal:void 0;if(i){let s;try{s=new DOMException("Aborted","AbortError")}catch{s=new Error("Aborted"),s.name="AbortError"}if(i.aborted)return Promise.reject(s);const a=new Promise(((e,t)=>{i.addEventListener("abort",(()=>t(s)),{once:!0})}));return t&&t.signal&&delete t.signal,Promise.race([a,n(e,t)])}return n(e,t)},Request:r}}({fetch:window.fetch,Request:window.Request,AbortController:window.AbortController}):void 0,Ee=ye?Te.fetch:window.fetch;var we;ye?Te.Request:window.Request,function(e){e.Armenian="58",e.Azerbaijani="57",e.Belarusian="114",e.English="3",e.Kazakh="97",e.Portuguese="73",e.Russian="0",e.Spanish="4",e.Ukrainian="1",e.Uzbek="65",e.Vietnamese="75"}(we||(we={}));const Ae=async(e,t,i)=>{const s=new URL("https://vk.com/js/lang-pack.js");s.searchParams.set("format","json"),s.searchParams.set("name",t),void 0!==e&&s.searchParams.set("lang",e);const a=await(await Ee(s.toString())).json();return $e(a,i)},$e=(e,t)=>Object.fromEntries(Object.entries(e.keys).map((([e,i])=>[e.substring(`${t}_`.length),ke(i)]))),ke=e=>Array.isArray(e)?e[0]:e;var Pe;!function(e){e.RU="ru",e.EN="en"}(Pe||(Pe={}))}}]);try{stManager.done("dist/web/chunks/f35f5b7b.c7d709bb.js")}catch(e){}