"use strict";(self.webpackChunkvkweb=self.webpackChunkvkweb||[]).push([[61522],{644606:(e,t,o)=>{o.d(t,{photos:()=>P});var s=o(70689),i=o(15042),a=o(902947),r=o(97875),n=o(740685),l=o(330),d=o(251087),h=o(93367),c=o(636322),u=o(255693),p=o(488844),g=o(159663),_=o(90625),m=o(65718),f=o(261712),v=o(877926),w=o(734009),C=o(769451),b=o(206082),E=o(800921),T=o(618418);const P={LOAD_TYPE_PHOTOS:"photos",LOAD_TYPE_ALBUMS:"albums",LOAD_TYPE_TAGGED:"tagged",MAX_DESC_INPUT_HEIGHT:600,changeAlbumPhoto(e){(0,g.showBox)("al_photos.php",{act:"change_thumb_box",album:e})},onMouseOverEditRow(e){const t=(0,s.geByClass1)("photos_photo_edit_row_desc_placeholder",e),o=(0,s.geByClass1)("photos_photo_edit_row_desc_input",e);(0,s.setTitle)(t,!1,(0,s.val)(o))},editInitSorter(){const e=(0,s.ge)("photos_container_photos");cur.photosEditSorter=new GridSorter(e,"photos_photo_edit_row_thumb",{onReorder:P.reorderPhotos})},updateEditHeaderPos(){void 0===cur.photosEditHeaderEl&&(cur.photosEditHeaderEl=(0,s.geByClass1)("photos_edit_selection_header")),cur.photosEditHeaderEl&&(cur.photosEditHeaderElOffset=cur.photosEditHeaderElOffset||(0,s.getXY)(cur.photosEditHeaderEl)[1]-(0,s.getSize)((0,s.ge)("page_header_cont"))[1],(0,u.scrollGetY)()>=cur.photosEditHeaderElOffset?(0,s.hasClass)(cur.photosEditHeaderEl,"photos_header_fixed")||((0,s.addClass)(cur.photosEditHeaderEl,"photos_header_fixed"),(0,s.setStyle)(cur.photosEditHeaderEl,{width:(0,s.getSize)((0,s.ge)("page_body"))[0]}),(0,s.setStyle)((0,s.domNS)(cur.photosEditHeaderEl),{"margin-top":(0,s.getSize)(cur.photosEditHeaderEl)[1]+"px"})):((0,s.removeClass)(cur.photosEditHeaderEl,"photos_header_fixed"),(0,s.setStyle)(cur.photosEditHeaderEl,{width:""}),(0,s.setStyle)((0,s.domNS)(cur.photosEditHeaderEl),{"margin-top":0})))},_editGetSelectedCount(){let e=(0,s.geByClass)("photos_edit_selected").length;if(cur.photoEditSelectedAll){const t=(0,s.geByClass)("photos_photo_edit_row").length;e=e<t?cur.count-t+e:cur.count}return e},editSelectAll(e){cur.photoEditSelectedAll=!e,(0,c.each)((0,s.geByClass)("photos_photo_edit_row"),(function(){(0,s.toggleClass)(this,"photos_edit_selected",cur.photoEditSelectedAll)})),P._editUpdateSelectedCounter()},_editUpdateSelectedCounter(){let e;const t=P._editGetSelectedCount();e=t?v.getLang("photos_edit_selected_count").replace("{total}",cur.count).replace("{count}",t):(0,v.langNumeric)(cur.count,v.curLang("photos_edit_selected_count_initial"),!0),(0,s.val)((0,s.ge)("photos_edit_selected_label"),e);const o=(0,s.ge)("photos_edit_selected_actions");(0,s.toggleClass)(o,"photos_selected",!!t),(0,s.geByClass)("photos_edit_selected_action",o).forEach((function(e){(0,s.toggleClass)(e,"link_lock",!t)}));const i=(0,s.ge)("photos_select_all_toggle");cur.photosEditSelectedHalf=t>=cur.count/2,cur.photosEditSelectedHalf?(0,s.val)(i,v.getLang("photos_edit_deselect_all")):(0,s.val)(i,v.getLang("photos_edit_select_all"))},selectEditPhoto(e,t){const o=(0,s.gpeByClass)("photos_photo_edit_row",t),i=(0,s.toggleClass)(o,"photos_edit_selected");if(e.shiftKey&&cur.photoEditPrevSelectedRowEl&&cur.photoEditPrevSelectedRowEl!=o){const e=(0,s.gpeByClass)("photos_edit_photos_container",t);let a=(0,s.domFC)(e),r=0;for(;r<2&&a;)a!=cur.photoEditPrevSelectedRowEl&&a!=o||r++,r&&(0,s.toggleClass)(a,"photos_edit_selected",i),a=(0,s.domNS)(a)}return cur.photoEditPrevSelectedRowEl=o,P._editUpdateSelectedCounter(),(0,h.cancelEvent)(e),!1},startEditPhotoDescription(e,t){P.stopEditPhotoDescription();const o=(0,s.gpeByClass)("photos_edit_photos_container",t),a=(0,s.hasClass)(t,"photos_photo_edit_row")?t:(0,s.gpeByClass)("photos_photo_edit_row",t),r=(0,s.geByClass1)("photos_photo_edit_row_desc_cont",a),n=(0,s.geByClass1)("photos_photo_edit_row_desc_placeholder",a),l=(0,s.geByClass1)("photos_photo_edit_row_desc_input",a);function d(e,t,o,a){const r=(0,c.clean)((0,s.val)(o)).split("\n").join("<br>")+"&nbsp;",n=(0,s.ce)("div",{innerHTML:r,className:"photos_photo_edit_row_desc_input"},{width:(0,s.getSize)(t)[0],display:"block",visibility:"hidden"});e.appendChild(n);const l=(0,s.getSize)(n)[1]+(i.browser.msie?10:0);(0,s.setStyle)(o,{height:Math.min(P.MAX_DESC_INPUT_HEIGHT,Math.round(l))}),(0,s.re)(n)}(0,s.val)(l,l.getAttribute("data-orig-desc")),d(r,n,l),(0,s.show)(l),(0,h.addEvent)(document,"click",P.stopEditPhotoDescription),(0,h.removeEvent)(l,"input"),(0,h.addEvent)(l,"input",d.pbind(r,n,l)),l.select(),(0,s.addClass)(o,"photos_desc_editing"),(0,s.addClass)(a,"photos_row_desc_editing"),e&&(0,h.cancelEvent)(e)},onEditPhotoDescriptionKeyPress(e){switch(e.keyCode){case 27:P.stopEditPhotoDescription(null,!0);break;case 9:P.stopEditPhotoDescription(null,!1);let t=(0,s.gpeByClass)("photos_photo_edit_row",e.currentTarget);t=(0,s.domNS)(t),t&&P.startEditPhotoDescription(null,t),(0,h.cancelEvent)(e)}},stopEditPhotoDescription(e,t){if(e&&(0,s.hasClass)(e.target,"photos_photo_edit_row_desc_input"))return;const o=Boolean(document.getElementById("photos_add_list"));let i;(0,h.removeEvent)(document,"click",P.stopEditPhotoDescription),(0,c.each)((0,s.geByClass)("photos_row_desc_editing"),(function(){i=this,(0,s.removeClass)(i,"photos_row_desc_editing");const e=(0,s.geByClass1)("photos_photo_edit_row_desc_placeholder",i),a=(0,s.geByClass1)("photos_photo_edit_row_desc_input",i),r=i.getAttribute("data-id"),n=i.getAttribute("data-edit-hash");let l="";if(t)l=a.getAttribute("data-orig-desc");else{l=(0,c.trim)((0,s.val)(a));if(l!=a.getAttribute("data-orig-desc")){const e={act:"save_desc",photo:r,hash:n,text:l,edit:1};o&&(e.stat_ref="save_description_upload_photo"),ajax.post("al_photos.php",e,{})}a.setAttribute("data-orig-desc",l),e.titleSet=!1}(0,s.val)(e,(0,c.clean)(l)||v.getLang("photos_add_description_placeholder")),(0,s.toggleClass)(e,"photos_edit_has_desc",!!l),(0,s.hide)(a)})),(0,s.removeClass)((0,s.gpeByClass)("photos_edit_photos_container",i),"photos_desc_editing")},updatePeriods(){cur.periods=(0,s.geByClass)("photos_period_delimiter",(0,s.ge)("photos_all_block"))},destroyPeriod(){cur.fixedPeriod&&((0,s.re)(cur.fixedPeriod),cur.fixedPeriod=!1,cur.fixedPeriodEl=!1)},fixPeriod(){if((0,s.ge)("photos_albums_block")&&(P.headerHeight=P.headerHeight||(0,s.getSize)((0,s.ge)("page_header_cont"))[1],cur.periods&&cur.periods.length)){const e=vk.staticheader?Math.max((0,u.scrollGetY)(),P.headerHeight):(0,u.scrollGetY)()+P.headerHeight;let t=!1,o=!1;const i=(0,s.getSize)(cur.periods[0])[1];for(let i in cur.periods)if(cur.periods.hasOwnProperty(i)){if((0,s.getXY)(cur.periods[i])[1]>=e)break;t=cur.periods[i];const a=(0,c.intval)(i)+1;o=!!cur.periods[a]&&(0,s.getXY)(cur.periods[a])[1]-e}if(t&&!cur.fileApiUploadStarted){if(t==cur.fixedPeriodEl)setTimeout((function(){(0,s.setStyle)(cur.fixedPeriod,{left:(0,s.getXY)(t)[0]+"px"})}));else{if(cur.fixedPeriod)cur.fixedPeriod.innerHTML=t.innerHTML;else{const e=cur.fixedPeriod=(0,s.ce)("div",{innerHTML:t.innerHTML,className:"photos_period_delimiter_fixed"},{left:(0,s.getXY)(t)[0]+"px"});(0,s.ge)("page_body").appendChild(cur.fixedPeriod),(cur._back?cur._back.hide:cur.destroy).push((function(){(0,s.re)(e)}))}cur.fixedPeriodEl=t}let e=!1!==o?o-i:0;e>=0&&(e=0),cur.fixedPeriodTop!==e&&((0,s.setStyle)(cur.fixedPeriod,{top:e+"px"}),cur.fixedPeriodTop=e)}else!t&&cur.fixedPeriod&&((0,s.re)(cur.fixedPeriod),cur.fixedPeriod=!1,cur.fixedPeriodEl=!1)}},scrollResize(){if(i.browser.mobile||cur.pvShown)return;const e=document.documentElement,t=window.innerHeight||e.clientHeight||document.body.clientHeight,o=(0,u.scrollGetY)(),a=(0,s.ge)("ui_photos_load_more"),r=(0,s.ge)("ui_albums_load_more"),n=(0,s.ge)("ui_tagged_load_more"),l=.8*t;(0,s.isVisible)(a)&&a.offsetTop-(o+t)<l&&P.load(),(0,s.isVisible)(r)&&cur.showAllAlbums&&r.offsetTop-(o+t)<l&&P.load(P.LOAD_TYPE_ALBUMS),(0,s.isVisible)(n)&&cur.showAllTagged&&n.offsetTop-(o+t)<l&&P.load(P.LOAD_TYPE_TAGGED),cur.fixPeriods&&P.fixPeriod(),P.updateEditHeaderPos()},initScroll(){cur.module="photos",P.scrollnode=window,(0,h.addEvent)(P.scrollnode,"scroll",P.scrollResize),(0,h.addEvent)(window,"resize",P.scrollResize),(0,h.removeEvent)(window,"load",P.initScroll),cur.destroy.push((function(){(0,h.removeEvent)(P.scrollnode,"scroll",P.scrollResize),(0,h.removeEvent)(window,"resize",P.scrollResize)}))},recache(e,t){if(cur.loading)return cur.loading=1,void setTimeout(P.recache.pbind(e,t),100);for(let e=cur.offset;ajaxCache["/"+nav.objLoc[0]+"#act="+nav.objLoc.act+"&offset="+e+"&part=1"];e+=20){const o=ajaxCache["/"+nav.objLoc[0]+"#act="+nav.objLoc.act+"&offset="+e+"&part=1"];o[0]+=t,ajaxCache["/"+nav.objLoc[0]+"#act="+nav.objLoc.act+"&offset="+(e+t)+"&part=1"]=o,delete ajaxCache["/"+nav.objLoc[0]+"#act="+nav.objLoc.act+"&offset="+e+"&part=1"]}cur.offset+=t},loaded(e,t,o,i){let a,r,n,l,d,h;switch(i||(cur.loading=0),i=i||P.LOAD_TYPE_PHOTOS){case P.LOAD_TYPE_TAGGED:cur.taggedOffset=e,n=cur.moreFromTagged,d=cur.moreTaggedOpts,l=cur.taggedOffset;break;case P.LOAD_TYPE_ALBUMS:cur.albumsOffset=e,n=cur.moreFromAlbums,d=cur.moreAlbumsOpts,l=cur.albumsOffset,h=cur.albumsCount;break;default:cur.offset=e,n=cur.moreFrom,d=cur.moreOpts,l=cur.offset,h=cur.count}a=(0,s.ge)("photos_container_"+i),r=(0,s.ge)("ui_"+i+"_load_more");const u=(0,s.ce)("div",{innerHTML:(0,c.trim)(t)});for(;u.firstChild;){if((0,s.hasClass)(u.firstChild,"photos_period_delimiter")){const e=u.firstChild.getAttribute("data-year");if((0,s.geByClass1)("photos_period_delimiter_"+e)){(0,s.re)(u.firstChild);continue}}cur.photoEditSelectedAll&&(0,s.addClass)(u.firstChild,"photos_edit_selected"),a.appendChild(u.firstChild)}o&&(0,c.extend)(cur.privacy,o),i==P.LOAD_TYPE_PHOTOS&&P.updatePeriods(),e>=h||!t?(0,s.hide)(r):i!=P.LOAD_TYPE_PHOTOS&&(cur.loading=1,ajax.post(n,(0,c.extend)({offset:l,part:1},d||{}),{cache:1,onDone:function(){2==cur.loading?P.loaded.apply(window,arguments):cur.loading=!1},onFail:function(){return cur.loading=0,!0}}))},load(e){let t,o,i,a;switch(e=e||P.LOAD_TYPE_PHOTOS){case P.LOAD_TYPE_PHOTOS:t=(0,s.ge)("ui_photos_load_more"),o=cur.moreFrom,i=cur.moreOpts,a=cur.offset;break;case P.LOAD_TYPE_TAGGED:t=(0,s.ge)("ui_tagged_load_more"),o=cur.moreFromTagged,i=cur.moreTaggedOpts,a=cur.taggedOffset;break;case P.LOAD_TYPE_ALBUMS:t=(0,s.ge)("ui_albums_load_more"),o=cur.moreFromAlbums,i=cur.moreAlbumsOpts,a=cur.albumsOffset}o&&(0,s.isVisible)(t)&&!(0,p.isButtonLocked)(t)&&(cur.loading?cur.loading=2:(e==P.LOAD_TYPE_PHOTOS&&i&&(cur.loading=1),ajax.post(o,(0,c.extend)({offset:a,part:1},i||{}),{onDone:P.loaded,onFail:function(){return cur.loading=0,!0},showProgress:function(){(0,p.lockButton)(t)},hideProgress:function(){(0,p.unlockButton)(t)},cache:1})))},loadMoreButtonClick(e){switch(e){case P.LOAD_TYPE_ALBUMS:cur.showAllAlbums=!0;break;case P.LOAD_TYPE_TAGGED:cur.showAllTagged=!0}this.load(e)},reorderAlbums(e,t,o){const s=e.id.replace("album",""),i=(t&&t.id||"").replace("album",""),a=(o&&o.id||"").replace("album","");ajax.post("al_photos.php",{act:"reorder_albums",album:s,before:i,after:a,hash:cur.reorderHash})},reorderPhotos(e,t,o){const i="edit"==nav.objLoc.act?"photo_edit_row_":"photo_row_",a=e.id.replace(i,""),r=(t&&t.id||"").replace(i,""),n=(o&&o.id||"").replace(i,"");let l=(0,s.domData)((0,s.ge)("photos_container_photos"),"rev");l=l?"1"===l?1:"":nav.objLoc.rev,ajax.post("al_photos.php",{act:"reorder_photos",photo:a,before:r,after:n,rev:l,hash:cur.reorderHash})},privacy(e){if("photos_move"==e){let t=Privacy.getValue(e);return t=t.split("_"),t=t[2],t!=cur.album.split("_")[1]&&P.movePhoto(t),!0}const t=e.match(/^album(\d+)/);if(!t)return;const o=(0,s.ge)("album"+vk.id+"_"+t[1]);if(o){if(o.helper){const e=(0,s.getSize)(o);if(e[0]!=o.w||e[1]!=o.h){(0,s.setStyle)(o.helper,{width:e[0],height:e[1]-(0,s.ge)("photos_container").sorter.dh}),(0,c.extend)(o,{x:o.x-o.w/2+e[0]/2,w:e[0],y:o.y-o.h/2+e[1]/2,h:e[1]});for(let e=o.nextSibling;e&&e.nextSibling;e=e.nextSibling.nextSibling)(0,s.setStyle)(e.nextSibling,{left:e.offsetLeft,top:e.offsetTop})}}clearTimeout(cur["privacy_timer_"+e]),cur["privacy_timer_"+e]=setTimeout(ajax.post.pbind("al_friends.php",{act:"save_privacy",key:e,val:Privacy.getValue(e),hash:cur.privacyHash}),500)}},deleteAlbum(e,t){(0,g.showFastBox)({title:v.getLang("photos_deleting_album"),bodyStyle:"padding: 20px;"},v.getLang("photos_sure_del_album"),v.getLang("global_delete"),(function(o){ajax.post("al_photos.php",{act:"delete_album",album:e,hash:t},{showProgress:()=>(0,p.lockButton)(o),hideProgress:()=>(0,p.unlockButton)(o)})}),v.getLang("global_cancel"))},showSaved(e,t){const o=(0,s.ge)(e),i=function(){setTimeout(r.animate.pbind(o,{backgroundColor:t,borderLeftColor:"#D8DFEA",borderRightColor:"#D8DFEA",borderTopColor:"#D8DFEA",borderBottomColor:"#D8DFEA"},1e3),1e3)};(0,s.isVisible)(o)?(0,r.animate)(o,{backgroundColor:"#E7F1F9",borderLeftColor:"#4C96D4",borderRightColor:"#4C96D4",borderTopColor:"#4C96D4",borderBottomColor:"#4C96D4"},200,i):((0,s.show)(o),i())},saveAlbum(e){const t={act:"save_album",album:cur.album,hash:cur.albumhash,title:(0,s.ge)("album_title").value,desc:(0,s.ge)("album_description").value,enable_hintach:(0,p.isChecked)("hintach_enabled_for_album")};if(!t.title)return(0,p.notaBene)("album_title");const o=cur.album.replace(vk.id+"_","");cur.privacy["album"+o]?(0,c.extend)(t,{view:Privacy.getValue("album"+o),comm:Privacy.getValue("albumcomm"+o)}):(0,s.ge)("album_only_check")&&(0,c.extend)(t,{main:(0,p.isChecked)("album_main_check"),only:(0,p.isChecked)("album_only_check"),comm:(0,p.isChecked)("album_comments_check")}),ajax.post("al_photos.php",t,{onDone:function(){const e=(0,s.ge)("album_main_check");e&&(0,p.isChecked)(e)&&((0,s.addClass)(e,"on"),(0,s.addClass)(e,"disabled"),(0,s.hide)("album_delete_action"));const t=(0,s.ge)("photos_changes_saved");(0,s.setStyle)(t,{opacity:1}),setTimeout((function(){(0,s.setStyle)(t,{opacity:0})}),1500)},showProgress:()=>(0,p.lockButton)(e),hideProgress:()=>(0,p.unlockButton)(e)})},savePhotos(){const e={act:"save_photos",album:cur.album,hash:cur.albumhash},t=(0,s.ge)("photos_container");let o=0;for(let i=t.firstChild;i;i=i.nextSibling){if(!i.firstChild||!(0,s.isVisible)(i.firstChild))continue;const t=i.id.replace("photo_edit_row","");e["photo_id"+o]=t,e["photo_desc"+o]=(0,s.ge)("photo_caption"+t).value,++o}ajax.post("al_photos.php",e,{onDone:function(){for(let e=t.firstChild;e;e=e.nextSibling){if(!e.firstChild||!(0,s.isVisible)(e.firstChild))continue;const t=e.id.replace("photo_edit_row","");(0,s.ge)("photo_save_result"+t).innerHTML=v.getLang("photos_privacy_description")}cur.descs=!1,(0,u.scrollToTop)(200),P.showSaved("photos_saved_msg","#F3F8FC"),(0,s.ge)("photos_container").sorter&&sorter.update((0,s.ge)("photos_container").sorter.elems[0])},progress:"photos_save_progress"})},deleteSelectedPhotos(e){const t=[];(0,c.each)((0,s.geByClass)("photos_edit_selected"),(function(){t.push(this.getAttribute("data-id"))}));const o=(0,c.intval)(P._editGetSelectedCount()>t.length),i=cur.album.split("_");(0,g.showBox)("/al_photos.php",{act:"delete_selected_box",Photo_ids:o?"":t.join(","),owner_id:i[0],album_id:i[1],all:o},{onDone(){const t=(0,d.curBox)();t.removeButtons(),t.addButton(v.getLang("photos_del_selected_box_yes"),(t=>{(0,s.show)("photos_del_box_progress"),(0,s.hide)("photos_del_box_text"),(0,s.re)(t);const o=(0,s.ge)("photos_del_box_progress_text");P.doEditBatchProcess({act:"delete_photos",hash:e,owner_id:i[0],album_id:i[1]},cur.editDeletePhotosArray,(0,s.ge)("photos_del_box_progress_wrap"),v.getLang("photos_del_selected_title_progress"),(function(e,t,i,a,r){(0,s.val)(o,v.getLang("photos_del_selected_box_text_progress").replace("{count}",a).replace("{total}",r)),cur.count=Math.max(cur.count-e,0),(0,c.each)(i,(function(e,t){(0,s.re)("photo_edit_row_"+t),cur.count=Math.max(cur.count,0)})),P._editUpdateSelectedCounter()}),(function(){const e=(0,d.curBox)();if(e&&e.hide(),0==cur.count)nav.reload();else{(0,s.geByClass)("photos_photo_edit_row").length<40&&P.load()}}))})),t.addButton(v.getLang("box_cancel"),(function(){t.hide(),cur.editDeletePhotosArray=!1}),"no")}})},doEditBatchProcess(e,t,o,i,a,r){const n=t.split(","),l=n.length,h=cur.editPhotosMaxChunkSize||50,u=Math.ceil(l/h),p=(0,s.geByClass1)("photos_progress_bar",(0,s.ge)(o))||(0,s.geByClass1)("ui_progress_bar",(0,s.ge)(o));let g=0;const _=document.title,m=(0,d.curBox)();a(0,!1,[],0,l),function t(o){if(!m.isVisible())return r(g),void(0,s.setDocumentTitle)(_);const d=n.slice(o*h,(o+1)*h);ajax.post("/al_photos.php",(0,c.extend)({photos:d.join(",")},e),{onDone:function(e,n,h){g+=e,o++,(0,s.setStyle)(p,{width:100*o/u+"%"}),(0,s.setDocumentTitle)(i.replace("{count}",g).replace("{total}",l)),a(e,n,d,g,l,h),o<u?t(o):setTimeout((function(){(0,s.setDocumentTitle)(_),r(g,n)}),200)}})}(0)},_showProgressPanel(e){const t=(0,s.se)('<div class="photo_mask_progress _photo_mask_progress"><div class="photos_editing_background"></div><div class="round_spinner"></div></div>');return e.appendChild(t),t},_hideProgressPanel(e){(0,s.re)((0,s.geByClass1)("_photo_mask_progress",e))},deletePhoto(e,t,o,i){let a;if(""===e&&o&&(a=(0,s.gpeByClass)("photos_photo_edit_row",o),e=(0,s.attr)(a,"data-id"),t=(0,s.attr)(a,"data-edit-hash")),a=a||(0,s.ge)("photo_edit_row_"+e),!a)return;const r=P._showProgressPanel(a);return(0,s.addClass)(a,"photos_deleted"),ajax.post("al_photos.php",{act:"delete_photo",photo:e,hash:t,edit:1},{onDone:function(e){(0,s.re)(r),a.appendChild((0,s.se)(e)),P.recache(cur.offset,-1),cur.count-=1,P._editUpdateSelectedCounter(),cur.count<2&&(0,s.hide)("album_thumb_action"),(0,s.ge)("photos_go_to_album_cont")&&!cur.count&&(0,s.hide)("photos_go_to_album_cont"),cur.photoAddUpdate&&cur.photoAddUpdate(a),cur.introTooltipHide&&cur.introTooltipHide(!0)}}),(0,h.cancelEvent)(i)},restorePhoto(e,t,o){const i=(0,s.ge)("photo_edit_row_"+t);if(!i||!(0,s.hasClass)(i,"photos_deleted"))return;const a=P._showProgressPanel(i);(0,s.re)((0,s.geByClass1)("photos_restore",i)),ajax.post("al_photos.php",{act:"restore_photo",photo:t,hash:o,edit:1},{onDone:function(){(0,s.re)(a),(0,s.removeClass)(i,"photos_deleted"),P.recache(cur.offset,1),cur.count+=1,P._editUpdateSelectedCounter(),cur.count>1&&(0,s.show)("album_thumb_action"),(0,s.ge)("photos_go_to_album_cont")&&cur.count&&(0,s.show)("photos_go_to_album_cont"),cur.photoAddUpdate&&cur.photoAddUpdate(i)},progress:"photo_restore_progress"+t})},toggleMoveToAlbumMode(e,t){const o=(0,s.ge)("photos_move_box_search"),i=(0,s.ge)("pv_move_to_album_cont"),a=(0,s.ge)("photos_box_edit_data"),r=(0,d.curBox)(),n=(0,s.geByClass1)("box_title",r.titleWrap);if(e){(0,s.hide)(o),(0,s.hide)(i),(0,s.show)(a),r.setOptions({width:500});let e=v.getLang("photos_move_to_new_album_title");cur.noAlbums||(e+=`\n          <span class="divider">|</span>\n          <a onclick="return photos.toggleMoveToAlbumMode(false, event)" href="" class="toggle">\n            ${v.getLang("photos_move_to_another_album_toggle")}\n          </a>\n        `),(0,s.val)(n,e),r.removeButtons().addButton(v.getLang("photos_create_album_and_move"),cur.saveNewAlbum).addButton(v.getLang("global_cancel"),r.hide,"no"),cur.onNewAlbumDone=function(e){(0,d.curBox)().hide(),P.movePhotosBox(cur.editPhotosArray.split(","),!1,(function(){setTimeout((function(){const t=(0,s.ge)("album"+e);P.doMovePhotos(!1,t)}))}))}}else(0,s.show)(o),(0,s.show)(i),(0,s.hide)(a),r.setOptions({width:795}),(0,s.val)(n,v.getLang("photos_move_box_title")+'<span class="divider">|</span><a onclick="return photos.toggleMoveToAlbumMode(true, event)" href="" class="toggle">'+v.getLang("photos_move_to_new_album")+"</a>"),r.removeButtons().addButton(v.getLang("global_cancel"),r.hide);return(0,h.cancelEvent)(t)},showMove(e,t,o){const i=cur.moveddc,a=(0,s.ge)("photos_move_link"+e);cur.privacyPhotoMove?Privacy.show(a,o,"photos_move"):(cur.zIndexUpdated&&(P.hideMove(),cur.noZIndexUpdate=!0),(0,s.ge)("photo_edit_row"+e)&&(cur.zIndexUpdated=e,(0,s.setStyle)((0,s.ge)("photo_edit_row"+e),{zIndex:150})),P.hideMove()),(0,c.extend)(cur,{movelnk:a,moveph:e,movehash:t}),cur.privacyPhotoMove||(a.parentNode.replaceChild(i,a),cur.movedd.focus(),cur.movedd.showDefaultList(),(0,h.addEvent)(document,"click",P.hideMove))},hideMove(){if(cur.noZIndexUpdate)delete cur.noZIndexUpdate;else if(!cur.privacyPhotoMove){if(cur.movelnk)try{cur.moveddc.parentNode.replaceChild(cur.movelnk,cur.moveddc),cur.movelnk=!1,cur.movedd.clear(),cur.zIndexUpdated&&(0,s.ge)("photo_edit_row"+cur.zIndexUpdated)&&((0,s.setStyle)((0,s.ge)("photo_edit_row"+cur.zIndexUpdated),{zIndex:100}),delete cur.zIndexUpdated)}catch(e){}(0,h.removeEvent)(document,"click",P.hideMove)}},movePhoto(e,t,o){e=(0,c.intval)(e);let i=s.show.pbind("photo_return_progress"+t),a=s.hide.pbind("photo_return_progress"+t);if(!t){if(!e||e==cur.album.split("_")[1])return P.hideMove();t=cur.moveph,o=cur.movehash,i=function(){(0,s.hide)("photo_delete_link"+t),(0,s.show)("photo_edit_progress"+t)},a=function(){(0,s.hide)("photo_edit_progress"+t),(0,s.show)("photo_delete_link"+t)}}ajax.post("al_photos.php",{act:"move_photo",album:e,photo:t,hash:o},{onDone:function(o){const i=(0,s.ge)("photo_edit_row"+t);if(i&&i.firstChild){if(e==cur.album.split("_")[1]){if((0,s.isVisible)(i.firstChild))return;i.removeChild(i.firstChild.nextSibling),(0,s.show)(i.firstChild),P.recache(cur.offset,1),++cur.count,cur.count>1&&(0,s.show)("album_thumb_action")}else{if(!(0,s.isVisible)(i.firstChild))return;P.hideMove(),(0,s.hide)(i.firstChild),i.appendChild((0,s.ce)("div",{innerHTML:o})),P.recache(cur.offset,-1),--cur.count,cur.count<2&&(0,s.hide)("album_thumb_action")}cur.photoAddUpdate&&cur.photoAddUpdate(i),cur.introTooltipHide&&cur.introTooltipHide(!0),(0,s.ge)("photos_go_to_album_cont")&&(0,s.toggle)("photos_go_to_album_cont",!!cur.count)}},onFail:function(e){if(P.hideMove(),e)return setTimeout((0,g.showFastBox)({title:v.getLang("global_error"),bodyStyle:"padding: 20px;"},e).hide,2e3),!0},showProgress:i,hideProgress:a})},updateThumbs(e,t){const o=(0,s.ge)("photos_add_img"+cur.peEditPhoto);o&&(o.src=e)},editPhoto(e,t,o){cur.peEditPhoto=e,(0,g.showBox)("al_photos.php",{act:"edit_photo",photo:e,webgl:1,stat:["ui_controls.css","ui_controls.js"]})},backupDesc(e){cur.descs||(cur.descs={}),cur.descs[e]=(0,c.trim)((0,s.ge)("photo_caption"+e).value)},saveDesc(e,t){const o=(0,s.ge)("photo_caption"+e).value,i=cur.descs[e];delete cur.descs[e],(0,c.trim)(o)!=i&&ajax.post("al_photos.php",{act:"save_desc",photo:e,hash:t,text:o,edit:1},{onDone:function(t){(0,s.ge)("photo_save_result"+e).innerHTML=t},onFail:function(t){return(0,s.ge)("photo_save_result"+e).innerHTML='<div class="photo_save_error">'+t+"</div>",!0},showProgress:function(){(0,s.ge)("photo_save_result"+e).innerHTML=v.getLang("photos_privacy_description"),(0,s.show)("photo_save_progress"+e)},hideProgress:function(){(0,s.hide)("photo_save_progress"+e)}})},genFile:(e,t,o)=>(0,s.ce)("div",{innerHTML:`\n        <a class="photo_file_cancel" id="photo_cancel${e}" onclick="${t}">${o}</a>\n        <div class="photo_file_button">\n          <div class="file_button_gray">\n            <div class="file_button" id="photo_file_button${e}">${v.getLang("photos_choose_file")}</div>\n          </div>\n        </div>\n      `}),initFile(e){FileButton.init("photo_file_button"+e,{name:"photo",id:"photo_file"+e,accept:"image/jpeg,image/png,image/gif",onchange:P.fileSelected})},addFile(){const e=cur.files.length,t=P.genFile(e,"photos.fileCancel("+e+")",v.getLang("global_cancel"));(0,c.extend)(t,{className:"photo_upload_file",id:"photo_upload_row"+e}),(0,s.ge)("photo_upload_files").appendChild(t),P.initFile(e),cur.files.push({})},filesLoad(){let e=0,t=0;for(;e<cur.files.length;++e){if((0,s.ge)("photo_file"+e).value)break}if(e==cur.files.length)return;cur.allcont=utilsNode.appendChild((0,s.ce)("div",{innerHTML:`\n        <iframe name="photo_frame_all"></iframe>\n        <form target="photo_frame_all" id="photo_form_all" method="POST" action="${cur.url}" enctype="multipart/form-data"></form>\n      `}));const o=(0,s.ge)("photo_form_all");let i=(0,c.extend)(cur.fields,{act:"do_add",al:1,from_host:locHost,ondone:"photos.filesDone",onfail:"photos.filesFail"});for(t in i)i.hasOwnProperty(t)&&o.appendChild((0,s.ce)("input",{name:t,value:i[t]}));for(e=0,t=0;e<cur.files.length;++e){let i=(0,s.ge)("photo_file"+e);i.value&&(i.name="file"+t,o.appendChild(i),++t)}o.submit()},fileSelected(){const e=(0,c.intval)(this.id.replace("photo_file",""));if(!cur.files[e].deleting&&(cur.files[e].cont||cur.files[e].id))return;cur["fileDone"+e]=P.fileDone.pbind(e),cur["fileFail"+e]=P.fileFail.pbind(e),cur.files[e].cont=utilsNode.appendChild((0,s.ce)("div",{innerHTML:`\n        <iframe name="photo_frame${e}"></iframe>\n        <form target="photo_frame${e}" id="photo_form${e}" method="POST" action="${cur.url}" enctype="multipart/form-data"></form>\n      `}));const t=(0,s.ge)("photo_form"+e),o=(0,c.extend)(cur.fields,{act:"do_add",al:1,from_host:locHost,ondone:"cur.fileDone"+e,onfail:"cur.fileFail"+e});for(let e in o)o.hasOwnProperty(e)&&t.appendChild((0,s.ce)("input",{name:e,value:o[e]}));t.appendChild(this),t.submit();const i=(0,s.ge)("photo_file_button"+e);(0,p.lockButton)(i),setTimeout((function(){i.innerHTML=i.innerHTML}),0),(0,s.show)("photo_cancel"+e),(0,s.ge)("photo_cancel"+e).innerHTML=v.getLang("global_cancel"),e==cur.files.length-1&&P.addFile()},fileDone(e,t){(0,s.hide)("photo_cancel"+e);let o="";for(let t=e+1;t<cur.files.length;++t)if(cur.files[t].id&&!cur.files[t].deleting){o=cur.files[t].id;break}setTimeout(ajax.post.pbind("al_photos.php",(0,c.extend)({act:"done_add",before:o,context:1},(0,E.fromQueryString)(t)),{onDone:function(t,o){if(!t)return P.fileFail(e,0);cur.files[e].cont.innerHTML="",utilsNode.removeChild(cur.files[e].cont),(0,c.extend)(cur.files[e],{id:t,deleting:!1,cont:!1}),(0,s.ge)("photo_upload_row"+e).innerHTML=o,(0,l.autosizeSetup)("photo_caption"+t,{minHeight:30}),(0,s.show)("photo_delete"+t)},onFail:function(t){if(t)return setTimeout((0,g.showFastBox)({title:v.getLang("global_error"),bodyStyle:"padding: 20px;"},t).hide,3e3),P.fileCancel(e),!0}}),0)},fileCancel(e,t){if(cur.files[e].cont&&(cur.files[e].cont.innerHTML="",utilsNode.removeChild(cur.files[e].cont)),t)return;const o=(0,s.ge)("photo_file_button"+e);(0,p.unlockButton)(o),o.innerHTML=v.getLang("photos_choose_file"),cur.files[e]={},P.initFile(e),(0,s.hide)("photo_cancel"+e)},fileFail(e,t){P.fileCancel(e)},fileDelete(e,t){let o=0;for(;o<cur.files.length&&cur.files[o].id!=e;)++o;if(o==cur.files.length||cur.files[o].deleting)return;cur.files[o].deleting=!0,ajax.post("al_photos.php",{act:"delete_photo",photo:e,hash:t,edit:2},{onFail:function(){cur.files[o].deleting=!1}});const i=(0,s.ge)("photo_edit_row"+e);i.parentNode.insertBefore(P.genFile(o,"photos.fileRestore('"+e+"', '"+t+"')",v.getLang("global_restore")),i),(0,s.hide)(i),P.initFile(o),(0,s.show)("photo_cancel"+o)},fileRestore(e,t){let o=0,i="";for(;o<cur.files.length&&cur.files[o].id!=e;)++o;if(o==cur.files.length||!cur.files[o].deleting||-1===cur.files[o].deleting)return;if(cur.files[o].cont)return P.fileCancel(o);for(let e=o+1;e<cur.files.length;++e)if(cur.files[e].id&&!cur.files[e].deleting){i=cur.files[e].id;break}cur.files[o].deleting=-1,ajax.post("al_photos.php",{act:"restore_photo",photo:e,hash:t,before:i,edit:2},{onDone:function(){cur.files[o].deleting=!1}});const a=(0,s.ge)("photo_edit_row"+e);(0,s.show)(a),(0,s.re)(a.previousSibling)},filesDone(e){setTimeout(ajax.post.pbind("al_photos.php",(0,c.extend)({act:"done_add",context:2},(0,E.fromQueryString)(e))),0)},filesFail(){for(let e=0;e<cur.files.length;++e)P.fileCancel(e);cur.allcont.innerHTML="",utilsNode.removeChild(cur.allcont),cur.allcont=!1},chooseFlash(){if(i.browser.flash<10)return(0,r.animate)((0,s.ge)("photo_flash_needed"),{backgroundColor:"#FFEFE8",borderBottomColor:"#E89B88",borderLeftColor:"#E89B88",borderRightColor:"#E89B88",borderTopColor:"#E89B88"},100,(()=>{(0,r.animate)((0,s.ge)("photo_flash_needed"),{backgroundColor:"#FFFFFF",borderBottomColor:"#CCCCCC",borderLeftColor:"#CCCCCC",borderRightColor:"#CCCCCC",borderTopColor:"#CCCCCC"},500)}));cur.photoCheckFails=0,(0,s.show)("photo_flash_upload"),(0,s.hide)("photo_default_upload"),(0,s.hide)("photo_upload_unavailable")},chooseDefault(){cur.photoCheckFails=0,(0,s.show)("photo_default_upload"),(0,s.hide)("photo_flash_upload"),cur.serverChecked?((0,s.show)("photo_upload_files"),(0,s.hide)("photo_default_check")):((0,s.hide)("photo_upload_files"),(0,s.show)("photo_default_check"),cur.checkUpload())},flashWidth:()=>-1==_ua.indexOf("Mac")||-1==_ua.indexOf("Opera")&&-1==_ua.indexOf("Firefox")?"600":"601",activeTab(e){const t=(0,s.domPN)((0,s.domPN)(e));for(let e=(0,s.domFC)(t);e;e=(0,s.domNS)(e))(0,s.removeClass)(e,"active_link");(0,s.addClass)((0,s.domPN)(e),"active_link")},checkHtml5Uploader(){const e=window.XMLHttpRequest||window.XDomainRequest,t=window.MozBlobBuilder||window.WebKitBlobBuilder||window.BlobBuilder;return e&&(window.FormData||window.FileReader&&(window.XMLHttpRequest&&XMLHttpRequest.sendAsBinary||window.ArrayBuffer&&window.Uint8Array&&t))},upload:(e,t)=>t&&(2==t.button||t.ctrlKey)?(P.checkHtml5Uploader()&&(e.href+="&html5=1"),!0):!(void 0!==cur.uplId&&window.Upload&&Upload.checked&&Upload.checked[cur.uplId]&&P.checkHtml5Uploader())||((0,s.ge)("photos_upload_input").click(),!1),uploadLink:(e,t)=>(P.checkHtml5Uploader()&&(e.href+="&html5=1"),nav.go(e,t)),onUploadSelect(e){if(!(0,s.ge)("photos_upload_area"))return;window.filesToUpload=e;const t=(0,s.ge)("photos_upload_area").innerHTML;(0,s.ge)("photos_upload_area").innerHTML='<img src="/images/upload.gif">',nav.go((0,s.ge)("photos_upload_area").href+"&html5=1",!1,{onFail:function(e){return(0,s.ge)("photos_upload_area").innerHTML=t,setTimeout((0,g.showFastBox)({title:v.getLang("global_error"),bodyStyle:"padding: 20px;"},e).hide,3e3),!0}})},thumbOver(e,t,o){cur.hideTO&&cur.hideTO[t]&&clearTimeout(cur.hideTO[t]);const i=(0,s.geByClass1)("description",e),a=(0,s.geByClass1)("photo_album_title",e),n=(0,s.getSize)(i)[1];(0,r.animate)(a,{marginTop:163-(n?n+7:0)},{duration:200,transition:r.Fx.Transitions.easeOutCirc});const l=(0,s.geByClass1)("photo_album_info_back",e),d=(0,s.geByClass1)("photo_album_info_cont",e);if(!l||!d)return;if(l.over&&!o)return void(l.over=0);const h=o?.6:.5,c=o?1:.8;o&&(l.over=1),(0,r.animate)(l,{opacity:h},{duration:200,transition:r.Fx.Transitions.easeOutCirc}),(0,r.animate)(d,{opacity:c},{duration:200,transition:r.Fx.Transitions.easeOutCirc})},thumbOut(e,t,o){const i=(0,s.geByClass1)("photo_album_info_back",e),a=(0,s.geByClass1)("photo_album_info_cont",e),n=()=>{if(o){const t=(0,s.geByClass1)("photo_album_title",e);(0,r.animate)(t,{marginTop:163},200)}if(!i||!a)return;const t=o?0:.5,n=o?0:.8;(0,r.animate)(i,{opacity:t},200),(0,r.animate)(a,{opacity:n},200)};o?(cur.hideTO=cur.hideTO||{},cur.hideTO[t]=setTimeout(n,150)):n()},openEditor:(e,t)=>(window.stManager.add([window.jsc("web/photoview.js"),"photoview.css"],(function(){const t=(0,s.gpeByClass)("photos_photo_edit_row",e);cur.onPESave=function(e){(0,d.curBox)().hide(),(0,s.setStyle)((0,s.geByClass1)("photos_photo_edit_row_thumb",t),"background-image","url('"+e+"')"),cur.onPESave=!1,document.body.style.overflow="auto"};const o=t.getAttribute("data-id");Photoview.openEditor(o,cur.savedThumbs?cur.savedThumbs[o]:t.getAttribute("data-thumb"))})),(0,h.cancelEvent)(t)),addToAlbum(){cur.isPhotoUpload=!0,P.movePhotosBox(cur.savedPhotos||[],!1)},movePhotosBox(e,t,o,i){let r=[],n=!1;(0,a.isArray)(e)?r=e:(""===e&&t&&(e=(0,s.gpeByClass)("photos_photo_edit_row",t).getAttribute("data-id")),e?r.push(e):(0,c.each)((0,s.geByClass)("photos_edit_selected"),(function(){r.push(this.getAttribute("data-id"))})),n=(0,c.intval)(P._editGetSelectedCount()>r.length));const l=cur.album?cur.album.split("_"):[vk.id];return(0,g.showBox)("/al_photos.php",{act:"a_move_to_album_box",photo_ids:n?"":r.join(","),owner_id:l[0],from_album_id:l[1],all:n},{onDone:o}),(0,h.cancelEvent)(i)},cancelMove(e,t,o,i,a,r,n){const l=(0,s.gpeByClass)("photos_photo_edit_row",t);(0,s.re)((0,s.geByClass1)("photos_cancel_move",l)),P._showProgressPanel(l),ajax.post("al_photos.php",{act:"move_photos",photos:o,to_album_id:i,from_album_id:a,hash:n,owner_id:r},{onDone:function(){P._hideProgressPanel(l),cur.count++,P._editUpdateSelectedCounter()}}),(0,h.cancelEvent)(e)},doMovePhotos(e,t,o){const i=(0,s.domClosest)("_photos_album",t),a=(0,s.domData)(i,"aid"),r=(0,s.domData)(i,"from-aid"),n=(0,s.domData)(i,"owner-id"),l=(0,s.domData)(i,"move-hash"),u=(0,s.domData)(i,"from"),p=(0,s.geByClass1)("photos_album_counter",t),g=(0,s.geByClass1)("photos_album_thumb",t),_=(0,s.ge)("pv_move_to_album_progress");g.insertBefore(_,g.children[0]),(0,s.show)(_),(0,s.addClass)(t,"photos_in_progress"),(0,s.addClass)((0,s.gpeByClass)("photos_container_albums",t),"photos_inactive"),P.doEditBatchProcess({act:"move_photos",to_album_id:a,from_album_id:r,owner_id:n,hash:l,from:u},cur.editPhotosArray,(0,s.ge)("pv_move_to_album_progress"),v.getLang("photos_move_in_progress_title"),(function(e,t,i,l,d,h){cur.count=Math.max(cur.count-e,0),(0,s.val)(p,+(0,s.val)(p)+e),(0,c.each)(i,(function(e,t){const i=(0,s.ge)("photo_edit_row_"+t);if(!cur.isPhotoUpload)if(i&&!o){i.classList.remove("photos_edit_selected");const e="return photos.cancelMove(event, this, '"+t+"', "+r+", "+a+", "+n+", '"+h+"')",o=(0,s.se)(`<div class="photos_cancel_move">\n                <div class="photos_editing_background"></div>\n                <a href="" onclick="${e}">${v.getLang("global_cancel")}</a></div>`);i.appendChild(o)}else(0,s.re)(i);cur.count=Math.max(cur.count,0)})),P._editUpdateSelectedCounter()}),(function(e,t){const i=(0,d.curBox)();i&&i.hide();let a=(0,v.langNumeric)(e,v.curLang("photos_x_photos_moved_no_cancel"));if(a=a.replace("{album}",t),(0,d.showDoneBox)(a),cur.pvShown&&cur.pvCurPhoto&&(cur.pvCurPhoto.album=t,(0,s.geByClass1)("pv_album_name").innerHTML=t),o||cur.isPhotoUpload)if(0==cur.count)nav.reload();else{(0,s.geByClass)("photos_photo_edit_row").length<40&&P.load()}})),e&&(0,h.cancelEvent)(e)},publishPhotos(e){if(cur.savedPhotos){cur.savingPhotos=!0;const t={act:"post",type:"photos_upload",to_id:vk.id,attach1_type:"photos_list",attach1:(cur.savedPhotos||[]).join(","),hash:cur.post_hash};ajax.post("/al_wall.php",t,{showProgress:()=>(0,p.lockButton)(e),onDone:function(){delete cur._back,nav.go("/id"+vk.id),(0,n.showBackLink)()}})}return!1},registerDragZone(e){(0,h.addEvent)(document,"dragenter dragover",(function(t){if(P.checkHtml5Uploader())return setTimeout((function(){clearTimeout(cur.dragTimer),delete cur.dragTimer}),0),e.on(t),(0,h.cancelEvent)(t)})),(0,h.addEvent)(document,"dragleave",(function(t){cur.dragTimer&&(clearTimeout(cur.dragTimer),delete cur.dragTimer),cur.dragTimer=setTimeout((function(){e.un(t)}),100),(0,h.cancelEvent)(t)})),(0,h.addEvent)(document,"drop",(function(t){return e.un(t,!0),e.drop(t.dataTransfer.files),(0,h.cancelEvent)(t)})),(0,T.pushNavDestroy)((()=>{(0,h.removeEvent)(document,"dragenter dragover"),(0,h.removeEvent)(document,"dragleave"),(0,h.removeEvent)(document,"drop")}))},initTagBlock(e={}){const t=document.querySelector(`.${_.PHOTO_TAG_BLOCK_CLASS}`);if(t)try{const o=new _.PhotoTagBlock(t,e);window.cur.destroy.push((()=>o.destroy()))}catch(e){console.error(e),(0,m.logError)(e)}},albumGoUploaderPropsCache:{},initAlbumGoUploader(e,t=null){let o=t||this.albumGoUploaderPropsCache[e];if(!o)return;this.albumGoUploaderPropsCache[e]=o;const{userId:i,groupId:a,albumId:r,uploadUrl:n,endpoint:l,curData:d}=o;d&&(0,c.extend)(window.cur,d);const h=(0,s.ge)("photos_upload_input"),u=(0,s.ge)("photos_upload_area_drop"),p=[],g=w.ImpUploader.init(e,{uploadUrl:n,accept:b.ALBUM_GO_UPLOADER_ACCEPT_TYPES,multiple:!0,input:h,dropArea:u,dragOverClass:"photos_upload_area_enter",onLoadStart:e=>{p.length=0,(0,s.hide)("system_msg"),window.PhotosAdd.onUploadStart(e)},onProgress:e=>{Array.from((0,s.geByClass)("photos_period_delimiter_fixed")).forEach(s.hide),_()},onLoadEnd:(e,t)=>{const[o]=t,s={group_id:a,album_id:r,user_id:i,photos_json:JSON.stringify(o)};window.PhotosAdd.onImpUploadComplete(e,s,l,(()=>{p.push(...e),_(),g.nextBatch()}))},onLoadEndAll:(e,t)=>{window.PhotosAdd.onUploadCompleteAll(e,t,!1)},onError:(e,t,o)=>{(0,m.logError)(`${t}: ${o}`,{environment:"go_uploader"}),(0,f.topError)(v.getLang("photos_upload_error"),{type:100});window.PhotosAdd.onImpUploadComplete(e,{},l),window.PhotosAdd.onUploadCompleteAll(null,null)}});function _(){const e=g.uploadedFiles.length,t=g.uploadedFiles[0].loadedSize,o=g.uploadedFiles[0].totalSize,i=p.length;if(i===e)window.PhotosAdd.hideUploadProgress(),(0,s.show)((0,s.ge)("photos_go_to_album"));else{const s=.1*(t/o)+.9*(i/e);window.PhotosAdd.updateProgressBar(s,i,e)}}window.photos.initAlbumGoUploaderDragZone(e),cur.nav.push((()=>(g.cancelAllUploads(),!0))),window.filesToUpload&&window.filesToUpload.length&&(g.manualUploadFiles([...window.filesToUpload]),delete window.filesToUpload)},initAlbumGoUploaderDragZone(e){const t=w.ImpUploader.getUploader(e);this.onAlbumGoUploaderDragEnter=e=>{t.handleDragEnter(e)},window.document.addEventListener("dragenter",this.onAlbumGoUploaderDragEnter)},detachAlbumGoUploaderDragZone(){window.document.removeEventListener("dragenter",this.onAlbumGoUploaderDragEnter)},initChooseSelectGoUploader({id:e,userId:t,groupId:o,albumId:s,uploadUrl:i,options:a={}}){new C.ChoosePhoto.Upload({id:e,userId:t,groupId:o,albumId:s,uploadUrl:i,options:a})},showProfileBox:(e,t)=>((0,g.showBox)("al_places.php",{act:"photos_box",uid:e},{stat:["maps.js",window.jsc("web/places.js"),"places.css","ui_controls.js","ui_controls.css"]}),(0,h.cancelEvent)(t),!1),photosUploadOnInputChange:e=>{const t=window.cur.album,o=w.ImpUploader.getUploader(t??"");e&&o?o.handleInputChange(e):(0,m.logError)(new Error(`Uploader "${t}" did not found`),{environment:"go_uploader"})}}},11660:(e,t,o)=>{o.d(t,{drawRoundedImage:()=>i,getCoverSize:()=>r,getCroppedImage:()=>n,getZeroFrameFromGif:()=>l,roundRect:()=>a});var s=o(433830);const i=(e,t,o,s,i,a,r,n,l,d,h)=>{const c=n||s,u=l||i,p=d||a||t.naturalWidth,g=h||r||t.naturalHeight;e.beginPath(),e.arc(c+o,u+o,o,Math.PI,Math.PI+Math.PI/2),e.lineTo(c+p-o,u),e.arc(c+p-o,u+o,o,Math.PI+Math.PI/2,2*Math.PI),e.lineTo(c+p,u+g-o),e.arc(c+p-o,u+g-o,o,2*Math.PI,Math.PI/2),e.lineTo(c+o,u+g),e.arc(c+o,u+g-o,o,Math.PI/2,Math.PI),e.closePath(),e.save(),e.clip(),e.drawImage(t,s,i,a,r,n,l,d,h),e.restore()},a=(e,t,o,s,i,a)=>{let r={};if("number"==typeof a)r={tl:a,tr:a,br:a,bl:a};else{const e={tl:0,tr:0,br:0,bl:0};for(let t in e)r[t]=r[t]||e[t]}e.save(),e.beginPath(),e.moveTo(t+r.tl,o),e.lineTo(t+s-r.tr,o),e.quadraticCurveTo(t+s,o,t+s,o+r.tr),e.lineTo(t+s,o+i-r.br),e.quadraticCurveTo(t+s,o+i,t+s-r.br,o+i),e.lineTo(t+r.bl,o+i),e.quadraticCurveTo(t,o+i,t,o+i-r.bl),e.lineTo(t,o+r.tl),e.quadraticCurveTo(t,o,t+r.tl,o),e.closePath(),e.restore()},r=(e,t,o,s,i,a)=>{const r=e/t;let n,l;return r>o/s?(n=s,l=s*r):(l=o,n=o/r),{width:l,height:n,offsetLeft:(o-l)*(i=void 0===i?.5:i),offsetTop:(s-n)*(a=void 0===a?.5:a)}};function n(e,t,o,i,a,r=0){return new Promise(((n,l)=>{("string"==typeof e?(0,s.loadImage)(e):Promise.resolve(e)).then((e=>{const d=document.createElement("canvas");d.width=90===r||270===r?e.naturalHeight:e.naturalWidth,d.height=90===r||270===r?e.naturalWidth:e.naturalHeight;const h=d.getContext("2d");if(!h)return void n(e);h.fillStyle="#fff",h.fillRect(0,0,h.canvas.width,h.canvas.height),r?(h.translate(d.width/2,d.height/2),h.rotate(r*Math.PI/180),h.drawImage(e,-e.naturalWidth/2,-e.naturalHeight/2)):h.drawImage(e,0,0);const c=h.getImageData(t,o,i,a),u=document.createElement("canvas");u.width=i,u.height=a;const p=u.getContext("2d");if(p)return p.putImageData(c,0,0),(0,s.loadImage)(u.toDataURL("image/jpeg",1)).then(n).catch(l);n(e)})).catch(l)}))}const l=(e,t,o)=>new Promise((i=>{"image/gif"!==e.type&&i({file:e,image:t,imageUrl:o});let a=document.createElement("canvas"),r=a.getContext("2d");if(!r)return i({file:e,image:t,imageUrl:o});a.width=t.width,a.height=t.height,r.drawImage(t,0,0),a.toBlob((a=>{if(null===a)return void i({file:e,image:t,imageUrl:o});const r=URL.createObjectURL(a);(0,s.loadImage)(o).then((e=>{i({file:a,image:e,imageUrl:r})})).catch((s=>{console.log(s),i({file:e,image:t,imageUrl:o})}))}))}))},781652:(e,t,o)=>{o.d(t,{GoUploaderDnD:()=>l});var s=o(92511),i=o(513432),a=o(206082),r=o(282588);class n{cancelUpload(e){e.cancelled=!0}cancelAllUploads(){this.uploadEvents.forEach((e=>{this.cancelUpload(e)}))}startFilesUpload(e,t){const o=this.multiple?this.multipleMaxSize:1,i=t.reduce(((e,t)=>{if(!e.length)return e.push([t]),e;const s=e.length-1,i=e[s].length,a=e[s].reduce(((e,t)=>e+=t.size),0);return i<o&&a<this.multipleMaxBatchSize?e[s].push(t):e.push([t]),e}),[]);let a=0;this.uploadEvents=i.map((e=>{let t=0;const o=e.reduce(((e,o,s)=>{const i=this.multiple?`file${s+1}`:"file";return t+=o.size,a++,e[i]={file:o,fileName:o.name,ind:a,loadedSize:0,fileSize:o.size},e}),{});return{totalSize:t,loadedSize:0,totalCount:e.length,uploaded:!1,cancelled:!1,files:o}})),this.onLoadStart&&this.uploadEvents.forEach((e=>{this.onLoadStart?.(e)}));const r=[];return this.uploadMode===s.UploadMode.parallel?this.uploadEvents.forEach((t=>{r.push(this.sendUploadRequest(e,t))})):(this.uploadEvents.forEach((t=>{r.push(new Promise((o=>{this.uploaderTasksQueue.push((()=>this.sendUploadRequest(e,t).then((e=>(o(e),this.nextBatch(),e)))))})))})),this.nextBatch()),Promise.all(r)}nextBatch(){const e=this.uploaderTasksQueue.shift();e&&e()}sendUploadRequest(e,t){const o=new FormData;Object.keys(t.files).forEach((e=>{const s=t.files[e];o.append(e,s.file)}));return(0,i.sendUploadRequest)(e,o,(e=>{let{loaded:o}=e;t.loadedSize=o,Object.keys(t.files).forEach((e=>{const s=t.files[e];if(o>0){let e=0;o>=s.fileSize?(e=s.fileSize,o-=s.fileSize):(e=o,o=0),s.loadedSize=e}})),this.onProgress?.(t)})).then((e=>{let o;t.uploaded=!0;try{o=JSON.parse(e)}catch(t){(0,a.logError)(t,"parse json error",{json:e}),o={error_code:n.ERROR_PARSE_JSON,error_msg:"Response parse error"}}return t.responseString=e,t.response=o,"files"in o&&o.files&&Object.keys(o.files).forEach((e=>{"files"in o&&o.files&&o.files[e]?.error_code&&(t.files[e].errorCode=o.files[e]?.error_code,t.files[e].errorMessage=o.files[e]?.error_msg)})),"error_code"in o?(t.errorCode=o.error_code,t.errorMessage=o.error_msg,this.onError?.(t)):this.onLoadEnd?.(t),t})).catch((e=>((0,a.logError)(e,"js syntax error"),t.errorCode=n.ERROR_JS,t.errorMessage=`Unknown Error (${e})`,this.onError?.(t),t)))}initFileInput(e){this.input=e,this.input.setAttribute("accept",this.accept.join(",")),this.multiple&&this.input.setAttribute("multiple","")}getAcceptedFilesOnly(e){return e.filter((e=>(0,a.acceptFile)(e,this.accept)))}cleanupFields(){this.input&&(this.input.value=""),this.uploadEvents=[]}uploadFiles(e){return this.beforeUpload(e).then((e=>this.startFilesUpload(this.uploadUrl,e)))}beforeUpload(e){return this.onBeforeUpload?this.onBeforeUpload(e):Promise.resolve(e)}manualUploadFiles(e){e.length?this.uploadFiles(e).then((e=>{this.uploadEvents.filter((e=>!e.cancelled)).length&&this.onLoadEndAll?.(e)})).finally((()=>{this.cleanupFields()})):this.cleanupFields()}destroy(){this.isDestroyed=!0}isUploadingActive(){return Boolean(this.uploadEvents.length)}constructor(e){this.multipleMaxSize=r.MULTIPLE_MAX_COUNT,this.multipleMaxBatchSize=r.MULTIPLE_BATCH_SIZE,this.uploadUrl="",this.uploadEvents=[],this.uploadMode=s.UploadMode.queue,this.isDestroyed=!1,this.uploaderTasksQueue=[],this.handleInputChange=e=>{const t=e.target.files;t&&0!==t.length?this.handleSendFiles([...t]):(0,a.logError)(new Error("GoUploader lib: bad args in handleInputChange"),"No files in event")},this.handleSendFiles=e=>{const t=this.getAcceptedFilesOnly(e);this.manualUploadFiles(t)},this.accept=e.accept??r.DEFAULT_ACCEPT,this.multiple=e.multiple??!1,this.uploadUrl=e.uploadUrl,this.uploadMode=e.uploadMode??s.UploadMode.queue,this.onBeforeUpload=e.onBeforeUpload,this.onProgress=e.onProgress,this.onLoadStart=e.onLoadStart,this.onLoadEnd=e.onLoadEnd,this.onLoadEndAll=e.onLoadEndAll,this.onError=e.onError,e.input&&this.initFileInput(e.input),e.multipleMaxSize&&e.multipleMaxSize>0&&e.multipleMaxSize<=r.MULTIPLE_MAX_COUNT&&(this.multipleMaxSize=e.multipleMaxSize),e.multipleMaxBatchSize&&(this.multipleMaxBatchSize=e.multipleMaxBatchSize)}}n.ERROR_JS=-1,n.ERROR_PARSE_JSON=-2;class l extends n{initDropArea(e){e&&(this.dropArea=e,this.dropArea.addEventListener("dragleave",this.handleDragLeave),this.dropArea.addEventListener("dragenter",this.handleDragEnter),this.dropArea.addEventListener("dragover",this.handleDragOver),this.dropArea.addEventListener("drop",this.handleDrop))}destroy(){super.destroy(),this.dropArea&&(this.dropArea.removeEventListener("dragleave",this.handleDragLeave),this.dropArea.removeEventListener("dragenter",this.handleDragEnter),this.dropArea.removeEventListener("dragover",this.handleDragOver),this.dropArea.removeEventListener("drop",this.handleDrop))}constructor(e){super(e),this.isDndActive=!1,this.dndTimer=-1,this.handleDrop=e=>{if(e.preventDefault(),e.stopPropagation(),this.onDragLeave&&this.onDragLeave(e),this.isDndActive=!1,!e.dataTransfer)return;const t=this.getAcceptedFilesOnly([...e.dataTransfer.files]);this.manualUploadFiles(t)},this.handleDragOver=e=>{e.preventDefault(),e.stopPropagation(),window.setTimeout((()=>{window.clearTimeout(this.dndTimer),this.dndTimer=-1}),0)},this.handleDragLeave=e=>{e.preventDefault(),e.stopPropagation(),-1!==this.dndTimer&&window.clearTimeout(this.dndTimer),this.dndTimer=window.setTimeout((()=>{this.isDndActive=!1,this.onDragLeave&&this.onDragLeave(e)}),100)},this.handleDragEnter=e=>{e.preventDefault(),e.stopPropagation(),this.isDndActive||(window.setTimeout((()=>{window.clearTimeout(this.dndTimer),this.dndTimer=-1}),0),this.isDndActive=!0,this.onDragEnter&&this.onDragEnter(e))},this.lazyInitDnD=e.lazyInitDnD??!1,e.dropArea&&!this.lazyInitDnD&&this.initDropArea(e.dropArea),e.onDragEnter&&(this.onDragEnter=e.onDragEnter),e.onDragLeave&&(this.onDragLeave=e.onDragLeave)}}},206082:(e,t,o)=>{o.d(t,{ALBUM_GO_UPLOADER_ACCEPT_TYPES:()=>r,GO_UPLOADER_ERROR_INCORRECT_SIZE:()=>n,acceptFile:()=>d,logError:()=>l});var s=o(65718),i=o(852401),a=o(212599);const r=["image/jpeg","image/png","image/gif","image/heic","image/heif","image/webp"],n=4601,l=(e,t="unknown",o={})=>{const a={environment:"goUploader",breadcrumb:{message:t,data:o,category:i.customBreadcrumbCategory}};(0,s.logError)(e,a)},d=(e,t)=>{if(e&&t){const o=e.name||"",s=e.type?e.type.toLowerCase():(0,a.calcMimeTypeByFileName)(o),i=s.replace(/\/.*$/,"");return t.some((e=>{const t=e.trim().toLowerCase();return t.startsWith(".")?o.toLowerCase().endsWith(t):t.endsWith("/*")?i===t.replace(/\/.*$/,""):s===t}))}return!0}},769114:(e,t,o)=>{o.d(t,{GoUploaderHelper:()=>a});var s=o(781652);const i=new Map,a={getUploader:e=>i.get(e),init(e,t){if(i.has(e)){const t=i.get(e);t&&t.destroy()}const o=new s.GoUploaderDnD(t);return i.set(e,o),o}}},92511:(e,t,o)=>{var s;o.d(t,{UploadMode:()=>s}),function(e){e[e.parallel=0]="parallel",e[e.queue=1]="queue"}(s||(s={}))},513432:(e,t,o)=>{o.d(t,{sendUploadRequest:()=>s});const s=(e,t,o)=>new Promise(((s,i)=>{const a=new XMLHttpRequest;a.open("POST",e,!0),o&&(a.upload.onloadstart=e=>{o(e)},a.upload.onprogress=e=>{o(e)}),a.onerror=()=>{i("Unknown error")},a.onreadystatechange=()=>{a.readyState===XMLHttpRequest.DONE&&(200===a.status?s(a.responseText):i())},a.send(t)}))},212599:(e,t,o)=>{o.d(t,{calcMimeTypeByFileName:()=>r,convertFileBlobToUploadedImage:()=>a,isHeicFile:()=>n});var s=o(433830),i=o(11660);const a=e=>{const t=URL.createObjectURL(e);return(0,s.loadImage)(t).then((o=>(0,i.getZeroFrameFromGif)(e,o,t).then((({file:e,image:t,imageUrl:o})=>({file:e,image:t,imageUrl:o})))))},r=e=>{let t="";if(e){const o=(e.split(".").pop()||"").toLowerCase();"heic"===o?t="image/heic":"heif"===o&&(t="image/heif")}return t},n=e=>{let t=e.type?.toLowerCase();return!t&&e.name&&(t=r(e.name)),["image/heic","image/heif"].includes(t)}},855764:(e,t,o)=>{o.d(t,{ImageProxyUploader:()=>n});var s=o(257884),i=o(593088),a=o(926907),r=o(70689);class n{cancelUpload(e){e.cancelled=!0}cancelAllUploads(){this.uploadedFiles.forEach((e=>{this.cancelUpload(e)}))}nextBatch(){const e=this.uploaderTasksQueue.shift();e&&e()}sendFilesUploadEvent(e,t){const o=this.uploadedFiles,s=this.uploadRequests.reduce(((e,t)=>e+t.loadedBytes),0),i=this.uploadRequests.reduce(((e,t)=>e+t.totalBytes),0);o.forEach((a=>{a.cancelled||(Object.assign(a,{loadedSize:s,totalCount:o.length,totalSize:i}),e(a,t))}))}startFilesUpload(e,t){this.uploadedFiles=t.map(((e,o)=>({file:e,fileName:e.name,ind:0,loadedSize:0,num:o,totalCount:t.length,totalSize:e.size,uploaded:!1,error:void 0,cancelled:!1}))),this.onLoadStart&&this.sendFilesUploadEvent(this.onLoadStart);const o=[...this.uploadedFiles],i=[];for(;o.length;){const t=[];let s=0;for(let e=0;e<5&&0!==o.length;e++){const e=o.shift();if(!e)break;if(s+=e.file.size,t.push(e),s>5242880)break}t.length&&i.push((()=>this.sendUploadRequest(e,t)))}const a=[];return this.uploadMode===s.UploadMode.parallel?i.forEach((e=>{a.push(e())})):(i.forEach((e=>{a.push(new Promise((t=>{this.uploaderTasksQueue.push((()=>e().then((e=>(t(e),e)))))})))})),this.nextBatch()),Promise.all(a)}sendUploadRequest(e,t){const o=new FormData,s={loadedBytes:0,totalBytes:0};this.uploadRequests.push(s);for(let e=0;e<t.length;e++){const s=t[e];o.append(`file${e+1}`,s.file)}return(0,i.sendUploadRequest)(e,o,s,(()=>{this.onProgress&&this.sendFilesUploadEvent(this.onProgress)})).then((e=>{let o;t.forEach((e=>{e.uploaded=!0}));try{o=JSON.parse(e)}catch(e){throw Error("Uploader response parsing error")}return Object.values(o.files).forEach(((e,s)=>{e&&(this.saveUploaderStateToFileState(t[s],e),Object.assign(t[s],{server:o.server,userId:o.user_id}),s++)})),this.onLoadEnd&&t.length&&this.onLoadEnd(t,[o]),e})).catch((e=>(t.forEach((t=>{t.errorMessage=e})),e)))}initFileInput(e){this.input=e,this.input.setAttribute("accept",this.accept.join(",")),this.multiple&&this.input.setAttribute("multiple","")}initDropArea(e){this.dropArea=e,this.dropArea?.addEventListener("dragleave",this.handleDragLeave),this.dropArea?.addEventListener("dragover",this.handleDragOver),this.dropArea?.addEventListener("drop",this.handleDrop)}destroy(){this.dropArea?.removeEventListener("dragleave",this.handleDragLeave),this.dropArea?.removeEventListener("dragover",this.handleDragOver),this.dropArea?.removeEventListener("drop",this.handleDrop)}getAcceptedFilesOnly(e){return[...e].filter((e=>(0,a.acceptFile)(e,this.accept)))}cleanupFields(){this.input&&(this.input.value=""),this.uploadRequests=[]}handleError(e){let t=0,o="unknown error";if("string"==typeof e)try{const s=JSON.parse(e);t=s.error_code??t,o=s.error_msg??o}catch(t){o=e}else o=e.message;this.onError&&this.onError(this.uploadedFiles,t,o)}uploadFiles(e){return this.startFilesUpload(this.uploadUrl,e).then((e=>Promise.all(e.map((e=>{let t;try{t=JSON.parse(e)}catch(e){throw Error("Uploader response parsing error")}return t})))))}saveUploaderStateToFileState(e,t){t&&(t.error_code?Object.assign(e,{errorCode:t.error_code,errorMessage:t.error_msg}):Object.assign(e,{width:+t.meta.width,height:+t.meta.height,kid:t.meta.kid,secret:t.secret,sha:t.sha}))}manualUploadFiles(e){e.length?this.uploadFiles(e).then((e=>{const t=this.uploadedFiles.filter((e=>!e.cancelled));this.onLoadEndAll&&t.length&&this.onLoadEndAll(this.uploadedFiles,e)})).finally((()=>{this.cleanupFields()})).catch((e=>{this.handleError(e)})):this.cleanupFields()}constructor(e){this.uploadUrl="",this.uploadedFiles=[],this.uploadMode=s.UploadMode.queue,this.uploadRequests=[],this.uploaderTasksQueue=[],this.isDndActive=!1,this.dndTimer=-1,this.handleDrop=e=>{if(e.preventDefault(),e.stopPropagation(),this.dragOverClass&&((0,r.hide)(this.dropArea),this.dropArea?.classList.remove(this.dragOverClass)),this.isDndActive=!1,!e.dataTransfer)return;const t=this.getAcceptedFilesOnly(e.dataTransfer.files);this.manualUploadFiles(t)},this.handleInputChange=e=>{const t=e.target.files;if(!t||0===t.length)return;const o=this.getAcceptedFilesOnly(t);this.manualUploadFiles(o)},this.handleDragOver=e=>{e.preventDefault(),e.stopPropagation(),window.setTimeout((()=>{window.clearTimeout(this.dndTimer),this.dndTimer=-1}),0)},this.handleDragLeave=e=>{e.preventDefault(),e.stopPropagation(),-1!==this.dndTimer&&window.clearTimeout(this.dndTimer),this.dndTimer=window.setTimeout((()=>{this.isDndActive=!1,this.dragOverClass&&((0,r.hide)(this.dropArea),this.dropArea?.classList.remove(this.dragOverClass))}),100)},this.handleDragEnter=e=>{e.preventDefault(),e.stopPropagation(),this.isDndActive||(window.setTimeout((()=>{window.clearTimeout(this.dndTimer),this.dndTimer=-1}),0),this.isDndActive=!0,this.dragOverClass&&(this.dropArea?.classList.add(this.dragOverClass),(0,r.show)(this.dropArea)))},this.accept=e.accept??["image/*"],this.multiple=e.multiple??!1,this.dragOverClass=e.dragOverClass,this.uploadUrl=e.uploadUrl,this.uploadMode=e.uploadMode??s.UploadMode.queue,this.onProgress=e.onProgress,this.onLoadStart=e.onLoadStart,this.onLoadEnd=e.onLoadEnd,this.onLoadEndAll=e.onLoadEndAll,this.onError=e.onError,e.input&&this.initFileInput(e.input),e.dropArea&&this.initDropArea(e.dropArea)}}},926907:(e,t,o)=>{o.d(t,{acceptFile:()=>s});const s=(e,t)=>{if(e&&t){const o=e.name||"",s=(e.type||"").toLowerCase(),i=s.replace(/\/.*$/,"");return t.some((e=>{const t=e.trim().toLowerCase();return t.startsWith(".")?o.toLowerCase().endsWith(t):t.endsWith("/*")?i===t.replace(/\/.*$/,""):s===t}))}return!0}},734009:(e,t,o)=>{o.d(t,{ImpUploader:()=>a});var s=o(855764);const i=new Map,a={getUploader:e=>i.get(e),init(e,t){if(i.has(e)){const t=i.get(e);t&&t.destroy()}const o=new s.ImageProxyUploader(t);return i.set(e,o),o}}},257884:(e,t,o)=>{var s;o.d(t,{UploadMode:()=>s}),function(e){e[e.parallel=0]="parallel",e[e.queue=1]="queue"}(s||(s={}))},593088:(e,t,o)=>{o.d(t,{sendUploadRequest:()=>s});const s=(e,t,o,s)=>new Promise(((i,a)=>{const r=new XMLHttpRequest;r.open("POST",e,!0),r.upload.onloadstart=e=>{o.totalBytes+=e.total,s()},r.upload.onprogress=e=>{e.lengthComputable&&(o.loadedBytes=e.loaded,o.totalBytes=e.total),s()},r.onerror=()=>{a("Unknown error")},r.onreadystatechange=()=>{if(r.readyState===XMLHttpRequest.DONE&&200===r.status){if(JSON.parse(r.responseText).error_code)return void a(r.responseText);i(r.responseText)}};const n=(e=>Array.from(e.entries()).reduce(((e,[,t])=>e+("string"==typeof t?t.length:t.size)),0))(t);o.totalBytes=n,r.send(t)}))},769451:(e,t,o)=>{o.d(t,{ChoosePhoto:()=>s});const s={Upload:o(79646).ChoosePhotoUpload}},79646:(e,t,o)=>{o.d(t,{ChoosePhotoUpload:()=>p});var s=o(70689),i=o(255693),a=o(159663),r=o(851782),n=o(471828),l=o(769114),d=o(92511),h=o(251087),c=o(802130);function u(e){return e.fileName.replace(/[&<>"']/g,"")}class p{beforeUpload(e){const t=window.cur,o=this.maxFiles-(t.savedPhotos||[]).length-(t.attachCount&&t.attachCount()||0);if(o<=0)return Promise.reject(n.getLang("global_error"));if(e.length<=o)return Promise.resolve(e);const s=n.getLang("global_attach_max_n_files",this.maxFiles).replace("{count}",String(this.maxFiles));return new Promise((function(t,i){const r={title:n.getLang("global_error"),width:430,bodyStyle:"padding: 20px; line-height: 160%;"};(0,a.showFastBox)(r,s,n.getLang("global_continue"),(function(){(0,h.curBox)()?.hide(),t(e.slice(0,o))}),n.getLang("global_cancel"),(function(){(0,h.curBox)()?.hide(),i("Abort by user")}))}))}removeProgress(e){this.isWiki||Object.keys(e.files).forEach((t=>{const o=e.files[t],s=o.ind+"_"+u(o);if(window.__upload_callback&&delete window.__upload_callback[s],window.cur.imMedia){document.getElementById(`upload${s}_progress_wrap`)?.remove();const e=window.cur.imMedia.lnkId;window.cur.addMedia[e].unchooseMedia(void 0)}else if(window.cur.addMedia){document.getElementById(`upload${s}_progress_wrap`)?.remove();const e=(window.cur.attachMediaIndexes||{})[s];e&&window.cur.addMedia[e].unchooseMedia(void 0)}}))}choosePhotoUploadFailed(e){this.removeProgress(e),this.isWiki||(0,c.statlogsValueEvent)("upload_photo_fails",e.files.length,e.response.server,e.response.error_code),"errorCode"in e&&e.errorCode&&(0,h.showDoneBox)(n.getLang("photos_add_error")+` (${e.errorCode})`),window.cur.onMediaUploadFail&&window.cur.onMediaUploadFail(e.files),this.onUploadCompleted(),this.instance.nextBatch()}choosePhotoUploaded(e){const t=Object.keys(e.files).some((t=>{const o=e.files[t],i=o.ind+"_"+u(o),a=document.getElementById(`upload${i}_progress_wrap`);if(a){const e=(0,s.gpeByClass)("submit_post_box",a);return!!e&&e.classList.contains("reply_box")}return!1}),{}),o=Object.values(e.files);r.ajax.post("al_photos.php",{act:"choose_uploaded",mid:this.userId,gid:this.groupId||0,aid:this.albumId,is_reply:t?1:0,upload_v2:1,bugcomments_editor:this.bugCommentEditor,photos:e.responseString},{onDone:e=>{window.cur.preventBoxHideWithSharedBox=!0,Object.entries(e).forEach((function([e,t],s){const i=o[s];window.cur.chooseMedia("photo",e,Object.assign({upload_ind:i.ind+"_"+i.fileName},t))})),window.cur.preventBoxHideWithSharedBox=!1,this.instance.nextBatch(),this.onUploadCompleted()},onFail:this.choosePhotoUploadFailed.bind(this,e)})}alWysiwygChoosePhotoUploaded(e){r.ajax.post("al_photos.php",{act:"choose_uploaded",mid:this.userId,gid:this.groupId,aid:this.albumId,al_wiki_editor:1,upload_v2:1,photos:e.responseString},{onDone:(e,t,o,s)=>{window.editorChoosePhoto&&window.editorChoosePhoto(e,t,o,s),this.onUploadCompleted(),this.instance.nextBatch()},onFail:this.choosePhotoUploadFailed.bind(this,e),progress:(0,h.curBox)()?.progress})}uploadProgress(e){if(e.cancelled)return!0;this.isWiki||Object.keys(e.files).forEach((t=>{const o=e.files[t],s=o.ind,i=u(o),a=s+"_"+i,r=(window.cur.attachMediaIndexes||{})[a];if(void 0===r||r&&window.cur.addMedia[r]||window.cur.imMedia){const t={loaded:o.loadedSize,total:o.fileSize,name:i};window.__upload_callback||(window.__upload_callback={}),window.__upload_callback[a]=()=>{this.instance.cancelUpload(e),this.removeProgress(e)},window.cur.showMediaProgress("photo",s,t,!0)}}))}uploadStart(e){if(this.isUploadCompletedAll=!1,this.isWiki){const e=document.getElementById(`photos_choose_upload_area_${this.id}`);e&&(e.innerHTML='<img src="/images/upload.gif"/>',e.removeAttribute("onclick"))}else{const t=(0,h.curBox)();t&&t.needHideLastCheck?window.boxQueue.hideLast(t.preventHideLastWithCheck):window.boxQueue.hideLast(),this.uploadProgress(e),window.cur.onMediaUploadStarted&&window.cur.onMediaUploadStarted(e.files)}window.cur.setChooseUploadFlag&&window.cur.setChooseUploadFlag("start")}uploadComplete(e){e.cancelled?this.removeProgress(e):"error_code"in e.response&&e.response.error_code?this.choosePhotoUploadFailed(e):((0,c.statlogsValueEvent)("upload_photo_fails",e.response.files.length,e.response.server,"success"),this.isWiki?this.alWysiwygChoosePhotoUploaded(e):this.choosePhotoUploaded(e))}onUploadCompleted(){window.cur.setChooseUploadFlag&&this.isUploadCompletedAll&&window.cur.setChooseUploadFlag("finish")}uploadCompleteAll(){this.isUploadCompletedAll=!0,window.cur.choosePhotoUploadedAll&&window.cur.choosePhotoUploadedAll()}onDragEnter(){const e=document.getElementById("photos_choose_upload_area_wrap");if(!e)return;if(e.classList.contains("photos_choose_upload_area_enter"))return;(0,s.hide)("photos_choose_wrap"),(0,s.hide)("photos_choose_more");const t=document.querySelector("#photos_choose_wrap"),o=(0,s.getXY)(t)[1],a=(0,s.getSize)(e)[1];e.style.height=`${(0,i.scrollGetY)()+document.documentElement.clientHeight-o+a}px`,e.classList.add("photos_choose_upload_area_enter"),this.dropArea.style.overflow="hidden"}onDragLeave(){const e=document.querySelector("#photos_choose_upload_area_wrap");e&&(e.classList.remove("photos_choose_upload_area_enter"),e.style.height="",(0,s.show)("photos_choose_wrap"),(0,s.show)("photos_choose_more"),this.dropArea.style.overflow="")}init(){this.dropArea=document.getElementById("box_layer_wrap"),this.instance=l.GoUploaderHelper.init(this.id,{uploadUrl:this.uploadUrl,input:document.getElementById(`photos_upload_input_${this.albumId}`),multiple:!0,multipleMaxSize:1,dropArea:this.dropArea,uploadMode:d.UploadMode.queue,onDragEnter:this.onDragEnter.bind(this),onDragLeave:this.onDragLeave.bind(this),onBeforeUpload:this.beforeUpload.bind(this),onLoadStart:this.uploadStart.bind(this),onProgress:this.uploadProgress.bind(this),onLoadEnd:this.uploadComplete.bind(this),onLoadEndAll:this.uploadCompleteAll.bind(this),onError:this.choosePhotoUploadFailed.bind(this)}),window.cur.initChooseUploadFlags={},window.cur.setChooseUploadFlag=e=>{window.cur.initChooseUploadFlags&&(e&&(window.cur.initChooseUploadFlags[e]=!0),"start"===e&&delete window.cur.initChooseUploadFlags.finish,window.cur.initChooseUploadFlags.clean_box&&!window.cur?.initChooseUploadFlags.start&&this.instance.destroy())},window.cur.nav.push((()=>(this.instance.cancelAllUploads(),this.instance.destroy(),!0)))}constructor(e){this.isUploadCompletedAll=!1,this.id=e.id,this.uploadUrl=e.uploadUrl,this.userId=e.userId,this.albumId=e.albumId,e.groupId&&(this.groupId=e.groupId),e.options&&(this.maxFiles=e.options.max_files||10,this.isWiki=!!e.options.wiki_editor,this.bugCommentEditor=e.options.bugcomments_editor||""),this.init()}}},473817:(e,t,o)=>{o.d(t,{PhotoSuggestedTagCard:()=>r});var s=o(614945),i=o(471828),a=o(184132);class r extends s.PhotoTagCard{confirm(){return this.tagArea.confirmSuggestedTags(this.getTags(),this,this.confirmBtn)}decline(){return this.tagArea.declineSuggestedTags(this.getTags(),this,this.declineBtn)}getResultText(e){const t=this.getOwnerId(),o=this.tagArea.getTags()[0].getOwnerNameGenitive();let r="";switch(e){case s.TagCardViewStatus.CONFIRMED:r=a.Ranges.isUserIdTransitional(t)?i.getLang("photo_recognition_confirm_myself_on_photo"):i.getLang("photo_recognition_confirm_myself_on_photo_group"),r=r.replace("{name}",o);break;case s.TagCardViewStatus.DECLINED:r=a.Ranges.isUserIdTransitional(t)?i.getLang("photo_recognition_decline_on_photo"):i.getLang("photo_recognition_decline_on_photo_group"),r=r.replace("{name}",o);break;default:r=i.getLang("photo_recognition_deleted_tag")}return r}constructor(e){super(e)}}},476946:(e,t,o)=>{var s;o.d(t,{PhotoTag:()=>i}),function(e){e[e.Initial=0]="Initial",e[e.Confirmed=1]="Confirmed",e[e.Declined=2]="Declined"}(s||(s={}));class i{decline(){this.tagEl.classList.remove("PhotoTag--confirm"),this.tagEl.classList.add("PhotoTag--decline"),this.cutoutEl.classList.remove("PhotoTagCutout--transparency"),this.state=2}confirm(){this.tagEl.classList.remove("PhotoTag--decline"),this.tagEl.classList.add("PhotoTag--confirm"),this.cutoutEl.classList.add("PhotoTagCutout--transparency"),this.state=1}reset(){this.tagEl.classList.remove("PhotoTag--decline"),this.tagEl.classList.remove("PhotoTag--confirm"),this.cutoutEl.classList.remove("PhotoTagCutout--transparency"),this.state=0}getFullRawId(){return`${this.tagArea.getPhotoRawId()}_${this.getId()}`}getId(){return this.id}getUserId(){return this.userId}getUserName(){return this.name}getUserNameGenitive(){return this.nameGenitive}getUserNameAccusative(){return this.nameAccusative}getOwnerNameGenitive(){return this.ownerNameGenitive}getPlacerNameGenitive(){return this.placerNameGenitive}isConfirmed(){return 1===this.state}getSex(){return this.sex}constructor(e,t){this.tagEl=e,this.tagArea=t;const o=e.getAttribute("data-item");if(!o)throw new Error("Tag: incorrect json data");const s=JSON.parse(o);this.id=Number(s.id),this.userId=s.userId,this.name=s.name,this.nameGenitive=s.nameGenitive,this.ownerNameGenitive=s.ownerNameGenitive,this.placerNameGenitive=s.placerNameGenitive,this.nameAccusative=s.nameAccusative,this.isSuggested=Boolean(s.isSuggested),this.sex=Number(s.sex),this.styles={top:s.top,left:s.left,width:s.width,height:s.height};let i=0;e.classList.contains("PhotoTag--confirm")?i=1:e.classList.contains("PhotoTag--decline")&&(i=2),this.state=i;const a=`tag_cutout${t.getPhotoRawId()}_${s.userId}`,r=document.getElementById(a);if(!r)throw new Error("Tag: incorrect data");this.cutoutEl=r}}},507273:(e,t,o)=>{o.d(t,{PhotoTagArea:()=>h});var s=o(476946),i=o(488844),a=o(977053),r=o(251087),n=o(471828),l=o(159663),d=o(448907);class h{showConfirmAlertBoxIfNeeded(e){const t=e[0];return new Promise(((e,o)=>{if(!window.cur.pvNeedShowAlertForOneSuggest||t.getUserId()===window.vk.id)return void e();const s=n.getLang("photo_recognition_one_tag_alert"),i=(0,n.langSex)(t.getSex(),n.getLang("photo_recognition_one_tag_alert_text","raw")).replace("{name}",t.getUserName()),a=(0,l.showFastBox)(s,i,n.getLang("photo_recognition_one_friend_submit_btn"),(()=>{this.hideHint(),a.hide(),e()}),n.getLang("global_cancel"),(()=>{a.hide(),o()}))}))}hideHint(){window.cur.pvNeedShowAlertForOneSuggest=!1;const e=window.cur.pvOneSuggestHintId,t=window.cur.pvOneSuggestHintHash;e&&t&&window.ajax.post("al_index.php",{act:"help_hints_hide",hint_id:e,hash:t},{onDone:()=>{},onFail:()=>(console.error("something wrong with help hint"),!0)})}decrementLeftMenuCounterIfNeeded(e){e.forEach((e=>{e.getUserId()===window.vk.id&&(0,d.decrementLeftMenuPhotoCounter)()}))}getFullRawTagIdsStr(e=this.tags){return e.reduce(((e,t,o)=>e+`${0===o?"":","}${t.getFullRawId()}`),"")}setConfirmedTagsByIds(e){const t=e.reduce(((e,t)=>(this.tagsMap[t]&&e.push(this.tagsMap[t]),e)),[]);return!!t.length&&(this.setConfirmedTags(t),!0)}setConfirmedTags(e){(e=e.filter((e=>this.tagsMap[e.getId()]))).length&&(e.forEach((e=>e.confirm())),this.tagArea.classList.add("PhotoTagArea--fade"))}setDeclinedTags(e){e.forEach((e=>e.decline()))}setDeclinedTagsByIds(e){const t=e.reduce(((e,t)=>(this.tagsMap[t]&&e.push(this.tagsMap[t]),e)),[]);return!!t.length&&(this.setDeclinedTags(t),!0)}reset(){this.tagArea.classList.remove("PhotoTagArea--fade"),this.tags.forEach((e=>e.reset()))}getPhotoRawId(){return this.photoEntity.getPhotoRawId()}getTags(){return this.tags}getConfirmedTags(){return this.tags.filter((e=>e.isConfirmed()))}setSizes(e,t){this.tagArea.style.width=`${e}px`,this.tagArea.style.height=`${t}px`}show(){this.tagArea.classList.remove("PhotoTagArea--hide")}static calculateTagAreaSizes(e,t,o){const s=e.offsetWidth,i=e.offsetHeight,a=t/o;let r,n,l=!0;return s/i>a&&(l=!1),l?(r=Math.round(Math.min(t,s)),n=Math.round(r/a)):(n=Math.round(Math.min(o,i)),r=Math.round(n*a)),[r,n]}constructor(e,t,o){this.confirmTag=(e,t,o)=>{o&&(0,i.lockButton)(o);const s=!(0,a.partConfigEnabled)("recognize_mock_turn_off");return new Promise(((a,l)=>{window.ajax.post("al_photos.php",{act:"confirm_tag",photo:t.getPhotoRawId(),tag:e.getId(),hash:this.tagHash},{onDone:()=>{this.setConfirmedTags([e]),this.decrementLeftMenuCounterIfNeeded([e]),a()},onFail:()=>s?(this.setConfirmedTags([e]),a(),!0):((0,r.showDoneBox)(n.getLang("global_unknown_error")),l(),!0),hideProgress:()=>{o&&(0,i.unlockButton)(o)}})}))},this.declineTag=(e,t,o)=>new Promise(((s,l)=>{o&&(0,i.lockButton)(o);const d=!(0,a.partConfigEnabled)("recognize_mock_turn_off");window.ajax.post("al_photos.php",{act:"delete_tag",photo:t.getPhotoRawId(),tag:e.getId(),hash:this.tagHash},{onDone:()=>{this.setDeclinedTags([e]),this.decrementLeftMenuCounterIfNeeded([e]),s()},onFail:()=>d?(this.setDeclinedTags([e]),s(),!0):((0,r.showDoneBox)(n.getLang("global_unknown_error")),l(),!0),hideProgress:()=>{o&&(0,i.unlockButton)(o)}})})),this.confirmSuggestedTags=(e,t,o)=>this.showConfirmAlertBoxIfNeeded(e).then((()=>{o&&(0,i.lockButton)(o);const t=!(0,a.partConfigEnabled)("recognize_mock_turn_off");return new Promise(((s,a)=>{window.ajax.post("al_photos.php",{act:"confirm_suggested_tags",tag_raw_ids:this.getFullRawTagIdsStr(e),track_code:this.trackCode,hash:this.tagHash},{onDone:()=>{this.setConfirmedTags(e),this.decrementLeftMenuCounterIfNeeded(e),s()},onFail:()=>t?(this.setConfirmedTags(e),s(),!0):((0,r.showDoneBox)(n.getLang("global_unknown_error")),a(),!0),hideProgress:()=>{o&&(0,i.unlockButton)(o)}})}))})),this.declineSuggestedTags=(e,t,o)=>new Promise(((t,s)=>{o&&(0,i.lockButton)(o);const l=!(0,a.partConfigEnabled)("recognize_mock_turn_off");window.ajax.post("al_photos.php",{act:"decline_suggested_tags",tag_raw_ids:this.getFullRawTagIdsStr(e),track_code:this.trackCode,hash:this.tagHash},{onDone:()=>{this.setDeclinedTags(e),this.decrementLeftMenuCounterIfNeeded(e),t()},onFail:()=>l?(this.setDeclinedTags(e),t(),!0):((0,r.showDoneBox)(n.getLang("global_unknown_error")),s(),!0),hideProgress:()=>{o&&(0,i.unlockButton)(o)}})}));const l=e.getEl().querySelector(".PhotoTagArea");if(!l)throw new Error("error: there is not tag area el");if(!t)throw new Error("error: there is not tag hash");const d=Array.from(e.getEl().querySelectorAll(".PhotoTag"));this.trackCode=o,this.tagArea=l,this.tagHash=t,this.photoEntity=e,this.tags=d.map((e=>new s.PhotoTag(e,this))),this.tagsMap=this.tags.reduce(((e,t)=>(e[t.getId()]=t,e)),{})}}},90625:(e,t,o)=>{o.d(t,{PHOTO_TAG_BLOCK_CLASS:()=>_,PhotoTagBlock:()=>m});var s=o(614945),i=o(813816),a=o(991249),r=o(473817),n=o(198448),l=o(488844),d=o(70689),h=o(159663),c=o(471828),u=o(448907),p=o(251087),g=o(226059);const _="PhotoTagBlock";class m{initListeners(){this.confirmAllBtn?.addEventListener("click",this.onConfirmAll),this.declineAllBtn?.addEventListener("click",this.onDeclineAll),this.loadMoreBtn?.addEventListener("click",this.loadMore),document.addEventListener(i.TagEventTypes.CONFIRM_SUGGESTED_TAGS,this.handleOutsideConfirmationSuggestedTags),document.addEventListener(i.TagEventTypes.DECLINE_SUGGESTED_TAGS,this.handleOutsideDeclinationSuggestedTags),document.addEventListener(i.TagEventTypes.CONFIRM_USER_TAG,this.handleOutsideConfirmationUserTag),document.addEventListener(i.TagEventTypes.DECLINE_USER_TAG,this.handleOutsideDeclinationUserTag),document.addEventListener(i.TagEventTypes.DELETE_TAG,this.handleOutsideDeletingTags),this.nextOffset&&this.isFullPage&&window.addEventListener("scroll",this.checkScroll)}deInitListeners(){this.confirmAllBtn?.removeEventListener("click",this.onConfirmAll),this.declineAllBtn?.removeEventListener("click",this.onDeclineAll),this.loadMoreBtn?.removeEventListener("click",this.loadMore),document.removeEventListener(i.TagEventTypes.CONFIRM_SUGGESTED_TAGS,this.handleOutsideConfirmationSuggestedTags),document.removeEventListener(i.TagEventTypes.DECLINE_SUGGESTED_TAGS,this.handleOutsideDeclinationSuggestedTags),document.removeEventListener(i.TagEventTypes.CONFIRM_USER_TAG,this.handleOutsideConfirmationUserTag),document.removeEventListener(i.TagEventTypes.DECLINE_USER_TAG,this.handleOutsideDeclinationUserTag),document.removeEventListener(i.TagEventTypes.DELETE_TAG,this.handleOutsideDeletingTags),this.isFullPage&&this.nextOffset&&document.removeEventListener("scroll",this.checkScroll)}onSubmitAll(e,t){const o=(0,p.curBox)();o&&o.hide(),(0,u.decrementLeftMenuPhotoCounter)(e);let s="";s=!this.submitAllLimit||this.fullCardsNumber<=this.submitAllLimit?`/albums${window.vk.id}`:`/albums${window.vk.id}?act=recognition_tags`,this.go(s,t)}go(e,t=""){const o=document.querySelector("#box_layer_wrap"),s=document.querySelector("#box_loader");window.nav.go(e,null,{onDone:()=>{t&&(0,p.showDoneBox)(t)},showProgress:()=>{(0,d.show)(o),(0,d.show)(s),(0,p.refreshBoxLoaderCoords)()},hideProgress:()=>{(0,d.hide)(o),(0,d.hide)(s)}})}getActiveCardsNumber(){const e=this.cards.filter((e=>e.isActive())).length,t=this.cards.length-e;return this.fullCardsNumber-t}destroy(){this.isDestroyed=!0,this.deInitListeners(),this.cards.forEach((e=>e.destroy()))}createCards(e){return e.map((e=>s.PhotoTagCard.isPhotoSuggestedTagCard(e)?new r.PhotoSuggestedTagCard(e):new a.PhotoUserTagCard(e)))}constructor(e,t){this.isLoading=!1,this.isDestroyed=!1,this.handleOutsideConfirmationSuggestedTags=e=>{const t=e.detail.photoRawId,o=e.detail.tagIds;this.cards.filter((e=>e.getPhotoRawId()===t)).forEach((e=>e.setConfirmedTagsByIds(o)))},this.handleOutsideDeclinationSuggestedTags=e=>{const t=e.detail.photoRawId,o=e.detail.tagIds;this.cards.filter((e=>e.getPhotoRawId()===t)).forEach((e=>e.setDeclinedTagsByIds(o)))},this.handleOutsideConfirmationUserTag=e=>{const t=e.detail.photoRawId,o=e.detail.tagId,s=this.cards.find((e=>e.getPhotoRawId()===t));s&&s.setConfirmedTagsByIds([o])},this.handleOutsideDeclinationUserTag=e=>{const t=e.detail.photoRawId,o=e.detail.tagId,s=this.cards.find((e=>e.getPhotoRawId()===t));s&&s.setDeclinedTagsByIds([o])},this.handleOutsideDeletingTags=e=>{const t=e.detail.photoRawId,o=e.detail.tagIds;this.cards.filter((e=>e.getPhotoRawId()===t)).forEach((e=>e.setDeletedTagsByIds(o)))},this.checkScroll=(0,n.debounce)((()=>{this.isLoading||window.innerHeight+window.pageYOffset+700>=this.cardsBlock.getBoundingClientRect().bottom&&this.loadMore()}),200),this.loadMore=()=>{!this.isLoading&&this.nextOffset&&(this.isLoading=!0,window.ajax.post("al_photos.php",{act:"recognition_tags",part:1,offset:this.nextOffset,is_full_page:Number(this.isFullPage)},{onDone:(e,t,o)=>{if(this.isLoading=!1,this.isDestroyed)return;this.fullCardsNumber=t,this.nextOffset=o,this.nextOffset||document.removeEventListener("scroll",this.checkScroll);const s=e?.map((e=>{const t=(0,d.se)(e);return this.cardsBlock.appendChild(t),t}));s?.length&&this.cards.push(...this.createCards(s)),o||(0,d.hide)(this.loadMoreBtn)},showProgress:()=>(0,l.lockButton)(this.loadMoreBtn),hideProgress:()=>(0,l.unlockButton)(this.loadMoreBtn)}))},this.getAllTagElements=e=>Array.from(e.querySelectorAll(`.${s.PHOTO_TAG_CARD_CLASS}`)),this.onConfirmAll=()=>{if(!this.confirmAllHash)return;const e=this.getActiveCardsNumber();window.ajax.post("al_photos.php",{act:"confirm_all_tags",hash:this.confirmAllHash},{onDone:()=>{this.onSubmitAll(e,c.getLang("photo_tags_confirmed_text",e))},onFail:e=>((0,h.showFastBox)(c.getLang("global_error"),e||c.getLang("global_unknown_error")),!0),showProgress:()=>this.confirmAllBtn&&g.FlatButton.lock(this.confirmAllBtn),hideProgress:()=>this.confirmAllBtn&&g.FlatButton.unlock(this.confirmAllBtn)})},this.onDeclineAll=()=>{if(!this.declineAllHash)return;const e=this.getActiveCardsNumber(),t=t=>{window.ajax.post("al_photos.php",{act:"decline_all_tags",hash:this.declineAllHash},{onDone:()=>{this.onSubmitAll(e,c.getLang("photo_tags_declined_text",e))},onFail:e=>((0,h.showFastBox)(c.getLang("global_error"),e||c.getLang("global_unknown_error")),!0),showProgress:()=>(0,l.lockButton)(t),hideProgress:()=>(0,l.unlockButton)(t)})};(0,h.showFastBox)(c.getLang("photo_tag_decline_box_title",e),c.getLang("photo_tag_decline_box_description"),c.getLang("photo_recognition_decline_all"),(e=>{t(e)}),c.getLang("global_cancel"))},this.block=e,this.isFullPage=t.isFullPage,this.fullCardsNumber=t.fullCardsNumber,this.nextOffset=t.nextOffset,this.confirmAllHash=t.confirmAllHash,this.declineAllHash=t.declineAllHash,this.submitAllLimit=t.submitAllLimit;const o=this.block.querySelector(".PhotoTagBlock__cards");if(!o)throw new Error("PhotoTagBlock: incorrect data");this.cardsBlock=o,this.loadMoreBtn=this.block.querySelector(".PhotoTagBlock__loadMoreBtn"),this.confirmAllBtn=document.querySelector(".PhotoTagBlock__confirmAll"),this.declineAllBtn=document.querySelector(".PhotoTagBlock__declineAll"),this.cards=this.createCards(this.getAllTagElements(this.cardsBlock)),this.initListeners()}}},614945:(e,t,o)=>{o.d(t,{PHOTO_TAG_CARD_CLASS:()=>h,PhotoTagCard:()=>p,TagCardViewStatus:()=>u});var s=o(861532),i=o(507273),a=o(30655),r=o(70689),n=o(93367),l=o(65718),d=o(406686);const h="PhotoTagCard",c="PhotoTagCard--noSize";var u;!function(e){e[e.ACTIVE=0]="ACTIVE",e[e.CONFIRMED=1]="CONFIRMED",e[e.DECLINED=2]="DECLINED",e[e.DELETED=3]="DELETED"}(u||(u={}));class p{destroy(){this.deInitListeners()}getPhotoRawId(){return this.photoRawId}getEl(){return this.photoEl}setConfirmedTagsByIds(e){this.tagArea.setConfirmedTagsByIds(e)&&this.setViewStatus(1)}setDeclinedTagsByIds(e){this.tagArea.setDeclinedTagsByIds(e)&&(this.setOverlay(),this.setViewStatus(2))}setDeletedTagsByIds(e){this.tagArea.setDeclinedTagsByIds(e)&&this.setViewStatus(3)}static isPhotoSuggestedTagCard(e){return Boolean(Number(e.dataset.isSuggest))}init(){this.initListeners(),this.photoUrl&&this.checkPhotoHasNoSizes()&&this.correctTagView(this.photoUrl)}initListeners(){this.confirmBtn.addEventListener("click",this.onConfirmClick),this.declineBtn.addEventListener("click",this.onDeclineClick),this.cancelConfirmBtn?.addEventListener("click",this.onCancelClick),this.cancelDeclineBtn?.addEventListener("click",this.onCancelClick),this.photoEl.addEventListener("click",this.onPhotoClick)}deInitListeners(){this.confirmBtn.removeEventListener("click",this.onConfirmClick),this.declineBtn.removeEventListener("click",this.onDeclineClick),this.cancelConfirmBtn?.removeEventListener("click",this.onCancelClick),this.cancelDeclineBtn?.removeEventListener("click",this.onCancelClick),this.photoEl.removeEventListener("click",this.onPhotoClick)}setViewStatus(e){const t=this.resultPanel.querySelector(".PhotoTagCard__resultWrapper");if(t){if(this.status=e,0===e)return(0,r.hide)(this.resultPanel),void(0,r.show)(this.description);t.innerHTML=this.getResultText(e),(0,r.hide)(this.description),1===e?(this.resultPanel.classList.add("PhotoTagCard__result--confirm"),this.resultPanel.classList.remove("PhotoTagCard__result--decline")):2===e?(this.resultPanel.classList.remove("PhotoTagCard__result--confirm"),this.resultPanel.classList.add("PhotoTagCard__result--decline")):(this.resultPanel.classList.remove("PhotoTagCard__result--confirm"),this.resultPanel.classList.remove("PhotoTagCard__result--decline")),(0,r.show)(this.resultPanel)}}setOverlay(e=!1){this.photoEl.classList.toggle("PhotoTagCard__photo--disable",e)}showPhoto(e){(0,a.showPhoto)(this.photoRawId,this.photoContext,this.photoViewOptions,e),this.updatePhotoviewCache()}getTags(){return this.tagArea.getTags()}getConfirmedTags(){return this.tagArea.getConfirmedTags()}updatePhotoviewCache(e=!1){this.photoViewOptions.noCache=e,e&&(0,d.dropPhotoCacheData)()}checkPhotoHasNoSizes(){return this.el.classList.contains(c)}correctTagView(e){const t=new Image;t.onload=()=>{const o=t.width,s=t.height;if(o&&s){const[t,a]=i.PhotoTagArea.calculateTagAreaSizes(this.photoEl,o,s),r=this.el.querySelector(".PhotoTagCard__stub");r&&r.remove();const n=document.createElement("div");n.classList.add("PhotoTagCard__image"),n.style.backgroundSize=`${t}px ${a}px`,n.style.backgroundImage=`url('${e}')`,this.photoEl.appendChild(n);const l=t+1,d=a+1;this.tagArea.setSizes(l,d),this.tagArea.show(),this.el.classList.remove(c)}},t.src=e}getOwnerId(){return this.ownerId}isActive(){return 0===this.status}constructor(e){this.status=0,this.isLoading=!1,this.onPhotoClick=e=>{e.ctrlKey||e.metaKey||(this.showPhoto(e),(0,n.cancelEvent)(e))},this.onConfirmClick=()=>{this.confirm().then((()=>{const e=this.getTags();this.tagArea.setConfirmedTags(e),this.updatePhotoviewCache(!0),this.setViewStatus(1)}),(e=>{e&&(0,l.logError)(e)})).finally((()=>{this.isLoading=!1}))},this.onDeclineClick=()=>{this.isLoading||(this.isLoading=!0,this.decline().then((()=>{this.setOverlay(),this.updatePhotoviewCache(!0),this.setViewStatus(2)}),(e=>{e&&(0,l.logError)(e)})).finally((()=>{this.isLoading=!1})))},this.onCancelClick=()=>{this.setOverlay(!1),this.tagArea.reset(),this.setViewStatus(0)},this.el=e;const t=e.dataset.photoViewOptions,o=e.dataset.photoContext,a=e.dataset.photoRawId,r=t&&(0,s.parseJSON)(t),d=e.dataset.tagHash;if(!(r&&a&&o&&d))throw new Error("PhotoTagCard: incorrect arguments");const[h,c]=a.split("_");this.ownerId=Number(h),this.photoId=Number(c),this.photoRawId=a,this.photoContext=o,this.photoViewOptions=r,this.photoUrl=e.dataset.photoUrl;const u=e.querySelector(".PhotoTagCard__button--confirm"),p=e.querySelector(".PhotoTagCard__button--decline"),g=e.querySelector(".PhotoTagCard__button--cancelConfirm"),_=e.querySelector(".PhotoTagCard__button--cancelDecline"),m=e.querySelector(".PhotoTagCard__desc"),f=e.querySelector(".PhotoTagCard__photo"),v=e.querySelector(".PhotoTagCard__result");if(!(u&&p&&m&&f&&v))throw new Error("PhotoTagCard: there are not elements");this.photoEl=f,this.confirmBtn=u,this.declineBtn=p,this.description=m,this.cancelConfirmBtn=g,this.cancelDeclineBtn=_,this.resultPanel=v,this.tagArea=new i.PhotoTagArea(this,d),this.init()}}},991249:(e,t,o)=>{o.d(t,{PhotoUserTagCard:()=>a});var s=o(614945),i=o(471828);class a extends s.PhotoTagCard{confirm(){const e=this.getTags();return this.tagArea.confirmTag(e[0],this,this.confirmBtn)}decline(){const e=this.getTags();return this.tagArea.declineTag(e[0],this,this.declineBtn)}getResultText(e){const t=this.getTags()[0].getPlacerNameGenitive()||"";let o="";switch(e){case s.TagCardViewStatus.CONFIRMED:o=i.getLang("photo_recognition_confirm_myself").replace("{name}",t);break;case s.TagCardViewStatus.DECLINED:o=i.getLang("photo_recognition_decline_myself").replace("{name}",t);break;default:o=i.getLang("photo_recognition_deleted_tag")}return o}constructor(e){super(e)}}},448907:(e,t,o)=>{o.d(t,{decrementLeftMenuPhotoCounter:()=>l});var s=o(636322),i=o(65718),a=o(740685);const r="ph",n=`l_${r}`;function l(e=1){try{const t=function(){const e=document.getElementById(n);if(!e)throw new Error("There is not photo left menu item");const t=e.querySelector(".left_count");return t?(0,s.intval)(t.textContent):0}();(0,a.handlePageCount)(r,Math.max(t-e,0))}catch(e){console.error(e),(0,i.logError)(e)}}},813816:(e,t,o)=>{var s;o.d(t,{TagEventTypes:()=>s}),function(e){e.CONFIRM_SUGGESTED_TAGS="CONFIRM_SUGGESTED_TAGS",e.DECLINE_SUGGESTED_TAGS="DECLINE_SUGGESTED_TAGS",e.DECLINE_USER_TAG="DECLINE_USER_TAG",e.CONFIRM_USER_TAG="CONFIRM_USER_TAG",e.DELETE_TAG="DELETE_TAG"}(s||(s={}))}}]);try{stManager.done("dist/web/chunks/0c0b3381.3722d29a.js")}catch(e){}